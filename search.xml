<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[æºç ç¼–è¯‘Portable Pyton]]></title>
    <url>%2Fblog%2Fpractice-compile-portable-python.html</url>
    <content type="text"><![CDATA[Portableçš„æ„æ€æ˜¯å¯æ‹”æ’çš„ï¼Œä¾¿æºå¼çš„ã€‚Portable ç¨‹åºåœ¨ä¸€å°è®¡ç®—æœºä¸Šç¼–è¯‘å¥½åŽï¼Œç§»æ¤åˆ°å…¶ä»–è®¡ç®—æœºä¸Šå°±å¯ä»¥ç›´æŽ¥è¿è¡Œã€‚ä¸€èˆ¬ç¨‹åºè¿è¡Œæ—¶éƒ½ä¼šä¾èµ–ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œåªè¦æŠŠå¯¹è¿™äº›åº“çš„ä¾èµ–æ–¹å¼ç”±é™æ€ä¾èµ–æ”¹æˆåŠ¨æ€ä¾èµ–ï¼Œå†æŠŠè¿™äº›åº“å’Œä¸»ä½“ç¨‹åºæ”¾åˆ°ä¸€èµ·æ‰“åŒ…ï¼Œå°±æˆä¸ºä¸€ä¸ªPortable ç¨‹åºã€‚å½“ç„¶Portable ä¹Ÿæ˜¯æœ‰é™åº¦çš„ï¼Œä¸èƒ½è·¨æ“ä½œç³»ç»Ÿç§»æ¤ï¼Œæ¯•ç«Ÿç¨‹åºå¯¹æ“ä½œç³»ç»Ÿçš„ä¾èµ–å…³è”å¤ªå¤šï¼Œé™¤éžæŠŠæ•´ä¸ªç³»ç»Ÿä¹Ÿç§»æ¤äº†ðŸ˜‚ã€‚ ä»¥Python-3.6.5 ä¸ºä¾‹ï¼Œè®²è¿°ä¸€ä¸‹æºç ç¼–è¯‘ä¸€ä¸ªPortable Pyton çš„ä¸»è¦æµç¨‹ã€‚ Windows å¹³å°winpython æ˜¯ä¸€ä¸ªä¸“é—¨ç¼–è¯‘Windows å¹³å°ä¸‹Portable Pyton çš„é¡¹ç›®ï¼Œå¯ä»¥ç›´æŽ¥ä¸‹è½½WinPython32-3.6.5.0Zero.exeæˆ–è€…WinPython64-3.6.5.0Zero.exeï¼Œè§£åŽ‹å‡ºæ¥å°±æ˜¯å¯¹åº”çš„32ä½Portable Pyton æˆ–64ä½Portable Pyton. macOS å¹³å°æœ€å¥½åœ¨OS X10.9ç³»ç»Ÿä¸‹ç¼–è¯‘Portable Pytonï¼Œå¯¹å…¶ä»–æ›´é«˜çº§çš„macOS å…¼å®¹æ€§ä¼šå¥½ä¸€äº›ã€‚python çš„ä¸€äº›å†…ç½®æ¨¡å—ä¼šä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼Œä¸»è¦æ˜¯ï¼š lzma openssl tcl/tk æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å…ˆå®‰è£…è¿™äº›åº“ã€‚ ç¼–è¯‘lzmaä¸‹è½½xz-5.2.3.tar.gzï¼Œè§£åŽ‹åˆ°/tmp/xz-5.2.3ï¼Œç„¶åŽï¼š 12345$ cd /tmp$ mkdir local$ cd xz-5.2.3$ ./configure --prefix=/tmp/local$ make &amp;&amp; make install ç¼–è¯‘opensslä¸‹è½½openssl-OpenSSL_1_0_2t.zipï¼Œè§£åŽ‹åˆ°/tmp/openssl-OpenSSL_1_0_2tï¼Œç„¶åŽï¼š 123$ cd /tmp/openssl-OpenSSL_1_0_2t$ ./Configure darwin64-x86_64-cc --prefix=/tmp/local -shared$ make &amp;&amp; make install ç¼–è¯‘tcl/tkä¸‹è½½tcl8519-src.zipï¼Œè§£åŽ‹åˆ°/tmp/tk8519-srcï¼›ä¸‹è½½tk8519-src.zipï¼Œè§£åŽ‹åˆ°/tmp/tk8519-srcï¼Œç„¶åŽï¼š 12345678$ cd /tmp/tcl8519-src$ cd unix/$ ./configure --prefix=/tmp/local$ make &amp;&amp; make install$ cd /tmp/tk8519-src$ cd unix/$ ./configure --prefix=/tmp/local --with-tcl=/tmp/tcl8519-src/unix --enable-aqua$ make &amp;&amp; make install ç¼–è¯‘pythonä¸‹è½½Python-3.6.5ï¼Œè§£åŽ‹åˆ°/tmp/Python-3.6.5ï¼Œ ç„¶åŽï¼š 1234567$ cd /tmp$ mkdir python$ cd Python-3.6.5$ CPPFLAGS="-I/tmp/local/include" \LDFLAGS="-L/tmp/local/lib" \./configure --prefix=/tmp/python $ make &amp;&amp; make install ä¿®æ”¹ä¾èµ–è·¯å¾„ä»¥ä¸Špython å®‰è£…åœ¨/tmp/pythonï¼ŒæŠŠpython ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŠ¨æ€åº“ï¼Œå¤åˆ¶åˆ°/tmp/python/libï¼š 123456789$ cd /tmp/python/lib$ cp /tmp/local/lib/liblzma.5.dylib ./$ cp /tmp/local/lib/libcrypto.1.0.0.dylib ./$ cp /tmp/local/lib/libssl.1.0.0.dylib ./$ cp /tmp/local/lib/libtcl8.5.dylib ./$ cp /tmp/local/lib/libtk8.5.dylib ./$ cp -R /tmp/local/lib/tcl8 ./$ cp -R /tmp/local/lib/tcl8.5 ./$ cp -R /tmp/local/lib/tk8.5 ./ macOSä¸‹ï¼Œotoolå·¥å…·å¯ä»¥æŸ¥çœ‹åŠ¨æ€åº“çš„ä¾èµ–è·¯å¾„ï¼Œintall_name_toolå·¥å…·å¯ä»¥ä¿®æ”¹åŠ¨æ€åº“çš„ä¾èµ–è·¯å¾„ã€‚æˆ‘ä»¬è¦æŠŠæ‰€æœ‰çš„å¤–éƒ¨ä¾èµ–ï¼ˆé™¤äº†ç³»ç»Ÿä¾èµ–ï¼‰éƒ½ä¿®æ”¹ä¸º/tmp/python/libå†…éƒ¨ä¾èµ–ï¼Œç»å¯¹çš„ä¾èµ–è·¯å¾„ä¹Ÿæ”¹ä¸ºç›¸å¯¹çš„ä¾èµ–è·¯å¾„ï¼š ä¿®æ”¹libssl.1.0.0.dylibï¼š123$ cd /tmp/python/lib$ otool -L libssl.1.0.0.dylib$ sudo install_name_tool -change /tmp/local/lib/libcrypto.1.0.0.dylib @executable_path/../lib/libcrypto.1.0.0.dylib libssl.1.0.0.dylib ä¿®æ”¹_lzma.cpython-36m-darwin.soï¼š123$ cd /tmp/python/lib/python3.6/lib-dynload$ otool -L _lzma.cpython-36m-darwin.so$ install_name_tool -change /tmp/local/lib/liblzma.5.dylib @executable_path/../lib/liblzma.5.dylib _lzma.cpython-36m-darwin.so ä¿®æ”¹_ssl.cpython-36m-darwin.soï¼š123$ cd /tmp/python/lib/python3.6/lib-dynload$ otool -L libssl.1.0.0.dylib$ install_name_tool -change /tmp/local/lib/libssl.1.0.0.dylib @executable_path/../lib/libssl.1.0.0.dylib -change /tmp/local/lib/libcrypto.1.0.0.dylib @executable_path/../lib/libcrypto.1.0.0.dylib _ssl.cpython-36m-darwin.so ä¿®æ”¹_tkinter.cpython-36m-darwin.soï¼š123$ cd /tmp/python/lib/python3.6/lib-dynload$ otool -L libssl.1.0.0.dylib$ install_name_tool -change /System/Library/Frameworks/Tcl.framework/Versions/8.5/Tcl @executable_path/../lib/libtcl8.5.dylib -change /System/Library/Frameworks/Tk.framework/Versions/8.5/Tk @executable_path/../lib/libtk8.5.dylib _tkinter.cpython-36m-darwin.so æµ‹è¯•æµ‹è¯•ä¿®æ”¹ä¾èµ–è·¯å¾„åŽçš„pythonè¿è¡Œæƒ…å†µï¼š 1234$ cd /tmp/python$ ./bin/python -m pip lmza$ ./bin/python -m pip ssl$ ./bin/python -m pip tkinter å‡çº§pip12$ cd /tmp/python$ ./bin/python -m pip install --upgrade pip æœ€åŽæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªPortable Pyton /tmp/pythonï¼Œå¯ä»¥å†…åµŒåˆ°å…¶ä»–ç¨‹åºä¸­ä¸€èµ·æ‰“åŒ…ï¼Œåˆ†å‘åˆ°å„ä¸ªè®¡ç®—æœºè¿è¡Œã€‚ å‚è€ƒ How to Compile Tcl Getting Started â€” Python Developerâ€™s Guide TkDocs - Tk Tutorial - Installing Tk Portable OpenSSL dylib on Mac OS X]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>practice</tag>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¼€å‘ä¸€ä¸ªReact + Electronåº”ç”¨]]></title>
    <url>%2Fblog%2Fpractice-develop-an-electron-app-with-react.html</url>
    <content type="text"><![CDATA[æœ€è¿‘ç”¨React + Electronå¼€å‘äº†ä¸€ä¸ªRSSé˜…è¯»å™¨ï¼Œå¼€æºåœ¨ï¼šhttps://github.com/breeze2/breaderï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹å¤§è‡´çš„å¼€å‘è¿‡ç¨‹ã€‚ åˆå§‹åŒ–åˆ›å»ºé¡¹ç›®ä»¥æ™®é€šçš„Reactåº”ç”¨åšåŸºç¡€ï¼Œä¸€æ­¥æ­¥åˆå§‹åŒ–é¡¹ç›®ã€‚é¢„å…ˆå®‰è£…yarnå·¥å…·ï¼Œç”¨yarnæ¥åˆ›å»ºä¸€ä¸ªReactåº”ç”¨é¡¹ç›®ï¼Œå‡è®¾åå­—å«demoï¼Œå†å¼•å…¥Electronä¾èµ–ã€‚ 1234$ cd /PATH/TO/PROJECTS$ yarn create react-app YOUR_APP_NAME$ cd /PATH/TO/PROJECTS/YOUR_APP_NAME$ yarn add electron --dev é…ç½®å…¥å£æ–‡ä»¶åˆ›å»ºé¡¹ç›®åŽï¼Œå¤§è‡´çš„ç›®å½•ç»“æž„å¦‚ä¸‹ï¼š 123456789|--&gt;demo |--&gt;node_modules |--... |--&gt;public |--index.html |--... |--&gt;src |--package.json |--... ä¸€èˆ¬æ¥è¯´ï¼ŒReactåº”ç”¨ï¼ˆæµ‹è¯•çŽ¯å¢ƒä¸‹ï¼‰çš„å…¥å£æ–‡ä»¶å°±æ˜¯public/index.htmlï¼Œè€ŒElectronåº”ç”¨çš„å…¥å£æ–‡ä»¶æœ€å¥½ä¹Ÿæ”¾åœ¨publicç›®å½•ä¸‹ï¼Œå¹¶å‘½åä¸ºelectron.jsï¼ˆè¿™æ ·electron-builderå¯ä»¥è‡ªåŠ¨è¯†åˆ«ï¼‰ã€‚ å…ˆåœ¨package.jsonä¸­lectronåº”ç”¨çš„å…¥å£æ–‡ä»¶ï¼Œæ·»åŠ mainé…ç½®ï¼š 12345&#123; ... "main": "public/electron.js", ...&#125; public/electron.jsä»£ç ï¼š 123456789101112131415161718192021222324252627282930const &#123; app, BrowserWindow &#125; = require('electron')const path = require('path')let mainWindowfunction createWindow() &#123; mainWindow = new BrowserWindow(&#123; width: 960, height: 600, &#125;) mainWindow.loadFile('index.html') mainWindow.webContents.openDevTools() mainWindow.on('closed', function () &#123; mainWindow = null &#125;)&#125;app.on('ready', createWindow)app.on('window-all-closed', function () &#123; if (process.platform !== 'darwin') &#123; app.quit() &#125;&#125;)app.on('activate', function () &#123; if (mainWindow === null) &#123; createWindow() &#125;&#125;) åœ¨æ‰§è¡Œæ‰§è¡Œyarn electron ./å‘½ä»¤å°±å¯ä»¥å¯åŠ¨Electronåº”ç”¨äº†ï¼Œä¸è¿‡Reactåº”ç”¨è¿˜æ²¡å¯åŠ¨èµ·æ¥ã€‚ å¯åŠ¨åº”ç”¨ä¸€èˆ¬ç”¨yarn react-scripts startå‘½ä»¤ï¼Œå°±å¯ä»¥å°†Reactåº”ç”¨æŒ‚è½½åœ¨æœ¬åœ°3000ç«¯å£ä¸Šï¼ˆ http://localhost:3000 ï¼‰ï¼Œç”¨äºŽå¼€å‘è°ƒè¯•ã€‚è¦ç”¨Reactç»“åˆElectronä¸€èµ·å¼€å‘è°ƒè¯•ï¼Œå…ˆå®‰è£…electron-is-devæ¥è¯†åˆ«å½“å‰æ˜¯å¦å¼€å‘çŽ¯å¢ƒã€‚ 1$ yarn add electron-is-dev ä¸€èˆ¬å¼€å‘çŽ¯å¢ƒæ˜¯åŠ è½½http://localhost:3000/ï¼Œæ­£å¼çŽ¯å¢ƒæ˜¯åŠ è½½../build/index.htmlæ–‡ä»¶ï¼Œæ‰€ä»¥ä¿®æ”¹public/electron.jsä»£ç ï¼ˆcreateWindowå‡½æ•°å†…ï¼‰ï¼š 12345678910const isDev = require('electron-is-dev')...-- // mainWindow.loadFile('index.html')++ if (isDev) &#123;++ mainWindow.loadURL('http://localhost:3000/')++ &#125; else &#123;++ mainWindow.loadFile(path.join(__dirname, '/../build/index.html'))++ &#125;... ç„¶åŽï¼Œåœ¨é¡¹ç›®ç›®å½•ä¸‹ï¼Œæ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œä¸€ä¸ªæ‰§è¡Œyarn react-scripts startï¼Œä¸€ä¸ªæ‰§è¡Œyarn electron ./ï¼Œå°±å¯ä»¥å¼€å‘è°ƒè¯•React + Electronåº”ç”¨äº†ã€‚ä¸ç”¨ç¾¡æ…•electron-vueï¼Œå¯ä»¥ä¸€å¥å‘½ä»¤å¯ä»¥ç›´æŽ¥å¯åŠ¨ï¼Œå…¶å®žåŽŸç†æ˜¯ä¸€æ ·çš„ã€‚è¦å®žçŽ°ä¸€å¥å‘½ä»¤å¯åŠ¨ä¹Ÿä¸éš¾ï¼Œåªè¦æŠŠä¸¤å¥å‘½ä»¤åˆåˆ°ä¸€èµ·æ‰§è¡Œå°±å¯ä»¥äº†ã€‚å…ˆå®‰è£…å·¥å…·åº“ï¼š 12$ yarn add concurrently --dev$ yarn add wait-on --dev ä¿®æ”¹package.jsonï¼Œæ·»åŠ ä¸€ä¸ªelectron-devè„šæœ¬å‘½ä»¤ï¼š 123456789&#123; ... "scripts": &#123; ... "electron-dev": "concurrently \"BROWSER=none react-scripts start\" \"wait-on http://localhost:3000 &amp;&amp; electron .\"", ... &#125; ...&#125; è¿™æ ·ï¼Œæ‰§è¡Œä¸€å¥yarn electron-devå°±å¯ä»¥å¯åŠ¨React + Electronåº”ç”¨äº†ã€‚ JSè¿è¡Œæ—¶ä¸€èˆ¬æ¥è¯´ï¼Œæµè§ˆå™¨æä¾›ä¸€ç§JSè¿è¡Œæ—¶ï¼ŒNodeJSæä¾›å¦ä¸€ç§JSè¿è¡Œæ—¶ï¼ŒElectronåˆ™æ˜¯å°†è¿™ä¸¤ç§è¿è¡Œæ—¶ç»“åˆåˆ°ä¸€èµ·æ¥æä¾›ã€‚ä¸è¿‡ï¼Œè¿™ä¸¤ç§è¿è¡Œæ—¶å¹¶ä¸æ˜¯å®Œç¾Žåœ°å’Œç¦ç›¸å¤„ï¼Œæ¯”å¦‚è¯´ä½¿ç”¨webpackæ—¶ï¼Œé€šè¿‡webpackæ‰“åŒ…çš„JSä»£ç ä¸­ï¼Œä¸èƒ½ç›´æŽ¥é€šè¿‡importå…³é”®å­—æˆ–è€…requireå‡½æ•°æ¥å¼•å…¥NodeJSæä¾›çš„åŠŸèƒ½æŽ¥å£ï¼Œå› ä¸ºwebpackè¦†ç›–äº†NodeJSè‡ªå¸¦çš„requireå‡½æ•°ã€‚ä¸è¿‡Electronä¸­ï¼Œwindowå¯¹è±¡çš„requireå±žæ€§ä¼šæ˜ å°„åˆ°NodeJSè‡ªå¸¦çš„requireå‡½æ•°ä¸Šï¼Œæ¯”å¦‚è¦è°ƒç”¨NodeJSæä¾›çš„httpæŽ¥å£ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š 1const http = window.require('http') é‡æ–°ç¼–è¯‘NodeJSæ‰©å±•é€šå¸¸ï¼Œçº¯JSä»£ç å®žçŽ°çš„å·¥å…·åº“éƒ½å¯ä»¥åœ¨ElectronçŽ¯å¢ƒä¸­è¿è¡Œã€‚ä¸è¿‡æœ‰äº›NodeJSçš„å·¥å…·åº“å¹¶ä¸æ˜¯çº¯JSä»£ç å®žçŽ°çš„ï¼Œæ¯”å¦‚node-sqlite3ã€‚node-sqlite3æ˜¯C++ç¼–å†™ï¼Œç®—æ˜¯NodeJSçš„æ‰©å±•ï¼Œè€Œä¸æ˜¯å•çº¯çš„å·¥å…·åº“ã€‚node-sqlite3éœ€è¦é’ˆå¯¹ElectronçŽ¯å¢ƒé‡æ–°ç¼–è¯‘ï¼Œæ‰èƒ½åœ¨ElectronçŽ¯å¢ƒä¸­è¿è¡Œã€‚ electron-rebuildelectron-rebuildæ˜¯ä¸“é—¨ElectronçŽ¯å¢ƒé’ˆå¯¹é‡æ–°ç¼–è¯‘NodeJSæ‰©å±•çš„ä¸€ä¸ªå·¥å…·ã€‚åœ¨é¡¹ç›®ç›®å½•ä¸‹ï¼Œå®‰è£…electron-rebuildï¼š 1$ yarn add electron-rebuild --dev æ¯”å¦‚ï¼Œé‡æ–°ç¼–è¯‘node-sqlite3ï¼Œåªéœ€è¦ï¼š 1$ yarn electron-rebuild -f -w sqlite3 åœ¨MacOSç³»ç»Ÿä¸Šå°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œåœ¨Windowsç³»ç»Ÿå°±å¤æ‚ä¸€äº›ã€‚ Windowsç³»ç»Ÿä¸Šé‡æ–°ç¼–è¯‘NodeJSæ‰©å±•åœ¨Windowsç³»ç»Ÿä¸Šä¹Ÿä¸€æ ·å¯ä»¥ä½¿ç”¨electron-rebuildå·¥å…·ï¼Œä½†å¿…é¡»é¢„å…ˆé…ç½®å¥½ç¼–è¯‘çŽ¯å¢ƒã€‚ é¦–å…ˆï¼Œå®‰è£…windowç¼–è¯‘å·¥å…·ï¼š 12$ npm install --global --production windows-build-tools$ npm config set msvs_version 2017 ç„¶åŽï¼Œä¸‹è½½å¹¶å®‰è£…Python2ï¼Œå¿…é¡»Python2ä¸èƒ½Python3ï¼Œå¦‚æžœåŒæ—¶å®‰è£…äº†Python2å’ŒPython3ï¼Œé¡»ç»™npmæŒ‡å®šPython2å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œé¿å…è°ƒç”¨äº†Python3ï¼š 1$ npm config set python /path/to/executable/python2 è¿™æ ·ï¼Œæ‰èƒ½åœ¨Windowsç³»ç»Ÿä¸Šè°ƒç”¨electron-rebuildã€‚å¦‚æžœelectron-rebuildæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œé‡ä¸ŠCONNECT ERRORå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥æ¢æˆæ·˜å®æºå†è¯•è¯•ã€‚ æ‰€ä»¥å°½é‡å°‘ç”¨NodeJSæ‰©å±•ï¼Œå¯ä»¥å…åŽ»è·¨å¹³å°æ—¶é‡æ–°ç¼–è¯‘çš„éº»çƒ¦ã€‚ åº”ç”¨æ‰“åŒ…åº”ç”¨å¼€å‘å®ŒæˆåŽï¼Œéœ€è¦æ‰“åŒ…æˆdmgæˆ–exeç­‰å®‰è£…æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨electron-builder electron-builderelectron-builderæœ‰å¾ˆå¤šé…ç½®é€‰é¡¹ï¼Œæ¥è°ƒç”¨å„å¼å„æ ·çš„ç¨‹åºæ‰“åŒ…ã€‚è¿™é‡Œåªç®€å•ä»‹ç»ä¸€ä¸‹MacOSç³»ç»Ÿå®‰è£…ç¨‹åºå’ŒWindowsç³»ç»ŸNSISå®‰è£…ç¨‹åºçš„æ‰“åŒ…é…ç½®ï¼ˆNSISæ˜¯ä¸€ä¸ªå¼€æºçš„ Windows ç³»ç»Ÿä¸‹å®‰è£…ç¨‹åºåˆ¶ä½œå·¥å…·ï¼‰ã€‚ ä¿®æ”¹package.jsonï¼Œæ·»åŠ buildé…ç½®ï¼š 123456789101112131415161718192021222324252627&#123; ... "homepage": "./", // å› ä¸ºæœ€åŽReactåº”ç”¨å¼•ç”¨çš„JSã€CSSç­‰èµ„æºéƒ½æ˜¯æœ¬åœ°çš„ï¼Œåªè¦ç”¨å½“å‰çš„ç›¸å¯¹è·¯å¾„å³å¯ "build": &#123; "appId": "com.xxx.app", // åº”ç”¨ID "npmRebuild": true, // æ‰“åŒ…å‰æ˜¯å¦é‡æ–°ç¼–è¯‘NodeJSæ‰©å±• "mac": &#123; "category": "news", // åº”ç”¨åˆ†ç±» "icon": "build/icon.png" // åº”ç”¨iconè·¯å¾„ &#125;, "win": &#123; "icon": "build/icon.png", // åº”ç”¨iconè·¯å¾„ "target": "nsis" // Windowså®‰è£…æ–‡ä»¶çš„ç›®æ ‡ç±»åž‹ &#125;, "nsis": &#123; "allowToChangeInstallationDirectory": true, // æ˜¯å¦å…è®¸ä¿®æ”¹å®‰è£…è·¯å¾„ "allowElevation": false, // æ˜¯å¦å…è®¸æå‡æƒé™ "createDesktopShortcut": true, // æ˜¯å¦åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ "menuCategory": true, //æ˜¯å¦åœ¨èœå•æ åˆ›å»ºåˆ†ç±» "oneClick": false // æ˜¯å¦ä¸€é”®å®‰è£… &#125;, "files": [ "build/**/*" // å¼•å…¥çš„æ–‡ä»¶ ] &#125; ...&#125; ç„¶åŽï¼Œå°±å¯ä»¥æ‰“åŒ…Electronåº”ç”¨äº†ï¼š 12$ yarn react-scripts build // å…ˆç”¨webpackæ‰“åŒ…Reactåº”ç”¨åˆ°`build`ç›®å½•ä¸‹$ yarn eletron-builder // å†ç”¨eletron-builderæ‰“åŒ…Electronåº”ç”¨ å½“ç„¶ï¼Œæ­£å¼æ‰“åŒ…è¿˜éœ€è¦ä»£ç ç­¾åï¼Œè¿˜æœ‰æ›´å¤šé…ç½®ï¼Œè¯·æŸ¥çœ‹electron-builderé…ç½®è¯´æ˜Žã€‚ å‚è€ƒ From React to an Electron app ready for production]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>practice</tag>
        <tag>react</tag>
        <tag>electron</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[PHPä»£ç é™æ€åˆ†æžå·¥å…·PHPStan]]></title>
    <url>%2Fblog%2Fpractice-php-static-analysis-tool-phpstan.html</url>
    <content type="text"><![CDATA[æœ€è¿‘å‘çŽ°è‡ªå·±å†™çš„PHPä»£ç è¿è¡Œç»“æžœæ€»è·Ÿè‡ªå·±é¢„æƒ³çš„ä¸ä¸€æ ·ï¼ŒæŽ’æŸ¥æ—¶å‘çŽ°å¤§å¤šæ˜¯è¯­æ³•é”™è¯¯ï¼Œåœ¨è¿è¡Œä¹‹å‰é”™è¯¯å·²ç»ç§ä¸‹ã€‚å¯èƒ½æ˜¯è‡ªå·±ç²—å¿ƒå¤§æ„ï¼Œæˆ–è€…è¯´php -læ£€æµ‹å¤ªç®€å•ï¼Œä¸è¿‡çš„ç¡®æ˜¯æœ‰ä¸€äº›è¯­æ³•é”™è¯¯åŸ‹è—å¾—å¤ªæ·±ï¼ˆæ¯•ç«ŸPHPæ˜¯åŠ¨æ€è¯­è¨€ï¼‰ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŠžæ³•ï¼Œåœ¨ä»£ç ä»£ç æ­£å¼è¿è¡Œä¹‹å‰ï¼ŒæŠŠè¯­æ³•é”™è¯¯å…¨æ‰¾å‡ºæ¥å‘¢ï¼Ÿ è¿™é‡Œä»‹ç»ä¸€æ¬¾PHPä»£ç é™æ€åˆ†æžå·¥å…·ï¼šPHPStanï¼Œä¸éœ€è¦è¿è¡Œä»£ç ï¼Œä¹Ÿå¯ä»¥å¯¹ä»£ç è¿›è¡Œä¸¥æ ¼çš„è¯­æ³•æ£€æµ‹ï¼Œå°½é‡å°†ä»£ç è¿è¡Œé”™è¯¯çŽ‡é™åˆ°æœ€ä½Žã€‚ PHPStanå®‰è£…ç›®å‰ï¼ŒPHPStanV0.10.2è¦æ±‚ç³»ç»ŸçŽ¯å¢ƒçš„PHPç‰ˆæœ¬ä¸ä½ŽäºŽ7.1ã€‚ç”¨Composerå…¨å±€å®‰è£…ï¼š 1$ composer global require phpstan/phpstan ä½¿ç”¨PHPStané™æ€åˆ†æžçš„ä½¿ç”¨æ–¹æ³•ååˆ†ç®€å•ï¼š 1$ phpstan analyse [-c|--configuration CONFIGURATION] [-l|--level LEVEL] [--no-progress] [--debug] [-a|--autoload-file AUTOLOAD-FILE] [--errorFormat ERRORFORMAT] [--memory-limit MEMORY-LIMIT] [--] [&lt;paths&gt;]... configurationï¼šè¿è¡Œé…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼› levelï¼šä¸¥æ ¼çº§åˆ«ï¼Œ0-7ï¼Œè¶Šå¤§è¶Šä¸¥æ ¼ï¼› no-progressï¼šä¸æ˜¾ç¤ºè¿›åº¦ï¼› debugï¼šdebugæ¨¡å¼ï¼› autoload-fileï¼šè‡ªåŠ¨åŠ è½½æ–‡ä»¶çš„è·¯å¾„ï¼› errorFormatï¼šé”™è¯¯æ ¼å¼ï¼› memory-limitï¼šå†…å­˜é™åˆ¶ï¼› pathsï¼šå¾…åˆ†æžçš„æ–‡ä»¶è·¯å¾„ã€‚ æ¯”å¦‚ï¼Œåˆ†æžä¸€ä¸ªPHPæ–‡ä»¶ï¼š 1$ phpstan analyse --level=7 --autoload-file=/PATH/TO/vendor/autoload.php /PATH/TO/someone.php PHPStan in VSCodeå½“ç„¶ï¼Œè¯­æ³•åˆ†æžåº”è¯¥æ˜¯ç¼–è¾‘å™¨åšçš„äº‹ï¼Œå†™å®Œä»£ç è¿˜è¦åˆ‡æ¢åˆ°å‘½ä»¤ç»ˆç«¯æ‰§è¡Œphpstanï¼Œæœªå…è¿‡äºŽç¹çã€‚æ‰€ä»¥è¿™é‡ŒæŽ¨èä¸€æ¬¾VSCodeæ‰©å±•ï¼šPHP Static Analysisã€‚ é¦–å…ˆï¼Œç”¨Composerå…¨å±€å®‰è£…PHPStanï¼›ç„¶åŽï¼Œåœ¨VSCodeçš„æ‰©å±•ç®¡ç†ä¸­æœç´¢PHP Static Analysisï¼Œå®‰è£…ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ‰©å±•ï¼›é‡è½½VSCodeé‡è½½çª—å£åŽï¼Œæ‰©å±•ä¼šè‡ªåŠ¨åˆ†æžVSCodeä¸‹æ‰“å¼€çš„PHPæ–‡ä»¶ã€‚ è¿è¡Œæ•ˆæžœï¼š æ¯”å¦‚ï¼Œå£°æ˜Žäº†ä¸€ä¸ªå˜é‡æœªè°ƒç”¨ï¼Œè°ƒç”¨äº†ä¸€ä¸ªæœªå£°æ˜Žçš„å˜é‡å’Œè°ƒç”¨äº†ä¸€ä¸ªæœªå®šä¹‰çš„æ–¹æ³•ç­‰ç­‰è¿™æ ·é”™è¯¯éƒ½ä¼šè¢«æ£€æµ‹å‡ºäº†ã€‚ ä¸è¿‡ï¼Œå®½æ¾ä¸€ç‚¹åœ°æ¥è¯´ï¼Œå…¶å®ž$this-&gt;array()æ–¹æ³•æ˜¯å­˜åœ¨çš„ï¼Œåªæ˜¯é€šè¿‡é­”æœ¯æ–¹æ³•__call()å®žçŽ°çš„ã€‚ PHPStan with Laravelé«˜ä¸¥æ ¼çº§åˆ«çš„PHPStanæ£€æµ‹åˆ°è°ƒç”¨æœªå£°æ˜Žçš„ç±»æ–¹æ³•æ—¶ï¼Œä¼šæŠ¥å‘Šç±»ä¸­æ–¹æ³•ä¸å­˜åœ¨çš„é”™è¯¯ï¼Œå³ä½¿è¿™ä¸ªç±»å®šä¹‰äº†__call()æˆ–__callStatic()ã€‚ å¾ˆå¤šåº”ç”¨æ¡†æž¶ä¸ºäº†ä¼˜é›…ï¼Œå¤§é‡ä½¿ç”¨äº†é­”æœ¯æ–¹æ³•ï¼Œæ¯”å¦‚Laravelã€‚ç”¨PHPStanæ£€æµ‹Laravelé¡¹ç›®ï¼Œè‡ªç„¶ä¼šæŠ¥å‘Šå¾ˆå¤šè°ƒç”¨æœªå£°æ˜Žç±»æ–¹æ³•çš„é”™è¯¯ï¼Œå¯¹äºŽè¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å€ŸåŠ©laravel-ide-helperæ¥é™ä½Žè¯¯æŠ¥ã€‚ å®‰è£…laravel-ide-helper12$ cd /PATH/TO/LARAVEL_PROJECT$ composer require barryvdh/laravel-ide-helper æ³¨å…¥LaravelIdeHelperç¼–è¾‘app/Providers/AppServiceProvider.phpé‡Œçš„æ³¨å†Œæ–¹æ³•ï¼š 123456789&lt;?php ... public function register() &#123; if ($this-&gt;app-&gt;environment() !== 'production') &#123; $this-&gt;app-&gt;register(\Barryvdh\LaravelIdeHelper\IdeHelperServiceProvider::class); &#125; // ... &#125; ç”Ÿæˆ_ide_helper.php12$ cd /PATH/TO/LARAVEL_PROJECT$ php artisan ide-helper:generate è¿™æ—¶ï¼ŒLaravelæ¡†æž¶ä¸­çš„Facadeç±»ï¼ŒåŽŸæœ¬é€šè¿‡__callStatic()èŽ·å–çš„é™æ€æ–¹æ³•ï¼Œå…¨éƒ¨åœ¨_ide_helper.phpå£°æ˜Žäº†ï¼Œåœ¨PHPStanæ£€æµ‹Laravelé¡¹ç›®ä»£ç æ—¶å¼•å…¥_ide_helper.phpæ–‡ä»¶ï¼Œå°±å¯ä»¥å‡å°‘è¯¯æŠ¥ã€‚ PHPStané…ç½®åœ¨Laravelé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»ºphpstan.neonæ–‡ä»¶ï¼š 123parameters: autoload_files: - %currentWorkingDirectory%/_ide_helper.php åœ¨Laravelé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œphpstanå‘½ä»¤æ—¶ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨phpstan.neonè¿™ä¸ªé…ç½®ã€‚ æœ€åŽä»£ç çš„è¯­æ³•é”™è¯¯ï¼Œåº”è¯¥åœ¨ç¼–å†™çš„æ—¶å€™åŠæ—¶å‘çŽ°ï¼Œå°½é‡å‡å°‘æ­£å¼è¿è¡Œæ—¶é”™è¯¯ã€‚]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>practice</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”¨Swooleå®žçŽ°ä¸€ä¸ªç®€å•çš„MySQLè¿žæŽ¥æ± ]]></title>
    <url>%2Fblog%2Fswoole-a-simple-mysql-connection-pool.html</url>
    <content type="text"><![CDATA[æœ€è¿‘Swooleå‘å¸ƒäº†4.0.2ç‰ˆæœ¬ï¼Œå†…ç½®åç¨‹æ›´åŠ å®Œå–„ï¼Œåˆ©ç”¨Swoole\Coroutine\Channelå’ŒSwoole\Coroutine\MySQLå¯ä»¥è½»æ¾å®žçŽ°ä¸€ä¸ªMySQLè¿žæŽ¥æ± ã€‚ å®žçŽ°ä»£ç ç›´æŽ¥çœ‹ä»£ç ï¼Œè„šæœ¬mysql_connection_pool.phpï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192&lt;?php// mysql_connection_pool.phpuse Swoole\Coroutine as Co;use Swoole\Coroutine\Channel as CoChannel;use Swoole\Coroutine\MySQL as CoMySQL;use Swoole\Http\Server as HttpServer;class MySqlCoroutine extends CoMySQL&#123; protected $used_at = null; public function getUsedAt() &#123; return $this-&gt;used_at; &#125; public function setUsedAt($time) &#123; $this-&gt;used_at = $time; &#125; public function isConnected() &#123; return $this-&gt;connected; &#125;&#125;class MySqlManager&#123; protected $max_number; protected $min_number; protected $config; protected $channel; protected $number; private $is_recycling = false; /** * [__construct æž„é€ å‡½æ•°] * @param array $config [MySQLæœåŠ¡å™¨ä¿¡æ¯] * @param integer $max_number [æœ€å¤§è¿žæŽ¥æ•°] * @param integer $min_number [æœ€å°è¿žæŽ¥æ•°] */ public function __construct(array $config, $max_number = 150, $min_number = 50) &#123; $this-&gt;max_number = $max_number; $this-&gt;min_number = $min_number; $this-&gt;config = $config; // $this-&gt;channel = new CoChannel($max_number); $this-&gt;number = 0; &#125; public function initChannel() &#123; $this-&gt;channel = new CoChannel($this-&gt;max_number); &#125; private function isFull() &#123; return $this-&gt;number === $this-&gt;max_number; &#125; private function isEmpty() &#123; return $this-&gt;number === 0; &#125; private function shouldRecover() &#123; return $this-&gt;number &gt; $this-&gt;min_number; &#125; private function increase() &#123; return $this-&gt;number += 1; &#125; private function decrease() &#123; return $this-&gt;number -= 1; &#125; protected function build() &#123; if (!$this-&gt;isFull()) &#123; printf("%d do %s\n", time(), 'build one'); $this-&gt;increase(); $mysql = new MySqlCoroutine(); $mysql-&gt;connect($this-&gt;config); $mysql-&gt;setUsedAt(time()); return $mysql; &#125; return false; &#125; protected function rebuild(MySqlCoroutine $mysql) &#123; printf("%d do %s\n", time(), 'rebuild one'); $mysql-&gt;connect($this-&gt;config); $mysql-&gt;setUsedAt(time()); return $mysql; &#125; protected function destroy(MySqlCoroutine $mysql) &#123; if (!$this-&gt;isEmpty()) &#123; printf("%d do %s\n", time(), 'destroy one'); $this-&gt;decrease(); return true; &#125; return false; &#125; public function push(MySqlCoroutine $mysql) &#123; if (!$this-&gt;channel-&gt;isFull()) &#123; printf("%d do %s\n", time(), 'push one'); $this-&gt;channel-&gt;push($mysql); return; &#125; &#125; public function pop() &#123; if ($mysql = $this-&gt;build()) &#123; return $mysql; &#125; $mysql = $this-&gt;channel-&gt;pop(); $now = time(); printf("%d do %s\n", time(), 'pop one'); if (!$mysql-&gt;isConnected()) &#123; return $this-&gt;rebuild($mysql); &#125; $mysql-&gt;setUsedAt($now); return $mysql; &#125; /** * [autoRecycling è‡ªåŠ¨å›žæ”¶è¿žæŽ¥] * @param integer $timeout [è¿žæŽ¥ç©ºç½®æ—¶é™] * @param integer $sleep [å¾ªçŽ¯æ£€æŸ¥çš„æ—¶é—´é—´éš”] * @return null [null] */ public function autoRecycling($timeout = 200, $sleep = 20) &#123; if (!$this-&gt;is_recycling) &#123; $this-&gt;is_recycling = true; while (1) &#123; Co::sleep($sleep); if ($this-&gt;shouldRecover()) &#123; $mysql = $this-&gt;channel-&gt;pop(); $now = time(); if ($now - $mysql-&gt;getUsedAt() &gt; $timeout) &#123; printf("%d do %s\n", time(), 'recover one'); $this-&gt;decrease(); &#125; else &#123; !$this-&gt;channel-&gt;isFull() &amp;&amp; $this-&gt;channel-&gt;push($mysql); &#125; &#125; &#125; &#125; &#125;&#125;$server = new HttpServer('127.0.0.1', 9501, SWOOLE_BASE);$server-&gt;set([ 'worker_num' =&gt; 1,]);$manager = new MySqlManager([ 'host' =&gt; '127.0.0.1', 'port' =&gt; 3306, 'user' =&gt; 'root', 'password' =&gt; '', 'database' =&gt; 'test', 'timeout' =&gt; -1,], 4, 2);$server-&gt;on('workerStart', function ($server) use ($manager) &#123; $manager-&gt;initChannel(); $manager-&gt;autoRecycling(4, 2); // å¯åŠ¨è‡ªåŠ¨å›žæ”¶&#125;);$server-&gt;on('request', function ($request, $response) use ($server, $manager) &#123; $mysql = $manager-&gt;pop(); // å–å‡ºä¸€ä¸ªMySQLè¿žæŽ¥ $mysql-&gt;query('select sleep(1);'); $manager-&gt;push($mysql); // è¿”å›žä¸€ä¸ªMySQLè¿žæŽ¥ $response-&gt;end(json_encode($server-&gt;stats()));&#125;);$server-&gt;start(); è¿è¡Œæ•ˆæžœè¿è¡Œè„šæœ¬ï¼š 1$ php mysql_connection_pool.php abæµ‹è¯•ï¼š 1$ ab -c 8 -n 8 http://127.0.0.1:9501/ é—´éš”10ç§’åŽï¼Œå†æ¬¡æµ‹è¯•ï¼š 1$ ab -c 8 -n 8 http://127.0.0.1:9501/ è¾“å‡ºç»“æžœï¼š 12345678910111213141516171819202122232425262728293031323334353637381532083141 do build one1532083141 do build one1532083141 do build one1532083141 do build one1532083142 do push one1532083142 do push one1532083142 do push one1532083142 do pop one1532083142 do pop one1532083142 do pop one1532083142 do push one1532083142 do pop one1532083143 do push one1532083143 do push one1532083143 do push one1532083143 do push one1532083147 do recover one1532083149 do recover one1532083160 do build one1532083160 do build one1532083160 do pop one1532083160 do rebuild one1532083160 do pop one1532083160 do rebuild one1532083161 do push one1532083161 do pop one1532083161 do push one1532083161 do push one1532083161 do push one1532083161 do pop one1532083161 do pop one1532083161 do pop one1532083162 do push one1532083162 do push one1532083162 do push one1532083162 do push one1532083166 do recover one1532083168 do recover one ä»£ç è§£é‡Šé¦–å…ˆä»£ç é‡Œå®šä¹‰äº†ä¸¤ä¸ªç±»ï¼Œåˆ†åˆ«æ˜¯ï¼š MySqlCoroutine MySqlManager MySqlCoroutineMySqlCoroutineç»§æ‰¿è‡ªSwoole\Coroutine\MySQLï¼Œä¸»è¦æ˜¯ä¸ºäº†å¢žåŠ ä¸€ä¸ªå±žæ€§used_atå’Œä¸¤ä¸ªä¸Žä¹‹é…å¥—çš„get/setæ–¹æ³•ï¼šgetUsedAtå’ŒsetUsedAtã€‚used_atæ˜¯ä¸ªæ—¶é—´æˆ³ï¼Œè®°å½•MySqlCoroutineçš„è¢«è°ƒç”¨çš„æ—¶é—´ç‚¹ã€‚è€ŒisConnectedæ–¹æ³•æ˜¯åˆ¤æ–­ä¸ŽæœåŠ¡å™¨çš„è¿žæŽ¥æ˜¯å¦æœ‰æ•ˆã€‚ MySqlManageræ¯ä¸ªMySqlCoroutineå®žä¾‹ä¸ŽMySQLæœåŠ¡å™¨ç»´ç³»ä¸€ä¸ªè¿žæŽ¥ï¼Œè€ŒMySqlManageræ¥ç®¡ç†è¿™äº›MySqlCoroutineï¼Œå³ç®¡ç†æ•´ä¸ªè¿žæŽ¥æ± ã€‚æž„å»ºMySqlManageræ—¶ï¼Œç”¨åˆ°ä¸‰ä¸ªå‚æ•°ï¼š configï¼šç”¨äºŽæž„å»ºMySqlCoroutineï¼› max_numberï¼šæœ€å¤§è¿žæŽ¥æ•°ï¼› min_numberï¼šæœ€å°è¿žæŽ¥æ•°ã€‚ å…¶å®žè¿™é‡Œè¯´çš„è¿žæŽ¥æ± ï¼Œå°±æ˜¯MySqlManagerçš„mysql_channelå±žæ€§ï¼Œå®žé™…çš„æ•°æ®ç±»åž‹æ˜¯Swoole\Coroutine\Channelã€‚è€Œæ± å†…è¿žæŽ¥çš„æ•°é‡ï¼Œä¼šç”¨numberå±žæ€§è®°å½•ä¸‹æ¥ã€‚ å†…éƒ¨æ–¹æ³•ï¼šbuild/rebuild/destroy buildæ–¹æ³•ï¼šå¦‚æžœå½“å‰è¿žæŽ¥çš„æ•°é‡æœªè¾¾åˆ°æœ€å¤§å€¼ï¼Œåˆ™æ–°å»ºä¸€ä¸ªMySqlCoroutineå®žä¾‹ä½œè¿”å›žå€¼ï¼Œå¹¶ä¸”numberå±žæ€§åŠ 1ï¼›å¦åˆ™ï¼Œè¿”å›žfalseã€‚ rebuildæ–¹æ³•ï¼šä¼ å…¥ä¸€ä¸ªMySqlCoroutineå®žä¾‹ï¼Œè¿”å›žä¸€ä¸ªæ–°çš„MySqlCoroutineå®žä¾‹ã€‚ destroyæ–¹æ³•ï¼šä¼ å…¥ä¸€ä¸ªMySqlCoroutineå®žä¾‹ï¼Œå¦‚æžœnumberå¤§äºŽ0ï¼Œé‚£ä¹ˆnumberå‡1ã€‚ å…¬æœ‰æ–¹æ³•ï¼špop/push/autoRecycling popæ–¹æ³•ï¼šå…ˆæ‰§è¡Œbuildæ–¹æ³•ï¼Œè‹¥æ˜¯è¿”å›žMySqlCoroutineå®žä¾‹ï¼Œåˆ™ç›´æŽ¥è¿”å›žè¿™ä¸ªMySqlCoroutineå®žä¾‹ï¼›å¦åˆ™ï¼Œä»Žmysql_channelé‡Œpopï¼ˆå¦‚æžœmysql_channelå·²ç»ç©ºäº†ï¼Œå½“å‰åç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç­‰å¾…å…¶ä»–åç¨‹å¾€mysql_channelæ”¾å…¥MySqlCoroutineå®žä¾‹ï¼‰ï¼Œè‹¥æ˜¯å–å‡ºçš„MySqlCoroutineå®žä¾‹çš„è¿žæŽ¥å·²æ— æ•ˆï¼ˆè¿žæŽ¥å¯èƒ½å·²ç»è¢«MySQLæœåŠ¡å™¨è‡ªåŠ¨æ–­å¼€ï¼‰ï¼Œé‚£å°±è¿”å›žrebuildæ–¹æ³•çš„å€¼ï¼Œå¦åˆ™ç›´æŽ¥è¿”å›žè¿™ä¸ªMySqlCoroutineå®žä¾‹ã€‚ pushæ–¹æ³•ï¼šå¦‚æžœmysql_channelæœªæ»¡ï¼Œå°±å¾€mysql_channelæ”¾å…¥ä¸€ä¸ªMySqlCoroutineï¼›å¦åˆ™ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚ autoRecyclingæ–¹æ³•ï¼šæŽ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œ$timeouå’Œ$sleepï¼›æ¯éš”$sleepç§’ï¼Œå°±æ£€æŸ¥ä¸€æ¬¡ï¼Œå½“å‰è¿žæŽ¥çš„æ•°é‡è¶…è¿‡äº†æœ€å°å€¼ï¼Œé‚£ä¹ˆå°±ä»Žmysql_channelé‡Œpopä¸€ä¸ªMySqlCoroutineå®žä¾‹ï¼Œè‹¥æ˜¯MySqlCoroutineå®žä¾‹ä¸Šä¸€æ¬¡ä½¿ç”¨æ—¶é—´ä¸ŽçŽ°åœ¨æ—¶é—´é—´éš”è¶…è¿‡äº†$timeouç§’ï¼Œè¯´æ˜Žè¿™ä¸ªMySqlCoroutineå®žä¾‹æ²¡æœ‰è¢«é¢‘ç¹ä½¿ç”¨ï¼Œå¯ä»¥å›žæ”¶ï¼›æ‰€è°“å›žæ”¶ï¼Œå°±æ˜¯ä»Žmysql_channelå–å‡ºåŽï¼Œä¸å†æ”¾å›žï¼Œå¹¶ä¸”numberå‡1ã€‚ è°ƒç”¨åœ¨Swoole\Http\Serverçš„workerStartå›žè°ƒå‡½æ•°é‡Œï¼Œè®©MySqlManagerå®žä¾‹å¼€å§‹è‡ªåŠ¨å›žæ”¶MySqlCoroutineå®žä¾‹ï¼›è€Œåœ¨Swoole\Http\Serverçš„requestå›žè°ƒå‡½æ•°é‡Œï¼Œéœ€è¦MySqlCoroutineå®žä¾‹æ—¶ï¼Œè°ƒç”¨MySqlManagerå®žä¾‹çš„popæ–¹æ³•ä»Žè¿žæŽ¥æ± é‡ŒèŽ·å–ï¼Œç”¨å®Œå†è°ƒç”¨MySqlManagerå®žä¾‹çš„pushæ–¹æ³•æ”¾å›žè¿žæŽ¥æ± ã€‚ æœ€åŽå°±è¿™æ ·ï¼Œåˆ©ç”¨Swooleæ‰©å±•ï¼Œå‡ åè¡ŒPHPä»£ç å°±èƒ½å®žçŽ°ä¸€ä¸ªè¿žæŽ¥é—´å¯ä»¥å¹¶è¡Œä½¿ç”¨ï¼Œæ± å†…æœ‰æœ€å¤§/æœ€å°æ•°é‡é™åˆ¶ï¼Œæœ‰è‡ªåŠ¨å›žæ”¶ç©ºé—²è¿žæŽ¥æœºåˆ¶çš„MySQLè¿žæŽ¥æ± ã€‚]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>php</tag>
        <tag>practice</tag>
        <tag>swoole</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åœ¨JPEGå›¾ç‰‡ä¸­åµŒå…¥HTML]]></title>
    <url>%2Fblog%2Fpractice-embed-html-in-jpeg.html</url>
    <content type="text"><![CDATA[æœ€è¿‘çœ‹åˆ°ä¸€ä¸ªæœ‰è¶£çš„ç½‘é¡µï¼šhttp://lcamtuf.coredump.cx/squirrel/ï¼Œæˆ–è€…è¯´ä¸€å¼ æœ‰è¶£çš„å›¾ç‰‡â€”â€”å› ä¸ºç”¨ç½‘ç»œæµè§ˆå™¨æ‰“å¼€å®ƒçœ‹åˆ°çš„æ˜¯ä¸€ä¸ªç½‘é¡µï¼Œç”¨å›¾ç‰‡æµè§ˆå™¨æ‰“å¼€å®ƒçœ‹åˆ°çš„åˆæ˜¯ä¸€å¼ å›¾ç‰‡ã€‚ åœ¨æœåŠ¡ç«¯è¦å¯¹åŒä¸€ä¸ªè¯·æ±‚åœ°å€å®žçŽ°ä¸åŒå“åº”æ˜¯ååˆ†ç®€å•çš„ï¼Œæ¯”å¦‚é€šè¿‡è¯·æ±‚å¤´Acceptæ¥åˆ¤æ–­ï¼š Accept=text/htmlåˆ™è¿”å›žè¶…æ–‡æœ¬ï¼› Accept=image/*åˆ™è¿”å›žå›¾ç‰‡ï¼› â€¦â€¦ å¯æ˜¯http://lcamtuf.coredump.cx/squirrel/è¿™ä¸ªç½‘é¡µï¼ˆæˆ–è€…è¯´å›¾ç‰‡ï¼‰åœ¨è„±ç¦»æœåŠ¡ç«¯çš„æƒ…å†µä¸‹ï¼Œä¾ç„¶èƒ½å¤Ÿå‘ˆçŽ°å‡ºç½‘é¡µå’Œå›¾ç‰‡ä¸¤ç§æ–‡ä»¶å†…å®¹ï¼Œè¿™æ˜¯æ€Žæ ·å®žçŽ°çš„å‘¢ï¼Ÿ åœ¨å‰ç«¯æ²¡æœ‰ç§˜å¯†ï¼Œæ‰“å¼€ç½‘ç»œæµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·æŸ¥çœ‹ä¸€ä¸‹ç½‘å€çš„å“åº”å†…å®¹ï¼š å“åº”å†…å®¹ä¸­æœ‰ç†Ÿæ‚‰HTMLæ ‡ç­¾ï¼Œä¹Ÿæœ‰ä¸€å¤§å †ä¹±ç ã€‚è¿™å †ä¹±ç åº”è¯¥æ˜¯å›¾ç‰‡æ–‡ä»¶çš„å­—ç¬¦è¯»ç ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆåœ¨ç½‘é¡µä¸Šçœ‹ä¸åˆ°å‘¢ï¼ŸåŽŸæ¥HTMLä¸­ä½¿ç”¨äº†body { visibility: hidden; }æ ·å¼å’Œ&lt;!--æ³¨é‡Šæ ‡ç­¾ï¼ˆæµè§ˆå™¨è‡ªåŠ¨è¡¥å…¨ï¼‰ï¼Œä¹±ç éƒ¨åˆ†å°±è¿™æ ·è¢«éšè—äº†ã€‚ HTMLå†…å®¹ï¼š 1&lt;html&gt;&lt;body&gt;&lt;style&gt;body &#123; visibility: hidden; &#125; .n &#123; visibility: visible; position: absolute; padding: 0 1ex 0 1ex; margin: 0; top: 0; left: 0; &#125; h1 &#123; margin-top: 0.4ex; margin-bottom: 0.8ex; &#125;&lt;/style&gt;&lt;div class=n&gt;&lt;h1&gt;&lt;i&gt;Hello, squirrel fans!&lt;/i&gt;&lt;/h1&gt;This is an embedded landing page for an image. You can link to this URL and get the HTML document you are viewing right now (soon to include essential squirrel facts); or embed the exact same URL as an image on your own squirrel-themed page:&lt;p&gt;&lt;xmp&gt;&lt;a href="http://lcamtuf.coredump.cx/squirrel/"&gt;Click here!&lt;/a&gt;&lt;/xmp&gt;&lt;xmp&gt;&lt;img src="http://lcamtuf.coredump.cx/squirrel/"&gt;&lt;/xmp&gt;&lt;p&gt;No server-side hacks involved - the magic happens in your browser. Let's try embedding the current page as an image right now (INCEPTION!):&lt;p&gt;&lt;img src="#" style="border: 1px solid crimson"&gt;&lt;p&gt;Pretty radical, eh? Send money to: lcamtuf@coredump.cx&lt;!-- ç„¶è€Œå›¾ç‰‡å±•ç¤ºä¸­ï¼Œä¹Ÿæ²¡çœ‹åˆ°HTMLçš„å†…å®¹ï¼Œåˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ JPEGç›¸å…³é¦–å…ˆå¯ä»¥ç¡®å®šè¿™å¼ å›¾ç‰‡æ˜¯JPEGæ ¼å¼ï¼Œå› ä¸ºå†…å®¹å¼€å¤´æœ‰æ˜Žæ˜¾çš„JFIFæ ‡è®°ï¼ˆJFIFï¼Œæ˜¯JPEGæœ€å¸¸è§çš„æ–‡ä»¶å­˜å‚¨æ ¼å¼ï¼Œä¹Ÿæ˜¯æ ‡å‡†çš„JPEGæ–‡ä»¶è½¬æ¢æ ¼å¼ï¼‰ã€‚JPEGæ ¼å¼å®šä¹‰äº†ä¸€ç³»åˆ—æ ‡è®°ç ï¼Œéƒ½æ˜¯ä»¥0xFFå¼€å¤´ï¼Œå¸¸è§çš„æœ‰ï¼š 0xFFD8ï¼šSOIï¼ˆStart Of Imageï¼‰ï¼Œå›¾ç‰‡å¼€å§‹æ ‡è®°ï¼› 0xFFD9ï¼šEOIï¼ˆEnd Of Imageï¼‰ï¼Œå›¾ç‰‡ç»“æŸæ ‡è®°ï¼› 0xFFDAï¼šSOSï¼ˆStart Of Scanï¼‰ï¼Œæ‰«æå¼€å§‹æ ‡è®°ï¼› 0xFFDBï¼šDQTï¼ˆDefine Quantization Tableï¼‰ï¼Œå®šä¹‰é‡åŒ–è¡¨ï¼› 0xFFC4ï¼šDHTï¼ˆDefine Huffman Tableï¼‰ï¼Œå®šä¹‰å“ˆå¤«æ›¼è¡¨ï¼› 0xFFEnï¼šAPPnï¼ˆApplication Specificï¼‰ï¼Œåº”ç”¨ç¨‹åºä¿¡æ¯ï¼› 0xFFFEï¼šCOMï¼ˆCommentï¼‰ï¼Œæ³¨é‡Šï¼› â€¦â€¦ å›¾ç‰‡çš„æ³¨é‡Šå†…å®¹ä¸ä¼šå±•ç¤ºï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬å¯ä»¥æŠŠHTMLéšè—åœ¨å›¾ç‰‡æ³¨é‡Šä¸­ã€‚ç”¨åå…­è¿›åˆ¶è¯»å–è¿™å¼ å›¾ç‰‡ï¼Œå¯ä»¥çœ‹åˆ°ï¼š è¿™å¼ å›¾ç‰‡ä¸­ä½¿ç”¨äº†æ³¨é‡Šæ ‡è®°0xFFFEï¼Œæ ‡è®°åŽé¢è·Ÿç€0x0372ã€‚0x0372è½¬æˆåè¿›åˆ¶æ˜¯882ï¼Œè€ŒHTMLå†…å®¹çš„é•¿åº¦åˆšå¥½æ˜¯880ä¸ªå­—èŠ‚ï¼ˆ0x0372æœ¬èº«å 2ä¸ªå­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“ï¼ŒHTMLå†…å®¹å°±æ˜¯å†™åœ¨è¿™å¼ å›¾ç‰‡æ³¨é‡Šä¸­ã€‚ ä»£ç å®žçŽ°ä¸‹é¢ç”¨PHPä»£ç ç®€å•å®žçŽ°ä¸€ä¸ªå°†HTMLå†…å®¹åµŒå…¥JPEGä¸­çš„å‡½æ•°ï¼š 1234567891011121314151617181920212223242526272829303132&lt;?phpfunction embedHtmlInJpeg($jpeg_file, $html_str, $html_file)&#123; $length = strlen($html_str) + 2; if ($length &gt; 256 * 256 - 1) &#123; return false; &#125; $content = ''; $reader = fopen($jpeg_file, 'rb'); $writer = fopen($html_file, 'wb'); $content = fread($reader, 2); // read 0xFFD8 fwrite($writer, $content); // write 0xFFD8 $header = 'FFFE' . sprintf('%04X', $length); $header = pack('H*', $header); $content = $header . $html_str; fwrite($writer, $content); // write 0xFFFE while (!feof($reader)) &#123; $content = fread($reader, 8192); fwrite($writer, $content); // write else &#125; fclose($reader); fclose($writer); return true;&#125;// call itembedHtmlInJpeg('lena.jpg', '&lt;html&gt;&lt;body&gt;&lt;style&gt;body &#123; visibility: hidden; &#125; .n &#123; visibility: visible; position: absolute; padding: 0 1ex 0 1ex; margin: 0; top: 0; left: 0; &#125; h1 &#123; margin-top: 0.4ex; margin-bottom: 0.8ex; &#125;&lt;/style&gt;&lt;div class=n&gt;&lt;h1&gt;&lt;i&gt;This image is a page.&lt;/i&gt;&lt;/h1&gt;Just open it in new tab.&lt;p&gt;&lt;img src="#" style="border: 1px solid crimson"&gt;&lt;!--', 'lena.html'); è¿™å¼ å›¾ç‰‡æ˜¯ä¸€ä¸ªç½‘é¡µï¼Œä¸ä¿¡ä½ å°±åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å®ƒ å®žé™…åº”ç”¨å°†ä¸€æ®µHTMLæ–‡æœ¬åµŒå…¥åˆ°ä¸€å¼ å›¾ç‰‡ä¸­ï¼Œå®žé™…ä¸Šï¼Œè¿˜æ²¡ä»€ä¹ˆåº”ç”¨ï¼Œå“ˆå“ˆå“ˆðŸ˜‚ã€‚å¦‚æžœèƒ½å°†JSæˆ–Shellè„šæœ¬è—åœ¨å›¾ç‰‡ä¸­ï¼Œå¹¶èƒ½åŽæœŸæ‰§è¡Œï¼Œé‚£å°±æœ‰æ„æ€äº†ï¼›è€Œä¸”æœ¬èº«æ˜¯ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼Œå¯ä»¥é¿è¿‡ä¸€äº›å®‰å…¨è½¯ä»¶çš„æ£€æŸ¥ã€‚]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>practice</tag>
        <tag>html</tag>
        <tag>frontend</tag>
        <tag>jpeg</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åœ¨Ubuntuä¸Šè¿è¡Œå¤šå®žä¾‹MySQL]]></title>
    <url>%2Fblog%2Fmysql-run-multiple-instances-on-ubuntu.html</url>
    <content type="text"><![CDATA[ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯ä¸€å°æœåŠ¡å™¨ä¸»æœºè¿è¡Œä¸€ä¸ªMySQLå®žä¾‹ï¼›ä¸è¿‡åœ¨å•æœºé…ç½®éžå¸¸é«˜çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘è¿è¡Œå¤šä¸ªMySQLå®žä¾‹ã€‚æ¯•ç«ŸMySQLæ˜¯å•è¿›ç¨‹ï¼ˆå¤šçº¿ç¨‹ï¼‰çš„è¿è¡Œæ¨¡å¼ï¼Œå•å®žä¾‹MySQLç”¨ä¸ä¸Šå¤ªå¤šèµ„æºã€‚ å½“ç„¶ï¼Œé«˜é…ç½®çš„å•æœºåº”è¯¥è€ƒè™‘ä½¿ç”¨Dockerå®žçŽ°å¤šMySQLæœåŠ¡ï¼Œåªæ˜¯è¿™é‡Œä»‹ç»ä¸€ä¸‹å¦‚ä½•è¿è¡Œå¤šå®žä¾‹MySQLã€‚æœ¬ä»¥ä¸ºåœ¨Ubuntuä¸Šå®žçŽ°å¾ˆå®¹æ˜“ï¼ŒåŽŸæ¥ä¹Ÿå¹¶ä¸ç®€å•ã€‚ è¿è¡ŒçŽ¯å¢ƒ Ubuntu 16.04 MySQL 5.17 mysqld_multiåœ¨å®‰è£…å¥½MySQL ServeråŽï¼Œåº”è¯¥æ˜¯å¯ä»¥ä½¿ç”¨mysqld_multiçš„ã€‚æŸ¥çœ‹é…ç½®ç¤ºä¾‹å‘½ä»¤ï¼š 123456789101112131415$ mysqld_multi --example[mysqld_multi]mysqld = /usr/bin/mysqld_safemysqladmin = /usr/bin/mysqladminuser = multi_adminpassword = my_password[mysqld2]socket = /tmp/mysql.sock2port = 3307pid-file = /var/lib/mysql2/hostname.pid2datadir = /var/lib/mysql2language = /usr/share/mysql/mysql/englishuser = unix_user1... ä¸€èˆ¬MySQLçš„é…ç½®æ–‡ä»¶æ˜¯/etc/mysql/my.cnfæˆ–è€…/etc/mysql/mysql.cnfï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­æœ€å¼€å§‹çš„åœ°æ–¹æ·»åŠ ï¼š 123[mysqld_multi]mysqld = /usr/bin/mysqld_safemysqladmin = /usr/bin/mysqladmin æŸ¥çœ‹å½“å‰mysqld_multiçŠ¶æ€ï¼š 123$ mysqld_multi report Reporting MySQL serversNo groups to be reported (check your GNRs) å¯ä»¥çœ‹åˆ°æ²¡æœ‰æœåŠ¡ç»„ç¾¤ï¼ŒçŽ°åœ¨æ·»åŠ ä¸€ä¸ªâ€”â€”åœ¨MySQLçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿½åŠ ï¼š 123456[mysqld3307]socket = /tmp/mysqld/mysqld3307.sockport = 3307pid-file = /tmp/mysqld/mysqld3307.piddatadir = /var/lib/mysql/multi/data3307user = mysql å†æŸ¥çœ‹å½“å‰mysqld_multiçŠ¶æ€ï¼š 123$ mysqld_multi report Reporting MySQL serversMySQL server from group: mysqld3307 is not running å¯ä»¥çœ‹åˆ°æœåŠ¡ç»„ç¾¤mysqld3307ï¼ˆæ³¨æ„æ¯ä¸ªæœåŠ¡ç»„ç¾¤åç§°å¿…é¡»ä»¥mysqldå¼€å¤´ï¼‰æ²¡æœ‰åœ¨è¿è¡Œã€‚çŽ°åœ¨è¿˜ä¸èƒ½ç›´æŽ¥è¿è¡Œmysqld3307æœåŠ¡ï¼Œå› ä¸ºæ²¡æœ‰åˆå§‹åŒ–æ•°æ®ç›®å½•/var/lib/mysql/multi/data3307ã€‚ åˆå§‹åŒ–æ•°æ®åº“ è¿‡åŽ»MySQLåˆå§‹åŒ–æ•°æ®åº“ä½¿ç”¨çš„æ˜¯mysql_install_dbå‘½ä»¤ï¼ŒçŽ°åœ¨æ˜¯mysqld --initializeã€‚ åœ¨Ubuntuç³»ç»Ÿä¸Šæœ‰ä¸€ä¸ªç³»ç»Ÿå®‰å…¨ç¨‹åºï¼Œå«AppArmorï¼Œå®ƒä¼šé™åˆ¶å„ä¸ªåº”ç”¨ç¨‹åºè®¿é—®ç³»ç»Ÿèµ„æºçš„æƒé™ã€‚Rootç”¨æˆ·è¿è¡Œç¨‹åºæ—¶ä¹Ÿç¢°åˆ°æƒé™ä¸è¶³é”™è¯¯çš„è¯ï¼Œé‚£ä¹ˆåº”è¯¥å°±æ˜¯AppArmoré™åˆ¶äº†ã€‚æ¯”å¦‚æˆ‘ä»¬éœ€è¦ä¿®æ”¹mysqldçš„æƒé™ï¼Œå°±å¾—ç¼–è¾‘å¯¹åº”çš„AppArmoré…ç½®æ–‡ä»¶ï¼Œç„¶åŽé‡å¯AppArmoræœåŠ¡ï¼š 12$ sudo vi /etc/apparmor.d/usr.sbin.mysqld$ sudo service apparmor restart ä¸Šé¢æœåŠ¡ç»„ç¾¤mysqld3307çš„é…ç½®ä¸­ç”¨åˆ°çš„ç›®å½•æ˜¯/tmp/mysqldå’Œ/var/lib/mysql/multiï¼Œmysqldç¨‹åºå¯¹/tmpå’Œ/var/lib/mysqléƒ½æ˜¯å…·æœ‰è¯»å†™æƒé™çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦ä¿®æ”¹AppArmoré…ç½®æ–‡ä»¶ã€‚ çŽ°åœ¨æ¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„æ•°æ®åº“ç›®å½•/var/lib/mysql/multi/data3307ï¼ˆä»¥mysqlç”¨æˆ·èº«ä»½æ‰§è¡Œï¼‰ï¼š 123$ sudo -u mysql mkdir /tmp/mysqld$ sudo -u mysql mkdir /var/lib/mysql/multi$ sudo -u mysql mysqld --initialize --user=mysql --datadir=/var/lib/mysql/multi/data3307 åˆå§‹åŒ–æˆåŠŸåŽï¼Œæ–°æ•°æ®åº“ä¼šè‡ªåŠ¨å»ºç«‹rootç”¨æˆ·ï¼Œå¹¶éšæœºç”Ÿæˆå¯†ç ï¼Œè¿™äº›ä¼šè®°å½•åœ¨MySQLæ—¥å¿—ä¸­ï¼š 1234567$ sudo tail /var/log/mysql/error.log2018-03-18T12:15:25.378684Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).2018-03-18T12:15:26.642564Z 0 [Warning] InnoDB: New log files created, LSN=457902018-03-18T12:15:26.900383Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.2018-03-18T12:15:26.986706Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 3544d1ec-2b6f-11e8-bf0a-aaaa0007ba64.2018-03-18T12:15:26.998294Z 0 [Warning] Gtid table is not ready to be used. Table 'mysql.gtid_executed' cannot be opened.2018-03-18T12:15:26.998765Z 1 [Note] A temporary password is generated for root@localhost: 4kDUVrlO&gt;zT) æˆ‘ä»¬å…ˆè®°ä½å¯†ç 4kDUVrlO&gt;zT)ã€‚ å¯åŠ¨æ–°å®žä¾‹æ‰§è¡Œä¸€ä¸‹å‘½ä»¤å³å¯ä»¥mysqlç”¨æˆ·èº«ä»½å¯åŠ¨æœåŠ¡ç»„ç¾¤mysqld3307ï¼ˆä¸éœ€è¦å‰ç¼€mysqldï¼‰ï¼š 1$ sudo -u mysql mysqld_multi start 3307 æŸ¥çœ‹å½“å‰mysqld_multiçŠ¶æ€ï¼š 123$ mysqld_multi report Reporting MySQL serversMySQL server from group: mysqld3307 is running é‡ç½®ä¸€ä¸‹å¯†ç ï¼š 123$ mysqladmin -uroot -h 127.0.0.1 -P 3307 -p'4kDUVrlO&gt;zT)' passwordNew password:Confirm new password: è¿žæŽ¥æœåŠ¡ç»„ç¾¤mysqld3307ï¼š 1$ mysql -uroot -h 127.0.0.1 -P 3307 -p å…³é—­å®žä¾‹åŽŸä»¥ä¸ºå…³é—­æœåŠ¡ç»„ç¾¤mysqld3307ï¼Œåªéœ€è¦ï¼š 1$ sudo -u mysql mysqld_multi stop 3307 ç»“æžœæŸ¥çœ‹mysqld_multiçŠ¶æ€ï¼Œmysqld3307ä¾ç„¶æ˜¯è¿è¡Œä¸­ï¼š 123$ mysqld_multi report Reporting MySQL serversMySQL server from group: mysqld3307 is running å¯èƒ½æ˜¯å› ä¸ºmysqld3307æ•°æ®åº“ä¸­æ²¡æœ‰ä¸Žmysqld_multié…ç½®å¯¹åº”çš„ç”¨æˆ·ï¼Œæ‰€ä»¥mysqld_multi stopå‘½ä»¤æ²¡èƒ½å…³é—­mysqld3307ã€‚ æˆ‘ä»¬å¯ä»¥ç”¨mysqladminå‘½ä»¤æ¥å…³é—­æœåŠ¡ç»„ç¾¤mysqld3307ï¼š 1$ mysqladmin -uroot -h 127.0.0.1 -P 3307 -p shutdown æœ€åŽè¿™é‡Œåªä»‹ç»äº†ç›‘å¬3307ç«¯å£çš„MySQLå®žä¾‹çš„å»ºç«‹è¿‡ç¨‹ï¼Œå…¶ä»–æ›´å¤šMySQLå®žä¾‹ï¼Œå¦‚ç›‘å¬3308ã€3309ç«¯å£ï¼Œåªéœ€æŒ‰ç…§ä¸Šè¿°æµç¨‹ï¼ˆæ·»åŠ é…ç½®ï¼Œåˆå§‹åŒ–æ•°æ®ç›®å½•ï¼Œå¯åŠ¨æœåŠ¡ï¼‰æ‰§è¡Œå³å¯ã€‚]]></content>
      <categories>
        <category>èº¬è¡Œ</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸€äº›æœ‰è¶£çš„MySQLæŸ¥è¯¢é—®é¢˜]]></title>
    <url>%2Fblog%2Fnote-mysql-in-leetcode.html</url>
    <content type="text"><![CDATA[åœ¨LeetCodeä¸Šæœ‰ä¸€äº›æœ‰è¶£çš„MySQLæŸ¥è¯¢é—®é¢˜ï¼Œè¿™é‡Œè®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿ä»¥åŽæŸ¥é˜…ã€‚ Department Top Three Salarieséƒ¨é—¨å‰ä¸‰è–ªèµ„é—®é¢˜ï¼šæŸ¥è¯¢å„ä¸ªéƒ¨é—¨è–ªèµ„å‰ä¸‰çš„å‘˜å·¥ï¼ˆè–ªèµ„ï¼‰ï¼Œå¹¶åˆ—æŽ’ååªå ä¸€ä½ã€‚ åŽŸé¢˜The Employee table holds all employees. Every employee has an Id, and there is also a column for the department Id. 12345678910+----+-------+--------+--------------+| Id | Name | Salary | DepartmentId |+----+-------+--------+--------------+| 1 | Joe | 70000 | 1 || 2 | Henry | 80000 | 2 || 3 | Sam | 60000 | 2 || 4 | Max | 90000 | 1 || 5 | Janet | 69000 | 1 || 6 | Randy | 85000 | 1 |+----+-------+--------+--------------+ The Department table holds all departments of the company. 123456+----+----------+| Id | Name |+----+----------+| 1 | IT || 2 | Sales |+----+----------+ Write a SQL query to find employees who earn the top three salaries in each of the department. For the above tables, your SQL query should return the following rows. 123456789+------------+----------+--------+| Department | Employee | Salary |+------------+----------+--------+| IT | Max | 90000 || IT | Randy | 85000 || IT | Joe | 70000 || Sales | Henry | 80000 || Sales | Sam | 60000 |+------------+----------+--------+ ç­”æ¡ˆå…ˆè¯´ç­”æ¡ˆï¼š 12345select dep.Name as "Department", emp.Name as "Employee", emp.Salary as "Salary"from Department as dep join Employee as emp on dep.Id = emp.DepartmentIdwhere exists (select 'x' from Employee as emp1 where emp1.Salary &gt; emp.Salary and emp1.DepartmentId = emp.DepartmentId having count(distinct emp1.Salary) &lt; 3); é¦–å…ˆDepartmentå’ŒEmployeeè”æŽ¥æ˜¯ä¸å¯å°‘çš„ï¼Œå› ä¸ºç»“æžœåŒ…å«ä¸¤å¼ è¡¨çš„å­—æ®µï¼›å†ç”¨å­æŸ¥è¯¢ï¼ˆexistsï¼‰ï¼Œä¿ç•™åŒéƒ¨é—¨å†…é«˜äºŽæœ¬èº«è–ªèµ„çš„ä¸è¶…è¿‡ä¸‰ä¸ªçš„å‘˜å·¥ï¼ˆhavingï¼‰ï¼Œå¹¶åˆ—æŽ’ååªå ä¸€ä½ï¼Œéœ€è¦åŽ»é‡ï¼ˆdistinctï¼‰ã€‚ æ³¨æ„ï¼šä»¥ä¸Š&#39;x&#39;å¹¶æ— ç‰¹æ®Šæ„ä¹‰ï¼Œåªæ˜¯æœ‰å€¼æ—¶è¡¨ç¤ºå­˜åœ¨ï¼Œæ— å€¼æ—¶è¡¨ç¤ºä¸å­˜åœ¨ã€‚ï¼›havingåº”è¯¥é…åˆgroup byä½¿ç”¨ï¼Œå•ç‹¬ä½¿ç”¨havingæ—¶è§†å½“å‰æ•°æ®ä¸ºä¸€ç»„ï¼›count()å‡½æ•°ä¹Ÿæ˜¯ï¼Œå•ç‹¬ä½¿ç”¨havingæ—¶ä¹Ÿç›¸å½“äºŽç»™å½“å‰æ•°æ®åˆ†æˆä¸€ç»„ã€‚ å¦å¤–ï¼šåªç”¨ä¸€ä¸ªselectï¼ˆæ²¡æœ‰å­æŸ¥è¯¢ï¼‰ä¹Ÿèƒ½å®žçŽ°ï¼Œå°±æ˜¯å°†Employeeå’Œè‡ªèº«joinï¼Œonè–ªèµ„æ¯”è‡ªå·±é«˜çš„å‘˜å·¥ï¼›ç„¶åŽç”¨group byåŽ»é‡ï¼Œå†ç»“åˆhaving count(distinct emp1.Salary) &lt; 3ï¼Œä¿ç•™æœ‰æ•ˆç»“æžœã€‚è¿™ä¸ªjoinæ–¹æ³•æ•ˆçŽ‡è¿œä½ŽäºŽä¸Šé¢å­æŸ¥è¯¢æ–¹æ³•ï¼Œæ‰€ä»¥ä¸è¦å¯¹å­æŸ¥è¯¢æœ‰åè§ã€‚ Human Traffic of Stadiumè¿žç»­è¾¾æ ‡é—®é¢˜ï¼šæŸ¥è¯¢è¿žç»­3å¤©ä½“è‚²é¦†äººæ•°é«˜äºŽ100çš„æ—¥æœŸã€‚ åŽŸé¢˜X city built a new stadium, each day many people visit it and the stats are saved as these columns: id, date, peoplePlease write a query to display the records which have 3 or more consecutive rows and the amount of people more than 100(inclusive).For example, the table stadium: 123456789101112+------+------------+-----------+| id | date | people |+------+------------+-----------+| 1 | 2017-01-01 | 10 || 2 | 2017-01-02 | 109 || 3 | 2017-01-03 | 150 || 4 | 2017-01-04 | 99 || 5 | 2017-01-05 | 145 || 6 | 2017-01-06 | 1455 || 7 | 2017-01-07 | 199 || 8 | 2017-01-08 | 188 |+------+------------+-----------+ For the sample data above, the output is: 12345678+------+------------+-----------+| id | date | people |+------+------------+-----------+| 5 | 2017-01-05 | 145 || 6 | 2017-01-06 | 1455 || 7 | 2017-01-07 | 199 || 8 | 2017-01-08 | 188 |+------+------------+-----------+ Note:Each day only have one row record, and the dates are increasing with id increasing. ç­”æ¡ˆæ€è·¯æ˜¯å…ˆæ‰¾å‡ºäººæ•°å¤§äºŽ100çš„æ—¥æœŸï¼Œç„¶åŽåœ¨è¿™äº›æ—¥æœŸé™„è¿‘å†æ‰¾æ•°å¤§äºŽ100çš„æ—¥æœŸï¼Œä¿ç•™èƒ½å¤Ÿå½¢æˆè¿žç»­3å¤©çš„æ—¥æœŸã€‚æç¤ºé‡Œè¯´è¡¨ä¸­æ¯ä¸€å¤©éƒ½æœ‰ä¸€æ¡è®°å½•ï¼Œè€Œä¸”æ—¥æœŸæ˜¯éšidé€’å¢žï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®¡ç®—idï¼Œè€Œä¸æ˜¯æ—¥æœŸã€‚ç”¨å­æŸ¥è¯¢çš„æ–¹æ³•ï¼š 12345678910111213select s.id, s.date, s.people from stadium as s where s.people &gt;= 100 and exists(select 'x' from stadium as s1 where s1.people &gt;= 100 and s1.id &gt;= s.id-2 and s1.id &lt;= s.id+2 and s1.id&lt;&gt;s.id having count(s1.id) &gt; 2 or (count(s1.id) = 2 and (sum(s1.id-s.id) not in (-1,1) and sum(abs(s1.id-s.id)) &lt;&gt; 4) ) ); åœ¨å½“å‰æ—¥æœŸçš„å‰2å¤©å’ŒåŽ2å¤©æ‰¾ï¼Œæ‰¾åˆ°äººæ•°å¤§äºŽ100çš„æ—¥æœŸä¸ªæ•°å¤§äºŽ2çš„è¯ï¼Œé‚£ä¹ˆå½“å‰æ—¥æœŸå¿…å®šå¯ä»¥å½¢æˆè¿žç»­3å¤©äººæ•°å¤§äºŽ100ï¼›æ‰¾åˆ°äººæ•°å¤§äºŽ100çš„æ—¥æœŸä¸ªæ•°ç­‰äºŽ2ï¼Œä¸”è¿™ä¸¤ä¸ªæ—¥æœŸä¸Žå½“å‰æ—¥æœŸçš„è·ç¦»å’Œä¸æ˜¯1æˆ–-1ï¼Œç»å¯¹è·ç¦»å’Œä¸æ˜¯4çš„è¯ï¼Œé‚£ä¹ˆå½“å‰æ—¥æœŸä¹Ÿæ˜¯å¯ä»¥å½¢æˆè¿žç»­3å¤©äººæ•°å¤§äºŽ100ï¼›å…¶ä»–æƒ…å†µéƒ½ä¸è¡Œã€‚ ç”¨joinçš„æ–¹æ³•ï¼š 12345678select distinct t1.*from stadium t1, stadium t2, stadium t3where t1.people &gt;= 100 and t2.people &gt;= 100 and t3.people &gt;= 100 and ( (t1.id - t2.id = 1 and t1.id - t3.id = 2 and t2.id - t3.id =1) -- t1, t2, t3 or (t2.id - t1.id = 1 and t2.id - t3.id = 2 and t1.id - t3.id =1) -- t2, t1, t3 or (t3.id - t2.id = 1 and t2.id - t1.id =1 and t3.id - t1.id = 2) -- t3, t2, t1 )order by t1.id; åŒæ ·ï¼Œä¸Šé¢çš„å­æŸ¥è¯¢æ–¹æ³•ä¾ç„¶æ¯”è¿™ä¸ªjoinæ–¹æ³•æ•ˆçŽ‡é«˜ã€‚ Trips and UsersåŽŸé¢˜ç”¨æˆ·å–æ¶ˆå«è½¦æœåŠ¡é—®é¢˜ï¼šç»Ÿè®¡ä¸€ä¸ªæ—¶é—´æ®µå†…æ¯å¤©ç”¨æˆ·å–æ¶ˆå«è½¦æœåŠ¡å æ‰€æœ‰å«è½¦æœåŠ¡çš„æ¯”ä¾‹ã€‚The Trips table holds all taxi trips. Each trip has a unique Id, while Client_Id and Driver_Id are both foreign keys to the Users_Id at the Users table. Status is an ENUM type of (â€˜completedâ€™, â€˜cancelled_by_driverâ€™, â€˜cancelled_by_clientâ€™). 1234567891011121314+----+-----------+-----------+---------+--------------------+----------+| Id | Client_Id | Driver_Id | City_Id | Status |Request_at|+----+-----------+-----------+---------+--------------------+----------+| 1 | 1 | 10 | 1 | completed |2013-10-01|| 2 | 2 | 11 | 1 | cancelled_by_driver|2013-10-01|| 3 | 3 | 12 | 6 | completed |2013-10-01|| 4 | 4 | 13 | 6 | cancelled_by_client|2013-10-01|| 5 | 1 | 10 | 1 | completed |2013-10-02|| 6 | 2 | 11 | 6 | completed |2013-10-02|| 7 | 3 | 12 | 6 | completed |2013-10-02|| 8 | 2 | 12 | 12 | completed |2013-10-03|| 9 | 3 | 10 | 12 | completed |2013-10-03| | 10 | 4 | 13 | 12 | cancelled_by_driver|2013-10-03|+----+-----------+-----------+---------+--------------------+----------+ The Users table holds all users. Each user has an unique Users_Id, and Role is an ENUM type of (â€˜clientâ€™, â€˜driverâ€™, â€˜partnerâ€™). 123456789101112+----------+--------+--------+| Users_Id | Banned | Role |+----------+--------+--------+| 1 | No | client || 2 | Yes | client || 3 | No | client || 4 | No | client || 10 | No | driver || 11 | No | driver || 12 | No | driver || 13 | No | driver |+----------+--------+--------+ Write a SQL query to find the cancellation rate of requests made by unbanned clients between Oct 1, 2013 and Oct 3, 2013. For the above tables, your SQL query should return the following rows with the cancellation rate being rounded to two decimal places. 1234567+------------+-------------------+| Day | Cancellation Rate |+------------+-------------------+| 2013-10-01 | 0.33 || 2013-10-02 | 0.00 || 2013-10-03 | 0.50 |+------------+-------------------+ ç­”æ¡ˆ1234select Request_at as "Day", round(1-sum(t.Status="completed")/count(t.id), 2) as "Cancellation Rate"from Trips as t join users as u on u.Users_Id = t.Client_Id and u.Banned = "No"where t.Request_at &gt;='2013-10-01' and t.Request_at&lt;='2013-10-03'group by t.Request_at; Median Employee SalaryåŽŸé¢˜ä¸­ä½è–ªèµ„é—®é¢˜ï¼šæŸ¥è¯¢å„å®¶å…¬å¸ä¸­è–ªèµ„æŽ’ä¸­ä½çš„çš„å‘˜å·¥ï¼ˆè–ªèµ„ï¼‰ã€‚The Employee table holds all employees. The employee table has three columns: Employee Id, Company Name, and Salary. 123456789101112131415161718192021+-----+------------+--------+|Id | Company | Salary |+-----+------------+--------+|1 | A | 2341 ||2 | A | 341 ||3 | A | 15 ||4 | A | 15314 ||5 | A | 451 ||6 | A | 513 ||7 | B | 15 ||8 | B | 13 ||9 | B | 1154 ||10 | B | 1345 ||11 | B | 1221 ||12 | B | 234 ||13 | C | 2345 ||14 | C | 2645 ||15 | C | 2645 ||16 | C | 2652 ||17 | C | 65 |+-----+------------+--------+ Write a SQL query to find the median salary of each company. Bonus points if you can solve it without using any built-in SQL functions. 123456789+-----+------------+--------+|Id | Company | Salary |+-----+------------+--------+|5 | A | 451 ||6 | A | 513 ||12 | B | 234 ||9 | B | 1154 ||14 | C | 2645 |+-----+------------+--------+ ç­”æ¡ˆ12345678select emp.Id, emp.Company, emp.Salaryfrom Employee as empjoin (select Company, count(*) as EmployeeNum from Employee group by Company) as emp1on emp1.Company = emp.Companywhere exists (select 'x' from Employee as emp2 where emp2.Company = emp.Company and emp2.Salary &lt; emp.Salary having count(emp2.Id) in ( floor((EmployeeNum-1)/2), floor(EmployeeNum/2) ));]]></content>
      <categories>
        <category>ç¬”è®°</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Swoole+Lumenï¼šåŒæ­¥ç¼–ç¨‹é£Žæ ¼è°ƒç”¨MySQLå¼‚æ­¥æŸ¥è¯¢]]></title>
    <url>%2Fblog%2Fswoole-lumen-asynchronous-mysql-query-with-synchronous-programming-style.html</url>
    <content type="text"><![CDATA[ç½‘ç»œç¼–ç¨‹ä¸€ç›´æ˜¯PHPçš„çŸ­æ¿ï¼Œå°½ç®¡Swooleæ‰©å±•å¼¥è¡¥äº†è¿™ä¸ªç¼ºé™·ï¼Œä½†æ˜¯å…¶ç¼–ç¨‹é£Žæ ¼åå‘äº†NodeJSæˆ–GoLangï¼Œä¸ŽåŽŸæœ¬çš„åŒæ­¥ç¼–ç¨‹é£Žæ ¼è¿¥ç„¶ç›¸å¼‚ã€‚ç›®å‰PHPçš„å¤§éƒ¨åˆ†ä¸»æµåº”ç”¨æ¡†æž¶ä¾ç„¶æ˜¯åŒæ­¥ç¼–ç¨‹é£Žæ ¼ï¼Œæ‰€ä»¥ä¸€ç›´åœ¨æŽ¢ç´¢Swooleä¸ŽåŒæ­¥ç¼–ç¨‹ç»“åˆçš„é€”å¾„ã€‚lumen-swoole-httpæ­£æ˜¯è¿žæŽ¥åŒæ­¥ç¼–ç¨‹Lumenå’Œå¼‚æ­¥ç¼–ç¨‹Swooleçš„ä¸€åº§æ¡¥æ¢ï¼Œæœ‰å…´è¶£å¯ä»¥å…³æ³¨ä¸€ä¸‹ã€‚ LNMPçš„ä¸è¶³LNMPæ˜¯ç»å…¸çš„Webåº”ç”¨æž¶æž„ç»„åˆï¼Œè™½ç„¶ï¼ˆLinuxã€NginXã€MySQLå’ŒPHP-FPMï¼‰å››è€…å„ç§æ˜¯ä¼˜ç§€çš„ç³»ç»Ÿæˆ–è½¯ä»¶ï¼Œä½†æ˜¯ç»„åˆåˆ°ä¸€èµ·çš„æ€»ä½“æ€§èƒ½å¹¶ä¸å°½äººæ„ï¼Œæ˜Žæ˜¾çš„ä¸æ˜¯1+1+1+1&gt;4ï¼Œè€Œæ˜¯4+3+2+1&lt;1ã€‚Linuxç³»ç»Ÿæ— å¯åŽšéžï¼Œä¸»è¦é—®é¢˜å‡ºçŽ°åœ¨ï¼š ä»ŽNginXåˆ°PHP-FPMNginXåˆ©ç”¨IOå¤šè·¯å¤ç”¨æœºåˆ¶epollï¼Œæžå¤§åœ°å‡å°‘äº†IOé˜»å¡žç­‰å¾…ï¼Œå¯ä»¥è½»æ¾åº”å¯¹C10Kã€‚å¯æ˜¯æ¯æ¬¡NginXå°†ç”¨æˆ·è¯·æ±‚ä¼ é€’ç»™PHP-FPMæ—¶ï¼ŒPHP-FPMæ€»æ˜¯éœ€è¦ä»Žæ–°åŠ è½½PHPé¡¹ç›®ä»£ç ï¼šåˆ›å»ºæ‰§è¡ŒçŽ¯å¢ƒï¼Œè¯»å–PHPæ–‡ä»¶å’Œä»£ç è§£æžã€ç¼–è¯‘ç­‰æ“ä½œä¸€æ¬¡åˆä¸€æ¬¡çš„é‡å¤æ‰§è¡Œï¼Œé€ æˆä¸å°çš„æ¶ˆè€—ã€‚ ä»ŽPHP-FPMåˆ°MySQLç”±äºŽPHPä»£ç æœ¬èº«æ˜¯åŒæ­¥æ‰§è¡Œï¼ŒPHP-FPMè¿žæŽ¥MySQLæŸ¥è¯¢æ•°æ®æ—¶ï¼Œåªèƒ½ç©ºé—²ç­‰å¾…MySQLè¿”å›žæŸ¥è¯¢ç»“æžœã€‚ä¸€ä¸ªæŸ¥è¯¢è¯­å¥æ‰§è¡Œæ—¶é—´å¯èƒ½ä¼šéœ€è¦å‡ ç§’é’Ÿï¼ŒæœŸé—´PHP-FPMè‹¥æ˜¯èƒ½æš‚æ—¶æ”¾ä¸‹å½“å‰ç”¨æˆ·æ…¢æŸ¥è¯¢è¯·æ±‚ï¼Œè€ŒåŽ»å¤„ç†å…¶ä»–ç”¨æˆ·è¯·æ±‚ï¼Œæ•ˆçŽ‡å¿…ç„¶æœ‰æ‰€æé«˜ã€‚ Swoole HTTPæœåŠ¡å™¨Swoole HTTPæœåŠ¡å™¨ä¹Ÿé‡‡ç”¨äº†epollæœºåˆ¶ï¼Œè¿è¡Œæ€§èƒ½ä¸ŽNginXç›¸æ¯”ï¼Œè™½ä¸åŠï¼ŒçŠ¹æœªè¿œã€‚ä¸è¿‡Swoole HTTPæœåŠ¡å™¨åµŒå…¥PHPä¸­ä½œä¸ºå…¶ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥ç›´æŽ¥è¿è¡ŒPHPï¼Œå®Œå…¨å¯ä»¥å–ä»£NginX + PHP-FPMç»„åˆã€‚ ä»¥ç›®å‰æµè¡Œçš„ä¸ºæ¡†æž¶Lumenï¼ˆLaravelçš„å­æ¡†æž¶ï¼‰ä¸ºä¾‹ï¼Œç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®ååˆ†ç®€å•ï¼Œåªéœ€è¦åœ¨$worker-&gt;onRequest($request, $response)ï¼ˆæ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼‰æ—¶å°†$requestä¼ ç»™Lumenå¤„ç†ï¼Œ$responseå†å°†Lumençš„å¤„ç†ç»“æžœè¿”å›žç»™ç”¨æˆ·ï¼Œè€Œä¸”$workerçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸé‡Œåªä¼šåŠ è½½ä¸€æ¬¡Lumené¡¹ç›®ä»£ç ï¼Œæ²¡æœ‰å¤šä½™çš„ç£ç›˜IOå’ŒPHPä»£ç ç¼–è¯‘çš„å¼€é”€ã€‚ åŽ‹åŠ›æµ‹è¯•åœ¨4GB+4Coreçš„è™šæ‹Ÿæœºä¸‹ï¼Œæµ‹è¯•HTTPæœåŠ¡å™¨çš„é™æ€è¾“å‡ºï¼š 2000å®¢æˆ·ç«¯å¹¶å‘500000è¯·æ±‚ï¼Œä¸å¼€å¯HTTP Keepaliveï¼Œå¹³å‡QPSï¼š 123NginX + HTML QPSï¼š25883.44NginX + PHP-FPM + Lumen QPSï¼š828.36Swoole + Lumen QPSï¼š13647.75 2000å®¢æˆ·ç«¯å¹¶å‘500000è¯·æ±‚ï¼Œå¼€å¯HTTP Keepaliveï¼Œå¹³å‡QPSï¼š 123NginX + HTML QPSï¼š86843.11NginX + PHP-FPM + Lumen QPSï¼š894.06Swoole + Lumen QPSï¼š18183.43 å¯ä»¥çœ‹å‡ºï¼ŒSwoole + Lumenç»„åˆçš„æ‰§è¡Œæ•ˆçŽ‡è¿œé«˜äºŽNginX + PHP-FPM + Lumenç»„åˆã€‚ å¼‚æ­¥MySQLå®¢æˆ·ç«¯ ä»¥ä¸Šéƒ½æ˜¯é“ºåž«ï¼Œä»¥ä¸‹æ‰æ˜¯æ•´ç¯‡æ–‡ç« çš„é‡ç‚¹ðŸ˜‚ðŸ˜‚ðŸ˜‚ ä¸€ä¸ªPHPåº”ç”¨è¦åšçš„äº‹ä¸ä¼šæ˜¯å•çº¯çš„æ•°æ®è®¡ç®—å’Œæ•°æ®è¾“å‡ºï¼Œæ›´å¤šçš„æ˜¯ä¸Žæ•°æ®åº“æ•°æ®äº¤äº’ã€‚ä»¥MySQLæ•°æ®åº“ä¸ºä¾‹ï¼Œåœ¨åªæœ‰ä¸€ä¸ªPHPè¿›ç¨‹çš„æƒ…å†µï¼Œæœ‰10ä¸ªç”¨æˆ·åŒæ—¶è¯·æ±‚æ‰§è¡Œselect sleep(1);ï¼ˆè€—æ—¶1ç§’ï¼‰æŸ¥è¯¢è¯­å¥ï¼Œè‹¥æ˜¯ä½¿ç”¨MySQLåŒæ­¥æŸ¥è¯¢ï¼Œé‚£ä¹ˆæ€»è€—æ—¶è‡³å°‘æ˜¯10ç§’ï¼›è‹¥æ˜¯ä½¿ç”¨MySQLå¼‚æ­¥æŸ¥è¯¢ï¼Œé‚£ä¹ˆæ€»è€—æ—¶å¯èƒ½åŽ‹ç¼©åˆ°1åˆ°2ç§’å†…ã€‚ åœ¨PHPåº”ç”¨ä¸­èƒ½å¤Ÿå®žçŽ°æ•°æ®åº“å¼‚æ­¥æŸ¥è¯¢ï¼Œæ‰èƒ½æ›´å¤§çš„çªç ´æ€§èƒ½ç“¶é¢ˆã€‚ è™½ç„¶Swooleæä¾›äº†å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œä½†æ˜¯å…¶å¼‚æ­¥ç¼–ç¨‹é£Žæ ¼ä¸ŽLumenè¿™ç§åŒæ­¥ç¼–ç¨‹é£Žæ ¼çš„é¡¹ç›®æ¡†æž¶å†²çªï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰å¯èƒ½åœ¨åŒæ­¥ç¼–ç¨‹é£Žæ ¼ä»£ç ä¸­è°ƒç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯å‘¢ï¼Ÿ ä¸€å¼€å§‹æˆ‘è§‰å¾—è¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œç›´åˆ°çœ‹äº†è¿™ç¯‡æ–‡ç« ï¼šCooperative multitasking using coroutines (in PHP!)ã€‚å½“ç„¶ï¼Œæˆ‘çœ‹çš„æ˜¯ä¸­æ–‡ç‰ˆï¼š åœ¨PHPä¸­ä½¿ç”¨åç¨‹å®žçŽ°å¤šä»»åŠ¡è°ƒåº¦ï¼Œæ–‡ä¸­æåˆ°äº†PHP5.5åŠ å…¥çš„ä¸€ä¸ªæ–°åŠŸèƒ½ï¼šyieldã€‚ Yieldyieldæ˜¯ä¸ªåŠ¨è¯ï¼Œæ„æ€æ˜¯â€œç”Ÿæˆâ€ï¼ŒPHPä¸­yieldç”Ÿå‡ºçš„ä¸œè¥¿å«Generatorï¼Œæ„æ€æ˜¯â€œç”Ÿæˆå™¨â€ðŸ˜‚ðŸ˜‚ðŸ˜‚ã€‚ ä¸ªäººç†è§£æ˜¯ï¼šyieldå°†å½“å‰æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä½œä¸ºå½“å‰å‡½æ•°çš„ç»“æžœè¿”å›žï¼ˆyieldå¿…é¡»åœ¨å‡½æ•°ä¸­ä½¿ç”¨ï¼‰ã€‚ åœ¨ç³»ç»Ÿå±‚é¢ï¼Œå„ä¸ªè¿›ç¨‹çš„è¿è¡Œç§©åºç”±CPUè°ƒåº¦ï¼›è€Œæœ‰äº†yieldï¼Œåœ¨PHPè¿›ç¨‹å†…ï¼Œç¨‹åºå‘˜å¯ä»¥è‡ªç”±è°ƒåº¦å„ä¸ªä»£ç å—çš„æ‰§è¡Œé¡ºåºã€‚æ¯”å¦‚ï¼Œå½“â€œå‘çŽ°â€å½“å‰ç”¨æˆ·è¯·æ±‚çš„MySQLæŸ¥è¯¢å°†ä¼šèŠ±è´¹è¾ƒå¤šçš„æ—¶é—´ï¼Œé‚£ä¹ˆå¯ä»¥å°†å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡è®°å½•èµ·æ¥ï¼Œäº¤ç»™å¼‚æ­¥MySQLå®¢æˆ·ç«¯å¤„ç†ï¼ˆä¸Žç”¨æˆ·è¯·æ±‚ç›¸å…³çš„$requestå’Œ$responseä¹Ÿä¼ é€’è¿‡åŽ»ï¼‰ï¼Œè€Œä¸»è¿›ç¨‹ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªç”¨æˆ·è¯·æ±‚ã€‚ çº¦å®šå£°æ˜Žå‰é¢ç”¨äº†â€œå‘çŽ°â€è¿™ä¸ªè¯ï¼Œå½“ç„¶ç¨‹åºä¸å¯èƒ½æ™ºèƒ½åœ°å‘çŽ°è¿˜æ²¡æ‰§è¡Œçš„æŸ¥è¯¢è¯­å¥å°†ä¼šæ˜¯ä¸ªæ…¢æŸ¥è¯¢ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›çº¦å®šå’Œå£°æ˜Žã€‚Lumenæ¡†æž¶æ˜¯ç»å…¸çš„MVCæ¨¡å¼ï¼Œæˆ‘ä»¬çº¦å®šCå³Controlleræ˜¯å¤„ç†ç”¨æˆ·è¯·æ±‚çš„æœ€åŽä¸€æ­¥â€”â€”ControlleræŽ¥å—ç”¨æˆ·è¯·æ±‚$requestå¹¶è¿”å›žå“åº”$responseã€‚åŒæ—¶æˆ‘ä»¬å£°æ˜Žä¸€ä¸ªç±»ï¼Œå«SlowQueryï¼Œè¿™ä¸ªç±»ååˆ†ç®€å•ï¼ˆå…·ä½“è¯·å‚è§SlowQuery.phpï¼‰ï¼š 123456789101112&lt;?phpnamespace BL\SwooleHttp\Database;class SlowQuery&#123; public $sql = ''; public function __construct($sql) &#123; $this-&gt;sql = $sql; &#125;&#125; æ¯”å¦‚ï¼ŒLumené¡¹ç›®ä¸­æœ‰è¿™ä¹ˆä¸€ä¸ªControllerï¼š 12345678910111213&lt;?phpnamespace App\Http\Controllers;use App\Http\Controllers\Controller;use DB;class TestController extends Controller&#123; public function test() &#123; $a = DB::select('select sleep(1);'); response()-&gt;json($a); &#125;&#125; ä¸Šé¢çš„DB::selectä½¿ç”¨çš„åŒæ­¥MySQLå®¢æˆ·ç«¯æŸ¥è¯¢ï¼Œæˆ‘ä»¬ç”¨SlowQueryå¯¹è±¡æ›¿æ¢å®ƒï¼š 12345678910111213&lt;?phpnamespace App\Http\Controllers;use App\Http\Controllers\Controller;use BL\SwooleHttp\Database\SlowQuery;class TestController extends Controller&#123; public function test() &#123; $a = yield new SlowQuery('select sleep(1);'); response()-&gt;json($a); &#125;&#125; ä»¥Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®æ—¶ï¼Œæˆ‘ä»¬ä¸€å®šä¼šèŽ·å–Controllerçš„è¿”å›žç»“æžœã€‚Controllerçš„è¿”å›žç»“æžœä¸€èˆ¬å¯ä»¥ç›´æŽ¥åŒ…è£…æˆLumenå“åº”è¿”å›žç»™ç”¨æˆ·çš„ï¼Œä½†è¿”å›žç»“æžœè‹¥æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨Generatorå¯¹è±¡ï¼Œè€Œä¸”å…¶å½“å‰å€¼æ˜¯ä¸€ä¸ªæ…¢æŸ¥è¯¢SlowQueryå¯¹è±¡çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å–å‡ºSlowQueryå¯¹è±¡çš„sqlå±žæ€§ï¼Œäº¤ç”±å¼‚æ­¥MySQLå®¢æˆ·ç«¯æ‰§è¡Œï¼›åœ¨å¼‚æ­¥æŸ¥è¯¢çš„å›žè°ƒå‡½æ•°ä¸­å°†æŸ¥è¯¢ç»“æžœæ”¾å›žGeneratorå¯¹è±¡å­˜å‚¨çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œå¾—åˆ°æœ€åŽç»“æžœæ‰è¿”å›žç»™ç”¨æˆ·ï¼›è€Œä¸»è¿›ç¨‹æ²¡æœ‰é˜»å¡žï¼Œå¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–ç”¨æˆ·è¯·æ±‚ã€‚ å½“ç„¶ï¼Œå¦‚æžœæƒ³ç”¨Eloquent ORMï¼Œé‚£ä¹Ÿå¾ˆç®€å•ï¼šæˆ‘ä»¬å…ˆç»§æ‰¿Lumençš„Modelï¼Œå°è£…æˆä¸€ä¸ªæ–°çš„Modelç±»ï¼ˆå…·ä½“å‚è§Model.phpï¼‰ï¼Œåº”ç”¨ä¸­çš„æ•°æ®æ¨¡åž‹éƒ½ç»§æ‰¿äºŽæ–°çš„Modelï¼ŒControllerå°±å¯ä»¥è¿™æ ·å†™ï¼š 1234567891011121314&lt;?phpnamespace App\Http\Controllers;use App\Http\Controllers\Controller;use App\Models\User;use DB;class TestController extends Controller&#123; public function test() &#123; $a = yield User::select(DB::raw('sleep(1)'))-&gt;yieldGet(); // æ³¨æ„Useré¡»ç»§æ‰¿è‡ª\BL\SwooleHttp\Database\Model response()-&gt;json($a); &#125;&#125; ä»¥ä¸Šä¸‰ä¸ªControlleræœ€ç»ˆäº§å‡ºçš„ç”¨æˆ·å“åº”éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡åŽä¸¤è€…ä½¿ç”¨çš„æ˜¯å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œæ•ˆçŽ‡æ›´é«˜ã€‚ ä»»åŠ¡è°ƒåº¦å™¨å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨æ¥æ‰§è¡Œè¿™äº›ç”Ÿæˆå™¨ï¼Œä»»åŠ¡è°ƒåº¦å™¨çš„å®žçŽ°æ–¹æ³• åœ¨PHPä¸­ä½¿ç”¨åç¨‹å®žçŽ°å¤šä»»åŠ¡è°ƒåº¦æ–‡ä¸­â€œå¤šä»»åŠ¡åä½œâ€ç« èŠ‚é‡Œæœ‰ä»‹ç»ï¼Œè¿™é‡Œä¸å±•å¼€ã€‚Lumenæ¡†æž¶ä¸­çš„ä»£ç ä¿æŒäº†åŒæ­¥ç¼–ç¨‹é£Žæ ¼ï¼Œè€Œä»»åŠ¡è°ƒåº¦å™¨ä¸­ä½¿ç”¨äº†å¼‚æ­¥ç¼–ç¨‹é£Žæ ¼æ¥è°ƒç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ã€‚ä»»åŠ¡è°ƒåº¦å™¨æ˜¯åœ¨Swoole HTTPæœåŠ¡å™¨å±‚é¢ä½¿ç”¨çš„ï¼Œå…·ä½“å‚è§Service.phpã€‚ è¿žæŽ¥é™åˆ¶å…¶å®žï¼Œæ¯å¼€å¯ä¸€ä¸ªSwooleå¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œä¸»è¿›ç¨‹å°±ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹è¿žæŽ¥MySQLï¼Œè‹¥æ˜¯å»ºç«‹å¤ªå¤šè¿žæŽ¥ï¼ˆçº¿ç¨‹ï¼‰ï¼Œä¼šå¢žåŠ è‡ªèº«æœåŠ¡å™¨çš„åŽ‹åŠ›ï¼Œä¹Ÿä¼šå¢žåŠ MySQLæ•°æ®åº“æœåŠ¡å™¨çš„åŽ‹åŠ›ã€‚è¿™ç§åˆ©ç”¨yieldæ¥è°ƒç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯å¤„ç†æ…¢æŸ¥è¯¢è€Œäº§ç”Ÿçš„çº¿ç¨‹ï¼Œæš‚ä¸”ç§°å®ƒä¸ºâ€œæ…¢æŸ¥è¯¢åç¨‹â€ã€‚ä¸ºäº†é™åˆ¶æ•°æ®åº“è¿žæŽ¥æ•°é‡ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªå…¨å±€å˜é‡è®°å½•å¯æ–°å»ºæ…¢æŸ¥è¯¢åç¨‹çš„æ•°é‡MAX_COROUTINEï¼Œå¼€å¯ä¸€ä¸ªå¼‚æ­¥MySQLå®¢æˆ·ç«¯æ—¶è®©å…¶å‡ä¸€ï¼Œå…³é—­ä¸€ä¸ªå¼‚æ­¥MySQLå®¢æˆ·ç«¯æ—¶è®©å…¶åŠ ä¸€ï¼›å½“ç”¨æˆ·è¯·æ±‚æ…¢æŸ¥è¯¢æ—¶ï¼ŒMAX_COROUTINEå¤§äºŽ0åˆ™ç”±å¼‚æ­¥MySQLå®¢æˆ·ç«¯å¤„ç†ï¼ŒMAX_COROUTINEç­‰äºŽ0æ—¶åˆ™ç”±ä¸»è¿›ç¨‹â€œç¡¬ç€å¤´çš®â€è‡ªå·±å¤„ç†ã€‚ åŽ‹åŠ›æµ‹è¯•åœ¨4GB+4Coreçš„è™šæ‹Ÿæœºä¸‹ï¼Œæµ‹è¯•HTTPæœåŠ¡å™¨ä¸Žæ•°æ®åº“è¯»å†™ï¼š ä¸€èˆ¬çš„å¿«é€ŸæŸ¥è¯¢å’Œå¿«é€Ÿå†™å…¥æµ‹è¯•ï¼š 200å¹¶å‘50000è¯·æ±‚è¯»ï¼Œåˆ©ç”¨HTTP Keepaliveï¼Œå¹³å‡QPSï¼š 12NginX + PHP-FPM + Lumen + MySQL QPSï¼š521.56Swoole + Lumen + MySQL QPSï¼š7509.99 200å¹¶å‘50000è¯·æ±‚å†™ï¼Œåˆ©ç”¨HTTP Keepaliveï¼Œå¹³å‡QPSï¼š 12NginX + PHP-FPM + Lumen + MySQL QPSï¼š449.44Swoole + Lumen + MySQL QPSï¼š1253.93 æ…¢æŸ¥è¯¢åç¨‹æµ‹è¯•ï¼š 16workerçš„Swoole HTTPæœåŠ¡å™¨ï¼Œå¹¶å‘æ‰§è¡Œselect sleep(1);è¯·æ±‚çš„æœ€å¤§æ•ˆçŽ‡æ˜¯15.72rpsï¼› 16worker x 10coroutineçš„Swoole HTTPæœåŠ¡å™¨ï¼Œå¹¶å‘æ‰§è¡Œselect sleep(1);è¯·æ±‚çš„æœ€å¤§æ•ˆçŽ‡æ˜¯151.93rpsã€‚ è¿™é‡Œä¸ºä»€ä¹ˆè¯´æœ€å¤§æ•ˆçŽ‡å‘¢ï¼Ÿå› ä¸ºå½“å¹¶å‘é‡è¿œå¤§äºŽworkeræ•°ç›® x coroutineæ•°ç›®æ—¶ï¼Œå¯å¼€å¯æ…¢æŸ¥è¯¢åç¨‹çš„Swoole HTTPæœåŠ¡å™¨çš„æ•ˆçŽ‡ä¼šé€æ¸è·Œå‘æ™®é€šSwoole HTTPæœåŠ¡å™¨ã€‚ select sleep(1);æŸ¥è¯¢è¯­å¥è€—æ—¶1ç§’ï¼Œæ¯ä¸ªç”¨æˆ·è¯·æ±‚éƒ½éœ€è¦1ç§’æ—¶é—´æ¥å¤„ç†ï¼›ä¸è¿‡ï¼Œ16è¿›ç¨‹çš„ã€æ¯ä¸ªè¿›ç¨‹å¯å¼€å¯10ä¸ªæ…¢æŸ¥è¯¢åç¨‹çš„Swoole HTTPæœåŠ¡å™¨çš„æ¯ç§’æœ€å¤šå¯ä»¥å¤„ç†160ä¸ªç”¨æˆ·è¯·æ±‚ï¼Œè€Œ16è¿›ç¨‹çš„æ™®é€šSwoole HTTPæœåŠ¡å™¨æ¯ç§’æœ€å¤šåªèƒ½å¤„ç†16ä¸ªç”¨æˆ·è¯·æ±‚ã€‚ å»¶ä¼¸å…¶å®žåˆ©ç”¨yieldï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å®žçŽ°å„ç§å„æ ·çš„â€œåç¨‹â€ã€‚æ¯”å¦‚ï¼ŒSwoole2.1ç‰ˆæœ¬å·²ç»å¼€å§‹æ”¯æŒgoå‡½æ•°ä¸Žé€šé“ï¼ŒåŽç»­æˆ‘ä»¬å¯èƒ½è¿˜å¯ä»¥å°†Lumen Controllerä¸­ä¸€äº›IOé˜»å¡žçš„æ“ä½œçš„ä¸Šä¸‹æ–‡ç§»è‡³goå‡½æ•°é‡Œæ‰§è¡Œï¼Œè¿™æ ·æ—¢ä¿ç•™äº†åŒæ­¥ç¼–ç¨‹çš„é£Žæ ¼ï¼Œç”±è¾¾åˆ°å¼‚æ­¥æ‰§è¡Œçš„æ€§èƒ½ã€‚ æœ€åŽä»¥ä¸Šç†è®ºï¼Œå·²ç»åœ¨lumen-swoole-httpé¡¹ç›®ä¸­å®žçŽ°ã€‚lumen-swoole-httpæ˜¯è¿žæŽ¥åŒæ­¥ç¼–ç¨‹Lumenå’Œå¼‚æ­¥ç¼–ç¨‹Swooleçš„ä¸€åº§æ¡¥æ¢ï¼Œå¯ä»¥å¸®åŠ©åŽŸç”ŸPHPçš„Lumenåº”ç”¨é¡¹ç›®å¿«é€Ÿè¿ç§»åˆ°Swoole HTTPæœåŠ¡å™¨ä¸Šï¼›å½“ç„¶ä¹Ÿå¯ä»¥å¿«é€Ÿè¿ç§»å›žåŽ»ðŸ˜‚ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å°è¯•ä½¿ç”¨ï¼š å®‰è£… ä½¿ç”¨ é…ç½® æ…¢æŸ¥è¯¢åç¨‹ â€¦]]></content>
      <categories>
        <category>æ±‚ç´¢</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>swoole</tag>
        <tag>lumen</tag>
        <tag>think</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åœ¨Lumené¡¹ç›®ä¸­è‡ªå®šä¹‰åŽç½®å¼‚æ­¥åç¨‹]]></title>
    <url>%2Fblog%2Fswoole-lumen-define-post-processing-coroutine.html</url>
    <content type="text"><![CDATA[ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»äº†åˆ©ç”¨yieldç‰¹æ€§å®žçŽ°åŽç½®çš„MySQLå¼‚æ­¥æŸ¥è¯¢åç¨‹ï¼ŒæŒ‰ç…§è¿™ç§â€œåŽç½®æ‰§è¡Œâ€çš„æ€è·¯ï¼Œå…¶å®žè¿˜å¯ä»¥å®žçŽ°æ›´å¤šå…¶ä»–çš„åŽç½®å¼‚æ­¥åç¨‹ã€‚è¿™é‡Œä»‹ç»å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªåŽç½®å¼‚æ­¥åç¨‹ï¼Œå°†æœ€å¤§å¼€å‘è‡ªç”±åº¦äº¤ç”±Lumenæ¡†æž¶ä½¿ç”¨è€…ã€‚ CustomAsyncProcesslumen-swoole-httpä¸­å·²ç»å®šä¹‰äº†æŠ½è±¡ç±»CustomAsyncProcessï¼Œåœ¨å¤„ç†ç”¨æˆ·è¯·æ±‚æ—¶ï¼Œè‹¥æ˜¯æ•èŽ·åˆ°CustomAsyncProcessç±»çš„å¯¹è±¡ï¼Œç¨‹åºä¾¿ä¼šæŒ‰ç…§CustomAsyncProcesså¯¹è±¡çš„æŒ‡å®šæ–¹æ³•æ‰§è¡Œã€‚éƒ¨åˆ†ä»£ç ï¼š 123456789101112&lt;?php ... $current_value = $last_generator-&gt;current(); if ($current_value instanceof CustomAsyncProcess) &#123; if ($worker-&gt;canDoCoroutine()) &#123; $worker-&gt;upCoroutineNum(); return $current_value-&gt;runAsyncTask($request, $response, $worker, $this-&gt;scheduler, $last_generator); &#125; else &#123; return $current_value-&gt;runNormalTask($request, $response, $worker, $this-&gt;scheduler, $last_generator); &#125; &#125; ... ä¸€ä¸ªç®€å•çš„åŽç½®åç¨‹æˆ‘ä»¬å…ˆæ¥å®žçŽ°ä¸€ä¸ªç®€å•çš„åŽç½®åç¨‹EasyProcessï¼Œç»§æ‰¿è‡ªCustomAsyncProcessï¼Œéœ€è¦å®žçŽ°ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132&lt;?phpnamespace App\http\AfterCoroutines;use BL\SwooleHttp\Service;use BL\SwooleHttp\Coroutine\SimpleSerialScheduler;use Generator;use swoole_http_request as SwooleHttpRequest;use swoole_http_response as SwooleHttpResponse;class EasyProcess extends \BL\SwooleHttp\Coroutine\CustomAsyncProcess&#123; // å› ä¸ºæœ‰åç¨‹æ•°é‡é™åˆ¶ï¼Œè¾¾åˆ°æœ€å¤§åç¨‹æ•°é‡æ—¶ï¼Œä¼šè°ƒç”¨runNormalTaskæ–¹æ³• public function runNormalTask(SwooleHttpRequest $request, SwooleHttpResponse $response, Service $worker, SimpleSerialScheduler $scheduler, Generator $last_generator) &#123; $value = 2; // ç»™æœ€åŽä¸€å±‚ç”Ÿæˆå™¨ï¼Œä¼ å…¥$valueå€¼ï¼Œå¹¶é€’å½’å¯¼å‡ºæ•´ä¸ªç”Ÿæˆå™¨å¥—å±‚çš„æœ€ç»ˆå€¼$final $final = $this-&gt;fullRunScheduler($scheduler, $last_generator, $value); $http_response = $final; // æ³¨æ„ï¼šrunNormalTaskæ–¹æ³•ä¸­ä½¿ç”¨makeNormalResponseæ–¹æ³•å“åº”ç”¨æˆ·è¯·æ±‚ $this-&gt;makeNormalResponse($request, $response, $worker, $http_response); &#125; // æ²¡è¾¾åˆ°æœ€å¤§åç¨‹æ•°é‡æ—¶ï¼Œä¼šè°ƒç”¨runAsyncTaskæ–¹æ³• public function runAsyncTask(SwooleHttpRequest $request, SwooleHttpResponse $response, Service $worker, SimpleSerialScheduler $scheduler, Generator $last_generator) &#123; $value = 1; // ç»™æœ€åŽä¸€å±‚ç”Ÿæˆå™¨ï¼Œä¼ å…¥$valueå€¼ï¼Œå¹¶é€’å½’å¯¼å‡ºæ•´ä¸ªç”Ÿæˆå™¨å¥—å±‚çš„æœ€ç»ˆå€¼$final $final = $this-&gt;fullRunScheduler($scheduler, $last_generator, $value); $http_response = $final; // æ³¨æ„ï¼šrunAsyncTaskæ–¹æ³•ä¸­ä½¿ç”¨makeAsyncResponseæ–¹æ³•å“åº”ç”¨æˆ·è¯·æ±‚ $this-&gt;makeAsyncResponse($request, $response, $worker, $http_response); &#125;&#125; ç„¶åŽå°±å¯ä»¥åœ¨Controllerä¸­ä½¿ç”¨è¿™ä¸ªåŽç½®åç¨‹ï¼š 12345678910111213&lt;?phpnamespace App\Http\Controllers;use App\http\AfterCoroutines\EasyProcess;use App\Http\Controllers\Controller;class TestController extends Controller&#123; public function test() &#123; $a = yield new EasyProcess(); response()-&gt;json($a); &#125;&#125; å½“è®¿é—®TestController@testå¯¹åº”çš„è·¯ç”±æ—¶ï¼Œå¾—åˆ°çš„è¿”å›žç»“æžœæœ‰å¯èƒ½æ˜¯1ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯2ï¼Œè§†å½“æ—¶åç¨‹æ•°é‡è€Œå®šã€‚1æˆ–2è¿™ä¸ªç»“æžœåœ¨TestController@testå±‚é¢ä¸Šæ˜¯æœªæ›¾çŸ¥çš„ï¼Œæ˜¯ç”±EasyProcessè¿™ä¸ªåŽç½®åç¨‹äº§å‡ºçš„ã€‚ EasyProcessä¸ç®—ä¸€ä¸ªå¼‚æ­¥åç¨‹ï¼Œæ— è®ºrunNormalTaskæ–¹æ³•æˆ–è€…runAsyncTaskæ–¹æ³•ï¼Œéƒ½æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚è‹¥æƒ³å®žçŽ°å¼‚æ­¥æ‰§è¡Œï¼Œå¿…é¡»ä½¿ç”¨Swooleæä¾›çš„å¼‚æ­¥å®¢æˆ·ç«¯ï¼Œè¯¦ç»†è¯·æŸ¥çœ‹Swooleå®˜æ–¹æ–‡æ¡£AsyncIOã€‚ ä¸‹é¢ä»‹ç»å¦‚ä½•å®žçŽ°ä¸€ä¸ªåŽç½®çš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯åç¨‹ã€‚ ä¸€ä¸ªåŽç½®çš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯åç¨‹å‡è®¾æˆ‘ä»¬å¤„ç†æŸä¸ªç”¨æˆ·è¯·æ±‚æ—¶ï¼Œéœ€è¦ä»Žè¿œç«¯é“¾æŽ¥http://www.domain.com/api/dataèŽ·å–ä¸€äº›æ•°æ®ï¼ŒæœŸé—´å¯èƒ½éœ€è¦è€—æ—¶å‡ ç§’é’Ÿï¼Œé‚£ä¹ˆæ€Žæ ·ç”¨åŽç½®å¼‚æ­¥åç¨‹å®žçŽ°æ¥é¿å…é˜»å¡žå‘¢ï¼Ÿ æˆ‘ä»¬å…ˆæ¥å®žçŽ°ä¸€ä¸ªç®€å•çš„åŽç½®åç¨‹AysncHttpProcessï¼Œç»§æ‰¿è‡ªCustomAsyncProcessï¼Œéœ€è¦å®žçŽ°ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344&lt;?phpnamespace App\http\AfterCoroutines;use BL\SwooleHttp\Service;use BL\SwooleHttp\Coroutine\SimpleSerialScheduler;use Generator;use swoole_http_request as SwooleHttpRequest;use swoole_http_response as SwooleHttpResponse;use Swoole\Http2\Client as SwooleHttpClient;class AysncHttpProcess extends \BL\SwooleHttp\Coroutine\CustomAsyncProcess&#123; public function $url; public function __construct($url) &#123; $this-&gt;url = $url; &#125; // å› ä¸ºæœ‰åç¨‹æ•°é‡é™åˆ¶ï¼Œè¾¾åˆ°æœ€å¤§åç¨‹æ•°é‡æ—¶ï¼Œä¼šè°ƒç”¨runNormalTaskæ–¹æ³• public function runNormalTask(SwooleHttpRequest $request, SwooleHttpResponse $response, Service $worker, SimpleSerialScheduler $scheduler, Generator $last_generator) &#123; $data = file_get_contents($this-&gt;url); // ç»™æœ€åŽä¸€å±‚ç”Ÿæˆå™¨ï¼Œä¼ å…¥$valueå€¼ï¼Œå¹¶é€’å½’å¯¼å‡ºæ•´ä¸ªç”Ÿæˆå™¨å¥—å±‚çš„æœ€ç»ˆå€¼$final $final = $this-&gt;fullRunScheduler($scheduler, $last_generator, $data); $http_response = $final; // æ³¨æ„ï¼šrunNormalTaskæ–¹æ³•ä¸­ä½¿ç”¨makeNormalResponseæ–¹æ³•å“åº”ç”¨æˆ·è¯·æ±‚ $this-&gt;makeNormalResponse($request, $response, $worker, $http_response); &#125; // æ²¡è¾¾åˆ°æœ€å¤§åç¨‹æ•°é‡æ—¶ï¼Œä¼šè°ƒç”¨runAsyncTaskæ–¹æ³• public function runAsyncTask(SwooleHttpRequest $request, SwooleHttpResponse $response, Service $worker, SimpleSerialScheduler $scheduler, Generator $last_generator) &#123; $client = new SwooleHttpClient(); $caller = $this; $client-&gt;get($this-&gt;url, function ($o) use($client, $caller) &#123; $data = $o-&gt;body; // ç»™æœ€åŽä¸€å±‚ç”Ÿæˆå™¨ï¼Œä¼ å…¥$valueå€¼ï¼Œå¹¶é€’å½’å¯¼å‡ºæ•´ä¸ªç”Ÿæˆå™¨å¥—å±‚çš„æœ€ç»ˆå€¼$final $final = $caller-&gt;fullRunScheduler($scheduler, $last_generator, $value); $http_response = $final; // æ³¨æ„ï¼šrunAsyncTaskæ–¹æ³•ä¸­ä½¿ç”¨makeAsyncResponseæ–¹æ³•å“åº”ç”¨æˆ·è¯·æ±‚ $caller-&gt;makeAsyncResponse($request, $response, $worker, $http_response); $client-&gt;close(); &#125;); &#125;&#125; ç„¶åŽå°±å¯ä»¥åœ¨Controllerä¸­ä½¿ç”¨è¿™ä¸ªåŽç½®åç¨‹ï¼š 12345678910111213&lt;?phpnamespace App\Http\Controllers;use App\http\AfterCoroutines\AysncHttpProcess;use App\Http\Controllers\Controller;class TestController extends Controller&#123; public function test() &#123; $a = yield new AysncHttpProcess('http://www.domain.com/api/data'); response()-&gt;json($a); &#125;&#125; å°±è¿™æ ·ï¼Œåœ¨åç¨‹æ•°é‡å…è®¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŽç½®çš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯åç¨‹èŽ·å–è¿œç«¯æ•°æ®ï¼Œå¹¶ä¸”é¿å…äº†é˜»å¡žã€‚ æœ€åŽä¸‰ç¯‡æ–‡ç« ï¼š ç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®çš„å®žçŽ°æ–¹æ³• åœ¨Lumené¡¹ç›®ä¸­ä½¿ç”¨Swooleå¼‚æ­¥MySQLå®¢æˆ·ç«¯çš„å®žçŽ°æ–¹æ³• åœ¨Lumené¡¹ç›®ä¸­è‡ªå®šä¹‰åŽç½®å¼‚æ­¥åç¨‹ è‡³æ­¤ï¼Œå·²ç»å°†lumen-swoole-httpçš„è®¾è®¡ç†å¿µä»‹ç»å®Œäº†ï¼Œä¸»è¦æ˜¯ä¸¤ç‚¹ï¼š åˆ©ç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®ï¼Œæé«˜æ‰§è¡Œæ•ˆçŽ‡ï¼› åˆ©ç”¨åŽç½®å¼‚æ­¥åç¨‹ï¼Œä¿æŒåŒæ­¥ç¼–ç¨‹é£Žæ ¼ï¼Œé¿å…ä¸»è¿›ç¨‹é˜»å¡žã€‚ Swooleå¡«è¡¥äº†PHPç½‘ç»œç¼–ç¨‹çš„ç¼ºé™·ï¼Œå¼•å…¥NodeJSã€GoLangç­‰è¯­è¨€çš„å¹¶è¡Œæ‰§è¡Œç‰¹æ€§ï¼Œä½¿ç”¨äº†ä¸åŒçš„ç¼–ç¨‹é£Žæ ¼ã€‚å¯¹æ­¤ï¼Œä¸åº”è¯¥ä¸€å‘³æŠ—æ‹’ï¼Œè€Œæ˜¯å­¦ä¼šèžä¼šè´¯é€šâ€”â€”å­¦æ— æ­¢å¢ƒï¼ŒçŸ¥è¯†æ²¡æœ‰ç•Œé™ï¼ŒPHPerä¹Ÿåº”è¯¥å­¦ä¹ å…¶ä»–è¯­è¨€çš„è®¾è®¡ç†å¿µï¼Œç‰¹åˆ«æ˜¯ä¸ºé«˜å¹¶å‘è€Œç”Ÿçš„GoLangã€‚]]></content>
      <categories>
        <category>æ±‚ç´¢</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>swoole</tag>
        <tag>lumen</tag>
        <tag>think</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åœ¨Lumené¡¹ç›®ä¸­ä½¿ç”¨Swooleå¼‚æ­¥MySQLå®¢æˆ·ç«¯çš„å®žçŽ°æ–¹æ³•]]></title>
    <url>%2Fblog%2Fswoole-lumen-use-async-mysql-client-in-lumen.html</url>
    <content type="text"><![CDATA[ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»äº†ç”¨Swoole HTTPæœåŠ¡å™¨æ›¿ä»£NginX + PHP-FPMæ¥è¿è¡ŒLumené¡¹ç›®çš„æ–¹æ³•ï¼Œæé«˜è¿è¡Œæ•ˆçŽ‡ã€‚ä¸è¿‡ï¼Œåœ¨å¤„ç†ç”¨æˆ·è¯·æ±‚è¿‡ç¨‹ä¸­è¿˜æ˜¯ä¼šå­˜åœ¨å¾ˆå¤šIOé˜»å¡žæƒ…å†µï¼Œæ¯”å¦‚MySQLæ•°æ®æŸ¥è¯¢ã€‚æœ‰æ²¡æœ‰å¯èƒ½åœ¨Lumenä¸­ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œä»¥æ­¤é¿å…IOé˜»å¡žå‘¢ï¼Ÿ å¼‚æ­¥MySQLå®¢æˆ·ç«¯Swoole1.8.6å¢žåŠ äº†å†…ç½®å¼‚æ­¥MySQLå®¢æˆ·ç«¯çš„æ”¯æŒï¼Œæ— éœ€ä¾èµ–å…¶ä»–ç¬¬ä¸‰æ–¹åº“ï¼Œä½¿ç”¨æ–¹æ³•ä¹Ÿéžå¸¸ç®€å•ï¼Œï¼ˆå…·ä½“å‚è€ƒSwooleå®˜æ–¹æ–‡æ¡£å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼‰ï¼š 1234567891011121314151617181920212223&lt;?php$db = new \swoole_mysql;$mysql_config = array( 'host' =&gt; '192.168.56.102', 'port' =&gt; 3306, 'user' =&gt; 'test', 'password' =&gt; 'test', 'database' =&gt; 'test', 'charset' =&gt; 'utf8', //æŒ‡å®šå­—ç¬¦é›† 'timeout' =&gt; 2,);$db-&gt;connect($mysql_config, function ($db, $r) &#123; if ($r) &#123; $sql = 'show tables'; $db-&gt;query($sql, function($db, $r) &#123; if ($r) &#123; var_dump($r); &#125; $db-&gt;close(); &#125;); &#125;&#125;); è¿™æ˜¯å…¸åž‹å›žè°ƒå¤„ç†çš„å¼‚æ­¥ç¼–ç¨‹é£Žæ ¼ï¼Œè€ŒLumenæœ¬èº«æ˜¯åŒæ­¥ç¼–ç¨‹é£Žæ ¼ï¼Œåœ¨ç¼–ç¨‹å±‚é¢ï¼Œä¸¤è€…ä¸èƒ½èžåˆã€‚æ¯”å¦‚ï¼Œæœ‰è¿™ä¹ˆä¸€ä¸ªControllerï¼š 12345678910111213&lt;?phpnamespace App\Http\Controllers;use App\Http\Controllers\Controller;use DB;class TestController extends Controller&#123; public function test() &#123; $a = DB::query('select * from users;'); response()-&gt;json($a); &#125;&#125; è‹¥æ˜¯æ”¹å†™æˆï¼š 1234567891011121314151617181920212223&lt;?phpnamespace App\Http\Controllers;use App\Http\Controllers\Controller;class TestController extends Controller&#123; public function test() &#123; $a = null; $db = new \swoole_mysql; $db-&gt;connect($mysql_config, function ($db, $r) use ($a) &#123; if ($r) &#123; $db-&gt;query('select * from users;', function($db, $r) use ($a) &#123; if ($r) &#123; $a = json_decode(json_encode($r)); &#125; $db-&gt;close(); &#125;); &#125; &#125;); response()-&gt;json($a); &#125;&#125; è¿™æ ·è¿”å›žçš„å“åº”æ°¸è¿œæ˜¯nullï¼Œå› ä¸ºresponse()-&gt;json($a)ä¼šåœ¨$db-&gt;query()ä¹‹å‰è¢«æ‰§è¡Œã€‚ ä¸€å¼€å§‹æˆ‘ä¹Ÿè§‰å¾—Lumené¡¹ç›®é‡Œæ°¸è¿œæ²¡åŠžæ³•ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯äº†ï¼Œç›´åˆ°çœ‹äº†è¿™ç¯‡æ–‡ç« ï¼šCooperative multitasking using coroutines (in PHP!)ã€‚å½“ç„¶ï¼Œæˆ‘çœ‹çš„æ˜¯ä¸­æ–‡ç‰ˆï¼š åœ¨PHPä¸­ä½¿ç”¨åç¨‹å®žçŽ°å¤šä»»åŠ¡è°ƒåº¦ï¼Œæ–‡ä¸­æåˆ°äº†PHP5.5åŠ å…¥çš„ä¸€ä¸ªæ–°åŠŸèƒ½ï¼šyieldã€‚ yieldyieldæ˜¯ä¸ªåŠ¨è¯ï¼Œæ„æ€æ˜¯â€œç”Ÿæˆâ€ï¼ŒPHPä¸­yieldç”Ÿå‡ºçš„ä¸œè¥¿å«Generatorï¼Œè¯‘ä½œâ€œç”Ÿæˆå™¨â€ã€‚yieldå¯ä»¥åšä»€ä¹ˆå‘¢ï¼Ÿyieldå¯ä»¥å°†å½“å‰æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä½œä¸ºå½“å‰å‡½æ•°çš„ç»“æžœè¿”å›žï¼ˆyieldå¿…é¡»åœ¨å‡½æ•°ä¸­ä½¿ç”¨ï¼‰ã€‚æœ‰äº†yieldï¼Œåˆèƒ½æ€Žæ ·å‘¢ï¼Ÿ é¦–å…ˆï¼Œæˆ‘ä»¬å£°æ˜Žä¸€ä¸ªç±»ï¼Œå«SlwoQueryï¼š 1234567891011&lt;?phpnamespace BL\SwooleHttp\Database;class SlowQuery&#123; public $sql = ''; public function __construct($sql) &#123; $this-&gt;sql = $sql; &#125;&#125; ç»“åˆä¸Šä¸€ç¯‡æ–‡ç« ã€Šç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®çš„å®žçŽ°æ–¹æ³•ã€‹ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹Serviceç±»çš„onRequestæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142&lt;?php public function onRequest(\swoole_http_request $request,\swoole_http_response $response) &#123; $app = $this-&gt;app; // å¤„ç†ç”¨æˆ·è¯·æ±‚ $http_request = $this-&gt;parseRequest($request); $http_response = $app-&gt;dispatch($http_request); if ($http_response instanceof \Generator) &#123; $gen = $http_response-&gt;current(); $gen_queue = new \SplQueue(); while($gen instanceof Generator) &#123; $gen_queue-&gt;push($gen); $gen = $gen-&gt;current(); &#125; $last_gen = $gen_queue-&gt;pop(); $value = $last_gen-&gt;current(); if ($value instanceof \BL\SwooleHttp\Database\SlowQuery) &#123; $db = new \swoole_mysql; $caller = $this; // å…³é”®éƒ¨åˆ† $db-&gt;connect($mysql_config, function ($db, $r) use ($caller, $request, $response, $gen_queue, $last_gen, $value) &#123; if ($r) &#123; $db-&gt;query($value-&gt;sql, function($db, $r) use ($caller, $request, $response, $gen_queue, $last_gen) &#123; if ($r) &#123; // å…³é”®éƒ¨åˆ† $r = json_decode(json_encode($r)); $last_gen-&gt;send($r); $ret = $last_gen-&gt;getReturn(); while(!$gen_queue-&gt;isEmpty()) &#123; $gen = $gen_queue-&gt;pop(); $gen-&gt;send($ret); $ret = $gen-&gt;getReturn(); &#125; $caller-&gt;makeResponse($response, $ret); &#125; $db-&gt;close(); &#125;); &#125; &#125;); &#125; &#125; else &#123; // å“åº”ç”¨æˆ·è¯·æ±‚ $this-&gt;makeResponse($response, $http_response); &#125; &#125; ä»£ç æ˜¯é•¿äº†äº›ï¼Œå› ä¸ºæ²¡åšåˆ†æ‹†å’Œå°è£…ï¼Œä¸»è¦å…³æ³¨$db-&gt;connect()å’Œ$caller-&gt;makeResponse()çš„å‡ºçŽ°ä½ç½®ã€‚æ•´å—ä»£ç çš„æ„æ€æ˜¯ï¼š å¦‚æžœLumenå¤„ç†ç”¨æˆ·è¯·æ±‚çš„è¿”å›žç»“æžœæ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆå°±ä»Žè¿™ä¸ªç”Ÿæˆå™¨çš„å‡½æ•°å¥—å±‚é‡Œå¯»æ‰¾ï¼ˆSlowQueryï¼‰ï¼› å¦‚æžœå½“å‰ç”Ÿæˆå™¨çš„å½“å‰å€¼ä¹Ÿæ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆå°±å¾€æ›´æ·±ä¸€å±‚é‡Œå¯»æ‰¾ï¼› å¦‚æžœå½“å‰ç”Ÿæˆå™¨çš„å½“å‰å€¼æ˜¯ä¸€ä¸ªSlowQueryå¯¹è±¡ï¼Œé‚£ä¹ˆå°†SlowQueryå¯¹è±¡çš„sqlå±žæ€§ï¼Œäº¤ç»™å¼‚æ­¥MySQLå®¢æˆ·swoole_mysqlæŸ¥è¯¢æ•°æ®ï¼› å°†æŸ¥è¯¢æ•°æ®ä¼ å…¥å½“å‰ç”Ÿæˆå™¨ï¼ŒèŽ·å¾—å½“å‰å±‚å‡½æ•°çš„è¿”å›žç»“æžœï¼› å°†å‡½æ•°è¿”å›žç»“æžœä¼ å…¥ä¸Šä¸€å±‚ç”Ÿæˆå™¨ï¼ŒèŽ·å–ä¸Šä¸€å±‚å‡½æ•°çš„è¿”å›žç»“æžœï¼Œé‡å¤ç›´åˆ°æ²¡æœ‰æ›´é«˜å±‚ç”Ÿæˆå™¨ï¼› æ‰å°†æœ€é¡¶å±‚å±‚çš„å‡½æ•°è¿”å›žç»“æžœä½œä¸ºå“åº”è¾“å‡ºç»™ç”¨æˆ·ã€‚è™½ç„¶æ•´ä¸ªè¿‡ç¨‹å¾ˆç»•ï¼Œä½†æ˜¯ï¼Œåœ¨Lumençš„Controllerå±‚é¢å´æ˜¯ååˆ†çš„ç›´æŽ¥äº†ç„¶ï¼š12345678910111213&lt;?phpnamespace App\Http\Controllers;use App\Http\Controllers\Controller;use BL\SwooleHttp\Database\SlowQuery;class TestController extends Controller&#123; public function test() &#123; $a = yield new SlowQuery('select * from users;'); response()-&gt;json($a); &#125;&#125; å°±è¿™æ ·ï¼Œå®žçŽ°äº†åœ¨åŒæ­¥ç¼–ç¨‹é£Žæ ¼çš„Lumené¡¹ç›®ä¸­ä½¿ç”¨ä¸Šäº†Swooleçš„å¼‚æ­¥MySQLå®¢æˆ·ç«¯ã€‚å®žçŽ°çš„æ€è·¯ï¼Œå°±åƒåŽç½®ä¸­é—´ä»¶ï¼Œä¿æŒæŽ§åˆ¶å™¨ä»£ç çš„æ•´æ´ï¼Œè„æ´»ç´¯æ´»æ”¾åœ¨ä¸­é—´ä»¶é‡Œæ‰§è¡Œã€‚ æ•ˆçŽ‡æå‡å‡å¦‚ç”¨æˆ·è¯·æ±‚æ‰§è¡Œä¸€ä¸ªæ•°æ®åº“æ…¢æŸ¥è¯¢è¯­å¥ï¼ˆå¯èƒ½è€—æ—¶1ç§’ï¼Œå¦‚select sleep(1);ï¼‰ï¼Œå•ä¸ªPHPè¿›ç¨‹ä½¿ç”¨åŒæ­¥MySQLå®¢æˆ·ç«¯å¤„ç†1ä¸ªè¿™æ ·çš„ç”¨æˆ·è¯·æ±‚ï¼Œè‡³å°‘éœ€è¦1ç§’ï¼Œå¤„ç†10ä¸ªï¼Œåˆ™è‡³å°‘éœ€è¦10ç§’ï¼›è€Œä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œå¤„ç†1ä¸ªï¼Œå¯èƒ½éœ€è¦1ç§’å¤šï¼Œå¤„ç†10ä¸ªï¼Œå¯èƒ½ä¹Ÿåªæ˜¯éœ€è¦1ç§’ã€‚å¼‚æ­¥æ‰§è¡Œå¸¦æ¥çš„æ•ˆçŽ‡æå‡ï¼Œæ˜¯ä¸è¨€è€Œå–»çš„ã€‚ ä¸è¿‡ï¼Œä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯æ˜¯ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºçš„ï¼Œä¸èƒ½å¤§é‡ä½¿ç”¨ï¼›è€Œä¸”éžæ…¢æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥ï¼Œæ ¹æœ¬ä¸éœ€è¦ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯æ¥æ‰§è¡Œï¼Œæ¯”å¦‚select * from users.id = 1;ï¼Œidæœ‰ä¸»é”®ç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶é—´ä¸ä¼šå¤ªé•¿ã€‚ æœ€åŽyieldå¯ä»¥å°†æ•´ä¸ªç¨‹åºçš„å„ä¸ªä»£ç å—çš„æ‰§è¡Œç§©åºäº¤ç”±ç¨‹åºå‘˜è‡ªè¡Œè°ƒåº¦ï¼Œç¡®å®žå¯ä»¥å®žçŽ°å¾ˆå¤šæ„å‘ä¸åˆ°çš„æ•ˆæžœã€‚åƒä»¥ä¸Šè¿™ç§â€œåŽç½®æ‰§è¡Œâ€çš„æ€è·¯ï¼Œä¸ä»…ä»…æ˜¯å¯ä»¥ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å¼‚æ­¥Rediså®¢æˆ·ç«¯ï¼Œå¼‚æ­¥HTTPå®¢æˆ·ç«¯ï¼Œè¿˜æœ‰æ›´å¤šå„ç§å„æ ·çš„åº”ç”¨ã€‚ ä¸‹ä¸€ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•è‡ªå®šä¹‰åŽç½®å¼‚æ­¥åç¨‹ã€‚]]></content>
      <categories>
        <category>æ±‚ç´¢</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>php</tag>
        <tag>swoole</tag>
        <tag>lumen</tag>
        <tag>think</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®çš„å®žçŽ°æ–¹æ³•]]></title>
    <url>%2Fblog%2Fswoole-lumen-run-lumen-with-swoole.html</url>
    <content type="text"><![CDATA[LNMPè™½æ˜¯ä¼ ç»Ÿçš„Webåº”ç”¨æž¶æž„ç»„åˆï¼Œæ— å¥ˆNginX + PHP-FPMçš„æ­é…è¿è¡Œæ•ˆçŽ‡å®žåœ¨å¤ªä½Žï¼›è€ŒSwoole HTTPæœåŠ¡å™¨å…·æœ‰NginXçº§åˆ«çš„æ€§èƒ½ï¼Œä¸”æœ¬èº«åµŒå…¥åœ¨PHPä¸­ï¼Œå®Œå…¨å¯ä»¥æ›¿ä»£NginX + PHP-FPMã€‚äºŽæ˜¯ä¸€ç›´åœ¨æŽ¢ç´¢ç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡Œä¼ ç»ŸPHPåº”ç”¨çš„é€”å¾„ã€‚è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®çš„å®žçŽ°æ–¹æ³•ï¼š Swoole HTTPæœåŠ¡å™¨Swoole1.7.7å¢žåŠ äº†å†…ç½®HTTPæœåŠ¡å™¨çš„æ”¯æŒï¼Œä½¿ç”¨äº†è·ŸNginXä¸€æ ·çš„IOå¤šè·¯å¤ç”¨æœºåˆ¶epollï¼Œå¯ä»¥è¾¾åˆ°NginXçº§åˆ«çš„æ€§èƒ½ï¼Œå¹¶ä¸”åªéœ€å‡ è¡Œä»£ç å³å¯å†™å‡ºä¸€ä¸ªå¼‚æ­¥éžé˜»å¡žå¤šè¿›ç¨‹çš„HTTPæœåŠ¡å™¨ï¼ˆepollå±žäºŽåŒæ­¥éžé˜»å¡žï¼Œè¿™é‡Œè¯´â€œå¼‚æ­¥éžé˜»å¡žâ€ä¸»è¦æ˜¯å› ä¸ºâ€œå¤šè¿›ç¨‹â€ï¼Œå•ä¸ªè¿›ç¨‹å†…éƒ¨ä¾ç„¶æ˜¯åŒæ­¥éžé˜»å¡žï¼‰ã€‚ å¼€å¯ä¸€ä¸ªSwoole HTTPæœåŠ¡å™¨çš„é¢å‘å¯¹è±¡ç¼–ç¨‹ä»£ç æ ·æ¿å¤§è‡´å¦‚ä¸‹ï¼ˆå…·ä½“å‚è€ƒSwooleå®˜æ–¹æ–‡æ¡£HttpServerï¼‰ï¼š 123456789101112131415161718192021222324252627282930313233343536&lt;?phpclass Service &#123; public $app; public $server; public function __construct($host, $port) &#123; $this-&gt;server = new \swoole_http_server($host, $port); &#125; public function start() &#123; // $this-&gt;server-&gt;on('start', array($this, 'onStart')); // $this-&gt;server-&gt;on('shutdown', array($this, 'onShutdown')); // $this-&gt;server-&gt;on('workerStop', array($this, 'onWorkerStop')); $this-&gt;server-&gt;on('workerStart', array($this, 'onWorkerStart')); $this-&gt;server-&gt;on('request', array($this, 'onRequest')); $this-&gt;server-&gt;start(); &#125; public function onWorkerStart($serv, $worker_id) &#123; // åº”ç”¨åˆå§‹åŒ– $this-&gt;app = 1; &#125; public function onRequest(\swoole_http_request $request,\swoole_http_response $response) &#123; $app = $this-&gt;app; // å¤„ç†ç”¨æˆ·è¯·æ±‚ $get = json_encode($request-&gt;get); // å“åº”ç”¨æˆ·è¯·æ±‚ $response-&gt;end("App is &#123;$app&#125;. Get &#123;$get&#125;"); &#125;&#125;$s = new Service("127.0.0.1", 9080);$s-&gt;start(); ç›´æŽ¥ç”¨phpå‘½ä»¤æ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œæµè§ˆå™¨è®¿é—®http://127.0.0.1:9080ï¼Œä¼šå¾—åˆ°ï¼š 1App is 1. Get null æµè§ˆå™¨è®¿é—®http://127.0.0.1:9080/?user=guestï¼Œä¼šå¾—åˆ°ï¼š 1App is 1. Get &#123;&quot;user&quot;:&quot;guest&quot;&#125; å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚ åŠ è½½Lumené¡¹ç›®Lumené¡¹ç›®çš„å…¥å£æ–‡ä»¶æ˜¯é¡¹ç›®è·¯å¾„ä¸‹çš„public/index.phpï¼Œé‡Œé¢åªæœ‰ç®€å•çš„ä¸¤è¡Œä»£ç ï¼š 123&lt;?php$app = require __DIR__.'/../bootstrap/app.php';$app-&gt;run(); ç¬¬ä¸€è¡Œä»£ç å°±æ˜¯åŠ è½½æ•´ä¸ªLumenæ¡†æž¶ä»£ç ï¼Œç¬¬äºŒè¡Œä»£ç åˆ™æ˜¯å¤„ç†è¯·æ±‚ï¼Œç”Ÿæˆå“åº”ã€‚ æ‰€ä»¥ï¼Œåœ¨Swoole HTTPæœåŠ¡å™¨ä¸­åŠ è½½Lumené¡¹ç›®ï¼Œä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€ä¿®æ”¹onWorkerStartæ–¹æ³•ï¼š 12345&lt;?php public function onWorkerStart($serv, $worker_id) &#123; // åº”ç”¨åˆå§‹åŒ– $this-&gt;app = require '/THE/FULL/PATH/TO/bootstrap/app.php'; &#125; å¤„ç†ç”¨æˆ·è¯·æ±‚è™½ç„¶å¯ä»¥åŠ è½½Lumenæ¡†æž¶ï¼Œä½†æ˜¯è¦æ€Žæ ·æ‰èƒ½ç”¨Lumenæ¡†æž¶æ¥å¤„ç†ç”¨æˆ·è¯·æ±‚å‘¢ï¼Ÿ ç”±äºŽLumenæ¡†æž¶çš„è§£è€¦ç¨‹åº¦éžå¸¸é«˜ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾åœ°å°†swoole_http_requestå¯¹è±¡$requestï¼Œè½¬æ¢æˆLumenæ¡†æž¶ç†Ÿæ‚‰çš„Illuminate\Http\Requestå¯¹è±¡ï¼Œè¿™æ ·Lumenæ¡†æž¶å°±èƒ½å¤„ç†ç”¨æˆ·è¯·æ±‚äº†ã€‚è¿™é‡Œå®žçŽ°ä¸€ä¸ªparseRequestæ–¹æ³•ï¼ŒæŽ¥æ”¶swoole_http_requestç±»å‚æ•°ï¼Œè¿”å›ž\Illuminate\Http\Requestç±»ç»“æžœï¼š 12345678910111213141516171819202122232425&lt;?php protected function parseRequest(\swoole_http_request $request) &#123; $get = isset($request-&gt;get) ? $request-&gt;get : array(); $post = isset($request-&gt;post) ? $request-&gt;post : array(); $cookie = isset($request-&gt;cookie) ? $request-&gt;cookie : array(); $server = isset($request-&gt;server) ? $request-&gt;server : array(); $header = isset($request-&gt;header) ? $request-&gt;header : array(); $files = isset($request-&gt;files) ? $request-&gt;files : array(); $fastcgi = array(); $new_server = array(); foreach ($server as $key =&gt; $value) &#123; $new_server[strtoupper($key)] = $value; &#125; foreach ($header as $key =&gt; $value) &#123; $new_server['HTTP_' . strtoupper($key)] = $value; &#125; $content = $request-&gt;rawContent() ?: null; $http_request = new \Illuminate\Http\Request($get, $post, $fastcgi, $cookie, $files, $new_server, $content); return $http_request; &#125; ç”Ÿæˆè¯·æ±‚å“åº”Lumenæ¡†æž¶å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œååˆ†æ–¹ä¾¿ï¼Œåªéœ€è°ƒç”¨åº”ç”¨çš„dispatchæ–¹æ³•å³å¯ã€‚ä¸è¿‡dispatchæ–¹æ³•è¿”å›žç»“æžœä¸€èˆ¬æ˜¯Symfony\Component\HttpFoundation\Responseå¯¹è±¡ï¼Œéœ€è¦åšä¸€äº›è½¬åŒ–æ‰èƒ½äº¤ç”±swoole_http_responseå¯¹è±¡ç»™ç”¨æˆ·è¾“å‡ºå“åº”ã€‚è¿™é‡Œå®žçŽ°ä¸€ä¸ªmakeResponseæ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728&lt;?php protected function parseRequest(\swoole_http_response $request, \Symfony\Component\HttpFoundation\Response $http_response) &#123; // status $response-&gt;status($http_response-&gt;getStatusCode()); // headers foreach ($http_response-&gt;headers-&gt;allPreserveCase() as $name =&gt; $values) &#123; foreach ($values as $value) &#123; $response-&gt;header($name, $value); &#125; &#125; // cookies foreach ($http_response-&gt;headers-&gt;getCookies() as $cookie) &#123; $response-&gt;rawcookie( $cookie-&gt;getName(), $cookie-&gt;getValue(), $cookie-&gt;getExpiresTime(), $cookie-&gt;getPath(), $cookie-&gt;getDomain(), $cookie-&gt;isSecure(), $cookie-&gt;isHttpOnly() ); &#125; // content $content = $http_response-&gt;getContent(); // send content $response-&gt;end($content); &#125; æœ‰äº†parseRequestæ–¹æ³•å’ŒmakeResponseæ–¹æ³•ï¼Œè¦å®žçŽ°ä»¥Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®æ¥å¤„ç†ç”¨æˆ·è¯·æ±‚åªè¦å‡ è¡Œä»£ç ã€‚onRequestæ–¹æ³•è¿™æ ·ä¿®æ”¹ï¼š 123456789&lt;?php public function onRequest(\swoole_http_request $request,\swoole_http_response $response) &#123; $app = $this-&gt;app; // å¤„ç†ç”¨æˆ·è¯·æ±‚ $http_request = $this-&gt;parseRequest($request); $http_response = $app-&gt;dispatch($http_request); // å“åº”ç”¨æˆ·è¯·æ±‚ $this-&gt;makeResponse($response, $http_response); &#125; æœ€åŽå°±è¿™æ ·ï¼Œä¸éœ€è¦ä¿®æ”¹Lumené¡¹ç›®åŽŸæœ¬ä»»ä½•ä»£ç ï¼Œå°±èƒ½è®©å…¶è¿è¡Œåœ¨Swoole HTTPæœåŠ¡å™¨ä¸Šã€‚å½“ç„¶ï¼Œç”¨æˆ·è¯·æ±‚å„ç§å„æ ·ï¼Œæœ‰è¯·æ±‚æ–‡ä»¶ä¸Šä¼ ï¼Œæœ‰è¯·æ±‚é™æ€èµ„æºç­‰ç­‰ï¼›å“åº”ç±»åž‹ä¹Ÿæ˜¯å„ç§å„æ ·ï¼Œæœ‰GzipåŽ‹ç¼©ï¼Œæœ‰JSONæ ¼å¼ï¼Œæœ‰è®¾ç½®Cookieç­‰å¾…ã€‚è¦å®žçŽ°ä¸€ä¸ªå¥å…¨çš„Swoole+Lumenç½‘å…³æœåŠ¡ï¼Œä»¥ä¸Šä»£ç è¿˜é¡»æ›´å¤šä¼˜åŒ–ï¼Œå…·ä½“å¯ä»¥å‚è€ƒService.phpã€‚ æŒ‰ç…§ä»¥ä¸Šæ€è·¯ï¼Œè¦å®žçŽ°ä»¥Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLaravelé¡¹ç›®ä¹Ÿä¸éš¾ï¼Œä¸è¿‡ï¼Œä¸ºäº†æ•ˆçŽ‡é€‰æ‹©Swooleï¼Œè‡ªç„¶ä¼šä¸ºäº†æ•ˆçŽ‡é€‰æ‹©Lumenè€Œä¸æ˜¯Laravelã€‚ ä¸‹ä¸€ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•åœ¨Lumenä¸­ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œå‡å°‘IOé˜»å¡žã€‚]]></content>
      <categories>
        <category>æ±‚ç´¢</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>swoole</tag>
        <tag>lumen</tag>
        <tag>think</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ­å»ºDocker Registryç§æœ‰é•œåƒä»“åº“]]></title>
    <url>%2Fblog%2Fpractice-docker-registry.html</url>
    <content type="text"><![CDATA[Docker Storeæ˜¯Dockerå®˜æ–¹æä¾›çš„å…¬å…±çš„é•œåƒä»“åº“ï¼Œä½†æœ‰æ—¶ä¼šéœ€è¦åœ¨å±€éƒ¨å†…å…±äº«é•œåƒï¼Œé‚£ä¹ˆå¯ä»¥åˆ©ç”¨Docker Registryå·¥å…·æ­å»ºä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ã€‚ ç›´æŽ¥è¿è¡Œå®˜æ–¹registryé•œåƒï¼Œå³å¯å¼€å¯é•œåƒä»“åº“æœåŠ¡ï¼š 1$ docker run -d -p 5000:5000 --restart=always --name registry registry è‹¥è¦å®šåˆ¶ä½¿ç”¨ï¼Œè¿˜éœ€æ›´å¤šé…ç½®ã€‚ Dockerå®‰è£…ç®€å•ä»‹ç»ä¸€ä¸‹Dockerçš„å®‰è£…ï¼š 123456$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"$ sudo apt-get update$ sudo apt-get install -y docker-ce$ sudo apt-get install -y docker-compose$ sudo usermod -aG docker $&#123;USER&#125; Docker Composeå®‰è£…Docker Composeçš„å®‰è£…ï¼š 12$ sudo curl -L https://github.com/docker/compose/releases/download/1.18.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose$ sudo chmod +x /usr/local/bin/docker-compose Docker Composeç¼–æŽ’è¿›å…¥å·¥ä½œç›®å½•ï¼Œç¼–è¾‘docker-compose.ymlï¼š 123$ cd ~/workspace$ cd docker/registry$ vi docker-compose.yml åŸºäºŽå®˜æ–¹é•œåƒregistryåˆ¶ä½œï¼Œ/etc/docker/registryæ˜¯å®¹å™¨å†…é…ç½®ä¿¡æ¯è·¯å¾„ï¼Œæ˜ å°„åˆ°æœ¬åœ°./configï¼›/var/lib/registryæ˜¯å®¹å™¨å†…æ•°æ®ä¿å­˜è·¯å¾„ï¼Œæ˜ å°„åˆ°æœ¬åœ°./dataï¼š 123456789version: "3"services: registry: image: registry ports: - "5000:5000" volumes: - "./config:/etc/docker/registry" - "./data:/var/lib/registry" Docker Registryé…ç½®è®¾ç½®HTTPè®¤è¯ï¼š 123$ mkdir -p config/auth$ htpasswd -Bbn $USERNAME $PASSWORD &gt; ./config/auth/htpasswd # or$ docker run --rm --entrypoint htpasswd registry -Bbn $USERNAME $PASSWORD &gt; ./config/auth/htpasswd é…ç½®Registryï¼š 1$ vi config/config.yml config/config.ymlï¼š 12345678910111213141516171819202122version: 0.1log: fields: service: registrystorage: cache: blobdescriptor: inmemory filesystem: rootdirectory: /var/lib/registryauth: htpasswd: realm: basic-realm path: /etc/docker/registry/auth/htpasswdhttp: addr: :5000 headers: X-Content-Type-Options: [nosniff]health: storagedriver: enabled: true interval: 10s threshold: 3 è¿è¡Œä¸Žæµ‹è¯•12345678$ docker-compose up -d$ docker login 127.0.0.1:5000$ docker pull ubuntu:16.04$ docker tag ubuntu:16.04 127.0.0.1/username/ubuntu:16.04$ docker push 127.0.0.1/username/ubuntu:16.04$ docker pull 127.0.0.1/username/ubuntu:16.04$ docker logout$ docker push 127.0.0.1/username/ubuntu:16.04 *HTTPSè™½ç„¶Docker Registryé»˜è®¤ç›‘å¬ç«¯å£æ˜¯5000ï¼Œä½†å®žé™…ä¸ŠæœåŠ¡æ˜¯åŸºäºŽHTTPï¼Œå¯ä»¥é€šè¿‡HTTPSä¿éšœä¼ è¾“æ•°æ®å®‰å…¨ã€‚Dockeré»˜è®¤ä¸å…è®¸éžHTTPSè¿žæŽ¥ä¸‹æŽ¨é€é•œåƒï¼ˆ127.0.0.1æœ¬åœ°ç½‘ç»œåœ°å€ä¾‹å¤–ï¼‰ï¼Œè¦å–æ¶ˆè¿™ä¸ªé™åˆ¶é¡»ä¿®æ”¹Dockeré…ç½®â€”â€”æ¯”å¦‚è¿žæŽ¥192.168.1.1:5000æœåŠ¡ï¼Œåœ¨/etc/default/dockeræ–‡ä»¶ä¸­æ·»åŠ DOCKER_OPTS=&quot;--insecure-registries=192.168.1.1:5000&quot;ï¼Œç„¶åŽé‡å¯Dockerï¼š 1$ sudo service docker restart å½“ç„¶ï¼Œæœ€å¥½è¿˜æ˜¯ç»™Docker Registryè®¾ç½®HTTPSï¼šå¯ä»¥ç”¨NginXä»£ç†æœ¬åœ°5000ç«¯å£ï¼Œç„¶åŽåœ¨NginXä¸Šè®¾ç½®HTTPSï¼›ä¹Ÿå¯ä»¥åœ¨Docker Registryå†…éƒ¨è®¾ç½®HTTPSï¼Œè¯¦ç»†è¿‡ç¨‹è¯·é˜…è¯»ã€Šç§æœ‰ä»“åº“é«˜çº§é…ç½®ã€‹ã€‚ å‚è€ƒ Deploy a registry server Configuring a registry]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>practice</tag>
        <tag>docker</tag>
        <tag>registry</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æºç å®‰è£…GitLabï¼ˆMySQL & HTTPSï¼‰]]></title>
    <url>%2Fblog%2Fpractice-gitlab-installation-from-source.html</url>
    <content type="text"><![CDATA[ä»‹ç»ä¸€ä¸‹åœ¨Ubuntu16.04ç³»ç»Ÿä¸‹æºç å®‰è£…GitLab10.04ä¸”ä»¥MySQLä½œä¸ºæ•°æ®åº“ã€SSLåŠ å¯†ä¼ è¾“çš„æ­¥éª¤ï¼š å¼€å§‹Dependencieså®‰è£…ä¾èµ–ï¼š 1$ sudo apt-get install -y build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libre2-dev libreadline-dev libncurses5-dev libffi-dev curl openssh-server checkinstall libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev logrotate rsync python-docutils pkg-config cmake ä¸ºGitLabåˆ›å»ºä¸€ä¸ªç³»ç»Ÿç”¨æˆ·gitï¼š 1$ sudo adduser --disabled-login --gecos 'GitLab' git $ sudo apt-get install -y postfix Gitå®‰è£…æœ€æ–°ç‰ˆGitï¼š 123$ sudo add-apt-repository ppa:git-core/ppa$ sudo apt-get update$ sudo apt-get install git Rubyå®‰è£…æœ€æ–°ç‰ˆRubyï¼š 1234$ sudo apt-add-repository ppa:brightbox/ruby-ng$ sudo apt-get update$ sudo apt-get install ruby$ sudo apt-get install ruby-dev å®‰è£…Bundlerï¼š 1$ sudo gem install bundler --no-ri --no-rdoc Goå®‰è£…Go1.9.2ï¼š 1234$ curl --remote-name --progress https://dl.google.com/go/go1.9.2.linux-amd64.tar.gz$ sudo tar -C /usr/local -xzf go1.9.2.linux-amd64.tar.gz$ sudo ln -sf /usr/local/go/bin/&#123;go,godoc,gofmt&#125; /usr/local/bin/$ rm go1.9.2.linux-amd64.tar.gz Nodeå®‰è£…NodeJS8.xï¼š 12$ curl --location https://deb.nodesource.com/setup_8.x | sudo bash -$ sudo apt-get install -y nodejs å®‰è£…yarnï¼š 1234$ curl --silent --show-error https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list$ sudo apt-get update$ sudo apt-get install yarn MySQLå®‰è£…MySQL5.7ï¼Œå…ˆä»ŽMySQLå®˜ç½‘ä¸‹è½½APTé…ç½®å™¨(mysql-apt-config_0.8.9-1_all.deb)[https://dev.mysql.com/downloads/file/?id=474129]ï¼Œç„¶åŽï¼š 123$ sudo dpkg -i mysql-apt-config_0.8.9-1_all.deb$ sudo apt-get update$ sudo apt-get install -y mysql-server mysql-client libmysqlclient-dev MySQLå®‰å…¨é…ç½®ï¼š 123$ $ mysql --version$ sudo mysql_secure_installation åˆ›å»ºGitLabç”¨æˆ·å’Œæ•°æ®åº“ï¼š 1234567891011$ mysql -u root -pmysql&gt; CREATE USER &apos;git&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;$password&apos;;# Create the GitLab production databasemysql&gt; CREATE DATABASE IF NOT EXISTS `gitlabhq_production` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_general_ci`;# Grant the GitLab user necessary permissions on the databasemysql&gt; GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, CREATE TEMPORARY TABLES, DROP, INDEX, ALTER, LOCK TABLES, REFERENCES, TRIGGER ON `gitlabhq_production`.* TO &apos;git&apos;@&apos;localhost&apos;;# Quit the database sessionmysql&gt; \q æµ‹è¯•ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®æ•°æ®åº“ï¼š 1$ sudo -u git -H mysql -u git -p -D gitlabhq_production Rediså®‰è£…Redis3.0.6ï¼š 1$ sudo apt-get install redis GitLabå…‹éš†GitLabæºç å…‹éš†GitLabæºç ï¼Œå¹¶é…ç½®GitLabï¼ˆä¿®æ”¹åŸŸåç­‰ç­‰ï¼‰ï¼š 12345$ cd /home/git$ sudo -u git -H git clone https://gitlab.com/gitlab-org/gitlab-ce.git -b 10-4-stable gitlab$ cd /home/git/gitlab$ sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml$ sudo -u git -H vi config/gitlab.yml é…ç½®GitLabé…ç½®å¯†é’¥æ–‡ä»¶ï¼š 12$ sudo -u git -H cp config/secrets.yml.example config/secrets.yml$ sudo -u git -H chmod 0600 config/secrets.yml é…ç½®Unicornï¼ˆä¿®æ”¹ç›‘å¬ç«¯å£ç­‰ç­‰ï¼‰ï¼š 12$ sudo -u git -H cp config/unicorn.rb.example config/unicorn.rb$ sudo -u git -H vi config/unicorn.rb è®¾ç½®ç›®å½•æƒé™ï¼š 1234567891011121314$ sudo chown -R git log/$ sudo chown -R git tmp/$ sudo chmod -R u+rwX,go-w log/$ sudo chmod -R u+rwX tmp/$ sudo chmod -R u+rwX tmp/pids/$ sudo chmod -R u+rwX tmp/sockets/$ sudo -u git -H mkdir public/uploads/$ sudo chmod 0700 public/uploads$ sudo chmod -R u+rwX builds/$ sudo chmod -R u+rwX shared/artifacts/$ sudo chmod -R ug+rwX shared/pages/ é…ç½®Rack Attackï¼š 1$ sudo -u git -H cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb é…ç½®Resqueï¼ˆä¿®æ”¹Redisé“¾æŽ¥ç­‰ç­‰ï¼‰ï¼š 12$ sudo -u git -H cp config/resque.yml.example config/resque.yml$ sudo -u git -H vi config/resque.yml é…ç½®Gitç”¨æˆ·ï¼š 123456789101112# Configure Git global settings for git user# 'autocrlf' is needed for the web editor$ sudo -u git -H git config --global core.autocrlf input# Disable 'git gc --auto' because GitLab already runs 'git gc' when needed$ sudo -u git -H git config --global gc.auto 0# Enable packfile bitmaps$ sudo -u git -H git config --global repack.writeBitmaps true# Enable push options$ sudo -u git -H git config --global receive.advertisePushOptions true æ•°æ®åº“è®¾ç½®é…ç½®MySQLï¼ˆä¿®æ”¹è´¦æˆ·å¯†ç ç­‰ç­‰ï¼‰ï¼š 123$ sudo -u git cp config/database.yml.mysql config/database.yml$ sudo -u git -H chmod o-rwx config/database.yml$ sudo -u git -H vi config/database.yml å®‰è£…Gemså®‰è£…Gemsï¼š 123# If you use MySQL (note, the option says "without ... postgres")# If you want to use Kerberos for user authentication, then omit kerberos in the --without option$ sudo -u git -H bundle install --deployment --without development test postgres aws kerberos å®‰è£…GitLab Shellå®‰è£…GitLab Shellï¼Œå¹¶é…ç½®ï¼ˆä¿®æ”¹GitLabé“¾æŽ¥ç­‰ç­‰ï¼‰ï¼š 123456# Run the installation task for gitlab-shell (replace `REDIS_URL` if needed):$ sudo -u git -H bundle exec rake gitlab:shell:install RAILS_ENV=production SKIP_STORAGE_VALIDATION=true# By default, the gitlab-shell config is generated from your main GitLab config.# You can review (and modify) the gitlab-shell config as follows:$ sudo -u git -H vi /home/git/gitlab-shell/config.yml å®‰è£…Gitlab Workhorseå®‰è£…Gitlab Workhorseï¼š 123$ sudo -u git -H bundle exec rake "gitlab:workhorse:install[/home/git/gitlab-workhorse]" RAILS_ENV=production$ sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production GITLAB_ROOT_PASSWORD='$root_password' GITLAB_ROOT_EMAIL='$root_email' secrets.yml/home/git/gitlab/config/secrets.ymlæ–‡ä»¶å­˜å‚¨ç€å„ç±»æ•°æ®åŠ å¯†çš„é’¥åŒ™ï¼Œåº”å¤‡ä»½åœ¨ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹ã€‚ å®‰è£…å¯åŠ¨è„šæœ¬å®‰è£…åœ¨ç³»ç»Ÿä¸­å¯åŠ¨GitLabæœåŠ¡çš„è„šæ­¥ï¼š 123$ sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab$ sudo cp lib/support/init.d/gitlab.default.example /etc/default/gitlab$ sudo update-rc.d gitlab defaults 21 å®‰è£…Gitalyå®‰è£…Gitalyï¼Œå¹¶é…ç½®ï¼š 1234$ sudo -u git -H bundle exec rake "gitlab:gitaly:install[/home/git/gitaly]" RAILS_ENV=production$ sudo chmod 0700 /home/git/gitlab/tmp/sockets/private$ sudo chown git /home/git/gitlab/tmp/sockets/private$ sudo -u git -H vi /home/git/gitaly/config.toml è®¾ç½®Logrotate1$ sudo cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab ç¼–è¯‘GetText PO1$ sudo -u git -H bundle exec rake gettext:compile RAILS_ENV=production MySQLå­—ç¬¦ä¸²é™åˆ¶1$ sudo -u git -H bundle exec rake add_limits_mysql RAILS_ENV=production ç¼–è¯‘å‰ç«¯èµ„æº12$ sudo -u git -H yarn install --production --pure-lockfile$ sudo -u git -H bundle exec rake gitlab:assets:compile RAILS_ENV=production NODE_ENV=production å¯åŠ¨GitLabæœåŠ¡å¯åŠ¨æˆ–é‡å¯GitLabæœåŠ¡ï¼š 123$ sudo service gitlab start# or$ sudo /etc/init.d/gitlab restart èŽ·å–æœåŠ¡é…ç½®1$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production æ£€æµ‹æœåŠ¡çŠ¶æ€1$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production Nginxå®‰è£…æœ€æ–°ç‰ˆNginXï¼š 123$ sudo add-apt-repository ppa:nginx/stable$ sudo apt-get update$ sudo apt-install nginx é…ç½®NginXä»£ç†ï¼ˆä¿®æ”¹åŸŸåç­‰ç­‰ï¼‰ï¼š 123$ sudo cp lib/support/nginx/gitlab /etc/nginx/sites-available/gitlab$ sudo ln -s /etc/nginx/sites-available/gitlab /etc/nginx/sites-enabled/gitlab$ sudo vi /etc/nginx/sites-available/gitlab é‡å¯NginXæœåŠ¡ï¼š 1$ sudo service nginx start *Letsencryptå®‰è£…Letsencryptï¼š 1$ sudo apt-get install letsencrypt ç”³è¯·å¯†é’¥å’Œè¯ä¹¦ï¼š 1$ sudo letsencrypt sudo letsencrypt certonly --webroot -w /home/git/gitlab/public -d '$domainname' é…ç½®NginXä»£ç†ï¼ˆä¿®æ”¹åŸŸåã€å¯†é’¥ä½ç½®ã€è¯ä¹¦ä½ç½®ç­‰ç­‰ï¼‰ï¼š 123sudo cp lib/support/nginx/gitlab-ssl /etc/nginx/sites-available/gitlabsudo ln -s /etc/nginx/sites-available/gitlab /etc/nginx/sites-enabled/gitlabsudo vi /etc/nginx/sites-available/gitlab é‡å¯NginXæœåŠ¡ï¼š 1$ sudo service nginx start å‚è€ƒ Installation from source Database MySQL]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>practice</tag>
        <tag>gitlab</tag>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Webé¡µé¢ä¸­æ»šåŠ¨ç©¿é€çš„è§£å†³æ–¹æ³•]]></title>
    <url>%2Fblog%2Fhack-scroll-event-propagation.html</url>
    <content type="text"><![CDATA[æœ€è¿‘åšä¸€ä¸ªç§»åŠ¨ç«¯çš„Webåº”ç”¨ï¼Œå› ä¸ºæ˜¯å•é¡µæ¨¡å¼ï¼Œæ‰€ä»¥å°‘ä¸äº†å„ç§å„æ ·çš„å¼¹å‡ºæ¡†ï¼Œä¾§è¾¹æ ï¼Œç»“æžœå‘çŽ°è¿™äº›å…ƒç´ åœ¨æ»šåŠ¨åˆ°è¾¹ç•Œæ—¶ï¼Œæ»šåŠ¨äº‹ä»¶ä¼šä¼ é€’ç»™çˆ¶å…ƒç´ ï¼Œå¯¼è‡´çˆ¶å…ƒç´ å¼€å§‹æ»šåŠ¨ï¼ˆåœ¨PCç«¯ä¹Ÿæ˜¯ä¸€æ ·å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œè€Œåœ¨ç§»åŠ¨ç«¯æ›´ä¸ºçªå‡ºï¼Œæœ‰æ—¶å³ä½¿ä¸åœ¨è¾¹ç•Œä¹Ÿä¼šå¯¼è‡´çˆ¶å…ƒç´ æ»šåŠ¨ï¼Œè‡ªèº«å´ä¸åŠ¨ï¼‰ã€‚ åœ¨ç½‘ä¸Šæœå¯»ä¸€ç•ªåŽï¼Œæ‰¾åˆ°å¾ˆå¤šå…³äºŽè¿™ä¸ªé—®é¢˜çš„è®¨è®ºï¼Œè§£å†³æ–¹æ³•å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š ï¼ˆJSï¼‰ç›‘å¬å…ƒç´ elæ»šåŠ¨äº‹ä»¶eventï¼Œå½“el.scrollTopæˆ–è€…el.scrollLeftåˆ°è¾¾è¾¹ç•Œå€¼çš„æ—¶å€™ï¼Œç”¨event.preventDefault()æ–¹æ³•å–æ¶ˆæµè§ˆå™¨é»˜è®¤æ“ä½œå’Œç”¨event.preventDefault()æ–¹æ³•åœæ­¢äº‹ä»¶å¾€ä¸Šä¼ æ’­ï¼› ï¼ˆCSSï¼‰åœ¨è¡¨å±‚å…ƒç´ ï¼ˆå¼¹å‡ºæ¡†ï¼Œä¾§è¾¹æ ç­‰ç­‰ï¼‰æ˜¾ç¤ºæ—¶ï¼Œä¿®æ”¹åº•å±‚å…ƒç´ ï¼ˆä¸€èˆ¬æ˜¯ç½‘é¡µä¸»ä½“bodyï¼‰çš„æ ·å¼ï¼Œå¦‚position:fixedã€overflow:hiddenç­‰ç­‰ï¼Œä½¿å…¶ä¸å¯æ»šåŠ¨ã€‚ å…·ä½“å¯ä»¥å‚è€ƒç§»åŠ¨ç«¯æ»šåŠ¨ç©¿é€é—®é¢˜ï¼Œå…¶ä¸­æåˆ°çš„â€œç»ˆæžå®Œç¾Žè§£å†³æ–¹æ¡ˆâ€ä¾¿å±žä¸Šé¢çš„ç¬¬äºŒç±»ã€‚ ç–‘è™‘è™½è¯´æ˜¯â€œç»ˆæžå®Œç¾Žè§£å†³æ–¹æ¡ˆâ€ï¼Œä½†å…¶å®žæˆ‘æ˜¯ä¸ç›¸ä¿¡çš„ï¼Œå› ä¸ºä¿®æ”¹äº†å…ƒç´ å®šä½æ–¹å¼ï¼Œå…ƒç´ éœ€è¦é‡ç»˜ï¼Œå†…å®¹æ˜¾ç¤ºä½ç½®ä¹Ÿä¼šæ”¹å˜ï¼Œå³ä½¿è®°å½•å†…å®¹ä½ç½®åŽç»­æ¢å¤ï¼Œç”»é¢ä¹Ÿå°‘ä¸å…æŠ–åŠ¨ï¼Œæ‰€ä»¥æ€Žä¹ˆå¯èƒ½æ˜¯â€œå®Œç¾Žâ€å‘¢ï¼Ÿ å®žè·µå°½ç®¡æœ‰æ‰€ç–‘è™‘ï¼Œè¿˜æ˜¯è¦å®žè·µä¸€ä¸‹ã€‚äºŽæ˜¯ç®€å•åœ°å†™ä¸€ä¸ªæµ‹è¯•æ ·ä¾‹äº†ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;Test&lt;/title&gt; &lt;style type="text/css"&gt; html, body &#123;width: 100%;&#125; body &#123;background-color: #9e9e9e; height: 9000px; margin: 0; padding: 0; z-index: 1;&#125; .main &#123;background-color: #00bcd4; height: 6000px; margin: 0;&#125; .nav &#123;background-color: #2196f3; width: 200px; position: fixed; top: 0; bottom: 0; right: 0; overflow: scroll; display: none; z-index: 9;&#125; &lt;/style&gt;&lt;/head&gt;&lt;body&gt; &lt;div class="main"&gt; &lt;div&gt; &lt;li&gt;testing testing&lt;/li&gt; &lt;li&gt;testing testing&lt;/li&gt; &lt;li&gt;testing testing&lt;/li&gt; &lt;li&gt;testing testing&lt;/li&gt; &lt;li&gt;testing testing&lt;/li&gt; &lt;!-- more and more --&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="nav"&gt; &lt;div style="height: 2000px"&gt; &lt;li&gt;testing testing&lt;/li&gt; &lt;li&gt;testing testing&lt;/li&gt; &lt;li&gt;testing testing&lt;/li&gt; &lt;li&gt;testing testing&lt;/li&gt; &lt;li&gt;testing testing&lt;/li&gt; &lt;!-- more and more --&gt; &lt;/div&gt; &lt;/div&gt; &lt;script type="text/javascript"&gt; var main = document.querySelector('.main'); var nav = document.querySelector('.nav'); var flag = 0; main.addEventListener('click', function () &#123; nav.style.display = 'block'; flag = document.body.scrollTop; document.body.style.position = 'fixed'; document.body.style.top = -flag + 'px'; &#125;); nav.addEventListener('click', function () &#123; document.body.style.position = 'static'; document.body.style.top = 'auto'; document.body.scrollTop = flag; nav.style.display = 'none'; &#125;); &lt;/script&gt;&lt;/body&gt;&lt;/html&gt; æ ·ä¾‹é¡µé¢ä¸­ï¼Œç‚¹å‡».mainæ—¶ï¼Œå°†.navè®¾ä¸ºå¯è§ï¼Œä¸”å°†bodyçš„å®šä½è®¾ä¸ºfixedï¼Œå‘ä¸Šåç§»åˆ°bodyæœ¬æ¥çš„æ»šåŠ¨é«˜åº¦ï¼Œè¿™æ ·.navå¯ä»¥æ»šåŠ¨è€Œ.mainä¸èƒ½æ»šåŠ¨ï¼Œå°±ä¸ä¼šå‡ºçŽ°æ»šåŠ¨ç©¿é€çš„é—®é¢˜ï¼›å†ç‚¹å‡».navï¼Œå°†.navè®¾ä¸ºä¸å¯è§ï¼Œä¸”å°†bodyçš„å®šä½è®¾ä¸ºstaticï¼Œå–æ¶ˆbodyçš„å‘ä¸Šåç§»å¹¶æ»šå›žæœ¬æ¥çš„æ»šåŠ¨é«˜åº¦ã€‚ æœ‰ä¸ªé—®é¢˜æ ·ä¾‹é¡µé¢åœ¨Safariæµè§ˆå™¨ä¸­è¿è¡Œæ­£å¸¸ï¼Œåœ¨Chromeæµè§ˆå™¨ä¸­å´æœ‰é—®é¢˜ï¼Œå› ä¸ºSafariæµè§ˆå™¨è®¤ä¸ºbodyå…ƒç´ æ˜¯æ»šåŠ¨ä¸»ä½“ï¼Œè€ŒChromeæµè§ˆå™¨è®¤ä¸ºhtmlå…ƒç´ æ‰æ˜¯æ»šåŠ¨ä¸»ä½“ã€‚documentä¸­èŽ·å–bodyå…ƒç´ çš„é”®å€¼æ˜¯bodyï¼Œè€ŒèŽ·å–htmlå…ƒç´ çš„é”®å€¼æ˜¯documentElementï¼Œæ‰€ä»¥è¦åœ¨Chromeæµè§ˆå™¨ä¸­è¿è¡Œæ­£å¸¸çš„è„šæ­¥ä»£ç åº”è¯¥æ˜¯ï¼š 123456789101112131415var main = document.querySelector('.main');var nav = document.querySelector('.nav');var flag = 0;main.addEventListener('click', function () &#123; nav.style.display = 'block'; flag = document.documentElement.scrollTop; document.documentElement.style.position = 'fixed'; document.documentElement.style.top = -flag + 'px';&#125;);nav.addEventListener('click', function () &#123; document.documentElement.style.position = 'static'; document.documentElement.style.top = 'auto'; document.documentElement.scrollTop = flag; nav.style.display = 'none';&#125;); è¿è¡Œæ•ˆæžœåœ¨.navå‡ºçŽ°æˆ–æ¶ˆå¤±æ—¶ï¼Œè®¤çœŸçœ‹å¯ä»¥å¼€åˆ°.mainæœ‰äº›å°æŠ–åŠ¨ï¼Œä½†å¹¶ä¸æ˜Žæ˜¾ï¼Œåœ¨ä»Šå¤©ç§»åŠ¨ç«¯ç¡¬ä»¶ï¼ˆCPUï¼Œå†…å­˜ï¼‰å’Œè½¯ä»¶ï¼ˆæµè§ˆå™¨ï¼‰ä¼˜åŒ–è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ»šåŠ¨ç©¿é€çš„è§£å†³æ–¹æ³•ç¡®å®žæ˜¯å¯ä»¥æ”¾å¿ƒä½¿ç”¨çš„ã€‚ æœ€åŽå¼€å·æœ‰ç–‘ï¼Œå®žè·µè¯æ˜Žã€‚]]></content>
      <categories>
        <category>æ–¹æ¡ˆ</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>html5</tag>
        <tag>css</tag>
        <tag>scheme</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åŸºäºŽRedisçš„ä»»åŠ¡è°ƒåº¦è®¾è®¡æ–¹æ¡ˆ]]></title>
    <url>%2Fblog%2Fscheme-redis-task-queue.html</url>
    <content type="text"><![CDATA[ä¸€ä¸ªç½‘å…³æœåŠ¡å™¨å°±è·Ÿå¿«é¤åº—ä¸€æ ·ï¼Œæ€»æ˜¯å¸Œæœ›å®¢äººæ¥å¾—å¿«ã€åŽ»å¾—ä¹Ÿå¿«ï¼Œè¿™æ ·åœ¨ç›¸åŒæ—¶é—´å†…æ‰å¯ä»¥æœåŠ¡æ›´å¤šçš„å®¢äººã€‚å¦‚æžœå¿«é¤åº—çš„æœåŠ¡å‘˜åœ¨ä¸€ä¸ªé¡¾å®¢ç‚¹é¤ã€ç­‰é¤å’Œç»“è´¦æ—¶éƒ½å…¨ç¨‹è·Ÿé™ªçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡å‘˜å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯åœ¨ç©ºé—²çš„ç­‰å¾…ã€‚åº”è¯¥æœ‰ä¸“é—¨çš„æœåŠ¡å‘˜è´Ÿè´£ç‚¹é¤ï¼Œä¸“é—¨çš„æœåŠ¡å‘˜è´Ÿè´£é€é¤ï¼Œä¸“é—¨çš„æœåŠ¡å‘˜è´Ÿè´£ç»“è´¦ï¼Œè¿™æ ·æ‰èƒ½æé«˜æ•ˆçŽ‡ã€‚åŒæ ·é“ç†ï¼Œç½‘å…³æœåŠ¡å™¨ä¸­ä¹Ÿéœ€è¦åˆ†å·¥æ˜Žç¡®ã€‚ä¸¾ä¸ªä¾‹å­ï¼š å‡è®¾æœ‰ä¸€ä¸ªç”³è¯·å‘é€é‡ç½®å¯†ç é‚®ä»¶çš„ç½‘å…³æŽ¥å£ï¼Œé¡»çŸ¥é“å‘é€ä¸€å°é‚®ä»¶å¯èƒ½ä¼šèŠ±è´¹ä¸Šå¥½å‡ ç§’é’Ÿï¼Œå¦‚æžœç½‘å…³æœåŠ¡å™¨ç›´æŽ¥åœ¨çº¿ä¸Šç»™ç”¨æˆ·å‘é€é‡ç½®å¯†ç é‚®ä»¶ï¼Œé«˜å¹¶å‘çš„æƒ…å†µä¸‹å°±å¾ˆå®¹æ˜“é€ æˆç½‘ç»œæ‹¥æŒ¤ã€‚ä½†å®žé™…ä¸Šï¼Œç½‘å…³æœåŠ¡å™¨å¹¶éžä¸€å®šè¦ç­‰å¾…é‚®ä»¶å‘é€æˆåŠŸåŽæ‰èƒ½å“åº”ç”¨æˆ·ï¼Œå®Œå…¨å¯ä»¥å…ˆå‘ŠçŸ¥ç”¨æˆ·é‚®ä»¶ä¼šå‘é€çš„ï¼Œè€ŒåŽå†åœ¨çº¿ä¸‹æŠŠé‚®ä»¶å‘é€å‡ºåŽ»ï¼ˆå°±åƒå¿«é¤åº—é‡Œç‚¹é¤çš„æœåŠ¡å‘˜è·Ÿé¡¾å®¢è¯´å…ˆåŽ»æ‰¾ä½ç½®åï¼Œé¥­èœåšå¥½åŽä¼šæœ‰äººç»™ä»–é€è¿‡åŽ»ï¼‰ã€‚ é‚£ä¹ˆæ˜¯è°æ¥æŠŠé‚®ä»¶å‘é€å‡ºåŽ»å‘¢ï¼Ÿ ä»»åŠ¡é˜Ÿåˆ—ä¸ºäº†ç½‘å…³æŽ¥å£èƒ½å¤Ÿå°½å¿«å“åº”ç”¨æˆ·è¯·æ±‚ï¼Œæ— éœ€å³æ—¶çŸ¥é“ç»“æžœçš„è€—æ—¶æ“ä½œå¯ä»¥äº¤ç”±ä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶æ¥å¤„ç†ã€‚ä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶ä¸­åŒ…å«ä¸¤ç§è§’è‰²ï¼Œä¸€ä¸ªæ˜¯ä»»åŠ¡ç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ˜¯ä»»åŠ¡æ¶ˆè´¹è€…ï¼Œè€Œä»»åŠ¡é˜Ÿåˆ—æ˜¯ä¸¤è€…ä¹‹é—´çš„çº½å¸¦ï¼š ç”Ÿäº§è€…å¾€é˜Ÿåˆ—é‡Œæ”¾å…¥ä»»åŠ¡ï¼› æ¶ˆè´¹è€…ä»Žé˜Ÿåˆ—é‡Œå–å‡ºä»»åŠ¡ã€‚ ä»»åŠ¡é˜Ÿåˆ—çš„æ•´ä½“è¿è¡Œæµç¨‹æ˜¯ï¼šä»»åŠ¡ç”Ÿäº§è€…æŠŠå½“å‰æ“ä½œçš„å…³é”®ä¿¡æ¯ï¼ˆåŽç»­å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯è¿˜åŽŸå‡ºå½“å‰æ“ä½œï¼‰æŠ½è±¡å‡ºæ¥ï¼Œæ¯”å¦‚å‘é€é‡ç½®å¯†ç çš„é‚®ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦å½“å‰ç”¨æˆ·é‚®ç®±å’Œç”¨æˆ·åå°±å¯ä»¥äº†ï¼›ä»»åŠ¡ç”Ÿäº§è€…æŠŠä»»åŠ¡æ”¾è¿›é˜Ÿåˆ—ï¼Œå®žé™…å°±æ˜¯æŠŠä»»åŠ¡çš„å…³é”®ä¿¡æ¯å­˜å‚¨èµ·æ¥ï¼Œè¿™é‡Œä¼šç”¨åˆ°MySQLã€Redisä¹‹ç±»æ•°æ®å­˜å‚¨å·¥å…·ï¼Œå¸¸ç”¨çš„æ˜¯Redisï¼›è€Œä»»åŠ¡æ¶ˆè´¹è€…å°±ä¸æ–­åœ°ä»Žæ•°æ®åº“ä¸­å–å‡ºä»»åŠ¡ä¿¡æ¯ï¼Œé€ä¸€æ‰§è¡Œã€‚ ä»»åŠ¡ç”Ÿäº§è€…çš„å·¥ä½œæ˜¯ä»»åŠ¡åˆ†å‘ï¼Œä¸€èˆ¬ç”±çº¿ä¸Šçš„ç½‘å…³æœåŠ¡ç¨‹åºæ‰§è¡Œï¼›ä»»åŠ¡æ¶ˆè´¹è€…çš„å·¥ä½œæ˜¯ä»»åŠ¡è°ƒåº¦ï¼Œä¸€èˆ¬ç”±çº¿ä¸‹çš„ç¨‹åºæ‰§è¡Œï¼Œè¿™æ ·å³ä½¿ä»»åŠ¡è€—æ—¶å†å¤šï¼Œä¹Ÿä¸é˜»å¡žç½‘å…³æœåŠ¡ã€‚ è¿™é‡Œä¸»è¦è®¨è®ºçš„æ˜¯ä»»åŠ¡è°ƒåº¦ï¼ˆä»»åŠ¡æ¶ˆè´¹è€…ï¼‰çš„ç¨‹åºè®¾è®¡ã€‚ ç®€å•ç›´æŽ¥å‡è®¾æˆ‘ä»¬ç”¨Redisåˆ—è¡¨Listå­˜å‚¨ä»»åŠ¡ä¿¡æ¯ï¼Œåˆ—è¡¨é”®åæ˜¯queues:defaultï¼Œä»»åŠ¡å‘å¸ƒå°±æ˜¯å¾€åˆ—è¡¨queues:defaultåŽè¿½åŠ æ•°æ®ï¼š 123&lt;?php// PHPä¼ªä»£ç  Redis::rpush('queues:default', serialize($task)); é‚£ä¹ˆä»»åŠ¡è°ƒåº¦å¯ä»¥è¿™æ ·ç®€å•ç›´æŽ¥çš„å®žçŽ°ï¼š 1234567891011121314151617181920212223&lt;?php// PHPä¼ªä»£ç Class Worker &#123; public function schedule() &#123; while(1) &#123; $seri = Redis::lpop('queues:default'); if($seri) &#123; $task = unserialize($seri); $this-&gt;handle($task); continue; &#125; sleep(1); &#125; &#125; public function handle($task) &#123; // do something time-consuming &#125;&#125;$worker = new Worker;$worker-&gt;schedule(); æ„å¤–ä¿é™©ä¸Šé¢ä»£ç æ˜¯ç›´æŽ¥ä»Žqueues:defaultåˆ—è¡¨ä¸­ç§»å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆlpopï¼‰ï¼Œå› ä¸ºhandle($task)å‡½æ•°æ˜¯ä¸€ä¸ªè€—æ—¶çš„æ“ä½œï¼Œè¿‡ç¨‹ä¸­è‹¥æ˜¯é‡åˆ°ä»€ä¹ˆæ„å¤–å¯¼è‡´äº†æ•´ä¸ªç¨‹åºé€€å‡ºï¼Œè¿™ä¸ªä»»åŠ¡å¯èƒ½è¿˜æ²¡æ‰§è¡Œå®Œæˆï¼Œå¯æ˜¯ä»»åŠ¡ä¿¡æ¯å·²ç»å®Œå…¨ä¸¢å¤±äº†ã€‚ä¿é™©èµ·è§ï¼Œå¯¹schedule()å‡½æ•°è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š 123456789101112131415&lt;?php... public function schedule() &#123; while(1) &#123; $seri = Redis::lindex('queues:default', 0); if($seri) &#123; $task = unserialize($seri); $this-&gt;handle($task); Redis::lpop('queues:default'); continue; &#125; sleep(1); &#125; &#125;... å³åœ¨ä»»åŠ¡å®ŒæˆåŽæ‰å°†ä»»åŠ¡ä¿¡æ¯ä»Žåˆ—è¡¨ä¸­ç§»é™¤ã€‚ å»¶æ—¶æ‰§è¡Œqueues:defaultåˆ—è¡¨ä¸­çš„ä»»åŠ¡éƒ½æ˜¯éœ€è¦å³æ—¶æ‰§è¡Œçš„ï¼Œä½†æ˜¯æœ‰äº›ä»»åŠ¡æ˜¯éœ€è¦é—´éš”ä¸€æ®µæ—¶é—´åŽæˆ–è€…åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šæ‰§è¡Œï¼Œé‚£ä¹ˆå¯ä»¥å¼•å…¥ä¸€ä¸ªæœ‰åºé›†åˆï¼Œå‘½åä¸ºqueues:default:delayedï¼Œæ¥å­˜æ”¾è¿™äº›ä»»åŠ¡ã€‚ä»»åŠ¡å‘å¸ƒæ—¶éœ€è¦æŒ‡æ˜Žæ‰§è¡Œçš„æ—¶é—´ç‚¹$timeï¼š 123&lt;?php// PHPä¼ªä»£ç  Redis::zadd('queues:default:delayed', $time, serialize($task)); ä»»åŠ¡è°ƒåº¦æ—¶ï¼Œå¦‚æžœqueues:defaultåˆ—è¡¨å·²ç»ç©ºäº†ï¼Œå°±ä»Žqueues:default:delayedé›†åˆä¸­å–å‡ºåˆ°è¾¾æ‰§è¡Œæ—¶é—´çš„ä»»åŠ¡æ”¾å…¥queues:defaultåˆ—è¡¨ä¸­ï¼š 1234567891011121314151617181920&lt;?php... public function schedule() &#123; while(1) &#123; $seri = Redis::lindex('queues:default', 0); if($seri) &#123; $task = unserialize($seri); $this-&gt;handle($task); Redis::lpop('queues:default'); continue; &#125; $seri_arr = Redis::zremrangebyscore('queues:default:delayed', 0, time()); if($seri_arr) &#123; Redis::rpush('queues:default', $seri_arr); continue; &#125; sleep(1); &#125; &#125;... ä»»åŠ¡è¶…æ—¶é¢„ä¼°ä»»åŠ¡æ­£å¸¸æ‰§è¡Œæ‰€éœ€çš„æœ€å¤§æ—¶é—´å€¼ï¼Œè‹¥æ˜¯ä»»åŠ¡æ‰§è¡Œè¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œå¯èƒ½æ˜¯è¿‡ç¨‹ä¸­é‡åˆ°ä¸€äº›æ„å¤–ï¼Œå¦‚æžœä»»ç”±å®ƒç»§ç»­å¡ç€ï¼Œé‚£ä¹ˆåŽé¢çš„ä»»åŠ¡å°±ä¼šæ— æ³•è¢«æ‰§è¡Œäº†ã€‚é¦–å…ˆæˆ‘ä»¬ç»™ä»»åŠ¡è®¾å®šä¸€ä¸ªæ—¶é™å±žæ€§timeoutï¼Œç„¶åŽåœ¨æ‰§è¡Œä»»åŠ¡å‰å…ˆç»™è¿›ç¨‹æœ¬èº«è®¾ç½®ä¸€ä¸ªé—¹é’Ÿä¿¡å·ï¼ŒtimeoutåŽæ”¶åˆ°ä¿¡å·è¯´æ˜Žä»»åŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œéœ€è¦é€€å‡ºå½“å‰è¿›ç¨‹ï¼ˆç”¨supervisorå®ˆæŠ¤è¿›ç¨‹æ—¶ï¼Œè¿›ç¨‹è‡ªèº«é€€å‡ºï¼Œsupervisorä¼šè‡ªåŠ¨å†æ‹‰èµ·ï¼‰ã€‚æ³¨æ„ï¼špcntl_alarm($timeout)ä¼šè¦†ç›–ä¹‹å‰é—¹é’Ÿä¿¡å·ï¼Œè€Œpcntl_alarm(0)ä¼šå–æ¶ˆé—¹é’Ÿä¿¡å·ï¼›ä»»åŠ¡è¶…æ—¶åŽï¼Œå½“å‰ä»»åŠ¡æ”¾å…¥queues:default:delayedé›†åˆä¸­å»¶æ—¶æ‰§è¡Œï¼Œä»¥å…å†æ¬¡é˜»å¡žé˜Ÿåˆ—ã€‚ 12345678910111213141516171819202122232425262728293031323334&lt;?php... public function schedule() &#123; while(1) &#123; $seri = Redis::lindex('queues:default', 0); if($seri) &#123; $task = unserialize($seri); $this-&gt;timeoutHanle($task); $this-&gt;handle($task); Redis::lpop('queues:default'); continue; &#125; $seri_arr = Redis::zremrangebyscore('queues:default:delayed', 0, time()); if($seri_arr) &#123; Redis::rpush('queues:default', $seri_arr); continue; &#125; pcntl_alarm(0); sleep(1); &#125; &#125; public function timeoutHanle($task) &#123; $timeout = (int)$task-&gt;timeout; if ($timeout &gt; 0) &#123; pcntl_signal(SIGALRM, function () &#123; $seri = Redis::lpop('queues:default'); Redis::zadd('queues:default:delayed', time()+10), $seri); posix_kill(getmypid(), SIGKILL); &#125;); &#125; pcntl_alarm($timeout); &#125;... å¹¶å‘æ‰§è¡Œä¸Šé¢ä»£ç ï¼Œç›´è§‚ä¸Šæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šè¿›ç¨‹å¹¶å‘æ‰§è¡Œçš„æ—¶å€™ï¼Œæœ‰äº›ä»»åŠ¡å¯èƒ½ä¼šè¢«é‡å¤æ‰§è¡Œï¼Œæ˜¯å› ä¸ºæ²¡èƒ½åŠæ—¶å°†å½“å‰æ‰§è¡Œçš„ä»»åŠ¡ä»Žqueues:defaultåˆ—è¡¨ä¸­ç§»å‡ºï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿå¯ä»¥è¯»å–åˆ°ã€‚ä¸ºäº†é¿å…é‡å¤æ‰§è¡Œçš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªæœ‰åºé›†åˆSortedSetå­˜æ”¾æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå‘½åä¸ºqueues:default:reservedã€‚é¦–å…ˆä»»åŠ¡æ˜¯ä»Žqueues:defaultåˆ—è¡¨ä¸­ç›´æŽ¥ç§»å‡ºï¼Œç„¶åŽå¼€å§‹æ‰§è¡Œä»»åŠ¡å‰å…ˆæŠŠä»»åŠ¡æ”¾è¿›queues:default:reservedé›†åˆä¸­ï¼Œä»»åŠ¡å®Œæˆäº†å†ä»Žqueues:default:reservedé›†åˆä¸­ç§»å‡ºã€‚å†ç»“åˆä»»åŠ¡è¶…æ—¶ï¼Œå‡è®¾ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸å¯èƒ½è¶…è¿‡60*60ç§’ï¼ˆå¯ä»¥æŒ‰éœ€è°ƒæ•´ï¼‰ï¼Œåœ¨queues:defaultåˆ—è¡¨ä¸ºç©ºçš„æ—¶å€™ï¼Œqueues:default:reservedé›†åˆä¸­æœ‰ä»»åŠ¡å·²ç»å­˜æ”¾è¶…è¿‡äº†60*60ç§’ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½æ˜¯æŸäº›è¿›ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡æ˜¯æ„å¤–é€€å‡ºäº†ï¼Œæ‰€ä»¥æŠŠè¿™äº›ä»»åŠ¡æ”¾åˆ°queues:default:delayedé›†åˆä¸­ç¨åŽæ‰§è¡Œã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142&lt;?php... public function schedule() &#123; while(1) &#123; $seri = Redis::lpop('queues:default', 0); if($seri) &#123; Redis::zadd('queues:default:reserved', time()+10, $seri); $task = unserialize($seri); $this-&gt;timeoutHanle($task); $this-&gt;handle($task); Redis::zrem('queues:default:reserved', $seri); continue; &#125; $seri_arr = Redis::zremrangebyscore('queues:default:delayed', 0, time()); if($seri_arr) &#123; Redis::rpush('queues:default', $seri_arr); continue; &#125; $seri_arr = Redis::zremrangebyscore('queues:default:reserved', 0, time()-60*60); if($seri_arr) &#123; foreach($seri_arr as $seri) &#123; Redis::zadd('queues:default:delayed', time()+10, $seri); &#125; &#125; sleep(1); &#125; &#125; public function timeoutHanle($task) &#123; $timeout = (int)$task-&gt;timeout; if ($timeout &gt; 0) &#123; pcntl_signal(SIGALRM, function () use ($task) &#123; $seri = serialize($task); Redis::zrem('queues:default:reserved', $seri); Redis::zadd('queues:default:delayed', time()+10), $seri); posix_kill(getmypid(), SIGKILL); &#125;); &#125; pcntl_alarm($timeout); &#125;... å…¶ä»–å¤±è´¥é‡è¯•ä»¥ä¸Šä»£ç æ²¡æœ‰æ£€éªŒä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œåº”è¯¥æœ‰ä»»åŠ¡å¤±è´¥çš„å¤„ç†æœºåˆ¶ï¼šæ¯”å¦‚ç»™ä»»åŠ¡è®¾å®šä¸€ä¸ªæœ€å¤šé‡è¯•æ¬¡æ•°å±žæ€§retry_timesï¼Œä»»åŠ¡æ¯æ‰§è¡Œä¸€æ¬¡retry_timesï¼Œä»»åŠ¡æ‰§è¡Œå¤±è´¥æ—¶ï¼Œè‹¥æ˜¯retry_timesç­‰äºŽ0ï¼Œåˆ™å°†ä»»åŠ¡æ”¾å…¥queues:default:failedåˆ—è¡¨ä¸­ä¸å†æ‰§è¡Œï¼›å¦åˆ™æ”¾å…¥æ”¾åˆ°queues:default:delayedé›†åˆä¸­ç¨åŽæ‰§è¡Œã€‚ ä¼‘çœ æ—¶é—´ä»¥ä¸Šä»£ç æ˜¯è¿›ç¨‹å¿™æ—¶è¿žç»­æ‰§è¡Œï¼Œé—²æ—¶ä¼‘çœ ä¸€ç§’ï¼Œå¯ä»¥æŒ‰éœ€è°ƒæ•´ä¼˜åŒ–ã€‚ äº‹ä»¶ç›‘å¬è‹¥æ˜¯éœ€è¦åœ¨ä»»åŠ¡æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶è¿›è¡ŒæŸäº›æ“ä½œï¼Œå¯ä»¥ç»™ä»»åŠ¡è®¾å®šæˆåŠŸæ“ä½œæ–¹æ³•afterSucceeded()æˆ–å¤±è´¥æ“ä½œæ–¹æ³•afterFailed()ï¼Œåœ¨ç›¸åº”çš„æ—¶å€™å›žè°ƒã€‚ æœ€åŽä»¥ä¸Šè®²è¿°äº†ä¸€ä¸ªä»»åŠ¡è°ƒåº¦ç¨‹åºçš„é€æ­¥æ¼”å˜ï¼Œè®¾è®¡æ–¹æ¡ˆå¾ˆå¤§ç¨‹åº¦ä¸Šå‚è€ƒäº†Laravel Queueã€‚ç”¨å·¥å…·ï¼ŒçŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚]]></content>
      <categories>
        <category>æ–¹æ¡ˆ</category>
      </categories>
      <tags>
        <tag>scheme</tag>
        <tag>php</tag>
        <tag>redis</tag>
        <tag>queue</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åŠ¨æ€æ›´æ–°æ—¶æ•ˆæ€§ç¼“å­˜çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ]]></title>
    <url>%2Fblog%2Fscheme-refresh-timeliness-cache.html</url>
    <content type="text"><![CDATA[æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡æ–‡ç« ä¸€å¼ ä¼˜æƒ åˆ¸å¼•å‘çš„è¡€æ¡ˆï¼Œæ–‡ç« ä½œè€…å®žçŽ°ä¸€ä¸ªèŽ·å–ä¼˜æƒ åˆ¸åˆ—è¡¨çš„RPCæŽ¥å£ï¼ŒæŽ¥å£ä¸­çš„æ‰§è¡Œæµç¨‹å¤§æ¦‚æ˜¯å…ˆåœ¨ç¼“å­˜é‡ŒèŽ·å–ä¼˜æƒ åˆ¸åˆ—è¡¨ï¼Œæœ‰åˆ™è¿”å›žï¼Œæ²¡æœ‰åˆ™åœ¨æ•°æ®åº“é‡ŒèŽ·å–ï¼Œå°†ç»“æžœå†™å…¥ç¼“å­˜å†è¿”å›žã€‚ç„¶è€Œï¼Œåœ¨é«˜å¹¶å‘è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œç¼“å­˜ä¼˜æƒ åˆ¸åˆ—è¡¨ä¸­å‡ºçŽ°å¤§é‡çš„é‡å¤æ•°æ®ã€‚ä¸»è¦åŽŸå› æ˜¯ï¼š ç¨‹åºåªé€‚åº”å•ä¾‹æ‰§è¡Œï¼Œæ²¡æœ‰è€ƒè™‘åˆ°å¤šä¾‹å¹¶å‘çš„æƒ…å†µï¼› ä¼˜æƒ åˆ¸åˆ—è¡¨åœ¨ç¼“å­˜ä¸­å­˜å‚¨ç»“æž„æ˜¯æ•°ç»„ï¼Œè€Œæ›´æ–°æ–¹æ³•æ˜¯ç›´æŽ¥è¿½åŠ ï¼› ç›´æŽ¥åœ¨RPCæŽ¥å£ä¸­æ‰§è¡Œæ›´æ–°ç¼“å­˜ã€‚ æ–‡ç« ä½œè€…æœ€åŽé€šè¿‡åå¤åˆ¤æ–­æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½åŠžæ³•ã€‚å…¶å®žè¿™æ ·éœ€è¦åŠ¨æ€æ›´æ–°ç¼“å­˜åœºæ™¯åœ¨å¼€å‘ä¸­ååˆ†å¸¸è§ï¼Œæ‰€ä»¥åœ¨è¿™é‡ŒæŽ¢è®¨ä¸€ä¸‹ç›¸å¯¹å®Œå–„çš„è§£å†³æ–¹æ¡ˆã€‚ åœºæ™¯å‡è®¾æœ‰ä¸€äº›æ—¶æ•ˆæ€§çš„æ•°æ®ï¼ˆæ¯”å¦‚æœ€æ–°èµ„è®¯ã€ä»Šæ—¥å¤©æ°”ç­‰ç­‰ï¼‰ï¼Œè¿™äº›æ•°æ®åœ¨ä¸€å®šæ—¶é—´å†…ä¸ä¼šæ”¹å˜ï¼Œç”¨æˆ·ç»å¸¸ä¼šèŽ·å–ï¼Œè€Œç›´æŽ¥ä»Žæ•°æ®åº“ä¸­è¯»å–ç›¸å¯¹è€—æ—¶ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®å¾ˆåº”è¯¥æ”¾åœ¨ç¼“å­˜ä¸­ã€‚å› ä¸ºè¿™äº›æ•°æ®å…·æœ‰æ—¶æ•ˆæ€§ï¼Œæ‰€ä»¥éœ€è¦åŠæ—¶æ›´æ–°ã€‚ç”¨å®šæ—¶æ›´æ–°çš„è¯ï¼ˆä¸€èˆ¬éƒ½ä¸ä¼šæ¯ä¸ª1ç§’æ›´æ–°ä¸€æ¬¡ï¼‰ï¼Œä¼šæœ‰ä¸€äº›é—´éš”ï¼›ç”¨åŠ¨æ€æ›´æ–°çš„è¯ï¼ˆç”±ç”¨æˆ·è§¦å‘æ›´æ–°ï¼‰ï¼Œåœ¨ç”¨æˆ·è¯·æ±‚èŽ·å–è¿™äº›æ•°æ®çš„æ—¶å€™æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œæ˜¯åˆ™æ›´æ–°å¹¶å°†æ–°çš„æ•°æ®è¿”å›žç»™ç”¨æˆ·ã€‚ å®žçŽ°æ•°æ®ç»“æž„åœ¨ç¼“å­˜ä¸­å­˜å‚¨æ•°æ®æ—¶ï¼Œåº”è¯¥é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æž„ã€‚ å¦‚æžœæ•°æ®æœ¬èº«æ˜¯æœ‰è§„åˆ™å…ƒç´ çš„é›†åˆï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨æ•°ç»„ç»“æž„å­˜å‚¨ï¼Œæ–¹ä¾¿æ‰©å±•ï¼› å¦‚æžœæ•°æ®æœ¬èº«æ˜¯æœ‰è§„åˆ™å…ƒç´ çš„é›†åˆä¸”å…ƒç´ å„æœ‰ä¸»é”®ï¼Œé‡‡ç”¨æ˜ å°„ç»“æž„å­˜å‚¨ï¼Œå¯ä»¥å•ç‹¬å¯¹å…ƒç´ è¿›è¡Œæ›´æ–°ï¼› å¦‚æžœæ•°æ®æœ¬èº«æ¯«æ— è§„åˆ™ï¼Œå¯ä»¥å°è£…æˆJSONæ ¼å¼ï¼Œé‡‡ç”¨å­—ç¬¦ä¸²ç»“æž„å­˜å‚¨ï¼Œæ›´æ–°æ—¶æ˜¯å…¨é‡æ›´æ–°ã€‚ å¦å¤–ï¼Œéœ€è¦è®°å½•æ•°æ®ä¸Šä¸€æ¬¡æ›´æ–°çš„æ—¶é—´æˆ³ï¼Œå³å°†è¿™ä¸ªæ—¶é—´æˆ³ä¹Ÿæ”¾è¿›ç¼“å­˜ï¼Œä»¥æ­¤æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼Œæ˜¯å¦éœ€è¦æ›´æ–°ã€‚å½“ç„¶ï¼ŒåƒRedisè¿™ç±»æˆç†Ÿçš„å­˜å‚¨å·¥å…·ï¼Œå¯ä»¥ç›´æŽ¥åˆ©ç”¨å…¶æä¾›çš„TTLï¼ˆtime to liveï¼‰æ¥åˆ¤æ–­ã€‚ ä»»åŠ¡é˜Ÿåˆ—é¦–å…ˆå…ˆå®žçŽ°ä¸€ä¸ªæ›´æ–°æ•°æ®çš„ä»»åŠ¡ï¼Œè¿™é‡Œæ›´æ–°æ˜¯æŒ‡å…¨é‡æ›´æ–°ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š 1234567891011public static function updateTheDataTask() &#123; $ttl = Redis::getTheDataTTL(); if($ttl &gt; NEED_TO_UPDATE) &#123; return false; &#125; $data = MySQL::getTheData(); Redis::setTheData($data); // update expires of the data at the same time sleep(2); Queue::cancelOtherUpdateTheDataTasks(); return true;&#125; ç„¶åŽï¼Œè¿è¡Œä¸€ä¸ªæ‰§è¡Œæ•°æ®æ›´æ–°ä»»åŠ¡çš„é˜Ÿåˆ—è¿›ç¨‹ï¼Œæ³¨æ„é¡»æ˜¯å•è¿›ç¨‹ï¼Œè€Œéžå¤šè¿›ç¨‹ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šåªæ‰§è¡Œä¸€ä¸ªæ•°æ®æ›´æ–°ä»»åŠ¡ã€‚å…¶ä¸­åšTTLåˆ¤æ–­ï¼Œæ˜¯ä¸ºäº†è¿‡æ»¤æ²¡å¿…è¦ä»»åŠ¡æ‰§è¡Œï¼›æ›´æ–°æˆåŠŸåŽä¼‘çœ ä¸¤ç§’ï¼ˆå…¶å®žå¯ä»¥ä¼‘çœ æ›´ä¹…ç‚¹ï¼‰ï¼Œä¸»è¦ç­‰å¾…RedisåŒæ­¥ï¼Œä»¥å…åŽç»­ä»»åŠ¡èŽ·å–åˆ°æ—§çš„æ•°æ®ï¼›å–æ¶ˆæŽ‰åŽç»­çš„æ•°æ®æ›´æ–°ä»»åŠ¡æ˜¯å› ä¸ºæ ¹æœ¬æ²¡å¿…è¦æ‰§è¡Œäº†ã€‚ ä»»åŠ¡é˜Ÿåˆ—å¯ä»¥ç”¨gearmanå®žçŽ°ï¼Œè€Œé˜Ÿåˆ—è¿›ç¨‹å¯ä»¥ç”¨supervisordæ¥å®ˆæŠ¤ï¼Œè¿™é‡Œä¸å±•å¼€ä»‹ç»ã€‚ ç½‘å…³æŽ¥å£æœ‰äº†ä¸Šé¢çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸‹é¢å®žçŽ°é¢å‘ç”¨æˆ·çš„èŽ·å–æ•°æ®æŽ¥å£å°±å®¹æ˜“å¤šäº†ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š 12345678910public function theData() &#123; $data = Redis::getTheData(); if($data) &#123; return $data; &#125; else &#123; $data = MySQL::getTheData(); Queue::pushUpdateTheDataTask(); return $data; &#125;&#125; Queue::pushUpdateTheDataTask()åªæ˜¯å°†æ•°æ®æ›´æ–°ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œç”±é˜Ÿåˆ—å¤„ç†è¿›ç¨‹åŽ»æ‰§è¡Œã€‚è¿™é‡Œå¼ºè°ƒä¸€ä¸‹ï¼Œæ•°æ®æ›´æ–°è™½ç„¶æ˜¯ç”±ç”¨æˆ·è§¦å‘ï¼Œä½†æ˜¯ç»ä¸åœ¨é¢å‘ç”¨æˆ·çš„ç½‘å…³æŽ¥å£é‡Œæ‰§è¡Œï¼Œå› ä¸ºé¢å‘ç”¨æˆ·çš„ç½‘å…³æŽ¥å£å¯èƒ½ä¼šæœ‰å¤§é‡å¹¶å‘è¯·æ±‚ï¼ŒæŽ¥å£å†…ä¸åº”è¯¥åšè€—æ—¶æ“ä½œï¼Œæ‰€ä»¥æ‰å»ºç«‹ä»»åŠ¡é˜Ÿåˆ—æ¥æ‰§è¡Œæ•°æ®æ›´æ–°ï¼Œå‡è½»ç½‘å…³åŽ‹åŠ›ã€‚ æ•ˆæžœè¿™ä¸ªæ–¹æ¡ˆåœ¨å¤§é‡å¹¶å‘è®¿é—®ç½‘å…³æŽ¥å£çš„æƒ…å†µä¸‹ï¼Œç¼“å­˜çš„æ•°æ®å¯ä»¥ä¿æŒå‡†ç¡®ï¼Œè¿‡ç¨‹æ²¡æœ‰è¿‡å¤šçš„æ— ç”¨æ“ä½œï¼Œä¹ŸèŠ‚çœäº†æ‰§è¡Œæ—¶é—´ã€‚ æœ€åŽã€Šä¸€å¼ ä¼˜æƒ åˆ¸å¼•å‘çš„è¡€æ¡ˆã€‹å›¾æ–‡å¹¶èŒ‚ï¼Œæ–‡ä¸­ä½œè€…å¯¹è¿›ç¨‹ã€ä»£ç å—ã€åˆ†å¸ƒå¼é”ç­‰æ–¹é¢è¿›è¡Œäº†è®¨è®ºï¼Œæœ€åŽä¹Ÿæä¾›è§£å†³æ–¹æ³•ï¼Œç„¶è€Œè¯»è€…æ›´éœ€è¦çš„æ˜¯ç‹¬ç«‹æ€è€ƒâ€”â€”åŒæ ·çš„é—®é¢˜ï¼Œå¯ä»¥æœ‰ä¸åŒçš„ã€æ›´å¥½çš„è§£å†³æ–¹æ³•ã€‚ å¼€å·æœ‰ç›Šï¼Œè´µåœ¨æ€è€ƒã€‚]]></content>
      <categories>
        <category>æ–¹æ¡ˆ</category>
      </categories>
      <tags>
        <tag>scheme</tag>
        <tag>mysql</tag>
        <tag>php</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”¨Dockeræ­å»ºRabbitMQé«˜å¯ç”¨é›†ç¾¤]]></title>
    <url>%2Fblog%2Fpractice-rabbitmq-ha-docker-compose.html</url>
    <content type="text"><![CDATA[RabbitMQæ˜¯åŸºäºŽé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰å®žçŽ°çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼Œä¸»è¦æä¾›æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ã€‚è¿™é‡Œä»‹ç»ç”¨Docker Composeæ­å»ºRabbitMQé«˜å¯ç”¨é›†ç¾¤çš„è¿‡ç¨‹ã€‚ RabbitMQè‡ªèº«æä¾›éƒ¨ç½²é›†ç¾¤çš„åŠŸèƒ½ï¼Œé€šè¿‡å‘½ä»¤ï¼š 123$ rabbitmqctl -n rabbit@rmqha_node1 stop_app$ rabbitmqctl -n rabbit@rmqha_node1 join_cluster --ram rabbit@rmqha_node0$ rabbitmqctl -n rabbit@rmqha_node1 start_app å°±å¯ä»¥å¾ˆå®¹æ˜“çš„å°†èŠ‚ç‚¹rabbit@rmqha_node1åŠ å…¥åˆ°é›†ç¾¤rabbit@rmqha_node0ä¸­ã€‚--ramé€‰é¡¹è¡¨ç¤ºèŠ‚ç‚¹ä»¥å†…å­˜å­˜å‚¨æ–¹å¼è¿è¡Œï¼Œè¯»å†™é€Ÿåº¦å¿«ï¼Œé‡å¯åŽå†…å®¹ä¼šä¸¢å¤±ï¼›ä¸åŠ --ramé€‰é¡¹ï¼ŒèŠ‚ç‚¹åˆ™ä»¥ç£ç›˜å­˜å‚¨æ–¹å¼è¿è¡Œï¼Œè™½ç„¶è¯»å†™é€Ÿåº¦æ…¢ï¼Œä½†æ˜¯å†…å®¹ä¸€èˆ¬å¯ä»¥æŒä¹…ä¿æŒã€‚ åœ¨åŒä¸€ä¸ªRabbitMQé›†ç¾¤ä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´å¹¶æ²¡æœ‰ä¸»ä»Žä¹‹åˆ†ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¼šåŒæ­¥ç›¸åŒçš„é˜Ÿåˆ—ç»“æž„ï¼Œé˜Ÿåˆ—å†…å®¹ï¼ˆæ¶ˆæ¯ï¼‰åˆ™å„è‡ªä¸åŒï¼Œä¸è¿‡æ¶ˆæ¯ä¼šåœ¨èŠ‚ç‚¹é—´ä¼ é€’ã€‚è¿™æ ·çš„é›†ç¾¤åªæ˜¯æé«˜äº†åº”å¯¹å¤§é‡å¹¶å‘è¯·æ±‚çš„èƒ½åŠ›ï¼Œæ•´ä½“å¯ç”¨æ€§è¿˜æ˜¯å¾ˆä½Žï¼Œå› ä¸ºæŸä¸ªèŠ‚ç‚¹å®•æœºåŽï¼Œå¯„å­˜åœ¨è¯¥èŠ‚ç‚¹ä¸Šçš„æ¶ˆæ¯ä¸å¯ç”¨ï¼Œè€Œåœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šä¹Ÿæ²¡æœ‰è¿™äº›æ¶ˆæ¯çš„å¤‡ä»½ï¼Œè‹¥æ˜¯è¯¥èŠ‚ç‚¹æ— æ³•æ¢å¤ï¼Œé‚£ä¹ˆè¿™äº›æ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRabbitMQæä¾›é•œåƒé˜Ÿåˆ—åŠŸèƒ½ï¼Œé€šè¿‡å‘½ä»¤ï¼š 1$ rabbitmqctl set_policy ha-all "^" '&#123;"ha-mode":"all"&#125;' å¯ä»¥è®¾ç½®é•œåƒé˜Ÿåˆ—ï¼Œ&quot;^&quot;è¡¨ç¤ºåŒ¹é…æ‰€æœ‰é˜Ÿåˆ—ï¼Œå³æ‰€æœ‰é˜Ÿåˆ—åœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šæœ‰å¤‡ä»½ã€‚åœ¨é›†ç¾¤ä¸­ï¼Œåªéœ€è¦åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè®¾ç½®é•œåƒé˜Ÿåˆ—ï¼Œè®¾ç½®æ“ä½œä¼šåŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ Docker Composeç¼–æŽ’è¿™ä¸ªç¼–æŽ’ä¸»è¦å®žçŽ°ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ã€ä¸¤ä¸ªå†…å­˜èŠ‚ç‚¹çš„RabbitMQé›†ç¾¤å’Œä¸€ä¸ªHAProxyä»£ç†ã€‚ ç›®å½•ç»“æž„12345678910L--rabbitmq-ha-docker //ä¸»ç›®å½• L--scripts //æœ¬åœ°ï¼ˆDockerå®¿ä¸»ï¼‰ä½¿ç”¨çš„ä¸€äº›è„šæœ¬ L--rmqha_set_policy.sh //è®¾ç½®å„ä¸ªæ•°æ®åº“è´¦å·å’Œå¼€å¯ä¸»ä»Žå¤åˆ¶ L--volumes //å„ä¸ªå®¹å™¨çš„æŒ‚è½½æ•°æ®å· L--rmqha_proxy L--haproxy.cfg //HAProxyé…ç½® L--rmqha_slave L--cluster_entrypoint.sh //å…¥å£æ–‡ä»¶ L--parameters.env //è´¦å·å¯†ç ç­‰çŽ¯å¢ƒå‚æ•° L--docker-compose.yml //ç¼–æŽ’é…ç½® docker-compose.yml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101version: "2"services: master: image: rabbitmq:3.6-management container_name: rmqha_node0 restart: always mem_limit: 256m networks: net1: ipv4_address: 10.9.0.10 hostname: rmqha_node0 ports: - "55672:15672" - "56720:5672" env_file: - ./parameters.env environment: - CONTAINER_NAME=rmqha_node0 - RABBITMQ_HOSTNAME=rmqha_node0 - RABBITMQ_NODENAME=rabbit slave1: image: rabbitmq:3.6-management container_name: rmqha_node1 restart: always depends_on: - master mem_limit: 256m networks: net1: ipv4_address: 10.9.0.11 hostname: rmqha_node1 # ports: # - "56721:5672" volumes: - "./volumes/rmqha_slave/cluster_entrypoint.sh:/usr/local/bin/cluster_entrypoint.sh" entrypoint: "/usr/local/bin/cluster_entrypoint.sh" command: "rabbitmq-server" env_file: - ./parameters.env environment: - CONTAINER_NAME=rmqha_node1 - RABBITMQ_HOSTNAME=rmqha_node1 - RABBITMQ_NODENAME=rabbit - RMQHA_RAM_NODE=true slave2: image: rabbitmq:3.6-management container_name: rmqha_node2 restart: always depends_on: - master mem_limit: 256m networks: net1: ipv4_address: 10.9.0.12 hostname: rmqha_node2 # ports: # - "56722:5672" volumes: - "./volumes/rmqha_slave/cluster_entrypoint.sh:/usr/local/bin/cluster_entrypoint.sh" entrypoint: "/usr/local/bin/cluster_entrypoint.sh" command: "rabbitmq-server" env_file: - ./parameters.env environment: - CONTAINER_NAME=rmqha_node2 - RABBITMQ_HOSTNAME=rmqha_node2 - RABBITMQ_NODENAME=rabbit - RMQHA_RAM_NODE=true haproxy: image: haproxy:1.8 container_name: rmqha_proxy restart: always depends_on: - master - slave1 - slave2 mem_limit: 256m networks: net1: ipv4_address: 10.9.0.19 hostname: rmqha_proxy ports: - "56729:5672" - "51080:1080" volumes: - "./volumes/rmqha_proxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro" - "./volumes/rmqha_proxy:/root/rmqha_proxy" environment: - CONTAINER_NAME=rmqha_proxynetworks: net1: driver: bridge ipam: config: - subnet: 10.9.0.0/16 gateway: 10.9.0.1 è¿™é‡Œé…ç½®äº†å››ä¸ªå®¹å™¨æœåŠ¡ï¼Œä¸€ä¸ªhaproxyï¼Œè´Ÿè´£ä»£ç†å„ä¸ªRabbitMQæœåŠ¡ï¼›ä¸‰ä¸ªrabbitmqï¼Œç»„æˆRabbitMQé›†ç¾¤ã€‚æ¯ä¸ªå®¹å™¨æœåŠ¡éƒ½æŒ‡å®šäº†é™æ€IPï¼Œå³ä½¿æœåŠ¡é‡å¯ä¹Ÿä¸ä¼šå‡ºçŽ°IPé”™ä¹±é—®é¢˜ï¼Œç‰¹æ®Šçš„ç½‘ç»œç«¯å£æ˜ å°„åŽé¢ä¼šä»‹ç»ã€‚ çŽ¯å¢ƒå‚æ•°parameters.env 123456RMQHA_MASTER_NODE=rabbitRMQHA_MASTER_HOST=rmqha_node0RABBITMQ_DEFAULT_USER=guestRABBITMQ_DEFAULT_PASS=guestRABBITMQ_NODENAME=rabbitRABBITMQ_ERLANG_COOKIE=myerlangcookie RabbitMQå¯åŠ¨è¿™é‡ŒRabbitMQå®¹å™¨æ˜¯ä½¿ç”¨Dockerå®˜æ–¹é•œåƒç”Ÿæˆçš„ï¼ŒèŠ‚ç‚¹rmqha_node0å¯ä»¥ç›´æŽ¥å¯åŠ¨ï¼›è€ŒèŠ‚ç‚¹rmqha_node1å’Œrmqha_node2éœ€è¦åŠ å…¥åˆ°rmqha_node0é›†ç¾¤é‡Œï¼Œæ‰€ä»¥éœ€è¦éœ€æ”¹å…¥å£æ–‡ä»¶ã€‚volumes/rmqha_slave/cluster_entrypoint.sh 1234567891011121314151617#!/bin/bashset -eif [ -e "/root/is_not_first_time" ]; then exec "$@"else /usr/local/bin/docker-entrypoint.sh rabbitmq-server -detached # å…ˆæŒ‰å®˜æ–¹å…¥å£æ–‡ä»¶å¯åŠ¨ä¸”æ˜¯åŽå°è¿è¡Œ rabbitmqctl -n "$RABBITMQ_NODENAME@$RABBITMQ_HOSTNAME" stop_app # åœæ­¢åº”ç”¨ rabbitmqctl -n "$RABBITMQ_NODENAME@$RABBITMQ_HOSTNAME" join_cluster $&#123;RMQHA_RAM_NODE:+--ram&#125; "$RMQHA_MASTER_NODE@$RMQHA_MASTER_HOST" # åŠ å…¥rmqha_node0é›†ç¾¤ rabbitmqctl -n "$RABBITMQ_NODENAME@$RABBITMQ_HOSTNAME" start_app # å¯åŠ¨åº”ç”¨ rabbitmqctl stop # åœæ­¢æ‰€æœ‰æœåŠ¡ touch /root/is_not_first_time sleep 2s exec "$@"fi HAProxyé…ç½®è¿™é‡ŒHAProxyå®¹å™¨ä¹Ÿæ˜¯ä½¿ç”¨Dockerå®˜æ–¹é•œåƒç”Ÿæˆçš„ï¼Œå¯åŠ¨å‰éœ€è¦å…ˆå‡†å¤‡é…ç½®æ–‡ä»¶ã€‚volumes/rmqha_proxy/haproxy.cfg 12345678910111213141516171819202122232425262728293031323334353637383940global log 127.0.0.1 local0 maxconn 4096defaults log global mode tcp option tcplog retries 3 option redispatch maxconn 2000 timeout connect 5000 timeout client 50000 timeout server 50000# ssl for rabbitmq# frontend ssl_rabbitmq # bind *:5673 ssl crt /root/rmqha_proxy/rmqha.pem # mode tcp # default_backend rabbitmqlisten stats bind *:1080 # haproxyå®¹å™¨1080ç«¯å£æ˜¾ç¤ºä»£ç†ç»Ÿè®¡é¡µé¢ï¼Œæ˜ å°„åˆ°å®¿ä¸»51080ç«¯å£ mode http stats enable stats hide-version stats realm Haproxy\ Statistics stats uri / stats auth admin:adminlisten rabbitmq bind *:5672 # haproxyå®¹å™¨5672ç«¯å£ä»£ç†å¤šä¸ªrabbitmqæœåŠ¡ï¼Œæ˜ å°„åˆ°å®¿ä¸»56729ç«¯å£ mode tcp balance roundrobin timeout client 1h timeout server 1h option clitcpka # server rmqha_node0 rmqha_node0:5672 check inter 5s rise 2 fall 3 server rmqha_node1 rmqha_node1:5672 check inter 5s rise 2 fall 3 server rmqha_node2 rmqha_node2:5672 check inter 5s rise 2 fall 3 å®žé™…è¿è¡Œåœ¨ä¸»ç›®å½•ä¸‹æ‰§è¡Œdocker-compose up -dæž„å»ºå¹¶è¿è¡Œæ•´ä¸ªDockeræœåŠ¡ã€‚ é•œåƒé˜Ÿåˆ—ï¼Œåœ¨ä¸»ç›®å½•ä¸‹æ‰§è¡Œï¼š 1$ sh ./scripts/rmqha_set_policy.sh å®žé™…ä¸Šæ˜¯æ‰§è¡Œäº†ï¼š 1$ docker exec -it rmqha_node0 rabbitmqctl set_policy ha-all &apos;^&apos; &apos;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&apos; å³åœ¨rmqha_node0é›†ç¾¤ä¸­å°†æ‰€æœ‰é˜Ÿåˆ—è®¾ç½®ä¸ºé•œåƒé˜Ÿåˆ—ï¼Œè¿™ä¸ªå‘½ä»¤åªéœ€æ‰§è¡Œä¸€æ¬¡ï¼Œé™¤éžé‡æ–°æž„å»ºæ•´ä¸ªDockeræœåŠ¡ã€‚ æµ‹è¯•ç”¨ä¸¤ä¸ªPHPè„šæœ¬å¯ä»¥å¯¹RabbitMQè¿›è¡Œç®€å•çš„æµ‹è¯•ï¼Œä¸è¿‡éœ€è¦ç”¨åˆ°php-amqplibåº“ã€‚ 1$ composer require php-amqplib/php-amqplib å‘é€æ¶ˆæ¯è„šæœ¬ï¼š 123456789101112131415161718&lt;?php// send.phprequire_once __DIR__ . '/vendor/autoload.php';use PhpAmqpLib\Connection\AMQPStreamConnection;use PhpAmqpLib\Message\AMQPMessage;$connection = new AMQPStreamConnection('127.0.0.1', 56729, 'guest', 'guest', '/'); // è¿žæŽ¥rmqha_proxy$channel = $connection-&gt;channel();$channel-&gt;queue_declare('task_queue', false, true, false, false);$data = "Hello World!";$msg = new AMQPMessage($data, array('delivery_mode' =&gt; AMQPMessage::DELIVERY_MODE_PERSISTENT));$channel-&gt;basic_publish($msg, '', 'task_queue');echo " [x] Sent ", $data, "\n";$channel-&gt;close();$connection-&gt;close(); æŽ¥å—æ¶ˆæ¯è„šæœ¬ï¼š 1234567891011121314151617181920212223&lt;?php// receive.phprequire_once __DIR__ . '/vendor/autoload.php';use PhpAmqpLib\Connection\AMQPStreamConnection;$connection = new AMQPStreamConnection('127.0.0.1', 56720, 'guest', 'guest', '/'); // è¿žæŽ¥rmqha_node0$channel = $connection-&gt;channel();$channel-&gt;queue_declare('task_queue', false, true, false, false);echo ' [*] Waiting for messages. To exit press CTRL+C', "\n";$callback = function ($msg) &#123; echo " [x] Received ", $msg-&gt;body, "\n"; sleep(1); echo " [x] Done", "\n"; $msg-&gt;delivery_info['channel']-&gt;basic_ack($msg-&gt;delivery_info['delivery_tag']);&#125;;$channel-&gt;basic_qos(null, 1, null);$channel-&gt;basic_consume('task_queue', '', false, false, false, false, $callback);while (count($channel-&gt;callbacks)) &#123; $channel-&gt;wait();&#125;$channel-&gt;close();$connection-&gt;close(); SSLè®¾ç½®ä¸ºäº†RabbitMQæœåŠ¡åœ¨ç½‘ç»œä¼ è¾“ä¸­ä¸æ³„æ¼ä¿¡æ¯ï¼Œå¯ä»¥ç»™HAProxyè®¾ç½®SSLä¼ è¾“ï¼ˆæ¯”å¯¹å„ä¸ªRabbitMQæœåŠ¡è®¾ç½®SSLä¼ è¾“çš„æ€§èƒ½æ¶ˆè€—è¦å°ï¼‰ï¼Œè¿™é‡Œç®€å•çš„ä»‹ç»ä¸€ä¸‹è‡ªç­¾è¯ä¹¦ï¼š 12345$ cd ./volumes/rmqha_proxy/$ openssl genrsa -out rmqha.key 1024 # éšæœºç”Ÿæˆä¸€ä¸ªç§é’¥$ openssl req -new -key rmqha.key -out rmqha.csr # æ ¹æ®ç§é’¥ç”Ÿæˆè¯ä¹¦ç­¾ç½²è¯·æ±‚$ openssl x509 -req -days 365 -in rmqha.csr -signkey rmqha.key -out rmqha.crt # è‡ªå·±ç­¾ç½²è¯ä¹¦$ cat rmqha.crt rmqha.key|tee rmqha.pem # å°†ç§é’¥å’Œè¯ä¹¦åˆå¹¶åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ æ³¨æ„ï¼šç”Ÿæˆè¯ä¹¦ç­¾ç½²è¯·æ±‚æ—¶ï¼Œéœ€è¦å¡«å†™ä¸€äº›ä¿¡æ¯ï¼ŒCommon Name (eg, fully qualified host name)åº”è¯¥å†™127.0.0.1ã€‚HAProxyé…ç½®ä¸­æ·»åŠ ï¼š 12345# ssl for rabbitmqfrontend ssl_rabbitmq bind *:5673 ssl crt /root/rmqha_proxy/rmqha.pem # haproxyå®¹å™¨5673ç«¯å£ä»£ç†rabbitmqæœåŠ¡ï¼Œéœ€è¦æ˜ å°„åˆ°å®¿ä¸»ç«¯å£ mode tcp default_backend rabbitmq PHPä¸­é€šè¿‡SSLè¿žæŽ¥HAProxyä»£ç†æœåŠ¡ç¤ºä¾‹ï¼š 12345&lt;?phprequire_once __DIR__ . '/vendor/autoload.php';use PhpAmqpLib\Connection\AMQPSSLConnection;$connection = new AMQPSSLConnection('127.0.0.1', 56730, 'guest', 'guest', '/', ['cafile'=&gt;'./rmqha.crt']); // å‡è®¾SSLçš„ç›‘å¬ç«¯å£æ˜¯56730ï¼Œrmqha.crtæ˜¯ä¸Šé¢ç”Ÿæˆçš„è‡ªç­¾è¯ä¹¦$channel = $connection-&gt;channel(); æœ€åŽå»ºè®® æ¶ˆæ¯ç”Ÿäº§è€…å¯ä»¥é€šè¿‡HAProxyä»£ç†è¿žæŽ¥RabbitMQæœåŠ¡ï¼Œå®žçŽ°è´Ÿè½½å‡è¡¡ï¼› æ¶ˆæ¯å¤„ç†è€…åº”è¯¥ç›´æŽ¥è¿žæŽ¥RabbitMQæœåŠ¡ä¸»æœºï¼Œå¹¶ä¸”è·ŸéšRabbitMQæœåŠ¡ä¸»æœºå¯åŠ¨æœåŠ¡ã€åœæ­¢æœåŠ¡ã€‚ æ‰©å±•é˜…è¯» Rabbitmqé«˜å¯ç”¨-é•œåƒé˜Ÿåˆ—æ¨¡å¼ Rabbitmqé›†ç¾¤é«˜å¯ç”¨æµ‹è¯•]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>practice</tag>
        <tag>docker</tag>
        <tag>rabbitmq</tag>
        <tag>haproxy</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JSå®žçŽ°äººè„¸æ¢å¦†å’Œé¡µé¢æˆªå›¾]]></title>
    <url>%2Fblog%2Fpractice-js-face-makeup-and-html2canvas.html</url>
    <content type="text"><![CDATA[æœ€è¿‘è¦åšä¸€ä¸ªH5æ´»åŠ¨é¡µé¢ï¼Œå¤§æ¦‚åŠŸèƒ½æ˜¯ç»™å›¾ç‰‡äººè„¸æ¢å¦†ï¼Œè‡ªç„¶ä¹Ÿå°‘ä¸äº†ä¸Šä¼ åŽŸå§‹å›¾ç‰‡å’Œå¯¼å‡ºæœ€ç»ˆå›¾ç‰‡ç­‰åŠŸèƒ½ã€‚å¦‚æžœå›¾ç‰‡åŠ å·¥ï¼ˆå³äººè„¸æ¢å¦†ï¼‰æ”¾åœ¨æœåŠ¡å™¨å¤„ç†ï¼Œé‚£ä¹ˆå¹¶å‘é‡é«˜çš„æ—¶å€™ï¼Œè‚¯å®šäº§ç”Ÿå¤§é‡é˜»å¡žã€‚äºŽæ˜¯æƒ³æŠŠå›¾ç‰‡åŠ å·¥æ”¾åœ¨å®¢æˆ·ç«¯å¤„ç†ï¼Œç”¨HTMLå †ç Œå‡ºå›¾ç‰‡çš„æœ€ç»ˆæ•ˆæžœï¼Œä½†æ˜¯æ€Žæ ·æŠŠHTMLå¯¼å‡ºæˆå›¾ç‰‡å‘¢ï¼Ÿ å›¾ç‰‡ä¸Šä¼ å›¾ç‰‡ä¸Šä¼ å¯ä»¥å‚è€ƒHTTPæ–‡ä»¶ä¸Šä¼ çš„ä¸€ä¸ªåŽç«¯å®Œå–„æ–¹æ¡ˆï¼ˆNginXï¼‰ï¼Œæˆ–è€…ä½¿ç”¨çŽ°æœ‰çš„äº‘å­˜å‚¨æœåŠ¡ï¼Œå¦‚ä¸ƒç‰›ç­‰ç­‰ã€‚ äº”å®˜å®šä½äººè„¸è¯†åˆ«å’Œäº”å®˜å®šä½å¯ä»¥åˆ©ç”¨OpenVCè‡ªè¡Œå®žçŽ°ï¼Œæˆ–è€…ä½¿ç”¨æˆç†Ÿçš„äº‘è¯†åˆ«æœåŠ¡ï¼Œå¦‚Face++ç­‰ç­‰ã€‚è¿™é‡Œä½¿ç”¨è…¾è®¯äº‘çš„äººè„¸è¯†åˆ«æœåŠ¡ã€‚ äººè„¸æ¢å¦†å‡è®¾æœ‰ä¸€å¼ å›¾ç‰‡ï¼Œè¯†åˆ«ç»“æžœå¦‚ä¸‹ï¼š å›¾ç‰‡æ¥æºï¼šä¸‡è±¡ä¼˜å›¾-è…¾è®¯äº‘ æ ¹æ®äº”å®˜å®šä½ç‚¹ï¼Œåœ¨é€‚å½“ä½ç½®ç»™äººè„¸æ·»ä¸Šå¦†é¥°ï¼Œæ¯”å¦‚å°èƒ¡å­ï¼š æºç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;Demo&lt;/title&gt;&lt;/head&gt;&lt;body style="padding: 0; margin: 0;"&gt; &lt;div style="width: 100%; text-align: center;"&gt; &lt;div style="width: 336px; margin-left: auto; margin-right: auto; position: relative;" id="div1"&gt; &lt;img src="./face.png" style="width: 100%;" id="face" /&gt; &lt;/div&gt; &lt;/div&gt; &lt;script type="text/javascript"&gt; var FACE = &#123; "session_id":"", "face_shape":[ &#123; "face_profile":[&#123;"x":49,"y":231&#125;,&#123;"x":59,"y":249&#125;,&#123;"x":71,"y":267&#125;,&#123;"x":84,"y":284&#125;,&#123;"x":100,"y":298&#125;,&#123;"x":118,"y":310&#125;,&#123;"x":138,"y":318&#125;,&#123;"x":158,"y":324&#125;,&#123;"x":178,"y":329&#125;,&#123;"x":198,"y":329&#125;,&#123;"x":217,"y":323&#125;,&#123;"x":232,"y":309&#125;,&#123;"x":239,"y":291&#125;,&#123;"x":244,"y":271&#125;,&#123;"x":249,"y":252&#125;,&#123;"x":252,"y":232&#125;,&#123;"x":253,"y":213&#125;,&#123;"x":251,"y":194&#125;,&#123;"x":247,"y":175&#125;,&#123;"x":240,"y":157&#125;,&#123;"x":232,"y":142&#125;], "left_eye":[&#123;"x":89,"y":209&#125;,&#123;"x":100,"y":210&#125;,&#123;"x":110,"y":207&#125;,&#123;"x":120,"y":202&#125;,&#123;"x":128,"y":196&#125;,&#123;"x":117,"y":190&#125;,&#123;"x":105,"y":191&#125;,&#123;"x":95,"y":198&#125;], "right_eye":[&#123;"x":209,"y":153&#125;,&#123;"x":204,"y":161&#125;,&#123;"x":196,"y":167&#125;,&#123;"x":186,"y":170&#125;,&#123;"x":176,"y":172&#125;,&#123;"x":179,"y":161&#125;,&#123;"x":187,"y":154&#125;,&#123;"x":198,"y":150&#125;], "left_eyebrow":[&#123;"x":58,"y":190&#125;,&#123;"x":72,"y":180&#125;,&#123;"x":89,"y":175&#125;,&#123;"x":106,"y":172&#125;,&#123;"x":122,"y":167&#125;,&#123;"x":105,"y":161&#125;,&#123;"x":86,"y":165&#125;,&#123;"x":68,"y":174&#125;], "right_eyebrow":[&#123;"x":214,"y":120&#125;,&#123;"x":200,"y":125&#125;,&#123;"x":187,"y":133&#125;,&#123;"x":175,"y":143&#125;,&#123;"x":162,"y":150&#125;,&#123;"x":169,"y":135&#125;,&#123;"x":182,"y":123&#125;,&#123;"x":198,"y":115&#125;], "mouth":[&#123;"x":149,"y":279&#125;,&#123;"x":165,"y":290&#125;,&#123;"x":184,"y":294&#125;,&#123;"x":202,"y":289&#125;,&#123;"x":215,"y":276&#125;,&#123;"x":219,"y":258&#125;,&#123;"x":219,"y":239&#125;,&#123;"x":208,"y":241&#125;,&#123;"x":196,"y":246&#125;,&#123;"x":189,"y":253&#125;,&#123;"x":178,"y":256&#125;,&#123;"x":163,"y":266&#125;,&#123;"x":165,"y":282&#125;,&#123;"x":181,"y":281&#125;,&#123;"x":197,"y":277&#125;,&#123;"x":207,"y":266&#125;,&#123;"x":214,"y":254&#125;,&#123;"x":209,"y":245&#125;,&#123;"x":200,"y":252&#125;,&#123;"x":191,"y":258&#125;,&#123;"x":177,"y":266&#125;,&#123;"x":163,"y":273&#125;], "nose":[&#123;"x":180,"y":231&#125;,&#123;"x":155,"y":187&#125;,&#123;"x":154,"y":201&#125;,&#123;"x":154,"y":216&#125;,&#123;"x":153,"y":230&#125;,&#123;"x":152,"y":247&#125;,&#123;"x":170,"y":248&#125;,&#123;"x":186,"y":245&#125;,&#123;"x":196,"y":235&#125;,&#123;"x":203,"y":219&#125;,&#123;"x":190,"y":211&#125;,&#123;"x":178,"y":203&#125;,&#123;"x":167,"y":195&#125;] &#125; ], "image_height":430, "image_width":336 &#125;; // äººè„¸è¯†åˆ«ç»“æžœ var BEARD = &#123; "src":"./beard.png", "image_height":222, "image_width":567 &#125;; // èƒ¡å­å›¾ç‰‡ä¿¡æ¯ function parseEyesData(leye, reye)&#123; var lx = ly = 0; var rx = ry = 0; for(var i in leye) &#123; lx += leye[i]['x']; ly += leye[i]['y']; &#125; lx = lx/leye.length; ly = ly/leye.length; for(var i in reye) &#123; rx += reye[i]['x']; ry += reye[i]['y']; &#125; rx = rx/leye.length; ry = ry/leye.length; return &#123; angle: Math.atan((ly-ry)/(lx-rx))/Math.PI*(180), span: Math.sqrt(Math.pow(lx-rx, 2)+Math.pow(ly-ry, 2)) &#125; &#125; // æ ¹æ®çœ¼ç›æ•°æ®ï¼ŒèŽ·å–è„¸å€¾è§’å’Œçœ¼å¿ƒè· var div1 = document.getElementById('div1'); var edata = parseEyesData(FACE['face_shape'][0]['left_eye'], FACE['face_shape'][0]['right_eye']); var beard = document.createElement('img'); var scale = div1.offsetWidth/FACE['image_width']; var point1 = FACE['face_shape'][0]['nose'][0]; // é¼»å°– var point2 = FACE['face_shape'][0]['nose'][7]; // é¼»ä½Ž var point3 = FACE['face_shape'][0]['mouth'][9]; //ä¸Šå”‡ä¸Šä¸­ç‚¹ var beardx = ((point1['x']+point2['x'])/2+point3['x'])/2*scale; // å¤§æ¦‚ç®—å‡ºäººä¸­Xåæ ‡ var beardy = ((point1['y']+point2['y'])/2+point3['y'])/2*scale; // å¤§æ¦‚ç®—å‡ºäººä¸­Yåæ ‡ var beardw = edata['span']*scale; // èƒ¡å­é•¿åº¦å–çœ¼å¿ƒè·å€¼ beard.width = beardw; beard.src = './beard.png'; beard.style.transform = 'rotate('+edata['angle']+'deg)'; beard.style.position = 'absolute'; beard.style.top = (beardy-beardw/2/(BEARD['image_width']/BEARD['image_height']))+'px'; beard.style.left = (beardx-beardw/2)+'px'; div1.appendChild(beard); &lt;/script&gt;&lt;/body&gt;&lt;/html&gt; æœ€ç»ˆæ•ˆæžœï¼š è¿™åªæ˜¯HTMLï¼Œæ€Žæ ·ä¿å­˜æˆå›¾ç‰‡å‘¢ï¼Ÿ å¯¼å‡ºå›¾ç‰‡æŠŠHTMLä¿å­˜æˆå›¾ç‰‡ï¼Œåœ¨æœåŠ¡å™¨ä¸Šå¯ä»¥ç”¨PhantomJSå®žçŽ°ï¼Œåœ¨æµè§ˆå™¨ä¸Šå‘¢ï¼Ÿå…¶å®žä¹Ÿæ˜¯å¯ä»¥å®žçŽ°çš„ï¼Œé¦–å…ˆå°†HTMLï¼ˆDOMç»“æž„ï¼‰å†™å…¥Canvasï¼ŒCanvaså†å¯¼å‡ºDataURLï¼Œæœ€åŽDataURLèµ‹äºˆimgæ ‡ç­¾çš„srcå±žæ€§ï¼Œä¾¿å¾—åˆ°æœ€ç»ˆå›¾ç‰‡ï¼Œè¯¦æƒ…è¯·é˜…è¯»Drawing DOM objects into a canvasã€‚ è¿™é‡Œä½¿ç”¨æ’ä»¶html2canvasæ¥å®žçŽ°HTMLå†™å…¥CanvasåŠŸèƒ½ï¼Œç±»ä¼¼çš„æ’ä»¶è¿˜æœ‰rasterizeHTML.jsç­‰ç­‰ã€‚ æºç ï¼š 12345678910111213141516171819202122232425262728293031323334353637&lt;script type="text/javascript" src="./html2canvas.min.js"&gt;&lt;/script&gt;&lt;script type="text/javascript"&gt; ... var can1 = document.createElement('canvas'); var img1 = document.createElement('img'); var ctxt = can1.getContext('2d'); var level = 2; can1.width = document.body.offsetWidth*level; can1.height = div1.offsetHeight*level; can1.style.width = can1.width + 'px'; can1.style.height = can1.height + 'px'; ctxt.scale(level, level); // ä½¿ç”¨ä¸¤å€å›¾ï¼Œä¿æŒæ¸…æ™°åº¦ setTimeout(function () &#123; html2canvas(div1, &#123;canvas:can1&#125;).then(function(can1) &#123; var can2 = document.createElement('canvas'); var face = document.getElementById('face'); var ctxt = can1.getContext('2d'); var level = 2; can2.width = face.offsetWidth*level; can2.height = face.offsetHeight*level; can2.style.width = face.offsetWidth + 'px'; can2.style.height = face.offsetWidth + 'px'; ctxt.scale(level, level); can2.getContext('2d').drawImage(can1, div1.offsetLeft*level, 0, face.offsetWidth*level, face.offsetHeight*level, 0, 0, face.offsetWidth*level, face.offsetHeight*level ); // ä½¿ç”¨can2æ˜¯ä¸ºäº†è£æŽ‰ä¸Žäººè„¸å›¾ç‰‡æ— å…³çš„è¾¹ç¼˜ var data = can2.toDataURL(); img1.src = data; document.body.appendChild(img1); // æŠŠå›¾ç‰‡æ”¾å…¥å½“å‰é¡µé¢ä¸­ can2 = null; can1 = null; &#125;); &#125;, 2000); // éœ€è¦ç­‰å¾…äººè„¸å›¾ç‰‡åŠ è½½å®Œæˆå†æ‰§è¡Œ&lt;/script&gt; åœ¨PCç«¯å¯ä»¥ç”¨aæ ‡ç­¾ä¸‹è½½å›¾ç‰‡ï¼Œhrefå±žæ€§å€¼åº”è¯¥æ˜¯canvaså¯¼å‡ºçš„DataURLï¼š 1&lt;a href="DataURL" download="æœ€ç»ˆæ•ˆæžœ" id="a1"&gt;ä¸‹è½½&lt;/a&gt; åœ¨ç§»åŠ¨ç«¯åˆ™éœ€è¦æ˜¾ç¤ºå›¾ç‰‡ï¼Œå¹¶å¼•å¯¼ç”¨æˆ·é•¿æŒ‰ä¿å­˜å›¾ç‰‡ã€‚ æœ€åŽæ³¨æ„ï¼šå¦‚æžœæœ€ç»ˆå›¾ç‰‡æœªèƒ½å†™å…¥canvasï¼Œå¯èƒ½æ˜¯å›¾ç‰‡è·¨åŸŸé—®é¢˜ï¼Œæˆ–è€…å›¾ç‰‡æœªåŠ è½½å®Œå°±å¼€å§‹å†™äº†ã€‚å¦å¤–ï¼šå¯ä»¥åˆ†æžå›¾ç‰‡äººè„¸çš„è¡¨æƒ…ã€å§¿æ€ã€å¹´çºªã€å¿ƒæƒ…ç­‰å±žæ€§ï¼Œæ­é…æ›´åˆé€‚çš„å¦†é¥°ï¼Œæ•ˆæžœæ›´ä½³ï¼›åŽŸå§‹å›¾ç‰‡ä¸Žå¦†é¥°å›¾ç‰‡å¯èƒ½ä¼šæœ‰è‰²è°ƒã€åˆ†è¾¨çŽ‡ç­‰ä¸ç›¸é…çš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨CSS3æ»¤é•œè°ƒæ•´ï¼Œä½¿å¾—æœ€ç»ˆç”»é¢æ›´èžæ´½ã€‚]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>practice</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”¨Dockeræ­å»ºMySQL MHAé«˜å¯ç”¨é›†ç¾¤]]></title>
    <url>%2Fblog%2Fpractice-mysql-mha-docker-compose.html</url>
    <content type="text"><![CDATA[MySQL MHAï¼ˆMaster High Availabilityï¼‰æ˜¯ç›®å‰ç›¸å¯¹æˆç†Ÿçš„ä¸€ä¸ªMySQLé«˜å¯ç”¨è§£å†³æ–¹æ¡ˆã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»ç”¨Docker Composeç¼–æŽ’MySQL MHAé«˜å¯ç”¨é›†ç¾¤çš„å®žè·µè¿‡ç¨‹ã€‚Docker Composeç¼–æŽ’ä¸­ä½¿ç”¨äº†ä¸¤ä¸ªçŽ°æœ‰é•œåƒï¼Œåˆ†åˆ«æ˜¯breeze2/mha4mysql-managerå’Œbreeze2/mha4mysql-nodeï¼Œè¿™ä¸¤ä¸ªé•œåƒçš„ç›¸å…³ä¿¡æ¯å¯ä»¥æŸ¥çœ‹ã€Šåˆ¶ä½œmha4mysqlçš„Dockeré•œåƒã€‹ã€‚æœ¬æ¬¡å®žè·µæºç ä¸Šä¼ åœ¨GitHubçš„breeze2/mysql-mha-dockerã€‚ Docker Composeç¼–æŽ’è¿™ä¸ªç¼–æŽ’ä¸»è¦å®žçŽ°ä¸€ä¸»ä¸€å¤‡ä¸€ä»Žçš„MySQL MHAé«˜å¯ç”¨é›†ç¾¤ã€‚ ç›®å½•ç»“æž„123456789101112131415L--mysql-mha-docker //ä¸»ç›®å½• L--scripts //æœ¬åœ°ï¼ˆDockerå®¿ä¸»ï¼‰ä½¿ç”¨çš„ä¸€äº›è„šæœ¬ L--mha_check_repl.sh L--... L--services //éœ€è¦buildçš„æœåŠ¡ï¼ˆç›®å‰æ˜¯ç©ºï¼‰ L--volumes //å„ä¸ªå®¹å™¨çš„æŒ‚è½½æ•°æ®å· L--mha_manager L--mha_node0 L--mha_node1 L--mha_node2 L--mha_share //å„ä¸ªå®¹å™¨å…±äº«çš„ç›®å½• L--scripts //å„ä¸ªå®¹å™¨å…±ç”¨çš„ä¸€äº›è„šæœ¬ L--sshkeys //å„ä¸ªå®¹å™¨çš„ssh public key L--parameters.env //è´¦å·å¯†ç ç­‰çŽ¯å¢ƒå‚æ•° L--docker-compose.yml //ç¼–æŽ’é…ç½® docker-compose.yml12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091version: "2"services: master: image: breeze2/mha4mysql-node:0.57 container_name: mha_node0 restart: always mem_limit: 256m networks: net1: ipv4_address: 10.5.0.10 ports: - "33060:3306" volumes: - "./volumes/mha_share/:/root/mha_share/" - "./volumes/mha_node0/lib/:/var/lib/mysql/" - "./volumes/mha_node0/conf/:/etc/mysql/conf.d/" env_file: - ./parameters.env environment: - CONTAINER_NAME=mha_node0 slave1: image: breeze2/mha4mysql-node:0.57 container_name: mha_node1 restart: always depends_on: - master mem_limit: 256m networks: net1: ipv4_address: 10.5.0.11 ports: - "33061:3306" volumes: - "./volumes/mha_share/:/root/mha_share/" - "./volumes/mha_node1/lib/:/var/lib/mysql/" - "./volumes/mha_node1/conf/:/etc/mysql/conf.d/" env_file: - ./parameters.env environment: - CONTAINER_NAME=mha_node1 slave2: image: breeze2/mha4mysql-node:0.57 container_name: mha_node2 depends_on: - master restart: always mem_limit: 256m networks: net1: ipv4_address: 10.5.0.12 ports: - "33062:3306" volumes: - "./volumes/mha_share/:/root/mha_share/" - "./volumes/mha_node2/lib/:/var/lib/mysql/" - "./volumes/mha_node2/conf/:/etc/mysql/conf.d/" env_file: - ./parameters.env environment: - CONTAINER_NAME=mha_node2 manager: image: breeze2/mha4mysql-manager:0.57 container_name: mha_manager depends_on: - master - slave1 - slave2 restart: always mem_limit: 256m networks: net1: ipv4_address: 10.5.0.9 volumes: - "./volumes/mha_share/:/root/mha_share/" - "./volumes/mha_manager/conf:/etc/mha" - "./volumes/mha_manager/work:/usr/local/mha" entrypoint: "tailf /dev/null" env_file: - ./parameters.env environment: - CONTAINER_NAME=mha_managernetworks: net1: driver: bridge ipam: config: - subnet: 10.5.0.0/16 gateway: 10.5.0.1 è¿™é‡Œé…ç½®äº†å››ä¸ªå®¹å™¨æœåŠ¡ï¼Œä¸€ä¸ªbreeze2/mha4mysql-managerï¼Œè´Ÿè´£ç®¡ç†å„ä¸ªæ•°æ®åº“ç»“ç‚¹ï¼›ä¸‰ä¸ªbreeze2/mha4mysql-nodeï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ä¸»åº“ï¼Œä¸€ä¸ªæ˜¯å¤‡ç”¨ä¸»åº“ï¼ˆå…¼ä½œä»Žåº“ï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯ï¼ˆçº¯ï¼‰ä»Žåº“ã€‚æ¯ä¸ªå®¹å™¨æœåŠ¡éƒ½æŒ‡å®šäº†é™æ€IPï¼Œå³ä½¿æœåŠ¡é‡å¯ä¹Ÿä¸ä¼šå‡ºçŽ°IPé”™ä¹±é—®é¢˜ã€‚ çŽ¯å¢ƒå‚æ•°parameters.env 1234567ROOT_PASSWORD=123456MYSQL_ROOT_PASSWORD=123456MYSQL_DATABASE=testingMYSQL_User=testingMYSQL_PASSWORD=testingMHA_SHARE_SCRIPTS_PATH=/root/mha_share/scriptsMHA_SHARE_SSHKEYS_PATH=/root/mha_share/sshkeys æ•°æ®åº“é…ç½®è¿™é‡Œç®€å•çš„é…ç½®ä¸€ä¸‹å„ä¸ªæ•°æ®åº“æ•°æ®å¤åˆ¶å¤‡ä»½ç›¸å…³çš„å‚æ•°ä¸»åº“ï¼Œmha_node0/conf/my.cnf 12345678910[mysqld]server-id=1log-bin=mysql-binbinlog-do-db=testingbinlog-ignore-db=mysqlreplicate-do-db=testingreplicate-ignore-db=mysqlauto_increment_increment=2auto_increment_offset=1expire_logs_days=7 å¤‡åº“ï¼Œmha_node1/conf/my.cnf 12345678910[mysqld]server-id=2log-bin=mysql-binbinlog-do-db=testingbinlog-ignore-db=mysqlreplicate-do-db=testingreplicate-ignore-db=mysqlauto_increment_increment=2auto_increment_offset=2expire_logs_days=7 ä»Žåº“ï¼Œmha_node2/conf/my.cnf 12345[mysqld]server-id=3replicate-do-db=testingreplicate-ignore-db=mysqlexpire_logs_days=7 MHAé…ç½®manager/conf/app1.conf 12345678910111213141516171819[server default]user=rootpassword=123456ssh_user=rootmanager_workdir=/usr/local/mharemote_workdir=/usr/local/mharepl_user=myslaverepl_password=myslave[server0]hostname=10.5.0.10[server1]hostname=10.5.0.11[server2]hostname=10.5.0.12 å®žé™…è¿è¡Œåœ¨ä¸»ç›®å½•ä¸‹æ‰§è¡Œdocker-compose up -dæž„å»ºå¹¶è¿è¡Œæ•´ä¸ªDockeræœåŠ¡ã€‚ SSHè®¾ç½®MHAè¦æ±‚å„ä¸ªä¸»æœºèƒ½å¤Ÿç›¸äº’SSHç™»å½•ï¼Œæ‰€ä»¥æ•´ä½“æœåŠ¡é¦–æ¬¡å¯åŠ¨æˆåŠŸåŽï¼Œåœ¨ä¸»ç›®å½•ä¸‹å…ˆæ‰§è¡Œä¸€äº›å‘½ä»¤ï¼š 12$ sh ./scripts/ssh_start.sh$ sh ./scripts/ssh_share.sh ssh_start.shä½œç”¨æ˜¯åœ¨å„ä¸ªå®¹å™¨ä¸Šå¼€å¯SSHæœåŠ¡ï¼Œssh_share.shä½œç”¨æ˜¯åœ¨å®¹å™¨å†…ç”ŸæˆSSHå…¬å¯†é’¥ï¼Œå†æŠŠå…¬é’¥å…±äº«åˆ°å…¶ä»–å®¹å™¨ã€‚å¸¸ç”¨å‘½ä»¤è°ƒç”¨çš„è„šæœ¬åœ¨scriptså’Œvolumes/mha_share/scriptsä¸‹ï¼Œè¿™äº›è„šæœ¬éƒ½å¾ˆç®€å•ï¼Œä¸€çœ‹å°±æ˜Žã€‚è‹¥æ˜¯æ•´ä½“æœåŠ¡é‡æ–°å¯åŠ¨ï¼Œåªéœ€é‡æ–°å¼€å¯SSHæœåŠ¡å³å¯ï¼š 1$ sh ./scripts/ssh_start.sh åœ¨managerå®¹å™¨ä¸Šæ£€æµ‹SSHæ˜¯å¦é…ç½®æˆåŠŸï¼š 12$ docker exec -it mha_manager /bin/bashroot@mha_manager# masterha_check_ssh --conf=/etc/mha/app1.conf è‹¥æ˜¯æˆåŠŸï¼Œä¼šæ˜¾ç¤º 12Mon Oct 16 14:53:59 2017 - [debug] ok.Mon Oct 16 14:53:59 2017 - [info] All SSH connection tests passed successfully. å¼€å¯æ•°æ®ä¸»ä»Žå¤åˆ¶é¦–å…ˆå¯¹ä¸»åº“ã€å¤‡è€ƒåˆ›å»ºå’ŒæŽˆæƒå¤åˆ¶è´¦å·ï¼Œå¯¹å¤‡åº“ã€ä»Žåº“è®¾ç½®ä¸»åº“ä¿¡æ¯å’Œå¼€å§‹å¤åˆ¶ï¼Œä»¥ä¸‹å‘½ä»¤ä¼šå®Œæˆè¿™äº›æ“ä½œï¼š 1$ sh ./scripts/mysql_set_mbs.sh å¯ä»¥åœ¨ä¸»åº“ä¸Šçš„testingæ•°æ®åº“é‡Œåˆ›å»ºä¸€å¼ è¡¨ï¼Œå†™å…¥ä¸€äº›æ•°æ®ï¼Œçœ‹çœ‹å¤‡åº“ã€ä»Žåº“ä¼šä¸ä¼šåŒæ­¥ã€‚ åœ¨managerå®¹å™¨ä¸Šæ£€æµ‹REPLæ˜¯å¦é…ç½®æˆåŠŸï¼š 12$ docker exec -it mha_manager /bin/bashroot@mha_manager# masterha_check_repl --conf=/etc/mha/app1.conf è‹¥æ˜¯æˆåŠŸï¼Œä¼šæ˜¾ç¤º 123Mon Oct 16 15:01:35 2017 - [info] Got exit code 0 (Not master dead).MySQL Replication Health is OK. å¼€å¯MHAç›‘æŽ§SSHå’ŒREPLæ£€æµ‹æ²¡é—®é¢˜åŽï¼Œå¯ä»¥åœ¨managerå®¹å™¨ä¸Šå¼€å¯MHAç›‘æŽ§ï¼š 12$ docker exec -it mha_manager /bin/bashroot@mha_manager# masterha_manager --conf=/etc/mha/app1.conf masterha_managerè¿›ç¨‹ä¼šä¸€ç›´ç›‘è§†ä¸»åº“çŠ¶æ€æ˜¯å¦å¯ç”¨ï¼Œè‹¥æ˜¯ä¸»åº“å®•æœºï¼Œmasterha_managerä¼šå°†å¤‡åº“ä¸Žä»Žåº“çš„Relay Logè¿›è¡Œæ¯”è¾ƒï¼ŒæŠŠæœ€æ–°çš„æ•°æ®æ•´åˆåˆ°å¤‡åº“ï¼Œç„¶åŽæŠŠå¤‡åº“æå‡ä¸ºæ–°ä¸»åº“ï¼Œä»Žåº“è·Ÿéšå¤åˆ¶æ–°ä¸»åº“ï¼Œæœ€åŽmasterha_managerè¿›ç¨‹ä¼šé€€å‡ºï¼Œä¸å†ç›‘æŽ§ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°ï¼ˆDockerå®¿ä¸»ï¼‰æš‚åœä¸»åº“ï¼ˆmha_node0å®¹å™¨ï¼‰ï¼š 1$ docker pause mha_node0 ç„¶åŽï¼Œmanagerå®¹å™¨ä¸Šmasterha_managerç¡®è®¤ä¸»åº“å¤±è”åŽï¼Œå¼€å§‹åˆ‡æ¢ä¸»åº“ï¼ŒæˆåŠŸåŽä¼šæ˜¾ç¤ºï¼š 1234567891011121314151617----- Failover Report -----app1: MySQL Master failover 10.5.0.10(10.5.0.10:3306) to 10.5.0.11(10.5.0.11:3306) succeededMaster 10.5.0.10(10.5.0.10:3306) is down!Check MHA Manager logs at 3d2d8185510b for details.Started automated(non-interactive) failover.The latest slave 10.5.0.11(10.5.0.11:3306) has all relay logs for recovery.Selected 10.5.0.11(10.5.0.11:3306) as a new master.10.5.0.11(10.5.0.11:3306): OK: Applying all logs succeeded.10.5.0.12(10.5.0.12:3306): This host has the latest relay log events.Generating relay diff files from the latest slave succeeded.10.5.0.12(10.5.0.12:3306): OK: Applying all logs succeeded. Slave started, replicating from 10.5.0.11(10.5.0.11:3306)10.5.0.11(10.5.0.11:3306): Resetting slave info succeeded.Master failover to 10.5.0.11(10.5.0.11:3306) completed successfully. å¯ä»¥åˆ°ä»Žåº“ï¼ˆmha_node2å®¹å™¨ï¼‰ï¼ŒæŸ¥çœ‹å¤åˆ¶çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°è·Ÿéšä¸»åº“æ˜¯10.5.0.11ï¼Œå³æ–°ä¸»åº“ï¼ˆåŽŸå¤‡åº“ï¼‰ï¼š 1234567$ docker exec -it mha_manager /bin/bashroot@mha_manager# mysql -u root -p$MYSQL_ROOT_PASSWORDmysql&gt; show slave status;*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 10.5.0.11 Master_User: myslave æœ€åŽåœ¨æ•°æ®åº“æœåŠ¡å™¨é›†ç¾¤ä¸­ï¼Œä½¿ç”¨MHAï¼Œå¯ä»¥åœ¨ä¸»åº“å®•æœºåŽå¿«é€Ÿåˆ‡æ¢æ–°ä¸»åº“ï¼Œå¯æ˜¯åº”ç”¨æœåŠ¡å™¨å¹¶ä¸çŸ¥é“ä¸»åº“å·²ç»è¢«åˆ‡æ¢ã€‚æ‰€ä»¥ï¼Œmasterha_managerè¿›ç¨‹åˆ‡æ¢ä¸»åº“æˆåŠŸåŽåº”è¯¥é€šçŸ¥åº”ç”¨æœåŠ¡å™¨æ–°çš„ä¸»åº“IPï¼Œæˆ–è€…ä½¿ç”¨è™šæ‹ŸIPé™é»˜è¿‡æ¸¡ã€‚è‹¥æ˜¯åº”ç”¨ä¸Žæ•°æ®åº“é€šè¿‡ä¸­é—´ä»¶ï¼ˆæ¯”å¦‚ProxySQLï¼‰æ¥è¿žæŽ¥çš„ï¼Œé‚£ä¹ˆåªéœ€åœ¨ä¸­é—´ä»¶ä¸Šä¿®æ”¹ä¸»åº“IPï¼Œå¯¹åº”ç”¨å½±å“ä¸å¤§ã€‚ æ³¨æ„ï¼šå› ä¸ºæœ¬composeä¸­MySQLæœåŠ¡ä¸ŽSSHæœåŠ¡æ²¡æœ‰åŒä¸€å¯åŠ¨ï¼ˆSSHæœåŠ¡æ˜¯å®¹å™¨å¯åŠ¨åŽæ‰å¼€å¯çš„ï¼‰ï¼Œæ‰€ä»¥æœ¬composeåªèƒ½å½“ä½œçº¿ä¸‹æ¨¡æ‹Ÿç»ƒä¹ ï¼Œæœªèƒ½åœ¨æ­£å¼çº¿ä¸Šåº”ç”¨ã€‚æ¯”å¦‚å…¶ä¸­æŸä¸ªç»“ç‚¹å®¹å™¨é‡å¯ï¼ŒSSHæœåŠ¡å¹¶æ²¡æœ‰è‡ªåŠ¨é‡å¯ï¼Œè¿›è€Œæ•´ä¸ªMHAé›†ç¾¤ä¸å¯ç”¨ã€‚]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>practice</tag>
        <tag>docker</tag>
        <tag>mha4mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆ¶ä½œmha4mysqlçš„Dockeré•œåƒ]]></title>
    <url>%2Fblog%2Fpractice-make-mha4mysql-docker-image.html</url>
    <content type="text"><![CDATA[æœ¬æ¥æƒ³è®°å½•ä¸€ä¸‹ç”¨Dockeræž„å»ºMySQL MHAé›†ç¾¤çš„å®žè·µè¿‡ç¨‹çš„ï¼Œä½†æ˜¯æ•´ä¸ªç¯‡å¹…æœ‰ç‚¹é•¿ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆæ¥ä»‹ç»ä¸€ä¸‹æ€Žæ ·åˆ¶ä½œmha4mysqlçš„Dockeré•œåƒã€‚ mha4mysqlæ˜¯æ—¥æœ¬å·¥ç¨‹å¸ˆYoshinori Matsunobuå¼€å‘çš„ä¸€æ¬¾MySQLé«˜å¯ç”¨è½¯ä»¶ã€‚mha4mysqlåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€æ˜¯ç®¡ç†å™¨éƒ¨åˆ†mha4mysql-managerï¼ŒäºŒæ˜¯ç»“ç‚¹éƒ¨åˆ†mha4mysql-nodeã€‚mha4mysql-nodeè¦è¿è¡Œåœ¨æ¯å°å—ç®¡ç†çš„MySQLæœåŠ¡å™¨ä¸Šï¼›è€Œmha4mysql-manageræ‰€åœ¨æœåŠ¡å™¨åˆ™ä¸éœ€è¦MySQLï¼Œä½†éœ€è¦mha4mysql-nodeã€‚å› ä¸ºmha4mysql-managerä¾èµ–mha4mysql-nodeï¼Œå³å®‰è£…mha4mysql-managerå‰å¿…é¡»å…ˆå®‰è£…mha4mysql-nodeã€‚ ä¸‹é¢è®²è§£ä¸€ä¸‹ï¼ŒåŸºäºŽdebian:jessieåˆ¶ä½œmha4mysql-managerçš„Dockeré•œåƒå’ŒåŸºäºŽmysql:5.7åˆ¶ä½œmha4mysql-nodeçš„Dockeré•œåƒã€‚ mha4mysql-managermha4mysql-managerçš„Dockerfile: 123456789101112131415161718192021FROM debian:jessieCOPY ./mha4mysql-manager.tar.gz /tmp/COPY ./mha4mysql-node.tar.gz /tmp/RUN build_deps='ssh sshpass perl libdbi-perl libmodule-install-perl libdbd-mysql-perl libconfig-tiny-perl liblog-dispatch-perl libparallel-forkmanager-perl make' \ &amp;&amp; apt-get update \ &amp;&amp; apt-get -y --force-yes install $build_deps \ &amp;&amp; tar -zxf /tmp/mha4mysql-node.tar.gz -C /opt \ &amp;&amp; cd /opt/mha4mysql-node \ &amp;&amp; perl Makefile.PL \ &amp;&amp; make \ &amp;&amp; make install \ &amp;&amp; tar -zxf /tmp/mha4mysql-manager.tar.gz -C /opt \ &amp;&amp; cd /opt/mha4mysql-manager \ &amp;&amp; perl Makefile.PL \ &amp;&amp; make \ &amp;&amp; make install \ &amp;&amp; cd /opt \ &amp;&amp; rm -rf /opt/mha4mysql-* \ &amp;&amp; apt-get clean æ³¨é‡Šï¼š åŸºäºŽdebian:jessieé•œåƒäºŒæ¬¡åˆ¶ä½œï¼› å°†mha4mysql-managerå’Œmha4mysql-nodeçš„å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼ˆv0.57ï¼‰æ‰“åŒ…ï¼Œå¤åˆ¶åˆ°é•œåƒå†…ï¼› build_depsæ˜¯mha4mysql-managerå’Œmha4mysql-nodeçš„å®‰è£…ä¾èµ–ã€è¿è¡Œä¾èµ–ï¼› å…ˆæ‹†åŒ…å®‰è£…mha4mysql-nodeï¼Œå®‰è£…å‘½ä»¤ï¼šperl Makefile.PL &amp;&amp; make &amp;&amp; make installï¼› æ‰èƒ½æ‹†åŒ…å®‰è£…mha4mysql-managerï¼Œå®‰è£…å‘½ä»¤ï¼šperl Makefile.PL &amp;&amp; make &amp;&amp; make installï¼› æ¸…ç†ä¸€äº›æ— ç”¨æ–‡ä»¶ã€‚ mha4mysql-nodemha4mysql-nodeçš„Dockerfile: 123456789101112131415FROM mysql:5.7COPY ./mha4mysql-node.tar.gz /tmp/RUN build_deps='ssh sshpass perl libdbi-perl libmodule-install-perl libdbd-mysql-perl make' \ &amp;&amp; apt-get update \ &amp;&amp; apt-get -y --force-yes install $build_deps \ &amp;&amp; tar -zxf /tmp/mha4mysql-node.tar.gz -C /opt \ &amp;&amp; cd /opt/mha4mysql-node \ &amp;&amp; perl Makefile.PL \ &amp;&amp; make \ &amp;&amp; make install \ &amp;&amp; cd /opt \ &amp;&amp; rm -rf /opt/mha4mysql-* \ &amp;&amp; apt-get clean æ³¨é‡Šï¼š åŸºäºŽmysql:5.7é•œåƒäºŒæ¬¡åˆ¶ä½œï¼› å°†mha4mysql-nodeçš„å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼ˆv0.57ï¼‰æ‰“åŒ…ï¼Œå¤åˆ¶åˆ°é•œåƒå†…ï¼› build_depsæ˜¯mha4mysql-nodeçš„å®‰è£…ä¾èµ–ã€è¿è¡Œä¾èµ–ï¼› æ‹†åŒ…å®‰è£…mha4mysql-managerï¼Œå®‰è£…å‘½ä»¤ï¼šperl Makefile.PL &amp;&amp; make &amp;&amp; make installï¼› æ¸…ç†ä¸€äº›æ— ç”¨æ–‡ä»¶ã€‚ æ³¨æ„v0.57 bugç›®å‰mha4mysql-managerå’Œmha4mysql-nodeçš„v0.57å¹¶ä¸å…¼å®¹ï¼Œæ–°ç‰ˆçš„libdbd-mysql-perlçš„è°ƒç”¨è¯­æ³•ï¼Œæ¯”å¦‚æ–°ç‰ˆè¦æ±‚è¿žæŽ¥æ•°æ®åº“æ ¼å¼æ˜¯ï¼šmy $dsn = &quot;DBI:mysql:;host=$opt{host};port=$opt{port}&quot;;è€Œv0.57æºç æ˜¯ï¼šmy $dsn = &quot;DBI:mysql:;host=[$opt{host}];port=$opt{port}&quot;;å¤šäº†ä¸€å¯¹ä¸­æ‹¬å·ä¼šå¯¼è‡´è¿žæŽ¥æ•°æ®åº“å¤±è´¥ã€‚è¿™é‡Œé•œåƒä¸­çš„mha4mysql-managerå’Œmha4mysql-nodeçš„æºç åŒ…æ˜¯å·²ç»å¯¹ä¸Šé¢é—®é¢˜è¿›è¡Œä¿®æ­£çš„ã€‚ å•å®¹å™¨å¤šæœåŠ¡æŒ‰ç…§Dockerçš„æ€æƒ³ï¼Œæ˜¯ä¸€ä¸ªå®¹å™¨åªåšä¸€ä»¶äº‹ï¼Œä½†æ˜¯mha4mysqlç»“ç‚¹éœ€è¦mysqlæœåŠ¡å’ŒsshæœåŠ¡ï¼Œè¿™é‡Œçš„ä¸´æ—¶è§£å†³åŠžæ³•æ˜¯å®¹å™¨å…ˆè¿è¡ŒmysqlæœåŠ¡ï¼Œä¹‹åŽæ‰§è¡Œdocker exec -it $CONTAINER_NAME /bin/bash service ssh startã€‚ç›®å‰å®žçŽ°Dokcerå•å®¹å™¨å¤šæœåŠ¡çš„hackæ–¹æ³•æ˜¯åˆ©ç”¨supervisorï¼Œåªåšsupervisorè¿™ä¸€ä»¶äº‹ï¼Œè€Œsupervisoråšå¤šä»¶äº‹ã€‚å¦‚æžœåŽæœŸçœŸçš„éœ€è¦ä½¿ç”¨supervisorï¼Œä¹Ÿå¯ä»¥åŸºäºŽæœ¬é•œåƒè¿›è¡ŒäºŒæ¬¡åˆ¶ä½œã€‚ æœ€åŽmha4mysql-managerå’Œmha4mysql-nodeçš„Dockerfileåˆ†åˆ«æ”¾åœ¨GitHubbreeze2/mha4mysql-manager-dockerå’Œbreeze2/mha4mysql-node-dockerä¸Šï¼›é•œåƒå¯ä»¥ç”¨dockerå‘½ä»¤ç›´æŽ¥æ‹‰å–ï¼š 12$ docker pull breeze2/mha4mysql-manager:0.57$ docker pull breeze2/mha4mysql-node:0.57]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>practice</tag>
        <tag>docker</tag>
        <tag>mha4mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”¨Dockerå®žçŽ°MySQL ProxySQLè¯»å†™åˆ†ç¦»]]></title>
    <url>%2Fblog%2Fpractice-mysql-proxysql-docker-compose.html</url>
    <content type="text"><![CDATA[ProxySQLæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„MySQLä¸­é—´ä»¶ï¼Œèƒ½å¤Ÿä»£ç†æ•°ç™¾å°MySQLæœåŠ¡å™¨ï¼Œæ”¯æŒæ•°åä¸‡çš„å¹¶å‘è¿žæŽ¥ã€‚ProxySQLä»£ç†MySQLå¹¶æä¾›è¯»å†™åˆ†ç¦»ï¼ŒæŸ¥è¯¢é‡å†™å’Œæ•°æ®åˆ†ç‰‡ç­‰åŠŸèƒ½ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»ç”¨Docker Composeç¼–æŽ’ç”¨ProxySQLå®žçŽ°MySQLé›†ç¾¤ä¸Šè¯»å†™åˆ†ç¦»çš„å®žè·µè¿‡ç¨‹ã€‚Docker Composeç¼–æŽ’ä¸­ä½¿ç”¨äº†ä¸€ä¸ªçŽ°æœ‰é•œåƒï¼Œå°±æ˜¯breeze2/proxysqlã€‚æœ¬æ¬¡å®žè·µæºç ä¸Šä¼ åœ¨GitHubçš„breeze2/mysql-proxy-dockerã€‚ Docker Composeç¼–æŽ’è¿™ä¸ªç¼–æŽ’ä¸»è¦å®žçŽ°ä¸€ä¸»ä¸¤ä»Žçš„ä¸€ä¸ªMySQLé›†ç¾¤å’Œä¸€ä¸ªProxySQLä»£ç†ï¼ŒProxySQLä»£ç†MYSQLé›†ç¾¤çš„æ•°æ®è¯·æ±‚å¹¶ä¸”è¿›è¡Œè¯»å†™åˆ†ç¦»ã€‚ ç›®å½•ç»“æž„1234567891011121314L--mysql-proxy-docker //ä¸»ç›®å½• L--scripts //æœ¬åœ°ï¼ˆDockerå®¿ä¸»ï¼‰ä½¿ç”¨çš„ä¸€äº›è„šæœ¬ L--mysql_set_users_and_repls.sh //è®¾ç½®å„ä¸ªæ•°æ®åº“è´¦å·å’Œå¼€å¯ä¸»ä»Žå¤åˆ¶ L--... L--services //éœ€è¦buildçš„æœåŠ¡ï¼ˆç›®å‰æ˜¯ç©ºï¼‰ L--volumes //å„ä¸ªå®¹å™¨çš„æŒ‚è½½æ•°æ®å· L--mysql_node0 L--mysql_node1 L--mysql_node2 L--proxysql L--share //å„ä¸ªå®¹å™¨å…±äº«çš„ç›®å½• L--scripts //å„ä¸ªå®¹å™¨å…±ç”¨çš„ä¸€äº›è„šæœ¬ L--parameters.env //è´¦å·å¯†ç ç­‰çŽ¯å¢ƒå‚æ•° L--docker-compose.yml //ç¼–æŽ’é…ç½® docker-compose.yml12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485version: "2"services: master: image: mysql:5.7 container_name: mysql_node0 restart: always mem_limit: 256m networks: net1: ipv4_address: 10.6.0.10 ports: - "3306" volumes: - "./volumes/share/:/root/share/" - "./volumes/mysql_node0/lib/:/var/lib/mysql/" - "./volumes/mysql_node0/conf/:/etc/mysql/conf.d/" env_file: - ./parameters.env slave1: image: mysql:5.7 container_name: mysql_node1 restart: always depends_on: - master mem_limit: 256m networks: net1: ipv4_address: 10.6.0.11 ports: - "3306" volumes: - "./volumes/share/:/root/share/" - "./volumes/mysql_node1/lib/:/var/lib/mysql/" - "./volumes/mysql_node1/conf/:/etc/mysql/conf.d/" env_file: - ./parameters.env slave2: image: mysql:5.7 container_name: mysql_node2 depends_on: - master restart: always mem_limit: 256m networks: net1: ipv4_address: 10.6.0.12 ports: - "3306" volumes: - "./volumes/share/:/root/share/" - "./volumes/mysql_node2/lib/:/var/lib/mysql/" - "./volumes/mysql_node2/conf/:/etc/mysql/conf.d/" env_file: - ./parameters.env proxy: image: breeze2/proxysql:1.4.3 container_name: proxysql depends_on: - master - slave1 - slave2 restart: always mem_limit: 256m networks: net1: ipv4_address: 10.6.0.9 ports: - "127.0.0.1:60320:6032" - "60330:6033" volumes: - "./volumes/proxysql/conf:/etc/proxysql" entrypoint: "proxysql -f -c /etc/proxysql/pr.cnf" env_file: - ./parameters.envnetworks: net1: driver: bridge ipam: config: - subnet: 10.6.0.0/16 gateway: 10.6.0.1 è¿™é‡Œé…ç½®äº†å››ä¸ªå®¹å™¨æœåŠ¡ï¼Œä¸€ä¸ªbreeze2/proxysqlï¼Œè´Ÿè´£ä»£ç†å„ä¸ªæ•°æ®åº“ï¼›ä¸‰ä¸ªmysqlï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ä¸»åº“ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯ä»Žåº“ã€‚æ¯ä¸ªå®¹å™¨æœåŠ¡éƒ½æŒ‡å®šäº†é™æ€IPï¼Œå³ä½¿æœåŠ¡é‡å¯ä¹Ÿä¸ä¼šå‡ºçŽ°IPé”™ä¹±é—®é¢˜ã€‚proxysqlå®¹å™¨çš„6032æ˜¯æä¾›ç®¡ç†æœåŠ¡çš„ç«¯å£ï¼Œåªå¯¹Dockerå®¿ä¸»æœºæœ¬åœ°IPå¼€æ”¾ï¼Œè€Œ6033æ˜¯ä»£ç†æ•°æ®è¯·æ±‚çš„ç«¯å£ï¼Œå¯ä»¥å¯¹Dockerå®¿ä¸»æœºç½‘ç»œIPå¼€æ”¾ã€‚ çŽ¯å¢ƒå‚æ•°parameters.env 1234MYSQL_ROOT_PASSWORD=123456MYSQL_DATABASE=testingMYSQL_User=testingMYSQL_PASSWORD=testing æ•°æ®åº“é…ç½®è¿™é‡Œç®€å•çš„é…ç½®ä¸€ä¸‹å„ä¸ªæ•°æ®åº“æ•°æ®å¤åˆ¶å¤‡ä»½ç›¸å…³çš„å‚æ•°ä¸»åº“ï¼Œmysql_node0/conf/my.cnf 12345678910[mysqld]server-id=1gtid-mode=onenforce-gtid-consistency=truelog-bin=mysql-binbinlog-do-db=testingbinlog-ignore-db=mysqlreplicate-do-db=testingreplicate-ignore-db=mysqlexpire_logs_days=7 ä»Žåº“ï¼Œmysql_node1/conf/my.cnf 12345678910[mysqld]server-id=2gtid-mode=onenforce-gtid-consistency=truelog-bin=mysql-binbinlog-do-db=testingbinlog-ignore-db=mysqlreplicate-do-db=testingreplicate-ignore-db=mysqlexpire_logs_days=7 ä»Žåº“ï¼Œmysql_node2/conf/my.cnf 12345678910[mysqld]server-id=3gtid-mode=onenforce-gtid-consistency=truelog-bin=mysql-binbinlog-do-db=testingbinlog-ignore-db=mysqlreplicate-do-db=testingreplicate-ignore-db=mysqlexpire_logs_days=7 ProxySQLé…ç½®proxysql/conf/pr.cnf 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990datadir=&quot;/tmp&quot;# ç®¡ç†å¹³å°å‚æ•°admin_variables =&#123; admin_credentials=&quot;admin2:admin2&quot; mysql_ifaces=&quot;0.0.0.0:6032&quot; refresh_interval=2000&#125;# mysqlå…¨å±€å‚æ•°mysql_variables =&#123; threads=4 max_connections=2048 default_query_delay=0 default_query_timeout=36000000 have_compress=true poll_timeout=2000 # interfaces=&quot;0.0.0.0:6033;/tmp/proxysql.sock&quot; interfaces=&quot;0.0.0.0:6033&quot; default_schema=&quot;information_schema&quot; stacksize=1048576 server_version=&quot;5.5.30&quot; connect_timeout_server=3000 # make sure to configure monitor username and password # https://github.com/sysown/proxysql/wiki/Global-variables#mysql-monitor_username-mysql-monitor_password monitor_username=&quot;pr_muser&quot; monitor_password=&quot;pr_mpass&quot; monitor_history=600000 monitor_connect_interval=60000 monitor_ping_interval=10000 monitor_read_only_interval=1500 monitor_read_only_timeout=500 ping_interval_server_msec=120000 ping_timeout_server=500 commands_stats=true sessions_sort=true connect_retries_on_failure=10&#125;# mysqlç”¨æˆ·å‚æ•°mysql_users = ( &#123; username = &quot;pr_auser&quot; password = &quot;pr_apass&quot; default_hostgroup = 0 &#125;)# mysqlæœåŠ¡å™¨å‚æ•°ï¼Œ10.6.0.10æ˜¯ä¸»åº“æ”¾åœ¨0ç»„ï¼Œå…¶ä»–æ˜¯ä»Žåº“æ”¾åœ¨1ç»„mysql_servers =( &#123; address = &quot;10.6.0.10&quot; port = 3306 weight = 1 hostgroup = 0 max_connections = 50 &#125;, &#123; address = &quot;10.6.0.11&quot; port = 3306 weight = 2 hostgroup = 1 max_connections = 100 &#125;, &#123; address = &quot;10.6.0.12&quot; port = 3306 weight = 2 hostgroup = 1 max_connections = 150 &#125;)# mysqlè¯·æ±‚è§„åˆ™ï¼Œä»¥ä¸‹é…ç½®æ˜¯è¯»æ—¶åŠ é”çš„è¯·æ±‚å‘ç»™0ç»„ï¼Œæ™®é€šè¯»å–çš„è¯·æ±‚å‘ç»™1ç»„ï¼Œå…¶ä»–é»˜è®¤å‘ç»™0ç»„ï¼ˆä¸Šé¢çš„default_hostgroupï¼‰mysql_query_rules:( &#123; rule_id=1 active=1 match_pattern=&quot;^SELECT .* FOR UPDATE$&quot; destination_hostgroup=0 apply=1 &#125;, &#123; rule_id=2 active=1 match_pattern=&quot;^SELECT&quot; destination_hostgroup=1 apply=1 &#125;) å®žé™…è¿è¡Œåœ¨ä¸»ç›®å½•ä¸‹æ‰§è¡Œdocker-compose up -dæž„å»ºå¹¶è¿è¡Œæ•´ä¸ªDockeræœåŠ¡ã€‚ å¼€å¯ä¸»ä»Žå¤åˆ¶åœ¨ä¸»ç›®å½•ä¸‹æ‰§è¡Œï¼š 1$ sh ./scripts/mysql_set_users_and_repls.sh å®žé™…ä¸Šæ˜¯è°ƒç”¨äº†æŒ‚è½½åœ¨æ•°æ®åº“å®¹å™¨é‡Œçš„ä¸€äº›è„šæœ¬ï¼š 123volumes/share/scripts/msyql_grant_proxysql_users.sh #è®¾ç½®ç»™proxysqlç”¨çš„è´¦å·ï¼Œpr_auserå’Œpr_muservolumes/share/scripts/msyql_grant_slave.sh #ä¸»åº“è®¾ç½®ç»™ä»Žåº“ç”¨çš„è´¦å·volumes/share/scripts/msyql_grant_slave.sh #ä»Žåº“å¼€å§‹æ•°æ®å¤åˆ¶ è„šæœ¬é‡Œçš„æ‰§è¡Œå‘½ä»¤éƒ½å¾ˆç®€å•ï¼Œä¸€çœ‹å°±æ˜Žã€‚ å¼€å¯ProxySQLä»£ç†æž„å»ºæ•´ä¸ªæœåŠ¡çš„æ—¶å€™ï¼Œproxysqlä¼šå…ˆæŒ‚è½½ä¸»ç›®å½•ä¸‹çš„./volumes/proxysql/conf/pr.cnfåˆ°å®¹å™¨å†…/etc/proxysql/pr.cnfï¼Œç„¶åŽæ‰§è¡Œproxysql -f -c /etc/proxysql/pr.cnfï¼Œæ‰€ä»¥è¿™é‡Œçš„ProxySQLæ˜¯æŒ‰ç…§pr.cnfé‡Œé¢çš„é…ç½®å¼€å¯MySQLä»£ç†æœåŠ¡çš„ï¼Œè¯·ä»”ç»†é˜…è¯»ä¸Šé¢ProxySQLé…ç½®ã€‚è‹¥æœ‰éœ€è¦åœ¨ProxySQLè¿è¡Œçš„è¿‡ç¨‹ä¸­ä¿®æ”¹é…ç½®ï¼Œå¯ä»¥ç™»å½•ProxySQLçš„ç®¡ç†ç³»ç»Ÿæ“ä½œã€‚ ProxySQLç®¡ç†ç³»ç»Ÿåœ¨Dockerå®¿ä¸»æœºä¸Šç™»å½•ProxySQLç®¡ç†ç³»ç»Ÿï¼ˆDockerå®¿ä¸»æœºéœ€è¦è£…æœ‰MySQL Clientï¼‰ï¼š 1$ mysql -u admin2 -padmin2 -h 127.0.0.1 -P60320 åœ¨ProxySQLç®¡ç†ç³»ç»Ÿä¸Šæ·»åŠ ä¸€ä¸ªmysql_userï¼ˆæ³¨æ„è¿™ä¸ªtestingè´¦å·æ˜¯å„ä¸ªæ•°æ®åº“éƒ½å·²å»ºç«‹çš„ï¼Œå…·ä½“æŸ¥çœ‹ä¸Šé¢çŽ¯å¢ƒå‚æ•°ï¼‰ï¼š 1mysql&gt; INSERT INTO mysql_users(username, password, default_hostgroup) VALUES ('testing', 'testing', 2); ç¡®è®¤æ˜¯å¦å·²æ·»åŠ ï¼š 12345678mysql&gt; SELECT * FROM mysql_users;+----------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+| username | password | active | use_ssl | default_hostgroup | default_schema | schema_locked | transaction_persistent | fast_forward | backend | frontend | max_connections |+----------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+| pr_auser | pr_apass | 1 | 0 | 0 | | 0 | 0 | 0 | 1 | 1 | 10000 || testing | testing | 1 | 0 | 2 | NULL | 0 | 1 | 0 | 1 | 1 | 10000 |+----------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+2 rows in set (0.00 sec) æŠŠå½“å‰ä¿®æ”¹ï¼ˆMEMORYå±‚ï¼‰åŠ è½½åˆ°æ­£åœ¨è¿è¡Œçš„ProxySQLï¼ˆRUNTIMEå±‚ï¼‰ï¼š 1mysql&gt; LOAD MYSQL USERS TO RUNTIME; åœ¨Dockerå®¿ä¸»æœºä¸Šç¡®è®¤ProxySQLæ˜¯å¦å·²åŠ è½½æœ€æ–°é…ç½®ï¼š 1234567$ mysql -u testing -ptesting -h 127.0.0.1 -P60330mysql: [Warning] Using a password on the command line interface can be insecure.Welcome to the MySQL monitor. Commands end with ; or \g.Your MySQL connection id is 7Server version: 5.5.30 (ProxySQL Admin Module)... è‹¥æƒ³ProxySQLé‡å¯åŽä¾ç„¶æ˜¯å½“å‰é…ç½®ï¼Œè¦æŠŠå½“å‰ä¿®æ”¹ï¼ˆMEMORYå±‚ï¼‰ä¿å­˜åˆ°ProxySQLçš„Sqliteæ•°æ®åº“é‡Œï¼ˆDISKå±‚ï¼‰ï¼š 1mysql&gt; SAVE MYSQL USERS TO DISK; ProxySQLé…ç½®ç³»ç»Ÿåˆ†ä¸‰å±‚ï¼Œåˆ†åˆ«æ˜¯MEMORYå±‚ã€RUNTIMEå±‚å’ŒDISKå±‚ã€‚ProxySQLç®¡ç†ç³»ç»Ÿæ“ä½œçš„æ˜¯MEMORYå±‚ï¼Œå½“å‰ProxySQLè¿è¡Œçš„æ˜¯RUNTIMEå±‚ï¼Œä¿å­˜åœ¨ProxySQLæœ¬åœ°Sqliteæ•°æ®åº“é‡Œçš„æ˜¯DISKå±‚ï¼Œè¯¦æƒ…è¯·é˜…è¯»æ–‡æ¡£ProxySQL Configurationã€‚ SysBenchæµ‹è¯•å·¥å…·SysBenchæ˜¯ä¸€ä¸ªè„šæœ¬åŒ–ã€å¤šçº¿ç¨‹çš„åŸºå‡†æµ‹è¯•å·¥å…·ï¼Œç»å¸¸ç”¨äºŽè¯„ä¼°æµ‹è¯•å„ç§ä¸åŒç³»ç»Ÿå‚æ•°ä¸‹çš„æ•°æ®åº“è´Ÿè½½æƒ…å†µã€‚SysBenchçš„ä½¿ç”¨æ•™ç¨‹å¯ä»¥å‚è€ƒsysbench 0.5ä½¿ç”¨æ‰‹å†Œã€‚è¿™é‡Œä½¿ç”¨SysBench-v1.0.9æ¥å¯¹ProxySQLè¿›è¡Œæµ‹è¯•ã€‚ SysBench Test Prepareé¦–å…ˆï¼Œåšæµ‹è¯•å‡†å¤‡ï¼š 12345678$ sysbench /usr/local/Cellar/sysbench/1.0.9/share/sysbench/oltp_read_write.lua --threads=5 --max-requests=0 --time=36 --db-driver=mysql --mysql-user=pr_auser --mysql-password=&apos;pr_apass&apos; --mysql-port=60330 --mysql-host=127.0.0.1 --mysql-db=testing --report-interval=1 preparesysbench 1.0.9 (using bundled LuaJIT 2.1.0-beta2)Initializing worker threads...Creating table &apos;sbtest1&apos;...Inserting 10000 records into &apos;sbtest1&apos;Creating a secondary index on &apos;sbtest1&apos;... æ³¨æ„ï¼Œ/usr/local/Cellar/sysbench/1.0.9/share/sysbench/oltp_read_write.luaæ–‡ä»¶å¯ä»¥åœ¨SysBenchå®‰è£…åŒ…é‡Œæ‰¾åˆ°ï¼Œæ‰§è¡Œå‘½ä»¤åŽï¼Œä¼šåœ¨ä¸»åº“testingæ•°æ®åº“é‡Œç”Ÿæˆä¸€ä¸ªsbtest1è¡¨å¹¶æ’å…¥ä¸€äº›æ•°æ®ï¼Œåœ¨ä»Žåº“é‡Œä¸€æ ·å¯ä»¥çœ‹åˆ°testingæ•°æ®åº“ä¸‹æœ‰sbtest1è¡¨ï¼Œè¯´æ˜Žä¸»ä»Žå¤åˆ¶å·²ç”Ÿæ•ˆã€‚ SysBench Test Runç„¶åŽï¼Œå¼€å§‹è¯»å†™æµ‹è¯•ï¼š 123456789101112131415161718$ sysbench /usr/local/Cellar/sysbench/1.0.9/share/sysbench/oltp_read_write.lua --threads=5 --max-requests=0 --time=36 --db-driver=mysql --mysql-user=pr_auser --mysql-password=&apos;pr_apass&apos; --mysql-port=60330 --mysql-host=127.0.0.1 --mysql-db=testing --report-interval=1 runsysbench 1.0.9 (using bundled LuaJIT 2.1.0-beta2)Running the test with following options:Number of threads: 5Report intermediate results every 1 second(s)Initializing random number generator from current timeInitializing worker threads...Threads started![ 1s ] thds: 5 tps: 51.66 qps: 1087.83 (r/w/o: 769.92/209.62/108.29) lat (ms,95%): 144.97 err/s: 0.00 reconn/s: 0.00[ 2s ] thds: 5 tps: 61.26 qps: 1229.13 (r/w/o: 862.60/243.01/123.52) lat (ms,95%): 142.39 err/s: 1.00 reconn/s: 0.00[ 3s ] thds: 5 tps: 60.85 qps: 1237.04 (r/w/o: 867.92/247.41/121.71) lat (ms,95%): 121.08 err/s: 0.00 reconn/s: 0.00[ 4s ] thds: 5 tps: 67.07 qps: 1332.44 (r/w/o: 931.01/267.29/134.15) lat (ms,95%): 127.81 err/s: 0.00 reconn/s: 0.00... æŸ¥çœ‹ç»“æžœç™»å½•ProxySQLç®¡ç†ç³»ç»Ÿï¼ŒæŸ¥çœ‹ç»Ÿè®¡ç»“æžœï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152$ mysql -u admin2 -padmin2 -h 127.0.0.1 -P60320mysql&gt; select * from stats_mysql_query_digest limit\G;*************************** 1. row *************************** hostgroup: 0 schemaname: testing username: pr_auser digest: 0xE365BEB555319B9Edigest_text: DELETE FROM sbtest1 WHERE id=? count_star: 2564 first_seen: 1508313300 last_seen: 1508313336 sum_time: 1923227 min_time: 149 max_time: 39773*************************** 2. row *************************** hostgroup: 0 schemaname: testing username: pr_auser digest: 0xFB239BC95A23CA36digest_text: UPDATE sbtest1 SET c=? WHERE id=? count_star: 2566 first_seen: 1508313300 last_seen: 1508313336 sum_time: 2016454 min_time: 158 max_time: 53514...*************************** 13. row *************************** hostgroup: 1 schemaname: testing username: pr_auser digest: 0xDBF868B2AA296BC5digest_text: SELECT SUM(k) FROM sbtest1 WHERE id BETWEEN ? AND ? count_star: 2570 first_seen: 1508313300 last_seen: 1508313336 sum_time: 7970660 min_time: 216 max_time: 56153*************************** 14. row *************************** hostgroup: 1 schemaname: testing username: pr_auser digest: 0xAC80A5EA0101522Edigest_text: SELECT c FROM sbtest1 WHERE id BETWEEN ? AND ? ORDER BY c count_star: 2570 first_seen: 1508313300 last_seen: 1508313336 sum_time: 10148202 min_time: 272 max_time: 5803214 rows in set (0.00 sec) å¯ä»¥çœ‹åˆ°è¯»æ“ä½œéƒ½å‘é€ç»™äº†hostgroup=1ç»„ï¼Œå†™æ“ä½œéƒ½å‘é€ç»™äº†hostgroup=0ç»„ï¼Œè¯´æ˜Žè¯»å†™åˆ†ç¦»å·²ç”Ÿæ•ˆï¼Œè¯»å†™åˆ†ç¦»é…ç½®è¯·ä»”ç»†é˜…è¯»ä¸Šé¢ProxySQLé…ç½®mysql_query_ruleséƒ¨åˆ†ã€‚ æ­¤è‡´åˆ°æ­¤ï¼Œç”¨Dockerå®žçŽ°MySQL ProxySQLè¯»å†™åˆ†ç¦»å·²å®Œæˆã€‚å¦å¤–ProxySQLæä¾›çš„æŸ¥è¯¢é‡å†™åŠŸèƒ½ï¼Œå…¶å®žæ˜¯åˆ©ç”¨mysql_query_rulesé…ç½®ï¼Œå¯¹æŽ¥æ”¶åˆ°çš„æŸ¥è¯¢è¯­å¥è¿›è¡Œæ­£åˆ™æ›¿æ¢ï¼Œå†ä¼ é€’ç»™æ•°æ®åº“æœåŠ¡å™¨ï¼Œè¯¦æƒ…è¯·é˜…è¯»æ–‡æ¡£ProxySQL Configurationä¸­çš„â€œMySQL Query Rulesâ€éƒ¨åˆ†ï¼›è€Œæ•°æ®åˆ†ç‰‡åŠŸèƒ½ï¼Œåœ¨çœŸå®žæ•°æ®åˆ†ç‰‡çš„åŸºç¡€ä¸Šï¼Œå†ç»“åˆmysql_query_rulesé…ç½®ï¼Œé‡å†™queryåˆ°æ­£ç¡®çš„ä¸»æœºã€æ•°æ®åº“æˆ–è¡¨ä¸Šï¼Œè¯¦ç»†å†…å®¹å¯ä»¥é˜…è¯»MySQL Sharding with ProxySQLã€‚]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>practice</tag>
        <tag>docker</tag>
        <tag>proxysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[OAuth2.0çš„æŽˆæƒæ¨¡å¼å’Œåº”ç”¨]]></title>
    <url>%2Fblog%2Foauth2-types-and-applications-of-the-grants.html</url>
    <content type="text"><![CDATA[OAuthï¼ˆå¼€æ”¾æŽˆæƒï¼‰æ˜¯ä¸€ä¸ªæ ‡å‡†åè®®ï¼Œä¸ºç”¨æˆ·èµ„æºçš„é‰´æƒé—®é¢˜æä¾›äº†ä¸€ä¸ªå®‰å…¨ã€å¼€æ”¾è€Œåˆç®€æ˜“çš„è§£å†³æ–¹æ¡ˆã€‚OAuth 2.0å®šä¹‰äº†å››ç§é‰´æƒæ¨¡å¼ï¼š æŽˆæƒç å‡†è®¸ï¼ˆAuthorization Code Grantï¼‰ éšå¼å‡†è®¸ï¼ˆImplicit Grantï¼‰ å®¢æˆ·ç«¯å‡†è®¸ï¼ˆClient Credentials Grantï¼‰ å¯†ç å‡†è®¸ï¼ˆResource Owner Password Credentials Grantï¼‰ è¿™é‡Œåªä»‹ç»è¿™å››ç§é‰´æƒæ¨¡å¼ï¼Œå³èŽ·å–æœ‰æ•ˆä»¤ç‰Œï¼ˆTokenï¼‰çš„å››ç§è¿‡ç¨‹ï¼Œå…³äºŽOAuth 2.0çš„å…¶ä»–æ›´å¤šå†…å®¹å»ºè®®é˜…è¯»ã€Šç†è§£OAuth 2.0ã€‹åŠ The OAuth 2.0 Authorization Frameworkã€‚ é¦–å…ˆï¼ŒOAuth 2.0é‰´æƒæ˜¯ç”¨æˆ·ï¼ˆResource Ownerï¼‰ã€ç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆThird-Party Applicationï¼‰å’Œé‰´æƒæœåŠ¡å™¨ï¼ˆAuthorization Serverï¼‰ä¸‰æ–¹é¢å…±åŒå®žçŽ°çš„ï¼Œå•é å…¶ä¸­ä¹‹ä¸€ä¸èƒ½åšåˆ°ã€‚ç¬¬ä¸‰æ–¹åº”ç”¨å¯¹äºŽé‰´æƒæœåŠ¡å™¨ï¼Œå¿…é¡»æ˜¯å¯ä¿¡çš„ï¼Œå½¼æ­¤çº¦å®šclient_idå’Œclient_secretã€redirect_uriç­‰æ•°æ®ã€‚æ‰€è°“é‰´æƒï¼Œå®žè´¨æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨å‘é‰´æƒæœåŠ¡å™¨ç”³è¯·æœ‰æ•ˆä»¤ç‰Œï¼ˆTokenï¼‰ï¼Œèƒ½èŽ·å–åˆ°æœ‰æ•ˆä»¤ç‰Œï¼Œåˆ™è¯´æ˜Žé‰´æƒé€šè¿‡ï¼Œåä¹‹ï¼Œä¸é€šè¿‡ã€‚ æŽˆæƒç å‡†è®¸å®žçŽ°æµç¨‹æŽˆæƒç å‡†è®¸æ˜¯åŸºäºŽé“¾æŽ¥è·³è½¬å®žçŽ°çš„é‰´æƒæ¨¡å¼ï¼Œå‡è®¾ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨åœ°å€ï¼šhttps://client.comé‰´æƒæœåŠ¡å™¨åœ°å€ï¼šhttps://server.comé‚£ä¹ˆå¤§æ¦‚çš„é‰´æƒæµç¨‹æ˜¯ï¼š ç¬¬ä¸‰æ–¹åº”ç”¨è¦ç”³è¯·ä»¤ç‰Œï¼Œé¦–å…ˆå¸¦ç€client_idç­‰å‚æ•°è·³è½¬åˆ°é‰´æƒæœåŠ¡å™¨é‰´æƒé“¾æŽ¥ï¼Œç”¨æˆ·åœ¨é‰´æƒæœåŠ¡å™¨ä¸Šé€‰æ‹©æ˜¯å¦åŒæ„æŽˆæƒäºŽç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆç”¨æˆ·è¦å…ˆåœ¨é‰´æƒæœåŠ¡å™¨ä¸Šç™»å½•ï¼‰ï¼› ç”¨æˆ·åŒæ„æŽˆæƒï¼Œé‰´æƒæœåŠ¡å™¨å¸¦ç€æŽˆæƒç codeè·³è½¬åˆ°åŽŸæœ¬æŒ‡å®šçš„ç¬¬ä¸‰æ–¹åº”ç”¨å›žè°ƒé“¾æŽ¥ï¼› ç¬¬ä¸‰æ–¹åº”ç”¨ç”¨æŽˆæƒç å’Œclient_secretç­‰å‚æ•°è·Ÿé‰´æƒæœåŠ¡å™¨æ¢å–ä»¤ç‰Œã€‚ æ³¨é‡Šï¼š é“¾æŽ¥è·³è½¬aå½¢å¼ä¸€èˆ¬æ˜¯ï¼ˆ$å¼€å¤´è¡¨ç¤ºæ˜¯å˜é‡ï¼‰ï¼š https://server.com/oauth/authorize?client_id=$CLIENT_ID&amp;response_type=code&amp;redirect_uri=$REDIRECT_URI&amp;scope=$SCOPE&amp;state=$STATEï¼› é“¾æŽ¥è·³è½¬bå½¢å¼ä¸€èˆ¬æ˜¯ï¼š https://client.com/oauth/callback?code=$CODE&amp;state=$STATEï¼› postè¯·æ±‚cå½¢å¼ä¸€èˆ¬æ˜¯ï¼šhttps://server.com/oauth/tokenï¼Œå‚æ•°å½¢å¼ï¼š 1234567&#123; grant_type: 'authorization_code', client_id: $CLIENT_ID, client_secret: $CLIENT_SECRET, redirect_uri: $REDIRECT_URI, code: $CODE&#125; postå“åº”då½¢å¼ä¸€èˆ¬æ˜¯ï¼š 123456&#123; token_type: 'Bearer', expires_in: $EXPIRES_IN, access_token: $ACCESS_TOKEN, refresh_token: $REFRESH_TOKEN&#125; åº”ç”¨åœºæ™¯æŽˆæƒç å‡†è®¸çš„é‰´æƒæ¨¡å¼æ˜¯å››ç§æ¨¡å¼å½“ä¸­åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†çš„ã€‚ä½¿ç”¨æŽˆæƒç å‡†è®¸çš„ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œä¸€èˆ¬æ˜¯B/Sç»“æž„ï¼ˆæµè§ˆå™¨/æœåŠ¡å™¨ç»“æž„ï¼‰ã€‚æœåŠ¡æä¾›å•†ï¼ˆHTTP Serviceï¼‰ç»™ç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘client_idå’Œclient_secretï¼Œç¬¬ä¸‰æ–¹åº”ç”¨çš„åŽå°æœåŠ¡å™¨æ®æ­¤ä¸ŽæœåŠ¡æä¾›å•†çš„é‰´æƒæœåŠ¡å™¨è¿›è¡Œäº’åŠ¨ã€‚æ¯”å¦‚ï¼Œå¾®ä¿¡å…¬ä¼—å·å¼€å‘ä¸­ï¼ŒèŽ·å–å½“å‰è®¿é—®ç”¨æˆ·ä¿¡æ¯å°±é‡‡ç”¨äº†æŽˆæƒç å‡†è®¸çš„é‰´æƒæ¨¡å¼ï¼Œè¯¦è§å¾®ä¿¡ç½‘é¡µæŽˆæƒã€‚ éšå¼å‡†è®¸å®žçŽ°æµç¨‹éšå¼å‡†è®¸æ˜¯æŽˆæƒç å‡†è®¸çš„ç®€åŒ–ï¼Œå› ä¸ºç”¨æˆ·åŒæ„æŽˆæƒå°±å¯ä»¥ç›´æŽ¥å‘æ”¾ä»¤ç‰Œï¼Œä¸éœ€è¦ç”¨æŽˆæƒç æ¥å†æ¬¡è¯·æ±‚ä»¤ç‰Œã€‚å¤§æ¦‚çš„é‰´æƒæµç¨‹æ˜¯ï¼š ç¬¬ä¸‰æ–¹åº”ç”¨è¦ç”³è¯·ä»¤ç‰Œï¼Œé¦–å…ˆå¸¦ç€client_idç­‰å‚æ•°è·³è½¬åˆ°é‰´æƒæœåŠ¡å™¨é‰´æƒé“¾æŽ¥ï¼Œç”¨æˆ·åœ¨é‰´æƒæœåŠ¡å™¨ä¸Šé€‰æ‹©æ˜¯å¦åŒæ„æŽˆæƒäºŽç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆç”¨æˆ·è¦å…ˆåœ¨é‰´æƒæœåŠ¡å™¨ä¸Šç™»å½•ï¼‰ï¼› ç”¨æˆ·åŒæ„æŽˆæƒï¼Œé‰´æƒæœåŠ¡å™¨å¸¦ç€ä»¤ç‰Œç­‰å‚æ•°è·³è½¬åˆ°åŽŸæœ¬æŒ‡å®šçš„ç¬¬ä¸‰æ–¹åº”ç”¨å›žè°ƒé“¾æŽ¥ã€‚ æ³¨é‡Šï¼š é“¾æŽ¥è·³è½¬aå½¢å¼ä¸€èˆ¬æ˜¯ï¼ˆ$å¼€å¤´è¡¨ç¤ºæ˜¯å˜é‡ï¼‰ï¼š https://server.com/oauth/authorize?client_id=$CLIENT_ID&amp;response_type=code&amp;redirect_uri=$REDIRECT_URI&amp;scope=$SCOPE&amp;state=$STATEï¼› é“¾æŽ¥è·³è½¬bå½¢å¼ä¸€èˆ¬æ˜¯ï¼š https://client.com/oauth/callback#token_type=Bearer&amp;expires_in=$EXPIRES_IN&amp;access_token=$ACCESS_TOKEN&amp;state=$STATEï¼› è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œé‰´æƒæœåŠ¡å™¨è·³å›žåˆ°ç¬¬ä¸‰æ–¹åº”ç”¨æ—¶ï¼Œä¸ºä»€ä¹ˆä¼ é€’å‚æ•°æ˜¯ä»¥hashå½¢å¼è€Œä¸æ˜¯queryå½¢å¼ï¼Ÿå› ä¸ºé“¾æŽ¥çš„hashæ•°æ®åªåœ¨æœ¬åœ°æµè§ˆå™¨é‡Œä¼ æ’­ï¼Œå†ç»“åˆHTTPSï¼Œæ•´ä¸ªç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œé“¾æŽ¥hashä¸­ä»¤ç‰Œç­‰ä¿¡æ¯å¹¶æ²¡æœ‰æš´éœ²ï¼›è€Œé“¾æŽ¥çš„queryæ•°æ®æ˜¯å¿…ç„¶ä¼šæš´éœ²çš„ã€‚ åº”ç”¨åœºæ™¯éšå¼å‡†è®¸çš„é‰´æƒæ¨¡å¼æœ€ç»ˆæ˜¯ä»¥é“¾æŽ¥çš„hashå½¢å¼ä¼ é€’ä»¤ç‰Œï¼Œæ•´ä¸ªæ“ä½œæµç¨‹åªèƒ½åœ¨æµè§ˆå™¨çŽ¯å¢ƒä¸­è¿›è¡Œã€‚ä½†æ¢ä¸ªè§’åº¦çœ‹ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨ä¸éœ€è¦ç»è¿‡è‡ªèº«åŽå°æœåŠ¡å™¨ï¼Œç›´æŽ¥å¯ä»¥åœ¨æµè§ˆå™¨ä¸­å‘é‰´æƒæœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œæ‰€ä»¥éšå¼å‡†è®¸çš„é‰´æƒæ¨¡å¼ååˆ†é€‚ç”¨äºŽå½“ä¸‹æµè¡Œçš„å‰åŽåˆ†ç¦»çš„å•é¡µåº”ç”¨æˆ–è€…åŸºäºŽWebviewçš„æ‰‹æœºåº”ç”¨ã€‚éšå¼å‡†è®¸çš„é‰´æƒæ¨¡å¼ä¸æ£€éªŒclient_secretï¼Œä¸è¿‡é‰´æƒæœåŠ¡å™¨åªä¼šå›žè·³åˆ°å¯ä¿¡çš„ç¬¬ä¸‰æ–¹åº”ç”¨å›žè°ƒé“¾æŽ¥ï¼ˆåˆå§‹çº¦å®šï¼‰ï¼Œæ‰€ä»¥é‰´æƒè¿‡ç¨‹ä¾ç„¶æ˜¯å®‰å…¨çš„ï¼Œå†è¯´client_secretæ”¾åœ¨å‰ç«¯JavaScriptä»£ç ä¸­å¾ˆå®¹æ˜“æš´éœ²ã€‚ å®¢æˆ·ç«¯å‡†è®¸å®žçŽ°æµç¨‹å®¢æˆ·ç«¯å‡†è®¸ï¼Œæ³¨æ„è¿™é‡Œè¯´çš„å®¢æˆ·ç«¯è¯´çš„æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œä½†å®ƒä¸æ˜¯ä¸€ä¸ªPCç¨‹åºæˆ–è€…æ‰‹æœºåº”ç”¨ï¼ŒæŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªæœºå™¨æˆ–è€…æœåŠ¡å™¨å¯èƒ½æ›´ä¸ºåˆç†ã€‚æ•´ä¸ªé‰´æƒæµç¨‹åªæœ‰ç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆThird-Party Applicationï¼‰å’Œé‰´æƒæœåŠ¡å™¨ï¼ˆAuthorization Serverï¼‰å‚ä¸Žï¼Œä¸éœ€è¦ç”¨æˆ·ï¼ˆResource Ownerï¼‰åŒæ„æŽˆæƒã€‚ å¤§æ¦‚çš„é‰´æƒæµç¨‹æ˜¯ï¼š ç¬¬ä¸‰æ–¹åº”ç”¨ç”¨client_idå’Œclient_secretç­‰å‚æ•°å‘é‰´æƒæœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼› é‰´æƒæœåŠ¡å™¨ç»™ç¬¬ä¸‰æ–¹åº”ç”¨å‘æ”¾ä»¤ç‰Œã€‚ æ³¨é‡Šï¼š ç”³è¯·ä»¤ç‰Œæ—¶ï¼Œpostè¯·æ±‚é“¾æŽ¥ä¸€èˆ¬æ˜¯ï¼šhttps://server.com/oauth/tokenï¼Œå‚æ•°å½¢å¼ï¼š 123456&#123; grant_type: 'client_credentials', client_id: $CLIENT_ID, client_secret: $CLIENT_SECRET, scope: $SCOPE&#125; å‘æ”¾ä»¤ç‰Œæ—¶ï¼Œpostå“åº”ä¸€èˆ¬æ˜¯ï¼š 12345&#123; token_type: 'Bearer', expires_in: $EXPIRES_IN, access_token: $ACCESS_TOKEN&#125; åº”ç”¨åœºæ™¯å®¢æˆ·ç«¯å‡†è®¸ä¸éœ€è¦ç»è¿‡ç”¨æˆ·åŒæ„æŽˆæƒï¼Œç›¸å½“äºŽæœåŠ¡æä¾›å•†ç›´æŽ¥å°†èµ„æºåˆ†äº«ç»™å¯ä¿¡çš„ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œä»¤ç‰Œåªæ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®æœåŠ¡æä¾›å•†æŽ¥å£æ‰€éœ€çš„ä¸€ä¸ªå‡­è¯ã€‚æ¯”å¦‚ï¼Œå¾®ä¿¡å…¬ä¼—å·å¼€å‘ä¸­ï¼Œå…¬ä¼—å·æœåŠ¡å™¨è°ƒç”¨å¾®ä¿¡æŽ¥å£å‰éœ€è¦ç»è¿‡å®¢æˆ·ç«¯å‡†è®¸ï¼Œè¯¦è§èŽ·å–access_tokenã€‚ å¯†ç å‡†è®¸å®žçŽ°æµç¨‹å¯†ç å‡†è®¸æ˜¯ç”¨æˆ·å°†è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç äº¤ä¸Žç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨æ®æ­¤å‘é‰´æƒæœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚å¤§æ¦‚çš„é‰´æƒæµç¨‹æ˜¯ï¼š ç”¨æˆ·åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨ä¸Šè¾“å…¥è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨æ®æ­¤å‘é‰´æƒæœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼› é‰´æƒæœåŠ¡å™¨ç»™ç¬¬ä¸‰æ–¹åº”ç”¨å‘æ”¾ä»¤ç‰Œã€‚ æ³¨é‡Šï¼š ç”³è¯·ä»¤ç‰Œæ—¶ï¼Œpostè¯·æ±‚é“¾æŽ¥ä¸€èˆ¬æ˜¯ï¼šhttps://server.com/oauth/tokenï¼Œå‚æ•°å½¢å¼ï¼š 12345678&#123; grant_type: 'password', client_id: $CLIENT_ID, client_secret: $CLIENT_SECRET, username: $USERNAME, password: $PASSWORD, scope: $SCOPE&#125; å‘æ”¾ä»¤ç‰Œæ—¶ï¼Œpostå“åº”ä¸€èˆ¬æ˜¯ï¼š 123456&#123; token_type: 'Bearer', expires_in: $EXPIRES_IN, access_token: $ACCESS_TOKEN, refresh_token: $REFRESH_TOKEN&#125; åº”ç”¨åœºæ™¯å¯†ç å‡†è®¸çš„é‰´æƒæ¨¡å¼é€‚ç”¨äºŽæ²¡æœ‰æµè§ˆå™¨çŽ¯å¢ƒã€æ²¡æœ‰åŽå°æœåŠ¡å™¨çš„ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œè¿™ç§åº”ç”¨æ˜¯ä¸€ä¸ªçº¯å®¢æˆ·ç«¯ï¼Œæ¯”å¦‚PCç¨‹åºæˆ–è€…æ‰‹æœºåº”ç”¨ï¼ˆåŒºåˆ«å®¢æˆ·ç«¯å‡†è®¸ï¼‰ã€‚é‰´æƒæœåŠ¡å™¨ä¸€èˆ¬ä¸ä¼šå¯¹ç¬¬ä¸‰æ–¹åº”ç”¨åšå¯†ç å‡†è®¸ï¼Œå› ä¸ºæ¶‰åŠåˆ°ç”¨æˆ·çš„å¯†ç ï¼Œé™¤éžç¬¬ä¸‰æ–¹åº”ç”¨ååˆ†å¯ä¿¡ã€‚æ¯”å¦‚ï¼ŒFacebookåŽŸæœ¬æ˜¯ä¸€ä¸ªWebç½‘ç«™ï¼ŒåŽæ¥è¦å¼€å‘æ‰‹æœºåº”ç”¨Facebook Appï¼Œé‚£ä¹ˆFacebook Webå¯ä»¥å¯¹Facebook Appåšå¯†ç å‡†è®¸ï¼Œå› ä¸ºFacebook Appæ˜¯Facebookè‡ªå®¶äº§å“ï¼Œä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚å³ä½¿ç¬¬ä¸‰æ–¹åº”ç”¨éžå¸¸å¯ä¿¡ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨åœ¨åŠŸèƒ½è®¾è®¡ä¸Šä¹Ÿä¸èƒ½å­˜å‚¨ç”¨æˆ·è¾“å…¥çš„å¯†ç ï¼Œä¸‡ä¸€è¢«ç ´è§£ï¼Œç”¨æˆ·çš„å¯†ç å°±ä¼šæš´éœ²ã€‚ æœ€åŽæœ€åŽæ€»ç»“ä¸€ä¸‹ï¼š æŽˆæƒç å‡†è®¸å’Œéšå¼å‡†è®¸ä¸­ç”¨æˆ·åŒæ„æŽˆæƒçš„æ“ä½œæ˜¯é¦–æ¬¡å¿…é¡»ï¼Œç”¨æˆ·åŒæ„åŽä¸‹æ¬¡é»˜è®¤ç›´æŽ¥åŒæ„ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥è®¾ç½®æœ‰æ•ˆæœŸï¼‰ï¼› æŽˆæƒç å‡†è®¸å’Œå¯†ç å‡†è®¸ä¼šè¿”å›žrefresh_tokenï¼Œä»¤ç‰Œè¿‡æœŸæ—¶ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å¯ä»¥ç”¨refresh_tokenéšå¼åˆ·æ–°ä»¤ç‰Œï¼› å®¢æˆ·ç«¯å‡†è®¸å’Œéšå¼å‡†è®¸ä¸ä¼šè¿”å›žrefresh_tokenï¼Œä»¤ç‰Œè¿‡æœŸæ—¶ï¼Œè¦æ±‚ç¬¬ä¸‰æ–¹åº”ç”¨é‡æ–°ç”³è¯·ä»¤ç‰Œï¼Œå®¢æˆ·ç«¯å‡†è®¸æ¨¡å¼é‡æ–°ç”³è¯·ä»¤ç‰Œå¯¹ç”¨æˆ·æ— å¹²æ‰°ï¼Œè€Œéšå¼å‡†è®¸æ¨¡å¼å¯ä»¥åˆ©ç”¨éšå½¢iframeé‡æ–°ç”³è¯·ä»¤ç‰Œæ¥å‡å°‘å¯¹ç”¨æˆ·çš„å¹²æ‰°ï¼› å¯¹äºŽB/Sç»“æž„çš„Webåº”ç”¨ï¼Œå»ºè®®ä½¿ç”¨æŽˆæƒç å‡†è®¸çš„é‰´æƒæ¨¡å¼ï¼› å¯¹äºŽå‰åŽåˆ†ç¦»çš„Webå•é¡µåº”ç”¨ï¼Œå»ºè®®ä½¿ç”¨éšå¼å‡†è®¸çš„é‰´æƒæ¨¡å¼ï¼› å¯¹äºŽå…±äº«èµ„æºï¼Œä¸Žç”¨æˆ·æ„æ„¿æ— å…³çš„åº”ç”¨ï¼Œå»ºè®®ä½¿ç”¨å®¢æˆ·ç«¯å‡†è®¸çš„é‰´æƒæ¨¡å¼ï¼› å¯¹äºŽè‡ªå®¶PCæˆ–æ‰‹æœºåº”ç”¨äº§å“ï¼Œå»ºè®®ä½¿ç”¨å¯†ç å‡†è®¸çš„é‰´æƒæ¨¡å¼ã€‚]]></content>
      <categories>
        <category>çŸ¥é“</category>
      </categories>
      <tags>
        <tag>oauth2</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å•ç‚¹ç™»å½•çš„å®žçŽ°]]></title>
    <url>%2Fblog%2Fpractice-single-sign-on.html</url>
    <content type="text"><![CDATA[å•ç‚¹ç™»å½•ï¼ˆSingle Sign-Onï¼‰ï¼Œæ˜¯æŒ‡ä¸€æ¬¡ç™»å½•ï¼Œå¤šç«™å¤ç”¨ç™»å½•æ€ã€‚è¿™é‡Œä¸»è¦è®²è§£ä¸€ä¸‹åŸºäºŽå…±äº«sessionå®žçŽ°çš„å•ç‚¹ç™»å½•ã€‚ å¯¹äºŽå¤§å¤šæ•°B/Sç»“æž„ï¼ˆæµè§ˆå™¨/æœåŠ¡å™¨ç»“æž„ï¼‰çš„Webç½‘ç«™ï¼Œç”¨æˆ·ç™»å½•æ€éƒ½æ˜¯å­˜å‚¨åœ¨sessionä¸­çš„ï¼Œè€ŒsessionIDï¼ˆsessionçš„å”¯ä¸€è¯†åˆ«å·ï¼‰è®°å½•åœ¨å‰ç«¯çš„cookieä¸­ï¼Œåªè¦åŒæ­¥å„ä¸ªç½‘ç«™çš„sessionIDï¼Œå„ä¸ªç½‘ç«™ä¾¿èƒ½å…±äº«åŒä¸€ä¸ªsessionï¼Œè¿›è€Œå…±ç”¨ç”¨æˆ·çš„ç™»å½•æ€ã€‚éœ€è¦å…±äº«sessionçš„æƒ…å†µä¸»è¦æœ‰ä¸‰ç§ï¼š åŒåŸŸåä¸‹ä¸åŒè·¯å¾„ï¼› åŒçˆ¶åŸŸåä¸‹ä¸åŒå­åŸŸåï¼› ä¸åŒåŸŸåï¼› ä¸‹é¢ä¼šæ ¹æ®è¿™ä¸‰ç§æƒ…å†µï¼Œå€Ÿç”¨Laravelå’ŒJQueryä»£ç ï¼Œé€ä¸€å®žçŽ°å•ç‚¹ç™»å½•ï¼ˆå…±äº«sessionï¼‰ã€‚ åŒåŸŸåä¸‹ä¸åŒè·¯å¾„å‡è®¾ä¸€ä¸ªç½‘ç«™ä¸‹æœ‰ä¸¤æ¡è·¯å¾„ï¼š https://www.a.site/path1 https://www.a.site/path2 è‹¥æƒ³è¿™ä¸¤æ¡è·¯å¾„åŒæ­¥sessionIDï¼Œååˆ†ç®€å•ï¼Œæ¯”å¦‚ç”¨æˆ·åœ¨https://www.a.site/path1è·¯å¾„ä¸‹ç™»å½•åŽï¼Œå°†è®°å½•sessionIDçš„cookieè®¾ç½®æˆæ ¹è·¯å¾„â€™/â€˜æœ‰æ•ˆï¼Œè¿™æ ·ç½‘ç«™https://www.a.siteä¸‹çš„æ‰€æœ‰è·¯å¾„éƒ½èƒ½ä½¿ç”¨è¿™ä¸ªcookieã€‚ä»£ç å®žçŽ°ï¼š 1234567&lt;?php // after login // raw php setcookie(session_name(), session_id(), time()+3600, '/'); // use laravel \Cookie::queue(config('session.cookie'), session()-&gt;getId(), 60, '/'); åŒçˆ¶åŸŸåä¸‹ä¸åŒå­åŸŸåå‡è®¾æœ‰ä¸¤ä¸ªç½‘ç«™ï¼š https://www.a.site https://mob.a.site è‹¥æƒ³è¿™ä¸¤ä¸ªç½‘ç«™åŒæ­¥sessionIDï¼Œå…¶å®žä¹Ÿä¸éš¾ã€‚é¦–å…ˆï¼Œè¿™ä¸¤ä¸ªç½‘ç«™å¯èƒ½ä¸åœ¨åŒä¸€ä¸ªä¸»æœºä¸Šï¼Œæ‰€ä»¥sessionä¸èƒ½ç›´æŽ¥ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯è¦ä¿å­˜åˆ°åŒä¸€æ•°æ®åº“ä¸­ï¼Œä¸”ä¸¤ä¸ªç½‘ç«™éƒ½èƒ½è®¿é—®è¿™ä¸ªæ•°æ®åº“ã€‚ç„¶åŽï¼Œç”¨æˆ·åœ¨https://www.a.siteç½‘ç«™ä¸‹ç™»å½•åŽï¼Œå°†è®°å½•sessionIDçš„cookieè®¾ç½®æˆçˆ¶åŸŸå.a.siteæœ‰æ•ˆï¼Œè¿™æ ·a.siteåŸŸåä¸‹çš„æ‰€æœ‰ç½‘ç«™éƒ½èƒ½ä½¿ç”¨è¿™ä¸ªcookieã€‚ä»£ç å®žçŽ°ï¼š 1234567&lt;?php // after login // raw php setcookie(session_name(), session_id(), time()+3600, '/', '.a.site'); // use laravel \Cookie::queue(config('session.cookie'), session()-&gt;getId(), 60, '/', '.a.site'); ä¸åŒåŸŸåJSONP+é“¾æŽ¥queryå‡è®¾æœ‰ä¸¤ä¸ªç½‘ç«™ï¼š https://www.a.site https://www.b.site è‹¥æƒ³è¿™ä¸¤ä¸ªç½‘ç«™åŒæ­¥sessionIDï¼Œå°±ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“äº†ã€‚è¿™é‡Œæ¶‰åŠäº†å‰ç«¯è·¨åŸŸé€šä¿¡é—®é¢˜ã€‚æœ¬æ¥æƒ³ç€ç”¨JSONP+é“¾æŽ¥queryæ¥å®žçŽ°çš„â€”â€”æ¯”å¦‚ï¼Œç”¨æˆ·åœ¨https://www.a.siteç½‘ç«™ä¸‹ç™»å½•åŽï¼Œä¾¿åœ¨ç½‘é¡µHTMLä¸­æ’å…¥ä¸€ä¸ªscriptæ ‡ç­¾ï¼Œå…¶srcå±žæ€§è®¾ä¸ºå¦ä¸€ä¸ªç½‘ç«™çš„åŠ¨æ€é“¾æŽ¥ï¼ŒsessionIDæ”¾åœ¨é“¾æŽ¥queryä¸­ï¼Œå½¢å¦‚&lt;script type=&quot;text/javascript&quot; src=&quot;https://www.b.site/set-cookie?session_id=$SESSION_ID&quot;&gt;&lt;/script&gt;è€Œhttps://www.b.site/set-cookieçš„å¤„ç†è„šæœ¬å¤§æ¦‚æ˜¯ 1234567&lt;?php // set cookie // raw php setcookie(session_name(), $_GET['session_id'], time()+3600); // use laravel \Cookie::queue(config('session.cookie'), request()-&gt;input('session_id'), 60); ä½†æ˜¯ï¼Œè¿™æ ·ä¸€æ¥ï¼Œåœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ï¼ŒsessionIDå°±ä¼šæš´éœ²äº†ï¼Œæ•´ä¸ªç½‘ç«™å°±ä¸å®‰å…¨äº†ã€‚ä¸ºäº†ä¿æŠ¤ç”¨æˆ·çš„sessionIDï¼Œä¸¤ä¸ªç½‘ç«™ä¹‹é—´å‰ç«¯è·¨åŸŸé€šä¿¡é‡‡ç”¨iframe+é“¾æŽ¥hashæ¥å®žçŽ°ã€‚ iframe+é“¾æŽ¥hashï¼ˆå…¶å®žè¿™é‡Œæ‰æ˜¯æ•´ç¯‡æ–‡ç« çš„é‡ç‚¹ï¼‰é¦–å…ˆï¼Œcookieå–æ¶ˆHttpOnlyé™åˆ¶ã€‚Laravelæ¡†æž¶é‡Œï¼Œè®°å½•sessionIDçš„cookieé»˜è®¤HttpOnlyï¼Œå› ä¸ºåŽé¢éœ€è¦åœ¨å‰ç«¯ä¿®æ”¹cookieï¼Œæ‰€ä»¥å…ˆå–æ¶ˆHttpOnlyï¼š 123456&lt;?php// config/session.php return [ ... 'http_only' =&gt; false; ]; å½“ç„¶ï¼Œå³ä½¿cookieæ˜¯HttpOnlyï¼Œä¹Ÿèƒ½è¢«ä¿®æ”¹ï¼Œä¸è¿‡éœ€è¦åœ¨åŽç«¯æ“ä½œï¼ˆæ­¥éª¤ç›¸å¯¹ä¼šç¹çï¼‰ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿é‡‡ç”¨å‰ç«¯æ“ä½œã€‚ç„¶åŽï¼Œç™»å½•æ“ä½œä½¿ç”¨å¼‚æ­¥è¯·æ±‚ã€‚å¼‚æ­¥è¯·æ±‚ç™»å½•æˆåŠŸåŽï¼Œå¯ä»¥åœ¨å›žè°ƒå‡½æ•°é‡ŒåŒæ­¥å…¶ä»–ç½‘ç«™çš„sessionIDã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849// login.js var sites = ['https://www.a.site', 'https://www.b.site']; var session_name = 'laravel_session'; var sync_num = 0; function afterLogin() &#123; window.location.href = '/home'; &#125; function afterSync() &#123; if(sync_num === sites.length) setTimeout(afterLogin, 800); &#125; function makeFrame(url) &#123; var $iframe = $('&lt;iframe style="display:none" class="sync-session-id"&gt;&lt;/iframe&gt;').appendTo('body'); $iframe.on('load', function () &#123; sync_num++; afterSync(); &#125;); $iframe.prop('src', url); &#125; function getCookie(name) &#123; var cookie_str = window.document.cookie; if (cookie_str.length&gt;0) &#123; var start = cookie_str.indexOf(name + '='); if (start!=-1) &#123; start = start + name.length + 1; var end=cookie_str.indexOf(';', start) if (end==-1) end=cookie_str.length; return unescape(cookie_str.substring(start, end)) &#125; &#125; return ''; &#125; ... $.post('/paht/to/login', &#123;username: username, password:password&#125;).done(function (rst) &#123; if(rst.code==0) &#123; // login successful var session_id = getCookie(session_name); // èŽ·å–ç™»å½•æˆåŠŸåŽçš„sessionID $.each(sites, function(i, e) &#123; if(window.location.href.indexOf(e)==0) &#123; sync_num++; return true; &#125; makeFrame(e+'/set-cookie.html'+'#'+'name='+session_name+'&amp;value='+session_id); // è®¿é—®ç½‘ç«™eçš„set-cookie.htmlæ¥åŒæ­¥sessionID &#125;); &#125; &#125;); æ¯ä¸ªç½‘ç«™éƒ½æ”¾ç½®ä¸€ä¸ªå¯è®¿é—®çš„set-cookie.html(åå­—å¯ä»¥è‡ªå–)ï¼Œset-cookie.htmlé‡Œé¢çš„è„šæœ¬ä¼šå°†é“¾æŽ¥çš„hashä¿¡æ¯è®°å½•åˆ°è‡ªèº«ç½‘ç«™çš„cookieé‡Œã€‚ 123456789101112131415161718192021222324252627282930313233&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;set cookie&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;script type="text/javascript"&gt; function setCookie(name, value, expires) &#123; var date = new Date(); date.setTime(date.getTime()+expires*1000); var cookie = name + '=' + escape(value) + ((expires==null)? '' : ';expires='+date.toGMTString()) + ';path=/'; window.document.cookie = cookie; &#125; var hash = window.location.hash; if(hash) &#123; var data_str = hash.substring(1); var data_arr = data_str.split('&amp;'); var data = &#123;&#125;; for(var i=0; i&lt;data_arr.length; i++) &#123; var str = data_arr[i]; var arr = str.split('='); if(arr[0]) data[arr[0]] = arr[1] ? arr[1]: ''; &#125; if(data.name &amp;&amp; data.value) &#123; setCookie(data.name, data.value, 3600); &#125; &#125; &lt;/script&gt;&lt;/body&gt;&lt;/html&gt; è¿™æ ·ç”¨æˆ·åœ¨ä¸€ä¸ªç½‘ç«™ç™»å½•åŽï¼Œåˆ°å¦ä¸€ä¸ªç½‘ç«™ä¹Ÿèƒ½å…±äº«ç™»å½•æ€ã€‚ ç»§ç»­ä¼˜åŒ–æ›´å¤šçš„ç½‘ç«™å½“æœ‰æ›´å¤šçš„ç½‘ç«™æ—¶ï¼Œå¦‚ï¼š https://www.a.site https://www.b.site https://www.c.site https://www.d.site https://www.e.site â€¦ å®‰è£…ä¸Šé¢çš„ä»£ç ï¼Œåªéœ€è¦åœ¨ç™»å½•é¡µé¢ä¸ŠæŠŠæ‰€æœ‰çš„ç½‘ç«™åœ°å€æ·»åŠ åˆ°sitesæ•°ç»„é‡Œå³å¯ï¼š 123456// login.js var sites = ['https://www.a.site', 'https://www.b.site', 'https://www.c.site', 'https://www.d.site', 'https://www.e.site']; var session_name = 'laravel_session'; var sync_num = 0; ... æˆ–è€…ï¼Œå–ä¸€ä¸ªç½‘ç«™ä½œä¸ºå…¶ä»–ç½‘ç«™çš„ç™»å½•ä»£ç†ã€‚å‡è®¾æ˜¯ä»£ç†ç½‘ç«™æ˜¯https://www.x.siteï¼Œè€Œå…¶ä»–ç½‘ç«™éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€è¯†åˆ«ç site_idã€‚æ¯”å¦‚https://www.a.siteçš„å”¯ä¸€è¯†åˆ«ç site_idæ˜¯1ï¼Œåˆ™ç”¨æˆ·è®¿é—®https://www.a.siteçš„ç™»å½•é¡µé¢æ—¶ï¼Œç½‘ç«™å¸¦ç€site_idè·³è½¬åˆ°https://www.x.site/login?site_id=1ï¼Œè€Œhttps://www.x.site/loginçš„åŽç«¯å¤„ç†æ–¹æ³•å¤§æ¦‚æ˜¯ï¼š 1234567891011121314151617&lt;?php // pseudo code // use laravel public function getLogin(Request $request) &#123; // get request $site_id = $request-&gt;input('site-id'); $site_url = get_site_url_by_id($site_id); if($isLogined) &#123; // has logined in www.x.site return redirect($site_url)-&gt;withCookie(\Cookie::make(config('session.cookie'), session()-&gt;getId(), 60)); &#125; else &#123; return view('x.login'); &#125; &#125; public function postLogin(Request $request) &#123; // post request &amp; ajax only ... &#125; è‹¥æ˜¯ç”¨æˆ·æœªæ›¾ç™»å½•è¿‡ï¼Œåˆ™åœ¨https://www.x.site/login?site_id=$SITE_IDé¡µé¢ä¸Šç”¨å¼‚æ­¥è¯·æ±‚ç™»å½•ï¼Œç™»å½•æˆåŠŸåŽå‰ç«¯è„šæœ¬åˆ·æ–°å½“å‰é¡µé¢ï¼Œå°±ä¼šå¸¦ç€cookieè·³å›žåˆ°site_idå¯¹åº”çš„ç½‘ç«™ï¼›ç”¨æˆ·åœ¨https://www.x.siteç™»å½•è¿‡ï¼Œåœ¨ç™»å½•å…¶ä»–ç½‘ç«™çš„æ—¶å€™ï¼Œç›´æŽ¥è·³åˆ°https://www.x.site/login?site_id=$SITE_IDï¼Œç»§è€Œå¸¦ç€cookieè·³å›žåˆ°site_idå¯¹åº”çš„ç½‘ç«™ã€‚ åŽç«¯è®¾ç½®cookieä¹‹å‰è¯´è¿‡çš„åŽç«¯è·¨åŸŸè®¾ç½®cookieï¼Œæ–¹æ³•å°±æ˜¯å¦‚ä¸Šé¢ä»£ç é‚£æ ·å¸¦cookieè·³è½¬é“¾æŽ¥ï¼š 1234567&lt;?php // raw php setcookie(session_name(), session_id(), time()+3600, '/'); header('Location: '.$site_url); // use laravel redirect($site_url)-&gt;withCookie(\Cookie::make(config('session.cookie'), session()-&gt;getId(), 60)); å…±äº«tokenå¦‚æžœç½‘ç«™ä½¿ç”¨tokenæ¥ç»´æŒç”¨æˆ·ç™»å½•æ€ï¼Œè€Œä¸æ˜¯sessionï¼Œé‚£ä¹ˆæ€Žæ ·å®žçŽ°å•ç‚¹ç™»å½•å‘¢ï¼Ÿå…¶å®žæ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œåˆ©ç”¨iframe+é“¾æŽ¥hashï¼Œå°†tokenæ”¾åˆ°é“¾æŽ¥hashé‡Œé¢ï¼Œä¼ é€’ç»™å…¶ä»–ç½‘ç«™ï¼Œå…¶ä»–ç½‘ç«™æŽ¥æ”¶åŽæŠŠtokenä¿å­˜åˆ°LocalStorageå°±è¡Œäº†ã€‚ æœ€åŽå‰åŽç»“åˆï¼Œå¯ä»¥å®žçŽ°å¾ˆå¤šhackæ“ä½œã€‚æœ€åŽè¯´è¯´ï¼ŒQQæ€Žæ ·å°†å®¢æˆ·ç«¯é‡Œçš„ç”¨æˆ·ç™»å½•æ€å…±äº«ç»™æµè§ˆå™¨ï¼šQQå®¢æˆ·ç«¯ç™»å½•åŽä¼šç›‘å¬ä¸€äº›æœ¬åœ°ç«¯å£ï¼Œå„ä¸ªQQç³»ç½‘ç«™é€šè¿‡JSONPæ–¹å¼è®¿é—®è¿™äº›ç«¯å£ï¼Œè¿›è€ŒèŽ·å–ç”¨æˆ·ç™»å½•ä¿¡æ¯ã€‚]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>php</tag>
        <tag>practice</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Swooleè¿žæŽ¥æ± åœ¨Laravelä¸­çš„ä½¿ç”¨]]></title>
    <url>%2Fblog%2Fpractice-swoole-connection-pool-in-laravel.html</url>
    <content type="text"><![CDATA[Swoole php-cpphp-cpæ˜¯Swooleç»„ç»‡å¼€å‘çš„ä¸€ä¸ªPHPæ‰©å±•ï¼Œå¯ä»¥æœ¬åœ°ä»£ç†MySQLã€Redisè¿žæŽ¥ï¼Œæä¾›è¿žæŽ¥æ± ï¼Œè¯»å†™åˆ†ç¦»ï¼Œè´Ÿè½½å‡è¡¡ï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå¤§æ•°æ®å—æ—¥å¿—ç­‰åŠŸèƒ½ã€‚ç›¸æ¯”åŽŸç”ŸPHPçš„æ•°æ®åº“è¿žæŽ¥ï¼Œphp-cpè¿žæŽ¥æ± å¯ä»¥ç¼“å­˜è¿žæŽ¥ï¼Œå…åŽ»ä¸€äº›é‡å¤æ–°å»ºã€å›žæ”¶æ•°æ®åº“è¿žæŽ¥å¸¦æ¥çš„æ—¶é—´æ¶ˆè€—å’ŒIOæ¶ˆè€—ï¼›å¹¶ä¸”php-cpè¿žæŽ¥å®šæ—¶pingæ•°æ®åº“ï¼Œä½¿å¾—è¿žæŽ¥ä¸ä¼šå¤ªä¹…æ²¡æ´»åŠ¨è€Œè¢«å›žæ”¶ï¼›åœ¨è¿žæŽ¥æ•°è¶…è¿‡é™é¢æ—¶ï¼Œphp-cpæä¾›äº†æŽ’é˜Ÿæœºåˆ¶ï¼Œè€Œä¸æ˜¯ç›´æŽ¥æ‹’ç»ï¼Œæ‰€ä»¥php-cpæ˜¯å€¼å¾—é«˜å¹¶å‘çš„PHPé¡¹ç›®å¼•å…¥ä½¿ç”¨çš„ã€‚php-cpæä¾›äº†ä»£æ›¿PDOçš„ç±»ï¼špdoProxyï¼Œæ‰€ä»¥åœ¨ä¸»æµPHPæ¡†æž¶ä¸­å¼•å…¥php-cpæ˜¯ååˆ†ç®€ä¾¿çš„ã€‚åœ¨php-cpçš„READMEä¸­ï¼Œæä¾›äº†Yiiã€CIå’ŒThinkPHPç­‰æ¡†æž¶çš„é›†æˆæ ·ä¾‹ï¼Œä½†æ˜¯å°‘äº†Laravelï¼Œæ‰€ä»¥è¿™é‡Œä»‹ç»ä¸€ä¸‹åœ¨Laravelé¡¹ç›®ä¸­æ€Žæ ·é›†æˆphp-cpã€‚ å®‰è£…php-cpæ‰©å±•é¦–å…ˆï¼Œä¸‹è½½php-cpæºç ï¼Œç¼–è¯‘å®‰è£…ï¼š 1234567$ cd tmp $ git clone https://github.com/swoole/php-cp.git$ cd php-cp$ phpize$ ./configure$ make$ sudo make install ç¼–è¯‘æˆåŠŸåŽï¼Œå°†extension=connect_pool.soæ·»åŠ åˆ°php-cliå’Œphp-fpmçš„php.inié…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·PHPå¯åŠ¨çš„æ—¶å€™å°±ä¼šåŠ è½½connect_poolæ‰©å±•ã€‚ å¯åŠ¨pool-serverphp-cpæä¾›äº†çŽ°æˆçš„è¿žæŽ¥æ± è„šæœ¬ï¼Œåªéœ€è¦æŒ‰ç…§ä»¥ä¸‹é…ç½®ï¼Œä¾¿èƒ½å¯åŠ¨pool-serverè¿žæŽ¥æ± æœåŠ¡ï¼š 123456789$ sudo cp ./config.ini.example /etc/pool.ini #æ ¹æ®éœ€æ±‚ä¿®æ”¹é…ç½®å†…å®¹$ sudo mkdir -m 755 /var/log/php-connection-pool #åˆ›å»ºæ—¥å¿—ç›®å½• ç›®å½•æ–‡ä»¶å¤¹ä¸å­˜åœ¨æˆ–æ²¡æƒé™ä¼šå¯¼è‡´æ—¥å¿—å†™ä¸èµ·$ chmod +x ./pool_server #xæƒé™gitå·²ç»è®¾ç½® ä¸ºç¨³å¦¥å†è®¾ç½®ä¸€æ¬¡ pool_serverä¸ºphpè„šæœ¬ å¯è‡ªè¡Œä¿®æ”¹$ [ -f /bin/env ] || sudo ln -s /usr/bin/env /bin/env #debç³»çš„ç³»ç»Ÿ(å¦‚debianã€ubuntu)envçš„è·¯å¾„ä¸º/usr/bin/envåšè½¯é“¾æŽ¥å…¼å®¹å¤„ç†$ sudo cp ./pool_server /usr/local/bin/pool_server$ sudo pool_server start #å¯åŠ¨æœåŠ¡ å¦‚æžœé…ç½®æ–‡ä»¶çš„daemonizeå¼€å¯åˆ™åŽå°è¿è¡Œ å¦åˆ™ä¸ºå‰å°è¿è¡Œ Ctrl+cç»“æŸæœåŠ¡$ sudo pool_server stop #åœæ­¢æœåŠ¡$ sudo pool_server restart #é‡å¯æœåŠ¡$ sudo pool_server status #æŸ¥çœ‹æœåŠ¡çŠ¶æ€ /etc/pool.iniæ˜¯pool_serverè„šæœ¬æŒ‡å®šçš„é…ç½®è·¯å¾„ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œè°ƒæ•´/etc/pool.inié‡Œé¢çš„é…ç½®å‚æ•°ã€‚æ¯”å¦‚ï¼ŒPDOæ•°æ®æºï¼ŒLaravelçš„è¿žæŽ¥æ ¼å¼ä¸€èˆ¬æ˜¯ï¼š 1[&apos;mysql:host=127.0.0.1;port=3306;dbname=forge&apos;] è‹¥æ˜¯è¯·æ±‚çš„è¿žæŽ¥åœ¨é…ç½®ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„æ•°æ®æºï¼Œpool_serverä¼šè‡ªåŠ¨æ–°å»ºä¸€ä¸ªæ•°æ®æºï¼Œæ–°çš„æ•°æ®æºä¿¡æ¯å¯ä»¥é€šè¿‡sudo pool_server statusæŸ¥çœ‹ã€‚ Laravelé›†æˆLaravelé›†æˆphp-cpçš„ä»£ç æˆ‘å·²ç»ä¸Šä¼ åˆ°githubï¼Œlaravel-swoole-cpï¼Œä¸»è¦æ˜¯ä¸‰ä¸ªæ–‡ä»¶ï¼š laravel/framework/src/Illuminate/Database/MySqlSwooleProxyConnection.php laravel/framework/src/Illuminate/Database/Connectors/MySqlSwooleProxyConnector.php laravel/framework/src/Illuminate/Database/Connectors/ConnectionFactory.php åªè¦å°†è¿™ä¸‰ä¸ªæ–‡ä»¶æ”¾åˆ°Laravelé¡¹ç›®çš„vendoræ–‡ä»¶å¤¹ä¸‹ä¾¿å¯ã€‚MySqlSwooleProxyConnection.phpå’ŒMySqlSwooleProxyConnector.phpæ˜¯æ¨¡ä»¿Laravelæ¡†æž¶è‡ªæœ‰çš„MySqlConnection.phpå’ŒMySqlConnector.phpæ–°å¢žç¼–å†™çš„ï¼›è€ŒConnectionFactory.phpåˆ™æ˜¯åœ¨Laravelæ¡†æž¶åŽŸæœ‰çš„åŸºç¡€ä¸Šä¿®æ”¹çš„ï¼Œä¸»è¦æ˜¯è°ƒç”¨MySqlSwooleProxyConnectionå’ŒMySqlSwooleProxyConnectorè¿™ä¸¤ä¸ªæ–°å¢žç±»ã€‚ ConnectionFactory.phpä¿®æ”¹çš„åœ°æ–¹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556&lt;?phpnamespace Illuminate\Database\Connectors;use Illuminate\Database\MySqlSwooleProxyConnection;...class ConnectionFactory&#123; ... public function createConnector(array $config) &#123; if (! isset($config['driver'])) &#123; throw new InvalidArgumentException('A driver must be specified.'); &#125; if ($this-&gt;container-&gt;bound($key = "db.connector.&#123;$config['driver']&#125;")) &#123; return $this-&gt;container-&gt;make($key); &#125; switch ($config['driver']) &#123; case 'mysql-cp': return new MySqlSwooleProxyConnector; case 'mysql': return new MySqlConnector; case 'pgsql': return new PostgresConnector; case 'sqlite': return new SQLiteConnector; case 'sqlsrv': return new SqlServerConnector; &#125; throw new InvalidArgumentException("Unsupported driver [&#123;$config['driver']&#125;]"); &#125; protected function createConnection($driver, $connection, $database, $prefix = '', array $config = []) &#123; if ($resolver = Connection::getResolver($driver)) &#123; return $resolver($connection, $database, $prefix, $config); &#125; switch ($driver) &#123; case 'mysql-cp': return new MySqlSwooleProxyConnection($connection, $database, $prefix, $config); case 'mysql': return new MySqlConnection($connection, $database, $prefix, $config); case 'pgsql': return new PostgresConnection($connection, $database, $prefix, $config); case 'sqlite': return new SQLiteConnection($connection, $database, $prefix, $config); case 'sqlsrv': return new SqlServerConnection($connection, $database, $prefix, $config); &#125; throw new InvalidArgumentException("Unsupported driver [$driver]"); &#125;&#125; æ³¨æ„ï¼Œè¿™é‡Œå°†php-cpçš„æ•°æ®åº“è¿žæŽ¥é©±åŠ¨å‘½åä¸ºmysql-cpï¼Œæ‰€ä»¥åœ¨Laravelé¡¹ç›®çš„æ•°æ®åº“é…ç½®config/database.phpé‡Œåº”è¯¥è¿™æ ·é…ç½®php-cpçš„è¿žæŽ¥é©±åŠ¨ï¼š 12345678910111213141516171819202122232425&lt;?php// config/database.phpreturn [ 'default' =&gt; env('DB_CONNECTION', 'mysql-cp'), 'connections' =&gt; [ 'mysql-cp' =&gt; [ 'driver' =&gt; 'mysql-cp', 'host' =&gt; env('DB_HOST', '127.0.0.1'), 'port' =&gt; env('DB_PORT', '3306'), 'database' =&gt; env('DB_DATABASE', 'forge'), 'username' =&gt; env('DB_USERNAME', 'forge'), 'password' =&gt; env('DB_PASSWORD', ''), 'unix_socket' =&gt; env('DB_SOCKET', ''), 'charset' =&gt; 'utf8mb4', 'collation' =&gt; 'utf8mb4_unicode_ci', 'prefix' =&gt; '', 'strict' =&gt; true, 'engine' =&gt; null, ], ... ],] é—®é¢˜æ¥äº†ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œæ‰§è¡Œä¸€å¥DB::table(&#39;users&#39;)-&gt;find();ï¼Œå´æŠ¥é”™äº†ï¼ˆæˆ‘å¥½åƒæ˜Žç™½äº†ä¸ºä»€ä¹ˆæ²¡äººæä¾›php-cpçš„Laravelè¿žæŽ¥é©±åŠ¨ï¼‰ï¼š è§£å†³åŠžæ³•ç»è¿‡æŽ’æŸ¥ï¼Œå‘çŽ°å½“æ•°æ®èŽ·å–æ¨¡å¼è®¾ä¸ºPDO::FETCH_OBJï¼Œpool_serverçš„workerå°±ä¼šé€€å‡ºï¼Œå…¶ä»–èŽ·å–æ¨¡å¼å°±è¿è¡Œæ­£å¸¸ï¼Œé‚£ä¹ˆåº”è¯¥æ˜¯å˜é‡åºåˆ—åŒ–ä¼ è¾“çš„é—®é¢˜ã€‚åŽŸæ¥php-cpV1.5.0ç‰ˆæœ¬ï¼ˆç›®å‰æœ€æ–°ç‰ˆï¼‰é’ˆå¯¹PHP7çŽ¯å¢ƒï¼Œä½¿ç”¨è‡ªå®¶çš„swoole_serializeåºåˆ—åŒ–æ–¹æ³•ï¼Œè€Œæˆ‘çš„ç³»ç»Ÿæ­£å¥½è£…çš„æ˜¯PHP7ï¼ŒäºŽæ˜¯æƒ³ï¼šç”¨ç›¸å¯¹ä¸»æµçš„åºåˆ—åŒ–æ–¹æ³•msgpack-phpæ›¿æ¢swoole_serializeçš„è¯å¯èƒ½ä¼šè§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æ›¿æ¢åŽï¼Œé‡æ–°ç¼–è¯‘å®‰è£…php-cpï¼Œæžœç„¶é—®é¢˜è§£å†³äº†ã€‚æ›¿æ¢åŽçš„php-cpæºç æˆ‘å·²ç»ä¸Šä¼ åˆ°githubï¼Œbreeze2/php-cpï¼Œè‹¥æœ‰éœ€è¦å¯ä»¥ä¸‹è½½å®‰è£…ã€‚ æœ€åŽphp-cpä¸»è¦ä½œç”¨æ˜¯åº”å¯¹é«˜å¹¶å‘ï¼Œå‡è®¾MySQLæ•°æ®åº“çš„æœ€å¤§è¿žæŽ¥æ•°max_connectionsæ˜¯100ï¼Œå½“è¯·æ±‚è¿žæŽ¥è¶…è¿‡100çš„æ—¶å€™ï¼Œè‹¥æ˜¯PHPç›´æŽ¥è®¿é—®æ•°æ®åº“ï¼ŒMySQLä¼šç›´æŽ¥æ‹’ç»å¤šå‡ºæ¥çš„è¿žæŽ¥ï¼›è€Œé€šè¿‡php-cpè®¿é—®æ•°æ®åº“ï¼Œphp-cpæœ‰æŽ’é˜Ÿæœºåˆ¶åº”å¯¹å¤šå‡ºæ¥çš„è¿žæŽ¥ï¼Œphp-cpçš„è¿žæŽ¥æ± å¯ä»¥é•¿é©»å†…å­˜ï¼Œä¹Ÿå…åŽ»äº†å¤§é‡çš„æ•°æ®åº“è¿žæŽ¥çº¿ç¨‹æ–°å»ºã€å›žæ”¶å¸¦æ¥çš„æ¶ˆè€—ã€‚ç»¼åˆæ¥è¯´ï¼Œä¸€èˆ¬å¹¶å‘é‡ä¸é«˜çš„ç½‘ç«™ä¹Ÿç”¨ä¸ä¸Šphp-cpï¼›è€Œå¯¹äºŽå¤§åž‹é«˜å¹¶å‘çš„ç½‘ç«™ï¼Œä½¿ç”¨æ•°æ®åº“ä¸­é—´ä»¶æ›´ä¸ºåˆç†ï¼Œå› ä¸ºphp-cpæ˜¯æœ¬åœ°ä»£ç†ï¼Œæœ‰äº›é™åˆ¶äº†å•æœºæ•ˆèƒ½ã€‚åªæ˜¯çœ‹åˆ°php-cpæ²¡æœ‰ç›¸åº”çš„Laravelè¿žæŽ¥é©±åŠ¨ï¼Œå¼ºè¿«ç—‡å‘ä½œï¼Œå†™äº†ä¸€ä¸ªè€Œå·²ã€‚]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>practice</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è‡ªåŠ¨åŒ–å·¥å…·Nightmareçš„ä¸€æ¬¡å®žè·µ]]></title>
    <url>%2Fblog%2Fpractice-nightmare-weiyun-operation.html</url>
    <content type="text"><![CDATA[äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œä¸€ä¸ªçº¿ä¸Šçš„å‚èµ›æ´»åŠ¨ç½‘ç«™è¦æ”¶é›†å‚èµ›é€‰æ‰‹æäº¤çš„å¾®äº‘åˆ†äº«é“¾æŽ¥ï¼Œä½†æ˜¯æ™®é€šå¾®äº‘è´¦å·çš„åˆ†äº«é“¾æŽ¥åªæœ‰7å¤©æœŸæ•ˆã€‚é‚£è¯¥æ€Žä¹ˆåŠžå‘¢ï¼Ÿåªå¥½æŠŠæ‰€æœ‰é€‰æ‰‹çš„å¾®äº‘åˆ†äº«é“¾æŽ¥è½¬å­˜åˆ°ä¸€ä¸ªé«˜çº§å¾®äº‘è´¦å·ä¸Šï¼Œå†ç”±é«˜çº§å¾®äº‘è´¦å·åˆ†äº«å‡ºæ¥ï¼Œä»¥æ­¤å¢žé•¿åˆ†äº«æ—¶é—´ã€‚å¦‚æžœé äººå·¥æ“ä½œï¼Œé‚£å·¥ä½œé‡å¤ªå¤§ï¼Œä¹Ÿéš¾å…ä¼šå‡ºé”™ï¼Œæ‰€ä»¥å†™äº†ä¸€ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬æ¥æ‰§è¡Œè¿™ä¸ªå·¥ä½œã€‚ï¼ˆåŽæ¥å¾®äº‘å–æ¶ˆäº†åˆ†äº«æœŸæ•ˆé™åˆ¶ï¼Œè¿™ä¸ªè„šæœ¬æ²¡æœ‰æ­£å¼ç”¨ä¸ŠðŸ˜Šï¼‰ NightmareNightmareæ˜¯ä¸€ä¸ªé«˜çº§çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–å·¥å…·åº“ï¼Œå‡ºè‡ªSegmentã€‚å®ƒæä¾›äº†ä¸€äº›æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œï¼ˆæ¯”å¦‚clickã€inputå’Œgotoç­‰ç­‰ï¼‰çš„APIï¼Œä¸»è¦ç”¨äºŽUIæµ‹è¯•å’Œç½‘é¡µçˆ¬è™«ã€‚Nightmareå†…ç½®äº†Electronï¼Œä¸€ä¸ªç±»ä¼¼PhantomJSçš„æµè§ˆå™¨ï¼ˆæˆ–è€…è¯´webviewå§ï¼‰ï¼Œä½†æ˜¯æ¯”PhantomJSæ›´å¿«ï¼Œæ›´çŽ°ä»£åŒ–ã€‚ å¼•å…¥Nightmareååˆ†ç®€å•ï¼Œåˆå§‹åŒ–ä¸€ä¸ªNodeJSé¡¹ç›®åŽï¼Œæ‰§è¡Œyarn add nightmareæˆ–è€…npm install nightmareå³å¯ã€‚ ä¸‹é¢ä»‹ç»æ”¶å½•å¾®äº‘åˆ†äº«é“¾æŽ¥ä»¥åŠå†åˆ†äº«çš„å…·ä½“å®žçŽ°ã€‚ å…·ä½“å®žçŽ°æ•´ä¸ªæµç¨‹å¤§æ¦‚æ˜¯åœ¨è‡ªå·±çš„äº‘ç›˜ä¸Šæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åŽå°†åˆ«äººçš„åˆ†äº«é“¾æŽ¥å­˜åˆ°è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œï¼Œå¤šä¸ªé“¾æŽ¥ä¾æ­¤å¾ªçŽ¯ï¼›å†æŠŠè¿™ä¸ªæ–‡ä»¶å¤¹é‡Œé¢çš„å†…å®¹åˆ†äº«å‡ºåŽ»ï¼Œè®°å½•è‡ªå·±çš„åˆ†äº«é“¾æŽ¥ï¼Œå¤šä¸ªæ–‡ä»¶å¤¹ä¾æ­¤å¾ªçŽ¯ã€‚ä¸ºäº†é¿å…æ–‡ä»¶å¤¹é‡åï¼Œæ¯æ¡åˆ†äº«é“¾æŽ¥é…å¤‡ä¸€ä¸ªå”¯ä¸€idã€‚ æœ€ç»ˆæ•ˆæžœï¼š å®žçŽ°èµ·æ¥å¹¶ä¸éš¾ï¼Œåªè¦ç ”ç©¶é¡µé¢çš„DOMç»“æž„ï¼Œç„¶åŽå®‰æŽ’å¥½å„ä¸ªæ“ä½œæµç¨‹ï¼Œå†ç”¨Nightmareæä¾›çš„æŽ¥å£å®žçŽ°è¿™äº›æ“ä½œå°±è¡Œäº†ã€‚ ä¸»è¦é—®é¢˜å®žçŽ°è¿‡ç¨‹ä¸­ä¸»è¦ç¢°åˆ°ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯è·¨åŸŸiframeé€šè®¯é—®é¢˜ï¼Œå¦ä¸€ä¸ªæ˜¯èŽ·å–Electronå†…éƒ¨jså˜é‡é—®é¢˜ã€‚ è·¨åŸŸiframeç”±äºŽElectronæµè§ˆå™¨çš„åŒæºå®‰å…¨ç­–ç•¥ï¼Œä¸»é¡µé¢ä¸èƒ½æ“ä½œè·¨åŸŸiframeé‡Œçš„å…ƒç´ ï¼Œä½†æ˜¯äº‘ç›˜ç™»å½•çš„æ—¶å€™éœ€è¦æ“ä½œqq.comåŸŸiframeé‡Œé¢çš„ç™»å½•æŒ‰é’®ã€‚è§£å†³åŠžæ³•æ˜¯ï¼Œå¼•ç”¨nightmare-iframe-manageræ‰©å±•ï¼Œç¦ç”¨Electronå®‰å…¨æ¨¡å¼ï¼š 1234567891011// yarn add nightmare// yarn add nightmare-iframe-managervar Nightmare = require('nightmare')require('nightmare-iframe-manager')(Nightmare)var nightmare = Nightmare(&#123; show: true, dock: true, webPreferences: &#123; webSecurity:false &#125;&#125;) èŽ·å–Electronå†…éƒ¨jså˜é‡åœ¨Electronå†…éƒ¨è¿è¡Œjsä»£ç æ—¶ï¼Œæœ‰æ—¶éœ€è¦å–å‡ºä¸€äº›å˜é‡å€¼åšè®°å½•ï¼Œæ¯”å¦‚ï¼Œå–å‡ºè‡ªå·±çš„äº‘ç›˜åˆ†äº«é“¾æŽ¥ã€‚å¤©çœŸçš„æˆ‘ä»¥ä¸ºè®¾ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ—¢èƒ½åœ¨è‡ªå·±çš„è„šæœ¬é‡Œä½¿ç”¨ï¼Œä¹Ÿèƒ½åœ¨Electronå†…éƒ¨ä½¿ç”¨ï¼Œç»“æžœæ˜¯æ ¹æœ¬å°±ä¸èµ·æ•ˆã€‚æœ€åŽè§£å†³åŠžæ³•æ˜¯å¼•å…¥voï¼Œå†ç»“åˆES6çš„æ–°ç‰¹æ€§yieldï¼ŒèŽ·å–Electronå†…éƒ¨å˜é‡å€¼ï¼š 123456789101112131415161718192021222324// yarn add nightmare// yarn add vovar vo = require('vo')var Nightmare = require('nightmare')var run = function* () &#123; var nightmare = Nightmare(&#123; show: true, dock: true, webPreferences: &#123; webSecurity:false &#125; &#125;) nightmare.goto('https://xxxxx') var link = yield nightmare.evaluate(function () &#123; var el = window.document.querySelector('#_disk_share_pop_container') return el.querySelector('span a.link').href &#125;)&#125;vo(run)(function(err, result) &#123; console.log(err, result) // console.log(JSON.stringify(result))&#125;) voæ˜¯ä¸€ä¸ªèƒ½å®Œå…¨æŽ§åˆ¶jsæ‰§è¡Œæµçš„å·¥å…·åº“ï¼Œè€Œyieldèƒ½â€œæš‚åœâ€æ‰§è¡Œæµï¼Œå–å‡ºæƒ³è¦çš„æŸä¸ªå˜é‡å€¼ï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚JSçš„ä¸œè¥¿æ—¥æ–°æœˆå¼‚ï¼Œæ²¡çœ‹ä¸€æ®µæ—¶é—´å°±å®Œå…¨è·Ÿä¸ä¸Šäº†ðŸ˜¢ã€‚ æœ€åŽå…¶å®žï¼Œç ”ç©¶ç½‘ç›˜é¡µé¢çš„DOMç»“æž„ï¼Œå†è®¾è®¡æœ‰æ•ˆçš„æ‰§è¡Œæµç¨‹ï¼ŒèŠ±è´¹æ—¶é—´ä¸å°‘ï¼›ä¸è¿‡èƒ½æ›¿ä»£å¤§é‡é‡å¤æ€§çš„äººå·¥æ“ä½œï¼Œä¹Ÿæ˜¯å€¼å¾—çš„ã€‚]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>practice</tag>
        <tag>nightmare</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å…³äºŽLNMPçš„ä¼˜åŒ–]]></title>
    <url>%2Fblog%2Fthink-about-the-optimization-of-lnmp.html</url>
    <content type="text"><![CDATA[çº¿ä¸Šæœ‰ä¸€ä¸ªç”¨LNMPæž„æž¶çš„ç½‘ç«™ï¼Œæœ‰ä¸€å¤©çœ‹åˆ°å®ƒå‡ºçŽ°äº†â€œ502 Bad Gatewayâ€é”™è¯¯ï¼ŒäºŽæ˜¯å°±å¼€å§‹æ€è€ƒä¼˜åŒ–é—®é¢˜äº†ã€‚é¦–å…ˆï¼Œæ˜Žç¡®ä¸€ä¸‹HTTPå„ä¸ªçŠ¶æ€ç çš„å«ä¹‰ï¼š 1XX ä¸´æ—¶æ¶ˆæ¯ 2XX è¿”å›žæˆåŠŸ 3XX é‡æ–°å®šå‘ 4XX å®¢æˆ·ç«¯é”™è¯¯ 5XX æœåŠ¡ç«¯é”™è¯¯ åŸºäºŽLNMPçš„ç½‘ç«™ä¸Šï¼Œå½“HTTPè¯·æ±‚è¿”å›žçš„çŠ¶æ€ç æ˜¯5XXçš„æ—¶å€™ï¼Œè¯´æ˜Žæ˜¯æœåŠ¡ç«¯å‡ºäº†é—®é¢˜ï¼›ä½†é—®é¢˜ä¸ä¸€å®šæ˜¯å‡ºåœ¨NginXï¼Œå› ä¸ºNginXæœ¬èº«ååˆ†è½»é‡ï¼Œä¸åšå¤ªå¤šçš„å¤æ‚é€»è¾‘å¤„ç†ï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šå‡ºé”™ï¼›é™¤äº†é™æ€èµ„æºçš„è¯·æ±‚ï¼Œå…¶ä»–å¤§éƒ¨åˆ†è¯·æ±‚NginXéƒ½ä¼šè½¬ç»™PHP-FPMæ¥å¤„ç†ï¼Œæ‰€ä»¥ä¸€èˆ¬é—®é¢˜æ˜¯æ›´å¤šåœ°å‡ºåœ¨PHPã€‚æ¯”å¦‚ï¼Œå¼€ç¯‡è¯´é‚£ä¸ªç½‘ç«™å‡ºçŽ°çš„502é”™è¯¯ï¼ŒæŸ¥çœ‹NginXæ—¥å¿—å‘çŽ°å¤§é‡çš„connect() to unix:/PATH/TO/PHP-FPM-SOCK failed (11: Resource temporarily unavailable)ï¼Œå…¶å®žåŽŸå› æ˜¯ç³»ç»Ÿæœ€å¤§è¿žæŽ¥æ•°è¿‡å°ã€‚ Linuxçš„å†…æ ¸ä¼˜åŒ–æŒ‰ç…§ã€Šé«˜æ€§èƒ½LinuxæœåŠ¡å™¨æž„å»ºå®žæˆ˜ï¼šè¿ç»´ç›‘æŽ§ã€æ€§èƒ½è°ƒä¼˜ä¸Žé›†ç¾¤åº”ç”¨ã€‹é‡Œçš„ä»‹ç»ï¼Œé…ç½®ç³»ç»Ÿå‚æ•°å¦‚ä¸‹ï¼š 123456789101112131415# /etc/sysctl.confnet.ipv4.tcp_max_tw_buckets = 6000net.ipv4.ip_local_port_range = 1024 65000net.ipv4.tcp_tw_recycle = 1net.ipv4.tcp_tw_reuse = 1net.ipv4.tcp_syncookies = 1net.core.somaxconn = 262144net.core.netdev_max_backlog = 262144net.ipv4.tcp_max_orphans = 262144net.ipv4.tcp_max_syn_backlog = 262144net.ipv4.tcp_synack_retries = 1net.ipv4.tcp_syn_retries = 1net.ipv4.tcp_fin_timeout = 1net.ipv4.tcp_keepalive_time = 30 ä¸ªäººä¿å®ˆèµ·è§ï¼Œå‚æ•°ç•¥æœ‰è°ƒæ•´ï¼š 12345678910111213141516# /etc/sysctl.confnet.core.somaxconn = 262144 # è¡¨ç¤ºç³»ç»ŸåŒæ—¶å‘èµ·çš„æœ€å¤§è¿žæŽ¥æ•°ï¼Œé»˜è®¤128net.core.netdev_max_backlog = 262144 # è¡¨ç¤ºå½“æ¯ä¸ªç½‘ç»œæŽ¥å£æŽ¥æ”¶æ•°æ®åŒ…çš„é€ŸçŽ‡æ¯”å†…æ ¸å¤„ç†è¿™äº›åŒ…çš„é€ŸçŽ‡å¿«æ—¶ï¼Œå…è®¸å‘é€åˆ°é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›®ï¼Œé»˜è®¤1000net.ipv4.ip_local_port_range = 32768 60999 # è¡¨ç¤ºå…è®¸ç³»ç»Ÿéšæœºæ‰“å¼€çš„ç«¯å£èŒƒå›´ï¼Œé»˜è®¤32768 60999net.ipv4.tcp_max_tw_buckets = 6000 # è¡¨ç¤ºç³»ç»ŸåŒæ—¶ä¿æŒtimewaitçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤524288net.ipv4.tcp_tw_recycle = 0 # å¼€å¯TCPè¿žæŽ¥ä¸­timewait socketsçš„å¿«é€Ÿå›žæ”¶ï¼Œé»˜è®¤ä¸å¼€å¯net.ipv4.tcp_tw_reuse = 1 # å¼€å¯TCPè¿žæŽ¥ä¸­timewait socketsé‡æ–°ç”¨äºŽæ–°çš„TCPè¿žæŽ¥ï¼Œé»˜è®¤ä¸å¼€å¯net.ipv4.tcp_max_orphans = 262144 # è¡¨ç¤ºç³»ç»Ÿä¸­ä¸è¢«å…³è”åˆ°ä»»ä½•ä¸€ä¸ªç”¨æˆ·æ–‡ä»¶å¥æŸ„ä¸Šçš„TCP socketsçš„æœ€å¤§æ•°ç›®ï¼Œå¯ä»¥é˜²æ­¢ç®€å•çš„DoSæ”»å‡»ï¼Œé»˜è®¤262144net.ipv4.tcp_max_syn_backlog = 262144 # è¡¨ç¤ºè®°å½•å°šæœªæ”¶åˆ°å®¢æˆ·ç«¯ç¡®è®¤ä¿¡æ¯çš„è¿žæŽ¥è¯·æ±‚çš„æœ€å¤§æ•°ç›®ï¼Œé»˜è®¤128net.ipv4.tcp_syncookies = 1 # å¼€å¯syncookiesåŠŸèƒ½ï¼Œå¯ä»¥é˜²æ­¢éƒ¨åˆ†SYNæ”»å‡»ï¼Œé»˜è®¤å¼€å¯net.ipv4.tcp_synack_retries = 1 # è¡¨ç¤ºç³»ç»Ÿæ”¾å¼ƒè¿žæŽ¥ä¹‹å‰å‘é€SYN+ACKåŒ…çš„æ•°é‡net.ipv4.tcp_syn_retries = 1 # è¡¨ç¤ºç³»ç»Ÿæ”¾å¼ƒè¿žæŽ¥ä¹‹å‰å‘é€SYNåŒ…çš„æ•°é‡net.ipv4.tcp_fin_timeout = 3 # è¡¨ç¤ºTCP socketsä¿æŒåœ¨FIN-WAIT-2çŠ¶æ€çš„æ—¶é—´ï¼Œé»˜è®¤60ç§’net.ipv4.tcp_keepalive_time = 30 # è¡¨ç¤ºå½“å¯ç”¨keepaliveçš„æ—¶å€™ï¼ŒTCPå‘é€keepaliveæ¶ˆæ¯çš„é¢‘åº¦ï¼Œé»˜è®¤7200ç§’ ä»¥ä¸Šå‚æ•°ä¸»è¦ä¸ºäº†é…åˆNginXã€PHP-FPMå’ŒMySQLè‡´å‘æŒ¥æ›´ä½³æ•ˆèƒ½ï¼Œå„ä¸ªå‚æ•°çš„æ•°å€¼åº”è¯¥æ ¹æ®å®žé™…ä¸»æœºç¡¬ä»¶æ¡ä»¶è‡ªè¡Œè°ƒæ•´ã€‚å°†é…ç½®å‚æ•°è¿½åŠ åˆ°/etc/sysctl.confæ–‡ä»¶åŽï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè®©ç³»ç»Ÿé‡è½½å‚æ•°ï¼š 1$ sudo sysctl -p NginXçš„é…ç½®ä¼˜åŒ–å¤§è‡´é…ç½®å¦‚ä¸‹ï¼š 123456789101112131415161718192021# /etc/nginx/nginx.confuser www-data; # æŒ‡å®šç”¨æˆ·worker_processes 8; # wokerè¿›ç¨‹æ•°ï¼Œä¸€èˆ¬è®¾ç½®ä¸ºCPUæ ¸æ•°*çº¿ç¨‹æ•°worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 0010000001000000 10000000; # ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…åˆ°æŒ‡å®šçš„CPUï¼Œé…åˆworker_processesä½¿ç”¨worker_rlimit_nofile 204800; # æ¯ä¸ªwokerèƒ½æ‰“å¼€çš„æœ€å¤šæ–‡ä»¶æè¿°ç¬¦æ•°ç›®pid /run/nginx.pid; # è¿›ç¨‹å·å­˜æ”¾ä½ç½®events &#123; use epoll; # è®¾ç½®ç”¨äºŽå¤ç”¨å®¢æˆ·ç«¯çº¿ç¨‹çš„è½®è¯¢æ–¹æ³• worker_connections 204800; # æ¯ä¸ªwokerçš„æœ€å¤šè¿žæŽ¥æ•°ç›®ï¼Œä¸è¦å¤§äºŽworker_rlimit_nofile multi_accept on; # å¯ç”¨æ”¶åˆ°ä¸€ä¸ªæ–°è¿žæŽ¥é€šçŸ¥åŽæŽ¥å—å°½å¯èƒ½å¤šçš„è¿žæŽ¥&#125;http &#123; keepalive_timeout 30; # server &#123; listen 80 backlog=204800; # &#125;&#125; å®žé™…ä¸ŠNginXçš„worker_connectionså‚æ•°ä¼šå—åˆ°ç³»ç»Ÿçš„net.core.somaxconnå‚æ•°é™åˆ¶ï¼Œè€Œnet.core.somaxconnå‚æ•°ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„ï¼ˆå¯ä»¥ç”¨ulimit -Hnå‘½ä»¤æŸ¥çœ‹ï¼‰ï¼Œç†è®ºä¸Šworker_connectionsåº”è¯¥è®¾ä¸ºnet.core.somaxconné™¤ä»¥worker_processesã€‚åœ¨é…åˆPHP-FPMä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æžœæƒ³NginXæ”¯æŒ1000å¹¶å‘è¯·æ±‚ï¼Œé‚£ä¹ˆworker_connectionså–å€¼ä¸èƒ½ä½ŽäºŽ2000ï¼Œå› ä¸ºæ¯ä¸ªè¯·æ±‚é‡Œï¼ŒNginXä¸Žå®¢æˆ·ç«¯éœ€è¦ä¸€ä¸ªè¿žæŽ¥ï¼Œä¸ŽPHP-FPMä¹Ÿéœ€è¦ä¸€ä¸ªè¿žæŽ¥ã€‚ PHP-FPMçš„é…ç½®ä¼˜åŒ–Unix socket VS TCP socketPHP-FPMæä¾›ä¸¤ç§é€šä¿¡æ–¹å¼ä¸ŽNginXå¯¹æŽ¥æ•°æ®ï¼Œä¸€ç§æ˜¯Unix socketï¼Œå¦ä¸€ç§æ˜¯TCP socketã€‚Unix socketæ˜¯åŒä¸€æ“ä½œç³»ç»Ÿä¸Šçš„ä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹è¿›è¡Œæ•°æ®é€šä¿¡çš„ç¼–ç¨‹æŽ¥å£ï¼Œè¿™ç§é€šä¿¡æ–¹å¼æ˜¯å‘ç”Ÿåœ¨ç³»ç»Ÿå†…æ ¸é‡Œè€Œä¸ä¼šåœ¨ç½‘ç»œé‡Œä¼ æ’­ï¼›TCP socketåˆ™æ˜¯åŸºäºŽTCP/IPåè®®ï¼Œè¿›ç¨‹é—´çš„é€šä¿¡æ˜¯é€šè¿‡ç½‘ç»œä¼ è¾“çš„ï¼Œå¯ä»¥è·¨ç³»ç»Ÿã€è·¨ä¸»æœºã€‚ä¸¤è€…ç›¸è¾ƒä¹‹ä¸‹ï¼ŒUnix socketæ›´ä½Žå±‚ï¼Œæ‰§è¡Œæ•ˆçŽ‡æ›´é«˜ï¼›è€ŒTCP socketå°è£…æ€§æ›´é«˜ï¼Œå®‰å…¨æ€§æ›´å¥½ã€‚å¦‚æžœNginXå’ŒPHP-FPMä¸åœ¨åŒä¸€ä¸»æœºä¸Šï¼Œé‚£ä¹ˆåªèƒ½é€‰æ‹©TCP socketï¼›å¦åˆ™ï¼Œå»ºè®®è€ƒè™‘Unix socketã€‚ æœ€å¤§è¿›ç¨‹æ•°å‡è®¾ä¸€ä¸ªPHP-FPMè¿›ç¨‹å ç”¨10MBå†…å­˜ï¼Œä¸”æ‰“ç®—åˆ†é…1GBå†…å­˜ç»™PHP-FPMç”¨ï¼Œé‚£ä¹ˆPHP-FPMçš„pm.pm.max_childrenå¯ä»¥è®¾ä¸º100ã€‚å½“ç„¶ï¼Œå®žé™…çš„æ¯ä¸ªPHP-FPMè¿›ç¨‹å¹³å‡æ‰€éœ€å†…å­˜è¦æ ¹æ®å®žé™…æƒ…å†µè®¡ç®—ã€‚ä½†PHP-FPMè¿›ç¨‹å¤šä¸ä¸€å®šæœ‰ç”¨ï¼Œæœ‰ç”¨æ˜¯æŒ‡PHP-FPMä¸ŽNginXä¹‹é—´æœ‰è¿žæŽ¥ï¼Œè€Œè¿žæŽ¥æ•°ä¹Ÿæ˜¯å—åˆ°ç³»ç»Ÿçš„net.core.somaxconnå‚æ•°é™åˆ¶ï¼ˆè¿žæŽ¥æ•°ä¸æ˜¯è¿›ç¨‹æ•°ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿žæŽ¥ï¼‰ã€‚ MySQLçš„é…ç½®ä¼˜åŒ–æœ€å¤§è¿žæŽ¥æ•°é¦–å…ˆï¼Œä¸ŽNginXã€PHP-FPMä¸åŒï¼ŒMySQLæ˜¯å¤šçº¿ç¨‹æ–¹å¼å·¥ä½œã€‚ä¸€èˆ¬MySQå¤„ç†è¿žæŽ¥çš„æ–¹å¼ï¼ˆthread_handlingï¼‰æœ‰æ¯ä¸ªè¿žæŽ¥ä¸€ä¸ªçº¿ç¨‹ï¼ˆone-connection-per-threadï¼‰å’Œæ‰€æœ‰è¿žæŽ¥ä¸€ä¸ªçº¿ç¨‹ï¼ˆno-threadsï¼‰ã€‚no-threadsæ¨¡å¼å¤§å¤šç”¨åœ¨è°ƒè¯•ï¼Œè€Œæ­£å¼çº¿ä¸ŠçŽ¯å¢ƒæ™®éé‡‡ç”¨çš„æ˜¯one-connection-per-threadæ¨¡å¼ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªPHP-FPMè¿›ç¨‹æœ€å¤šåªä¼šè·ŸMySQLå»ºç«‹ä¸€ä¸ªè¿žæŽ¥ï¼ŒMySQLçš„æœ€å¤§è¿žæŽ¥æ•°ï¼ˆmax_connectionsï¼‰ä¸åº”è¯¥å°‘äºŽPHP-FPMè¿›ç¨‹æ•°ï¼Œå¦åˆ™å¹¶å‘çš„æ—¶å€™æœ‰çš„PHP-FPMä¼šè¿žæŽ¥ä¸ä¸ŠMySQLã€‚å¯¹äºŽè¶Šæ¥è¶Šå¤§çš„å¹¶å‘é‡ï¼Œä¸èƒ½ä¸€å‘³æé«˜MySQLçš„æœ€å¤§è¿žæŽ¥æ•°ï¼Œåˆç†çš„æ–¹å¼æ˜¯ï¼Œè®¾å®šä¸€ä¸ªMySQLè¿žæŽ¥æ•°ç•Œé™ï¼Œè¶…å‡ºçš„è¿žæŽ¥è¯·æ±‚éœ€ç­‰å¾…ã€‚ çŸ­è¿žæŽ¥å’Œé•¿è¿žæŽ¥PHP-FPMä¸ŽMySQLä¹‹é—´çš„è¿žæŽ¥æœ‰ä¸¤ç§å½¢å¼ï¼Œåˆ†çŸ­è¿žæŽ¥å’Œé•¿è¿žæŽ¥ã€‚ MySQLåœ¨one-connection-per-threadæ¨¡å¼ä¸‹ï¼ŒPHP-FPMéœ€è¦è¯·æ±‚æ“ä½œæ•°æ®åº“æ—¶ï¼šå¦‚æžœPHP-FPMä½¿ç”¨çŸ­è¿žæŽ¥å½¢å¼ï¼Œé‚£ä¹ˆMySQLéƒ½ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ”¯æŒè¿™ä¸ªè¿žæŽ¥ï¼Œæ•°æ®æ“ä½œç»“æŸåŽï¼ŒPHP-FPMä¼šå›žæ”¶è¿™ä¸ªè¿žæŽ¥ï¼ŒMySQLä¹Ÿä¼šå›žæ”¶å¯¹åº”çš„çº¿ç¨‹ï¼Œè¿™é‡Œå°±ä¼šæœ‰ä¸€å®šçš„æ—¶é—´æ¶ˆè€—å’Œçš„IOæ¶ˆè€—ï¼›å¦‚æžœPHP-FPMä½¿ç”¨é•¿è¿žæŽ¥å½¢å¼ï¼Œåœ¨æ²¡æœ‰ç›¸åŒçš„é•¿è¿žæŽ¥çš„æƒ…å†µä¸‹ï¼ŒPHP-FPMæ‰ä¼šæ–°å»ºä¸€ä¸ªè¿žæŽ¥ï¼Œæ•°æ®æ“ä½œç»“æŸåŽè¿™ä¸ªçº¿ç¨‹ä¸ä¼šè¢«å›žæ”¶ï¼Œè€Œæ˜¯ç­‰å¾…è¢«å¤ç”¨ï¼Œè¿™æ ·è™½ç„¶ä¼šèŠ‚çœä¸€äº›å¼€é”€ï¼Œä½†æ˜¯åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¤§é‡çš„é•¿è¿žæŽ¥å»ºç«‹ä¸å›žæ”¶ï¼ŒMySQLä¹Ÿç®¡ç†åŒæ ·å¤šçš„çº¿ç¨‹ï¼Œå¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œèµ„æºç«žäº‰ï¼Œä¼šä½¿å¾—MySQLæ‰§è¡Œæ•ˆçŽ‡ä¸‹é™ã€‚ å¦‚æžœPHP-FPMé‡‡ç”¨åŠ¨æ€è¿›ç¨‹ç®¡ç†æ¨¡å¼ï¼Œä¸”æ‰€æœ‰è¿›ç¨‹éƒ½ä¸ŽMySQLé•¿è¿žæŽ¥çš„è¯ï¼Œé‚£ä¹ˆç©ºé—²æ—¶ï¼Œéƒ¨åˆ†PHP-FPMè¿›ç¨‹è¢«å›žæ”¶ï¼ˆä¸ŽMySQLçš„è¿žæŽ¥ä¹Ÿä¼šè¢«å›žæ”¶ï¼‰ï¼Œéƒ¨åˆ†PHP-FPMè¿›ç¨‹è¢«ä¿ç•™ä¸‹æ¥ï¼ˆä¸ŽMySQLçš„è¿žæŽ¥ä¹Ÿä¼šè¢«ä¿ç•™ä¸‹æ¥ï¼‰ï¼›é«˜å¹¶å‘æ—¶ï¼Œä¿ç•™ä¸‹æ¥çš„PHP-FPMè¿›ç¨‹å¯ä»¥å¤ç”¨å·²æœ‰çš„MySQLè¿žæŽ¥ï¼Œå…¶ä»–çš„é‡æ–°å»ºç«‹ï¼Œè¿™å°±ç›¸å½“äºŽæžç«¯é•¿è¿žæŽ¥å’Œæžç«¯çŸ­è¿žæŽ¥çš„æŠ˜ä¸­ã€‚ ä¸€èˆ¬çš„LNMPç½‘ç«™åº”ç”¨ä½¿ç”¨çŸ­è¿žæŽ¥è®¿é—®æ•°æ®åº“å°±è¶³å¤Ÿäº†ï¼Œç”¨å®Œå°±å›žæ”¶ï¼Œå‡è½»ç³»ç»Ÿè´Ÿæ‹…ï¼›ä¸­å¤§åž‹çš„å¯èƒ½éœ€è¦ä½¿ç”¨é•¿è¿žæŽ¥ï¼Œå› ä¸ºæ“ä½œæ•°æ®åº“çš„è¯·æ±‚ä¸æ–­å‘èµ·ï¼ŒæŠŠæ—¶é—´å’ŒIOèŠ±è´¹åœ¨å»ºç«‹æ–°è¿žæŽ¥å’Œå›žæ”¶æ—§è¿žæŽ¥å°±å¾ˆæµªè´¹ï¼Œä½†æ˜¯MySQLçš„çº¿ç¨‹æ•°ï¼ˆè¿žæŽ¥æ•°ï¼‰å¿…é¡»ç»´æŒåœ¨åˆç†èŒƒå›´å†…ã€‚ çº¿ç¨‹æ± å’Œè¿žæŽ¥æ± è¦åœ¨é«˜å¹¶å‘ä¸­ï¼ŒæŽ§åˆ¶MySQLçš„çº¿ç¨‹æ•°ï¼ˆè¿žæŽ¥æ•°ï¼‰ï¼Œä¸€èˆ¬çš„è§£å†³æ–¹æ¡ˆæ˜¯è®¾ç½®çº¿ç¨‹æ± æˆ–è€…è¿žæŽ¥æ± ã€‚ çº¿ç¨‹æ± æ˜¯åœ¨æ•°æ®æœåŠ¡ç«¯å»ºç«‹æœ‰é™æ•°é‡çš„çº¿ç¨‹ï¼Œæ¥å¤„ç†æ‰€æœ‰åº”ç”¨å®¢æˆ·ç«¯çš„è¿žæŽ¥ã€‚MySQLä¼ä¸šç‰ˆï¼ˆæ”¶è´¹ï¼‰æä¾›äº†çº¿ç¨‹æ± æœºåˆ¶ï¼ˆthread_handling=pool-of-threadsï¼‰ï¼Œè¯¦ç»†é…ç½®å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£MySQL Enterprise Thread Poolã€‚ è¿žæŽ¥æ± æ˜¯åœ¨åº”ç”¨å®¢æˆ·ç«¯ä¸Žæ•°æ®æœåŠ¡ç«¯ä¹‹é—´ï¼Œè®¾ç½®ä¸€ä¸ªä¸­é—´ä»£ç†ï¼Œè¿™ä¸ªä¸­é—´ä»£ç†ä¼šä¸Žæ•°æ®æœåŠ¡ç«¯å»ºç«‹æœ‰é™æ•°é‡çš„è¿žæŽ¥ï¼Œæ¥å¤„ç†æ‰€æœ‰åº”ç”¨å®¢æˆ·ç«¯çš„æ•°æ®è¯·æ±‚ã€‚è¿žæŽ¥æ± å¯ä»¥ä½¿ç”¨å¼€æºçš„æ•°æ®åº“ä¸­é—´ä»¶atlasæ¥æ­å»ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨PHPæ‰©å±•swooleæ¥è‡ªå·±å†™ä¸€ä¸ªã€‚ php-cpæ˜¯Swooleç»„ç»‡å¼€å‘çš„ä¸€ä¸ªPHPæ‰©å±•ï¼Œå¯ä»¥æœ¬åœ°ä»£ç†MySQLã€Redisè¿žæŽ¥ï¼Œæä¾›è¿žæŽ¥æ± ï¼Œè¯»å†™åˆ†ç¦»ï¼Œè´Ÿè½½å‡è¡¡ï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå¤§æ•°æ®å—æ—¥å¿—ç­‰åŠŸèƒ½ï¼Œåœ¨ä¸»æµphpæ¡†æž¶å¼•å…¥ä½¿ç”¨ä¹Ÿååˆ†ç®€ä¾¿ï¼Œå…·ä½“å¯ä»¥å‚è€ƒã€‚ å…¶ä»– å¹³æ—¶è¦å¤šç•™æ„LNMPçš„æ—¥å¿—ä¿¡æ¯ï¼Œæ ¹æ®æç¤ºä¼˜åŒ–é…ç½®ï¼Œæ¯”å¦‚ï¼š NginX(24: Too many open files)è¯´æ˜Žwork_rlimit_nofileå‚æ•°éœ€è¦å¢žå¤§ï¼› NginX(worker_connections are not enough while connecting to upstream)è¯´æ˜Žworker_connectionså‚æ•°éœ€è¦å¢žå¤§ï¼› NginX(11: Resource temporarily unavailable)ä¸€èˆ¬æ˜¯å¹¶å‘è¿žæŽ¥è¶…è¿‡æ¥ç³»ç»Ÿçš„net.core.somaxconné™åˆ¶ï¼› MySQL(too many connections)è¯´æ˜Žmax_connectionså‚æ•°éœ€è¦å¢žå¤§ï¼› MySQL(too many open files)è¯´æ˜Žopen_files_limitå‚æ•°éœ€è¦å¢žå¤§ï¼Œå½“ç„¶ç³»ç»Ÿçš„fs.file-maxä¹Ÿä¸èƒ½è¿‡å°ï¼› MySQL(has gone away)æ˜¯è¿žæŽ¥å¤ªä¹…æ²¡æ´»åŠ¨è¢«MySQLå›žæ”¶äº†ï¼ŒMySQLçš„wait_timeoutä¹Ÿä¸èƒ½è¿‡å°ã€‚ æœ€åŽæ­¤æ–‡çš„LNMPä¼˜åŒ–ä¸»è¦æ˜¯é’ˆå¯¹é«˜å¹¶å‘æƒ…å†µï¼Œå…¶ä»–æ–¹é¢ä¼˜åŒ–æœ‰æœºä¼šä¼šç»§ç»­è¡¥å……ã€‚]]></content>
      <categories>
        <category>æ±‚ç´¢</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>php</tag>
        <tag>nginx</tag>
        <tag>think</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è…¾è®¯äº‘COSçš„ä¸€æ¬¡å®žè·µ]]></title>
    <url>%2Fblog%2Fpractice-qcloud-cos.html</url>
    <content type="text"><![CDATA[å¾ˆå¤šç½‘ç«™éƒ½ä¼šéœ€è¦æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½çš„åŠŸèƒ½ï¼Œä½†æ˜¯æœåŠ¡å™¨æœ¬èº«é…ç½®ï¼ˆå¦‚å®¹é‡ã€å¸¦å®½ç­‰ç­‰ï¼‰å¯èƒ½æ‰›ä¸ä½å¤§é‡çš„ä¸Šä¼ ã€ä¸‹è½½ï¼Œè¿™æ—¶å€™ï¼Œåˆ©ç”¨ä¸€äº›çŽ°æˆçš„äº‘å­˜å‚¨æœåŠ¡æ¥åˆ†æ‹…ä¸€ä¸‹æœåŠ¡å™¨çš„åŽ‹åŠ›ã€‚è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹è…¾è®¯äº‘COSçš„ä½¿ç”¨ï¼Œå¤§æ¦‚çš„åŠŸèƒ½æµç¨‹æ˜¯ï¼š å‰ç«¯ï¼ˆJSï¼‰å®žçŽ°æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼› åŽç«¯ï¼ˆPHPï¼‰ç»™å‰ç«¯å‘æ”¾ç­¾åï¼Œä½¿å‰ç«¯å¯ä»¥ç›´æŽ¥è®¿é—®COSï¼› æ ¹æ®COSç”Ÿæˆçš„æ–‡ä»¶é“¾æŽ¥è®¿é—®æ–‡ä»¶ã€‚ PHPåŽç«¯ç­¾åæœºåˆ¶ä»¥Laravelé¡¹ç›®ä¸ºä¾‹ï¼šé¦–å…ˆï¼Œåœ¨é¡¹ç›®ç›®å½•ä¸‹ï¼Œæ–°å»ºç›®å½•app/Plugins/Qcloud/Cosï¼›ç„¶åŽï¼Œä¸‹è½½COSçš„PHP SDKï¼Œå°†SDKä¸­src/qcloud/cosä¸‹æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°é¡¹ç›®çš„app/Plugins/Qcloud/Cosä¸‹ï¼Œè¿™é‡Œåªç”¨åˆ°Auth.phpã€‚å¤§æ¦‚ä»£ç ï¼š routes/web.php 1234&lt;?phpRoute::post('/qcloud/cos/sign', 'QcloudController@postCosSign');Route::post('/qcloud/cos/sign-once', 'QcloudController@postCosSignOnce'); app/Plugins/Qcloud/Cos/Auth.php 1234567891011&lt;?php/** * Signature create related functions for authenticating with cos system. */namespace App\Plugins\QCloud\Cos;// åŠ ä¸Šå‘½åç©ºé—´/** * Auth class for creating reusable or nonreusable signature. */class Auth &#123; ...&#125; config/web.php 12345678910&lt;?php return [ 'qcloud_cos' =&gt; [ 'app_id' =&gt; '1234567890', 'secret_id' =&gt; '************************************', 'secret_key' =&gt; '********************************', 'region' =&gt; 'gz', //å¹¿å·ž 'timeout' =&gt; 60 ],]; QcloudController.php 123456789101112131415161718192021222324&lt;?phpuse App\Plugins\QCloud\Cos\Auth as CosAuth;class QcloudController extends Controller &#123;... // å¤šæ¬¡å¤ç”¨çš„ç­¾å public function postQcloudCosSign(Request $request) &#123; $team = $this-&gt;getAuthUser(); $bucket = $request-&gt;input('bucket'); $timeout = time()+2*60*60; $config = config('web.qcloud_cos'); $cos_auth = new CosAuth($config['app_id'], $config['secret_id'], $config['secret_key']); $sign = $cos_auth-&gt;createReusableSignature($timeout, $bucket); return $this-&gt;responseJSON(['sign'=&gt;$sign]); &#125; // å•æ¬¡ä½¿ç”¨çš„ç­¾å public function postQcloudCosSignOnce(Request $request) &#123; $bucket = $request-&gt;input('bucket'); $timeout = time()+2*60*60; $config = config('web.qcloud_cos'); $cos_auth = new CosAuth($config['app_id'], $config['secret_id'], $config['secret_key']); $sign = $cos_auth-&gt;createNonreusableSignature($bucket, '/'); return $this-&gt;responseJSON(['sign'=&gt;$sign]); &#125;&#125; JSå‰ç«¯ä¸Šä¼ æ–‡ä»¶ä¸‹è½½COSçš„JS SDKï¼Œå°†SDKä¸­dist/cos-js-sdk-v4.jså¤åˆ¶åˆ°é¡¹ç›®çš„public/jsä¸‹ï¼Œæ³¨æ„ä½¿ç”¨SDKéœ€è¦æµè§ˆå™¨æ”¯æŒHTML 5ã€‚å¤§æ¦‚ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt; &lt;title&gt;Demo&lt;/title&gt;&lt;/head&gt;&lt;body&gt; &lt;div&gt; &lt;input type="file" name="upload_file" id="upload_file" /&gt; &lt;button id="do_upload"&gt;è¯·ä¸Šä¼ &lt;/button&gt; &lt;span&gt;&lt;/span&gt; &lt;/div&gt; &lt;script type="text/javascript" src="/js/jquery.js"&gt;&lt;/script&gt; &lt;script type="text/javascript" src="/js/cos-js-sdk-v4.js"&gt;&lt;/script&gt; &lt;script type="text/javascript"&gt; var USERID = $('#user').data('id') var PREFIX = Date.now()+'_'+USERID+'_' var COS = new CosCloud(&#123; appid: '1234567890', bucket: 'public', region: 'gz', getAppSign: function (callback) &#123; $.post('/qcloud/cos/sign').done(function (data) &#123; var sign = data.sign callback(sign) &#125;).fail(function () &#123; B.alert('è¯·æ±‚å¤±è´¥ï¼Œç¨åŽå†è¯•') &#125;) &#125;, getAppSignOnce: function (callback) &#123; $.post('/qcloud/cos/sign-once').done(function (data) &#123; var sign = data.sign callback(sign) &#125;).fail(function () &#123; B.alert('è¯·æ±‚å¤±è´¥ï¼Œç¨åŽå†è¯•') &#125;) &#125; &#125;) $('#do_upload').click(function () &#123; var $this = $(this) var files = document.getElementById('upload_file').files if(!files.length || !files[0]) &#123; return 0 &#125; var file = files[0] if(file.size &amp;&amp; file.size &lt; 50*1024*1024) &#123; $this.prop('disabled', true) $this.text('å¼€å§‹ä¸Šä¼  ') COS.uploadFile(function (result) &#123; // successCallBack setTimeout(function() &#123; $this.prop('disabled', true) $this.text('è¯·ä¸Šä¼  ') &#125;, 1800) $this.text('ä¸Šä¼ æˆåŠŸ ') &#125;, function (result) &#123; // errorCallBack setTimeout(function() &#123; $this.prop('disabled', true) $this.text('è¯·ä¸Šä¼  ') &#125;, 1800) $this.text('ä¸Šä¼ å¤±è´¥ ') &#125;, function (current) &#123; // progressCallBack $this.text('æ­£åœ¨ä¸Šä¼  '+ (current*100).toFixed(1)+'%') &#125;, COS.bucket, PREFIX+file.name, file, 0) &#125; else &#123; B.alert('æ–‡ä»¶ä¸èƒ½å¤§äºŽ50MB') &#125; &#125;) &lt;/script&gt;&lt;/body&gt;&lt;/html&gt; å…¶ä»–é˜²ç›—é“¾å¦‚æžœä¸æƒ³å­˜åœ¨COSä¸Šçš„æ–‡ä»¶ï¼Œè¢«å…¶ä»–ç½‘ç«™ç›—ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨COSåŽå°ä¸Šç»™å¯¹åº”çš„å­˜å‚¨ç—›ï¼ˆBucketï¼‰è®¾ç½®Refererç™½åå•ï¼Œé˜²æ­¢è¢«æ¶æ„ç›—é“¾ã€‚å½“ç„¶ï¼Œä¼ªé€ Refererçš„è¯·æ±‚åº”è¯¥ä¹Ÿé˜²ä¸äº†ã€‚ å®šæ—¶æ¸…ç†å› ä¸ºå‰ç«¯å¯ä»¥ç›´æŽ¥ä¸ŽCOSè¿žæŽ¥ï¼Œä¸Šä¼ çš„æ–‡ä»¶æ²¡æœ‰ç»è¿‡åŽç«¯æ£€éªŒï¼Œæ‰€ä»¥æœ‰æ•ˆçš„ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯éƒ½åº”è¯¥è®°å½•åœ¨æ•°æ®åº“é‡Œï¼Œç„¶åŽåœ¨æ¯å¤©ç©ºé—²æ—¶æ®µå°†æ˜¨å¤©ä¸Šä¼ çš„æ–‡ä»¶éƒ½éåŽ†ä¸€éï¼ˆæ–‡ä»¶åå‰ç¼€è®¾ä¸ºæ—¥æœŸå°±å¯ä»¥æ®æ­¤æ£€ç´¢ï¼‰ï¼Œä¸è®°å½•åœ¨åº“çš„ã€ç±»åž‹ä¸åŒ¹é…çš„ï¼Œä½“ç§¯è¿‡å¤§çš„ç­‰æ­¤ç±»æ–‡ä»¶éƒ½å¯ä»¥åˆ é™¤ã€‚ æœ€åŽä¸€ä¸ªç½‘ç«™æœ¬èº«è¦å®žçŽ°æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½åŠŸèƒ½å¹¶ä¸éš¾ï¼Œä½†æ˜¯æ€»æ˜¯ä¼šæœ‰å„æ ·çš„éšæ‚£ï¼ˆå¯å‚è€ƒHTTPæ–‡ä»¶ä¸Šä¼ çš„ä¸€ä¸ªåŽç«¯å®Œå–„æ–¹æ¡ˆï¼ˆNginXï¼‰ï¼‰ã€‚äºŽæ­¤ï¼Œå€Ÿç”¨çŽ°æˆçš„äº‘å­˜å‚¨æœåŠ¡æ¥å®žçŽ°æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½åŠŸèƒ½ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„å¯è¡Œæ–¹æ¡ˆã€‚]]></content>
      <categories>
        <category>å®žè·µ</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>php</tag>
        <tag>practice</tag>
        <tag>qcloud</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[HTTPæ–‡ä»¶ä¸Šä¼ çš„ä¸€ä¸ªåŽç«¯å®Œå–„æ–¹æ¡ˆï¼ˆNginXï¼‰]]></title>
    <url>%2Fblog%2Fscheme-nginx-php-js-upload-process.html</url>
    <content type="text"><![CDATA[å¾ˆå¤šç½‘ç«™éƒ½ä¼šæœ‰ä¸Šä¼ æ–‡ä»¶çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ä¸Šä¼ ç”¨æˆ·å¤´åƒï¼Œä¸Šä¼ ä¸ªäººç®€åŽ†ç­‰ç­‰ï¼Œé™¤éžæ˜¯ç½‘ç›˜ç±»çš„ç½‘ç«™ï¼Œä¸€èˆ¬ä¸Šä¼ æ–‡ä»¶ä¸ä¼šä½œä¸ºç½‘ç«™çš„ä¸»è¦åŠŸèƒ½ï¼›è€Œä¸”ï¼Œå¦‚ä»Šå¤§ä¼—çš„ç½‘é€Ÿå·²ç»æ˜¯è¶³å¤Ÿçš„å¿«ï¼Œä¸Šä¼ å‡ ç™¾KBçš„æ–‡ä»¶ï¼Œå‡ ä¹Žå¯ä»¥ç§’å†…å®Œæˆã€‚æ‰€ä»¥ï¼Œå¤§å¤šæ•°ç½‘ç«™ï¼Œå¯¹äºŽä¸Šä¼ æ–‡ä»¶çš„å¤„ç†ï¼Œéƒ½æ˜¯ç®€å•çš„å‰ç«¯POSTä¸Šä¼ ï¼ŒåŽç«¯éªŒè¯å­˜æ”¾ç„¶åŽè¿”å›žè®¿é—®åœ°å€ã€‚æ¯•ç«Ÿï¼Œæ–‡ä»¶å°ï¼Œç½‘é€Ÿå¿«ï¼Œä¸€çž¬é—´çš„äº‹æƒ…è°ä¼šå¤šåœ¨æ„å‘¢ï¼Ÿ å­˜åœ¨é—®é¢˜å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç½‘ç«™ï¼ŒåŸºäºŽNginX+PHP+JSæž„æž¶ï¼Œç½‘ç«™å…è®¸ç”¨æˆ·ä¸Šä¼ ä¸€äº›å°è§†é¢‘ã€éŸ³ä¹æˆ–è€…PPTç­‰æ–‡ä»¶åœ¨çº¿ä¸Šå±•ç¤ºï¼Œå•ä¸ªæ–‡ä»¶å¤§å°é™åˆ¶ä¸è¶…è¿‡30MBï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦æ€Žæ ·å®žçŽ°è¿™ä¸ªä¸Šä¼ åŠŸèƒ½å‘¢ï¼Ÿ é™åˆ¶ä¸Šä¼ æ–‡ä»¶çš„å¤§å°é¦–å…ˆï¼ŒNginXè¦èƒ½æŽ¥å—æœ€å¤§32MBçš„è¯·æ±‚ï¼ˆé™¤äº†æœ€å¤§æ–‡ä»¶æœ¬èº«30MBï¼Œå†é¢„ç•™ä¸€äº›ç»™å…¶ä»–è¯·æ±‚å‚æ•°ï¼‰ï¼Œæˆ‘ä»¬ä¼šä¿®æ”¹ç½‘ç«™çš„è™šæ‹Ÿä¸»æœºé…ç½®ï¼š 12345# website.confserver&#123; client_max_body_size 32M; ...&#125; ç„¶åŽï¼ŒPHPä¹Ÿè¦ä¿®æ”¹é…ç½®ï¼ŒæŽ¥å—æœ€å¤§30MBçš„æ–‡ä»¶ä¸Šä¼ å’Œæœ€å¤§32MBçš„POSTè¯·æ±‚ï¼š 123# php.iniupload_max_filesize = 30M;post_max_size = 32M; å…¶å®žï¼Œå•å‡­client_max_body_sizeï¼ŒNginXæ˜¯ä¸èƒ½çœŸæ­£é™åˆ¶ä¸Šä¼ æ–‡ä»¶å¤§å°çš„ï¼Œå› ä¸ºNginXä¼šå…ˆè®©å®¢æˆ·ç«¯ï¼ˆä¸€èˆ¬æ˜¯æµè§ˆå™¨ï¼‰å¼€å§‹ä¸Šä¼ è¯·æ±‚ï¼Œç›´åˆ°ä¸Šä¼ çš„å†…å®¹å¤§å°è¶…è¿‡äº†é™åˆ¶ï¼ŒNginXæ‰ä¼šä¸­æ­¢ä¸Šä¼ ï¼ŒæŠ¥413 Request Entity Too Largeé”™è¯¯ï¼Œæ²¡è¶…è¿‡é™åˆ¶åˆ™äº¤ç»™PHPå¤„ç†ã€‚äºŽæ˜¯ï¼ŒPHPçš„upload_max_filesizeå’Œpost_max_sizeå°±æ›´æ²¡ç”¨äº†ï¼Œå› ä¸ºPHPèŽ·å–åˆ°æ–‡ä»¶ä¿¡æ¯çš„æ—¶å€™ï¼Œä¸Šä¼ è¿‡ç¨‹å·²ç»ç»“æŸäº†ï¼ˆè¿™æ—¶å½“ç„¶æ˜¯ä¸Šä¼ æˆåŠŸï¼ŒNginXä¸­æ­¢è¯·æ±‚çš„è¯PHPä¸ä¼šè¿›åœºï¼‰ã€‚åœ¨NginXä¼ é€’è¯·æ±‚ç»“æžœå‰ï¼ŒPHPä»€ä¹ˆï¼ˆæ¯”å¦‚éªŒè¯ç”¨æˆ·ï¼ŒéªŒè¯æƒé™ç­‰ç­‰ï¼‰éƒ½åšä¸äº†ã€‚ å¦‚æžœç”¨æˆ·ä¸Šä¼ äº†ä¸€ä¸ªå¤§äºŽ32MBçš„æ—¶å€™ï¼Œç›´åˆ°ä¸Šä¼ åˆ°32MBçš„æ—¶å€™æ‰èƒ½å‘Šè¯‰ç”¨æˆ·æ–‡ä»¶è¿‡å¤§äº†ï¼Œé‚£ä¹ˆå‰é¢çš„æ—¶é—´ç”¨æˆ·ä¸å°±ç™½ç­‰äº†å—ï¼Ÿè€Œä¸”æœåŠ¡å™¨çš„å¸¦å®½è¿˜æ˜¯ä¸€æ ·è¢«æ¶ˆè€—äº†ã€‚æˆ‘ä»¬æ›´å¸Œæœ›åœ¨ä¸Šä¼ å¼€å§‹å‰å°±èƒ½å‘Šè¯‰ç”¨æˆ·æ–‡ä»¶è¿‡å¤§äº†ã€‚å¾ˆå¤šç½‘ç«™å¼€å‘ï¼Œéƒ½ä¼šæŠŠè¿™ä¸€æ­¥äº¤ç»™JSå¤„ç†ï¼Œåœ¨æ–°åž‹æµè§ˆå™¨(æ”¯æŒHTML5)é‡Œï¼ŒJSçš„ç¡®å¯ä»¥èŽ·å–inputæ–‡ä»¶çš„å¤§å°ï¼›åœ¨æ—§çš„IEé‡Œï¼Œä¹Ÿå¯ä»¥é€šè¿‡ActiveXæ¥å®žçŽ°ã€‚ä½†æ˜¯JSçš„é™åˆ¶å¤„ç†å¾ˆå®¹æ˜“è¢«ç»•è¿‡åŽ»ï¼Œåªè¦çŸ¥é“ä¸Šä¼ åœ°å€ï¼Œä¸€ä¸ªformæ ‡ç­¾å°±èƒ½æŠŠæ–‡ä»¶ä¼ è¿‡åŽ»ï¼š 1234&lt;form id=&quot;upload_form&quot; action=&quot;/path/to/upload&quot; enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt; &lt;input type=&quot;file&quot; name=&quot;upload_file&quot; value=&quot;/path/of/big/big/file&quot; /&gt; &lt;input type=&quot;submit&quot; value=&quot;Upload&quot; /&gt;&lt;/form&gt; æ­£å¸¸çš„ç”¨æˆ·å½“ç„¶ä¸ä¼šè¿™æ ·åšï¼Œä½†æ˜¯æœ‰æ„æ”»å‡»ç½‘ç«™çš„äººä¼šã€‚ é™åˆ¶ä¸Šä¼ æ–‡ä»¶çš„é€Ÿåº¦å¦‚æžœæœåŠ¡å™¨çš„å…¥å£å¸¦å®½æ˜¯100mbpsï¼Œç”¨æˆ·çš„ä¸Šè¡Œå¸¦å®½æ˜¯10mbpsï¼Œç”¨æˆ·ä¸Šä¼ ä¸€ä¸ª30MBçš„æ–‡ä»¶è‡³å°‘éœ€è¦30ç§’ï¼Œé‚£ä¹ˆåœ¨30ç§’å†…ï¼ŒæœåŠ¡å™¨çš„å¸¦å®½åªèƒ½æ»¡è¶³10ä¸ªç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ï¼Œå¸¦å®½è¢«å æ»¡åŽï¼ŒæœåŠ¡å™¨å°±å¾ˆéš¾å†å¤„ç†å…¶ä»–è¯·æ±‚äº†ã€‚æ‰€ä»¥ï¼Œé™åˆ¶ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶çš„é€Ÿåº¦å°±å¾ˆæœ‰å¿…è¦ã€‚ç›®å‰ï¼ŒJSåšä¸åˆ°é™åˆ¶ä¸Šä¼ æ–‡ä»¶çš„é€Ÿåº¦ï¼ŒPHPä¹Ÿåšä¸åˆ°ã€‚ ä¸Šä¼ æ–‡ä»¶çš„è¿›åº¦ç”¨æˆ·ä¸Šä¼ ä¸€ä¸ª30MBçš„æ–‡ä»¶è‡³å°‘éœ€è¦30ç§’ï¼Œé‚£ä¹ˆ30ç§’å†…åº”è¯¥å‘ŠçŸ¥ç”¨æˆ·ä¸Šä¼ çš„è¿›åº¦ï¼Œä¸èƒ½è®©ç”¨æˆ·æ— æ„ŸçŸ¥çš„ç­‰å¾…ã€‚HTML5æ”¹è¿›äº†XMLHttpRequestå¯¹è±¡ï¼Œåœ¨æ”¯æŒHTML5çš„æ–°åž‹æµè§ˆå™¨é‡Œï¼ŒJSå¯ä»¥èŽ·å–XMLHttpRequestä¸Šä¼ æ–‡ä»¶çš„è¿›åº¦ï¼›åœ¨æ—§çš„æµè§ˆå™¨çš„ä¹Ÿå¯ä»¥é€šè¿‡Flashä¸ŽJSç»“åˆï¼ˆæ¯”å¦‚SWFUploadï¼‰ï¼Œä»Žè€ŒèŽ·å–ä¸Šä¼ æ–‡ä»¶çš„è¿›åº¦ã€‚ä½†æ˜¯æ–°åž‹æµè§ˆå™¨é‡Œï¼ŒFlashå·²ç»è¢«æ‘’å¼ƒäº†ï¼Œå› è€Œè¦æ”¯æŒæ–°æ—§æµè§ˆå™¨ï¼ŒJSå°±è¦å†™æˆä¸¤å¥—ä»£ç ã€‚åœ¨è¿™é‡ŒPHPä¹Ÿæ˜¯å¸®ä¸ä¸Šå¿™ï¼Œå› ä¸ºPHPæ‹¿åˆ°ä¼ æ–‡ä»¶ä¿¡æ¯çš„æ—¶å€™ï¼Œä¸Šä¼ å·²ç»ç»“æŸäº†ã€‚ è§£å†³æ–¹æ¡ˆç½‘ç«™æ˜¯NginX+PHP+JSæž„æž¶çš„ï¼ŒPHPå’ŒJSè§£å†³ä¸äº†çš„é—®é¢˜ï¼Œé‚£åº”è¯¥åœ¨NginXä¸Šè§£å†³å®ƒã€‚NginXè™½ç„¶æ˜¯ä¸€ä¸ªçŽ°æˆçš„è½¯ä»¶ï¼Œä½†æ˜¯å®ƒè¿˜æ˜¯å¯ä»¥ç»§ç»­æ‰©å±•å’Œä¿®æ”¹çš„ã€‚NginXæœ¬èº«æ²¡æœ‰æä¾›ä¸Šä¼ æ–‡ä»¶çš„å¤æ‚å¤„ç†åŠŸèƒ½ï¼Œè€Œåœ¨NginXå®˜æ–¹è®¤å¯çš„ç¬¬ä¸‰æ–¹æ‰©å±•æ¨¡å—é‡Œï¼Œæœ‰ä¸¤ä¸ªæ¨¡å—å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®žçŽ°å¤æ‚çš„ä¸Šä¼ æ–‡ä»¶åŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯nginx-upload-moduleå’Œnginx-upload-progress-moduleã€‚ è¦å°†nginx-upload-moduleå’Œnginx-upload-progress-moduleç¼–è¯‘è¿›NginXï¼Œé¦–å…ˆè¦ä¸‹è½½NginXæºç å’Œnginx-upload-moduleã€nginx-upload-progress-moduleè¿™ä¸¤ä¸ªæ¨¡å—çš„æºç ï¼Œç„¶åŽåœ¨NginXæºç ç›®å½•ä¸­ï¼Œåœ¨configureå‚æ•°ä¸­åŠ å…¥è¿™ä¸¤ä¸ªè¿™ä¸¤ä¸ªæ¨¡å—ï¼Œæœ€åŽmake installï¼Œå¤§æ¦‚çš„æ‰§è¡Œå‘½ä»¤ï¼š 1234567891011$ cd ~$ mkdir tmp$ cd tmp$ wget http://nginx.org/download/nginx-1.11.3.tar.gz$ tar -xvzf nginx-1.11.3.tar.gz$ git clone https://github.com/vkholodkov/nginx-upload-module.git$ git clont https://github.com/masterzen/nginx-upload-progress-module.git$ cd nginx-1.11.3$ ./configure --add-module=~/tmp/nginx-upload-module --add-module~/tmp/nginx-upload-progress-module ...$ make$ make install å¦‚æžœç³»ç»Ÿä¸Šå·²ç»å®‰è£…è¿‡NginXå¹¶ä¸”æ‰€å®‰è£…NginXç‰ˆæœ¬æ”¯æŒåŠ¨æ€æ¨¡å—ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘å°†nginx-upload-moduleå’Œnginx-upload-progress-moduleç¼–è¯‘æˆåŠ¨æ€æ¨¡å—ï¼Œè¿™æ ·å°±ä¸éœ€è¦é‡æ–°å®‰è£…NginXã€‚nginx-module-libsä¸Šæœ‰Ubuntuç³»ç»Ÿä¸Šä¸»çº¿NginXç‰ˆæœ¬çš„ä¸€äº›åŠ¨æ€æ¨¡å—ï¼Œå¯ä»¥ä¸Šé¢ä¸‹è½½é€‚é…ä½ çš„nginx-upload-moduleå’Œnginx-upload-progress-moduleã€‚ ä¸‹é¢ä¸»è¦ä»‹ç»ä¸€ä¸‹ä¸¤ä¸ªæ¨¡å—çš„ç”¨æ³•ï¼š nginx-upload-moduleå½“ä¸Šä¼ æ–‡ä»¶çš„ä½“ç§¯å°äºŽclient_max_body_sizeæ—¶ï¼Œ nginx-upload-moduleå¯ä»¥å¸®åŠ©æˆ‘ä»¬é™åˆ¶ä¸Šä¼ é€Ÿåº¦ï¼Œä½¿ç”¨æ–¹æ³•è§ä¸‹ã€‚NginXçš„ç«™ç‚¹é…ç½®ï¼š 1234567891011121314151617181920212223242526272829303132333435# website.confserver &#123; ... client_max_body_size 32m; # é™åˆ¶ä¸Šä¼ é€Ÿåº¦æœ€å¤§2Mbps upload_limit_rate 256k; location /upload &#123; # é™åˆ¶ä¸Šä¼ æ–‡ä»¶æœ€å¤§30MB upload_max_file_size 30m; # åŽç»­äº¤ç»™ upload.php å¤„ç† upload_pass /upload.php; # æŒ‡å®šä¸Šä¼ æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œ1è¡¨ç¤ºæŒ‰1ä½æ•£åˆ—ï¼Œå°†ä¸Šä¼ æ–‡ä»¶éšæœºå­˜åˆ°æŒ‡å®šç›®å½•ä¸‹çš„0ã€1ã€2ã€...ã€8ã€9ç›®å½•ä¸­ï¼ˆè¿™äº›ç›®å½•è¦æ‰‹åŠ¨å»ºç«‹ï¼‰ upload_store /tmp 1; # ä¸Šä¼ æ–‡ä»¶çš„è®¿é—®æƒé™ï¼Œuser:rè¡¨ç¤ºç”¨æˆ·åªè¯» upload_store_access user:r; # è®¾ç½®è¯·æ±‚ä½“çš„å­—æ®µ upload_set_form_field "$&#123;upload_field_name&#125;_name" "$upload_file_name"; upload_set_form_field "$&#123;upload_field_name&#125;_content_type" "$upload_content_type"; upload_set_form_field "$&#123;upload_field_name&#125;_path" "$upload_tmp_path"; # æŒ‡ç¤ºåŽç«¯å…³äºŽä¸Šä¼ æ–‡ä»¶çš„md5å€¼å’Œæ–‡ä»¶å¤§å° upload_aggregate_form_field "$&#123;upload_field_name&#125;_md5" "$upload_file_md5"; upload_aggregate_form_field "$&#123;upload_field_name&#125;_size" "$upload_file_size"; upload_pass_form_field "^submit$|^description$"; # è‹¥å‡ºçŽ°å¦‚ä¸‹é”™è¯¯ç åˆ™åˆ é™¤ä¸Šä¼ çš„æ–‡ä»¶ upload_cleanup 400 404 499 500-505; &#125;&#125; ä¸Šä¼ æ–‡ä»¶çš„é¡µé¢ï¼š 1234&lt;form id="upload" enctype="multipart/form-data" action="/upload" method="post" &gt; &lt;input name="upload_file" type="file" label="fileupload" /&gt; &lt;input type="submit" value="Upload File" /&gt;&lt;/form&gt; å¤„ç†ä¸Šä¼ ç»“æžœçš„è„šæœ¬ï¼š 123&lt;?php// upload.phpprint_r($_REQUEST); å¦‚æžœå¯¹PHPè§£æžä½¿ç”¨äº†ä¼˜é›…é“¾æŽ¥ï¼Œæ¯”å¦‚Laravelï¼Œé‚£ä¹ˆåº”è¯¥è¿™æ ·ä½¿ç”¨ï¼š NginXçš„ç«™ç‚¹é…ç½®ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849# website.confserver &#123; ... client_max_body_size 32m; # é™åˆ¶ä¸Šä¼ é€Ÿåº¦æœ€å¤§2Mbps upload_limit_rate 256k; location / &#123; try_files $uri $uri/ /index.php?$query_string; &#125; location ~ \.php$ &#123; include snippets/fastcgi-php.conf; fastcgi_param HTTP_PROXY ""; fastcgi_pass unix:/run/php/php-fpm.sock; &#125; location @upload_handle &#123; rewrite ^ /index.php last; &#125; location /upload &#123; # é™åˆ¶ä¸Šä¼ æ–‡ä»¶æœ€å¤§30MB upload_max_file_size 30m; # åŽç»­äº¤ç»™ index.php å¤„ç† upload_pass @upload_handle; # æŒ‡å®šä¸Šä¼ æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œ1è¡¨ç¤ºæŒ‰1ä½æ•£åˆ—ï¼Œå°†ä¸Šä¼ æ–‡ä»¶éšæœºå­˜åˆ°æŒ‡å®šç›®å½•ä¸‹çš„0ã€1ã€2ã€...ã€8ã€9ç›®å½•ä¸­ï¼ˆè¿™äº›ç›®å½•è¦æ‰‹åŠ¨å»ºç«‹ï¼‰ upload_store /tmp 1; # ä¸Šä¼ æ–‡ä»¶çš„è®¿é—®æƒé™ï¼Œuser:rè¡¨ç¤ºç”¨æˆ·åªè¯» upload_store_access user:r; # è®¾ç½®è¯·æ±‚ä½“çš„å­—æ®µ upload_set_form_field "$&#123;upload_field_name&#125;_name" "$upload_file_name"; upload_set_form_field "$&#123;upload_field_name&#125;_content_type" "$upload_content_type"; upload_set_form_field "$&#123;upload_field_name&#125;_path" "$upload_tmp_path"; # æŒ‡ç¤ºåŽç«¯å…³äºŽä¸Šä¼ æ–‡ä»¶çš„md5å€¼å’Œæ–‡ä»¶å¤§å° upload_aggregate_form_field "$&#123;upload_field_name&#125;_md5" "$upload_file_md5"; upload_aggregate_form_field "$&#123;upload_field_name&#125;_size" "$upload_file_size"; upload_pass_form_field "^submit$|^description$"; # è‹¥å‡ºçŽ°å¦‚ä¸‹é”™è¯¯ç åˆ™åˆ é™¤ä¸Šä¼ çš„æ–‡ä»¶ upload_cleanup 400 404 499 500-505; &#125;&#125; ä¸Šä¼ æ–‡ä»¶çš„é¡µé¢ï¼š 12345&lt;!-- laravel blade.php --&gt;&lt;form id="upload?_token=&#123;&#123;csrf_token()&#125;&#125;" enctype="multipart/form-data" action="/upload" method="post" &gt; &lt;input name="upload_file" type="file" label="fileupload" /&gt; &lt;input type="submit" value="Upload File" /&gt;&lt;/form&gt; Laravelè·¯ç”±é…ç½®ï¼š 123&lt;?php// routes/web.phpRoute::post('/upload', 'Web\IndexController@upload')-&gt;name('upload'); LaravelæŽ§åˆ¶å™¨ä¸­å¤„ç†ä¸Šä¼ çš„æ–¹æ³•ï¼š 12345&lt;?php// Web/IndexController.phpfunction upload() &#123; dump(request());&#125; nginx-upload-progress-modulenginx-upload-progress-moduleå¯ä»¥å¸®åŠ©æˆ‘ä»¬è·Ÿè¸ªä¸Šä¼ çš„è¿›åº¦ï¼Œä½¿ç”¨æ–¹æ³•è§ä¸‹ã€‚ NginXçš„ç«™ç‚¹é…ç½®ï¼š 123456789101112131415161718# website.confserver &#123; ... client_max_body_size 32m; # å¼€è¾Ÿä¸€ä¸ªç©ºé—´proxiedæ¥å­˜å‚¨è·Ÿè¸ªä¸Šä¼ çš„ä¿¡æ¯1MB upload_progress proxied 1m; location ^~ /progress &#123; # æŠ¥å‘Šä¸Šä¼ çš„ä¿¡æ¯ report_uploads proxied; &#125; location /upload &#123; ... # ä¸Šä¼ å®ŒæˆåŽï¼Œä»ç„¶ä¿å­˜ä¸Šä¼ ä¿¡æ¯5s track_uploads proxied 5s; &#125;&#125; ä¸Šä¼ æ–‡ä»¶çš„é¡µé¢å’Œæ¯éš”ä¸€ç§’æŸ¥è¯¢ä¸€ä¸‹ä¸Šä¼ è¿›åº¦çš„è„šæœ¬ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152&lt;form id="upload" enctype="multipart/form-data" action="/upload" method="post" onsubmit="openProgressBar(); return true;"&gt; &lt;input name="userfile" type="file" label="fileupload" /&gt; &lt;input type="submit" value="Upload File" /&gt;&lt;/form&gt;&lt;div&gt; &lt;div id="progress" style="width: 400px; border: 1px solid black"&gt; &lt;div id="progressbar" style="width: 1px; background-color: black; border: 1px solid white"&gt;&amp;nbsp;&lt;/div&gt; &lt;/div&gt; &lt;div id="tp"&gt;(progress)&lt;/div&gt;&lt;/div&gt;&lt;script type="text/javascript"&gt; var interval = null; var uuid = ""; function openProgressBar() &#123; for (var i = 0; i &lt; 32; i++) &#123; uuid += Math.floor(Math.random() * 16).toString(16); &#125; document.getElementById("upload").action = "/upload?X-Progress-ID=" + uuid; /* æ¯éš”ä¸€ç§’æŸ¥è¯¢ä¸€ä¸‹ä¸Šä¼ è¿›åº¦ */ interval = window.setInterval(function () &#123; fetch(uuid); &#125;, 1000); &#125; function fetch(uuid) &#123; var req = new XMLHttpRequest(); req.open("GET", "/progress", 1); req.setRequestHeader("X-Progress-ID", uuid); req.onreadystatechange = function () &#123; if (req.readyState == 4) &#123; if (req.status == 200) &#123; var upload = eval(req.responseText); document.getElementById('tp').innerHTML = upload.state; /* æ›´æ–°è¿›åº¦æ¡ */ if (upload.state == 'done' || upload.state == 'uploading') &#123; var bar = document.getElementById('progressbar'); var w = 400 * upload.received / upload.size; bar.style.width = w + 'px'; &#125; /* ä¸Šä¼ å®Œæˆï¼Œä¸å†æŸ¥è¯¢è¿›åº¦ */ if (upload.state == 'done') &#123; window.clearTimeout(interval); &#125; if (upload.state == 'error') &#123; window.clearTimeout(interval); alert('something wrong'); &#125; &#125; &#125; &#125; req.send(null); &#125;&lt;/script&gt; å½“ä¸Šä¼ æ–‡ä»¶çš„ä½“ç§¯å¤§äºŽclient_max_body_sizeæ—¶ï¼Œ nginx-upload-moduleæœªèƒ½å¸®æˆ‘ä»¬ç«‹åˆ»ä¸­æ–­ä¸Šä¼ ï¼Œå¹¶ä¸”ä¸èƒ½é™åˆ¶ä¸Šä¼ é€Ÿåº¦ï¼Œä½†æ˜¯nginx-upload-progress-moduleå¯ä»¥å‘å‰ç«¯æŠ¥å‘Šæ–‡ä»¶è¿‡å¤§çš„é”™è¯¯ï¼Œå‰ç«¯å¯ä»¥è¿™æ ·å­æ¥ä¸­æ–­ä¸Šä¼ ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960&lt;form id="upload" enctype="multipart/form-data" action="/upload" method="post" onsubmit="openProgressBar(); return false;"&gt; &lt;input name="userfile" type="file" label="fileupload" id="userfile" /&gt; &lt;input type="submit" value="Upload File" /&gt;&lt;/form&gt;&lt;div&gt; &lt;div id="progress" style="width: 400px; border: 1px solid black"&gt; &lt;div id="progressbar" style="width: 1px; background-color: black; border: 1px solid white"&gt;&amp;nbsp;&lt;/div&gt; &lt;/div&gt; &lt;div id="tp"&gt;(progress)&lt;/div&gt;&lt;/div&gt;&lt;script type="text/javascript"&gt; var interval = null; var uuid = ""; var uploadxhr = null; function openProgressBar() &#123; for (var i = 0; i &lt; 32; i++) &#123; uuid += Math.floor(Math.random() * 16).toString(16); &#125; var action = "/upload?X-Progress-ID=" + uuid; var file = document.getElementById('userfile').files[0]; uploadxhr = new XMLHttpRequest(); // uploadxhr.file = file; uploadxhr.open('post', action, true); uploadxhr.setRequestHeader("Content-Type","multipart/form-data"); uploadxhr.send(file); /* æ¯éš”ä¸€ç§’æŸ¥è¯¢ä¸€ä¸‹ä¸Šä¼ è¿›åº¦ */ interval = window.setInterval(function () &#123; fetch(uuid); &#125;, 1000); &#125; function fetch(uuid) &#123; var req = new XMLHttpRequest(); req.open("GET", "/progress", 1); req.setRequestHeader("X-Progress-ID", uuid); req.onreadystatechange = function () &#123; if (req.readyState == 4) &#123; if (req.status == 200) &#123; var upload = eval(req.responseText); document.getElementById('tp').innerHTML = upload.state; /* æ›´æ–°è¿›åº¦æ¡ */ if (upload.state == 'done' || upload.state == 'uploading') &#123; var bar = document.getElementById('progressbar'); var w = 400 * upload.received / upload.size; bar.style.width = w + 'px'; &#125; /* ä¸Šä¼ å®Œæˆï¼Œä¸å†æŸ¥è¯¢è¿›åº¦ */ if (upload.state == 'done') &#123; window.clearTimeout(interval); &#125; if (upload.state == 'error') &#123; window.clearTimeout(interval); uploadxhr.abort(); alert('something wrong'); &#125; &#125; &#125; &#125; req.send(null); &#125;&lt;/script&gt; å¦å¤–nginx-upload-moduleå’Œnginx-upload-progress-moduleè¿˜æä¾›äº†æ›´å¤šçš„æŒ‡ä»¤ï¼Œå¸®å¿™æˆ‘ä»¬å®žçŽ°æ›´å¤æ‚çš„ä¸Šä¼ æ–‡ä»¶åŠŸèƒ½ï¼Œæ¯”å¦‚æ–­ç‚¹ç»­ä¼ ç­‰ï¼Œæœ‰å…´è¶£å¯ä»¥é˜…è¯»ä¸¤ä¸ªæ¨¡å—çš„å®˜æ–¹æ–‡æ¡£ï¼Œäº†è§£æ›´å¤šã€‚å¦å¤–ï¼Œå› ä¸ºnginx-upload-moduleæœªèƒ½åŠæ—¶æ‹¦ä¸‹ä½“ç§¯è¿‡å¤§çš„æ–‡ä»¶ä¸Šä¼ ï¼Œæ‰€ä»¥ï¼Œå°½ç®¡ä¿éšœäº†ç”¨æˆ·çš„æ­£å¸¸ä½¿ç”¨ï¼Œå¯æ˜¯ä¾ç„¶ä¸èƒ½é˜²èŒƒæ¶æ„çš„æµé‡æ”»å‡»ã€‚nginx-upload-progress-moduleèƒ½å¤Ÿåœ¨ä¸€å¼€å§‹å°±æ£€æµ‹åˆ°ä¸Šä¼ æ–‡ä»¶çš„ä½“ç§¯æ˜¯å¦è¿‡å¤§ï¼ˆHTTPè¯·æ±‚å¤´é‡Œçš„Content-Lengthå­˜æœ‰æ–‡ä»¶çš„ä½“ç§¯å¤§å°ï¼‰ï¼Œè¿™æ—¶å€™å°±åº”è¯¥ä¸­æ–­ä¸Šä¼ ï¼ˆå¯èƒ½æ˜¯NginXé™åˆ¶ï¼Œæ‰©å±•æ¨¡å—æ— æ³•ä¸­æ–­HTTPè¯·æ±‚ï¼‰ï¼Œå¤§å®¶æœ‰å…´è¶£çš„è¯å¯ä»¥ç ”ç©¶ä¸€ä¸‹NginXæºç å’Œæ‰©å±•å¼€å‘ã€‚ æ€è€ƒNginXçš„client_max_body_sizeè®¾ä¸º32mï¼Œæ”»å‡»è€…å¯ä»¥ä¸Šä¼ 1GBçš„æ–‡ä»¶ï¼Œç›´åˆ°ä¸Šä¼ åˆ°32MBçš„æ—¶å€™ï¼ŒNginXæ‰ä¼šä¸­æ–­ä¸Šä¼ ï¼ŒæœåŠ¡å™¨è¢«æ¶ˆè€—äº†32MBçš„æµé‡ã€‚ç»†æƒ³ä¸€ä¸‹ï¼š å³ä½¿NginXåœ¨ä¸€å¼€å§‹å°±æ‹¦ä¸‹äº†ä½“ç§¯å¤§äºŽ32MBçš„æ–‡ä»¶ï¼Œå¯æ˜¯æ”»å‡»è€…ä¾ç„¶å¯ä»¥ç›´æŽ¥ä¸Šä¼ 30MBå¤§å°çš„æ–‡ä»¶ï¼ŒæœåŠ¡å™¨è¿˜æ˜¯ä¼šè¢«æ¶ˆè€—äº†30MBçš„æµé‡ï¼Œæ‰€ä»¥åœ¨ä¸€å¼€å§‹å°±æ‹¦æˆªçš„æ„ä¹‰å¹¶ä¸å¤§ï¼› å¯æ˜¯ä¸Šä¼ æ–‡ä»¶çš„ä½“ç§¯å¤§äºŽclient_max_body_sizeæ—¶ï¼Œnginx-upload-moduleçš„é™é€ŸåŠŸèƒ½ä¸èµ·ä½œç”¨ï¼Œè¿™å°±æˆé—®é¢˜äº†ï¼› NginXæ²¡æœ‰ç›´æŽ¥ä¿¡ä»»è¯·æ±‚å¤´çš„Content-Lengthï¼Œåº”è¯¥æœ‰ä»–çš„ä¾æ®ï¼Œä¸è¿‡æ­£å¸¸ç”¨æˆ·ä¸ä¼šè™šæŠ¥å§ï¼ˆå³ä½¿æŠ¥å°ä¹Ÿä¸æŠ¥å¤§å•Šï¼‰ï¼› çœ‹æ¥è¿™ä¸ªæ–¹æ¡ˆè¿˜éœ€ç»§ç»­å®Œå–„ï¼Œæˆ–è€…å€ŸåŠ©çŽ°æˆçš„äº‘å­˜å‚¨æœåŠ¡æ¥å®žçŽ°æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ˆå¯å‚è€ƒè…¾è®¯äº‘COSçš„ä¸€æ¬¡å®žè·µï¼‰ã€‚ æœ€åŽå¦‚æžœä¸€ä¸ªç½‘ç«™ï¼Œå…è®¸ç”¨æˆ·å…¨é€Ÿä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶æŒç»­æ•°åç§’ï¼Œé‚£ä¹ˆè¿™ä¸ªç½‘ç«™ä¸€å®šå­˜åœ¨è¢«æµé‡æ”»å‡»çš„é£Žé™©ï¼Œæœ‰å¯èƒ½æ˜¯å¤§é‡ç”¨æˆ·åŒæ—¶ä½¿ç”¨é€ æˆçš„ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ¶æ„çš„DDoSæ”»å‡»ï¼ˆï¼Ÿï¼Ÿå¥½åƒæ‰€æœ‰ç½‘ç«™éƒ½ä¼šæœ‰è¿™ä¸ªé£Žé™©ï¼‰ã€‚è¦æ˜¯æœåŠ¡å™¨å¸¦å®½è¢«å æ»¡ï¼ŒæœåŠ¡å™¨å¯¹äºŽä¸€äº›ç”¨æˆ·å°±åƒæ˜¯æŽ‰çº¿äº†ï¼Œæ‰€ä»¥ä¸Šä¼ æ–‡ä»¶çš„é—®é¢˜å¿…é¡»é‡è§†ã€‚å¦å¤–ï¼Œå¼€å‘è€…ä¸åº”è¯¥å±€é™äºŽä¸€ç§ç¼–ç¨‹è¯­è¨€æˆ–è€…ä¸€ä¸ªçŸ¥è¯†é¢†åŸŸä¸ŠåŽ»æ€è€ƒè§£å†³é—®é¢˜ï¼Œåº”è¯¥æ¶‰è§ˆæ›´å¤šçš„çŸ¥è¯†é¢†åŸŸï¼Œä»Žæ›´å¤šè§’åº¦ã€æ›´å¤šæ–¹ä½åŽ»è§£å†³é—®é¢˜ã€‚ å‚è€ƒ OPTIMIZED FILE UPLOADING WITH PHP &amp; NGINX How to Upload Large Files in PHP æ–‡ä»¶ä¸Šä¼ çš„æ¸è¿›å¼å¢žå¼º]]></content>
      <categories>
        <category>æ–¹æ¡ˆ</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>scheme</tag>
        <tag>php</tag>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ€Žæ ·ç®—å‡ºPiï¼ˆÏ€ï¼‰]]></title>
    <url>%2Fblog%2Fmath-calculating-pi.html</url>
    <content type="text"><![CDATA[åœ†å‘¨çŽ‡æ—¥ï¼ˆPi Dayï¼Œåˆè¯‘Ï€èŠ‚ï¼‰æ˜¯ä¸€å¹´ä¸€åº¦çš„åº†ç¥æ•°å­¦å¸¸æ•°Ï€çš„èŠ‚æ—¥ï¼Œç‰¹åœ°å†™ä¸€ç¯‡ä¸ŽÏ€ç›¸å…³çš„æ–‡ç« ã€‚ ä¸€é“é¢˜ç›®æœ€è¿‘ç¢°åˆ°ä¸€é“æ•°å­¦ç¼–ç¨‹é¢˜ç›®ï¼Œå°±æ˜¯åˆ©ç”¨ä»¥ä¸‹å…¬å¼æ±‚å‡ºÏ€çš„ï¼ˆè¿‘ä¼¼ï¼‰å€¼ï¼š$$ x - \frac{x^3} {3!} + \frac{x^5} {5!} - \frac{x^7} {7!} + \ldots = \sum_{n=0}^{+\infty} \frac{(-1)^n x^{2n+1}} {(2n+1)!} $$ ç½‘ä¸Šæœäº†ä¸€ä¸‹ï¼ŒåŽŸæ¥è¿™æ˜¯æ­£å¼¦å‡½æ•°çš„æ³°å‹’çº§æ•°å±•å¼€å¼ï¼ˆé«˜ç­‰æ•°å­¦æ—©å¿˜å…‰äº†ï¼‰ã€‚ æœºæ™ºçš„æˆ‘ä¸€ä¸‹å­å°±æƒ³åˆ°äº†sin(Ï€)=0ï¼Œä»£å…¥ä¸Šé¢å…¬å¼ï¼Œå¾—åˆ°æ–¹ç¨‹ï¼š$$ sin(\pi) = \pi - \frac{\pi^3} {3!} + \frac{\pi^5} {5!} - \frac{\pi^7} {7!} + \ldots = 0 $$ äºŽæ˜¯ï¼š$$ \pi = \frac{\pi^3} {3!} - \frac{\pi^5} {5!} + \frac{\pi^7} {7!} - \ldots $$ ç„¶åŽï¼Œè§£æ–¹ç¨‹â€¦â€¦å‘ƒâ€¦â€¦è¿™ä¸ªæˆ‘ä¸ä¼šï¼å†ä¸Šç½‘æ‰¾æ‰¾ã€‚ ç™¾ç§‘çŸ¥é“æœ‰ç©ºè¦å¤šçœ‹çœ‹ç™¾ç§‘çŸ¥è¯†ï¼Œèƒ½å­¦åˆ°å¾ˆå¤šä¸œè¥¿ã€‚ æ¢…é’¦å…¬å¼åœ¨ç»´åŸºç™¾ç§‘çš„åœ†å‘¨çŽ‡æ¡ç›®é‡Œï¼Œæåˆ°äº†è®¡ç®—Ï€çš„æ¢…é’¦å…¬å¼ï¼š$$ \frac{\pi} {4} = 4arctan\frac{1} {5} - arctan\frac{1} {239} $$ è¿™ä¸ªæ˜¯åˆ©ç”¨arctan(x)çš„æ³°å‹’çº§æ•°å±•å¼€å¼ï¼Œå’Œ4arctan(1)=Ï€æŽ¨å¯¼å‡ºæ¥çš„ã€‚å¯æ˜¯ç”¨sin(x)çš„æ³°å‹’çº§æ•°å±•å¼€å¼ä¸èƒ½æŽ¨å¯¼å‡ºarctan(x)çš„æ³°å‹’çº§æ•°å±•å¼€å¼ï¼Œæ‰€ä»¥ç”¨æ¢…é’¦å…¬å¼æ±‚Ï€å°±ä¸å’Œé¢˜æ„äº†ã€‚ å·´å¡žå°”é—®é¢˜åœ¨ç»´åŸºç™¾ç§‘çš„å·´å¡žå°”é—®é¢˜æ¡ç›®é‡Œï¼Œæåˆ°æ¬§æ‹‰åˆ©ç”¨æ­£å¼¦å‡½æ•°çš„æ³°å‹’çº§æ•°å±•å¼€å¼ï¼Œæ±‚è¯äº†ï¼š$$ \frac{\pi} {6} = \frac{1} {1^2} + \frac{1} {2^2} + \frac{1} {3^2} + \frac{1} {4^2} + \ldots $$ å¯æ˜¯æ±‚è¯è¿‡ç¨‹ä¸­åˆ©ç”¨äº†é›¶ç‚¹ä»£å…¥æ–¹ç¨‹æ±‚è§£ï¼Œä¸ç®—ä¸¥è°¨ï¼Œæ‰€ä»¥è¿™æ¡å…¬å¼ä¹Ÿä¸èƒ½ç”¨ã€‚ å¤¹æŒ¤å®šç†å…³é”®æ–¹å‘æ˜¯ç”¨æ­£å¼¦å‡½æ•°åŽ»æ±‚Ï€ï¼ŒäºŽæ˜¯ç”¨sin(x)å’ŒÏ€ä½œä¸ºå…³é”®å­—ï¼Œåˆåœ¨ç½‘ä¸Šæœäº†ä¸€éï¼Œç»ˆäºŽå‘çŽ°äº†ä¸€ç¯‡â€œæœ‰è¶£â€çš„æ–‡ç« â€”â€”ä¸€ä¸ªæœ‰è¶£çš„åœ†å‘¨çŽ‡è®¡ç®—å…¬å¼ x=sin(x)+xã€‚æ–‡ä¸­ä¸»è¦è®²ä½œè€…â€œåŽŸåˆ›â€äº†ä¸€ç§æ±‚Ï€ç®—æ³•ï¼Œå°±æ˜¯â€œé€šè¿‡è¿­ä»£è®¡ç®—x=sin(x)+xï¼Œé€¼è¿‘Ï€â€ï¼ˆåŽŸè¯ï¼‰ã€‚ é€šè¿‡â€œé€¼è¿‘â€æ¥æ±‚Ï€å€¼ï¼Œçš„ç¡®æ˜¯å¾ˆæœ‰æ„æ€çš„ä¸€ç§æ–¹æ³•ã€‚å¯æ˜¯ä½œè€…åªæ˜¯ç»™å‡ºäº†è®¡ç®—æ–¹æ³•ï¼Œå´æ²¡æœ‰è¯¦ç»†çš„æŽ¨å¯¼è¿‡ç¨‹ã€‚ä¸€å¼€å§‹å¯¹è¿™ç§ç®—æ³•è¿˜æ˜¯æŒæ€€ç–‘æ€åº¦ï¼Œç›´åˆ°åŽæ¥æƒ³èµ·äº†å¤¹æŒ¤å®šç†ï¼ˆä¹Ÿå«å¤¹é€¼å‡†åˆ™ï¼Œå…¶å®žä¸å¤§è®°å¾—è¿™ä¸ªåå­—ï¼Œåªæ˜¯å¤§æ¦‚çŸ¥é“ç”±å®ƒæŽ¨å¯¼å‡ºæ¥çš„æžé™å…¬å¼ï¼‰ï¼Œç”±å¤¹æŒ¤å®šç†å¯ä»¥å¾ˆå®¹æ˜“å¾—åˆ°ä»¥ä¸‹æžé™ï¼ˆä¸€èˆ¬é«˜ç­‰æ•°å­¦ä¹¦é‡Œéƒ½ä¼šæåˆ°ï¼‰ï¼š$$ \lim_{x \rightarrow 0} sin(x) = x $$ äºŽæ˜¯ï¼Œæœ‰ï¼š$$ \lim_{\pi-x \rightarrow 0} sin(\pi-x) = pi-x $$ åˆå› ä¸ºsin(Ï€-x)=sin(x)ï¼Œå¾—ï¼š$$ \lim_{\pi-x \rightarrow 0} sin(x) + x = pi $$ å‡è®¾ï¼Œxå¤§äºŽ0å°äºŽÏ€ï¼Œåˆ™sin(x)å¤§äºŽ0å°äºŽ1ï¼›åœ¨xæ— é™è¶‹äºŽÏ€æ—¶ï¼Œsin(x)+xä¹Ÿåœ¨æ— é™è¶‹äºŽÏ€ï¼Œè€Œä¸”æ¯”xæ›´è¶‹äºŽÏ€ï¼ˆå› ä¸ºè¿™é‡Œsin(x)ä¸æ˜¯è´Ÿæ•°ï¼‰ï¼›æ‰€ä»¥ï¼Œä¸æ–­åœ°è®©x=sin(x)+xé‚£ä¹ˆxå°±å¯ä»¥æ— é™åœ°æŽ¥è¿‘Ï€äº†ã€‚ å†ç”¨sin(x)çš„æ³°å‹’çº§æ•°å±•å¼€å¼ä»£æ›¿sin(x)ï¼Œé‚£ä¹ˆæ±‚Ï€çš„å‡½æ•°ä»£ç ï¼ˆjavascriptï¼‰å°±å¾ˆå®¹æ˜“å†™äº†ï¼š 12345678910111213141516171819202122232425262728var INFINITY = 100; // ç”¨100è¡¨ç¤ºæ­£æ— ç©·ï¼Œè¶Šå¤§è¶Šå‡†ï¼Œå¤ªå¤§å¯èƒ½ä¼šæº¢å‡ºvar PI = 3; // xçš„åˆå§‹å€¼è®¾ä¸ºæŽ¥è¿‘PIçš„æ•°ï¼Œæ¯”å¦‚3ï¼Œä¹Ÿå¯ä»¥æ˜¯1ã€2ã€2.1ã€2.2ã€...function getPI(len) &#123; if(PI&gt;3) &#123; return PI.toFixed(len); &#125; for(var i=0; i&lt;INFINITY; i++) &#123; PI = taylorSin(PI)+PI; &#125; return PI.toFixed(len);&#125;function taylorSin(x) &#123; var sinx = 0; for(var i=0; i&lt;INFINITY; i++) &#123; sinx+=Math.pow(-1, i)*Math.pow(x, i*2+1)/factorial(i*2+1); &#125; return sinx;&#125;function factorial(n) &#123; var f = n; while(--n) &#123; f*=n; &#125; return f;&#125; æ‰€ä»¥ï¼ŒÏ€å€¼æ€Žä¹ˆç®—ï¼Ÿæ­»å¾ªçŽ¯ç®—å•Šã€‚ æœ€åŽå…¶å®žï¼Œæ±‚Ï€çš„æ–¹æ³•è¿˜æœ‰å¾ˆå¤šï¼Œå°½ç®¡Ï€æ˜¯ä¸€ä¸ªæ— ç†æ•°ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥æµè§ˆä¸€ä¸‹ç½‘é¡µï¼Œç‰¹åˆ«æ˜¯è´åˆ©-æ³¢å°”æ¸©-æ™®åŠ³å¤«å…¬å¼ï¼Œå…¶å¯ä»¥ç›´æŽ¥ç®—å‡ºå°æ•°ç‚¹åŽé¢çš„ç¬¬nä½æ•°å€¼ï¼š å¦‚ä½•è®¡ç®—åœ†å‘¨çŽ‡ Pi è´åˆ©-æ³¢å°”æ¸©-æ™®åŠ³å¤«å…¬å¼ é«˜æ–¯-å‹’è®©å¾·ç®—æ³• æ¢…é’¦ç±»å…¬å¼ å·´å¡žå°”é—®é¢˜]]></content>
      <categories>
        <category>æ±‚ç´¢</category>
      </categories>
      <tags>
        <tag>math</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å…³äºŽç”¨æˆ·å¤šæ ‡ç­¾çš„æ›´æ–°]]></title>
    <url>%2Fblog%2Fthink-about-user-tags.html</url>
    <content type="text"><![CDATA[åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œç»å¸¸è¦çŽ°å®žè¿™æ ·çš„ä¸€ä¸ªåŠŸèƒ½â€”â€”å…³ç³»è¡¨æ›´æ–°ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥è®¾ç½®å¤šä¸ªæ ‡ç­¾ï¼Œè€Œä¸€ä¸ªæ ‡ç­¾ä¸‹åˆå¯ä»¥æœ‰å¤šä¸ªç”¨æˆ·ï¼Œä¸¤è€…æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œç”¨ä¸€å¼ å…³ç³»è¡¨è®°å½•ç”¨æˆ·çš„æ ‡ç­¾æ•°æ®ï¼Œé‚£ä¹ˆï¼Œå½“æ›´æ–°ç”¨æˆ·æ ‡ç­¾çš„æ—¶å€™ï¼Œæ€Žæ ·å®‰æŽ’æ‰§è¡Œæµç¨‹ï¼Œæ‰æ˜¯æœ€ä¼˜çš„å‘¢ï¼Ÿ æ•°æ®å…³ç³»å‡è®¾æ•°æ®åº“ä¸­æœ‰ä¸‰å¼ è¡¨ï¼Œuserï¼Œtagï¼Œuser_tagï¼š å‡è®¾æ•°æ®åº“ä¸­æœ‰ä¸‰å¼ è¡¨ï¼Œ user: id name 1 user1 2 user2 3 user3 â€¦ â€¦ tag: id title 1 tag1 2 tag2 3 tag3 â€¦ â€¦ user_tag: | id | user_id | tag_id | deleted_at|| â€” | â€” | â€” | â€” | â€” || 1 | 1 | 1 | null || 2 | 2 | 1 | null || 3 | 3 | 1 | null || â€¦ | â€¦ | â€¦ | null | user_tagè¡¨è®°å½•äº†userè¡¨å’Œtagè¡¨ä¹‹é—´çš„å…³ç³»ï¼Œå¹¶ä¸”user_tagè¡¨å†…ä½¿ç”¨è½¯åˆ é™¤ã€‚ é—®é¢˜æè¿°å¦‚æžœç”¨æˆ·user1çš„æ ‡ç­¾ä¸ºtag1ã€tag2å’Œtag3ï¼ŒçŽ°åœ¨æƒ³æ›´æ–°ä¸ºtag2ã€tag4å’Œtag6ï¼Œé‚£ä¹ˆåº”è¯¥æ€Žæ ·æ“åšï¼Ÿ è§£å†³æ–¹æ¡ˆæœ€æš´åŠ›çš„è§£å†³åŠžæ³•å°±æ˜¯deleteæ—§æ•°æ®ï¼Œç„¶åŽinsertæ–°æ•°æ®ã€‚ä½†æ˜¯é¡¹ç›®ä¸­ï¼Œä¸ºäº†å®‰å…¨ï¼Œä¸€èˆ¬ä¼šç¦ç”¨ç¡¬åˆ é™¤ï¼Œè€Œä½¿ç”¨è½¯åˆ é™¤ã€‚å¦‚æžœç”¨è½¯åˆ é™¤ç»“åˆinsertï¼Œå…³ç³»è¡¨å°±ä¼šè¶Šæ¥è¶Šå¤§ã€‚ æ¯”è¾ƒå¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå®žæ—¶æ›´æ–°å’Œå·®é›†æ›´æ–°ã€‚ å®žæ—¶æ›´æ–°å½“ç»™ç”¨æˆ·æ·»åŠ ä¸€ä¸ªæ ‡ç­¾æ—¶ï¼ŒåŽå°ç«‹åˆ»æ›´æ–°ï¼›å½“ç»™ç”¨æˆ·ç§»é™¤ä¸€ä¸ªæ ‡ç­¾æ—¶ï¼ŒåŽå°ä¹Ÿç«‹åˆ»æ›´æ–°ï¼Œè¿™æ ·çš„åšæ³•ï¼Œå®žçŽ°èµ·æ¥å¾ˆç®€å•ï¼Œï¼ˆä¼ªï¼‰ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920// with laravel// in UserTag Modelstatic public function addUserTag($user_id, $tag_id) &#123; $user_tag = self::where(['user_id'=&gt; $user_id, 'tag_id'=&gt; $tag_id])-&gt;first(); if($user_tag) &#123; $user_tag-&gt;deleted_at = null; return $user_tag-&gt;save(); &#125; else &#123; $user_tag = new self; $user_tag-&gt;user_id = $user_id; $user_tag-&gt;tag_id = $tag_id; $user-&gt;save(); &#125;&#125;static public function removeUserTag($user_id, $tag_id) &#123; return self::where(['user_id'=&gt; $user_id, 'tag_id'=&gt; $tag_id])-&gt;update(['deleted_at'=&gt; time()]);&#125; å·®é›†æ›´æ–°å¦‚æžœä½¿ç”¨å®žæ—¶æ›´æ–°ï¼Œé‚£ä¹ˆæ¯æ¬¡æ“ä½œéƒ½è¦å‘åŽå°å‘é€è¯·æ±‚ï¼Œè¿™æ ·çš„è¯·æ±‚ä¸€èˆ¬éƒ½æ˜¯å°è€Œå¤šï¼Œå€’ä¸å¦‚ä½¿ç”¨æ‰¹é‡æ›´æ–°ã€‚æ¯”è¾ƒä¸€ä¸‹æ–°æ•°æ®å’Œå°±æ•°æ®ï¼Œé’ˆå¯¹å·®é›†è¿›è¡Œæ›´æ–°ï¼Œï¼ˆä¼ªï¼‰ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748// with laravel// in UserTag Modelstatic public function getAllUserTagID($user_id) &#123; $result = self::(['user_id'=&gt; $user_id])-&gt;select('tag_id'); if($result) &#123; return $result-&gt;pluck('tag_id')-&gt;toArray(); &#125; return [];&#125;static public function insertUserTags($user_id, array $tag_ids) &#123; $data = []; foreach ($tag_ids as $tag_id) &#123; $data[] = [ 'user_id' =&gt; $user_id, 'tag_id' =&gt; $tag_id, ]; &#125; return self::insert($data);&#125;static public function updateUserTags($user_id, array $tag_ids, $action = 'in') &#123; self::where(['user_id'=&gt; $user_id])-&gt;whereIn('tag_id', $tag_ids); if ($action == 'in') &#123; return $builder-&gt;update(['deleted_at'=&gt; null]); &#125; else if ($action == 'out') &#123; return $builder-&gt;update(['deleted_at'=&gt; time()]); &#125; return false;&#125;// in UserTag Controllerpublic function postUserTags($request) &#123; $user_id = session('user_id'); $old_tag_ids = UserTag::getAllUserTagID($user_id); $new_tag_ids = $request-&gt;input('tag_ids'); // is array $save_tag_ids = array_intersect($old_tag_ids, $new_tag_ids); // éœ€è¦ä¿ç•™çš„æ ‡ç­¾id $throw_tag_ids = array_diff($old_tag_ids, $save_tag_ids); // éœ€è¦åˆ é™¤çš„æ ‡ç­¾id $add_tag_ids = array_diff($new_tag_ids, $save_tag_ids); // éœ€è¦æ·»åŠ çš„æ ‡ç­¾id UserTag::updateUserTags($employee-&gt;id, $save_tag_ids, 'in'); UserTag::updateUserTags($employee-&gt;id, $throw_tag_ids, 'out'); UserTag::insertUserTags($employee-&gt;id, $add_tag_ids);&#125; æœ€åŽæœ€åŽè¯´ä¸¤å¥ï¼Œå¤šç‚¹å…³æ³¨array_intersectã€array_diffç­‰ç­‰PHPæ•°ç»„å‡½æ•°çš„ä½¿ç”¨ã€‚]]></content>
      <categories>
        <category>æ±‚ç´¢</category>
      </categories>
      <tags>
        <tag>think</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å…³äºŽJSçš„MVVMå®žçŽ°]]></title>
    <url>%2Fblog%2Fthink-about-js-mvvm.html</url>
    <content type="text"><![CDATA[è¿‡åŽ»Webåº”ç”¨çš„å¸¸ç”¨å¼€å‘æ¨¡å¼æ˜¯MVCï¼Œå‰ç«¯åŽå°å¹¶åœ¨ä¸€èµ·å¼€å‘ã€‚éšç€JavaScriptè¯­è¨€çš„å‘å±•ï¼Œå‰ç«¯èƒ½åšçš„è¶Šæ¥è¶Šå¤šï¼ŒWebåº”ç”¨å¼€å‘ä¹Ÿè¶‹å‘äº†â€œå‰åŽç«¯åˆ†ç¦»â€ã€‚å‰åŽç«¯åˆ†ç¦»å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°æ¦‚å¿µï¼Œå®žè´¨æ˜¯Webåº”ç”¨ä»ŽB/Sï¼ˆæµè§ˆå™¨ï¼æœåŠ¡å™¨ï¼‰ç»“æž„å‘C/Sï¼ˆå®¢æˆ·ç«¯ï¼æœåŠ¡ç«¯ï¼‰ç»“æž„è½¬å˜ ã€‚åˆ†ç¦»åŽï¼Œå‰ç«¯å°±è‡ªæˆä¸€ä¸ªç³»ç»Ÿï¼Œå¤§å®¶å¼€å§‹æŽ¢è®¨å‰ç«¯çš„å¼€å‘æ¨¡å¼ï¼Œè€Œå…¶ä¸­MVVMæ¨¡å¼å¤‡å—æŽ¨å´‡ã€‚ MVVMMVVMï¼Œå³Model-View-ViewModelï¼Œæ˜¯ä»ŽMVCè¡ç”Ÿå‡ºæ¥çš„å¼€å‘æ¨¡å¼ã€‚MVVMæ¨¡å¼ç”¨ViewModelæ›¿ä»£äº†Controllerï¼ŒViewModelå°±åƒæ˜¯Modelå’ŒViewä¹‹é—´çš„æ¡¥æ¢â€”â€”æ•°æ®æ¨¡åž‹é€šè¿‡ViewModelå±•ç¤ºåœ¨è§†å›¾ä¸­ï¼Œå½“è§†å›¾å‘ç”Ÿå˜åŒ–ï¼Œå¯ä»¥é€šè¿‡ViewModelæ¥è§¦å‘æ•°æ®æ›´æ”¹ï¼›è€Œæ•°æ®çš„æ›´æ”¹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ViewModelæ¥è§¦å‘Viewå˜åŒ–ï¼Œç¤ºæ„å›¾ï¼š æ•°æ®æ¨¡åž‹å’Œè§†å›¾ä¹‹é—´çš„ä½œç”¨æ˜¯ç›¸äº’çš„ï¼Œæ•°æ®æ¨¡åž‹è·Ÿéšäº†è§†å›¾å˜åŒ–ï¼Œè§†å›¾ä¹Ÿè·Ÿéšæ•°æ®æ¨¡åž‹æ›´æ”¹ï¼Œè¿™æ˜¯ä¸€ç§åŒå‘ç»‘å®šã€‚æ•°æ®æ¨¡åž‹å’Œè§†å›¾çš„åŒå‘ç»‘å®šæ˜¯MVVMçš„åŸºç¡€æž¶æž„ã€‚å¦‚æžœæ•°æ®æ¨¡åž‹å’Œè§†å›¾èƒ½å¤ŸåŒå‘ç»‘å®šï¼Œé‚£ä¹ˆå‰ç«¯ä¸­ç”¨æˆ·çš„å¤æ‚äº¤äº’æ“ä½œï¼Œå¯ä»¥çŸ­çŸ­å‡ è¡Œä»£ç å°±èƒ½å®žçŽ°ã€‚ä½†æ˜¯ï¼Œæ€Žä¹ˆæ‰èƒ½è®©æ•°æ®æ¨¡åž‹å’Œè§†å›¾åŒå‘ç»‘å®šå‘¢ï¼Ÿ çŒœæƒ³æœ€åˆä½“éªŒåˆ°æ•°æ®æ¨¡åž‹å’Œè§†å›¾çš„åŒå‘ç»‘å®šï¼Œæ˜¯åœ¨Angularçš„æ•™ç¨‹æ–‡æ¡£é‡Œã€‚ä»Žé¢å­ï¼Œçœ‹é‡Œå­ï¼Œæ•°æ®æ¨¡åž‹å’Œè§†å›¾çš„åŒå‘ç»‘å®šæ˜¯æ€Žä¹ˆå®žçŽ°çš„å‘¢ï¼Ÿå½“æ—¶å°±æƒ³åˆ°äº†set/getçš„æ–¹æ³•ï¼ˆset/getæ˜¯æŒ‡å¯¹å±žæ€§è¿›è¡Œæ“ä½œå°è£…ï¼Œè¿™é‡Œä¸»è¦ç”¨åˆ°çš„æ˜¯setï¼‰ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435function Model(data) &#123; var _view; this.bind = function(view) &#123; _view = view; &#125;; this.set = function(name, value) &#123; this[name] = value; _view.update(); &#125;; this.update = function() &#123; // reset by _view; &#125;&#125;function View(dom) &#123; var _model; this.bind = function(model) &#123; _model = model; &#125;; dom.addEventListener('change', function() &#123; _model.update(); &#125;); this.update = function() &#123; // render by _model &#125;;&#125;var m = new Model(data);var v = new View(dom);m.bind(v);v.bind(m);m.set('a', 1);... Modelå®žä¾‹é€šè¿‡setæ–¹æ³•æ¥ä¿®æ”¹å±žæ€§æ—¶ï¼Œsetæ–¹æ³•ä¸­å·²ç»å¸¦æœ‰æ›´æ–°å¯¹åº”Viewå®žä¾‹çš„ä»£ç ï¼›Viewå®žä¾‹åœ¨HTMLä¸­çš„æ ‡ç­¾è§¦å‘changeäº‹ä»¶æ—¶ï¼Œå›žè°ƒå‡½æ•°ä¸­ä¹Ÿå¸¦æœ‰æ›´æ–°å¯¹åº”Modelå®žä¾‹çš„ä»£ç ï¼Œè¿™æ ·å°±ç®€å•çš„å®žçŽ°äº†ä¸€ä¸ªModelå’ŒViewçš„åŒå‘ç»‘å®šã€‚ç„¶è€Œï¼Œèƒ½ä¸èƒ½ç›´æŽ¥é€šè¿‡ç­‰äºŽå·=èµ‹å€¼æ—¶å°±è§¦å‘äº†æ•°æ®ä¿®æ”¹çš„äº‹ä»¶å‘¢ï¼Ÿ ä¸»æµå®žçŽ°ä¸»æµçš„å‰ç«¯MVVMæ¡†æž¶ï¼Œå®žçŽ°åŒå‘ç»‘å®šçš„åšæ³•å¤§æ¦‚å¯å½’çº³ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š å‘å¸ƒ-è®¢é˜… è„å€¼æ£€æŸ¥ æ•°æ®åŠ«æŒ å‘å¸ƒ-è®¢é˜…å‘å¸ƒ-è®¢é˜…ï¼Œæ˜¯ä¸€ç§äº‹ä»¶æ¨¡åž‹ã€‚Modelå’ŒViewéƒ½æœ‰å„è‡ªçš„å‘å¸ƒã€è®¢é˜…æ–¹æ³•ï¼ŒåŒæ—¶Modelåœ¨ä¿®æ”¹æ•°æ®çš„æ—¶å€™ä¼šå‘å¸ƒå¹¿æ’­ï¼Œè€ŒViewè®¢é˜…äº†è¿™ä¸ªå¹¿æ’­ï¼Œåœ¨æ”¶åˆ°å¹¿æ’­çš„æ—¶å€™æ›´æ–°è§†å›¾ï¼›Viewåœ¨è§†å›¾æ›´æ–°çš„æ—¶å€™ä¼šå‘å¸ƒå¹¿æ’­ï¼Œè€ŒModelä¹Ÿè®¢é˜…äº†è¿™ä¸ªå¹¿æ’­ï¼Œåœ¨æ”¶åˆ°å¹¿æ’­çš„æ—¶å€™æ›´æ–°æ•°æ®ï¼Œè¿™æ ·å°±å½¢æˆäº†åŒå‘ç»‘å®šï¼Œå¤§è‡´çš„å®žçŽ°ä»£ç ä¸Žä¸Šé¢çš„â€œçŒœæƒ³â€å·®ä¸å¤šã€‚Backbone.jså°±æ˜¯ä½¿ç”¨äº† å‘å¸ƒ-è®¢é˜… æ¥å®žçŽ°åŒå‘ç»‘å®šã€‚ è„å€¼æ£€æŸ¥è„å€¼æ£€æŸ¥ï¼Œæ˜¯æŒ‡åœ¨ç‰¹å®šæƒ…å†µä¸‹ï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰ä¿®æ”¹ï¼Œæ˜¯å¦éœ€è¦æ›´æ–°è§†å›¾ï¼›æˆ–è€…æ£€æŸ¥è§†å›¾æ˜¯å¦æœ‰æ›´æ”¹ï¼Œæ˜¯å¦éœ€è¦æ›´æ–°æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨setIntervalå‡½æ•°æ¥è®¾ç½®å®šæ—¶æ£€æŸ¥ï¼Œå°½ç®¡éžå®žæ—¶ï¼Œä½†ä¹Ÿå¯ä»¥å®žçŽ°äº†åŒå‘ç»‘å®šã€‚Angular.jsä¹Ÿæ˜¯ä½¿ç”¨è„å€¼æ£€æŸ¥æ¥å®žçŽ°åŒå‘ç»‘å®šã€‚ä¸è¿‡Angular.jsä¸æ˜¯å®šæ—¶å‘¨æœŸåœ°åŽ»æ£€æŸ¥ï¼Œè€Œæ˜¯åœ¨ä¸€äº›ç‰¹æ®Šäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰æ‰§è¡Œè„å€¼æ£€æŸ¥ï¼Œæ¯”å¦‚ï¼š DOMçš„changeã€checkã€clickç­‰äº‹ä»¶ï¼› XHRå“åº”äº‹ä»¶ï¼› $digest()ã€$apply()ã€$timeout()å’Œ$interval()ç­‰å‡½æ•°çš„è°ƒç”¨ï¼› â€¦ æ•°æ®åŠ«æŒECMAScript262v5ä¸­Objectæœ‰äº†ä¸€ä¸ªæ–°çš„æ–¹æ³•å±žæ€§ï¼šdefinePropertyã€‚Object.defineProperty() æ–¹æ³•ä¼šç›´æŽ¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–°å±žæ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å±žæ€§ï¼Œå¹¶è¿”å›žè¿™ä¸ªå¯¹è±¡ï¼›åŒæ—¶ï¼Œèƒ½å¤Ÿè®¾ç½®è¯¥å±žæ€§åœ¨è¢«getæˆ–setçš„å›žè°ƒå‡½æ•°ï¼Œè¯¥å±žæ€§è¢«èµ‹å€¼ï¼Œæˆ–è€…è¢«å–å€¼çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œå›žè°ƒå‡½æ•°ï¼Œè¿™å°±æ˜¯æ•°æ®åŠ«æŒã€‚åˆ©ç”¨è¿™ä¸ªæ–°ç‰¹æ€§ï¼Œå†ç»“åˆ å‘å¸ƒ-è®¢é˜…ï¼Œæˆ‘ä»¬å°±èƒ½å®žçŽ°ç›´æŽ¥é€šè¿‡ç­‰äºŽå·=èµ‹å€¼æ—¶å°±è§¦å‘äº†æ•°æ®ä¿®æ”¹çš„äº‹ä»¶ï¼Œè¿›è€Œæ›´æ–°è§†å›¾ã€‚Vue.jsæ­£æ˜¯ä½¿ç”¨äº†è¿™ç§æ–¹å¼å®žçŽ°äº†Modelåˆ°Viewçš„ç»‘å®šï¼Œå½“ç„¶Viewåˆ°Modelçš„ç»‘å®šè¿˜æ˜¯é ç›‘å¬HTMLçš„DOMäº‹ä»¶ã€‚ æœ€åŽæœ€åŽè¯´ä¸¤å¥ï¼Œå¦‚æžœå‰ç«¯ä½¿ç”¨äº†MVVMæ¨¡å¼å¼€å‘ï¼Œé‚£ä¹ˆä¸€å®šè¦æŠ›å¼ƒè¿‡åŽ»æ‰‹åŠ¨æ“ä½œDOMæ¥èŽ·å–æ•°æ®ã€æ›´æ–°è§†å›¾ç­‰ç­‰æ€æƒ³ï¼ˆå°¤å…¶æ˜¯jQueryæ ¹æ·±è’‚å›ºçš„å½±å“ï¼‰ï¼Œå¦åˆ™å¾ˆéš¾èžå…¥MVVMã€‚]]></content>
      <categories>
        <category>æ±‚ç´¢</category>
      </categories>
      <tags>
        <tag>think</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å…³äºŽå°è£…ç¬¬ä¸‰æ–¹ç±»åº“]]></title>
    <url>%2Fblog%2Fthink-about-encapsulating-libs.html</url>
    <content type="text"><![CDATA[åœ¨å†™ã€ŠjQuery Ajaxçš„å°è£…ã€‹çš„æ—¶å€™ï¼Œçªç„¶æƒ³åˆ°ä¸€äº›ä¸œè¥¿ï¼ŒäºŽæ˜¯å°±è¯•ç€å†™ä¸‹æ¥â€¦â€¦ æŽ§åˆ¶åè½¬å­¦ä¹ Laravelæ—¶ï¼Œä¸å¯é¿å…åœ°ä¸€å®šè¦ç ”ç©¶â€œæŽ§åˆ¶åè½¬â€ã€‚è¿™é‡Œå¹¶ä¸è¯¦ç»†ä»‹ç»â€œæŽ§åˆ¶åè½¬â€ï¼Œåªæ˜¯ç®€å•é˜è¿°ä¸€äº›å…¶ä¸»è¦æ€æƒ³ã€‚æŽ§åˆ¶åè½¬ï¼Œæ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œé€šè¿‡â€œä¾èµ–æ³¨å…¥â€å’Œâ€œä¾èµ–æŸ¥æ‰¾â€å®žçŽ°ä¾èµ–å€’ç½®ã€‚æœ¬æ¥ä¸€ä¸ªå®žä½“ï¼Œå…¶æŽ§åˆ¶æƒä¸»è¦åœ¨å…¶æ‰€ä¾èµ–çš„å…¶ä»–å®žä½“èº«ä¸Šï¼Œå¦‚æžœåè½¬äº†è¿™ç§å…³ç³»ï¼Œé‚£ä¹ˆæŽ§åˆ¶æƒå°±å›žåˆ°å®žä½“è‡ªå·±èº«ä¸Šï¼Œå®žé™…ä¸Šå°±æ˜¯å‡å¼±å¯¹å…¶ä»–å®žä½“çš„ä¾èµ–æ€§ï¼ˆå°±æ˜¯è§£è€¦å§ï¼‰ã€‚æŽ§åˆ¶åè½¬ï¼Œä¹Ÿæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ã€‚æŒ‰ç…§æŽ§åˆ¶åè½¬æ¨¡å¼æ¥ç¼–ç¨‹ï¼Œæ¨¡å—å®šä¹‰çš„æ­¥éª¤ä¼šå˜å¾—ç¹æ‚ï¼Œä½†æ˜¯æ¨¡å—è°ƒç”¨è¿˜æ˜¯ç®€ä¾¿çš„ï¼›æ¨¡å—ä¸Žæ¨¡å—ä¹‹é—´çš„ä¾èµ–æ€§å‡å¼±ï¼Œå¦‚æžœåŽæœŸæŸä¸ªæ¨¡å—æœ‰æ‰€æ”¹åŠ¨ï¼Œå¯¹äºŽå…¶ä»–æ¨¡å—çš„å½±å“å¹¶ä¸å¤§ã€‚ ä¾èµ–éš”ç¦»åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šå¼•å…¥ä¸€äº›ç¬¬ä¸‰æ–¹ç±»åº“ï¼Œæ¯•ç«Ÿæ²¡æœ‰è¶³å¤Ÿçš„æ—¶é—´åŽ»å¼€å‘ç»´æŠ¤æ‰€æœ‰åŠŸèƒ½ã€‚å¼•å…¥äº†ç¬¬ä¸‰æ–¹ç±»åº“ï¼Œæˆ‘ä»¬çš„ä»£ç å°±ä¼šä¾èµ–è¿™äº›ç±»åº“ï¼Œå°±æ˜¯è¯´ï¼Œå¦‚æžœç¼ºå¤±äº†æŸä¸ªç±»åº“ï¼Œæˆ–è€…æŸä¸ªç±»åº“å‘ç”Ÿäº†ä¸€äº›ç‰¹æ®Šæ›´æ”¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ä»£ç å°±ä¸èƒ½å¤Ÿæ­£å¸¸è¿è¡Œäº†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨å¼•å…¥ç¬¬ä¸‰æ–¹ç±»åº“æ—¶ï¼Œå°½é‡é€‰æ‹©æŒç»­æ›´æ–°ï¼Œç‰ˆæœ¬ç¨³å®šçš„ä¼˜è´¨ç±»åº“ï¼Œè¿™æ ·çš„ç±»åº“å¾ˆå°‘ä¼šå‡ºçŽ°åœæ­¢æ›´æ–°ï¼Œæˆ–è€…ç‰ˆæœ¬å¤§æ”¹çš„æƒ…å†µï¼Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¼šç›¸å¯¹çš„ç¨³å®šã€‚å¼•å…¥ç¬¬ä¸‰æ–¹ç±»åº“ä¹‹åŽï¼Œæˆ‘ä»¬å°±è¦æ˜Žç™½ä¸€ä¸ªäº‹å®žï¼Œç¬¬ä¸‰æ–¹ç±»åº“ä¸å¯èƒ½ç™¾åˆ†ç™¾çš„é€‚é…æˆ‘ä»¬çš„é¡¹ç›®ï¼Œæ€»æ˜¯ä¼šæœ‰ä¸€äº›å·²çŸ¥æˆ–æœªçŸ¥çš„å˜æ•°ï¼Œè¿™æ—¶å€™ï¼Œå…¶å®žä¹Ÿæ˜¯å¼•å…¥äº†é£Žé™©ã€‚å¯¹äºŽè¶³å¤Ÿä¼˜ç§€çš„ç±»åº“ï¼Œæˆ‘ä»¬å¯ä»¥ç»™äºˆè¶³å¤Ÿçš„ä¿¡ä»»ï¼Œä½†æ˜¯ï¼Œè°åˆèƒ½å¤Ÿä¿è¯å‘¢ï¼Ÿè¿˜æœ‰ï¼Œå…¶ä»–çš„ä¸æ€Žä¹ˆä¼˜ç§€çš„ç±»åº“å‘¢ï¼Ÿ æˆ‘çš„å»ºè®®æ˜¯å¯¹äºŽä¸€äº›æœ‰é¡¾è™‘çš„ç¬¬ä¸‰æ–¹ç±»åº“ï¼Œå¼•å…¥åŽä¸åº”è¯¥ç›´æŽ¥ä½¿ç”¨ï¼Œè€Œæ˜¯åŠ ä¸€å±‚å°è£…ï¼Œå…¶å®žå°±æ˜¯åŠ ä¸€å±‚éš”ç¦»ã€‚æŠŠç¬¬ä¸‰æ–¹ç±»åº“å°è£…åœ¨ä¸€ä¸ªæ¨¡å—é‡Œé¢ï¼Œç„¶åŽè¿™ä¸ªæ¨¡å—ç»™å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼Œå¦‚æžœé‚£ä¸ªç¬¬ä¸‰æ–¹ç±»åº“å‘ç”Ÿæ¯”è¾ƒå¤§çš„å˜æ›´ï¼Œé‚£ä¹ˆåªæ˜¯å¯¹åº”çš„é‚£ä¸ªå°è£…æ¨¡å—éœ€è¦æ”¹åŠ¨ï¼Œå…¶ä»–æ¨¡å—å¹¶ä¸å—å½±å“ï¼Œè¿™æ ·æˆ‘ä»¬çš„ä»£ç å°±ä¸ä¼šå¤„äºŽè¢«äººç‰µä¸€å‘è€Œå…¨èº«åŠ¨çš„å±€é¢ã€‚ å¼•å…¥ä¸€ä¸ªç¬¬ä¸‰æ–¹ç±»åº“ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä»£ç è‚¯å®šå¯¹å®ƒæœ‰æ‰€ä¾èµ–ï¼Œä½†æ˜¯é€šè¿‡å°è£…éš”ç¦»ï¼Œé¡¹ç›®æ•´ä½“ä¸Šå¯¹å®ƒçš„ä¾èµ–æ€§å¹¶ä¸é«˜ï¼Œå› ä¸ºä¸»è¦éƒ½é›†ä¸­åœ¨é‚£ä¸ªå°è£…å®ƒçš„æ¨¡å—é‡Œäº†ã€‚è¿™æ ·å­ï¼Œæˆ‘ä»¬é¡¹ç›®å¯¹è‡ªèº«çš„æŽ§åˆ¶æƒè¿˜æ˜¯åœ¨è‡ªå·±çš„æ‰‹ä¸­ã€‚ æœ€åŽæœ€åŽè¯´ä¸¤å¥ï¼šé€šè¿‡å°è£…éš”ç¦»ï¼Œæ¥å‡å¼±å¯¹ç¬¬ä¸‰æ–¹ç±»åº“çš„ä¾èµ–ï¼Œä¹Ÿè®¸ä¸Žâ€œæŽ§åˆ¶åè½¬â€çš„å®žçŽ°æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯ä¸Žå…¶é™ä½Žè€¦åˆçš„ç›®æ ‡æ˜¯ä¸€è‡´çš„ã€‚]]></content>
      <categories>
        <category>æ±‚ç´¢</category>
      </categories>
      <tags>
        <tag>think</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[PHPä¸­çš„abstractã€interfaceå’Œtrait]]></title>
    <url>%2Fblog%2Fphp-abstract-interface-trait.html</url>
    <content type="text"><![CDATA[é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œæœ‰å‡ ä¸ªé‡è¦ç‰¹å¾ï¼šç»§æ‰¿æ€§ï¼ŒæŠ½è±¡æ€§ï¼Œå¤šæ€æ€§ç­‰ç­‰ã€‚è¿™é‡Œé’ˆå¯¹PHPè¯­è¨€ï¼Œè®¨è®ºä¸€ä¸‹abstractã€interfaceå’Œtraitï¼Œå…¶ä»–è¯­è¨€å¯èƒ½æœ‰åå·®ã€‚ abstractæŠ½è±¡ç±»åœ¨é¢å‘å¯¹è±¡çš„æ¦‚å¿µä¸­ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯é€šè¿‡ç±»æ¥æç»˜çš„ã€‚å…·ä½“ç±»æ˜¯å®žä¾‹å¯¹è±¡çš„æŠ½è±¡åŒ–ï¼Œè€Œ æŠ½è±¡ç±» åˆ™æ˜¯å…·ä½“ç±»çš„æŠ½è±¡åŒ–ã€‚å®šä¹‰ä¸€ä¸ªå…·ä½“ç±»ï¼Œä½¿ç”¨å…³é”®å­—classï¼›å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè¦å¸¦ä¸Šå…³é”®å­—abstractï¼Œå³abstract classã€‚PHPè¯­è¨€çš„æœºåˆ¶æ¯”è¾ƒå®½æ¾ï¼ŒæŠ½è±¡ç±»å¯ä»¥ç»§æ‰¿äºŽå…¶ä»–æŠ½è±¡ç±»ï¼Œä¹Ÿå¯ä»¥ç»§æ‰¿äºŽå…·ä½“ç±»ï¼Œä½†æ˜¯æŠ½è±¡ç±»æ²¡æœ‰ç›´æŽ¥çš„å®žä¾‹åŒ–å¯¹è±¡ã€‚ 12345678910111213141516171819202122232425262728&lt;?php abstract class AbstractClass1 &#123; // å¼ºåˆ¶è¦æ±‚å­ç±»å®šä¹‰è¿™äº›æ–¹æ³• abstract protected function getValue(); abstract protected function prefixValue($prefix); // æ™®é€šæ–¹æ³•ï¼ˆéžæŠ½è±¡æ–¹æ³•ï¼‰ public function printOut() &#123; print $this-&gt;getValue() . "\n"; &#125; &#125; class ConcreteClass1 extends AbstractClass1 &#123; protected function getValue() &#123; return "ConcreteClass1"; &#125; public function prefixValue($prefix) &#123; return "&#123;$prefix&#125;ConcreteClass1"; &#125; &#125; abstract class AbstractClass2 extends ConcreteClass1 &#123; &#125; æŠ½è±¡æ–¹æ³•æŠ½è±¡ç±»ä¸­å¯ä»¥è®¾ç½®å±žæ€§ï¼Œå®šä¹‰å…·ä½“æ–¹æ³•ï¼Œç‰¹åˆ«ï¼Œè¿˜å¯ä»¥å®šä¹‰ æŠ½è±¡æ–¹æ³•ã€‚å®šä¹‰å®šä¹‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨å…³é”®å­—abstractï¼Œå¹¶ä¸”åªèƒ½åœ¨æŠ½è±¡ç±»ä¸­å®šä¹‰ã€‚æŠ½è±¡ç±»ä¸­ï¼Œåªèƒ½å£°æ˜ŽæŠ½è±¡æ–¹æ³•å…¶è°ƒç”¨æ–¹å¼ï¼ˆå‚æ•°ï¼‰ï¼Œä¸èƒ½å®šä¹‰å…¶å…·ä½“çš„åŠŸèƒ½å®žçŽ°ï¼›è€Œåœ¨æŠ½è±¡ç±»çš„å…·ä½“å­ç±»ä¸­ï¼Œä¸€å®šè¦å°†çˆ¶ç±»ä¸­çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•å…·ä½“åŒ–ï¼š å…·ä½“æ–¹æ³•ä¸å†å¸¦abstractå£°æ˜Žï¼› å…·ä½“æ–¹æ³•çš„è®¿é—®æŽ§åˆ¶å¿…é¡»å’Œçˆ¶ç±»ä¸­ä¸€æ ·ï¼ˆæˆ–è€…æ›´ä¸ºå®½æ¾ï¼‰ï¼› å…·ä½“æ–¹æ³•å®šä¹‰çš„è°ƒç”¨æ–¹å¼å¿…é¡»ä¸ŽæŠ½è±¡æ–¹æ³•çš„å£°æ˜ŽåŒ¹é…ï¼Œå³æ‰€éœ€å‚æ•°çš„æ•°é‡ã€ç±»åž‹å¿…é¡»ä¸€è‡´ã€‚å¦‚æžœè¦å¢žåŠ å‚æ•°ï¼Œåªèƒ½åœ¨æœ«å°¾è¿½åŠ ï¼Œå¹¶ä¸”åªèƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ interfaceé¦–å…ˆï¼ŒæŽ¥å£ä¸æ˜¯ç±»ï¼Œæ—¢ä¸æ˜¯å…·ä½“ç±»ï¼Œä¹Ÿä¸æ˜¯æŠ½è±¡ç±»ï¼ŒæŽ¥å£çš„å®šä¹‰å°±æ²¡æœ‰ç”¨åˆ°å…³é”®å­—classã€‚å®šä¹‰ä¸€ä¸ªæŽ¥å£ï¼Œä½¿ç”¨å…³é”®å­—interfaceï¼š 123456789101112131415161718192021&lt;?php interface a &#123; const b = 'Interface constant'; public function foo(); &#125; interface b &#123; public function bar(); &#125; interface c extends a, b &#123; public function baz(); &#125; class ConcreteClass implements c &#123; public function foo()&#123;&#125; public function baz()&#123;&#125; public function bar()&#123;&#125; &#125; æŽ¥å£æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š æŽ¥å£ä¸èƒ½è¢«å®žä¾‹åŒ–ï¼Œå› ä¸ºæŽ¥å£ä¸æ˜¯ç±»ï¼› æŽ¥å£å¯ä»¥ç»§æ‰¿äºŽå…¶ä»–æŽ¥å£ï¼Œå¹¶ä¸”å¯ä»¥å¤šé‡ç»§æ‰¿ï¼Œä½†ä¸èƒ½ç»§æ‰¿äºŽç±»ï¼› æŽ¥å£ä¸­ä¸èƒ½è®¾ç½®å±žæ€§ï¼Œä½†æ˜¯å¯ä»¥è®¾ç½®å¸¸é‡ï¼› æŽ¥å£çš„æ–¹æ³•åªèƒ½æ˜¯å…¬æœ‰çš„ï¼Œå¹¶ä¸”æ˜¯åªå£°æ˜Žä¸å®šä¹‰ï¼› å…·ä½“ç±»ã€æŠ½è±¡ç±»éƒ½å¯ä»¥ä½¿ç”¨å…³é”®å­—implementsæ¥å®žçŽ°ï¼ˆå¤šä¸ªï¼‰æŽ¥å£ï¼› å…·ä½“ç±»ä¸­ä¸€å®šè¦å…·ä½“åŒ–æ‰€æœ‰è¦å®žçŽ°çš„æŽ¥å£æ–¹æ³•ï¼Œå¹¶ä¸”å®šä¹‰çš„è°ƒç”¨æ–¹å¼å¿…é¡»ä¸ŽæŽ¥å£ä¸­æ‰€å£°æ˜Žçš„åŒ¹é…ï¼Œå³æ‰€éœ€å‚æ•°çš„æ•°é‡ã€ç±»åž‹å¿…é¡»ä¸€è‡´ã€‚å¦‚æžœè¦å¢žåŠ å‚æ•°ï¼Œåªèƒ½åœ¨æœ«å°¾è¿½åŠ ï¼Œå¹¶ä¸”åªèƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ traittraitï¼Œä¸­æ–‡æ„æ€æ˜¯ ç‰¹ç‚¹ï¼Œç®—æ˜¯PHPçš„ä¸€ä¸ªæ–°è¯­æ³•ï¼ˆè‡ªPHP5.4åŠ å…¥ï¼‰ã€‚PHPæœ¬èº«æ˜¯ä¸æ”¯æŒå¤šé‡ç»§æ‰¿çš„ï¼Œtraitå°±æ˜¯ä¸ºäº†å‡å°‘å•ç»§æ‰¿è¯­è¨€çš„é™åˆ¶è€Œæå‡ºï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡traitè‡ªç”±åœ°åœ¨ä¸åŒå±‚æ¬¡ç»“æž„å†…ç‹¬ç«‹çš„ç±»ä¸­å¤ç”¨ä»£ç ã€‚traitç¤ºä¾‹ï¼š 123456789101112131415161718&lt;?php trait A &#123; public $a = 1; public function say() &#123; echo 'a'; &#125; abstract public function selfSay(); &#125; trait B &#123; use A; &#125; class C &#123; use B; public function selfSay() &#123; echo 'c'; &#125; &#125; traitæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š traitä¸æ˜¯ç±»ï¼Œæ— æ³•é€šè¿‡è‡ªèº«æ¥å®žä¾‹åŒ–ï¼Œä¹Ÿä¸èƒ½ç»§æ‰¿æˆ–è€…è¢«ç»§æ‰¿ï¼› ä½†æ˜¯traitä¸­ï¼Œå¯ä»¥å®šä¹‰å±žæ€§ï¼Œå®šä¹‰å…·ä½“æ–¹æ³•ï¼Œè¿˜å¯ä»¥å£°æ˜ŽæŠ½è±¡æ–¹æ³•ï¼› æ­£å¦‚classèƒ½å¤Ÿä½¿ç”¨traitä¸€æ ·ï¼Œtraitä¹Ÿèƒ½å¤Ÿä½¿ç”¨å…¶ä»–traitã€‚åœ¨traitå®šä¹‰æ—¶å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªtraitã€‚ ä½¿ç”¨traitçš„æ—¶å€™è¿˜è¦æ³¨æ„ï¼š ä¼˜å…ˆçº§ã€‚ä»ŽåŸºç±»ç»§æ‰¿çš„æˆå‘˜ä¼šè¢« trait æ’å…¥çš„æˆå‘˜æ‰€è¦†ç›–ã€‚ä¼˜å…ˆé¡ºåºæ˜¯æ¥è‡ªå½“å‰ç±»çš„æˆå‘˜è¦†ç›–äº†traitçš„æ–¹æ³•ï¼Œè€Œtraitåˆ™è¦†ç›–äº†è¢«ç»§æ‰¿çš„æ–¹æ³•ã€‚ å¤šä¸ªtraitã€‚é€šè¿‡é€—å·åˆ†éš”ï¼Œåœ¨useå£°æ˜Žåˆ—å‡ºå¤šä¸ªtraitï¼Œå¯ä»¥éƒ½æ’å…¥åˆ°ä¸€ä¸ªç±»ä¸­ã€‚ å†²çªé—®é¢˜ã€‚å¦‚æžœå¼•å…¥çš„ä¸¤ä¸ªtraitéƒ½å®šä¹‰äº†ä¸€ä¸ªåŒåæ–¹æ³•ï¼Œä¸”æ²¡æœ‰æ˜Žç¡®çš„è§£å†³å†²çªï¼Œé‚£ä¹ˆä»£ç å°†ä¼šäº§ç”Ÿä¸€ä¸ªè‡´å‘½é”™è¯¯ã€‚ä¸ºäº†è§£å†³å¤šä¸ª trait åœ¨åŒä¸€ä¸ªç±»ä¸­çš„å‘½åå†²çªï¼Œå¯ä»¥ä½¿ç”¨insteadofæ“ä½œç¬¦æ¥æ˜Žç¡®æŒ‡å®šä½¿ç”¨å†²çªæ–¹æ³•ä¸­çš„å“ªä¸€ä¸ªï¼Œæˆ–è€…ä½¿ç”¨as æ“ä½œç¬¦å°†å…¶ä¸­ä¸€ä¸ªå†²çªçš„æ–¹æ³•ä»¥å¦ä¸€ä¸ªåç§°æ¥å¼•å…¥ï¼š 123456789101112131415161718192021222324252627282930&lt;?php trait A &#123; public function smallTalk() &#123; echo 'a'; &#125; public function bigTalk() &#123; echo 'A'; &#125; &#125; trait B &#123; public function smallTalk() &#123; echo 'b'; &#125; public function bigTalk() &#123; echo 'B'; &#125; &#125; class Talker &#123; use A, B &#123; B::smallTalk insteadof A; A::bigTalk insteadof B; &#125; &#125; class Aliased_Talker &#123; use A, B &#123; B::smallTalk insteadof A; A::bigTalk insteadof B; B::bigTalk as talk; &#125; &#125; asæ“ä½œç¬¦è¿˜å¯ä»¥ç”¨æ¥è°ƒæ•´æ–¹æ³•çš„è®¿é—®æŽ§åˆ¶ï¼š 1234567891011121314&lt;?php trait HelloWorld &#123; public function sayHello() &#123; echo 'Hello World!'; &#125; &#125; // ä¿®æ”¹ sayHello çš„è®¿é—®æŽ§åˆ¶ class MyClass1 &#123; use HelloWorld &#123; sayHello as protected; &#125; &#125; // ç»™æ–¹æ³•ä¸€ä¸ªæ”¹å˜äº†è®¿é—®æŽ§åˆ¶çš„åˆ«åï¼ŒåŽŸç‰ˆ sayHello çš„è®¿é—®æŽ§åˆ¶åˆ™æ²¡æœ‰å‘ç”Ÿå˜åŒ– class MyClass2 &#123; use HelloWorld &#123; sayHello as private myPrivateHello; &#125; &#125; æœ€åŽPHPé¢å‘å¯¹è±¡å¼€å‘æ—¶ï¼Œè¦çµæ´»åˆ©ç”¨abstractã€interfaceå’Œtraitï¼Œä¸è¦ç”Ÿæ¬ç¡¬å¥—ã€‚ å‚è€ƒ-ç±»ä¸Žå¯¹è±¡-æŠ½è±¡ç±»-ç±»ä¸Žå¯¹è±¡-å¯¹è±¡æŽ¥å£-ç±»ä¸Žå¯¹è±¡-Trait]]></content>
      <categories>
        <category>çŸ¥é“</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Windowsä¸Šç¼–è¯‘PHP]]></title>
    <url>%2Fblog%2Fphp-compile-on-windows.html</url>
    <content type="text"><![CDATA[å¹³æ—¶åœ¨Windowsç³»ç»Ÿä¸ŠåšPHPå¼€å‘ï¼Œéƒ½æ˜¯ç›´æŽ¥ä½¿ç”¨WAMPçš„ç»§æ‰¿çŽ¯å¢ƒã€‚æœ€è¿‘éœ€è¦ç”¨åˆ°ä¸€ä¸ªPHPæ‰©å±•ï¼Œä¹Ÿæ²¡æ‰¾åˆ°çŽ°æˆçš„DLLæ–‡ä»¶ï¼ŒäºŽæ˜¯æƒ³ç€è‡ªå·±ç¼–è¯‘ä¸€ä¸ªã€‚é¦–å…ˆï¼Œéœ€è¦å®‰è£…ä¸€ä¸ªVisual Studio Visual Studioä¸Šå¤§å­¦çš„æ—¶å€™ï¼Œè€å¸ˆæ•™æˆ‘ä»¬ç”¨ VC6.0 ï¼Œæˆ‘å°±åœ¨è‡ªå·±ç”µè„‘ä¸Šè£…äº†ä¸ª Visual Studio 2010*ï¼ŒåŠŸèƒ½å…¨é€‰ï¼Œå äº†å¥½åå‡ GBç©ºé—´ï¼Œç„¶åŽå°±æ²¡æ€Žä¹ˆç”¨äº†ï¼Œçœ‹æ¥åªæ˜¯æƒ³ä½“éªŒä¸€ä¸‹è¿›åº¦æ¡çš„ä¼˜é›…ã€‚åŽæ¥ç”¨ä¸Šäº† *Sublime ï¼Œä»¥ä¸ºæ­¤ç”Ÿè¶³çŸ£ï¼Œæ²¡æƒ³åˆ°ä»Šå¤©è¿˜æ˜¯è¦æ±‚ Visual Studio 2015ï¼Œ ä¸æ„§ä¸ºå¤©ä¸‹ç¬¬ä¸€IDEã€‚ å®‰è£…è¿‡ç¨‹ç•¥åŽ»ï¼š ç†Ÿæ‚‰çš„ç•Œé¢ï¼š å…¶å®žè¿™é‡Œä¸ŽVisual Studio IDEæ²¡æœ‰å¤šå¤§å…³ç³»ï¼Œä¸»è¦æ˜¯è¦ä½¿ç”¨å®ƒçš„æŽ§åˆ¶å°ï¼š PHP SDKPHP For Windowsï¼Œæ˜¯ä¸€ä¸ªPHPå®˜æ–¹æä¾›Windowsç³»ç»Ÿæ”¯æŒçš„ç½‘ç«™ã€‚è¿™é‡Œå¯ä»¥æ‰¾åˆ°ï¼Œå·²ç»ç¼–è¯‘å¥½çš„ã€å¯ä»¥åœ¨Windowsç³»ç»Ÿä¸Šç›´æŽ¥è¿è¡Œçš„PHPï¼ŒPECLä¸Šå„ç§PHPæ‰©å±•çš„DLLæ–‡ä»¶ï¼Œè¿˜æœ‰åœ¨Windowsç³»ç»Ÿä¸Šç¼–è¯‘PHPæ—¶éœ€è¦ç”¨åˆ°çš„ä¸€äº›å·¥å…·ã€‚ åœ¨Windowsç³»ç»Ÿä¸Šç¼–è¯‘PHPï¼Œéœ€è¦å‡†å¤‡ä»¥ä¸‹ææ–™ï¼š PHPæºç ï¼Œæ¯”å¦‚php-7.0.14.tar.gz PHP SDKï¼Œæ¯”å¦‚php-sdk-binary-tools-20110915.zip ç¼–è¯‘æ—¶ä¾èµ–ï¼Œæ¯”å¦‚deps-7.0-vc14-x64.7z ç¼–è¯‘æ­¥éª¤å·¥ä½œç©ºé—´é¦–å…ˆï¼ŒæŠŠphp-sdk-binary-tools-20110915.zipé‡Œé¢çš„å†…å®¹è§£åŽ‹åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œä¾‹å¦‚ï¼šD:\php-sdk-binary-toolsã€‚ç„¶åŽæ‰“å¼€VC2015 x64 CMDï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 12345D:cd D:\php-sdk-binary-tools\bin\phpsdk_setvars.batbin\phpsdk_buildtree.bat phpdevxcopy /E phpdev\vc9\* phpdev\vc14\ å†æŠŠdeps-7.0-vc14-x64.7zé‡Œé¢çš„å†…å®¹è§£åŽ‹åˆ°D:\php-sdk-binary-tools\phpdev\vc14\x64ï¼Œphp-7.0.14.tar.gzé‡Œé¢çš„å†…å®¹è§£åŽ‹åˆ°D:\php-sdk-binary-tools\phpdev\vc14\x64\php-7.0ï¼Œè¿™æ—¶å€™ï¼Œç›®å½•ç»“æž„å¤§æ¦‚å¦‚ä¸‹ï¼š 12345678910111213141516D:\php-sdk-binary-tools\ |--bin\ |--phpdev\ | |--vc6\ | |--vc8\ | |--vc9\ | |--vc14\ | |--x64\ | |--deps\ | |--bin\ | |--include\ | |--lib\ | |--php-7.0\ | |--x86\ |--script\ |--share\ å¼€å§‹ç¼–è¯‘æ‰“å¼€VC2015 x64 CMDï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 123456789D:cd D:\php-sdk-binary-tools\phpdev\vc14\x64\php-7.0buildconfconfigure --helpconfigure nmakenmake snap configure --helpä¼šè¾“å‡ºå¯ç”¨çš„é€‰é¡¹ï¼ŒæŒ‰éœ€é€‰æ‹©ã€‚ ç¼–è¯‘æ‰©å±•å¦‚æžœéœ€è¦ç¼–è¯‘æŸä¸ªPHPæ‰©å±•ï¼Œæ¯”å¦‚åå­—å«someone_extï¼Œ å¯ä»¥å°†å…¶æºç æ”¾ç½®åˆ°D:\php-sdk-binary-tools\phpdev\vc14\x64\php-7.0\ext\someone_extä¸­ï¼Œç„¶åŽæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 12345D:cd D:\php-sdk-binary-tools\phpdev\vc14\x64\php-7.0nmake cleanbuildconf --forceconfigure --help æ­£å¸¸æƒ…å†µä¸‹ï¼Œconfigure --helpçš„è¾“å‡ºä¸­someone_extè¿™ä¸ªPHPæ‰©å±•çš„ç›¸å…³é€‰é¡¹ï¼Œæ‰§è¡Œconfigureå¸¦ä¸Šç›¸å…³é€‰é¡¹å³å¯ã€‚åªç¼–è¯‘someone_extè¿™ä¸ªPHPæ‰©å±•ï¼Œä¸é‡æ–°ç¼–è¯‘PHPï¼Œå¤§æ¦‚çš„å‘½ä»¤å¦‚ä¸‹ï¼š 12configure --disable-all --enable-someone_ext=sharednmake åŽè®°ä¸€å¼€å§‹æåˆ°åˆè¡·æ˜¯æƒ³ç¼–è¯‘ä¸€ä¸ªPHPæ‰©å±•çš„ï¼Œä½†æ˜¯ä¸Šæ–‡åªå­—æœªæï¼Œä¸»è¦æ˜¯å› ä¸ºï¼Œåœ¨ç¼–è¯‘å®ŒPHPåŽï¼Œä¸‹è½½æ‰©å±•çš„æºç æ—¶æ‰å‘çŽ°ï¼Œå®ƒä¸æ”¯æŒWindowsç³»ç»Ÿï¼ˆåªæœ‰config.m4ï¼Œæ²¡æœ‰config.w32ï¼‰ï¼Œæ¬²å“­æ— æ³ªã€‚è¿™ä¸ªæ‰©å±•åå­—å«pecl-gearmanï¼Œä¸‡äº‹æ±‚ä¸å¾—äººï¼Œæœ‰ç©ºè‡ªå·±å†™ä¸€ä¸ªå§ï¼ˆä¼°è®¡å†™ä¸€ä¸ªconfig.w32å°±è¡Œäº†å§ï¼‰ï¼ŒæŒ½å‹‰è‡ªå°Šã€‚ å‚è€ƒ PHP For Windows Build your own PHP on Windows åœ¨Windowsä¸‹ç¼–è¯‘PHPå’ŒPHPæ‰©å±•]]></content>
      <categories>
        <category>èº¬è¡Œ</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>practice</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[PHPä¸­çš„$thisã€selfå’Œparent]]></title>
    <url>%2Fblog%2Fphp-%24this-self-parent.html</url>
    <content type="text"><![CDATA[å¯ç»§æ‰¿æ€§æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹çš„é‡è¦ç‰¹å¾ã€‚åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç”±äºŽç±»ä¸Žç±»ä¹‹é—´ç»§æ‰¿å…³ç³»ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å¼„æ··å¯¹è±¡å±žæ€§çš„çœŸå®žå½’å±žï¼Œåˆ°åº•è‡ªå·±ä»£ç æ‰€è°ƒç”¨çš„æ˜¯çˆ¶ç±»å±žæ€§è¿˜æ˜¯å­ç±»å±žæ€§å‘¢ï¼Ÿè¿™é‡Œé’ˆå¯¹PHPè¯­è¨€ï¼Œè®¨è®ºä¸€ä¸‹$thisã€selfå’Œparentè¿™ä¸‰ä¸ªå…³é”®å­—çš„ä½œç”¨ã€‚ åŸºæœ¬æ¦‚å¿µ å£°æ˜Žä¸€ä¸‹ï¼Œä»¥ä¸‹çš„æ‰€æœ‰æè¿°éƒ½æ˜¯åŸºäºŽPHPçš„E_STRICTæ¨¡å¼ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶çš„PHPä»£ç è¿è¡ŒäºŽE_STRICTæ¨¡å¼ä¸‹ï¼Œå¦åˆ™ä»£ç å¾ˆå®¹æ˜“äº§ç”ŸäºŒä¹‰ã€‚ é¦–å…ˆï¼Œ$thisã€selfå’Œparentåªèƒ½åœ¨ç±»å®šä¹‰å†…éƒ¨ä½¿ç”¨ã€‚ $thisæ˜¯ä¸€ä¸ªä¼ªå˜é‡ï¼Œä¸èƒ½ä¹Ÿä¸éœ€è¦æ‰‹åŠ¨èµ‹å€¼ã€‚åœ¨ç±»å†…éƒ¨å®šä¹‰æ–¹æ³•æ—¶ï¼Œ$thisè‡ªåŠ¨æŒ‡å‘äº†ä¸»å«å¯¹è±¡ï¼Œå³æ˜¯ä¸»å«å¯¹è±¡çš„å¼•ç”¨ã€‚å¦‚æžœæ²¡æœ‰å®žä¾‹åŒ–å¯¹è±¡ï¼Œ$thiså°±æ˜¯ç©ºå€¼ï¼›åœ¨é™æ€æ–¹æ³•ä¸­$thisä¸€ç›´æ˜¯ç©ºå€¼ï¼Œä¸ç®¡æ˜¯è¢«ç±»åè°ƒç”¨ï¼Œè¿˜æ˜¯è¢«å®žä¾‹åŒ–å¯¹è±¡è°ƒç”¨ã€‚ ä¸Ž$thisä¸åŒï¼Œselfä¸æ˜¯ä¸€ä¸ªå˜é‡ï¼Œä¸èƒ½ä½œä¸ºå‚æ•°ä¼ é€’äºˆå‡½æ•°ã€‚åœ¨ç±»å®šä¹‰å†…éƒ¨ï¼ŒselfæŒ‡å‘äº†å½“å‰çš„ç±»ã€‚æ— å…³æœ‰æ²¡æœ‰å®žä¾‹åŒ–å¯¹è±¡ï¼Œselfæ˜¯å½“å‰ç±»çš„å¼•ç”¨ã€‚åœ¨ä»£ç ä¸Šï¼Œä½¿ç”¨selfçš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥ç”¨å½“å‰ç±»åä»£æ›¿ï¼Œä¸”è¿è¡Œç»“æžœä¸ä¼šæ”¹å˜ï¼›ç„¶è€Œï¼Œä½¿ç”¨$this-&gt;çš„åœ°æ–¹ï¼Œå¦‚æžœæ˜¯åœ¨è°ƒç”¨ç±»æ–¹æ³•ï¼ˆä¸æ˜¯ç±»å±žæ€§ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”¨self::ä»£æ›¿ï¼Œè™½ç„¶è¯­æ³•ä¸Šæ²¡æœ‰é”™è¯¯ï¼Œä½†æ˜¯é€»è¾‘ä¸Šä¼šæœ‰å·®å¼‚ï¼Œè¯¦è§ä¸‹é¢ $thisä¸Žselfã€‚ parentä¹Ÿä¸æ˜¯ä¸€ä¸ªå˜é‡ï¼Œä¹Ÿä¸èƒ½ä½œä¸ºå‚æ•°ä¼ é€’äºˆå‡½æ•°ã€‚åœ¨ç±»å®šä¹‰å†…éƒ¨ï¼ŒparentæŒ‡å‘äº†å½“å‰ç±»çš„ç›´æŽ¥çˆ¶ç±»ï¼Œå¦‚æžœå½“å‰ç±»æ²¡æœ‰çˆ¶ç±»ï¼Œä½¿ç”¨parentåˆ™ä¼šæŠ¥é”™ã€‚ $thisä¸Žselfå¯¹äºŽ$thisä¸Žselfï¼Œä¸€èˆ¬è®¤ä¸ºï¼š$thiså¼•ç”¨ç±»çš„å®žä¾‹åŒ–å¯¹è±¡ï¼Œå¯ä»¥è°ƒç”¨ç±»çš„æ‰€æœ‰å±žæ€§å’Œæ–¹æ³•ï¼›è€Œselfå¼•ç”¨ç±»æœ¬èº«ï¼Œä¸Žå®žä¾‹åŒ–å¯¹è±¡æ— å…³ï¼Œåªèƒ½è°ƒç”¨é™æ€èµ„æºï¼ˆå¦‚ç±»å¸¸é‡ã€é™æ€å±žæ€§å’Œé™æ€æ–¹æ³•ï¼‰ã€‚ä½†æ˜¯å®žé™…ä¸Šselfå¯ä»¥â€œè¸©è¿‡ç•Œâ€â€”â€”selfä¹Ÿå¯ä»¥è°ƒç”¨éžé™æ€èµ„æºã€‚ åˆ†æžåœ¨ç±»å®šä¹‰å†…éƒ¨ï¼Œ $this-&gt;åŽé¢å¯ä»¥è¿žæŽ¥å½“å‰ç±»çš„æ‰€ä»¥ç±»å±žæ€§å’Œç±»æ–¹æ³•ï¼Œä½†ä¸èƒ½è¿žæŽ¥ç±»å¸¸é‡ï¼›è€Œself::åŽé¢å¯ä»¥è¿žæŽ¥ç±»å¸¸é‡ã€é™æ€å±žæ€§å’Œ _æ‰€æœ‰ç±»æ–¹æ³•_ã€‚selfå¯ä»¥è°ƒç”¨éžé™æ€æ–¹æ³•ï¼Œå®žé™…ä¸Šæ˜¯è¦å€Ÿç”¨å½“å‰ç±»çš„å®žä¾‹åŒ–å¯¹è±¡æ¥è°ƒç”¨çš„ã€‚åœ¨é™æ€æ–¹æ³•ä¸­ï¼Œselfä¸èƒ½è°ƒç”¨éžé™æ€æ–¹æ³•ï¼Œæ­£å¦‚$thisä¸èƒ½è¢«ä½¿ç”¨ï¼›è€Œåœ¨éžé™æ€æ–¹æ³•ä¸­ï¼Œselfå°±å¯ä»¥è°ƒç”¨å…¶ä»–éžé™æ€æ–¹æ³•äº†ï¼Œæ­£å¦‚$thiså¯ä»¥æ­£å¸¸è¢«ä½¿ç”¨ã€‚é‚£ä¹ˆï¼Œåœ¨éžé™æ€æ–¹æ³•ä¸­è°ƒç”¨å…¶ä»–éžé™æ€æ–¹æ³•ï¼Œä½¿ç”¨$this-&gt;å’Œä½¿ç”¨self::æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ 1234567891011121314151617181920212223&lt;?php class A &#123; public function name() &#123; echo 'A'; &#125; public function thisName() &#123; $this-&gt;name(); &#125; public function selfName() &#123; self::name(); &#125; &#125; class B extends A &#123; public function name() &#123; echo 'B'; &#125; &#125; $b = new B(); $b-&gt;name(); // echo B; $b-&gt;thisName(); // echo B; $b-&gt;selfName(); // echo A; å¯¹äºŽè°ƒç”¨éžé™æ€æ–¹æ³•ï¼Œå¯ä»¥è¿™æ ·æ¥æ€»ç»“$thiså’Œselfçš„åŒºåˆ«ï¼š$thisæ˜¯ç›´æŽ¥æŒ‡å‘ è¿è¡Œæ—¶ çš„å®žä¾‹åŒ–å¯¹è±¡çš„ï¼Œè€Œselfæ˜¯å€Ÿç”¨ å®šä¹‰æ—¶ çš„å®žä¾‹åŒ–å¯¹è±¡ã€‚ï¼ˆselfæ˜¯ä¸èƒ½è°ƒç”¨éžé™æ€å±žæ€§çš„ï¼Œæ‰€ä»¥è¿™ä¸€ç‚¹ä¸éœ€è¦è®¨è®º$thisä¸Žselfçš„åŒºåˆ«ï¼‰ ä½¿ç”¨å‡è®¾çˆ¶ç±»å®šä¹‰äº†ä¸€ä¸ªéžé™æ€æ–¹æ³•aï¼Œé‡Œé¢è°ƒç”¨äº†å¦ä¸€ä¸ªéžé™æ€æ–¹æ³•bï¼š å¦‚æžœå¸Œæœ›å­ç±»çš„å®žä¾‹åŒ–å¯¹è±¡è°ƒç”¨aæ—¶å¯ä»¥ä½¿ç”¨å­ç±»è‡ªèº«çš„bï¼Œé‚£ä¹ˆï¼Œçˆ¶ç±»çš„aå®šä¹‰æ—¶åº”è¯¥ä½¿ç”¨$this-&gt;b();ï¼› å¦‚æžœå¸Œæœ›å­ç±»çš„å®žä¾‹åŒ–å¯¹è±¡è°ƒç”¨aæ—¶å¯ä»¥ä½¿ç”¨çˆ¶ç±»çš„bï¼Œé‚£ä¹ˆï¼Œçˆ¶ç±»çš„aå®šä¹‰æ—¶å°±åº”è¯¥ä½¿ç”¨self::b();ã€‚ $thisä¸Žparentåœ¨ç±»å®šä¹‰å†…éƒ¨ï¼ŒparentæŒ‡å‘äº†å½“å‰ç±»çš„ç›´æŽ¥çˆ¶ç±»ã€‚parentå’Œselfçš„æ„ä¹‰ä¸åŒï¼Œä½†æ˜¯æ€§è´¨ä¸Šæ˜¯å‡ ä¹Žä¸€æ ·çš„ã€‚ åˆ†æžparent::åŽé¢å¯ä»¥è¿žæŽ¥ç›´æŽ¥çˆ¶ç±»çš„å¸¸é‡ã€é™æ€å±žæ€§å’Œ _æ‰€æœ‰ç±»æ–¹æ³•_ã€‚parentå¯ä»¥è°ƒç”¨éžé™æ€æ–¹æ³•ï¼Œå®žé™…ä¸Šæ˜¯å€Ÿç”¨ç›´æŽ¥çˆ¶ç±»çš„å®žä¾‹åŒ–å¯¹è±¡æ¥è°ƒç”¨çš„ã€‚ç›´æŽ¥çœ‹ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940&lt;?php class A &#123; public function name() &#123; echo 'A'; &#125; public function thisName() &#123; $this-&gt;name(); &#125; public function selfName() &#123; self::name(); &#125; &#125; class B extends A &#123; public function name() &#123; echo 'B'; &#125; public function parentName() &#123; parent::name(); &#125; public function bparentName() &#123; parent::name(); &#125; &#125; class C extends B &#123; public function name() &#123; echo 'C'; &#125; public function parentName() &#123; parent::name(); &#125; &#125; $c = new C(); $c-&gt;name(); // echo C; $c-&gt;parentName(); // echo B; $c-&gt;bparentName(); // echo A; å¯¹äºŽè°ƒç”¨éžé™æ€æ–¹æ³•ï¼Œparentæ˜¯å€Ÿç”¨ å®šä¹‰æ—¶ çš„ç›´æŽ¥çˆ¶ç±»çš„å®žä¾‹åŒ–å¯¹è±¡ã€‚ï¼ˆparentä¹Ÿæ˜¯ä¸èƒ½è°ƒç”¨éžé™æ€å±žæ€§çš„ï¼‰ ä½¿ç”¨åŽæœŸé™æ€ç»‘å®šæ€§è´¨ä¸Šï¼Œselfå’Œparentå¯ä»¥å½’ä¸ºä¸€ç±»ï¼Œå…¶å®žå®ƒä»¬è¿˜æœ‰ä¸€ä¸ªåŒç±»â€”â€”staticã€‚èŒƒå›´è§£æžæ“ä½œç¬¦::ï¼Œé™¤äº†ç±»åï¼Œå°±åªæœ‰è¿™ä¸‰ä¸ªå…³é”®å­—å¯ä»¥ä½¿ç”¨ã€‚ åˆ†æžä¸Šé¢ $thisä¸Žself çš„è®¨è®ºæ˜¯åŸºäºŽå¯¹éžé™æ€æ–¹æ³•çš„è°ƒç”¨ï¼Œå¦‚æžœæ˜¯å¯¹é™æ€æ–¹æ³•çš„è°ƒç”¨å‘¢ï¼Ÿè¿˜æ˜¯ç›´æŽ¥çœ‹ä»£ç ï¼š 12345678910111213141516171819202122&lt;?php class A &#123; public static function name() &#123; echo 'A'; &#125; public static function staticName() &#123; static::name(); &#125; public static function selfName() &#123; self::name(); &#125; &#125; class B extends A &#123; public static function name() &#123; echo 'B'; &#125; &#125; B::name(); // echo B; B::staticName(); // echo B; B::selfName(); // echo A; è¿™é‡Œstatic::çš„ä½œç”¨ï¼Œå«åš åŽæœŸé™æ€ç»‘å®šï¼Œç”¨äºŽåœ¨ç»§æ‰¿èŒƒå›´å†…å¼•ç”¨é™æ€è°ƒç”¨çš„ç±»ã€‚ä»Žè¯­è¨€å†…éƒ¨è§’åº¦çœ‹ï¼Œâ€œåŽæœŸç»‘å®šâ€çš„æ„æ€æ˜¯è¯´ï¼šstatic::ä¸è¢«è§£æžä¸º å®šä¹‰æ—¶ å½“å‰ç±»ï¼Œè€Œæ˜¯åœ¨å®žé™… è¿è¡Œæ—¶ çš„ä½¿ç”¨ç±»ã€‚static::åŽé¢åªèƒ½è¿žæŽ¥é™æ€å±žæ€§å’Œé™æ€æ–¹æ³•ï¼Œå¼¥è¡¥äº†$thisä¸Žselfçš„ä¸è¶³ã€‚ ä½¿ç”¨å‡è®¾çˆ¶ç±»å®šä¹‰äº†ä¸€ä¸ªé™æ€æ–¹æ³•aï¼Œé‡Œé¢è°ƒç”¨äº†å¦ä¸€ä¸ªé™æ€æ–¹æ³•bï¼š å¦‚æžœå¸Œæœ›å­ç±»è°ƒç”¨aæ—¶å¯ä»¥ä½¿ç”¨å­ç±»è‡ªèº«çš„bï¼Œé‚£ä¹ˆï¼Œçˆ¶ç±»çš„aå®šä¹‰æ—¶åº”è¯¥ä½¿ç”¨static::b();ï¼› å¦‚æžœå¸Œæœ›å­ç±»è°ƒç”¨aæ—¶å¯ä»¥ä½¿ç”¨çˆ¶ç±»çš„bï¼Œé‚£ä¹ˆï¼Œçˆ¶ç±»çš„aå®šä¹‰æ—¶å°±åº”è¯¥ä½¿ç”¨self::b();ã€‚ æœ€åŽæ‰€ä»¥åœ¨å®šä¹‰ç±»çš„æ—¶å€™ï¼Œåº”è¯¥ä½¿ç”¨$thisçš„åœ°æ–¹å°±ä½¿ç”¨$thisï¼Œåº”è¯¥ä½¿ç”¨selfçš„åœ°æ–¹å°±ä½¿ç”¨selfï¼Œparentä¼°è®¡ä¼šå¾ˆå°‘ç”¨åˆ°ï¼Œæ€»ä¹‹ä¸è¦æ··ç€ç”¨äº†ã€‚ å‚è€ƒ-ç±»ä¸Žå¯¹è±¡-åŸºæœ¬æ¦‚å¿µ-ç±»ä¸Žå¯¹è±¡-èŒƒå›´è§£æžæ“ä½œç¬¦-ç±»ä¸Žå¯¹è±¡-åŽæœŸé™æ€ç»‘å®š-ç±»ä¸Žå¯¹è±¡-åŸºæœ¬æ¦‚å¿µ]]></content>
      <categories>
        <category>çŸ¥é“</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[HTMLä¸­å•å¼•å·çš„è½¬ä¹‰ç¬¦]]></title>
    <url>%2Fblog%2Fphp-escape-apostrophe-in-html.html</url>
    <content type="text"><![CDATA[å°±åœ¨ä»Šå¤©ï¼ˆ2016-11-12ï¼‰ï¼Œä¸€ä¸ªæ­£å¸¸è¿è¡Œäº†å‡ ä¸ªæœˆçš„Webç®¡ç†ç³»ç»Ÿï¼Œçªç„¶å‡ºçŽ°äº†ä¸€ä¸ªBUGï¼Œè€Œä¸”åªé’ˆå¯¹ä¸ªåˆ«ç”¨æˆ·ï¼Œå…¶ä»–ç”¨æˆ·ä½¿ç”¨æ­£å¸¸ï¼›æŽ’æŸ¥äº†ä¸€ä¸‹ï¼Œå‘çŽ°é—®é¢˜å°±å‡ºåœ¨HTMLçš„è½¬ä¹‰ç¬¦ä¸Šã€‚ HTMLçš„è½¬ä¹‰ç¬¦å°±ç®—æ²¡æŸ¥çœ‹è¿‡HTMLçš„ç¬¦å·è¡¨ï¼ŒHTMLå†™çš„å¤šäº†ï¼Œä¹Ÿè‡ªç„¶ä¼šçŸ¥é“ç©ºæ ¼çš„è½¬ä¹‰ç¬¦æ˜¯&amp;nbsp;ã€‚å…¶ä»–ä¸€äº›å¸¸ç”¨çš„è½¬ä¹‰ç¬¦è¿˜æœ‰ï¼š æ˜¾ç¤º è½¬ä¹‰å®žä½“åç§° è½¬ä¹‰å®žä½“ç¼–å· â€œ &qout; &#34; &amp; &amp; &#38; &lt; &lt; &#60; &gt; &gt; &#62; â€¦ â€¦ â€¦ æœ‰äº›ç¬¦å·æ²¡æœ‰è½¬ä¹‰çš„å®žä½“åç§°ï¼Œä½†ä¸€å®šæœ‰è½¬ä¹‰çš„å®žä½“ç¼–å·ï¼Œå¯ä»¥æŸ¥çœ‹HTML ASCII å‚è€ƒæ‰‹å†Œã€‚è¿™é‡Œå…ˆè¯´æ˜Žå•å¼•å·&#39;çš„è½¬ä¹‰ç¬¦æ˜¯&amp;#39;ï¼Œ ä¸‹é¢å†æ¥é™ˆè¿°ä»Šå¤©é‡åˆ°çš„BUGã€‚ è¿˜åŽŸçŽ°åœºPHPå¼€å‘è€…ç»å¸¸ä¼šæŠŠä¸€äº›æ•°æ®ä¿å­˜åœ¨HTMLé¡µé¢ä¸Šï¼Œæ–¹ä¾¿JSå¼€å‘è€…è°ƒç”¨ï¼Œæ¯”å¦‚è¯´ï¼ŒæŠŠç”¨æˆ·çš„ä¸€äº›ä¸ªäººä¿¡æ¯è®°å½•åœ¨é¡µé¢ä¸Šï¼š 1234567891011//php&lt;?php $user = array( "id" =&gt; 1 "name" =&gt; "å‚æœ¬", "work" =&gt; "è´µå¹²", "addr" =&gt; "ä¸è¯¦'", );?&gt;//html&lt;button class="btn user-btn" data-user='&lt;?php echo json_encode($user); ?&gt;' &gt;æŸ¥çœ‹ä¿¡æ¯&lt;/button&gt; è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œbuttonæ ‡ç­¾çš„classçš„å€¼ç”¨åŒå¼•å·åŒ…åˆï¼Œè€Œdata-userçš„å€¼ç”¨å•å¼•å·åŒ…åˆï¼Œå› ä¸ºPHPä¸­çš„json_encodeå‡½æ•°ä¼šäº§ç”ŸåŒå¼•å·ï¼Œå¦‚æžœdata-userçš„å€¼ç”¨åŒå¼•å·åŒ…åˆï¼Œç¢°ä¸Šjson_encodeå‡½æ•°äº§ç”Ÿçš„åŒå¼•å·ï¼Œå°±ä¼šæå‰é—­åˆï¼Œä¿å­˜çš„å€¼å°±å¤±çœŸäº†ã€‚ ä½†æ˜¯ï¼Œå¦ä¸€ä¸ªé—®é¢˜ä¹Ÿéšä¹‹è€Œæ¥ï¼šæ•°ç»„userçš„addrå±žæ€§çš„å€¼æ˜¯&quot;ä¸è¯¦&#39;&quot;ï¼Œè¿™ä¸ªå€¼ç”±ç”¨æˆ·å¡«å†™ï¼Œä¸çŸ¥é“æœ‰æ„è¿˜æ˜¯æ— æ„ï¼Œå€¼ä¸­å¸¦æœ‰ä¸€ä¸ªå•å¼•å·ï¼ŒäºŽæ˜¯data-userçš„å€¼è¿˜æ˜¯è¢«æå‰é—­åˆè€Œå¤±çœŸäº†ã€‚ è¿™è¯¥æ€Žä¹ˆè§£å†³å‘¢ï¼Ÿ æ­£åˆ™æ›¿æ¢å½“ç„¶æ˜¯ç”¨æ­£åˆ™åŒ¹é…æ›¿æ¢çš„æ–¹æ³•å•Šï¼ä¸€å¼€å§‹æˆ‘ä»¥ä¸ºå•å¼•å·&#39;çš„è½¬ä¹‰ç¬¦æ˜¯\&#39;ï¼Œæ¯•ç«Ÿç±»Cè¯­è¨€éƒ½æ˜¯è¿™æ ·å­ï¼ŒäºŽæ˜¯å°±å†™äº†ä¸€ä¸ªæ­£åˆ™æ›¿æ¢ï¼ŒæŠŠ&#39;ï¼ˆä¸åŒ…æ‹¬\&#39;ï¼‰æ¢æˆ\&#39;ï¼š 1preg_replace('/([^\\])\'/', '$1\\\'', json_encode($user)); è¿è¡Œä¸€ä¸‹ï¼ŒæŠ¥é”™äº†ã€‚å¯èƒ½æ˜¯å› ä¸ºä¼˜å…ˆçº§é™åˆ¶ï¼Œ&#39;/[^\\]\&#39;/&#39;ä¸­å…ˆè½¬ä¹‰äº†]ï¼ŒäºŽæ˜¯å°±æŠ¥å‡ºä¸­æ‹¬å·æ²¡é—­åˆçš„é”™è¯¯ã€‚é‚£å°±åŠ ä¸Šä¸ªæ‹¬å·()ï¼ŒåŒºåˆ†ä¸€ä¸‹ï¼š 1preg_replace('/([^(\\)])\'/', '$1\\\'', json_encode($user)); å“ˆï¼Œæ›¿æ¢æ˜¯æˆåŠŸäº†ï¼Œå¯æ˜¯\&#39;ä¸­è¿˜æ˜¯å¸¦æœ‰&#39;ï¼Œdata-userçš„å€¼è¿˜æ˜¯è¢«æå‰é—­åˆäº†â€¦â€¦ è§£å†³åŠžæ³•ç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹ï¼Œæ‰çŸ¥é“HTMLä¸­&#39;çš„è½¬ä¹‰ç¬¦æ ¹æœ¬ä¸æ˜¯\&#39;ï¼Œè€Œæ˜¯&amp;#39;ï¼ŒäºŽæ˜¯ï¼Œæœ€åŽçš„è§£å†³åŠžæ³•å°±æ˜¯ï¼š 1preg_replace('/\'/', '&amp;#39;', json_encode($user)); æŠŠæ•°æ®ç›´æŽ¥ä¿å­˜åœ¨é¡µé¢æ ‡ç­¾çš„dataå±žæ€§ä¸Šï¼Œè¿™ç§å®žçŽ°æ–¹å¼ç»å¸¸ä¼šç”¨åˆ°çš„å§ï¼Œä½†æ˜¯è¦æ³¨æ„è½¬ä¹‰ä¸€ä¸‹å•å¼•å·æˆ–è€…åŒå¼•å·ï¼š 1preg_replace(array('/\'/', '/"/'), array('&amp;#39;', '&amp;#34;'), json_encode($user)); æœ€åŽä¸¤å¥æœ€åŽè¯´ä¸¤å¥ï¼Œåªè¦æ˜¯BUGï¼Œä¸€å®šèƒ½ç™¾åˆ†ç™¾é‡çŽ°ï¼›BUGä¸é’ˆå¯¹è°ï¼ŒBUGé’ˆå¯¹æ‰€æœ‰äººã€‚]]></content>
      <categories>
        <category>èº¬è¡Œ</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ‰¹é‡æ›´æ–°çŸ­ID]]></title>
    <url>%2Fblog%2Fmysql-mass-update-short-id.html</url>
    <content type="text"><![CDATA[ç”Ÿæˆå”¯ä¸€ç ï¼ˆIDï¼‰çš„æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œä¸€èˆ¬è¦å‡å°‘å†²çªï¼Œå°±è¦å¢žåŠ ç é•¿ã€‚å¯æ˜¯ï¼Œå¾ˆå¤šåº”ç”¨åœºæ™¯ä¸­ï¼ˆæ¯”å¦‚æŠŠå”¯ä¸€ç é™„åœ¨URLä¸­ï¼‰ï¼Œæˆ‘ä»¬å°±éœ€è¦æ¯”è¾ƒçŸ­çš„å”¯ä¸€ç ã€‚ Hashidsè¿™é‡Œå…ˆæŽ¨èä¸€ä¸ªç”ŸæˆçŸ­IDçš„å¼€æºåº“â€”â€”Hashidsï¼Œå®ƒçš„å®žçŽ°åŽŸç†å¤§æ¦‚æ˜¯æ ¹æ®é•¿çš„å”¯ä¸€ç ï¼Œé€šè¿‡è½¬ç ï¼Œç”ŸæˆçŸ­çš„å”¯ä¸€ç ã€‚å¦‚æžœæƒ³è¦å¾—åˆ°å°½é‡çŸ­çš„å”¯ä¸€ç ï¼Œé‚£ä¹ˆåŽŸç åº”è¯¥æ˜¯çº¯æ•°å­—IDã€‚ Mysqlçš„è‡ªå¢žIDä»¥Mysqlçš„è‡ªå¢žIDä½œä¸ºåŽŸç ï¼Œå€ŸåŠ©Hashidsï¼Œå°±å¯ä»¥å¾—åˆ°æ¯”è¾ƒçŸ­çš„å”¯ä¸€ç ã€‚æ’å…¥ä¸€æ¡è®°å½•å†æ›´æ–°å­—æ®µï¼Œå…¶å®žçŽ°è¿‡ç¨‹æ˜¯å…ˆInsertï¼Œç„¶åŽUpdateã€‚ä½†æ˜¯ï¼Œå¦‚æžœæ˜¯æ‰¹é‡æ’å…¥è®°å½•ï¼Œé‚£åˆåº”è¯¥æ€Žæ ·æ›´æ–°çŸ­IDå­—æ®µå‘¢ï¼Ÿ æ‰¹é‡æ›´æ–°ä¸åŒå€¼å› ä¸ºçŸ­IDæ¥æºäºŽè‡ªå¢žIDï¼Œæ‰€ä»¥å¿…ç„¶æ˜¯å…ˆæ’å…¥è®°å½•ï¼Œæ‰èƒ½èŽ·å–åˆ°çŸ­IDã€‚åœ¨æ‰¹é‡æ’å…¥è®°å½•åŽï¼Œå†ä¸€æ¡ä¸€æ¡åœ°åŽ»æ›´æ–°çŸ­IDå­—æ®µï¼Œæ•ˆçŽ‡è‚¯å®šå¾ˆæ…¢ã€‚ å¦‚æžœæœ‰Hashidsåœ¨Mysqlä¸­æœ‰å®žçŽ°å‡½æ•°ï¼ˆæ¯”å¦‚è¯´ï¼Œå‡½æ•°åå­—å«HASHIDï¼‰çš„è¯ï¼Œé‚£ä¹ˆæ›´æ–°è¯­å¥å¯ä»¥è¿™æ ·å†™ï¼š 1UPDATE table_name SET `short_id` = HASHID(`id`) WHERE `short_id` IS NULL; äº‹å®žæ˜¯ç›®å‰è¿˜æ²¡æœ‰å®žçŽ°HASHIDè¿™ä¸ªå‡½æ•°ï¼Œè¿™é‡Œè®°ä¸‹ä¸€ä¸ªæ–¹æ³•ï¼Œä»¥å¤‡åŽå¿˜ï¼š 12345678910111213// with laravel$list = DB::table('table_name')-&gt;whereNull('short_id')-&gt;select('id')-&gt;get();$ids= [];$sql = ' CASE id ';foreach($list as $k=&gt;$v) &#123; $ids[] = $v-&gt;id; $short_id = Hashids::encode($v-&gt;id); $sql .= sprintf('WHEN %d THEN "%s" ', $v-&gt;id, $short_id);&#125;$sql .= ' END ';DB::table('table_name')-&gt;whereIn('id', $ids)-&gt;update(['short_cdkey'=&gt;DB::raw($sql)]); æœ€åŽä¸¤å¥CASE WHENæ˜¯ä¸€ä¸ªå¥½ä¸œè¥¿ï¼Œè¦å¤šçµæ´»ä½¿ç”¨ã€‚]]></content>
      <categories>
        <category>èº¬è¡Œ</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[CONCAT å’Œ GROUP_CONCAT]]></title>
    <url>%2Fblog%2Fmysql-concat-and-group_concat.html</url>
    <content type="text"><![CDATA[åœ¨MySQLæ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æžœæŸ¥è¯¢è¯­å¥é‡Œä½¿ç”¨äº†GROUP BYï¼Œé‚£ä¹ˆSELECTè¡¨å­—æ®µæ—¶åªèƒ½èŽ·å–åˆ†ç»„å†…ç¬¬ä¸€æ¡è®°å½•çš„æ•°æ®å€¼ï¼Œè¦æ€Žæ ·æ‰èƒ½å¾—åˆ°åˆ†ç»„å†…æ‰€æœ‰è®°å½•çš„å­—æ®µæ•°æ®å€¼å‘¢ï¼Ÿ CONCATMySQLä¸­ï¼Œä¸»è¦çš„è¿žæŽ¥å­—ç¬¦ä¸²å‡½æ•°ï¼Œå°±æ˜¯ CONCATã€‚CONCATå‡½æ•°ç”¨äºŽå°†å¤šä¸ªæ•°æ®å€¼è¿žæŽ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚è¯­æ³•ï¼š 1CONCAT(str1, str2, â€¦) æ³¨æ„ï¼šå¦‚æžœæœ‰ä»»ä½•ä¸€ä¸ªå‚æ•°ä¸ºNULLï¼Œé‚£ä¹ˆè¿”å›žç»“æžœå°±æ˜¯NULLã€‚æ€Žæ ·é¿å…å‚æ•°ä¸ºNULLçš„æƒ…å†µï¼Œå½“ç„¶æ˜¯ä½¿ç”¨CASE WHENï¼š 1CONCAT(CASE WHEN str1 is NULL THEN "NULL" ELSE str1 END, CASE WHEN str2 is NULL THEN "NULL" ELSE str2 END, â€¦) è¿˜æœ‰ä¸ªè¿žæŽ¥å­—ç¬¦ä¸²çš„å‡½æ•°ï¼ŒCONCAT_WSï¼Œè¡¨ç¤ºâ€œCONCAT With Separatorâ€ï¼Œæ˜¯CONCATçš„ç‰¹æ®Šå½¢å¼ã€‚CONCAT_WSå‡½æ•°ç”¨äºŽå°†å¤šä¸ªæ•°æ®å€¼ç”¨æŒ‡å®šçš„åˆ†éš”ç¬¦è¿žæŽ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚è¯­æ³•ï¼š 1CONCAT_WS(separator, str1, str2, â€¦) æ³¨æ„ï¼šå¦‚æžœç¬¬ä¸€å‚æ•°ï¼Œå³åˆ†éš”ç¬¦ï¼Œè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²&#39;&#39;ï¼Œç›¸å½“äºŽç§»é™¤åˆ†éš”ç¬¦ï¼Œè®¾ç½®ä¸ºNULLï¼Œé‚£ä¹ˆè¿”å›žç»“æžœå°±æ˜¯NULLï¼›å…¶ä»–å‚æ•°å¦‚æžœä¸ºNULLï¼Œå°±ä¼šè¢«å¿½ç•¥ï¼Œè¿›è€Œè¿žæŽ¥ä¸‹ä¸ªå‚æ•°ï¼Œä½†æ˜¯ç©ºå­—ç¬¦ä¸²&#39;&#39;ä¸ä¼šè¢«å¿½ç•¥ã€‚ä¸ºäº†ä¿è¯è¿žæŽ¥æ•°æ®çš„é¡ºåºï¼Œè¿˜å¾—ä½¿ç”¨CASE WHENï¼š 1CONCAT_WS(separator, CASE WHEN str1 is NULL THEN "NULL" ELSE str1 END, CASE WHEN str2 is NULL THEN "NULL" ELSE str2 END, â€¦) GROUP_CONCATGROUP_CONCATå‡½æ•°å¯ä»¥å°†åˆ†ç»„å†…çš„æ•°æ®è¿žæŽ¥åˆæˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å› ä¸ºæ˜¯åšåˆ†ç»„å†…æ“ä½œï¼Œæ‰€ä»¥GROUP_CONCATçš„åŠŸèƒ½ä¼šå¤æ‚ä¸€äº›ï¼Œå¤„ç†å¯ä»¥è®¾ç½®åˆ†éš”ç¬¦ï¼Œè¿˜å¯ä»¥å¯¹è®°å½•æ•°æ®åšåŽ»é‡ï¼ŒæŽ’åºå¤„ç†ã€‚åœ¨é€»è¾‘ä¸Šï¼ŒGROUP_CONCATåº”è¯¥æ˜¯ä¸ŽGROUP BYé…åˆä½¿ç”¨çš„ï¼Œå½“ç„¶å°±ç®—æŸ¥è¯¢è¯­å¥ä¸­æ²¡æœ‰å‡ºçŽ°GROUP BYï¼Œä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨GROUP_CONCATçš„ï¼Œå°±æ˜¯æŠŠæ•´ä¸ªè®°å½•æ•°æ®çœ‹ä½œä¸€ä¸ªç»„äº†ã€‚è¯­æ³•ï¼š 12345GROUP_CONCAT( [DISTINCT] expr [,expr ...] [ORDER BY &#123;unsigned_integer | col_name | formula&#125; [ASC | DESC] [,col_name ...]] [SEPARATOR str_val]) æ³¨æ„ï¼šåˆ†éš”ç¬¦ç¼ºçœä¸ºä¸€ä¸ªé€—å·&quot;,&quot;ï¼Œå¯ä»¥è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²&#39;&#39;ï¼Œç›¸å½“äºŽç§»é™¤åˆ†éš”ç¬¦ï¼Œä½†æ˜¯ä¸èƒ½è®¾ç½®ä¸ºNULLï¼Œå¦åˆ™æŠ¥é”™ï¼›å¦‚æžœæŸä¸ªè¿žæŽ¥å‚æ•°çš„å€¼ä¸ºNULLï¼Œå°±ä¼šè¢«å¿½ç•¥ï¼Œè¿›è€Œè¿žæŽ¥ä¸‹ä¸ªå‚æ•°ï¼Œä½†æ˜¯ç©ºå­—ç¬¦ä¸²&#39;&#39;ä¸ä¼šè¢«å¿½ç•¥ã€‚ åº”ç”¨åœ¨MySQLæ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æžœæŸ¥è¯¢è¯­å¥é‡Œä½¿ç”¨äº†GROUP BYï¼Œé‚£ä¹ˆSELECTè¡¨å­—æ®µæ—¶åªèƒ½èŽ·å–åˆ†ç»„å†…ç¬¬ä¸€æ¡è®°å½•çš„æ•°æ®å€¼ï¼Œè¦æ€Žæ ·æ‰èƒ½å¾—åˆ°åˆ†ç»„å†…æ‰€æœ‰è®°å½•çš„å­—æ®µæ•°æ®å€¼å‘¢ï¼Ÿ å‡è®¾ï¼Œæœ‰ä¸¤å¼ è¡¨ï¼Œuserså’Œfriendsï¼šusers: id name 1 user1 2 user2 3 user3 friends: id user_id name create_at 1 1 friend1 1457452801 2 1 friend2 1457452802 3 1 friend3 1457452803 4 2 friend4 1457452804 5 2 friend5 1457452805 6 2 friend6 1457452806 7 3 friend7 1457452807 8 3 friend8 1457452808 9 3 friend9 1457452809 æƒ³è¦èŽ·å–æ¯ä¸€ä¸ªuserçš„æ‰€æœ‰firendï¼Œå¹¶ä¸”æŒ‰ç…§create_até¡ºæŽ’åºçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨GROUP_CONCATå’ŒCONCAT_WSï¼š 12345678910111213SELECT u.id as user_id, u.name as user_name, GROUP_CONCAT( CONCAT_WS("%", f.id, f.name) ORDER BY f.create_at ASC SEPARATOR ";" ) as friends_groupFROM users as u JOIN friends as f on u.id = f.user_idWHERE 1; æœ€åŽæœ€åŽè¯´ä¸¤å¥ï¼Œåœ¨MySQLä¸­æŸ¥è¯¢æ•°æ®æ—¶ï¼Œè¦èŽ·å–åˆ†ç»„å†…çš„æ•°æ®æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨GROUP_CONCATã€‚è¿˜æœ‰ç»„å†…æ•°æ®æŽ’åºï¼Œä¹Ÿå¯ä»¥å€Ÿç”¨GROUP_CONCATã€‚]]></content>
      <categories>
        <category>çŸ¥é“</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SELECT INTO å’Œ INSERT SELECT INTO]]></title>
    <url>%2Fblog%2Fmysql-select-into-and-insert-select-into.html</url>
    <content type="text"><![CDATA[å¼€å‘ä¸­ç»å¸¸ä¼šç¢°åˆ°æŠŠå·²å­˜åœ¨è®°å½•çš„æ•°æ®èµ‹ç»™æ–°è®°å½•çš„åœºæ™¯ï¼Œæ€Žæ ·æ‰èƒ½æŠŠSELECTå’ŒINSERTåˆå¹¶åˆ°ä¸€ä¸ªæ‰§è¡Œè¯­å¥ä¸­å‘¢ï¼Ÿ SELECT INTOè¯­æ³•ï¼š 1SELECT `t1`.`column1` AS column1, `t1`.`column2` AS column2, 'column3' AS column3 INTO `Table2` FROM `Table1` AS t1; æ³¨æ„ï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šåˆ›å»ºè¡¨Table2ï¼Œæ‰€ä»¥ï¼Œæ‰§è¡Œå‰è¦æ±‚è¡¨Table2ä¸å­˜åœ¨ã€‚ INSERT SELECT INTOè¯­æ³•ï¼š 1Insert INTO `Table2` (column1, column2, ...) SELECT value1,value2,... FROM `Table1`; æ³¨æ„ï¼šæ‰§è¡Œå‰è¦æ±‚è¡¨Table2å­˜åœ¨åˆ‡æœ‰å›ºå®šç»“æž„ï¼›SELECTå‰é¢æ²¡æœ‰VALUESå…³é”®å­—ï¼›FROMåŽé¢å¯ä»¥è·Ÿæ›´å¤æ‚çš„æŸ¥è¯¢è¯­å¥ã€‚]]></content>
      <categories>
        <category>çŸ¥é“</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[jQuery Ajaxçš„å°è£…]]></title>
    <url>%2Fblog%2Fjs-encapsulate-jquery-ajax.html</url>
    <content type="text"><![CDATA[ç¨‹åºå¼€å‘æ—¶ï¼Œç»å¸¸å¼•å…¥ç¬¬ä¸‰æ–¹ç±»åº“ã€‚å¦‚æžœç±»åº“ä¸­çš„ä¸€äº›å‡½æ•°è°ƒç”¨å¾—éžå¸¸é¢‘ç¹ï¼Œé‚£ä¹ˆå°±åº”è¯¥è€ƒè™‘è‡ªå·±å°è£…ä¸€ä¸‹ï¼Œè¿™æ ·å¯¹äºŽåŽé¢çš„ä»£ç è¿­ä»£ï¼Œä¼šå¸¦æ¥å¾ˆå¤§ä¾¿åˆ©ã€‚è¿™é‡Œé’ˆå¯¹jQuery.ajaxï¼Œè®¨è®ºä¸€ä¸‹å…¶å¦‚ä½•å°è£…ï¼Œå¯¹äºŽå…¶ä»–ç±»åº“æˆ–è®¸ä¹Ÿé€‚ç”¨ã€‚ $.ajaxjQueryçš„ajaxçš„ç¡®æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œä¸»è¦å®žçŽ°å¼‚æ­¥HTTPè¯·æ±‚çš„åŠŸèƒ½ï¼Œç›¸ä¿¡å¤§å®¶éƒ½æœ‰ç”¨è¿‡ï¼Œå¹¶ä¸”è§‰å¾—å¥½ç”¨ã€‚jQueryä»Ž1.5.0ç‰ˆæœ¬å¼€å§‹ï¼Œå¼•å…¥äº†deferredå¯¹è±¡ï¼Œ$.ajaxï¼ˆéƒ½çŸ¥é“$æ˜¯jQueryçš„åˆ«ç§°ï¼‰çš„è°ƒç”¨å°±å˜å¾—æ›´åŠ ç®€å•å¿«æ·ã€‚æ¯”å¦‚ï¼Œå‘èµ·ä¸€ä¸ªPOSTè¯·æ±‚ï¼š 123var url = '/';var data = &#123;&#125;;$.post(url, data).done(function() &#123;&#125;).fail(function() &#123;&#125;); $.ajaxæœ¬èº«å°±æ˜¯å¯¹ XMLHttpRequest çš„å°è£…ï¼Œå¹¶ä¸”å·²ç»å°è£…å¾—éžå¸¸å¥½ã€‚å€Ÿç”¨$.ajaxï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸¤è¡Œä»£ç å°±èƒ½å®Œæˆä¸€ä¸ªå¼‚æ­¥HTTPè¯·æ±‚ï¼›$.ajaxåœ¨å¾ˆå¤šåº”ç”¨åœºæ™¯ä¸­ä¹Ÿé€‚ç”¨ï¼Œé‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆè¿˜è¦è‡ªå·±å†å°è£…ä¸€å±‚å‘¢ï¼Ÿ æ¯•ç«Ÿï¼Œä¸–é—´æ²¡æœ‰ç™¾åˆ†ç™¾å®Œç¾Žçš„ç¬¬ä¸‰æ–¹ç±»åº“ï¼Œå„ä¸ªå¼€å‘é¡¹ç›®æœ‰å„è‡ªä¸åŒçš„éœ€æ±‚ï¼Œ$.ajaxæœ¬èº«ä¸å¯èƒ½å®Œå…¨åŽ»é€‚é…ï¼Œè‡ªå·±æ”¹è£…ä¸€ä¸‹å¾ˆæœ‰å¿…è¦ï¼›å¯¹äºŽä»¥åŽçš„ä»£ç å˜æ›´ï¼Œå¦‚æžœç›´æŽ¥ä½¿ç”¨$.ajaxï¼Œé‚£ä¹ˆæŽ§åˆ¶æƒå°±åœ¨jQueryæ‰‹ä¸­ï¼Œè€Œè‡ªå·±å°è£…ä¸€å±‚ï¼ŒæŽ§åˆ¶æƒå°±åœ¨è‡ªå·±æ‰‹ä¸­ï¼Œåˆ°æ—¶å€™æ”¹ä»£ç ä¼šç®€å•å¾ˆå¤šã€‚ è¿˜æ˜¯å…ˆè¯´è¯´ï¼Œæ€Žä¹ˆå°è£…$.ajaxå§ã€‚æ¯”å¦‚ï¼Œå°è£…$.postï¼š 12345678910111213141516171819202122// å‡è®¾å‰é¢å·²ç»å¼•å…¥äº†jQueryfunction BL() &#123; this._author = 'BreezeLin'; this._version = '0.1.0';&#125;BL.prototype = &#123; post: function(url, data) &#123; return $.post(url, data); &#125;,&#125;// æˆ–è€…BL.prototype = &#123; post: function() &#123; return $.post.apply(this, arguments); &#125;,&#125;;// ä½¿ç”¨var B = new BL();B.post('/', &#123;&#125;).done(function() &#123;&#125;).fail(function() &#123;&#125;);// åŽé¢å‡¡æ˜¯è¦å‘èµ·å¼‚æ­¥POSTè¯·æ±‚ï¼Œéƒ½æ˜¯ä½¿ç”¨B.postï¼Œè€Œä¸æ˜¯$.post å“ˆï¼Œè¯´å¥½çš„å°è£…ï¼Œç»“æžœåªæ˜¯ç›´æŽ¥è¿”å›žï¼Œè¿™æ ·çš„å°è£…è·Ÿä¸å°è£…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæ˜¯çš„ï¼Œå½“å‰æ˜¯æ²¡æœ‰åŒºåˆ«ï¼Œä¸€åˆ‡éƒ½æ˜¯ä¸ºä»¥åŽçš„ä»£ç è¿­ä»£åšå‡†å¤‡ã€‚å‡è®¾æœ‰é‚£ä¹ˆä¸€å¤©ï¼ŒjQueryå¼€å§‹æ”¶è´¹æˆ–è€…åœæ­¢æ›´æ–°ï¼Œå¦‚æžœæˆ‘ä»¬åšäº†è¿™ä¸€å±‚çš„å°è£…ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨BL.prototypeä¸­ï¼Œå®žçŽ°æˆ–è€…åŠ å›ºå¼‚æ­¥HTTPåŠŸèƒ½â€”â€”å®žé™…ä¸Šæˆ‘ä»¬çš„ä»£ç å®Œå…¨å¯ä»¥æ‘†è„±å¯¹jQueryä¾èµ–ï¼ŒæŽ§åˆ¶æƒå§‹ç»ˆåœ¨æˆ‘ä»¬æ‰‹ä¸Šï¼ˆæ€Žä¹ˆæœ‰ç§â€œæŽ§åˆ¶åè½¬â€çš„æ„Ÿè§‰ï¼Ÿï¼‰ã€‚ å‚æ•°è¿‡æ»¤ä¸€èˆ¬çš„HTTPä¼ è¾“ï¼Œä¸ºäº†ç¡®ä¿å®‰å…¨æ€§ï¼Œéƒ½ä¼šå¯¹è¯·æ±‚å‚æ•°è¿›è¡ŒåŠ å¯†ã€‚$.ajaxæ˜¯åŽŸæ ·æäº¤çš„ï¼Œä¸èƒ½æ»¡è¶³ï¼ˆæ‰€ä»¥è‚¯å®šè¦å°è£…å•Šï¼‰ã€‚å¦‚æžœä¸€å¼€å§‹å°±æœ‰åšè‡ªå·±çš„ä¸€å±‚å°è£…ï¼Œé‚£ä¹ˆåŽæœŸä»Žå‚æ•°æ— åŠ å¯†ï¼Œåˆ°å‚æ•°åŠ å¯†ï¼Œæˆ–è€…åŠ å¯†ç®—æ³•å˜æ›´éƒ½æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚åƒä¸‹é¢ä»£ç ï¼Œåªéœ€è¦ä¿®æ”¹my_encryptå‡½æ•°ï¼Œå°±è¡Œäº†ï¼š 1234567891011121314function BL() &#123; this._author = 'BreezeLin'; this._version = '0.1.0';&#125;// åŠ å¯†å‡½æ•°function my_encrypt(data) &#123; return data;&#125;BL.prototype = &#123; post: function(url, data) &#123; data = my_encrypt(data); return $.post(url, data); &#125;,&#125;; ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¯·æ±‚è·¯å¾„ï¼Œå¯èƒ½ä¼šéœ€è¦è¡¥å…¨ã€æ ¡éªŒç­‰æ“ä½œï¼Œä¹Ÿå¯ä»¥åœ¨BL.prototypeé‡Œé¢è®¾ç½®ã€‚å¦‚æžœæœ‰å¿…è¦ï¼Œè¿˜å¯ä»¥è€ƒè™‘å¼€å‘ç¬¬ä¸‰å‚æ•°ï¼Œç¬¬å››å‚æ•°â€¦â€¦ å›žè°ƒå‡½æ•°æ”¹è£… åˆ«çœ‹â€œå‚æ•°è¿‡æ»¤â€å’Œâ€œå›žè°ƒå‡½æ•°æ”¹è£…â€åå­—ä¸Šä¸å¯¹ä»—ï¼Œå®žé™…ä¸Šä»–ä»¬æ˜¯å¼‚æ­¥HTTPè¯·æ±‚çš„ä¸€å‰ä¸€åŽï¼šä¸€ä¸ªæ˜¯è¯·æ±‚å‰å¤„ç†ï¼Œä¸€ä¸ªæ˜¯è¿”å›žåŽå¤„ç†ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å‡è®¾å¼€å‘é¡¹ç›®ä¸­æœ‰è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ï¼š é¡¹ç›®çš„HTTPæœåŠ¡æŽ¥å£é‡‡ç”¨æ•°æ®æ— åŠ å¯†è¿”å›žï¼› å‰ç«¯JSçš„å¼‚æ­¥è¯·æ±‚ä½¿ç”¨çš„æ˜¯$.ajaxï¼Œå¹¶ä¸”è¿›è¡Œäº†å¦‚ä¸‹å°è£…ï¼š 123456789function BL() &#123; this._author = 'BreezeLin'; this._version = '0.1.0';&#125;;BL.prototype = &#123; post: function(url, data) &#123; return $.post(url, data); &#125;,&#125;; é¡¹ç›®ä»£ç ä¸­ï¼Œå¤šå¤„ä½¿ç”¨äº†å¦‚ä¸‹ä»£ç ï¼š 1234567891011var B = new BL();var url = '/';var data = &#123;&#125;;B.post().done(function(result) &#123; // ä¼ªä»£ç ï¼Œå¯¹è¿”å›žæ•°æ®çš„ä¸€äº›æ“ä½œ if(result.status==1) &#123; handle_with(result.data); &#125; else &#123; alert(result.info); &#125;&#125;); é—®é¢˜æ¥äº†ï¼Œé¡¹ç›®çš„HTTPæœåŠ¡æŽ¥å£å¼€å§‹é‡‡ç”¨æ•°æ®åŠ å¯†è¿”å›žã€‚ å¦‚æžœå½“åˆè‡ªå·±æ²¡æœ‰å°è£…$.ajaxï¼Œé‚£ä¹ˆé¡¹ç›®ä¸­ç”¨åˆ°å¼‚æ­¥è¯·æ±‚çš„åœ°æ–¹åªèƒ½ä¸€è¡Œä¸€è¡Œä»£ç åœ°åŽ»æ”¹ï¼ˆæ‰€ä»¥çŸ¥é“è‡ªå·±å°è£…çš„å¥½å¤„äº†å§ï¼‰ã€‚çŽ°åœ¨æ˜¯æœ‰è‡ªå·±å°è£…ä¸”å¤šå¤„è°ƒç”¨äº†ï¼Œä½†æ˜¯è¯·æ±‚è¿”å›žæœ‰å˜æ›´ï¼Œé‚£è¯¥æ€Žä¹ˆåŠžå‘¢ï¼Ÿ å…¶å®žè¿™æ˜¯ä¸€é“é¢è¯•é¢˜ï¼Œå•å‡­è¿™ä¸ªé—®é¢˜å°±å¯ä»¥å±•å¼€å†™æˆä¸€ç¯‡æ–‡ç« äº†ã€‚è¿™ä¸ªé—®é¢˜ï¼Œä»¥å‰é¢è¯•çš„æ—¶å€™äººå®¶é—®è¿‡æˆ‘ï¼ŒåŽæ¥é¢è¯•çš„æ—¶å€™æˆ‘ä¹Ÿé—®è¿‡äººå®¶ï¼Œè™½ç„¶ä¸æ˜¯ç™¾åˆ†ç™¾çš„åŽŸé¢˜ï¼Œä½†æ˜¯æ ¸å¿ƒæ€æƒ³æ˜¯ä¸€æ ·çš„ã€‚ å…ˆçœ‹é—®é¢˜ï¼šé¡¹ç›®ä¸­ï¼Œdoneå‡½æ•°å·²ç»è¢«å¤§é‡ä½¿ç”¨ï¼Œä¸€ä¸ªä¸ªåœ°åŽ»æ”¹ï¼Œå·¥ç¨‹é‡å¤ªå¤§ï¼›ä½†æ˜¯doneçš„å‡½æ•°å‚æ•°ä¸­çš„resultå·²ç»è¢«åŠ å¯†ï¼Œä¸èƒ½ç›´æŽ¥ä½¿ç”¨ï¼Œæ¯”å¦‚alert(result.info);å¹¶ä¸èƒ½å¾—åˆ°é¢„æœŸç»“æžœã€‚ è§£å†³åŠžæ³•ï¼šè¿˜æ˜¯å¾—ä¿®æ”¹doneå‡½æ•°ï¼Œåœ¨å“ªé‡Œæ”¹å‘¢ï¼Ÿåœ¨BL.prototypeé‡Œé¢æ”¹ã€‚è¿™å…¶å®žæ˜¯å¯¹JavaScriptä¸­å‡½æ•°çš„callæˆ–è€…applyï¼Œargumentsç­‰çŸ¥è¯†ç‚¹çš„è€ƒæŸ¥ï¼š 12345678910111213141516171819202122232425262728function BL() &#123; this._author = 'BreezeLin'; this._version = '0.1.0';&#125;;// è§£å¯†å‡½æ•°function my_decrypt(data) &#123; return data;&#125;BL.prototype = &#123; post: function(url, data) &#123; var $deferred = $.post(url, data); var $done = $deferred.done; $deferred.done = function() &#123; var arg1 = arguments[0]; if(typeof arg1 === 'function') &#123; var func = function() &#123; var args = arguments; var result = args[0]; args[0] = my_decrypt(result); return arg1.apply(this, args); &#125;; arguments[0] = func; &#125; return $done.apply(this, arguments); &#125;; return $deferred; &#125;,&#125;; å“ˆå“ˆï¼Œä»£ç æ˜¯ä¸æ˜¯æœ‰ç‚¹ç»•ï¼Œç»†å¿ƒè¯»ä¸€ä¸‹ï¼Œè¿˜æ˜¯æŒºç²¾å½©çš„ã€‚è¿™æ˜¯ä¸€ä¸ªäºŒé‡æ”¹è£…ï¼Œå…ˆæ”¹è£…äº†doneå‡½æ•°ï¼Œåœ¨æ”¹è£…äº†doneå‡½æ•°å‚æ•°ï¼ˆå—¯ï¼Œå¥½åƒæ¯”åŽŸæ¥çš„é¢è¯•é¢˜å¤æ‚äº†ç‚¹ï¼Œå¼€å§‹è¿˜ä»¥ä¸ºå®žçŽ°ä¸äº†äº†ï¼‰ã€‚å°±è¿™æ ·ï¼Œæœ¬æ¥è°ƒç”¨äº†doneå‡½æ•°çš„åœ°æ–¹ä¸ç”¨æ”¹åŠ¨ä»£ç ï¼Œç¨‹åºä¹Ÿå¯ä»¥èƒ½å¤Ÿæ­£å¸¸è¿è¡Œäº†ã€‚ æœ€åŽæœ€åŽè¯´ä¸¤å¥ï¼šé¡¹ç›®å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šå¼•å…¥ä¸€äº›ç¬¬ä¸‰æ–¹ç±»åº“ï¼Œè¿™æ ·è‡ªå·±ä»£ç å°±ä¼šâ€œä¾èµ–â€è¿™äº›ç±»åº“ï¼›æˆ‘ä»¬è‡ªå·±å¯¹å…¶å°è£…ä¸€å±‚ï¼ŒæŠŠæŽ§åˆ¶æƒæŽŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ï¼Œè¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚è‡ªå·±å°è£…ä»£ç ï¼Œå¯¹åŽé¢ä¸å¯é¢„æœŸçš„å˜æ›´é£Žé™©ï¼Œè¿˜æ˜¯æœ‰ç›¸å¯¹é«˜çš„å¯æŽ§æ€§ã€‚jQuery.ajaxåªæ˜¯ä¸€ä¸ªä¾‹å­ï¼Œä»¥å…¶ä¸ºé•œï¼Œå¯¹é¢‘ç¹ä½¿ç”¨çš„ç±»åº“åŠ ä¸€å±‚è‡ªå·±çš„å°è£…ï¼Œä¿è¯è‡ªå·±çš„æŽ§åˆ¶æƒã€‚]]></content>
      <categories>
        <category>èº¬è¡Œ</category>
      </categories>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ—¶é—´çš„ç°çƒ¬]]></title>
    <url>%2Fblog%2Ffilm-ashes-of-time.html</url>
    <content type="text"><![CDATA[ç¬¬ä¸€æ¬¡çœ‹ã€Šä¸œé‚ªè¥¿æ¯’ã€‹ï¼Œé‚£äº›ç‹¬ç™½ï¼Œä¸€å¥å¥æˆ³å…¥å¿ƒè‚ºï¼›åŽæ¥æ¯æ¬¡çœ‹å®Œï¼Œéƒ½æƒ³å†™ç‚¹ä¸œè¥¿ï¼Œå´å‘çŽ°å†™çš„è¿˜æ˜¯é‚£ä¸€å¥å¥ç‹¬ç™½ã€‚ æ…•å®¹å«£ä¸€ç›´åœ¨é—®ï¼Œé—®ä½ æœ€å–œæ¬¢çš„äººæ˜¯ä¸æ˜¯æˆ‘ï¼›å­¤å¥³ä¸€ç›´åœ¨ç­‰ï¼Œç­‰é‚£ä¸ªä¸ºå¥¹æŠ¥ä»‡çš„äººå‡ºçŽ°ï¼› æ­¦å£«ä¸€å¿ƒæƒ³å›žåˆ°å®¶ä¹¡ï¼Œå†çœ‹ä¸€çœ¼æ¡ƒèŠ±ï¼›æ´ªä¸ƒä¸€å¿ƒæƒ³å‡ºåŽ»é—¯è¡ï¼Œå°±ç®—å¸¦ä¸Šå¦»å­ï¼› é»„è¯å¸ˆå–äº†åŠåŸ•é†‰ç”Ÿæ¢¦æ­»ï¼Œæ¸æ¸å¿˜äº†ä¸€åˆ‡ï¼›æ¬§é˜³é”‹ä¹Ÿå–äº†åŠåŸ•é†‰ç”Ÿæ¢¦æ­»ï¼Œå´è®°å¾—æ›´æ¸…æ¥šï¼š è®°å¾—æ›¾ç»æœ‰ä¸ªäººé—®ä»–ï¼Œæœ€çˆ±çš„äººæ˜¯ä¸æ˜¯æˆ‘ï¼›è®°å¾—æ›¾ç»æœ‰ä¸ªäººç­‰ä»–ï¼Œç­‰ä»–å›žåŽ»ï¼› è®°å¾—æ›¾ç»å‡ºæ¥é—¯è¡ï¼Œå´æ²¡æœ‰å¸¦ä¸Šå¥¹ï¼›è®°å¾—æ›¾ç»æƒ³è¿‡å›žåŽ»ï¼Œå´å§‹ç»ˆæ²¡æœ‰â€¦â€¦ æ‰€ä»¥è¯ï¼Œå¹´é’äººå””å¥½ç‡çŽ‹å®¶å«æ˜Žæ˜Žç³»çˆ±ï¼Œååå””è®²]]></content>
      <categories>
        <category>æœ‰æ„Ÿ</category>
      </categories>
      <tags>
        <tag>life</tag>
        <tag>film</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„PHPæ‰©å±•]]></title>
    <url>%2Fblog%2Fphp-a-simple-extension.html</url>
    <content type="text"><![CDATA[PHPåŸºäºŽCè¯­è¨€ç¼–å†™ï¼Œæ”¯æŒè‡ªå®šä¹‰æ‰©å±•ï¼Œæ‰©å±•è‡ªç„¶ä¹Ÿæ˜¯åŸºäºŽCè¯­è¨€ç¼–å†™å’¯ã€‚å¤§å­¦é‡Œå­¦ï¼ˆæ°´ï¼‰è¿‡Cè¯­è¨€ï¼Œå†™ä¸€ä¸ªç®€å•çš„PHPæ‰©å±•ï¼Œåº”è¯¥æ²¡é—®é¢˜å§ã€‚ è¿è¡ŒçŽ¯å¢ƒ OSï¼šLinux PHPï¼š5.6 phpizeï¼š20131226 æ–°å»ºé¡¹ç›®æ ‡å‡†çš„è‡ªåŠ¨ç”Ÿæˆé¦–å…ˆè¦å‡†å¤‡ä¸€ä»½ PHPæºä»£ç  ã€‚å°†æºä»£ç åŒ…è§£åŽ‹åŽï¼Œåœ¨extç›®å½•é‡Œï¼ˆPHPè‡ªå¸¦æ‰©å±•çš„æºä»£ç å°±å­˜æ”¾åœ¨è¿™é‡Œï¼‰ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåå­—å«åšext_skelçš„å¯è¿è¡Œæ–‡ä»¶ã€‚è¿™ä¸ªext_skelæ–‡ä»¶å°±æ˜¯PHPæä¾›ç»™æˆ‘ä»¬æ¥åˆ›å»ºæ‰©å±•é¡¹ç›®çš„ï¼Œç”¨æ³•ï¼š 12$ cd ext/$ ./ext_skel --extname=my_ext_name æ‰§è¡Œå¦‚ä¸Šå‘½ä»¤åŽï¼Œå½“å‰è·¯å¾„ä¸‹å°±ä¼šå¤šäº†ä¸€ä¸ªåå­—å«my_ext_nameçš„ç›®å½•ï¼Œé‡Œé¢å­˜æ”¾ç€ä¸€ä¸ªè§„èŒƒçš„PHPæ‰©å±•é¡¹ç›®ä»£ç ï¼Œè¿™äº›éƒ½æ˜¯ext_skelè‡ªåŠ¨ç”Ÿæˆçš„ã€‚ä¸»è¦çš„æ–‡ä»¶æ˜¯è¿™å‡ ä¸ªï¼š config.m4ï¼ˆå¯¹åº”unixï¼‰ config.w32ï¼ˆå¯¹åº”windowsï¼‰ my_ext_name.c php_my_ext_name.h å¦‚æžœå¯¹æ‰©å±•ç»“æž„å·²ç»è¶³å¤Ÿç†Ÿæ‚‰ï¼Œ./ext_skelå‘½ä»¤åŽé¢å¸¦ä¸Š--no-helpå‚æ•°ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ä¸­å°±ä¸ä¼šå‡ºçŽ°å¤šä½™çš„æ³¨é‡Šã€‚ æ‰‹åŠ¨åˆ›å»ºå½“ç„¶ï¼Œæ²¡æœ‰ext_skelï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨å»ºç«‹ä¸€ä¸ªPHPæ‰©å±•é¡¹ç›®ï¼Œå…ˆæ–°å»ºä¸€ä¸ªç›®å½•æ¥å­˜æ”¾ä»£ç ï¼š 12$ mkdir my_ext_name$ cd my_ext_name ç„¶åŽæ–°å»ºä¸€ä¸ª config.m4 æ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹é…ç½®ï¼š 12345678//config.m4PHP_ARG_ENABLE(my_ext_name, whether to enable my_ext_name support,[ --enable-my_ext_name Enable my_ext_name support])if test "$PHP_MY_EXT_NAME" != "no"; then PHP_SUBST(MY_EXT_NAME_SHARED_LIBADD) PHP_NEW_EXTENSION(my_ext_name, my_ext_name.c, $ext_shared)fi è§£é‡Šä¸€ä¸‹ï¼š PHP_ARG_ENABLEå‡½æ•°æ˜¯ç”¨æ¥é…ç½®æ‰©å±•çš„å·¥ä½œæ–¹å¼çš„ï¼Œå¦‚æžœè¯¥æ‰©å±•ä¾èµ–å…¶ä»–æ‰©å±•ï¼Œåº”è¯¥ä½¿ç”¨PHP_ARG_WITHå‡½æ•°ï¼ˆè¿™é‡Œä¸ç”¨ï¼‰ï¼› PHP_SUBSTå‡½æ•°å°†å˜é‡è¾“å‡ºåˆ°ç”±configureç”Ÿæˆçš„æ–‡ä»¶ä¸­ï¼› PHP_NEW_EXTENSIONå‡½æ•°å£°æ˜Žäº†è¯¥æ‰©å±•çš„åç§°ï¼ˆå¦‚my_ext_nameï¼‰ã€éœ€è¦çš„æºæ–‡ä»¶åï¼ˆå¦‚my_ext_name.cï¼‰ã€æ­¤æ‰©å±•çš„ç¼–è¯‘å½¢å¼ï¼ˆ$ext_sharedï¼‰ã€‚$ext_sharedè¿™ä¸ªå‚æ•°è¡¨æ˜Žè¯¥æ‰©å±•ä¸æ˜¯ä¸€ä¸ªé™æ€æ¨¡å—ï¼Œè€Œæ˜¯åœ¨PHPè¿è¡Œæ—¶åŠ¨æ€åŠ è½½çš„ã€‚æ›´å¤šå†…å®¹å‚è§ã€ŠPHPæ‰©å±•å¼€å‘ä¸Žå†…æ ¸åº”ç”¨ã€‹çš„ ç¬¬äº”ç«  ã€‚ ç¼–å†™å‡½æ•°æŽ¥ä¸‹æ¥ï¼ŒæŠŠæƒ³è¦å®žçŽ°çš„åŠŸèƒ½å†™å…¥æ‰©å±•ä¸­ã€‚å†™ç‚¹ä»€ä¹ˆå¥½å‘¢ï¼Ÿå…¶å®žæˆ‘æƒ³å†™ä¸€ä¸ªå‹å¥½æ—¶é—´è½¬åŒ–çš„å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ€Žæ ·çš„å‡½æ•°ï¼Ÿç”¨PHPè¯­è¨€è¡¨è¾¾ä¼šç›´è§‚ç‚¹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839function php_friendly_time($time) &#123; $arg_time = null; $now_time = null; $dif_time = null; $ret_time = null; $timeinfo = null; if(is_int($time)) &#123; $arg_time = $time; &#125; else if(is_string($time)) &#123; $arg_time = strtotime($time); &#125; else &#123; return null; &#125; $now_time = time(); $dif_time = $now_time - $arg_time; if($dif_time&lt;60) &#123; $ret_time = 'just now'; &#125; else if($dif_time&lt;120) &#123; $ret_time = 'one minute ago'; &#125; else if($dif_time&lt;3600) &#123; $ret_time = (int)($dif_time/60) . ' minutes ago'; &#125; else if($dif_time&lt;7200) &#123; $ret_time = 'one hour ago'; &#125; else if($dif_time&lt;86400) &#123; $ret_time = (int)($dif_time/3600) . ' hours ago'; &#125; else if($dif_time&lt;172800) &#123; $timeinfo = getdate($arg_time); $ret_time = 'one day ago ' . $timeinfo['hours'] . ':' . $timeinfo['minutes']; &#125; else if($dif_time&lt;1209600) &#123; $timeinfo = getdate($arg_time); $ret_time = (int)($dif_time/86400) . ' days ago ' . $timeinfo['hours'] . ':' . $timeinfo['minutes']; &#125; else &#123; $ret_time = date("Y-m-d H:i:s", $arg_time); &#125; return $ret_time;&#125; å¥½ï¼Œæƒ³è¡¨è¾¾çš„å¤§æ¦‚å°±æ˜¯è¿™ä¸ªæ„æ€ï¼Œé‚£ä¹ˆç”¨Cè¯­è¨€æ€Žä¹ˆåœ¨PHPæ‰©å±•å®žçŽ°å‘¢ï¼Ÿ å¤´æ–‡ä»¶æŒ‰ç…§Cè¯­è¨€å¼€å‘è§„èŒƒï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªå¤´æ–‡ä»¶php_my_ext_name.hï¼Œè¿™é‡Œä¸»è¦æ˜¯åšä¸€äº›å®å®šä¹‰æ“ä½œï¼š 1234567891011//php_my_ext_name.h#ifndef PHP_MY_EXT_NAME_H#define PHP_MY_EXT_NAME_H#define phpext_my_ext_name_ptr &amp;my_ext_name_module_entry#define PHP_MY_EXT_NAME_VERSION "0.1.0"extern zend_module_entry my_ext_name_module_entry;#endif ç¨‹åºæ–‡ä»¶åˆ›å»ºä¸€ä¸ªç¨‹åºæ–‡ä»¶my_ext_name.cï¼Œé‡Œé¢è¦å†™çš„ä»£ç å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š 1234567891011121314151617181920212223242526272829303132333435//my_ext_name.c#ifdef HAVE_CONFIG_H#include "config.h"#endif#include "php.h"#include "php_my_ext_name.h"PHP_FUNCTION(friendly_time)&#123; ...&#125;const zend_function_entry my_ext_name_functions[] = &#123; PHP_FE(friendly_time, NULL) PHP_FE_END&#125;;zend_module_entry my_ext_name_module_entry = &#123; STANDARD_MODULE_HEADER, "my_ext_name", my_ext_name_functions, NULL, /* MINIT */ NULL, /* MSHUTDOWN */ NULL, /* RINIT */ NULL, /* RSHUTDOWN */ NULL, /* MINFO */ PHP_MY_EXT_NAME_VERSION, STANDARD_MODULE_PROPERTIES&#125;;#ifdef COMPILE_DL_MY_EXT_NAMEZEND_GET_MODULE(my_ext_name)#endif ä¸»è¦æ˜¯è¿™å‡ ä¸ªæ­¥éª¤ï¼š é¦–å…ˆï¼ŒåŠ è½½ä¸€äº›éœ€è¦çš„å¤´æ–‡ä»¶ï¼› ç”¨PHP_FUNCTIONè¿™ä¸ªå®å‡½æ•°å®šä¹‰æƒ³è¦åœ¨PHPä¸­å®žçŽ°çš„æ‰©å±•å‡½æ•°ï¼Œå‚æ•°åç§°å°†ä¼šæ˜¯åœ¨PHPä¸­è°ƒç”¨çš„å‡½æ•°åç§°ï¼Œå¦‚ï¼šfriendly_timeï¼› ç„¶åŽåœ¨ä¸€ä¸ªzend_function_entryç»“æž„ä½“æ•°ç»„ä¸­ï¼Œç”¨PHP_FEï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªå®å‡½æ•°ï¼‰æ³¨å†Œåˆšåˆšå®šä¹‰çš„æ‰©å±•å‡½æ•°ï¼Œå¦‚ï¼šfriendly_timeï¼› æŽ¥ä¸‹æ¥ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ªzend_module_entryç»“æž„ä½“ä¸­å¡«å†™æ‰©å±•æ¨¡å—çš„å…¥å£ä¿¡æ¯ï¼Œå½“ç„¶è¿™ä¸ªç»“æž„ä½“çš„åå­—è¦è·Ÿæ‰©å±•åå¯¹åº”ï¼Œå¦‚ï¼šmy_ext_name_module_entryï¼› æœ€åŽï¼Œåˆ¤æ–­ä¸€ä¸‹è¿™ä¸ªæ‰©å±•æ¨¡å—æ˜¯å¦è¢«åŠ¨æ€é“¾æŽ¥ï¼Œå¦‚æžœæ˜¯ï¼Œå°±æ‰§è¡ŒZEND_GET_MODULEå®å‡½æ•°ï¼ˆåœ¨è¿™é‡Œä¸€å®šæ˜¯ï¼‰ã€‚ ç®€å•çš„ä»‹ç»ä¸€ä¸‹PHP_FUNCTIONï¼Œä»–çš„å®å®šä¹‰å¦‚ä¸‹ï¼š 1234#define PHP_FUNCTION ZEND_FUNCTION#define ZEND_FUNCTION(name) ZEND_NAMED_FUNCTION(ZEND_FN(name))#define ZEND_NAMED_FUNCTION(name) void name(INTERNAL_FUNCTION_PARAMETERS)#define ZEND_FN(name) zif_##name æ‰€ä»¥å‘¢ï¼ŒPHP_FUNCTION(friendly_time)æœ€ç»ˆä¼šè¢«è½¬åŒ–æˆï¼š 1void zif_friendly_time(INTERNAL_FUNCTION_PARAMETERS) è¿™æ ·å­çœ‹ï¼Œä»£ç æ˜¯ä¸æ˜¯è§‰å¾—ç†Ÿæ‚‰å¤šäº†ï¼Ÿè¿™æ‰æ˜¯æ­£å¸¸çš„Cä»£ç å•Šï¼å¤§å®¶æœ‰æ²¡æœ‰æ³¨æ„åˆ°my_ext_name_functionsæ•°ç»„é‡Œæ²¡æœ‰,åˆ†éš”ï¼Ÿæ¥çœ‹çœ‹PHP_FEçš„å®å®šä¹‰ï¼š 12#define ZEND_FE(name, arg_info) ZEND_FENTRY(name, ZEND_FN(name), arg_info, 0)#define ZEND_FENTRY(zend_name, name, arg_info, flags) &#123; #zend_name, name, arg_info, (zend_uint) (sizeof(arg_info)/sizeof(struct _zend_arg_info)-1), flags &#125;, äºŽæ˜¯ï¼ŒPHP_FE(friendly_time, NULL)æœ€ç»ˆä¼šè¢«è½¬åŒ–æˆï¼š 1&#123;"friendly_time",zif_walu_hello,NULL, (zend_uint) (sizeof(NULL)/sizeof(struct _zend_arg_info)-1), 0 &#125;, å¯ä»¥çœ‹åˆ°,å·²ç»å¸¦ä¸Šäº†ã€‚å¦‚æžœæ‰©å±•æ¨¡å—é‡Œæœ‰å¤šä¸ªå‡½æ•°ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨PHP_FUNCTIONæ¥å®šä¹‰ï¼Œå¦‚PHP_FUNCTION(more_function){...}ï¼›ç„¶åŽåœ¨my_ext_name_functionsæ•°ç»„ä¸­ä»¥ä¸Žfriendly_timeåŒæ ·çš„å½¢å¼æ³¨å†Œå‡½æ•°ï¼Œå¦‚ï¼šPHP_FE(more_function)ã€‚ å…·ä½“å®žçŽ°é‚£ä¹ˆï¼ŒPHP_FUNCTION(friendly_time)å‡½æ•°å…·ä½“è¦æ€Žä¹ˆå®žçŽ°å‘¢ï¼Ÿå…ˆä¸Šä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455PHP_FUNCTION(friendly_time)&#123; char* strg; int argc; int len; int dif_time; long arg_time; long now_time; struct tm tm_time; zval **arg; argc = ZEND_NUM_ARGS(); if (argc == 0) &#123; RETURN_NULL(); &#125; if (zend_parse_parameters(argc TSRMLS_CC, "Z", &amp;arg) == FAILURE) &#123; RETURN_NULL(); &#125; if (Z_TYPE_PP(arg) == IS_STRING) &#123; strptime(Z_STRVAL_PP(arg), "%Y-%m-%d %H:%M:%S", &amp;tm_time); arg_time = mktime(&amp;tm_time); &#125; else if(Z_TYPE_PP(arg) == IS_LONG) &#123; arg_time = Z_LVAL_PP(arg); &#125; else &#123; RETURN_NULL(); &#125; time ( &amp;now_time ); dif_time = now_time - arg_time; if(dif_time&lt;60) &#123; len = spprintf(&amp;strg, 0, "just now"); &#125; else if(dif_time&lt;120) &#123; len = spprintf(&amp;strg, 0, "one minute ago"); &#125; else if(dif_time&lt;3600) &#123; len = spprintf(&amp;strg, 0, "%d minutes ago", dif_time/60); &#125; else if(dif_time&lt;7200) &#123; len = spprintf(&amp;strg, 0, "one hour ago"); &#125; else if(dif_time&lt;86400) &#123; len = spprintf(&amp;strg, 0, "%d hours ago", dif_time/3600); &#125; else if(dif_time&lt;172800) &#123; tm_time = *localtime( &amp;arg_time ); len = spprintf(&amp;strg, 0, "one day ago %d:%d", tm_time.tm_hour, tm_time.tm_min); &#125; else if(dif_time&lt;1209600) &#123; tm_time = *localtime( &amp;arg_time ); len = spprintf(&amp;strg, 0, "%d days ago %d:%d", dif_time/86400, tm_time.tm_hour, tm_time.tm_min); &#125; else &#123; tm_time = *localtime( &amp;arg_time ); len = spprintf(&amp;strg, 0, "%d-%d-%d %d:%d", tm_time.tm_year+1900, tm_time.tm_mon+1, tm_time.tm_mday, tm_time.tm_hour, tm_time.tm_min); &#125; RETURN_STRINGL(strg, len, 0);&#125; è¿™é‡Œæ¶‰åŠäº†å‡ ä¸ªçŸ¥è¯†ç‚¹ï¼Œè®°å¥½äº†ï¼Œè€ƒè¯•ä¼šè€ƒåˆ°ï¼ˆå¼€çŽ©ç¬‘çš„ï¼‰ï¼š å˜é‡ç±»åž‹ å‡½æ•°å‚æ•° å‡½æ•°è¿”å›ž æŽ¥æ”¶å‚æ•° ZEND_NUM_ARGSè¿™ä¸ªå‡½æ•°ï¼ˆçœ‹ä»–åå­—å…¨å¤§å†™ï¼Œå°±çŸ¥é“ä¹Ÿæ˜¯ä¸ªå®å‡½æ•°ï¼‰å¯ä»¥èŽ·å–åˆ°æ‰©å±•å‡½æ•°åœ¨PHPè¿è¡ŒçŽ¯å¢ƒä¸­ä¼ å…¥çš„å‚æ•°ä¸ªæ•°ï¼› zend_parse_parameterså‡½æ•°æ˜¯ç”¨æ¥è§£æžä¼ å…¥å‚æ•°çš„ï¼Œåƒä¸Šé¢çš„ä»£ç ä¸­ï¼š 123if (zend_parse_parameters(argc TSRMLS_CC, "Z", &amp;arg) == FAILURE) &#123; RETURN_NULL();&#125; Zè¡¨ç¤ºä¼ å…¥çš„å‚æ•°ç±»åž‹æ˜¯zval**ï¼ˆå³åœ¨PHPä¸­è°ƒç”¨è¯¥å‡½æ•°æ—¶å¯ä»¥ä¼ å…¥ä»»æ„ç±»åž‹å‡½æ•°ï¼‰ï¼Œè¿™é‡Œæ˜¯æŠŠä¸€ä¸ªzval**ç±»åž‹å‚æ•°èµ‹å€¼ç»™å˜é‡argï¼Œè¯¦ç»†å†…å®¹å‚è§ã€ŠPHPæ‰©å±•å¼€å‘ä¸Žå†…æ ¸åº”ç”¨ã€‹çš„ ç¬¬ä¸ƒç«  ï¼› å¤§å®¶æœ‰æ²¡æœ‰å‘çŽ°zend_parse_parametersçš„ç¬¬ä¸€ä¸ªå‚æ•°å’Œç¬¬äºŒå‚æ•°æ˜¯ç”¨ç©ºæ ¼åˆ†éš”çš„ï¼Œå®žé™…ä¸Šä»–çš„å®å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š 1#define TSRMLS_CC ,tsrm_ls æ‰€ä»¥ï¼Œ,æ˜¯æœ‰çš„ã€‚é‚£ä¹ˆä»–çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…·ä½“å‚è§ã€Šæ­ç§˜TSRMï¼ˆIntrospecting TSRMï¼‰ã€‹ã€‚ ç±»åž‹åˆ¤æ–­Z_TYPE_PP(arg) == IS_STRINGè¦è¡¨è¾¾çš„æ„æ€å¾ˆç›´è§‚ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸‹å˜é‡argçš„å®žé™…å€¼æ˜¯ä¸æ˜¯å­—ç¬¦ä¸²ç±»åž‹ï¼ŒZ_TYPE_PPæ˜¯ç”¨æ¥èŽ·å–zval**ç±»åž‹å˜é‡çš„å®žé™…å€¼ç±»åž‹ï¼Œç±»ä¼¼çš„è¿˜æœ‰Z_TYPEï¼ˆå¯¹åº”zvalï¼‰å’ŒZ_TYPE_Pï¼ˆå¯¹åº”zval*ï¼‰ã€‚PHPå†…æ ¸ä¸­çš„å˜é‡ç±»åž‹è¯¦ç»†å†…å®¹å‚è§ã€ŠPHPæ‰©å±•å¼€å‘ä¸Žå†…æ ¸åº”ç”¨ã€‹çš„ ç¬¬äºŒç« ã€‚ è¿”å›žå€¼æ¯”å¦‚åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œä¼ å…¥å‚æ•°åˆæ³•çš„èŠ±ï¼Œè¿”å›žçš„æ˜¯RETURN_STRINGL(strg, len, 0)ã€‚ä¸Žä¹‹ç±»ä¼¼çš„è¿˜æœ‰RETURN_LONGã€RETURN_DOUBLEã€RETURN_BOOLå’ŒRETURN_NULLç­‰å¾…ï¼Œå…·ä½“å‚è§ã€ŠPHPæ‰©å±•å¼€å‘ä¸Žå†…æ ¸åº”ç”¨ã€‹çš„ ç¬¬å…­ç« ã€‚ ç¼–è¯‘è¿è¡Œä»£ç ç¼–å†™å®ŒæˆåŽï¼Œåœ¨æ‰©å±•é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œï¼š 1234$ phpize$ ./configure$ make$ make install å¦‚æžœç¼–è¯‘æˆåŠŸçš„è¯ï¼Œè¯¥æ‰©å±•æ¨¡å—å·²ç»å®‰è£…åˆ°æœ¬åœ°çš„PHPä¸­äº†ï¼Œç„¶åŽåœ¨php.iniï¼ˆä¸€èˆ¬åœ¨/etc/php/ä¸‹ï¼‰ä¸­å¼€å¯è¯¥æ‰©å±•æ¨¡å—ï¼Œå³åœ¨php.inié‡ŒåŠ ä¸Šï¼š 1extension="my_ext_name.so" ç”¨ä¸€ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹PHPå¼€å¯çš„æ‰©å±•æ¨¡å—ï¼š 1$ php -m æµ‹è¯•ä¸€ä¸‹friendly_timeå‡½æ•°èƒ½ä¸èƒ½æ­£å¸¸è¿è¡Œï¼š 1$ php -r 'echo friendly_time(time()-1000), "\n";' æœ€åŽé€šè¿‡æµ‹è¯•æ¯”è¾ƒï¼Œæ‰©å±•å½¢å¼å®žçŽ°çš„friendly_timeå‡½æ•°ï¼Œå’Œçº¯PHPè¯­è¨€å®žçŽ°çš„php_friendly_timeå‡½æ•°çš„æ‰§è¡Œæ•ˆçŽ‡å·®è·ä¸å¤§ï¼Œæ‰€ä»¥è¯´ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å‡½æ•°éƒ½åº”è¯¥ç”¨æ‰©å±•å½¢å¼å®žçŽ°ã€‚é™¤éžæ˜¯éžå¸¸å¤æ‚ã€è€—æ—¶çš„æ“ä½œéœ€è¦ä»¥æ‰©å±•å½¢å¼å®žçŽ°ï¼Œå¦åˆ™ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡åœ°ä½¿ç”¨PHPæä¾›çš„åŽŸç”Ÿå‡½æ•°æ¥å®žçŽ°æƒ³è¦çš„åŠŸèƒ½ã€‚ æºç  https://coding.net/u/breeze2/p/php-ext-dev-trip/git å‚è€ƒ é£Žé›ªä¹‹éš… PHPæ‰©å±•å¼€å‘ä¸Žå†…æ ¸åº”ç”¨]]></content>
      <categories>
        <category>èº¬è¡Œ</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å…³äºŽæŸ¥è¯¢æ•°æ®åŽ»é‡]]></title>
    <url>%2Fblog%2Fmysql-about-deduplication.html</url>
    <content type="text"><![CDATA[å¼€å§‹åœ¨MySQLä¸­ï¼ŒåŽ»é™¤é‡å¤æ•°æ®çš„æ–¹å¼æœ‰ä¸¤ç§ï¼šåˆ†åˆ«æ˜¯DISTINCTå’ŒGROUP BYï¼Œè™½ç„¶ä¸¤è€…çš„åŽ»é‡æ•ˆçŽ‡éƒ½ä¸é«˜ï¼Œä½†æ˜¯GROUP BYçš„æ‰§è¡Œæ•ˆçŽ‡è¦æ¯”DISTINCTé«˜ï¼Œæœ‰å›¾ä¸ºè¯ï¼šå›¾æ ·ï¼Œå¹¶æ²¡æœ‰å›¾ï¼Œè¿™é‡ŒåªæŠŠé“ç†è¯´æ¸…æ¥šï¼Œå›¾ä¸é‡è¦ã€‚ GROUP BYä½¿ç”¨GROUP BYåŽ»é‡ï¼Œæ˜¯ç›´æŽ¥æŠŠæ¯ä¸€è¡Œè®°å½•åˆ†åˆ°å¯¹åº”çš„ç»„é‡Œï¼Œç¬¬ä¸€æ¡å…¥ç»„çš„è®°å½•ä¼šæˆä¸ºç»„ä»£è¡¨ï¼ŒSELECTå­—æ®µå€¼å°±æ˜¯é€‰å–è¯¥æ¡è®°å½•çš„å­—æ®µå€¼ã€‚ DISTINCTè€Œä½¿ç”¨DISTINCTåŽ»é‡ï¼Œæ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„åŽ»é‡ï¼Œå¯¹äºŽæ¯ä¸€æ¡è®°å½•ï¼Œéƒ½ä¼šå…ˆæŸ¥è¯¢ä¸€ä¸‹æ˜¯å¦å·²ç»å­˜åœ¨ï¼ˆæ…¢åœ¨è¿™é‡Œï¼‰ï¼Œä¸å­˜åœ¨å°±é€‰ä¸Šï¼Œå­˜åœ¨å°±è·³è¿‡ã€‚ ç´¢å¼•å¦‚æžœå¯¹éœ€è¦åŽ»é‡çš„å…³é”®å­—æ®µåŠ ä¸Šç´¢å¼•ï¼ŒåŽ»é‡æ•ˆçŽ‡ä¼šæœ‰å¤§å¹…åº¦æå‡ï¼Œè€Œä¸”ä½¿ç”¨DISTINCTåŽ»é‡çš„æ‰§è¡Œæ•ˆçŽ‡ï¼Œå’Œä½¿ç”¨GROUP BYåŽ»é‡çš„å·®ä¸å¤šã€‚å…¶å®žç´¢å¼•å°±åƒæ˜¯GROUP BYçš„ç¼“å­˜ï¼Œå¯¹äºŽå…³é”®å­—æ®µçš„ç›¸åŒçš„è®°å½•ï¼Œå®ƒä»¬çš„ç´¢å¼•æ˜¯ä¸€æ ·çš„ï¼Œå°±åƒæ˜¯åˆ†åˆ°äº†åŒä¸€ç»„é‡Œã€‚æœ‰äº†ç´¢å¼•ï¼Œå°±å¥½åƒå·²ç»åˆ†å¥½äº†ç»„ï¼ŒåŽ»é‡çš„é€Ÿåº¦è‡ªç„¶å°±å˜å¿«äº†ï¼›è€ŒDISTINCTä¼šæŒ‰ç…§GROUP BYçš„æ–¹å¼åŽ»é‡ï¼Œå½¼æ­¤çš„æ•ˆçŽ‡è‡ªç„¶ä¹Ÿå°±å·®ä¸å¤šäº†ã€‚ å­æŸ¥è¯¢è®¨è®ºæ•°æ®åŽ»é‡é—®é¢˜æ€Žä¹ˆä¼šæ‰¯ä¸Šå­æŸ¥è¯¢å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥æŽ¢è®¨ä¸€ä¸‹é‡å¤æ•°æ®æ˜¯æ€Žä¹ˆäº§ç”Ÿçš„ã€‚ JOIN + GROUP BYä¸€èˆ¬æ¥è¯´ï¼Œå•è¡¨é‡Œé¢å¾ˆå°‘ä¼šæœ‰é‡å¤æ•°æ®ï¼Œä½†æ˜¯è¿žæŽ¥ï¼ˆJOINï¼‰ä¸Šä¸€å¯¹å¤šå…³ç³»æˆ–è€…å¤šå¯¹å¤šå…³ç³»çš„å…¶ä»–è¡¨æ—¶ï¼Œæ€»çš„è®°å½•æ•°é‡å°±æœ‰å¯èƒ½å¢žåŠ ã€‚ç„¶è€Œæˆ‘ä»¬æ›´å…³æ³¨ä¸»è¡¨çš„å†…å®¹ï¼Œæ€»æ˜¯å¸Œæœ›ä¸»è¡¨çš„è®°å½•èƒ½ä¿æŒå”¯ä¸€ï¼Œå‰¯è¡¨çš„æŸäº›å†…å®¹ç”¨GROUP_ CONCAT()ä¸²è”èµ·æ¥ä½œä¸ºä¸€ä¸ªå­—æ®µå€¼é™„åœ¨ä¸»è¡¨ä¸Šå°±å¥½äº†ï¼Œè¿™æ—¶æˆ‘ä»¬é€šå¸¸ä¼šç”¨GROUP BYï¼ˆä¸ç”¨æ•ˆçŽ‡ä½Žçš„DISTINCTï¼‰ä¸»è¡¨çš„ä¸»é”®æ¥åŽ»é‡ã€‚ä¸»è¡¨çš„ä¸»é”®å½“ç„¶æœ‰ç´¢å¼•ï¼Œä½†æ˜¯è¿™ä¸ªç´¢å¼•åªèƒ½ç”¨åœ¨ä¸»è¡¨é‡Œé¢ä½¿ç”¨ï¼ŒJOINä¸Šå…¶ä»–è¡¨åŽï¼Œç´¢å¼•å°±æ²¡ä»€ä¹ˆç”¨äº†(å½“ç„¶ï¼Œ)ï¼Œè¿™æ—¶å€™å†ç”¨GROUP BYï¼Œæ•ˆçŽ‡ä¸ä½†æ²¡æœ‰æé«˜ï¼Œè¿˜å¯èƒ½å˜å¾—æ›´ä½Žï¼ˆå› ä¸ºè®°å½•æ•°é‡å¢žåŠ äº†ï¼‰ã€‚ è§£å†³æ•°æ®é‡å¤é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘å¦‚ä½•åŽ»é™¤é‡å¤ï¼Œä½†æ›´åº”è¯¥è€ƒè™‘çš„æ˜¯ï¼šå¦‚ä½•é˜»æ­¢é‡å¤æ•°æ®çš„äº§ç”Ÿï¼ˆé—®é¢˜çš„æ ¹æºï¼‰ Subquery VS JOINæ™®éçš„ï¼Œå¤§å®¶æ€»æ˜¯æŽ¨å´‡ä½¿ç”¨JOINï¼Œè€Œé¿å…ä½¿ç”¨å­æŸ¥è¯¢ã€‚å› ä¸ºå¤§å¤šæƒ…å†µä¸‹ï¼ŒJOINå¯ä»¥æ›¿ä»£å­æŸ¥è¯¢ï¼Œå¹¶ä¸”æ•ˆçŽ‡æ›´é«˜ã€‚ åè¿‡æ¥è¯´ï¼Œå°±æ˜¯å­æŸ¥è¯¢ä¹Ÿèƒ½æ›¿ä»£JOIN æ‰€ä»¥ï¼Œå­æŸ¥è¯¢è·Ÿæ•°æ®åŽ»é‡é—®é¢˜æ‰¯ä¸Šäº†ï¼JOINï¼Œç‰¹åˆ«æ˜¯OUTER JOINå¯èƒ½ä¼šäº§ç”Ÿæ•°æ®é‡å¤ï¼Œæ­£æ˜¯é—®é¢˜çš„æ ¹æºã€‚å¦‚æžœä¸è€ƒè™‘åŽ»é‡ï¼Œé‚£ä¹ˆè‡ªç„¶é€‰æ‹©JOINï¼Œè€Œä¸ç”¨å­æŸ¥è¯¢ï¼›ä½†æ˜¯å¦‚æžœåœ¨JOINåŽåˆè¦ç”¨GROUP BYåŽ»é‡ï¼Œé‚£ä¹ˆè¿˜ä¸å¦‚é€‰æ‹©å­æŸ¥è¯¢ã€‚åˆé€‚åœ°ä½¿ç”¨å­æŸ¥è¯¢ï¼Œæ‰§è¡Œæ•ˆçŽ‡ä¼šæ¯”JOIN+GROUP BYè¦æ›´é«˜ã€‚ æœ€åŽè¯´ä¸€å¥ä¸è¦æ•´å¤©çš„JOINã€JOINã€JOINï¼›æœ‰çš„è¿˜æ•´å¤©LEFT JOINã€LEFT JOINã€LEFT JOINâ€¦â€¦]]></content>
      <categories>
        <category>æ±‚ç´¢</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Apache HTTP Serverä¸­çš„Allowã€DenyæŒ‡ä»¤]]></title>
    <url>%2Fblog%2Fapache-allow-and-deny.html</url>
    <content type="text"><![CDATA[åœ¨é…ç½®Apache HTTP Serverçš„æ—¶å€™ï¼Œç»å¸¸ä¼šç”¨åˆ°Allowã€Denyè¿™ä¸¤ä¸ªä¸ªæŒ‡ä»¤ï¼Œæ¥å®žçŽ°ç›®å½•æƒé™æŽ§åˆ¶ã€å†…å¤–ç½‘éš”ç¦»çš„åŠŸèƒ½ã€‚ç„¶è€Œè¿™ä¸¤ä¸ªæŒ‡ä»¤æ˜¯æ€Žæ ·ç›¸äº’é…åˆä½¿ç”¨çš„å‘¢ï¼Ÿ mod_authz_hostmod_authz_hostæ˜¯Apache HTTP Serverçš„ä¸€ä¸ªå®˜æ–¹æ ‡å‡†æ¨¡å—ï¼Œä¸»è¦æä¾›ä¸‰ä¸ªæŒ‡ä»¤ï¼šAllowï¼ŒDenyå’ŒOrderï¼ŒæŒ‡ä»¤ç”¨åœ¨&lt;Directory&gt;, &lt;Files&gt;, &lt;Location&gt;ä¸­ï¼Œä¹Ÿç”¨äºŽ.htaccessæ–‡ä»¶ä¸­æŽ§åˆ¶å¯¹æœåŠ¡å™¨ç‰¹å®šéƒ¨åˆ†çš„è®¿é—®ã€‚Allowå’ŒDenyæŒ‡ä»¤ç”¨äºŽæŒ‡å‡ºå…è®¸å“ªäº›ç”¨æˆ·ä¸»æœºåŠä¸å…è®¸å“ªäº›ç”¨æˆ·ä¸»æœºè®¿é—®æœåŠ¡å™¨ï¼Œè€ŒOrderæŒ‡ä»¤è®¾ç½®é»˜è®¤çš„è®¿é—®çŠ¶æ€å¹¶é…ç½®Allowå’ŒDenyæŒ‡ä»¤æ€Žæ ·ç›¸äº’ä½œç”¨ã€‚ AllowAllowï¼ŒæŽ§åˆ¶å“ªäº›ä¸»æœºèƒ½å¤Ÿè®¿é—®æœåŠ¡å™¨çš„æŸäº›åŒºåŸŸã€‚ç”¨æ³•ï¼š 1Allow from 10.1.2.3 DenyDenyï¼ŒæŽ§åˆ¶å“ªäº›ä¸»æœºè¢«ç¦æ­¢è®¿é—®æœåŠ¡å™¨çš„æŸäº›åŒºåŸŸã€‚ç”¨æ³•ï¼š 1Deny from 10.1.2.3 OrderOrderï¼ŒæŽ§åˆ¶é»˜è®¤çš„è®¿é—®çŠ¶æ€ä¸ŽAllowå’ŒDenyæŒ‡ä»¤ç”Ÿæ•ˆçš„é¡ºåºåœ¨æ²¡æœ‰OrderæŒ‡ä»¤çš„æƒ…å†µä¸‹ï¼ŒAllowçš„ä¼˜å…ˆçº§ä¼šæ¯”Denyé«˜ï¼Œå¦‚ä¸‹é…ç½®å®žé™…ä¸Šæ²¡æœ‰é™åˆ¶IP10.1.2.3ä¸»æœºçš„è®¿é—®æƒé™ï¼š 123Deny from 10.1.2.3Allow from 10.1.2.3Deny from 10.1.2.3 Orderçš„æœ‰ä¸‰ç§å–å€¼ï¼š Deny,Allow DenyæŒ‡ä»¤åœ¨AllowæŒ‡ä»¤ä¹‹å‰è¢«è¯„ä¼°ã€‚é»˜è®¤å…è®¸æ‰€æœ‰è®¿é—®ã€‚ä»»ä½•ä¸åŒ¹é…DenyæŒ‡ä»¤æˆ–è€…åŒ¹é…AllowæŒ‡ä»¤çš„å®¢æˆ·éƒ½è¢«å…è®¸è®¿é—®ã€‚ Allow,Deny AllowæŒ‡ä»¤åœ¨DenyæŒ‡ä»¤ä¹‹å‰è¢«è¯„ä¼°ã€‚é»˜è®¤æ‹’ç»æ‰€æœ‰è®¿é—®ã€‚ä»»ä½•ä¸åŒ¹é…AllowæŒ‡ä»¤æˆ–è€…åŒ¹é…DenyæŒ‡ä»¤çš„å®¢æˆ·éƒ½å°†è¢«ç¦æ­¢è®¿é—®ã€‚ Mutual-failure åªæœ‰å‡ºçŽ°åœ¨Allowåˆ—è¡¨å¹¶ä¸”ä¸å‡ºçŽ°åœ¨Denyåˆ—è¡¨ä¸­çš„ä¸»æœºæ‰è¢«å…è®¸è®¿é—®ã€‚è¿™ç§é¡ºåºä¸Žâ€Order Allow,Denyâ€å…·æœ‰åŒæ ·æ•ˆæžœï¼Œä¸èµžæˆä½¿ç”¨ã€‚ å…³é”®å­—åªèƒ½ç”¨é€—å·åˆ†éš”,å®ƒä»¬ä¹‹é—´ä¸èƒ½æœ‰ç©ºæ ¼ã€‚æ³¨æ„åœ¨æ‰€æœ‰æƒ…å†µä¸‹æ¯ä¸ªAllowå’ŒDenyæŒ‡ä»¤è¯­å¥éƒ½å°†è¢«è¯„ä¼°ã€‚]]></content>
      <categories>
        <category>çŸ¥é“</category>
      </categories>
      <tags>
        <tag>apache</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å†™åœ¨ä¹‹å‰]]></title>
    <url>%2Fblog%2Ffeature.html</url>
    <content type="text"><![CDATA[å†™åœ¨ä¹‹å‰æ¯å½“æˆ‘æœ‰æƒ³ä¸æ˜Žç™½çš„äº‹æƒ…ï¼Œæˆ‘ä¼šè¯•ç€æŠŠå®ƒå†™ä¸‹æ¥ã€‚å¦‚æžœæˆ‘èƒ½å†™çš„æ¸…æ¥šï¼Œé‚£ä¹ˆæˆ‘å°±èƒ½çŸ¥é“å®ƒçš„é“ç†ã€‚ ä¸èƒ½è¯´çš„ï¼Œåº”è¯¥ä¿æŒæ²‰é»˜ï¼› èƒ½å¤Ÿè¯´çš„ï¼Œä¸€å®šèƒ½è¯´æ¸…æ¥šã€‚ Write it down and make it out.]]></content>
      <categories>
        <category>å°é¢</category>
      </categories>
      <tags>
        <tag>dream</tag>
      </tags>
  </entry>
</search>
