<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Lin Blog</title>
  
  <subtitle>æ—æŸæ ¼</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://breeze2.github.io/blog/"/>
  <updated>2019-09-30T02:17:26.551Z</updated>
  <id>https://breeze2.github.io/blog/</id>
  
  <author>
    <name>æ—æ¯…é”‹</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æºç ç¼–è¯‘Portable Pyton</title>
    <link href="https://breeze2.github.io/blog/practice-compile-portable-python.html"/>
    <id>https://breeze2.github.io/blog/practice-compile-portable-python.html</id>
    <published>2019-09-28T10:15:06.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Portableçš„æ„æ€æ˜¯å¯æ‹”æ’çš„ï¼Œä¾¿æºå¼çš„ã€‚Portable ç¨‹åºåœ¨ä¸€å°è®¡ç®—æœºä¸Šç¼–è¯‘å¥½åï¼Œç§»æ¤åˆ°å…¶ä»–è®¡ç®—æœºä¸Šå°±å¯ä»¥ç›´æ¥è¿è¡Œã€‚ä¸€èˆ¬ç¨‹åºè¿è¡Œæ—¶éƒ½ä¼šä¾èµ–ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œåªè¦æŠŠå¯¹è¿™äº›åº“çš„ä¾èµ–æ–¹å¼ç”±é™æ€ä¾èµ–æ”¹æˆåŠ¨æ€ä¾èµ–ï¼Œå†æŠŠè¿™äº›åº“å’Œä¸»ä½“ç¨‹åºæ”¾åˆ°ä¸€èµ·æ‰“åŒ…ï¼Œå°±æˆä¸ºä¸€ä¸ªPortable ç¨‹åºã€‚<br>å½“ç„¶Portable ä¹Ÿæ˜¯æœ‰é™åº¦çš„ï¼Œä¸èƒ½è·¨æ“ä½œç³»ç»Ÿç§»æ¤ï¼Œæ¯•ç«Ÿç¨‹åºå¯¹æ“ä½œç³»ç»Ÿçš„ä¾èµ–ä¸èƒ½æ”¾åˆ°ä¸€èµ·æ‰“åŒ…ğŸ˜‚ã€‚</p></blockquote><p>ä»¥<a href="https://www.python.org/downloads/release/python-365/" target="_blank" rel="noopener">Python-3.6.5</a> ä¸ºä¾‹ï¼Œè®²è¿°ä¸€ä¸‹æºç ç¼–è¯‘ä¸€ä¸ªPortable Pyton çš„ä¸»è¦æµç¨‹ã€‚</p><a id="more"></a><h2 id="Windows-å¹³å°"><a href="#Windows-å¹³å°" class="headerlink" title="Windows å¹³å°"></a>Windows å¹³å°</h2><p><a href="https://winpython.github.io/" target="_blank" rel="noopener">winpython</a> æ˜¯ä¸€ä¸ªä¸“é—¨ç¼–è¯‘Windows å¹³å°ä¸‹Portable Pyton çš„é¡¹ç›®ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½<a href="https://github.com/winpython/winpython/releases/download/1.10.20180404/WinPython32-3.6.5.0Zero.exe" target="_blank" rel="noopener">WinPython32-3.6.5.0Zero.exe</a>æˆ–è€…<a href="https://github.com/winpython/winpython/releases/download/1.10.20180404/WinPython64-3.6.5.0Zero.exe" target="_blank" rel="noopener">WinPython64-3.6.5.0Zero.exe</a>ï¼Œè§£å‹å‡ºæ¥å°±æ˜¯å¯¹åº”çš„32ä½Portable Pyton æˆ–64ä½Portable Pyton.</p><h2 id="macOS-å¹³å°"><a href="#macOS-å¹³å°" class="headerlink" title="macOS å¹³å°"></a>macOS å¹³å°</h2><p>æœ€å¥½åœ¨<code>OS X10.9</code>ç³»ç»Ÿä¸‹ç¼–è¯‘Portable Pytonï¼Œå¯¹å…¶ä»–æ›´é«˜çº§çš„macOS å…¼å®¹æ€§ä¼šå¥½ä¸€äº›ã€‚<br>python çš„ä¸€äº›å†…ç½®æ¨¡å—ä¼šä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼Œä¸»è¦æ˜¯ï¼š</p><ul><li><a href="https://tukaani.org/xz/" target="_blank" rel="noopener">lzma</a></li><li><a href="https://www.openssl.org/" target="_blank" rel="noopener">openssl</a></li><li><a href="https://www.tcl.tk/" target="_blank" rel="noopener">tcl/tk</a></li></ul><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å…ˆå®‰è£…è¿™äº›åº“ã€‚</p><h3 id="ç¼–è¯‘lzma"><a href="#ç¼–è¯‘lzma" class="headerlink" title="ç¼–è¯‘lzma"></a>ç¼–è¯‘lzma</h3><p>ä¸‹è½½<a href="https://tukaani.org/xz/xz-5.2.3.tar.gz" target="_blank" rel="noopener">xz-5.2.3.tar.gz</a>ï¼Œè§£å‹åˆ°<code>/tmp/xz-5.2.3</code>ï¼Œç„¶åï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp</span><br><span class="line">$ <span class="built_in">mkdir</span> local</span><br><span class="line">$ <span class="built_in">cd</span> xz-<span class="number">5</span>.<span class="number">2</span>.<span class="number">3</span></span><br><span class="line">$ ./configure --prefix=/tmp/local</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘openssl"><a href="#ç¼–è¯‘openssl" class="headerlink" title="ç¼–è¯‘openssl"></a>ç¼–è¯‘openssl</h3><p>ä¸‹è½½<a href="https://github.com/openssl/openssl/archive/OpenSSL_1_0_2t.zip" target="_blank" rel="noopener">openssl-OpenSSL_1_0_2t.zip</a>ï¼Œè§£å‹åˆ°<code>/tmp/openssl-OpenSSL_1_0_2t</code>ï¼Œç„¶åï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp/openssl-OpenSSL_1_0_2t</span><br><span class="line">$ ./Configure darwin64-x86_64-cc --prefix=/tmp/local -shared</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘tcl-tk"><a href="#ç¼–è¯‘tcl-tk" class="headerlink" title="ç¼–è¯‘tcl/tk"></a>ç¼–è¯‘tcl/tk</h3><p>ä¸‹è½½<a href="https://sourceforge.net/projects/tcl/files/Tcl/8.5.19/tcl8519-src.zip/download" target="_blank" rel="noopener">tcl8519-src.zip</a>ï¼Œè§£å‹åˆ°<code>/tmp/tk8519-src</code>ï¼›ä¸‹è½½<a href="https://sourceforge.net/projects/tcl/files/Tcl/8.5.19/tk8519-src.zip/download" target="_blank" rel="noopener">tk8519-src.zip</a>ï¼Œè§£å‹åˆ°<code>/tmp/tk8519-src</code>ï¼Œç„¶åï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp/tcl8519-src</span><br><span class="line">$ <span class="built_in">cd</span> unix/</span><br><span class="line">$ ./configure --prefix=/tmp/local</span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">$ <span class="built_in">cd</span> /tmp/tk8519-src</span><br><span class="line">$ <span class="built_in">cd</span> unix/</span><br><span class="line">$ ./configure --prefix=/tmp/local --with-tcl=/tmp/tcl8519-src/unix --enable-aqua</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘python"><a href="#ç¼–è¯‘python" class="headerlink" title="ç¼–è¯‘python"></a>ç¼–è¯‘python</h3><p>ä¸‹è½½<a href="https://www.python.org/ftp/python/3.6.5/Python-3.6.5.tgz" target="_blank" rel="noopener">Python-3.6.5</a>ï¼Œè§£å‹åˆ°<code>/tmp/Python-3.6.5</code>ï¼Œ ç„¶åï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp</span><br><span class="line">$ <span class="built_in">mkdir</span> python</span><br><span class="line">$ <span class="built_in">cd</span> Python-<span class="number">3</span>.<span class="number">6</span>.<span class="number">5</span></span><br><span class="line">$ CPPFLAGS="-I/tmp/local/include" \</span><br><span class="line">LDFLAGS="-L/tmp/local/lib" \</span><br><span class="line">./configure --prefix=/tmp/python </span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹ä¾èµ–è·¯å¾„"><a href="#ä¿®æ”¹ä¾èµ–è·¯å¾„" class="headerlink" title="ä¿®æ”¹ä¾èµ–è·¯å¾„"></a>ä¿®æ”¹ä¾èµ–è·¯å¾„</h3><p>ä»¥ä¸Špython å®‰è£…åœ¨<code>/tmp/python</code>ï¼ŒæŠŠpython ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŠ¨æ€åº“ï¼Œå¤åˆ¶åˆ°<code>/tmp/python/lib</code>ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp/python/lib</span><br><span class="line">$ cp /tmp/local/lib/liblzma.<span class="number">5</span>.dylib ./</span><br><span class="line">$ cp /tmp/local/lib/libcrypto.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib ./</span><br><span class="line">$ cp /tmp/local/lib/libssl.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib ./</span><br><span class="line">$ cp /tmp/local/lib/libtcl8.<span class="number">5</span>.dylib ./</span><br><span class="line">$ cp /tmp/local/lib/libtk8.<span class="number">5</span>.dylib ./</span><br><span class="line">$ cp -R /tmp/local/lib/tcl8 ./</span><br><span class="line">$ cp -R /tmp/local/lib/tcl8.<span class="number">5</span> ./</span><br><span class="line">$ cp -R /tmp/local/lib/tk8.<span class="number">5</span> ./</span><br></pre></td></tr></table></figure><p>macOSä¸‹ï¼Œ<code>otool</code>å·¥å…·å¯ä»¥æŸ¥çœ‹åŠ¨æ€åº“çš„ä¾èµ–è·¯å¾„ï¼Œ<code>intall_name_tool</code>å·¥å…·å¯ä»¥ä¿®æ”¹åŠ¨æ€åº“çš„ä¾èµ–è·¯å¾„ã€‚<br>æˆ‘ä»¬è¦æŠŠæ‰€æœ‰çš„å¤–éƒ¨ä¾èµ–ï¼ˆé™¤äº†ç³»ç»Ÿä¾èµ–ï¼‰éƒ½ä¿®æ”¹ä¸º<code>/tmp/python/lib</code>å†…éƒ¨ä¾èµ–ï¼Œç»å¯¹çš„ä¾èµ–è·¯å¾„ä¹Ÿæ”¹ä¸ºç›¸å¯¹çš„ä¾èµ–è·¯å¾„ï¼š</p><h4 id="ä¿®æ”¹libssl-1-0-0-dylibï¼š"><a href="#ä¿®æ”¹libssl-1-0-0-dylibï¼š" class="headerlink" title="ä¿®æ”¹libssl.1.0.0.dylibï¼š"></a>ä¿®æ”¹<code>libssl.1.0.0.dylib</code>ï¼š</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp/python/lib</span><br><span class="line">$ otool -L libssl.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib</span><br><span class="line">$ sudo install_name_tool -change /tmp/local/lib/libcrypto.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib @executable_path/../lib/libcrypto.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib libssl.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹-lzma-cpython-36m-darwin-soï¼š"><a href="#ä¿®æ”¹-lzma-cpython-36m-darwin-soï¼š" class="headerlink" title="ä¿®æ”¹_lzma.cpython-36m-darwin.soï¼š"></a>ä¿®æ”¹<code>_lzma.cpython-36m-darwin.so</code>ï¼š</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp/python/lib/python3.<span class="number">6</span>/lib-dynload</span><br><span class="line">$ otool -L _lzma.cpython-<span class="number">36</span>m-darwin.so</span><br><span class="line">$ install_name_tool -change /tmp/local/lib/liblzma.<span class="number">5</span>.dylib @executable_path/../lib/liblzma.<span class="number">5</span>.dylib _lzma.cpython-<span class="number">36</span>m-darwin.so</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹-ssl-cpython-36m-darwin-soï¼š"><a href="#ä¿®æ”¹-ssl-cpython-36m-darwin-soï¼š" class="headerlink" title="ä¿®æ”¹_ssl.cpython-36m-darwin.soï¼š"></a>ä¿®æ”¹<code>_ssl.cpython-36m-darwin.so</code>ï¼š</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp/python/lib/python3.<span class="number">6</span>/lib-dynload</span><br><span class="line">$ otool -L libssl.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib</span><br><span class="line">$ install_name_tool -change /tmp/local/lib/libssl.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib @executable_path/../lib/libssl.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib -change /tmp/local/lib/libcrypto.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib @executable_path/../lib/libcrypto.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib _ssl.cpython-<span class="number">36</span>m-darwin.so</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹-tkinter-cpython-36m-darwin-soï¼š"><a href="#ä¿®æ”¹-tkinter-cpython-36m-darwin-soï¼š" class="headerlink" title="ä¿®æ”¹_tkinter.cpython-36m-darwin.soï¼š"></a>ä¿®æ”¹<code>_tkinter.cpython-36m-darwin.so</code>ï¼š</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp/python/lib/python3.<span class="number">6</span>/lib-dynload</span><br><span class="line">$ otool -L libssl.<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>.dylib</span><br><span class="line">$ install_name_tool -change /System/Library/Frameworks/Tcl.framework/Versions/<span class="number">8</span>.<span class="number">5</span>/Tcl @executable_path/../lib/libtcl8.<span class="number">5</span>.dylib -change /System/Library/Frameworks/Tk.framework/Versions/<span class="number">8</span>.<span class="number">5</span>/Tk @executable_path/../lib/libtk8.<span class="number">5</span>.dylib _tkinter.cpython-<span class="number">36</span>m-darwin.so</span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>æµ‹è¯•ä¿®æ”¹ä¾èµ–è·¯å¾„åçš„pythonè¿è¡Œæƒ…å†µï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp/python</span><br><span class="line">$ ./bin/python -m pip lmza</span><br><span class="line">$ ./bin/python -m pip ssl</span><br><span class="line">$ ./bin/python -m pip tkinter</span><br></pre></td></tr></table></figure><h3 id="å‡çº§pip"><a href="#å‡çº§pip" class="headerlink" title="å‡çº§pip"></a>å‡çº§pip</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp/python</span><br><span class="line">$ ./bin/python -m pip install --upgrade pip</span><br></pre></td></tr></table></figure><h3 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h3><p>æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªPortable Pyton <code>/tmp/python</code>ï¼Œå¯ä»¥å†…åµŒåˆ°å…¶ä»–ç¨‹åºä¸­ä¸€èµ·æ‰“åŒ…ï¼Œåˆ†å‘åˆ°å„ä¸ªè®¡ç®—æœºè¿è¡Œã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://www.tcl.tk/doc/howto/compile.html" target="_blank" rel="noopener">How to Compile Tcl</a></li><li><a href="https://devguide.python.org/setup/" target="_blank" rel="noopener">Getting Started â€” Python Developerâ€™s Guide </a></li><li><a href="https://tkdocs.com/tutorial/install.html" target="_blank" rel="noopener">TkDocs - Tk Tutorial - Installing Tk</a></li><li><a href="https://bitbucket.org/snippets/Zifix/88ny/" target="_blank" rel="noopener">Portable OpenSSL dylib on Mac OS X</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Portableçš„æ„æ€æ˜¯å¯æ‹”æ’çš„ï¼Œä¾¿æºå¼çš„ã€‚Portable ç¨‹åºåœ¨ä¸€å°è®¡ç®—æœºä¸Šç¼–è¯‘å¥½åï¼Œç§»æ¤åˆ°å…¶ä»–è®¡ç®—æœºä¸Šå°±å¯ä»¥ç›´æ¥è¿è¡Œã€‚ä¸€èˆ¬ç¨‹åºè¿è¡Œæ—¶éƒ½ä¼šä¾èµ–ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œåªè¦æŠŠå¯¹è¿™äº›åº“çš„ä¾èµ–æ–¹å¼ç”±é™æ€ä¾èµ–æ”¹æˆåŠ¨æ€ä¾èµ–ï¼Œå†æŠŠè¿™äº›åº“å’Œä¸»ä½“ç¨‹åºæ”¾åˆ°ä¸€èµ·æ‰“åŒ…ï¼Œå°±æˆä¸ºä¸€ä¸ªPortable ç¨‹åºã€‚&lt;br&gt;å½“ç„¶Portable ä¹Ÿæ˜¯æœ‰é™åº¦çš„ï¼Œä¸èƒ½è·¨æ“ä½œç³»ç»Ÿç§»æ¤ï¼Œæ¯•ç«Ÿç¨‹åºå¯¹æ“ä½œç³»ç»Ÿçš„ä¾èµ–ä¸èƒ½æ”¾åˆ°ä¸€èµ·æ‰“åŒ…ğŸ˜‚ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä»¥&lt;a href=&quot;https://www.python.org/downloads/release/python-365/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Python-3.6.5&lt;/a&gt; ä¸ºä¾‹ï¼Œè®²è¿°ä¸€ä¸‹æºç ç¼–è¯‘ä¸€ä¸ªPortable Pyton çš„ä¸»è¦æµç¨‹ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
      <category term="python" scheme="https://breeze2.github.io/blog/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>å¼€å‘ä¸€ä¸ªReact + Electronåº”ç”¨</title>
    <link href="https://breeze2.github.io/blog/practice-develop-an-electron-app-with-react.html"/>
    <id>https://breeze2.github.io/blog/practice-develop-an-electron-app-with-react.html</id>
    <published>2019-02-16T10:50:06.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ç”¨React + Electronå¼€å‘äº†ä¸€ä¸ªRSSé˜…è¯»å™¨ï¼Œå¼€æºåœ¨ï¼š<a href="https://github.com/breeze2/breader" target="_blank" rel="noopener">https://github.com/breeze2/breader</a>ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹å¤§è‡´çš„å¼€å‘è¿‡ç¨‹ã€‚</p><p><img src="https://breeze2.github.io/breader/screenshot.jpg" alt="Breader"></p><a id="more"></a><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><h3 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h3><p>ä»¥æ™®é€šçš„Reactåº”ç”¨åšåŸºç¡€ï¼Œä¸€æ­¥æ­¥åˆå§‹åŒ–é¡¹ç›®ã€‚é¢„å…ˆå®‰è£…<a href="https://yarnpkg.com/" target="_blank" rel="noopener">yarn</a>å·¥å…·ï¼Œç”¨<code>yarn</code>æ¥åˆ›å»ºä¸€ä¸ªReactåº”ç”¨é¡¹ç›®ï¼Œå‡è®¾åå­—å«<code>demo</code>ï¼Œå†å¼•å…¥Electronä¾èµ–ã€‚</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /<span class="built_in">PATH</span>/TO/PROJECTS</span><br><span class="line">$ yarn create react-app YOUR_APP_NAME</span><br><span class="line">$ <span class="built_in">cd</span> /<span class="built_in">PATH</span>/TO/PROJECTS/YOUR_APP_NAME</span><br><span class="line">$ yarn add electron --dev</span><br></pre></td></tr></table></figure><h3 id="é…ç½®å…¥å£æ–‡ä»¶"><a href="#é…ç½®å…¥å£æ–‡ä»¶" class="headerlink" title="é…ç½®å…¥å£æ–‡ä»¶"></a>é…ç½®å…¥å£æ–‡ä»¶</h3><p>åˆ›å»ºé¡¹ç›®åï¼Œå¤§è‡´çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">|--&gt;demo</span><br><span class="line">    |--&gt;node_modules</span><br><span class="line">        |--...</span><br><span class="line">    |--&gt;public</span><br><span class="line">        |--index.html</span><br><span class="line">        |--...</span><br><span class="line">    |--&gt;src</span><br><span class="line">    |--package.json</span><br><span class="line">    |--...</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æ¥è¯´ï¼ŒReactåº”ç”¨ï¼ˆæµ‹è¯•ç¯å¢ƒä¸‹ï¼‰çš„å…¥å£æ–‡ä»¶å°±æ˜¯<code>public/index.html</code>ï¼Œè€ŒElectronåº”ç”¨çš„å…¥å£æ–‡ä»¶æœ€å¥½ä¹Ÿæ”¾åœ¨<code>public</code>ç›®å½•ä¸‹ï¼Œå¹¶å‘½åä¸º<code>electron.js</code>ï¼ˆè¿™æ ·<a href="https://github.com/electron-userland/electron-builder" target="_blank" rel="noopener">electron-builder</a>å¯ä»¥è‡ªåŠ¨è¯†åˆ«ï¼‰ã€‚</p><p>å…ˆåœ¨<code>package.json</code>ä¸­lectronåº”ç”¨çš„å…¥å£æ–‡ä»¶ï¼Œæ·»åŠ <code>main</code>é…ç½®ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  "main": "public/electron.js",</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>public/electron.js</code>ä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; app, BrowserWindow &#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mainWindow</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWindow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    mainWindow = <span class="keyword">new</span> BrowserWindow(&#123;</span><br><span class="line">        width: <span class="number">960</span>,</span><br><span class="line">        height: <span class="number">600</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    mainWindow.loadFile(<span class="string">'index.html'</span>)</span><br><span class="line">    mainWindow.webContents.openDevTools()</span><br><span class="line">    mainWindow.on(<span class="string">'closed'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        mainWindow = <span class="literal">null</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'ready'</span>, createWindow)</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'window-all-closed'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (process.platform !== <span class="string">'darwin'</span>) &#123;</span><br><span class="line">        app.quit()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'activate'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mainWindow === <span class="literal">null</span>) &#123;</span><br><span class="line">        createWindow()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œæ‰§è¡Œ<code>yarn electron ./</code>å‘½ä»¤å°±å¯ä»¥å¯åŠ¨Electronåº”ç”¨äº†ï¼Œä¸è¿‡Reactåº”ç”¨è¿˜æ²¡å¯åŠ¨èµ·æ¥ã€‚</p><h3 id="å¯åŠ¨åº”ç”¨"><a href="#å¯åŠ¨åº”ç”¨" class="headerlink" title="å¯åŠ¨åº”ç”¨"></a>å¯åŠ¨åº”ç”¨</h3><p>ä¸€èˆ¬ç”¨<code>yarn react-scripts start</code>å‘½ä»¤ï¼Œå°±å¯ä»¥å°†Reactåº”ç”¨æŒ‚è½½åœ¨æœ¬åœ°3000ç«¯å£ä¸Šï¼ˆ <a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a> ï¼‰ï¼Œç”¨äºå¼€å‘è°ƒè¯•ã€‚è¦ç”¨Reactç»“åˆElectronä¸€èµ·å¼€å‘è°ƒè¯•ï¼Œå…ˆå®‰è£…<a href="https://github.com/sindresorhus/electron-is-dev" target="_blank" rel="noopener">electron-is-dev</a>æ¥è¯†åˆ«å½“å‰æ˜¯å¦å¼€å‘ç¯å¢ƒã€‚</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add electron-is-dev</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬å¼€å‘ç¯å¢ƒæ˜¯åŠ è½½<code>http://localhost:3000/</code>ï¼Œæ­£å¼ç¯å¢ƒæ˜¯åŠ è½½<code>../build/index.html</code>æ–‡ä»¶ï¼Œæ‰€ä»¥ä¿®æ”¹<code>public/electron.js</code>ä»£ç ï¼ˆ<code>createWindow</code>å‡½æ•°å†…ï¼‰ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isDev = <span class="built_in">require</span>(<span class="string">'electron-is-dev'</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">--    <span class="comment">// mainWindow.loadFile('index.html')</span></span><br><span class="line">++    <span class="keyword">if</span> (isDev) &#123;</span><br><span class="line">++        mainWindow.loadURL(<span class="string">'http://localhost:3000/'</span>)</span><br><span class="line">++    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">++        mainWindow.loadFile(path.join(__dirname, <span class="string">'/../build/index.html'</span>))</span><br><span class="line">++    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œåœ¨é¡¹ç›®ç›®å½•ä¸‹ï¼Œæ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œä¸€ä¸ªæ‰§è¡Œ<code>yarn react-scripts start</code>ï¼Œä¸€ä¸ªæ‰§è¡Œ<code>yarn electron ./</code>ï¼Œå°±å¯ä»¥å¼€å‘è°ƒè¯•React + Electronåº”ç”¨äº†ã€‚<br>ä¸ç”¨ç¾¡æ…•<a href="https://github.com/SimulatedGREG/electron-vue" target="_blank" rel="noopener">electron-vue</a>ï¼Œå¯ä»¥ä¸€å¥å‘½ä»¤å¯ä»¥ç›´æ¥å¯åŠ¨ï¼Œå…¶å®åŸç†æ˜¯ä¸€æ ·çš„ã€‚<br>è¦å®ç°ä¸€å¥å‘½ä»¤å¯åŠ¨ä¹Ÿä¸éš¾ï¼Œåªè¦æŠŠä¸¤å¥å‘½ä»¤åˆåˆ°ä¸€èµ·æ‰§è¡Œå°±å¯ä»¥äº†ã€‚å…ˆå®‰è£…å·¥å…·åº“ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add concurrently --dev</span><br><span class="line">$ yarn add wait-on --dev</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>package.json</code>ï¼Œæ·»åŠ ä¸€ä¸ª<code>electron-dev</code>è„šæœ¬å‘½ä»¤ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    ...</span><br><span class="line">    "electron-dev": "concurrently \"BROWSER=none react-scripts start\" \"wait-on http://localhost:3000 &amp;&amp; electron .\"",</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæ‰§è¡Œä¸€å¥<code>yarn electron-dev</code>å°±å¯ä»¥å¯åŠ¨React + Electronåº”ç”¨äº†ã€‚</p><h2 id="JSè¿è¡Œæ—¶"><a href="#JSè¿è¡Œæ—¶" class="headerlink" title="JSè¿è¡Œæ—¶"></a>JSè¿è¡Œæ—¶</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œæµè§ˆå™¨æä¾›ä¸€ç§JSè¿è¡Œæ—¶ï¼ŒNodeJSæä¾›å¦ä¸€ç§JSè¿è¡Œæ—¶ï¼ŒElectronåˆ™æ˜¯å°†è¿™ä¸¤ç§è¿è¡Œæ—¶ç»“åˆåˆ°ä¸€èµ·æ¥æä¾›ã€‚ä¸è¿‡ï¼Œè¿™ä¸¤ç§è¿è¡Œæ—¶å¹¶ä¸æ˜¯å®Œç¾åœ°å’Œç¦ç›¸å¤„ï¼Œæ¯”å¦‚è¯´ä½¿ç”¨<a href="https://webpack.js.org/" target="_blank" rel="noopener">webpack</a>æ—¶ï¼Œé€šè¿‡webpackæ‰“åŒ…çš„JSä»£ç ä¸­ï¼Œä¸èƒ½ç›´æ¥é€šè¿‡<code>import</code>å…³é”®å­—æˆ–è€…<code>require</code>å‡½æ•°æ¥å¼•å…¥NodeJSæä¾›çš„åŠŸèƒ½æ¥å£ï¼Œå› ä¸ºwebpackè¦†ç›–äº†NodeJSè‡ªå¸¦çš„<code>require</code>å‡½æ•°ã€‚<br>ä¸è¿‡Electronä¸­ï¼Œ<code>window</code>å¯¹è±¡çš„<code>require</code>å±æ€§ä¼šæ˜ å°„åˆ°NodeJSè‡ªå¸¦çš„<code>require</code>å‡½æ•°ä¸Šï¼Œæ¯”å¦‚è¦è°ƒç”¨NodeJSæä¾›çš„<a href="https://nodejs.org/dist/latest-v10.x/docs/api/http.html" target="_blank" rel="noopener">http</a>æ¥å£ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">window</span>.require(<span class="string">'http'</span>)</span><br></pre></td></tr></table></figure><h2 id="é‡æ–°ç¼–è¯‘NodeJSæ‰©å±•"><a href="#é‡æ–°ç¼–è¯‘NodeJSæ‰©å±•" class="headerlink" title="é‡æ–°ç¼–è¯‘NodeJSæ‰©å±•"></a>é‡æ–°ç¼–è¯‘NodeJSæ‰©å±•</h2><p>é€šå¸¸ï¼Œçº¯JSä»£ç å®ç°çš„å·¥å…·åº“éƒ½å¯ä»¥åœ¨Electronç¯å¢ƒä¸­è¿è¡Œã€‚ä¸è¿‡æœ‰äº›NodeJSçš„å·¥å…·åº“å¹¶ä¸æ˜¯çº¯JSä»£ç å®ç°çš„ï¼Œæ¯”å¦‚<a href="https://github.com/mapbox/node-sqlite3" target="_blank" rel="noopener">node-sqlite3</a>ã€‚<code>node-sqlite3</code>æ˜¯C++ç¼–å†™ï¼Œç®—æ˜¯NodeJSçš„æ‰©å±•ï¼Œè€Œä¸æ˜¯å•çº¯çš„å·¥å…·åº“ã€‚<code>node-sqlite3</code>éœ€è¦é’ˆå¯¹Electronç¯å¢ƒé‡æ–°ç¼–è¯‘ï¼Œæ‰èƒ½åœ¨Electronç¯å¢ƒä¸­è¿è¡Œã€‚</p><h3 id="electron-rebuild"><a href="#electron-rebuild" class="headerlink" title="electron-rebuild"></a>electron-rebuild</h3><p><a href="https://github.com/electron/electron-rebuild" target="_blank" rel="noopener">electron-rebuild</a>æ˜¯ä¸“é—¨Electronç¯å¢ƒé’ˆå¯¹é‡æ–°ç¼–è¯‘NodeJSæ‰©å±•çš„ä¸€ä¸ªå·¥å…·ã€‚<br>åœ¨é¡¹ç›®ç›®å½•ä¸‹ï¼Œå®‰è£…electron-rebuildï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add electron-rebuild --dev</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼Œé‡æ–°ç¼–è¯‘node-sqlite3ï¼Œåªéœ€è¦ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yarn electron-rebuild -f -w sqlite3</span><br></pre></td></tr></table></figure><p>åœ¨MacOSç³»ç»Ÿä¸Šå°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œåœ¨Windowsç³»ç»Ÿå°±å¤æ‚ä¸€äº›ã€‚</p><h3 id="Windowsç³»ç»Ÿä¸Šé‡æ–°ç¼–è¯‘NodeJSæ‰©å±•"><a href="#Windowsç³»ç»Ÿä¸Šé‡æ–°ç¼–è¯‘NodeJSæ‰©å±•" class="headerlink" title="Windowsç³»ç»Ÿä¸Šé‡æ–°ç¼–è¯‘NodeJSæ‰©å±•"></a>Windowsç³»ç»Ÿä¸Šé‡æ–°ç¼–è¯‘NodeJSæ‰©å±•</h3><p>åœ¨Windowsç³»ç»Ÿä¸Šä¹Ÿä¸€æ ·å¯ä»¥ä½¿ç”¨electron-rebuildå·¥å…·ï¼Œä½†å¿…é¡»é¢„å…ˆé…ç½®å¥½ç¼–è¯‘ç¯å¢ƒã€‚</p><p>é¦–å…ˆï¼Œå®‰è£…windowç¼–è¯‘å·¥å…·ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --global --production windows-build-tools</span><br><span class="line">$ npm config <span class="built_in">set</span> msvs_version <span class="number">2017</span></span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œä¸‹è½½å¹¶å®‰è£…<a href="https://www.python.org/downloads/release/python-2715/" target="_blank" rel="noopener">Python2</a>ï¼Œå¿…é¡»Python2ä¸èƒ½Python3ï¼Œå¦‚æœåŒæ—¶å®‰è£…äº†Python2å’ŒPython3ï¼Œé¡»ç»™<code>npm</code>æŒ‡å®šPython2å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œé¿å…è°ƒç”¨äº†Python3ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm config <span class="built_in">set</span> python /<span class="built_in">path</span>/to/executable/python2</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæ‰èƒ½åœ¨Windowsç³»ç»Ÿä¸Šè°ƒç”¨electron-rebuildã€‚å¦‚æœelectron-rebuildæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œé‡ä¸Š<code>CONNECT ERROR</code>å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥æ¢æˆæ·˜å®æºå†è¯•è¯•ã€‚</p><p>æ‰€ä»¥å°½é‡å°‘ç”¨NodeJSæ‰©å±•ï¼Œå¯ä»¥å…å»è·¨å¹³å°æ—¶é‡æ–°ç¼–è¯‘çš„éº»çƒ¦ã€‚</p><h2 id="åº”ç”¨æ‰“åŒ…"><a href="#åº”ç”¨æ‰“åŒ…" class="headerlink" title="åº”ç”¨æ‰“åŒ…"></a>åº”ç”¨æ‰“åŒ…</h2><p>åº”ç”¨å¼€å‘å®Œæˆåï¼Œéœ€è¦æ‰“åŒ…æˆ<code>dmg</code>æˆ–<code>exe</code>ç­‰å®‰è£…æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://www.electron.build/" target="_blank" rel="noopener">electron-builder</a></p><h3 id="electron-builder"><a href="#electron-builder" class="headerlink" title="electron-builder"></a>electron-builder</h3><p>electron-builderæœ‰å¾ˆå¤šé…ç½®é€‰é¡¹ï¼Œæ¥è°ƒç”¨å„å¼å„æ ·çš„ç¨‹åºæ‰“åŒ…ã€‚è¿™é‡Œåªç®€å•ä»‹ç»ä¸€ä¸‹MacOSç³»ç»Ÿå®‰è£…ç¨‹åºå’ŒWindowsç³»ç»ŸNSISå®‰è£…ç¨‹åºçš„æ‰“åŒ…é…ç½®ï¼ˆ<a href="https://sourceforge.net/projects/nsis/" target="_blank" rel="noopener">NSIS</a>æ˜¯ä¸€ä¸ªå¼€æºçš„ Windows ç³»ç»Ÿä¸‹å®‰è£…ç¨‹åºåˆ¶ä½œå·¥å…·ï¼‰ã€‚</p><p>ä¿®æ”¹<code>package.json</code>ï¼Œæ·»åŠ <code>build</code>é…ç½®ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  "homepage": "./", // å› ä¸ºæœ€åReactåº”ç”¨å¼•ç”¨çš„JSã€CSSç­‰èµ„æºéƒ½æ˜¯æœ¬åœ°çš„ï¼Œåªè¦ç”¨å½“å‰çš„ç›¸å¯¹è·¯å¾„å³å¯</span><br><span class="line">  "build": &#123;</span><br><span class="line">    "appId": "com.xxx.app", // åº”ç”¨ID</span><br><span class="line">    "npmRebuild": true, // æ‰“åŒ…å‰æ˜¯å¦é‡æ–°ç¼–è¯‘NodeJSæ‰©å±•</span><br><span class="line">    "mac": &#123;</span><br><span class="line">      "category": "news", // åº”ç”¨åˆ†ç±»</span><br><span class="line">      "icon": "build/icon.png" // åº”ç”¨iconè·¯å¾„</span><br><span class="line">    &#125;,</span><br><span class="line">    "win": &#123;</span><br><span class="line">      "icon": "build/icon.png", // åº”ç”¨iconè·¯å¾„</span><br><span class="line">      "target": "nsis" // Windowså®‰è£…æ–‡ä»¶çš„ç›®æ ‡ç±»å‹</span><br><span class="line">    &#125;,</span><br><span class="line">    "nsis": &#123;</span><br><span class="line">      "allowToChangeInstallationDirectory": true, // æ˜¯å¦å…è®¸ä¿®æ”¹å®‰è£…è·¯å¾„</span><br><span class="line">      "allowElevation": false, // æ˜¯å¦å…è®¸æå‡æƒé™</span><br><span class="line">      "createDesktopShortcut": true, // æ˜¯å¦åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼</span><br><span class="line">      "menuCategory": true, //æ˜¯å¦åœ¨èœå•æ åˆ›å»ºåˆ†ç±»</span><br><span class="line">      "oneClick": false // æ˜¯å¦ä¸€é”®å®‰è£…</span><br><span class="line">    &#125;,</span><br><span class="line">    "files": [</span><br><span class="line">      "build/**/*" // å¼•å…¥çš„æ–‡ä»¶</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œå°±å¯ä»¥æ‰“åŒ…Electronåº”ç”¨äº†ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yarn react-scripts build // å…ˆç”¨webpackæ‰“åŒ…Reactåº”ç”¨åˆ°`build`ç›®å½•ä¸‹</span><br><span class="line">$ yarn eletron-builder // å†ç”¨eletron-builderæ‰“åŒ…Electronåº”ç”¨</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæ­£å¼æ‰“åŒ…è¿˜éœ€è¦<a href="https://electronjs.org/docs/tutorial/code-signing" target="_blank" rel="noopener">ä»£ç ç­¾å</a>ï¼Œè¿˜æœ‰æ›´å¤šé…ç½®ï¼Œè¯·æŸ¥çœ‹<a href="https://www.electron.build/configuration" target="_blank" rel="noopener">electron-builderé…ç½®è¯´æ˜</a>ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://medium.com/@kitze/%EF%B8%8F-from-react-to-an-electron-app-ready-for-production-a0468ecb1da3" target="_blank" rel="noopener">From React to an Electron app ready for production</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘ç”¨React + Electronå¼€å‘äº†ä¸€ä¸ªRSSé˜…è¯»å™¨ï¼Œå¼€æºåœ¨ï¼š&lt;a href=&quot;https://github.com/breeze2/breader&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/breeze2/breader&lt;/a&gt;ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹å¤§è‡´çš„å¼€å‘è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://breeze2.github.io/breader/screenshot.jpg&quot; alt=&quot;Breader&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
      <category term="react" scheme="https://breeze2.github.io/blog/tags/react/"/>
    
      <category term="electron" scheme="https://breeze2.github.io/blog/tags/electron/"/>
    
  </entry>
  
  <entry>
    <title>PHPä»£ç é™æ€åˆ†æå·¥å…·PHPStan</title>
    <link href="https://breeze2.github.io/blog/practice-php-static-analysis-tool-phpstan.html"/>
    <id>https://breeze2.github.io/blog/practice-php-static-analysis-tool-phpstan.html</id>
    <published>2018-08-08T17:31:23.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘å‘ç°è‡ªå·±å†™çš„PHPä»£ç è¿è¡Œç»“æœæ€»è·Ÿè‡ªå·±é¢„æƒ³çš„ä¸ä¸€æ ·ï¼Œæ’æŸ¥æ—¶å‘ç°å¤§å¤šæ˜¯è¯­æ³•é”™è¯¯ï¼Œåœ¨è¿è¡Œä¹‹å‰é”™è¯¯å·²ç»ç§ä¸‹ã€‚å¯èƒ½æ˜¯è‡ªå·±ç²—å¿ƒå¤§æ„ï¼Œæˆ–è€…è¯´<code>php -l</code>æ£€æµ‹å¤ªç®€å•ï¼Œä¸è¿‡çš„ç¡®æ˜¯æœ‰ä¸€äº›è¯­æ³•é”™è¯¯åŸ‹è—å¾—å¤ªæ·±ï¼ˆæ¯•ç«ŸPHPæ˜¯åŠ¨æ€è¯­è¨€ï¼‰ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•ï¼Œåœ¨ä»£ç ä»£ç æ­£å¼è¿è¡Œä¹‹å‰ï¼ŒæŠŠè¯­æ³•é”™è¯¯å…¨æ‰¾å‡ºæ¥å‘¢ï¼Ÿ</p></blockquote><p>è¿™é‡Œä»‹ç»ä¸€æ¬¾PHPä»£ç é™æ€åˆ†æå·¥å…·ï¼š<a href="https://github.com/phpstan/phpstan" target="_blank" rel="noopener">PHPStan</a>ï¼Œä¸éœ€è¦è¿è¡Œä»£ç ï¼Œä¹Ÿå¯ä»¥å¯¹ä»£ç è¿›è¡Œä¸¥æ ¼çš„è¯­æ³•æ£€æµ‹ï¼Œå°½é‡å°†ä»£ç è¿è¡Œé”™è¯¯ç‡é™åˆ°æœ€ä½ã€‚</p><h2 id="PHPStan"><a href="#PHPStan" class="headerlink" title="PHPStan"></a>PHPStan</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>ç›®å‰ï¼ŒPHPStan<code>V0.10.2</code>è¦æ±‚ç³»ç»Ÿç¯å¢ƒçš„PHPç‰ˆæœ¬ä¸ä½äº7.1ã€‚ç”¨Composerå…¨å±€å®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ composer global require phpstan/phpstan</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>PHPStané™æ€åˆ†æçš„ä½¿ç”¨æ–¹æ³•ååˆ†ç®€å•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ phpstan analyse [-c|--configuration CONFIGURATION] [-l|--level LEVEL] [--no-progress] [--debug] [-a|--<span class="built_in">autoload</span>-file AUTOLOAD-FILE] [--errorFormat ERRORFORMAT] [--memory-limit MEMORY-LIMIT] [--] [&lt;paths&gt;]...</span><br></pre></td></tr></table></figure><ul><li>configurationï¼šè¿è¡Œé…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼›</li><li>levelï¼šä¸¥æ ¼çº§åˆ«ï¼Œ0-7ï¼Œè¶Šå¤§è¶Šä¸¥æ ¼ï¼›</li><li>no-progressï¼šä¸æ˜¾ç¤ºè¿›åº¦ï¼›</li><li>debugï¼šdebugæ¨¡å¼ï¼›</li><li>autoload-fileï¼šè‡ªåŠ¨åŠ è½½æ–‡ä»¶çš„è·¯å¾„ï¼›</li><li>errorFormatï¼šé”™è¯¯æ ¼å¼ï¼›</li><li>memory-limitï¼šå†…å­˜é™åˆ¶ï¼›</li><li>pathsï¼šå¾…åˆ†æçš„æ–‡ä»¶è·¯å¾„ã€‚</li></ul><p>æ¯”å¦‚ï¼Œåˆ†æä¸€ä¸ªPHPæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ phpstan analyse --level=7 --<span class="built_in">autoload</span>-file=/PATH/TO/vendor/autoload.php /PATH/TO/someone.php</span><br></pre></td></tr></table></figure><h2 id="PHPStan-in-VSCode"><a href="#PHPStan-in-VSCode" class="headerlink" title="PHPStan in VSCode"></a>PHPStan in VSCode</h2><p>å½“ç„¶ï¼Œè¯­æ³•åˆ†æåº”è¯¥æ˜¯ç¼–è¾‘å™¨åšçš„äº‹ï¼Œå†™å®Œä»£ç è¿˜è¦åˆ‡æ¢åˆ°å‘½ä»¤ç»ˆç«¯æ‰§è¡Œ<code>phpstan</code>ï¼Œæœªå…è¿‡äºç¹çã€‚æ‰€ä»¥è¿™é‡Œæ¨èä¸€æ¬¾VSCodeæ‰©å±•ï¼š<a href="https://marketplace.visualstudio.com/items?itemName=breezelin.phpstan" target="_blank" rel="noopener">PHP Static Analysis</a>ã€‚</p><p><img src="/blog/assets/images/practice-php-static-analysis-tool-phpstan1.jpg" alt="PHP Static Analysis"></p><p>é¦–å…ˆï¼Œç”¨Composerå…¨å±€å®‰è£…PHPStanï¼›ç„¶åï¼Œåœ¨VSCodeçš„æ‰©å±•ç®¡ç†ä¸­æœç´¢<code>PHP Static Analysis</code>ï¼Œå®‰è£…ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ‰©å±•ï¼›é‡è½½VSCodeé‡è½½çª—å£åï¼Œæ‰©å±•ä¼šè‡ªåŠ¨åˆ†æVSCodeä¸‹æ‰“å¼€çš„PHPæ–‡ä»¶ã€‚</p><p>è¿è¡Œæ•ˆæœï¼š<br><img src="/blog/assets/images/practice-php-static-analysis-tool-phpstan2.jpg" alt="è¿è¡Œæ•ˆæœ"></p><p>æ¯”å¦‚ï¼Œå£°æ˜äº†ä¸€ä¸ªå˜é‡æœªè°ƒç”¨ï¼Œè°ƒç”¨äº†ä¸€ä¸ªæœªå£°æ˜çš„å˜é‡å’Œè°ƒç”¨äº†ä¸€ä¸ªæœªå®šä¹‰çš„æ–¹æ³•ç­‰ç­‰è¿™æ ·é”™è¯¯éƒ½ä¼šè¢«æ£€æµ‹å‡ºäº†ã€‚</p><p>ä¸è¿‡ï¼Œå®½æ¾ä¸€ç‚¹åœ°æ¥è¯´ï¼Œå…¶å®<code>$this-&gt;array()</code>æ–¹æ³•æ˜¯å­˜åœ¨çš„ï¼Œåªæ˜¯é€šè¿‡é­”æœ¯æ–¹æ³•<code>__call()</code>å®ç°çš„ã€‚</p><h2 id="PHPStan-with-Laravel"><a href="#PHPStan-with-Laravel" class="headerlink" title="PHPStan with Laravel"></a>PHPStan with Laravel</h2><p>é«˜ä¸¥æ ¼çº§åˆ«çš„PHPStanæ£€æµ‹åˆ°è°ƒç”¨æœªå£°æ˜çš„ç±»æ–¹æ³•æ—¶ï¼Œä¼šæŠ¥å‘Šç±»ä¸­æ–¹æ³•ä¸å­˜åœ¨çš„é”™è¯¯ï¼Œå³ä½¿è¿™ä¸ªç±»å®šä¹‰äº†<code>__call()</code>æˆ–<code>__callStatic()</code>ã€‚</p><p>å¾ˆå¤šåº”ç”¨æ¡†æ¶ä¸ºäº†ä¼˜é›…ï¼Œå¤§é‡ä½¿ç”¨äº†é­”æœ¯æ–¹æ³•ï¼Œæ¯”å¦‚<a href="https://laravel.com/" target="_blank" rel="noopener">Laravel</a>ã€‚<br>ç”¨PHPStanæ£€æµ‹Laravelé¡¹ç›®ï¼Œè‡ªç„¶ä¼šæŠ¥å‘Šå¾ˆå¤šè°ƒç”¨æœªå£°æ˜ç±»æ–¹æ³•çš„é”™è¯¯ï¼Œå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å€ŸåŠ©<a href="https://github.com/barryvdh/laravel-ide-helper" target="_blank" rel="noopener">laravel-ide-helper</a>æ¥é™ä½è¯¯æŠ¥ã€‚</p><h3 id="å®‰è£…laravel-ide-helper"><a href="#å®‰è£…laravel-ide-helper" class="headerlink" title="å®‰è£…laravel-ide-helper"></a>å®‰è£…laravel-ide-helper</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /PATH/TO/LARAVEL_PROJECT</span><br><span class="line">$ composer require barryvdh/laravel-ide-helper</span><br></pre></td></tr></table></figure><h3 id="æ³¨å…¥LaravelIdeHelper"><a href="#æ³¨å…¥LaravelIdeHelper" class="headerlink" title="æ³¨å…¥LaravelIdeHelper"></a>æ³¨å…¥LaravelIdeHelper</h3><p>ç¼–è¾‘<code>app/Providers/AppServiceProvider.php</code>é‡Œçš„æ³¨å†Œæ–¹æ³•ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;app-&gt;environment() !== <span class="string">'production'</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app-&gt;register(\Barryvdh\LaravelIdeHelper\IdeHelperServiceProvider::class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="ç”Ÿæˆ-ide-helper-php"><a href="#ç”Ÿæˆ-ide-helper-php" class="headerlink" title="ç”Ÿæˆ_ide_helper.php"></a>ç”Ÿæˆ_ide_helper.php</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /PATH/TO/LARAVEL_PROJECT</span><br><span class="line">$ php artisan ide-helper:generate</span><br></pre></td></tr></table></figure><p>è¿™æ—¶ï¼ŒLaravelæ¡†æ¶ä¸­çš„Facadeç±»ï¼ŒåŸæœ¬é€šè¿‡<code>__callStatic()</code>è·å–çš„é™æ€æ–¹æ³•ï¼Œå…¨éƒ¨åœ¨_ide_helper.phpå£°æ˜äº†ï¼Œåœ¨PHPStanæ£€æµ‹Laravelé¡¹ç›®ä»£ç æ—¶å¼•å…¥<code>_ide_helper.php</code>æ–‡ä»¶ï¼Œå°±å¯ä»¥å‡å°‘è¯¯æŠ¥ã€‚</p><h3 id="PHPStané…ç½®"><a href="#PHPStané…ç½®" class="headerlink" title="PHPStané…ç½®"></a>PHPStané…ç½®</h3><p>åœ¨Laravelé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»º<code>phpstan.neon</code>æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">parameters:</span><br><span class="line">    autoload_files:</span><br><span class="line">        - %currentWorkingDirectory%/_ide_helper.php</span><br></pre></td></tr></table></figure><p>åœ¨Laravelé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ<code>phpstan</code>å‘½ä»¤æ—¶ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨<code>phpstan.neon</code>è¿™ä¸ªé…ç½®ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ä»£ç çš„è¯­æ³•é”™è¯¯ï¼Œåº”è¯¥åœ¨ç¼–å†™çš„æ—¶å€™åŠæ—¶å‘ç°ï¼Œå°½é‡å‡å°‘æ­£å¼è¿è¡Œæ—¶é”™è¯¯ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘å‘ç°è‡ªå·±å†™çš„PHPä»£ç è¿è¡Œç»“æœæ€»è·Ÿè‡ªå·±é¢„æƒ³çš„ä¸ä¸€æ ·ï¼Œæ’æŸ¥æ—¶å‘ç°å¤§å¤šæ˜¯è¯­æ³•é”™è¯¯ï¼Œåœ¨è¿è¡Œä¹‹å‰é”™è¯¯å·²ç»ç§ä¸‹ã€‚å¯èƒ½æ˜¯è‡ªå·±ç²—å¿ƒå¤§æ„ï¼Œæˆ–è€…è¯´&lt;code&gt;php -l&lt;/code&gt;æ£€æµ‹å¤ªç®€å•ï¼Œä¸è¿‡çš„ç¡®æ˜¯æœ‰ä¸€äº›è¯­æ³•é”™è¯¯åŸ‹è—å¾—å¤ªæ·±ï¼ˆæ¯•ç«ŸPHPæ˜¯åŠ¨æ€è¯­è¨€ï¼‰ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•ï¼Œåœ¨ä»£ç ä»£ç æ­£å¼è¿è¡Œä¹‹å‰ï¼ŒæŠŠè¯­æ³•é”™è¯¯å…¨æ‰¾å‡ºæ¥å‘¢ï¼Ÿ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™é‡Œä»‹ç»ä¸€æ¬¾PHPä»£ç é™æ€åˆ†æå·¥å…·ï¼š&lt;a href=&quot;https://github.com/phpstan/phpstan&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;PHPStan&lt;/a&gt;ï¼Œä¸éœ€è¦è¿è¡Œä»£ç ï¼Œä¹Ÿå¯ä»¥å¯¹ä»£ç è¿›è¡Œä¸¥æ ¼çš„è¯­æ³•æ£€æµ‹ï¼Œå°½é‡å°†ä»£ç è¿è¡Œé”™è¯¯ç‡é™åˆ°æœ€ä½ã€‚&lt;/p&gt;
&lt;h2 id=&quot;PHPStan&quot;&gt;&lt;a href=&quot;#PHPStan&quot; class=&quot;headerlink&quot; title=&quot;PHPStan&quot;&gt;&lt;/a&gt;PHPStan&lt;/h2&gt;&lt;h3 id=&quot;å®‰è£…&quot;&gt;&lt;a href=&quot;#å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…&quot;&gt;&lt;/a&gt;å®‰è£…&lt;/h3&gt;&lt;p&gt;ç›®å‰ï¼ŒPHPStan&lt;code&gt;V0.10.2&lt;/code&gt;è¦æ±‚ç³»ç»Ÿç¯å¢ƒçš„PHPç‰ˆæœ¬ä¸ä½äº7.1ã€‚ç”¨Composerå…¨å±€å®‰è£…ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ composer global require phpstan/phpstan&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="php" scheme="https://breeze2.github.io/blog/tags/php/"/>
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
  </entry>
  
  <entry>
    <title>ç”¨Swooleå®ç°ä¸€ä¸ªç®€å•çš„MySQLè¿æ¥æ± </title>
    <link href="https://breeze2.github.io/blog/swoole-a-simple-mysql-connection-pool.html"/>
    <id>https://breeze2.github.io/blog/swoole-a-simple-mysql-connection-pool.html</id>
    <published>2018-07-20T09:58:23.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘Swooleå‘å¸ƒäº†4.0.2ç‰ˆæœ¬ï¼Œå†…ç½®åç¨‹æ›´åŠ å®Œå–„ï¼Œåˆ©ç”¨Swoole\Coroutine\Channelå’ŒSwoole\Coroutine\MySQLå¯ä»¥è½»æ¾å®ç°ä¸€ä¸ªMySQLè¿æ¥æ± ã€‚</p></blockquote><a id="more"></a><h2 id="å®ç°ä»£ç "><a href="#å®ç°ä»£ç " class="headerlink" title="å®ç°ä»£ç "></a>å®ç°ä»£ç </h2><p>ç›´æ¥çœ‹ä»£ç ï¼Œè„šæœ¬<code>mysql_connection_pool.php</code>ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// mysql_connection_pool.php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Coroutine</span> <span class="title">as</span> <span class="title">Co</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Coroutine</span>\<span class="title">Channel</span> <span class="title">as</span> <span class="title">CoChannel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Coroutine</span>\<span class="title">MySQL</span> <span class="title">as</span> <span class="title">CoMySQL</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Http</span>\<span class="title">Server</span> <span class="title">as</span> <span class="title">HttpServer</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlCoroutine</span> <span class="keyword">extends</span> <span class="title">CoMySQL</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $used_at = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUsedAt</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;used_at;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setUsedAt</span><span class="params">($time)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;used_at = $time;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isConnected</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connected;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $max_number;</span><br><span class="line">    <span class="keyword">protected</span> $min_number;</span><br><span class="line">    <span class="keyword">protected</span> $config;</span><br><span class="line">    <span class="keyword">protected</span> $channel;</span><br><span class="line">    <span class="keyword">protected</span> $number;</span><br><span class="line">    <span class="keyword">private</span> $is_recycling = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [__construct æ„é€ å‡½æ•°]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array   $config         [MySQLæœåŠ¡å™¨ä¿¡æ¯]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $max_number     [æœ€å¤§è¿æ¥æ•°]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $min_number     [æœ€å°è¿æ¥æ•°]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $config, $max_number = <span class="number">150</span>, $min_number = <span class="number">50</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;max_number = $max_number;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;min_number = $min_number;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config     = $config;</span><br><span class="line">        <span class="comment">// $this-&gt;channel        = new CoChannel($max_number);</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;number = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initChannel</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;channel = <span class="keyword">new</span> CoChannel(<span class="keyword">$this</span>-&gt;max_number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">isFull</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;number === <span class="keyword">$this</span>-&gt;max_number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;number === <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">shouldRecover</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;number &gt; <span class="keyword">$this</span>-&gt;min_number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">increase</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;number += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">decrease</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;number -= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isFull()) &#123;</span><br><span class="line">            printf(<span class="string">"%d do %s\n"</span>, time(), <span class="string">'build one'</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;increase();</span><br><span class="line">            $mysql = <span class="keyword">new</span> MySqlCoroutine();</span><br><span class="line">            $mysql-&gt;connect(<span class="keyword">$this</span>-&gt;config);</span><br><span class="line">            $mysql-&gt;setUsedAt(time());</span><br><span class="line">            <span class="keyword">return</span> $mysql;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">rebuild</span><span class="params">(MySqlCoroutine $mysql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        printf(<span class="string">"%d do %s\n"</span>, time(), <span class="string">'rebuild one'</span>);</span><br><span class="line">        $mysql-&gt;connect(<span class="keyword">$this</span>-&gt;config);</span><br><span class="line">        $mysql-&gt;setUsedAt(time());</span><br><span class="line">        <span class="keyword">return</span> $mysql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">(MySqlCoroutine $mysql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isEmpty()) &#123;</span><br><span class="line">            printf(<span class="string">"%d do %s\n"</span>, time(), <span class="string">'destroy one'</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;decrease();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">push</span><span class="params">(MySqlCoroutine $mysql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;channel-&gt;isFull()) &#123;</span><br><span class="line">            printf(<span class="string">"%d do %s\n"</span>, time(), <span class="string">'push one'</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;channel-&gt;push($mysql);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($mysql = <span class="keyword">$this</span>-&gt;build()) &#123;</span><br><span class="line">            <span class="keyword">return</span> $mysql;</span><br><span class="line">        &#125;</span><br><span class="line">        $mysql = <span class="keyword">$this</span>-&gt;channel-&gt;pop();</span><br><span class="line">        $now   = time();</span><br><span class="line">        printf(<span class="string">"%d do %s\n"</span>, time(), <span class="string">'pop one'</span>);</span><br><span class="line">        <span class="keyword">if</span> (!$mysql-&gt;isConnected()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;rebuild($mysql);</span><br><span class="line">        &#125;</span><br><span class="line">        $mysql-&gt;setUsedAt($now);</span><br><span class="line">        <span class="keyword">return</span> $mysql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [autoRecycling è‡ªåŠ¨å›æ”¶è¿æ¥]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  integer $timeout [è¿æ¥ç©ºç½®æ—¶é™]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  integer $sleep   [å¾ªç¯æ£€æŸ¥çš„æ—¶é—´é—´éš”]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> null             [null]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">autoRecycling</span><span class="params">($timeout = <span class="number">200</span>, $sleep = <span class="number">20</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;is_recycling) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;is_recycling = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                Co::sleep($sleep);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;shouldRecover()) &#123;</span><br><span class="line">                    $mysql = <span class="keyword">$this</span>-&gt;channel-&gt;pop();</span><br><span class="line">                    $now   = time();</span><br><span class="line">                    <span class="keyword">if</span> ($now - $mysql-&gt;getUsedAt() &gt; $timeout) &#123;</span><br><span class="line">                        printf(<span class="string">"%d do %s\n"</span>, time(), <span class="string">'recover one'</span>);</span><br><span class="line">                        <span class="keyword">$this</span>-&gt;decrease();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        !<span class="keyword">$this</span>-&gt;channel-&gt;isFull() &amp;&amp; <span class="keyword">$this</span>-&gt;channel-&gt;push($mysql);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$server = <span class="keyword">new</span> HttpServer(<span class="string">'127.0.0.1'</span>, <span class="number">9501</span>, SWOOLE_BASE);</span><br><span class="line"></span><br><span class="line">$server-&gt;set([</span><br><span class="line">    <span class="string">'worker_num'</span> =&gt; <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">$manager = <span class="keyword">new</span> MySqlManager([</span><br><span class="line">    <span class="string">'host'</span>     =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'port'</span>     =&gt; <span class="number">3306</span>,</span><br><span class="line">    <span class="string">'user'</span>     =&gt; <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">    <span class="string">'database'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">    <span class="string">'timeout'</span>  =&gt; <span class="number">-1</span>,</span><br><span class="line"></span><br><span class="line">], <span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">$server-&gt;on(<span class="string">'workerStart'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($server)</span> <span class="title">use</span> <span class="params">($manager)</span> </span>&#123;</span><br><span class="line">    $manager-&gt;initChannel();</span><br><span class="line">    $manager-&gt;autoRecycling(<span class="number">4</span>, <span class="number">2</span>); <span class="comment">// å¯åŠ¨è‡ªåŠ¨å›æ”¶</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$server-&gt;on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($request, $response)</span> <span class="title">use</span> <span class="params">($server, $manager)</span> </span>&#123;</span><br><span class="line">    $mysql = $manager-&gt;pop(); <span class="comment">// å–å‡ºä¸€ä¸ªMySQLè¿æ¥</span></span><br><span class="line">    $mysql-&gt;query(<span class="string">'select sleep(1);'</span>);</span><br><span class="line">    $manager-&gt;push($mysql); <span class="comment">// è¿”å›ä¸€ä¸ªMySQLè¿æ¥</span></span><br><span class="line">    $response-&gt;end(json_encode($server-&gt;stats()));</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$server-&gt;start();</span><br></pre></td></tr></table></figure><h2 id="è¿è¡Œæ•ˆæœ"><a href="#è¿è¡Œæ•ˆæœ" class="headerlink" title="è¿è¡Œæ•ˆæœ"></a>è¿è¡Œæ•ˆæœ</h2><p>è¿è¡Œè„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php mysql_connection_pool.php</span><br></pre></td></tr></table></figure><p>abæµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ab -c 8 -n 8 http://127.0.0.1:9501/</span><br></pre></td></tr></table></figure><p>é—´éš”10ç§’åï¼Œå†æ¬¡æµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ab -c 8 -n 8 http://127.0.0.1:9501/</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">1532083141 <span class="keyword">do</span> build one</span><br><span class="line">1532083141 <span class="keyword">do</span> build one</span><br><span class="line">1532083141 <span class="keyword">do</span> build one</span><br><span class="line">1532083141 <span class="keyword">do</span> build one</span><br><span class="line">1532083142 <span class="keyword">do</span> push one</span><br><span class="line">1532083142 <span class="keyword">do</span> push one</span><br><span class="line">1532083142 <span class="keyword">do</span> push one</span><br><span class="line">1532083142 <span class="keyword">do</span> pop one</span><br><span class="line">1532083142 <span class="keyword">do</span> pop one</span><br><span class="line">1532083142 <span class="keyword">do</span> pop one</span><br><span class="line">1532083142 <span class="keyword">do</span> push one</span><br><span class="line">1532083142 <span class="keyword">do</span> pop one</span><br><span class="line">1532083143 <span class="keyword">do</span> push one</span><br><span class="line">1532083143 <span class="keyword">do</span> push one</span><br><span class="line">1532083143 <span class="keyword">do</span> push one</span><br><span class="line">1532083143 <span class="keyword">do</span> push one</span><br><span class="line">1532083147 <span class="keyword">do</span> recover one</span><br><span class="line">1532083149 <span class="keyword">do</span> recover one</span><br><span class="line">1532083160 <span class="keyword">do</span> build one</span><br><span class="line">1532083160 <span class="keyword">do</span> build one</span><br><span class="line">1532083160 <span class="keyword">do</span> pop one</span><br><span class="line">1532083160 <span class="keyword">do</span> rebuild one</span><br><span class="line">1532083160 <span class="keyword">do</span> pop one</span><br><span class="line">1532083160 <span class="keyword">do</span> rebuild one</span><br><span class="line">1532083161 <span class="keyword">do</span> push one</span><br><span class="line">1532083161 <span class="keyword">do</span> pop one</span><br><span class="line">1532083161 <span class="keyword">do</span> push one</span><br><span class="line">1532083161 <span class="keyword">do</span> push one</span><br><span class="line">1532083161 <span class="keyword">do</span> push one</span><br><span class="line">1532083161 <span class="keyword">do</span> pop one</span><br><span class="line">1532083161 <span class="keyword">do</span> pop one</span><br><span class="line">1532083161 <span class="keyword">do</span> pop one</span><br><span class="line">1532083162 <span class="keyword">do</span> push one</span><br><span class="line">1532083162 <span class="keyword">do</span> push one</span><br><span class="line">1532083162 <span class="keyword">do</span> push one</span><br><span class="line">1532083162 <span class="keyword">do</span> push one</span><br><span class="line">1532083166 <span class="keyword">do</span> recover one</span><br><span class="line">1532083168 <span class="keyword">do</span> recover one</span><br></pre></td></tr></table></figure><h2 id="ä»£ç è§£é‡Š"><a href="#ä»£ç è§£é‡Š" class="headerlink" title="ä»£ç è§£é‡Š"></a>ä»£ç è§£é‡Š</h2><p>é¦–å…ˆä»£ç é‡Œå®šä¹‰äº†ä¸¤ä¸ªç±»ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>MySqlCoroutine</li><li>MySqlManager</li></ul><h3 id="MySqlCoroutine"><a href="#MySqlCoroutine" class="headerlink" title="MySqlCoroutine"></a>MySqlCoroutine</h3><p>MySqlCoroutineç»§æ‰¿è‡ª<code>Swoole\Coroutine\MySQL</code>ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¢åŠ ä¸€ä¸ªå±æ€§<code>used_at</code>å’Œä¸¤ä¸ªä¸ä¹‹é…å¥—çš„<code>get/set</code>æ–¹æ³•ï¼š<code>getUsedAt</code>å’Œ<code>setUsedAt</code>ã€‚<code>used_at</code>æ˜¯ä¸ªæ—¶é—´æˆ³ï¼Œè®°å½•MySqlCoroutineçš„è¢«è°ƒç”¨çš„æ—¶é—´ç‚¹ã€‚è€Œ<code>isConnected</code>æ–¹æ³•æ˜¯åˆ¤æ–­ä¸æœåŠ¡å™¨çš„è¿æ¥æ˜¯å¦æœ‰æ•ˆã€‚</p><h3 id="MySqlManager"><a href="#MySqlManager" class="headerlink" title="MySqlManager"></a>MySqlManager</h3><p>æ¯ä¸ªMySqlCoroutineå®ä¾‹ä¸MySQLæœåŠ¡å™¨ç»´ç³»ä¸€ä¸ªè¿æ¥ï¼Œè€ŒMySqlManageræ¥ç®¡ç†è¿™äº›MySqlCoroutineï¼Œå³ç®¡ç†æ•´ä¸ªè¿æ¥æ± ã€‚<br>æ„å»ºMySqlManageræ—¶ï¼Œç”¨åˆ°ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li><code>config</code>ï¼šç”¨äºæ„å»ºMySqlCoroutineï¼›</li><li><code>max_number</code>ï¼šæœ€å¤§è¿æ¥æ•°ï¼›</li><li><code>min_number</code>ï¼šæœ€å°è¿æ¥æ•°ã€‚</li></ul><p>å…¶å®è¿™é‡Œè¯´çš„è¿æ¥æ± ï¼Œå°±æ˜¯MySqlManagerçš„<code>mysql_channel</code>å±æ€§ï¼Œå®é™…çš„æ•°æ®ç±»å‹æ˜¯<code>Swoole\Coroutine\Channel</code>ã€‚è€Œæ± å†…è¿æ¥çš„æ•°é‡ï¼Œä¼šç”¨<code>number</code>å±æ€§è®°å½•ä¸‹æ¥ã€‚</p><h4 id="å†…éƒ¨æ–¹æ³•ï¼šbuild-rebuild-destroy"><a href="#å†…éƒ¨æ–¹æ³•ï¼šbuild-rebuild-destroy" class="headerlink" title="å†…éƒ¨æ–¹æ³•ï¼šbuild/rebuild/destroy"></a>å†…éƒ¨æ–¹æ³•ï¼šbuild/rebuild/destroy</h4><ul><li>buildæ–¹æ³•ï¼šå¦‚æœå½“å‰è¿æ¥çš„æ•°é‡æœªè¾¾åˆ°æœ€å¤§å€¼ï¼Œåˆ™æ–°å»ºä¸€ä¸ªMySqlCoroutineå®ä¾‹ä½œè¿”å›å€¼ï¼Œå¹¶ä¸”<code>number</code>å±æ€§åŠ 1ï¼›å¦åˆ™ï¼Œè¿”å›falseã€‚</li><li>rebuildæ–¹æ³•ï¼šä¼ å…¥ä¸€ä¸ªMySqlCoroutineå®ä¾‹ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„MySqlCoroutineå®ä¾‹ã€‚</li><li>destroyæ–¹æ³•ï¼šä¼ å…¥ä¸€ä¸ªMySqlCoroutineå®ä¾‹ï¼Œå¦‚æœ<code>number</code>å¤§äº0ï¼Œé‚£ä¹ˆ<code>number</code>å‡1ã€‚</li></ul><h4 id="å…¬æœ‰æ–¹æ³•ï¼špop-push-autoRecycling"><a href="#å…¬æœ‰æ–¹æ³•ï¼špop-push-autoRecycling" class="headerlink" title="å…¬æœ‰æ–¹æ³•ï¼špop/push/autoRecycling"></a>å…¬æœ‰æ–¹æ³•ï¼špop/push/autoRecycling</h4><ul><li>popæ–¹æ³•ï¼šå…ˆæ‰§è¡Œbuildæ–¹æ³•ï¼Œè‹¥æ˜¯è¿”å›MySqlCoroutineå®ä¾‹ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ªMySqlCoroutineå®ä¾‹ï¼›å¦åˆ™ï¼Œä»<code>mysql_channel</code>é‡Œ<code>pop</code>ï¼ˆå¦‚æœ<code>mysql_channel</code>å·²ç»ç©ºäº†ï¼Œå½“å‰åç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç­‰å¾…å…¶ä»–åç¨‹å¾€<code>mysql_channel</code>æ”¾å…¥MySqlCoroutineå®ä¾‹ï¼‰ï¼Œè‹¥æ˜¯å–å‡ºçš„MySqlCoroutineå®ä¾‹çš„è¿æ¥å·²æ— æ•ˆï¼ˆè¿æ¥å¯èƒ½å·²ç»è¢«MySQLæœåŠ¡å™¨è‡ªåŠ¨æ–­å¼€ï¼‰ï¼Œé‚£å°±è¿”å›rebuildæ–¹æ³•çš„å€¼ï¼Œå¦åˆ™ç›´æ¥è¿”å›è¿™ä¸ªMySqlCoroutineå®ä¾‹ã€‚</li><li>pushæ–¹æ³•ï¼šå¦‚æœ<code>mysql_channel</code>æœªæ»¡ï¼Œå°±å¾€<code>mysql_channel</code>æ”¾å…¥ä¸€ä¸ªMySqlCoroutineï¼›å¦åˆ™ï¼Œä»€ä¹ˆä¹Ÿä¸åšã€‚</li><li>autoRecyclingæ–¹æ³•ï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œ<code>$timeou</code>å’Œ<code>$sleep</code>ï¼›æ¯éš”<code>$sleep</code>ç§’ï¼Œå°±æ£€æŸ¥ä¸€æ¬¡ï¼Œå½“å‰è¿æ¥çš„æ•°é‡è¶…è¿‡äº†æœ€å°å€¼ï¼Œé‚£ä¹ˆå°±ä»<code>mysql_channel</code>é‡Œ<code>pop</code>ä¸€ä¸ªMySqlCoroutineå®ä¾‹ï¼Œè‹¥æ˜¯MySqlCoroutineå®ä¾‹ä¸Šä¸€æ¬¡ä½¿ç”¨æ—¶é—´ä¸ç°åœ¨æ—¶é—´é—´éš”è¶…è¿‡äº†<code>$timeou</code>ç§’ï¼Œè¯´æ˜è¿™ä¸ªMySqlCoroutineå®ä¾‹æ²¡æœ‰è¢«é¢‘ç¹ä½¿ç”¨ï¼Œå¯ä»¥å›æ”¶ï¼›æ‰€è°“å›æ”¶ï¼Œå°±æ˜¯ä»<code>mysql_channel</code>å–å‡ºåï¼Œä¸å†æ”¾å›ï¼Œå¹¶ä¸”<code>number</code>å‡1ã€‚</li></ul><h3 id="è°ƒç”¨"><a href="#è°ƒç”¨" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h3><p>åœ¨<code>Swoole\Http\Server</code>çš„<code>workerStart</code>å›è°ƒå‡½æ•°é‡Œï¼Œè®©MySqlManagerå®ä¾‹å¼€å§‹è‡ªåŠ¨å›æ”¶MySqlCoroutineå®ä¾‹ï¼›è€Œåœ¨<code>Swoole\Http\Server</code>çš„<code>request</code>å›è°ƒå‡½æ•°é‡Œï¼Œéœ€è¦MySqlCoroutineå®ä¾‹æ—¶ï¼Œè°ƒç”¨MySqlManagerå®ä¾‹çš„popæ–¹æ³•ä»è¿æ¥æ± é‡Œè·å–ï¼Œç”¨å®Œå†è°ƒç”¨MySqlManagerå®ä¾‹çš„pushæ–¹æ³•æ”¾å›è¿æ¥æ± ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å°±è¿™æ ·ï¼Œåˆ©ç”¨Swooleæ‰©å±•ï¼Œå‡ åè¡ŒPHPä»£ç å°±èƒ½å®ç°ä¸€ä¸ªè¿æ¥é—´å¯ä»¥å¹¶è¡Œä½¿ç”¨ï¼Œæ± å†…æœ‰æœ€å¤§/æœ€å°æ•°é‡é™åˆ¶ï¼Œæœ‰è‡ªåŠ¨å›æ”¶ç©ºé—²è¿æ¥æœºåˆ¶çš„MySQLè¿æ¥æ± ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘Swooleå‘å¸ƒäº†4.0.2ç‰ˆæœ¬ï¼Œå†…ç½®åç¨‹æ›´åŠ å®Œå–„ï¼Œåˆ©ç”¨Swoole\Coroutine\Channelå’ŒSwoole\Coroutine\MySQLå¯ä»¥è½»æ¾å®ç°ä¸€ä¸ªMySQLè¿æ¥æ± ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="mysql" scheme="https://breeze2.github.io/blog/tags/mysql/"/>
    
      <category term="php" scheme="https://breeze2.github.io/blog/tags/php/"/>
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
      <category term="swoole" scheme="https://breeze2.github.io/blog/tags/swoole/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨JPEGå›¾ç‰‡ä¸­åµŒå…¥HTML</title>
    <link href="https://breeze2.github.io/blog/practice-embed-html-in-jpeg.html"/>
    <id>https://breeze2.github.io/blog/practice-embed-html-in-jpeg.html</id>
    <published>2018-06-12T15:27:23.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘çœ‹åˆ°ä¸€ä¸ªæœ‰è¶£çš„ç½‘é¡µï¼š<a href="http://lcamtuf.coredump.cx/squirrel/" target="_blank" rel="noopener">http://lcamtuf.coredump.cx/squirrel/</a>ï¼Œæˆ–è€…è¯´ä¸€å¼ æœ‰è¶£çš„å›¾ç‰‡â€”â€”å› ä¸ºç”¨ç½‘ç»œæµè§ˆå™¨æ‰“å¼€å®ƒçœ‹åˆ°çš„æ˜¯ä¸€ä¸ªç½‘é¡µï¼Œç”¨å›¾ç‰‡æµè§ˆå™¨æ‰“å¼€å®ƒçœ‹åˆ°çš„åˆæ˜¯ä¸€å¼ å›¾ç‰‡ã€‚</p></blockquote><p><img src="/blog/assets/images/practice-embed-html-in-jpeg1.jpg" alt="æ¾é¼ è¿·"></p><a id="more"></a><p>åœ¨æœåŠ¡ç«¯è¦å¯¹åŒä¸€ä¸ªè¯·æ±‚åœ°å€å®ç°ä¸åŒå“åº”æ˜¯ååˆ†ç®€å•çš„ï¼Œæ¯”å¦‚é€šè¿‡è¯·æ±‚å¤´<code>Accept</code>æ¥åˆ¤æ–­ï¼š</p><ul><li><code>Accept=text/html</code>åˆ™è¿”å›è¶…æ–‡æœ¬ï¼›</li><li><code>Accept=image/*</code>åˆ™è¿”å›å›¾ç‰‡ï¼›</li><li>â€¦â€¦</li></ul><p>å¯æ˜¯<a href="http://lcamtuf.coredump.cx/squirrel/" target="_blank" rel="noopener">http://lcamtuf.coredump.cx/squirrel/</a>è¿™ä¸ªç½‘é¡µï¼ˆæˆ–è€…è¯´å›¾ç‰‡ï¼‰åœ¨è„±ç¦»æœåŠ¡ç«¯çš„æƒ…å†µä¸‹ï¼Œä¾ç„¶èƒ½å¤Ÿå‘ˆç°å‡ºç½‘é¡µå’Œå›¾ç‰‡ä¸¤ç§æ–‡ä»¶å†…å®¹ï¼Œè¿™æ˜¯æ€æ ·å®ç°çš„å‘¢ï¼Ÿ</p><p>åœ¨å‰ç«¯æ²¡æœ‰ç§˜å¯†ï¼Œæ‰“å¼€ç½‘ç»œæµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·æŸ¥çœ‹ä¸€ä¸‹ç½‘å€çš„å“åº”å†…å®¹ï¼š</p><p><img src="/blog/assets/images/practice-embed-html-in-jpeg2.jpg" alt="å“åº”å†…å®¹"></p><p>å“åº”å†…å®¹ä¸­æœ‰ç†Ÿæ‚‰HTMLæ ‡ç­¾ï¼Œä¹Ÿæœ‰ä¸€å¤§å †ä¹±ç ã€‚è¿™å †ä¹±ç åº”è¯¥æ˜¯å›¾ç‰‡æ–‡ä»¶çš„å­—ç¬¦è¯»ç ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆåœ¨ç½‘é¡µä¸Šçœ‹ä¸åˆ°å‘¢ï¼Ÿ<br>åŸæ¥HTMLä¸­ä½¿ç”¨äº†<code>body { visibility: hidden; }</code>æ ·å¼å’Œ<code>&lt;!--</code>æ³¨é‡Šæ ‡ç­¾ï¼ˆæµè§ˆå™¨è‡ªåŠ¨è¡¥å…¨ï¼‰ï¼Œä¹±ç éƒ¨åˆ†å°±è¿™æ ·è¢«éšè—äº†ã€‚</p><p>HTMLå†…å®¹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"><span class="selector-tag">body</span> &#123; <span class="attribute">visibility</span>: hidden; &#125; <span class="selector-class">.n</span> &#123; <span class="attribute">visibility</span>: visible; <span class="attribute">position</span>: absolute; <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">1ex</span> <span class="number">0</span> <span class="number">1ex</span>; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">left</span>: <span class="number">0</span>; &#125; <span class="selector-tag">h1</span> &#123; <span class="attribute">margin-top</span>: <span class="number">0.4ex</span>; <span class="attribute">margin-bottom</span>: <span class="number">0.8ex</span>; &#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">n</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">i</span>&gt;</span>Hello, squirrel fans!<span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span>This is an embedded landing page for an image. You can link to this URL and get the HTML document you are viewing right now (soon to include essential squirrel facts); or embed the exact same URL as an image on your own squirrel-themed page:<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">xmp</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://lcamtuf.coredump.cx/squirrel/"</span>&gt;</span>Click here!<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">xmp</span>&gt;</span><span class="tag">&lt;<span class="name">xmp</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://lcamtuf.coredump.cx/squirrel/"</span>&gt;</span><span class="tag">&lt;/<span class="name">xmp</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>No server-side hacks involved - the magic happens in your browser. Let's try embedding the current page as an image right now (INCEPTION!):<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"#"</span> <span class="attr">style</span>=<span class="string">"border: 1px solid crimson"</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>Pretty radical, eh? Send money to: lcamtuf@coredump.cx<span class="comment">&lt;!--</span></span><br></pre></td></tr></table></figure><p>ç„¶è€Œå›¾ç‰‡å±•ç¤ºä¸­ï¼Œä¹Ÿæ²¡çœ‹åˆ°HTMLçš„å†…å®¹ï¼Œåˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><h2 id="JPEGç›¸å…³"><a href="#JPEGç›¸å…³" class="headerlink" title="JPEGç›¸å…³"></a>JPEGç›¸å…³</h2><p>é¦–å…ˆå¯ä»¥ç¡®å®šè¿™å¼ å›¾ç‰‡æ˜¯JPEGæ ¼å¼ï¼Œå› ä¸ºå†…å®¹å¼€å¤´æœ‰æ˜æ˜¾çš„<code>JFIF</code>æ ‡è®°ï¼ˆ<a href="https://en.wikipedia.org/wiki/JPEG_File_Interchange_Format" target="_blank" rel="noopener">JFIF</a>ï¼Œæ˜¯JPEGæœ€å¸¸è§çš„æ–‡ä»¶å­˜å‚¨æ ¼å¼ï¼Œä¹Ÿæ˜¯æ ‡å‡†çš„JPEGæ–‡ä»¶è½¬æ¢æ ¼å¼ï¼‰ã€‚<br>JPEGæ ¼å¼å®šä¹‰äº†ä¸€ç³»åˆ—æ ‡è®°ç ï¼Œéƒ½æ˜¯ä»¥0xFFå¼€å¤´ï¼Œå¸¸è§çš„æœ‰ï¼š</p><ul><li><code>0xFFD8</code>ï¼šSOIï¼ˆStart Of Imageï¼‰ï¼Œå›¾ç‰‡å¼€å§‹æ ‡è®°ï¼›</li><li><code>0xFFD9</code>ï¼šEOIï¼ˆEnd Of Imageï¼‰ï¼Œå›¾ç‰‡ç»“æŸæ ‡è®°ï¼›</li><li><code>0xFFDA</code>ï¼šSOSï¼ˆStart Of Scanï¼‰ï¼Œæ‰«æå¼€å§‹æ ‡è®°ï¼›</li><li><code>0xFFDB</code>ï¼šDQTï¼ˆDefine Quantization Tableï¼‰ï¼Œå®šä¹‰é‡åŒ–è¡¨ï¼›</li><li><code>0xFFC4</code>ï¼šDHTï¼ˆDefine Huffman Tableï¼‰ï¼Œå®šä¹‰å“ˆå¤«æ›¼è¡¨ï¼›</li><li><code>0xFFEn</code>ï¼šAPPnï¼ˆApplication Specificï¼‰ï¼Œåº”ç”¨ç¨‹åºä¿¡æ¯ï¼›</li><li><code>0xFFFE</code>ï¼šCOMï¼ˆCommentï¼‰ï¼Œæ³¨é‡Šï¼›</li><li>â€¦â€¦</li></ul><p>å›¾ç‰‡çš„æ³¨é‡Šå†…å®¹ä¸ä¼šå±•ç¤ºï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬å¯ä»¥æŠŠHTMLéšè—åœ¨å›¾ç‰‡æ³¨é‡Šä¸­ã€‚<br>ç”¨åå…­è¿›åˆ¶è¯»å–è¿™å¼ å›¾ç‰‡ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><p><img src="/blog/assets/images/practice-embed-html-in-jpeg3.jpg" alt="åå…­è¿›åˆ¶è¯»å–"></p><p>è¿™å¼ å›¾ç‰‡ä¸­ä½¿ç”¨äº†æ³¨é‡Šæ ‡è®°<code>0xFFFE</code>ï¼Œæ ‡è®°åé¢è·Ÿç€<code>0x0372</code>ã€‚<code>0x0372</code>è½¬æˆåè¿›åˆ¶æ˜¯<code>882</code>ï¼Œè€ŒHTMLå†…å®¹çš„é•¿åº¦åˆšå¥½æ˜¯880ä¸ªå­—èŠ‚ï¼ˆ<code>0x0372</code>æœ¬èº«å 2ä¸ªå­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“ï¼ŒHTMLå†…å®¹å°±æ˜¯å†™åœ¨è¿™å¼ å›¾ç‰‡æ³¨é‡Šä¸­ã€‚</p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>ä¸‹é¢ç”¨PHPä»£ç ç®€å•å®ç°ä¸€ä¸ªå°†HTMLå†…å®¹åµŒå…¥JPEGä¸­çš„å‡½æ•°ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">embedHtmlInJpeg</span><span class="params">($jpeg_file, $html_str, $html_file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $length = strlen($html_str) + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> ($length &gt; <span class="number">256</span> * <span class="number">256</span> - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $content = <span class="string">''</span>;</span><br><span class="line">    $reader  = fopen($jpeg_file, <span class="string">'rb'</span>);</span><br><span class="line">    $writer  = fopen($html_file, <span class="string">'wb'</span>);</span><br><span class="line">    $content = fread($reader, <span class="number">2</span>); <span class="comment">// read 0xFFD8</span></span><br><span class="line">    fwrite($writer, $content); <span class="comment">// write 0xFFD8</span></span><br><span class="line"></span><br><span class="line">    $header  = <span class="string">'FFFE'</span> . sprintf(<span class="string">'%04X'</span>, $length);</span><br><span class="line">    $header  = pack(<span class="string">'H*'</span>, $header);</span><br><span class="line">    $content = $header . $html_str;</span><br><span class="line">    fwrite($writer, $content); <span class="comment">// write 0xFFFE</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!feof($reader)) &#123;</span><br><span class="line">        $content = fread($reader, <span class="number">8192</span>);</span><br><span class="line">        fwrite($writer, $content); <span class="comment">// write else</span></span><br><span class="line">    &#125;</span><br><span class="line">    fclose($reader);</span><br><span class="line">    fclose($writer);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// call it</span></span><br><span class="line">embedHtmlInJpeg(<span class="string">'lena.jpg'</span>,</span><br><span class="line">    <span class="string">'&lt;html&gt;&lt;body&gt;&lt;style&gt;body &#123; visibility: hidden; &#125; .n &#123; visibility: visible; position: absolute; padding: 0 1ex 0 1ex; margin: 0; top: 0; left: 0; &#125; h1 &#123; margin-top: 0.4ex; margin-bottom: 0.8ex; &#125;&lt;/style&gt;&lt;div class=n&gt;&lt;h1&gt;&lt;i&gt;This image is a page.&lt;/i&gt;&lt;/h1&gt;Just open it in new tab.&lt;p&gt;&lt;img src="#" style="border: 1px solid crimson"&gt;&lt;!--'</span>,</span><br><span class="line">    <span class="string">'lena.html'</span>);</span><br></pre></td></tr></table></figure><h2 id="è¿™å¼ å›¾ç‰‡æ˜¯ä¸€ä¸ªç½‘é¡µï¼Œä¸ä¿¡ä½ å°±åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å®ƒ"><a href="#è¿™å¼ å›¾ç‰‡æ˜¯ä¸€ä¸ªç½‘é¡µï¼Œä¸ä¿¡ä½ å°±åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å®ƒ" class="headerlink" title="è¿™å¼ å›¾ç‰‡æ˜¯ä¸€ä¸ªç½‘é¡µï¼Œä¸ä¿¡ä½ å°±åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å®ƒ"></a>è¿™å¼ å›¾ç‰‡æ˜¯ä¸€ä¸ªç½‘é¡µï¼Œä¸ä¿¡ä½ å°±åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å®ƒ</h2><p><a href="https://breeze2.github.io/blog/practice-embed-html-in-jpeg4.html" target="_blank"><img src="/blog/practice-embed-html-in-jpeg4.html" alt="Lena"></a></p><h2 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h2><p>å°†ä¸€æ®µHTMLæ–‡æœ¬åµŒå…¥åˆ°ä¸€å¼ å›¾ç‰‡ä¸­ï¼Œå®é™…ä¸Šï¼Œè¿˜æ²¡ä»€ä¹ˆåº”ç”¨ï¼Œå“ˆå“ˆå“ˆğŸ˜‚ã€‚<br>å¦‚æœèƒ½å°†<code>JS</code>æˆ–<code>Shell</code>è„šæœ¬è—åœ¨å›¾ç‰‡ä¸­ï¼Œå¹¶èƒ½åæœŸæ‰§è¡Œï¼Œé‚£å°±æœ‰æ„æ€äº†ï¼›è€Œä¸”æœ¬èº«æ˜¯ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼Œå¯ä»¥é¿è¿‡ä¸€äº›å®‰å…¨è½¯ä»¶çš„æ£€æŸ¥ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘çœ‹åˆ°ä¸€ä¸ªæœ‰è¶£çš„ç½‘é¡µï¼š&lt;a href=&quot;http://lcamtuf.coredump.cx/squirrel/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://lcamtuf.coredump.cx/squirrel/&lt;/a&gt;ï¼Œæˆ–è€…è¯´ä¸€å¼ æœ‰è¶£çš„å›¾ç‰‡â€”â€”å› ä¸ºç”¨ç½‘ç»œæµè§ˆå™¨æ‰“å¼€å®ƒçœ‹åˆ°çš„æ˜¯ä¸€ä¸ªç½‘é¡µï¼Œç”¨å›¾ç‰‡æµè§ˆå™¨æ‰“å¼€å®ƒçœ‹åˆ°çš„åˆæ˜¯ä¸€å¼ å›¾ç‰‡ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;/blog/assets/images/practice-embed-html-in-jpeg1.jpg&quot; alt=&quot;æ¾é¼ è¿·&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="php" scheme="https://breeze2.github.io/blog/tags/php/"/>
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
      <category term="html" scheme="https://breeze2.github.io/blog/tags/html/"/>
    
      <category term="frontend" scheme="https://breeze2.github.io/blog/tags/frontend/"/>
    
      <category term="jpeg" scheme="https://breeze2.github.io/blog/tags/jpeg/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨Ubuntuä¸Šè¿è¡Œå¤šå®ä¾‹MySQL</title>
    <link href="https://breeze2.github.io/blog/mysql-run-multiple-instances-on-ubuntu.html"/>
    <id>https://breeze2.github.io/blog/mysql-run-multiple-instances-on-ubuntu.html</id>
    <published>2018-03-18T19:02:13.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯ä¸€å°æœåŠ¡å™¨ä¸»æœºè¿è¡Œä¸€ä¸ªMySQLå®ä¾‹ï¼›ä¸è¿‡åœ¨å•æœºé…ç½®éå¸¸é«˜çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘è¿è¡Œå¤šä¸ªMySQLå®ä¾‹ã€‚æ¯•ç«ŸMySQLæ˜¯å•è¿›ç¨‹ï¼ˆå¤šçº¿ç¨‹ï¼‰çš„è¿è¡Œæ¨¡å¼ï¼Œå•å®ä¾‹MySQLç”¨ä¸ä¸Šå¤ªå¤šèµ„æºã€‚</p><p>å½“ç„¶ï¼Œé«˜é…ç½®çš„å•æœºåº”è¯¥è€ƒè™‘ä½¿ç”¨<a href="https://www.docker.com/" target="_blank" rel="noopener">Docker</a>å®ç°å¤šMySQLæœåŠ¡ï¼Œåªæ˜¯è¿™é‡Œä»‹ç»ä¸€ä¸‹å¦‚ä½•è¿è¡Œå¤šå®ä¾‹MySQLã€‚æœ¬ä»¥ä¸ºåœ¨Ubuntuä¸Šå®ç°å¾ˆå®¹æ˜“ï¼ŒåŸæ¥ä¹Ÿå¹¶ä¸ç®€å•ã€‚</p><h2 id="è¿è¡Œç¯å¢ƒ"><a href="#è¿è¡Œç¯å¢ƒ" class="headerlink" title="è¿è¡Œç¯å¢ƒ"></a>è¿è¡Œç¯å¢ƒ</h2><ul><li>Ubuntu 16.04</li><li>MySQL 5.17</li></ul><a id="more"></a><h2 id="mysqld-multi"><a href="#mysqld-multi" class="headerlink" title="mysqld_multi"></a>mysqld_multi</h2><p>åœ¨å®‰è£…å¥½MySQL Serveråï¼Œåº”è¯¥æ˜¯å¯ä»¥ä½¿ç”¨<code>mysqld_multi</code>çš„ã€‚<br>æŸ¥çœ‹é…ç½®ç¤ºä¾‹å‘½ä»¤ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ mysqld_multi --example</span><br><span class="line">[mysqld_multi]</span><br><span class="line">mysqld     = /usr/bin/mysqld_safe</span><br><span class="line">mysqladmin = /usr/bin/mysqladmin</span><br><span class="line">user       = multi_admin</span><br><span class="line">password   = my_password</span><br><span class="line"></span><br><span class="line">[mysqld2]</span><br><span class="line">socket     = /tmp/mysql.sock2</span><br><span class="line">port       = <span class="number">3307</span></span><br><span class="line">pid-file   = /var/lib/mysql2/hostname.pid2</span><br><span class="line">datadir    = /var/lib/mysql2</span><br><span class="line">language   = /usr/share/mysql/mysql/english</span><br><span class="line">user       = unix_user1</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬MySQLçš„é…ç½®æ–‡ä»¶æ˜¯<code>/etc/mysql/my.cnf</code>æˆ–è€…<code>/etc/mysql/mysql.cnf</code>ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­æœ€å¼€å§‹çš„åœ°æ–¹æ·»åŠ ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld_multi]</span><br><span class="line">mysqld     = /usr/bin/mysqld_safe</span><br><span class="line">mysqladmin = /usr/bin/mysqladmin</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰<code>mysqld_multi</code>çŠ¶æ€ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mysqld_multi report                               </span><br><span class="line">Reporting MySQL servers</span><br><span class="line">No groups to be reported (check your GNRs)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰æœåŠ¡ç»„ç¾¤ï¼Œç°åœ¨æ·»åŠ ä¸€ä¸ªâ€”â€”åœ¨MySQLçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿½åŠ ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysqld3307]</span><br><span class="line">socket     = /tmp/mysqld/mysqld3307.sock</span><br><span class="line">port       = 3307</span><br><span class="line">pid-file   = /tmp/mysqld/mysqld3307.pid</span><br><span class="line">datadir    = /var/lib/mysql/multi/data3307</span><br><span class="line">user       = mysql</span><br></pre></td></tr></table></figure><p>å†æŸ¥çœ‹å½“å‰<code>mysqld_multi</code>çŠ¶æ€ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mysqld_multi report                               </span><br><span class="line">Reporting MySQL servers</span><br><span class="line">MySQL server from group: mysqld3307 is not running</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœåŠ¡ç»„ç¾¤<code>mysqld3307</code>ï¼ˆæ³¨æ„æ¯ä¸ªæœåŠ¡ç»„ç¾¤åç§°å¿…é¡»ä»¥<code>mysqld</code>å¼€å¤´ï¼‰æ²¡æœ‰åœ¨è¿è¡Œã€‚ç°åœ¨è¿˜ä¸èƒ½ç›´æ¥è¿è¡Œ<code>mysqld3307</code>æœåŠ¡ï¼Œå› ä¸ºæ²¡æœ‰åˆå§‹åŒ–æ•°æ®ç›®å½•<code>/var/lib/mysql/multi/data3307</code>ã€‚</p><h2 id="åˆå§‹åŒ–æ•°æ®åº“"><a href="#åˆå§‹åŒ–æ•°æ®åº“" class="headerlink" title="åˆå§‹åŒ–æ•°æ®åº“"></a>åˆå§‹åŒ–æ•°æ®åº“</h2><blockquote><p>è¿‡å»MySQLåˆå§‹åŒ–æ•°æ®åº“ä½¿ç”¨çš„æ˜¯<code>mysql_install_db</code>å‘½ä»¤ï¼Œç°åœ¨æ˜¯<code>mysqld --initialize</code>ã€‚</p></blockquote><p>åœ¨Ubuntuç³»ç»Ÿä¸Šæœ‰ä¸€ä¸ªç³»ç»Ÿå®‰å…¨ç¨‹åºï¼Œå«AppArmorï¼Œå®ƒä¼šé™åˆ¶å„ä¸ªåº”ç”¨ç¨‹åºè®¿é—®ç³»ç»Ÿèµ„æºçš„æƒé™ã€‚Rootç”¨æˆ·è¿è¡Œç¨‹åºæ—¶ä¹Ÿç¢°åˆ°æƒé™ä¸è¶³é”™è¯¯çš„è¯ï¼Œé‚£ä¹ˆåº”è¯¥å°±æ˜¯AppArmoré™åˆ¶äº†ã€‚æ¯”å¦‚æˆ‘ä»¬éœ€è¦ä¿®æ”¹<code>mysqld</code>çš„æƒé™ï¼Œå°±å¾—ç¼–è¾‘å¯¹åº”çš„AppArmoré…ç½®æ–‡ä»¶ï¼Œç„¶åé‡å¯AppArmoræœåŠ¡ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vi /etc/apparmor.d/usr.sbin.mysqld</span><br><span class="line">$ sudo service apparmor restart</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æœåŠ¡ç»„ç¾¤<code>mysqld3307</code>çš„é…ç½®ä¸­ç”¨åˆ°çš„ç›®å½•æ˜¯<code>/tmp/mysqld</code>å’Œ<code>/var/lib/mysql/multi</code>ï¼Œ<code>mysqld</code>ç¨‹åºå¯¹<code>/tmp</code>å’Œ<code>/var/lib/mysql</code>éƒ½æ˜¯å…·æœ‰è¯»å†™æƒé™çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦ä¿®æ”¹AppArmoré…ç½®æ–‡ä»¶ã€‚</p><p>ç°åœ¨æ¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„æ•°æ®åº“ç›®å½•<code>/var/lib/mysql/multi/data3307</code>ï¼ˆä»¥mysqlç”¨æˆ·èº«ä»½æ‰§è¡Œï¼‰ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u mysql <span class="built_in">mkdir</span> /tmp/mysqld</span><br><span class="line">$ sudo -u mysql <span class="built_in">mkdir</span> /var/lib/mysql/multi</span><br><span class="line">$ sudo -u mysql mysqld --initialize --user=mysql --datadir=/var/lib/mysql/multi/data3307</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–æˆåŠŸåï¼Œæ–°æ•°æ®åº“ä¼šè‡ªåŠ¨å»ºç«‹rootç”¨æˆ·ï¼Œå¹¶éšæœºç”Ÿæˆå¯†ç ï¼Œè¿™äº›ä¼šè®°å½•åœ¨MySQLæ—¥å¿—ä¸­ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tail /var/log/mysql/error.log</span><br><span class="line"><span class="number">2018</span>-<span class="number">03</span>-<span class="number">18</span>T12:<span class="number">15</span>:<span class="number">25</span>.<span class="number">378684</span>Z <span class="number">0</span> [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation <span class="keyword">for</span> <span class="built_in">more</span> details).</span><br><span class="line"><span class="number">2018</span>-<span class="number">03</span>-<span class="number">18</span>T12:<span class="number">15</span>:<span class="number">26</span>.<span class="number">642564</span>Z <span class="number">0</span> [Warning] InnoDB: New log files created, LSN=<span class="number">45790</span></span><br><span class="line"><span class="number">2018</span>-<span class="number">03</span>-<span class="number">18</span>T12:<span class="number">15</span>:<span class="number">26</span>.<span class="number">900383</span>Z <span class="number">0</span> [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line"><span class="number">2018</span>-<span class="number">03</span>-<span class="number">18</span>T12:<span class="number">15</span>:<span class="number">26</span>.<span class="number">986706</span>Z <span class="number">0</span> [Warning] No existing UUID has been found, so we assume that this is the first <span class="built_in">time</span> that this server has been started. Generating a new UUID: <span class="number">3544</span>d1ec-<span class="number">2</span>b6f-<span class="number">11</span>e8-bf0a-aaaa0007ba64.</span><br><span class="line"><span class="number">2018</span>-<span class="number">03</span>-<span class="number">18</span>T12:<span class="number">15</span>:<span class="number">26</span>.<span class="number">998294</span>Z <span class="number">0</span> [Warning] Gtid table is <span class="keyword">not</span> ready to be used. Table 'mysql.gtid_executed' cannot be opened.</span><br><span class="line"><span class="number">2018</span>-<span class="number">03</span>-<span class="number">18</span>T12:<span class="number">15</span>:<span class="number">26</span>.<span class="number">998765</span>Z <span class="number">1</span> [Note] A temporary password is generated <span class="keyword">for</span> root@localhost: <span class="number">4</span>kDUVrlO&gt;zT)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆè®°ä½å¯†ç <code>4kDUVrlO&gt;zT)</code>ã€‚</p><h2 id="å¯åŠ¨æ–°å®ä¾‹"><a href="#å¯åŠ¨æ–°å®ä¾‹" class="headerlink" title="å¯åŠ¨æ–°å®ä¾‹"></a>å¯åŠ¨æ–°å®ä¾‹</h2><p>æ‰§è¡Œä¸€ä¸‹å‘½ä»¤å³å¯ä»¥mysqlç”¨æˆ·èº«ä»½å¯åŠ¨æœåŠ¡ç»„ç¾¤<code>mysqld3307</code>ï¼ˆä¸éœ€è¦å‰ç¼€<code>mysqld</code>ï¼‰ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u mysql mysqld_multi <span class="built_in">start</span> <span class="number">3307</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰<code>mysqld_multi</code>çŠ¶æ€ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mysqld_multi report                               </span><br><span class="line">Reporting MySQL servers</span><br><span class="line">MySQL server from group: mysqld3307 is running</span><br></pre></td></tr></table></figure><p>é‡ç½®ä¸€ä¸‹å¯†ç ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mysqladmin -uroot -h <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -P <span class="number">3307</span> -p'<span class="number">4</span>kDUVrlO&gt;zT)' password</span><br><span class="line">New password:</span><br><span class="line">Confirm new password:</span><br></pre></td></tr></table></figure><p>è¿æ¥æœåŠ¡ç»„ç¾¤<code>mysqld3307</code>ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -uroot -h <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -P <span class="number">3307</span> -p</span><br></pre></td></tr></table></figure><h2 id="å…³é—­å®ä¾‹"><a href="#å…³é—­å®ä¾‹" class="headerlink" title="å…³é—­å®ä¾‹"></a>å…³é—­å®ä¾‹</h2><p>åŸä»¥ä¸ºå…³é—­æœåŠ¡ç»„ç¾¤<code>mysqld3307</code>ï¼Œåªéœ€è¦ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u mysql mysqld_multi stop <span class="number">3307</span></span><br></pre></td></tr></table></figure><p>ç»“æœæŸ¥çœ‹<code>mysqld_multi</code>çŠ¶æ€ï¼Œ<code>mysqld3307</code>ä¾ç„¶æ˜¯è¿è¡Œä¸­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mysqld_multi report                               </span><br><span class="line">Reporting MySQL servers</span><br><span class="line">MySQL server from group: mysqld3307 is running</span><br></pre></td></tr></table></figure><blockquote><p>å¯èƒ½æ˜¯å› ä¸º<code>mysqld3307</code>æ•°æ®åº“ä¸­æ²¡æœ‰ä¸<code>mysqld_multi</code>é…ç½®å¯¹åº”çš„ç”¨æˆ·ï¼Œæ‰€ä»¥<code>mysqld_multi stop</code>å‘½ä»¤æ²¡èƒ½å…³é—­<code>mysqld3307</code>ã€‚</p></blockquote><p>æˆ‘ä»¬å¯ä»¥ç”¨<code>mysqladmin</code>å‘½ä»¤æ¥å…³é—­æœåŠ¡ç»„ç¾¤<code>mysqld3307</code>ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysqladmin -uroot -h <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -P <span class="number">3307</span> -p shutdown</span><br></pre></td></tr></table></figure><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>è¿™é‡Œåªä»‹ç»äº†ç›‘å¬3307ç«¯å£çš„MySQLå®ä¾‹çš„å»ºç«‹è¿‡ç¨‹ï¼Œå…¶ä»–æ›´å¤šMySQLå®ä¾‹ï¼Œå¦‚ç›‘å¬3308ã€3309ç«¯å£ï¼Œåªéœ€æŒ‰ç…§ä¸Šè¿°æµç¨‹ï¼ˆæ·»åŠ é…ç½®ï¼Œåˆå§‹åŒ–æ•°æ®ç›®å½•ï¼Œå¯åŠ¨æœåŠ¡ï¼‰æ‰§è¡Œå³å¯ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯ä¸€å°æœåŠ¡å™¨ä¸»æœºè¿è¡Œä¸€ä¸ªMySQLå®ä¾‹ï¼›ä¸è¿‡åœ¨å•æœºé…ç½®éå¸¸é«˜çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘è¿è¡Œå¤šä¸ªMySQLå®ä¾‹ã€‚æ¯•ç«ŸMySQLæ˜¯å•è¿›ç¨‹ï¼ˆå¤šçº¿ç¨‹ï¼‰çš„è¿è¡Œæ¨¡å¼ï¼Œå•å®ä¾‹MySQLç”¨ä¸ä¸Šå¤ªå¤šèµ„æºã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼Œé«˜é…ç½®çš„å•æœºåº”è¯¥è€ƒè™‘ä½¿ç”¨&lt;a href=&quot;https://www.docker.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Docker&lt;/a&gt;å®ç°å¤šMySQLæœåŠ¡ï¼Œåªæ˜¯è¿™é‡Œä»‹ç»ä¸€ä¸‹å¦‚ä½•è¿è¡Œå¤šå®ä¾‹MySQLã€‚æœ¬ä»¥ä¸ºåœ¨Ubuntuä¸Šå®ç°å¾ˆå®¹æ˜“ï¼ŒåŸæ¥ä¹Ÿå¹¶ä¸ç®€å•ã€‚&lt;/p&gt;
&lt;h2 id=&quot;è¿è¡Œç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#è¿è¡Œç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;è¿è¡Œç¯å¢ƒ&quot;&gt;&lt;/a&gt;è¿è¡Œç¯å¢ƒ&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Ubuntu 16.04&lt;/li&gt;
&lt;li&gt;MySQL 5.17&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="èº¬è¡Œ" scheme="https://breeze2.github.io/blog/categories/%E8%BA%AC%E8%A1%8C/"/>
    
    
      <category term="mysql" scheme="https://breeze2.github.io/blog/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€äº›æœ‰è¶£çš„MySQLæŸ¥è¯¢é—®é¢˜</title>
    <link href="https://breeze2.github.io/blog/note-mysql-in-leetcode.html"/>
    <id>https://breeze2.github.io/blog/note-mysql-in-leetcode.html</id>
    <published>2018-03-02T10:02:13.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨<a href="https://leetcode.com/" target="_blank" rel="noopener">LeetCode</a>ä¸Šæœ‰ä¸€äº›æœ‰è¶£çš„MySQLæŸ¥è¯¢é—®é¢˜ï¼Œè¿™é‡Œè®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿ä»¥åæŸ¥é˜…ã€‚</p></blockquote><a id="more"></a><h2 id="Department-Top-Three-Salaries"><a href="#Department-Top-Three-Salaries" class="headerlink" title="Department Top Three Salaries"></a>Department Top Three Salaries</h2><p>éƒ¨é—¨å‰ä¸‰è–ªèµ„é—®é¢˜ï¼šæŸ¥è¯¢å„ä¸ªéƒ¨é—¨è–ªèµ„å‰ä¸‰çš„å‘˜å·¥ï¼ˆè–ªèµ„ï¼‰ï¼Œå¹¶åˆ—æ’ååªå ä¸€ä½ã€‚</p><h3 id="åŸé¢˜"><a href="#åŸé¢˜" class="headerlink" title="åŸé¢˜"></a>åŸé¢˜</h3><p>The Employee table holds all employees. Every employee has an Id, and there is also a column for the department Id.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">----+-------+--------+--------------+</span></span><br><span class="line">| Id | Name  | Salary | DepartmentId |</span><br><span class="line">+<span class="comment">----+-------+--------+--------------+</span></span><br><span class="line">| 1  | Joe   | 70000  | 1            |</span><br><span class="line">| 2  | Henry | 80000  | 2            |</span><br><span class="line">| 3  | Sam   | 60000  | 2            |</span><br><span class="line">| 4  | Max   | 90000  | 1            |</span><br><span class="line">| 5  | Janet | 69000  | 1            |</span><br><span class="line">| 6  | Randy | 85000  | 1            |</span><br><span class="line">+<span class="comment">----+-------+--------+--------------+</span></span><br></pre></td></tr></table></figure><p>The Department table holds all departments of the company.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| Id | Name     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| 1  | IT       |</span><br><span class="line">| 2  | Sales    |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br></pre></td></tr></table></figure><p>Write a SQL query to find employees who earn the top three salaries in each of the department. For the above tables, your SQL query should return the following rows.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+------------+----------+--------+</span><br><span class="line">| Department | Employee | Salary |</span><br><span class="line">+------------+----------+--------+</span><br><span class="line">| IT         | Max      | 90000  |</span><br><span class="line">| IT         | Randy    | 85000  |</span><br><span class="line">| IT         | Joe      | 70000  |</span><br><span class="line">| Sales      | Henry    | 80000  |</span><br><span class="line">| Sales      | Sam      | 60000  |</span><br><span class="line">+------------+----------+--------+</span><br></pre></td></tr></table></figure><h3 id="ç­”æ¡ˆ"><a href="#ç­”æ¡ˆ" class="headerlink" title="ç­”æ¡ˆ"></a>ç­”æ¡ˆ</h3><p>å…ˆè¯´ç­”æ¡ˆï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dep.Name <span class="keyword">as</span> <span class="string">"Department"</span>, emp.Name <span class="keyword">as</span> <span class="string">"Employee"</span>, emp.Salary <span class="keyword">as</span> <span class="string">"Salary"</span></span><br><span class="line"><span class="keyword">from</span> Department <span class="keyword">as</span> dep <span class="keyword">join</span> Employee <span class="keyword">as</span> emp <span class="keyword">on</span> dep.Id = emp.DepartmentId</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="string">'x'</span> <span class="keyword">from</span> Employee <span class="keyword">as</span> emp1</span><br><span class="line">    <span class="keyword">where</span> emp1.Salary &gt; emp.Salary <span class="keyword">and</span> emp1.DepartmentId = emp.DepartmentId <span class="keyword">having</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> emp1.Salary) &lt; <span class="number">3</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆDepartmentå’ŒEmployeeè”æ¥æ˜¯ä¸å¯å°‘çš„ï¼Œå› ä¸ºç»“æœåŒ…å«ä¸¤å¼ è¡¨çš„å­—æ®µï¼›å†ç”¨å­æŸ¥è¯¢ï¼ˆexistsï¼‰ï¼Œä¿ç•™åŒéƒ¨é—¨å†…é«˜äºæœ¬èº«è–ªèµ„çš„ä¸è¶…è¿‡ä¸‰ä¸ªçš„å‘˜å·¥ï¼ˆhavingï¼‰ï¼Œå¹¶åˆ—æ’ååªå ä¸€ä½ï¼Œéœ€è¦å»é‡ï¼ˆdistinctï¼‰ã€‚</p><p>æ³¨æ„ï¼šä»¥ä¸Š<code>&#39;x&#39;</code>å¹¶æ— ç‰¹æ®Šæ„ä¹‰ï¼Œåªæ˜¯æœ‰å€¼æ—¶è¡¨ç¤ºå­˜åœ¨ï¼Œæ— å€¼æ—¶è¡¨ç¤ºä¸å­˜åœ¨ã€‚ï¼›<code>having</code>åº”è¯¥é…åˆ<code>group by</code>ä½¿ç”¨ï¼Œå•ç‹¬ä½¿ç”¨<code>having</code>æ—¶è§†å½“å‰æ•°æ®ä¸ºä¸€ç»„ï¼›<code>count()</code>å‡½æ•°ä¹Ÿæ˜¯ï¼Œå•ç‹¬ä½¿ç”¨<code>having</code>æ—¶ä¹Ÿç›¸å½“äºç»™å½“å‰æ•°æ®åˆ†æˆä¸€ç»„ã€‚</p><p>å¦å¤–ï¼šåªç”¨ä¸€ä¸ª<code>select</code>ï¼ˆæ²¡æœ‰å­æŸ¥è¯¢ï¼‰ä¹Ÿèƒ½å®ç°ï¼Œå°±æ˜¯å°†Employeeå’Œè‡ªèº«<code>join</code>ï¼Œ<code>on</code>è–ªèµ„æ¯”è‡ªå·±é«˜çš„å‘˜å·¥ï¼›ç„¶åç”¨<code>group by</code>å»é‡ï¼Œå†ç»“åˆ<code>having count(distinct emp1.Salary) &lt; 3</code>ï¼Œä¿ç•™æœ‰æ•ˆç»“æœã€‚è¿™ä¸ª<code>join</code>æ–¹æ³•æ•ˆç‡è¿œä½äºä¸Šé¢å­æŸ¥è¯¢æ–¹æ³•ï¼Œæ‰€ä»¥ä¸è¦å¯¹å­æŸ¥è¯¢æœ‰åè§ã€‚</p><h2 id="Human-Traffic-of-Stadium"><a href="#Human-Traffic-of-Stadium" class="headerlink" title="Human Traffic of Stadium"></a>Human Traffic of Stadium</h2><p>è¿ç»­è¾¾æ ‡é—®é¢˜ï¼šæŸ¥è¯¢è¿ç»­3å¤©ä½“è‚²é¦†äººæ•°é«˜äº100çš„æ—¥æœŸã€‚</p><h3 id="åŸé¢˜-1"><a href="#åŸé¢˜-1" class="headerlink" title="åŸé¢˜"></a>åŸé¢˜</h3><p>X city built a new stadium, each day many people visit it and the stats are saved as these columns: id, date, people<br>Please write a query to display the records which have 3 or more consecutive rows and the amount of people more than 100(inclusive).<br>For example, the table stadium:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------+------------+-----------+</span></span><br><span class="line">| id   | date       | people    |</span><br><span class="line">+<span class="comment">------+------------+-----------+</span></span><br><span class="line">| 1    | 2017-01-01 | 10        |</span><br><span class="line">| 2    | 2017-01-02 | 109       |</span><br><span class="line">| 3    | 2017-01-03 | 150       |</span><br><span class="line">| 4    | 2017-01-04 | 99        |</span><br><span class="line">| 5    | 2017-01-05 | 145       |</span><br><span class="line">| 6    | 2017-01-06 | 1455      |</span><br><span class="line">| 7    | 2017-01-07 | 199       |</span><br><span class="line">| 8    | 2017-01-08 | 188       |</span><br><span class="line">+<span class="comment">------+------------+-----------+</span></span><br></pre></td></tr></table></figure><p>For the sample data above, the output is:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------+------------+-----------+</span></span><br><span class="line">| id   | date       | people    |</span><br><span class="line">+<span class="comment">------+------------+-----------+</span></span><br><span class="line">| 5    | 2017-01-05 | 145       |</span><br><span class="line">| 6    | 2017-01-06 | 1455      |</span><br><span class="line">| 7    | 2017-01-07 | 199       |</span><br><span class="line">| 8    | 2017-01-08 | 188       |</span><br><span class="line">+<span class="comment">------+------------+-----------+</span></span><br></pre></td></tr></table></figure><p>Note:<br>Each day only have one row record, and the dates are increasing with id increasing.</p><h3 id="ç­”æ¡ˆ-1"><a href="#ç­”æ¡ˆ-1" class="headerlink" title="ç­”æ¡ˆ"></a>ç­”æ¡ˆ</h3><p>æ€è·¯æ˜¯å…ˆæ‰¾å‡ºäººæ•°å¤§äº100çš„æ—¥æœŸï¼Œç„¶ååœ¨è¿™äº›æ—¥æœŸé™„è¿‘å†æ‰¾æ•°å¤§äº100çš„æ—¥æœŸï¼Œä¿ç•™èƒ½å¤Ÿå½¢æˆè¿ç»­3å¤©çš„æ—¥æœŸã€‚<br>æç¤ºé‡Œè¯´è¡¨ä¸­æ¯ä¸€å¤©éƒ½æœ‰ä¸€æ¡è®°å½•ï¼Œè€Œä¸”æ—¥æœŸæ˜¯éšidé€’å¢ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®¡ç®—idï¼Œè€Œä¸æ˜¯æ—¥æœŸã€‚<br>ç”¨å­æŸ¥è¯¢çš„æ–¹æ³•ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.id, s.date, s.people </span><br><span class="line"><span class="keyword">from</span> stadium <span class="keyword">as</span> s </span><br><span class="line"><span class="keyword">where</span> s.people &gt;= <span class="number">100</span> <span class="keyword">and</span> <span class="keyword">exists</span>(<span class="keyword">select</span> <span class="string">'x'</span></span><br><span class="line">    <span class="keyword">from</span> stadium <span class="keyword">as</span> s1</span><br><span class="line">    <span class="keyword">where</span> s1.people &gt;= <span class="number">100</span></span><br><span class="line">        <span class="keyword">and</span> s1.id &gt;= s.id<span class="number">-2</span></span><br><span class="line">        <span class="keyword">and</span> s1.id &lt;= s.id+<span class="number">2</span></span><br><span class="line">        <span class="keyword">and</span> s1.id&lt;&gt;s.id</span><br><span class="line">    <span class="keyword">having</span> <span class="keyword">count</span>(s1.id) &gt; <span class="number">2</span></span><br><span class="line">        <span class="keyword">or</span> (<span class="keyword">count</span>(s1.id) = <span class="number">2</span> </span><br><span class="line">            <span class="keyword">and</span> (<span class="keyword">sum</span>(s1.id-s.id) <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">-1</span>,<span class="number">1</span>) <span class="keyword">and</span> <span class="keyword">sum</span>(<span class="keyword">abs</span>(s1.id-s.id)) &lt;&gt; <span class="number">4</span>)</span><br><span class="line">        )</span><br><span class="line">    );</span><br></pre></td></tr></table></figure><p>åœ¨å½“å‰æ—¥æœŸçš„å‰2å¤©å’Œå2å¤©æ‰¾ï¼Œæ‰¾åˆ°äººæ•°å¤§äº100çš„æ—¥æœŸä¸ªæ•°å¤§äº2çš„è¯ï¼Œé‚£ä¹ˆå½“å‰æ—¥æœŸå¿…å®šå¯ä»¥å½¢æˆè¿ç»­3å¤©äººæ•°å¤§äº100ï¼›æ‰¾åˆ°äººæ•°å¤§äº100çš„æ—¥æœŸä¸ªæ•°ç­‰äº2ï¼Œä¸”è¿™ä¸¤ä¸ªæ—¥æœŸä¸å½“å‰æ—¥æœŸçš„è·ç¦»å’Œä¸æ˜¯1æˆ–-1ï¼Œç»å¯¹è·ç¦»å’Œä¸æ˜¯4çš„è¯ï¼Œé‚£ä¹ˆå½“å‰æ—¥æœŸä¹Ÿæ˜¯å¯ä»¥å½¢æˆè¿ç»­3å¤©äººæ•°å¤§äº100ï¼›å…¶ä»–æƒ…å†µéƒ½ä¸è¡Œã€‚</p><p>ç”¨<code>join</code>çš„æ–¹æ³•ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> t1.*</span><br><span class="line"><span class="keyword">from</span> stadium t1, stadium t2, stadium t3</span><br><span class="line"><span class="keyword">where</span> t1.people &gt;= <span class="number">100</span> <span class="keyword">and</span> t2.people &gt;= <span class="number">100</span> <span class="keyword">and</span> t3.people &gt;= <span class="number">100</span></span><br><span class="line">    <span class="keyword">and</span> ( (t1.id - t2.id = <span class="number">1</span> <span class="keyword">and</span> t1.id - t3.id = <span class="number">2</span> <span class="keyword">and</span> t2.id - t3.id =<span class="number">1</span>) <span class="comment">-- t1, t2, t3</span></span><br><span class="line">        <span class="keyword">or</span> (t2.id - t1.id = <span class="number">1</span> <span class="keyword">and</span> t2.id - t3.id = <span class="number">2</span> <span class="keyword">and</span> t1.id - t3.id =<span class="number">1</span>) <span class="comment">-- t2, t1, t3</span></span><br><span class="line">        <span class="keyword">or</span> (t3.id - t2.id = <span class="number">1</span> <span class="keyword">and</span> t2.id - t1.id =<span class="number">1</span> <span class="keyword">and</span> t3.id - t1.id = <span class="number">2</span>) <span class="comment">-- t3, t2, t1</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> t1.id;</span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œä¸Šé¢çš„å­æŸ¥è¯¢æ–¹æ³•ä¾ç„¶æ¯”è¿™ä¸ªjoinæ–¹æ³•æ•ˆç‡é«˜ã€‚</p><h2 id="Trips-and-Users"><a href="#Trips-and-Users" class="headerlink" title="Trips and Users"></a>Trips and Users</h2><h3 id="åŸé¢˜-2"><a href="#åŸé¢˜-2" class="headerlink" title="åŸé¢˜"></a>åŸé¢˜</h3><p>ç”¨æˆ·å–æ¶ˆå«è½¦æœåŠ¡é—®é¢˜ï¼šç»Ÿè®¡ä¸€ä¸ªæ—¶é—´æ®µå†…æ¯å¤©ç”¨æˆ·å–æ¶ˆå«è½¦æœåŠ¡å æ‰€æœ‰å«è½¦æœåŠ¡çš„æ¯”ä¾‹ã€‚<br>The Trips table holds all taxi trips. Each trip has a unique Id, while Client_Id and Driver_Id are both foreign keys to the Users_Id at the Users table. Status is an ENUM type of (â€˜completedâ€™, â€˜cancelled_by_driverâ€™, â€˜cancelled_by_clientâ€™).</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">----+-----------+-----------+---------+--------------------+----------+</span></span><br><span class="line">| Id | Client_Id | Driver_Id | City_Id |        Status      |Request_at|</span><br><span class="line">+<span class="comment">----+-----------+-----------+---------+--------------------+----------+</span></span><br><span class="line">| 1  |     1     |    10     |    1    |     completed      |2013-10-01|</span><br><span class="line">| 2  |     2     |    11     |    1    | cancelled_by_driver|2013-10-01|</span><br><span class="line">| 3  |     3     |    12     |    6    |     completed      |2013-10-01|</span><br><span class="line">| 4  |     4     |    13     |    6    | cancelled_by_client|2013-10-01|</span><br><span class="line">| 5  |     1     |    10     |    1    |     completed      |2013-10-02|</span><br><span class="line">| 6  |     2     |    11     |    6    |     completed      |2013-10-02|</span><br><span class="line">| 7  |     3     |    12     |    6    |     completed      |2013-10-02|</span><br><span class="line">| 8  |     2     |    12     |    12   |     completed      |2013-10-03|</span><br><span class="line">| 9  |     3     |    10     |    12   |     completed      |2013-10-03| </span><br><span class="line">| 10 |     4     |    13     |    12   | cancelled_by_driver|2013-10-03|</span><br><span class="line">+<span class="comment">----+-----------+-----------+---------+--------------------+----------+</span></span><br></pre></td></tr></table></figure><p>The Users table holds all users. Each user has an unique Users_Id, and Role is an ENUM type of (â€˜clientâ€™, â€˜driverâ€™, â€˜partnerâ€™).</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">----------+--------+--------+</span></span><br><span class="line">| Users_Id | Banned |  Role  |</span><br><span class="line">+<span class="comment">----------+--------+--------+</span></span><br><span class="line">|    1     |   No   | client |</span><br><span class="line">|    2     |   Yes  | client |</span><br><span class="line">|    3     |   No   | client |</span><br><span class="line">|    4     |   No   | client |</span><br><span class="line">|    10    |   No   | driver |</span><br><span class="line">|    11    |   No   | driver |</span><br><span class="line">|    12    |   No   | driver |</span><br><span class="line">|    13    |   No   | driver |</span><br><span class="line">+<span class="comment">----------+--------+--------+</span></span><br></pre></td></tr></table></figure><p>Write a SQL query to find the cancellation rate of requests made by unbanned clients between Oct 1, 2013 and Oct 3, 2013. For the above tables, your SQL query should return the following rows with the cancellation rate being rounded to two decimal places.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">------------+-------------------+</span></span><br><span class="line">|     Day    | Cancellation Rate |</span><br><span class="line">+<span class="comment">------------+-------------------+</span></span><br><span class="line">| 2013-10-01 |       0.33        |</span><br><span class="line">| 2013-10-02 |       0.00        |</span><br><span class="line">| 2013-10-03 |       0.50        |</span><br><span class="line">+<span class="comment">------------+-------------------+</span></span><br></pre></td></tr></table></figure><h3 id="ç­”æ¡ˆ-2"><a href="#ç­”æ¡ˆ-2" class="headerlink" title="ç­”æ¡ˆ"></a>ç­”æ¡ˆ</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> Request_at <span class="keyword">as</span> <span class="string">"Day"</span>, <span class="keyword">round</span>(<span class="number">1</span>-<span class="keyword">sum</span>(t.Status=<span class="string">"completed"</span>)/<span class="keyword">count</span>(t.id), <span class="number">2</span>) <span class="keyword">as</span> <span class="string">"Cancellation Rate"</span></span><br><span class="line"><span class="keyword">from</span> Trips <span class="keyword">as</span> t <span class="keyword">join</span> <span class="keyword">users</span> <span class="keyword">as</span> u <span class="keyword">on</span> u.Users_Id = t.Client_Id <span class="keyword">and</span> u.Banned = <span class="string">"No"</span></span><br><span class="line"><span class="keyword">where</span> t.Request_at &gt;=<span class="string">'2013-10-01'</span> <span class="keyword">and</span> t.Request_at&lt;=<span class="string">'2013-10-03'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t.Request_at;</span><br></pre></td></tr></table></figure><h2 id="Median-Employee-Salary"><a href="#Median-Employee-Salary" class="headerlink" title="Median Employee Salary"></a>Median Employee Salary</h2><h3 id="åŸé¢˜-3"><a href="#åŸé¢˜-3" class="headerlink" title="åŸé¢˜"></a>åŸé¢˜</h3><p>ä¸­ä½è–ªèµ„é—®é¢˜ï¼šæŸ¥è¯¢å„å®¶å…¬å¸ä¸­è–ªèµ„æ’ä¸­ä½çš„çš„å‘˜å·¥ï¼ˆè–ªèµ„ï¼‰ã€‚<br>The Employee table holds all employees. The employee table has three columns: Employee Id, Company Name, and Salary.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+--------+</span></span><br><span class="line">|Id   | Company    | Salary |</span><br><span class="line">+<span class="comment">-----+------------+--------+</span></span><br><span class="line">|1    | A          | 2341   |</span><br><span class="line">|2    | A          | 341    |</span><br><span class="line">|3    | A          | 15     |</span><br><span class="line">|4    | A          | 15314  |</span><br><span class="line">|5    | A          | 451    |</span><br><span class="line">|6    | A          | 513    |</span><br><span class="line">|7    | B          | 15     |</span><br><span class="line">|8    | B          | 13     |</span><br><span class="line">|9    | B          | 1154   |</span><br><span class="line">|10   | B          | 1345   |</span><br><span class="line">|11   | B          | 1221   |</span><br><span class="line">|12   | B          | 234    |</span><br><span class="line">|13   | C          | 2345   |</span><br><span class="line">|14   | C          | 2645   |</span><br><span class="line">|15   | C          | 2645   |</span><br><span class="line">|16   | C          | 2652   |</span><br><span class="line">|17   | C          | 65     |</span><br><span class="line">+<span class="comment">-----+------------+--------+</span></span><br></pre></td></tr></table></figure><p>Write a SQL query to find the median salary of each company. Bonus points if you can solve it without using any built-in SQL functions.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+--------+</span></span><br><span class="line">|Id   | Company    | Salary |</span><br><span class="line">+<span class="comment">-----+------------+--------+</span></span><br><span class="line">|5    | A          | 451    |</span><br><span class="line">|6    | A          | 513    |</span><br><span class="line">|12   | B          | 234    |</span><br><span class="line">|9    | B          | 1154   |</span><br><span class="line">|14   | C          | 2645   |</span><br><span class="line">+<span class="comment">-----+------------+--------+</span></span><br></pre></td></tr></table></figure><h3 id="ç­”æ¡ˆ-3"><a href="#ç­”æ¡ˆ-3" class="headerlink" title="ç­”æ¡ˆ"></a>ç­”æ¡ˆ</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> emp.Id, emp.Company, emp.Salary</span><br><span class="line"><span class="keyword">from</span> Employee <span class="keyword">as</span> emp</span><br><span class="line"><span class="keyword">join</span> (<span class="keyword">select</span> Company, <span class="keyword">count</span>(*) <span class="keyword">as</span> EmployeeNum <span class="keyword">from</span> Employee <span class="keyword">group</span> <span class="keyword">by</span> Company) <span class="keyword">as</span> emp1</span><br><span class="line"><span class="keyword">on</span> emp1.Company = emp.Company</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="string">'x'</span> <span class="keyword">from</span> Employee <span class="keyword">as</span> emp2</span><br><span class="line">    <span class="keyword">where</span> emp2.Company = emp.Company <span class="keyword">and</span> emp2.Salary &lt; emp.Salary</span><br><span class="line">    <span class="keyword">having</span> <span class="keyword">count</span>(emp2.Id) <span class="keyword">in</span> ( <span class="keyword">floor</span>((EmployeeNum<span class="number">-1</span>)/<span class="number">2</span>), <span class="keyword">floor</span>(EmployeeNum/<span class="number">2</span>) )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;åœ¨&lt;a href=&quot;https://leetcode.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;LeetCode&lt;/a&gt;ä¸Šæœ‰ä¸€äº›æœ‰è¶£çš„MySQLæŸ¥è¯¢é—®é¢˜ï¼Œè¿™é‡Œè®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿ä»¥åæŸ¥é˜…ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="ç¬”è®°" scheme="https://breeze2.github.io/blog/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="mysql" scheme="https://breeze2.github.io/blog/tags/mysql/"/>
    
      <category term="leetcode" scheme="https://breeze2.github.io/blog/tags/leetcode/"/>
    
  </entry>
  
  <entry>
    <title>Swoole+Lumenï¼šåŒæ­¥ç¼–ç¨‹é£æ ¼è°ƒç”¨MySQLå¼‚æ­¥æŸ¥è¯¢</title>
    <link href="https://breeze2.github.io/blog/swoole-lumen-asynchronous-mysql-query-with-synchronous-programming-style.html"/>
    <id>https://breeze2.github.io/blog/swoole-lumen-asynchronous-mysql-query-with-synchronous-programming-style.html</id>
    <published>2018-03-02T09:23:02.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ç½‘ç»œç¼–ç¨‹ä¸€ç›´æ˜¯PHPçš„çŸ­æ¿ï¼Œå°½ç®¡<a href="https://www.swoole.com/" target="_blank" rel="noopener">Swoole</a>æ‰©å±•å¼¥è¡¥äº†è¿™ä¸ªç¼ºé™·ï¼Œä½†æ˜¯å…¶ç¼–ç¨‹é£æ ¼åå‘äº†NodeJSæˆ–GoLangï¼Œä¸åŸæœ¬çš„åŒæ­¥ç¼–ç¨‹é£æ ¼è¿¥ç„¶ç›¸å¼‚ã€‚ç›®å‰PHPçš„å¤§éƒ¨åˆ†ä¸»æµåº”ç”¨æ¡†æ¶ä¾ç„¶æ˜¯åŒæ­¥ç¼–ç¨‹é£æ ¼ï¼Œæ‰€ä»¥ä¸€ç›´åœ¨æ¢ç´¢Swooleä¸åŒæ­¥ç¼–ç¨‹ç»“åˆçš„é€”å¾„ã€‚<br><a href="https://github.com/breeze2/lumen-swoole-http" target="_blank" rel="noopener">lumen-swoole-http</a>æ­£æ˜¯è¿æ¥åŒæ­¥ç¼–ç¨‹Lumenå’Œå¼‚æ­¥ç¼–ç¨‹Swooleçš„ä¸€åº§æ¡¥æ¢ï¼Œæœ‰å…´è¶£å¯ä»¥å…³æ³¨ä¸€ä¸‹ã€‚</p></blockquote><h2 id="LNMPçš„ä¸è¶³"><a href="#LNMPçš„ä¸è¶³" class="headerlink" title="LNMPçš„ä¸è¶³"></a>LNMPçš„ä¸è¶³</h2><p>LNMPæ˜¯ç»å…¸çš„Webåº”ç”¨æ¶æ„ç»„åˆï¼Œè™½ç„¶ï¼ˆLinuxã€NginXã€MySQLå’ŒPHP-FPMï¼‰å››è€…å„ç§æ˜¯ä¼˜ç§€çš„ç³»ç»Ÿæˆ–è½¯ä»¶ï¼Œä½†æ˜¯ç»„åˆåˆ°ä¸€èµ·çš„æ€»ä½“æ€§èƒ½å¹¶ä¸å°½äººæ„ï¼Œæ˜æ˜¾çš„ä¸æ˜¯<code>1+1+1+1&gt;4</code>ï¼Œè€Œæ˜¯<code>4+3+2+1&lt;1</code>ã€‚Linuxç³»ç»Ÿæ— å¯åšéï¼Œä¸»è¦é—®é¢˜å‡ºç°åœ¨ï¼š</p><h3 id="ä»NginXåˆ°PHP-FPM"><a href="#ä»NginXåˆ°PHP-FPM" class="headerlink" title="ä»NginXåˆ°PHP-FPM"></a>ä»NginXåˆ°PHP-FPM</h3><p>NginXåˆ©ç”¨IOå¤šè·¯å¤ç”¨æœºåˆ¶<a href="https://en.wikipedia.org/wiki/Epoll" target="_blank" rel="noopener">epoll</a>ï¼Œæå¤§åœ°å‡å°‘äº†IOé˜»å¡ç­‰å¾…ï¼Œå¯ä»¥è½»æ¾åº”å¯¹<a href="https://en.wikipedia.org/wiki/C10k_problem" target="_blank" rel="noopener">C10K</a>ã€‚å¯æ˜¯æ¯æ¬¡NginXå°†ç”¨æˆ·è¯·æ±‚ä¼ é€’ç»™PHP-FPMæ—¶ï¼ŒPHP-FPMæ€»æ˜¯éœ€è¦ä»æ–°åŠ è½½PHPé¡¹ç›®ä»£ç ï¼šåˆ›å»ºæ‰§è¡Œç¯å¢ƒï¼Œè¯»å–PHPæ–‡ä»¶å’Œä»£ç è§£æã€ç¼–è¯‘ç­‰æ“ä½œä¸€æ¬¡åˆä¸€æ¬¡çš„é‡å¤æ‰§è¡Œï¼Œé€ æˆä¸å°çš„æ¶ˆè€—ã€‚</p><h3 id="ä»PHP-FPMåˆ°MySQL"><a href="#ä»PHP-FPMåˆ°MySQL" class="headerlink" title="ä»PHP-FPMåˆ°MySQL"></a>ä»PHP-FPMåˆ°MySQL</h3><p>ç”±äºPHPä»£ç æœ¬èº«æ˜¯åŒæ­¥æ‰§è¡Œï¼ŒPHP-FPMè¿æ¥MySQLæŸ¥è¯¢æ•°æ®æ—¶ï¼Œåªèƒ½ç©ºé—²ç­‰å¾…MySQLè¿”å›æŸ¥è¯¢ç»“æœã€‚ä¸€ä¸ªæŸ¥è¯¢è¯­å¥æ‰§è¡Œæ—¶é—´å¯èƒ½ä¼šéœ€è¦å‡ ç§’é’Ÿï¼ŒæœŸé—´PHP-FPMè‹¥æ˜¯èƒ½æš‚æ—¶æ”¾ä¸‹å½“å‰ç”¨æˆ·æ…¢æŸ¥è¯¢è¯·æ±‚ï¼Œè€Œå»å¤„ç†å…¶ä»–ç”¨æˆ·è¯·æ±‚ï¼Œæ•ˆç‡å¿…ç„¶æœ‰æ‰€æé«˜ã€‚</p><a id="more"></a><h2 id="Swoole-HTTPæœåŠ¡å™¨"><a href="#Swoole-HTTPæœåŠ¡å™¨" class="headerlink" title="Swoole HTTPæœåŠ¡å™¨"></a>Swoole HTTPæœåŠ¡å™¨</h2><p><a href="https://wiki.swoole.com/wiki/page/326.html" target="_blank" rel="noopener">Swoole HTTPæœåŠ¡å™¨</a>ä¹Ÿé‡‡ç”¨äº†epollæœºåˆ¶ï¼Œè¿è¡Œæ€§èƒ½ä¸NginXç›¸æ¯”ï¼Œè™½ä¸åŠï¼ŒçŠ¹æœªè¿œã€‚ä¸è¿‡Swoole HTTPæœåŠ¡å™¨åµŒå…¥PHPä¸­ä½œä¸ºå…¶ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥ç›´æ¥è¿è¡ŒPHPï¼Œå®Œå…¨å¯ä»¥å–ä»£NginX + PHP-FPMç»„åˆã€‚</p><p>ä»¥ç›®å‰æµè¡Œçš„ä¸ºæ¡†æ¶<a href="https://lumen.laravel.com/" target="_blank" rel="noopener">Lumen</a>ï¼ˆLaravelçš„å­æ¡†æ¶ï¼‰ä¸ºä¾‹ï¼Œç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®ååˆ†ç®€å•ï¼Œåªéœ€è¦åœ¨<code>$worker-&gt;onRequest($request, $response)</code>ï¼ˆæ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼‰æ—¶å°†<code>$request</code>ä¼ ç»™Lumenå¤„ç†ï¼Œ<code>$response</code>å†å°†Lumençš„å¤„ç†ç»“æœè¿”å›ç»™ç”¨æˆ·ï¼Œè€Œä¸”<code>$worker</code>çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸé‡Œåªä¼šåŠ è½½ä¸€æ¬¡Lumené¡¹ç›®ä»£ç ï¼Œæ²¡æœ‰å¤šä½™çš„ç£ç›˜IOå’ŒPHPä»£ç ç¼–è¯‘çš„å¼€é”€ã€‚</p><h3 id="å‹åŠ›æµ‹è¯•"><a href="#å‹åŠ›æµ‹è¯•" class="headerlink" title="å‹åŠ›æµ‹è¯•"></a>å‹åŠ›æµ‹è¯•</h3><p>åœ¨4GB+4Coreçš„è™šæ‹Ÿæœºä¸‹ï¼Œæµ‹è¯•HTTPæœåŠ¡å™¨çš„é™æ€è¾“å‡ºï¼š</p><ul><li><p>2000å®¢æˆ·ç«¯å¹¶å‘500000è¯·æ±‚ï¼Œä¸å¼€å¯HTTP Keepaliveï¼Œå¹³å‡QPSï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NginX + HTML               QPSï¼š25883.44</span><br><span class="line">NginX + PHP-FPM + Lumen    QPSï¼š828.36</span><br><span class="line">Swoole + Lumen             QPSï¼š13647.75</span><br></pre></td></tr></table></figure></li><li><p>2000å®¢æˆ·ç«¯å¹¶å‘500000è¯·æ±‚ï¼Œå¼€å¯HTTP Keepaliveï¼Œå¹³å‡QPSï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NginX + HTML               QPSï¼š86843.11</span><br><span class="line">NginX + PHP-FPM + Lumen    QPSï¼š894.06</span><br><span class="line">Swoole + Lumen             QPSï¼š18183.43</span><br></pre></td></tr></table></figure></li></ul><p>å¯ä»¥çœ‹å‡ºï¼Œ<code>Swoole + Lumen</code>ç»„åˆçš„æ‰§è¡Œæ•ˆç‡è¿œé«˜äº<code>NginX + PHP-FPM + Lumen</code>ç»„åˆã€‚</p><h2 id="å¼‚æ­¥MySQLå®¢æˆ·ç«¯"><a href="#å¼‚æ­¥MySQLå®¢æˆ·ç«¯" class="headerlink" title="å¼‚æ­¥MySQLå®¢æˆ·ç«¯"></a>å¼‚æ­¥MySQLå®¢æˆ·ç«¯</h2><blockquote><p>ä»¥ä¸Šéƒ½æ˜¯é“ºå«ï¼Œä»¥ä¸‹æ‰æ˜¯æ•´ç¯‡æ–‡ç« çš„é‡ç‚¹ğŸ˜‚ğŸ˜‚ğŸ˜‚</p></blockquote><p>ä¸€ä¸ªPHPåº”ç”¨è¦åšçš„äº‹ä¸ä¼šæ˜¯å•çº¯çš„æ•°æ®è®¡ç®—å’Œæ•°æ®è¾“å‡ºï¼Œæ›´å¤šçš„æ˜¯ä¸æ•°æ®åº“æ•°æ®äº¤äº’ã€‚ä»¥MySQLæ•°æ®åº“ä¸ºä¾‹ï¼Œåœ¨åªæœ‰ä¸€ä¸ªPHPè¿›ç¨‹çš„æƒ…å†µï¼Œæœ‰10ä¸ªç”¨æˆ·åŒæ—¶è¯·æ±‚æ‰§è¡Œ<code>select sleep(1);</code>ï¼ˆè€—æ—¶1ç§’ï¼‰æŸ¥è¯¢è¯­å¥ï¼Œè‹¥æ˜¯ä½¿ç”¨MySQLåŒæ­¥æŸ¥è¯¢ï¼Œé‚£ä¹ˆæ€»è€—æ—¶è‡³å°‘æ˜¯10ç§’ï¼›è‹¥æ˜¯ä½¿ç”¨MySQLå¼‚æ­¥æŸ¥è¯¢ï¼Œé‚£ä¹ˆæ€»è€—æ—¶å¯èƒ½å‹ç¼©åˆ°1åˆ°2ç§’å†…ã€‚</p><p>åœ¨PHPåº”ç”¨ä¸­èƒ½å¤Ÿå®ç°æ•°æ®åº“å¼‚æ­¥æŸ¥è¯¢ï¼Œæ‰èƒ½æ›´å¤§çš„çªç ´æ€§èƒ½ç“¶é¢ˆã€‚</p><p>è™½ç„¶Swooleæä¾›äº†<a href="https://wiki.swoole.com/wiki/page/517.html" target="_blank" rel="noopener">å¼‚æ­¥MySQLå®¢æˆ·ç«¯</a>ï¼Œä½†æ˜¯å…¶å¼‚æ­¥ç¼–ç¨‹é£æ ¼ä¸Lumenè¿™ç§åŒæ­¥ç¼–ç¨‹é£æ ¼çš„é¡¹ç›®æ¡†æ¶å†²çªï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰å¯èƒ½åœ¨åŒæ­¥ç¼–ç¨‹é£æ ¼ä»£ç ä¸­è°ƒç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯å‘¢ï¼Ÿ</p><blockquote><p>ä¸€å¼€å§‹æˆ‘è§‰å¾—è¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œç›´åˆ°çœ‹äº†è¿™ç¯‡æ–‡ç« ï¼š<a href="http://nikic.github.io/2012/12/22/Cooperative-multitasking-using-coroutines-in-PHP.html" target="_blank" rel="noopener">Cooperative multitasking using coroutines (in PHP!)</a>ã€‚å½“ç„¶ï¼Œæˆ‘çœ‹çš„æ˜¯ä¸­æ–‡ç‰ˆï¼š<a href="http://www.laruence.com/2015/05/28/3038.html" target="_blank" rel="noopener"> åœ¨PHPä¸­ä½¿ç”¨åç¨‹å®ç°å¤šä»»åŠ¡è°ƒåº¦</a>ï¼Œæ–‡ä¸­æåˆ°äº†PHP5.5åŠ å…¥çš„ä¸€ä¸ªæ–°åŠŸèƒ½ï¼š<a href="http://php.net/manual/en/language.generators.syntax.php" target="_blank" rel="noopener">yield</a>ã€‚</p></blockquote><h3 id="Yield"><a href="#Yield" class="headerlink" title="Yield"></a>Yield</h3><p><code>yield</code>æ˜¯ä¸ªåŠ¨è¯ï¼Œæ„æ€æ˜¯â€œç”Ÿæˆâ€ï¼ŒPHPä¸­<code>yield</code>ç”Ÿå‡ºçš„ä¸œè¥¿å«<code>Generator</code>ï¼Œæ„æ€æ˜¯â€œç”Ÿæˆå™¨â€ğŸ˜‚ğŸ˜‚ğŸ˜‚ã€‚</p><p>ä¸ªäººç†è§£æ˜¯ï¼šyieldå°†å½“å‰æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä½œä¸ºå½“å‰å‡½æ•°çš„ç»“æœè¿”å›ï¼ˆyieldå¿…é¡»åœ¨å‡½æ•°ä¸­ä½¿ç”¨ï¼‰ã€‚</p><p>åœ¨ç³»ç»Ÿå±‚é¢ï¼Œå„ä¸ªè¿›ç¨‹çš„è¿è¡Œç§©åºç”±CPUè°ƒåº¦ï¼›è€Œæœ‰äº†yieldï¼Œåœ¨PHPè¿›ç¨‹å†…ï¼Œç¨‹åºå‘˜å¯ä»¥è‡ªç”±è°ƒåº¦å„ä¸ªä»£ç å—çš„æ‰§è¡Œé¡ºåºã€‚æ¯”å¦‚ï¼Œå½“â€œå‘ç°â€å½“å‰ç”¨æˆ·è¯·æ±‚çš„MySQLæŸ¥è¯¢å°†ä¼šèŠ±è´¹è¾ƒå¤šçš„æ—¶é—´ï¼Œé‚£ä¹ˆå¯ä»¥å°†å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡è®°å½•èµ·æ¥ï¼Œäº¤ç»™å¼‚æ­¥MySQLå®¢æˆ·ç«¯å¤„ç†ï¼ˆä¸ç”¨æˆ·è¯·æ±‚ç›¸å…³çš„<code>$request</code>å’Œ<code>$response</code>ä¹Ÿä¼ é€’è¿‡å»ï¼‰ï¼Œè€Œä¸»è¿›ç¨‹ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªç”¨æˆ·è¯·æ±‚ã€‚</p><h3 id="çº¦å®šå£°æ˜"><a href="#çº¦å®šå£°æ˜" class="headerlink" title="çº¦å®šå£°æ˜"></a>çº¦å®šå£°æ˜</h3><p>å‰é¢ç”¨äº†â€œå‘ç°â€è¿™ä¸ªè¯ï¼Œå½“ç„¶ç¨‹åºä¸å¯èƒ½æ™ºèƒ½åœ°å‘ç°è¿˜æ²¡æ‰§è¡Œçš„æŸ¥è¯¢è¯­å¥å°†ä¼šæ˜¯ä¸ªæ…¢æŸ¥è¯¢ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›çº¦å®šå’Œå£°æ˜ã€‚<br>Lumenæ¡†æ¶æ˜¯ç»å…¸çš„MVCæ¨¡å¼ï¼Œæˆ‘ä»¬çº¦å®šCå³Controlleræ˜¯å¤„ç†ç”¨æˆ·è¯·æ±‚çš„æœ€åä¸€æ­¥â€”â€”Controlleræ¥å—ç”¨æˆ·è¯·æ±‚<code>$request</code>å¹¶è¿”å›å“åº”<code>$response</code>ã€‚åŒæ—¶æˆ‘ä»¬å£°æ˜ä¸€ä¸ªç±»ï¼Œå«<code>SlowQuery</code>ï¼Œè¿™ä¸ªç±»ååˆ†ç®€å•ï¼ˆå…·ä½“è¯·å‚è§<a href="https://github.com/breeze2/lumen-swoole-http/blob/master/src/Database/SlowQuery.php" target="_blank" rel="noopener">SlowQuery.php</a>ï¼‰ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BL</span>\<span class="title">SwooleHttp</span>\<span class="title">Database</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SlowQuery</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sql = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sql    = $sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼ŒLumené¡¹ç›®ä¸­æœ‰è¿™ä¹ˆä¸€ä¸ªControllerï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DB</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $a = DB::select(<span class="string">'select sleep(1);'</span>);</span><br><span class="line">        response()-&gt;json($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„<code>DB::select</code>ä½¿ç”¨çš„åŒæ­¥MySQLå®¢æˆ·ç«¯æŸ¥è¯¢ï¼Œæˆ‘ä»¬ç”¨<code>SlowQuery</code>å¯¹è±¡æ›¿æ¢å®ƒï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">BL</span>\<span class="title">SwooleHttp</span>\<span class="title">Database</span>\<span class="title">SlowQuery</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $a = <span class="keyword">yield</span> <span class="keyword">new</span> SlowQuery(<span class="string">'select sleep(1);'</span>);</span><br><span class="line">        response()-&gt;json($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®æ—¶ï¼Œæˆ‘ä»¬ä¸€å®šä¼šè·å–Controllerçš„è¿”å›ç»“æœã€‚Controllerçš„è¿”å›ç»“æœä¸€èˆ¬å¯ä»¥ç›´æ¥åŒ…è£…æˆLumenå“åº”è¿”å›ç»™ç”¨æˆ·çš„ï¼Œä½†è¿”å›ç»“æœè‹¥æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨Generatorå¯¹è±¡ï¼Œè€Œä¸”å…¶å½“å‰å€¼æ˜¯ä¸€ä¸ªæ…¢æŸ¥è¯¢SlowQueryå¯¹è±¡çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å–å‡ºSlowQueryå¯¹è±¡çš„sqlå±æ€§ï¼Œäº¤ç”±å¼‚æ­¥MySQLå®¢æˆ·ç«¯æ‰§è¡Œï¼›åœ¨å¼‚æ­¥æŸ¥è¯¢çš„å›è°ƒå‡½æ•°ä¸­å°†æŸ¥è¯¢ç»“æœæ”¾å›Generatorå¯¹è±¡å­˜å‚¨çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œå¾—åˆ°æœ€åç»“æœæ‰è¿”å›ç»™ç”¨æˆ·ï¼›è€Œä¸»è¿›ç¨‹æ²¡æœ‰é˜»å¡ï¼Œå¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–ç”¨æˆ·è¯·æ±‚ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœæƒ³ç”¨<a href="http://laravel.com/docs/eloquent" target="_blank" rel="noopener">Eloquent ORM</a>ï¼Œé‚£ä¹Ÿå¾ˆç®€å•ï¼šæˆ‘ä»¬å…ˆç»§æ‰¿Lumençš„Modelï¼Œå°è£…æˆä¸€ä¸ªæ–°çš„Modelç±»ï¼ˆå…·ä½“å‚è§<a href="https://github.com/breeze2/lumen-swoole-http/blob/master/src/Database/Model.php" target="_blank" rel="noopener">Model.php</a>ï¼‰ï¼Œåº”ç”¨ä¸­çš„æ•°æ®æ¨¡å‹éƒ½ç»§æ‰¿äºæ–°çš„Modelï¼ŒControllerå°±å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DB</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $a = <span class="keyword">yield</span> User::select(DB::raw(<span class="string">'sleep(1)'</span>))-&gt;yieldGet(); <span class="comment">// æ³¨æ„Useré¡»ç»§æ‰¿è‡ª\BL\SwooleHttp\Database\Model</span></span><br><span class="line">        response()-&gt;json($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸‰ä¸ªControlleræœ€ç»ˆäº§å‡ºçš„ç”¨æˆ·å“åº”éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡åä¸¤è€…ä½¿ç”¨çš„æ˜¯å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œæ•ˆç‡æ›´é«˜ã€‚</p><h3 id="ä»»åŠ¡è°ƒåº¦å™¨"><a href="#ä»»åŠ¡è°ƒåº¦å™¨" class="headerlink" title="ä»»åŠ¡è°ƒåº¦å™¨"></a>ä»»åŠ¡è°ƒåº¦å™¨</h3><p>å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨æ¥æ‰§è¡Œè¿™äº›ç”Ÿæˆå™¨ï¼Œä»»åŠ¡è°ƒåº¦å™¨çš„å®ç°æ–¹æ³•<a href="http://www.laruence.com/2015/05/28/3038.html" target="_blank" rel="noopener"> åœ¨PHPä¸­ä½¿ç”¨åç¨‹å®ç°å¤šä»»åŠ¡è°ƒåº¦</a>æ–‡ä¸­â€œå¤šä»»åŠ¡åä½œâ€ç« èŠ‚é‡Œæœ‰ä»‹ç»ï¼Œè¿™é‡Œä¸å±•å¼€ã€‚<br>Lumenæ¡†æ¶ä¸­çš„ä»£ç ä¿æŒäº†åŒæ­¥ç¼–ç¨‹é£æ ¼ï¼Œè€Œä»»åŠ¡è°ƒåº¦å™¨ä¸­ä½¿ç”¨äº†å¼‚æ­¥ç¼–ç¨‹é£æ ¼æ¥è°ƒç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ã€‚ä»»åŠ¡è°ƒåº¦å™¨æ˜¯åœ¨Swoole HTTPæœåŠ¡å™¨å±‚é¢ä½¿ç”¨çš„ï¼Œå…·ä½“å‚è§<a href="https://github.com/breeze2/lumen-swoole-http/blob/master/src/Service.php" target="_blank" rel="noopener">Service.php</a>ã€‚</p><h3 id="è¿æ¥é™åˆ¶"><a href="#è¿æ¥é™åˆ¶" class="headerlink" title="è¿æ¥é™åˆ¶"></a>è¿æ¥é™åˆ¶</h3><p>å…¶å®ï¼Œæ¯å¼€å¯ä¸€ä¸ªSwooleå¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œä¸»è¿›ç¨‹å°±ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹è¿æ¥MySQLï¼Œè‹¥æ˜¯å»ºç«‹å¤ªå¤šè¿æ¥ï¼ˆçº¿ç¨‹ï¼‰ï¼Œä¼šå¢åŠ è‡ªèº«æœåŠ¡å™¨çš„å‹åŠ›ï¼Œä¹Ÿä¼šå¢åŠ MySQLæ•°æ®åº“æœåŠ¡å™¨çš„å‹åŠ›ã€‚<br>è¿™ç§åˆ©ç”¨yieldæ¥è°ƒç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯å¤„ç†æ…¢æŸ¥è¯¢è€Œäº§ç”Ÿçš„çº¿ç¨‹ï¼Œæš‚ä¸”ç§°å®ƒä¸ºâ€œæ…¢æŸ¥è¯¢åç¨‹â€ã€‚<br>ä¸ºäº†é™åˆ¶æ•°æ®åº“è¿æ¥æ•°é‡ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªå…¨å±€å˜é‡è®°å½•å¯æ–°å»ºæ…¢æŸ¥è¯¢åç¨‹çš„æ•°é‡<code>MAX_COROUTINE</code>ï¼Œå¼€å¯ä¸€ä¸ªå¼‚æ­¥MySQLå®¢æˆ·ç«¯æ—¶è®©å…¶å‡ä¸€ï¼Œå…³é—­ä¸€ä¸ªå¼‚æ­¥MySQLå®¢æˆ·ç«¯æ—¶è®©å…¶åŠ ä¸€ï¼›å½“ç”¨æˆ·è¯·æ±‚æ…¢æŸ¥è¯¢æ—¶ï¼Œ<code>MAX_COROUTINE</code>å¤§äº0åˆ™ç”±å¼‚æ­¥MySQLå®¢æˆ·ç«¯å¤„ç†ï¼Œ<code>MAX_COROUTINE</code>ç­‰äº0æ—¶åˆ™ç”±ä¸»è¿›ç¨‹â€œç¡¬ç€å¤´çš®â€è‡ªå·±å¤„ç†ã€‚</p><h3 id="å‹åŠ›æµ‹è¯•-1"><a href="#å‹åŠ›æµ‹è¯•-1" class="headerlink" title="å‹åŠ›æµ‹è¯•"></a>å‹åŠ›æµ‹è¯•</h3><p>åœ¨4GB+4Coreçš„è™šæ‹Ÿæœºä¸‹ï¼Œæµ‹è¯•HTTPæœåŠ¡å™¨ä¸æ•°æ®åº“è¯»å†™ï¼š</p><h4 id="ä¸€èˆ¬çš„å¿«é€ŸæŸ¥è¯¢å’Œå¿«é€Ÿå†™å…¥æµ‹è¯•ï¼š"><a href="#ä¸€èˆ¬çš„å¿«é€ŸæŸ¥è¯¢å’Œå¿«é€Ÿå†™å…¥æµ‹è¯•ï¼š" class="headerlink" title="ä¸€èˆ¬çš„å¿«é€ŸæŸ¥è¯¢å’Œå¿«é€Ÿå†™å…¥æµ‹è¯•ï¼š"></a>ä¸€èˆ¬çš„å¿«é€ŸæŸ¥è¯¢å’Œå¿«é€Ÿå†™å…¥æµ‹è¯•ï¼š</h4><ul><li><p>200å¹¶å‘50000è¯·æ±‚è¯»ï¼Œåˆ©ç”¨HTTP Keepaliveï¼Œå¹³å‡QPSï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NginX + PHP-FPM + Lumen + MySQL    QPSï¼š521.56</span><br><span class="line">Swoole + Lumen + MySQL             QPSï¼š7509.99</span><br></pre></td></tr></table></figure></li><li><p>200å¹¶å‘50000è¯·æ±‚å†™ï¼Œåˆ©ç”¨HTTP Keepaliveï¼Œå¹³å‡QPSï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NginX + PHP-FPM + Lumen + MySQL    QPSï¼š449.44</span><br><span class="line">Swoole + Lumen + MySQL             QPSï¼š1253.93</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ…¢æŸ¥è¯¢åç¨‹æµ‹è¯•ï¼š"><a href="#æ…¢æŸ¥è¯¢åç¨‹æµ‹è¯•ï¼š" class="headerlink" title="æ…¢æŸ¥è¯¢åç¨‹æµ‹è¯•ï¼š"></a>æ…¢æŸ¥è¯¢åç¨‹æµ‹è¯•ï¼š</h4><ul><li>16workerçš„Swoole HTTPæœåŠ¡å™¨ï¼Œå¹¶å‘æ‰§è¡Œ<code>select sleep(1);</code>è¯·æ±‚çš„æœ€å¤§æ•ˆç‡æ˜¯15.72rpsï¼›</li><li>16worker x 10coroutineçš„Swoole HTTPæœåŠ¡å™¨ï¼Œå¹¶å‘æ‰§è¡Œ<code>select sleep(1);</code>è¯·æ±‚çš„æœ€å¤§æ•ˆç‡æ˜¯151.93rpsã€‚</li></ul><blockquote><p>è¿™é‡Œä¸ºä»€ä¹ˆè¯´æœ€å¤§æ•ˆç‡å‘¢ï¼Ÿå› ä¸ºå½“å¹¶å‘é‡è¿œå¤§äºworkeræ•°ç›® x coroutineæ•°ç›®æ—¶ï¼Œå¯å¼€å¯æ…¢æŸ¥è¯¢åç¨‹çš„Swoole HTTPæœåŠ¡å™¨çš„æ•ˆç‡ä¼šé€æ¸è·Œå‘æ™®é€šSwoole HTTPæœåŠ¡å™¨ã€‚</p></blockquote><p><code>select sleep(1);</code>æŸ¥è¯¢è¯­å¥è€—æ—¶1ç§’ï¼Œæ¯ä¸ªç”¨æˆ·è¯·æ±‚éƒ½éœ€è¦1ç§’æ—¶é—´æ¥å¤„ç†ï¼›ä¸è¿‡ï¼Œ16è¿›ç¨‹çš„ã€æ¯ä¸ªè¿›ç¨‹å¯å¼€å¯10ä¸ªæ…¢æŸ¥è¯¢åç¨‹çš„Swoole HTTPæœåŠ¡å™¨çš„æ¯ç§’æœ€å¤šå¯ä»¥å¤„ç†160ä¸ªç”¨æˆ·è¯·æ±‚ï¼Œè€Œ16è¿›ç¨‹çš„æ™®é€šSwoole HTTPæœåŠ¡å™¨æ¯ç§’æœ€å¤šåªèƒ½å¤„ç†16ä¸ªç”¨æˆ·è¯·æ±‚ã€‚</p><h3 id="å»¶ä¼¸"><a href="#å»¶ä¼¸" class="headerlink" title="å»¶ä¼¸"></a>å»¶ä¼¸</h3><p>å…¶å®åˆ©ç”¨yieldï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å®ç°å„ç§å„æ ·çš„â€œåç¨‹â€ã€‚æ¯”å¦‚ï¼Œ<a href="https://www.oschina.net/news/93248/swoole-2-1-released" target="_blank" rel="noopener">Swoole2.1ç‰ˆæœ¬</a>å·²ç»å¼€å§‹æ”¯æŒgoå‡½æ•°ä¸é€šé“ï¼Œåç»­æˆ‘ä»¬å¯èƒ½è¿˜å¯ä»¥å°†Lumen Controllerä¸­ä¸€äº›IOé˜»å¡çš„æ“ä½œçš„ä¸Šä¸‹æ–‡ç§»è‡³goå‡½æ•°é‡Œæ‰§è¡Œï¼Œè¿™æ ·æ—¢ä¿ç•™äº†åŒæ­¥ç¼–ç¨‹çš„é£æ ¼ï¼Œç”±è¾¾åˆ°å¼‚æ­¥æ‰§è¡Œçš„æ€§èƒ½ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ä»¥ä¸Šç†è®ºï¼Œå·²ç»åœ¨<a href="https://github.com/breeze2/lumen-swoole-http" target="_blank" rel="noopener">lumen-swoole-http</a>é¡¹ç›®ä¸­å®ç°ã€‚<br><code>lumen-swoole-http</code>æ˜¯è¿æ¥åŒæ­¥ç¼–ç¨‹Lumenå’Œå¼‚æ­¥ç¼–ç¨‹Swooleçš„ä¸€åº§æ¡¥æ¢ï¼Œå¯ä»¥å¸®åŠ©åŸç”ŸPHPçš„Lumenåº”ç”¨é¡¹ç›®å¿«é€Ÿè¿ç§»åˆ°Swoole HTTPæœåŠ¡å™¨ä¸Šï¼›å½“ç„¶ä¹Ÿå¯ä»¥å¿«é€Ÿè¿ç§»å›å»ğŸ˜‚ã€‚<br>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å°è¯•ä½¿ç”¨ï¼š</p><ul><li><a href="https://breeze2.github.io/lumen-swoole-http/#/1_installation">å®‰è£…</a></li><li><a href="https://breeze2.github.io/lumen-swoole-http/#/1_usage">ä½¿ç”¨</a></li><li><a href="https://breeze2.github.io/lumen-swoole-http/#/1_configuration">é…ç½®</a></li><li><a href="https://breeze2.github.io/lumen-swoole-http/#/3_coroutine_for_slow_query">æ…¢æŸ¥è¯¢åç¨‹</a></li><li>â€¦</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ç½‘ç»œç¼–ç¨‹ä¸€ç›´æ˜¯PHPçš„çŸ­æ¿ï¼Œå°½ç®¡&lt;a href=&quot;https://www.swoole.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Swoole&lt;/a&gt;æ‰©å±•å¼¥è¡¥äº†è¿™ä¸ªç¼ºé™·ï¼Œä½†æ˜¯å…¶ç¼–ç¨‹é£æ ¼åå‘äº†NodeJSæˆ–GoLangï¼Œä¸åŸæœ¬çš„åŒæ­¥ç¼–ç¨‹é£æ ¼è¿¥ç„¶ç›¸å¼‚ã€‚ç›®å‰PHPçš„å¤§éƒ¨åˆ†ä¸»æµåº”ç”¨æ¡†æ¶ä¾ç„¶æ˜¯åŒæ­¥ç¼–ç¨‹é£æ ¼ï¼Œæ‰€ä»¥ä¸€ç›´åœ¨æ¢ç´¢Swooleä¸åŒæ­¥ç¼–ç¨‹ç»“åˆçš„é€”å¾„ã€‚&lt;br&gt;&lt;a href=&quot;https://github.com/breeze2/lumen-swoole-http&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;lumen-swoole-http&lt;/a&gt;æ­£æ˜¯è¿æ¥åŒæ­¥ç¼–ç¨‹Lumenå’Œå¼‚æ­¥ç¼–ç¨‹Swooleçš„ä¸€åº§æ¡¥æ¢ï¼Œæœ‰å…´è¶£å¯ä»¥å…³æ³¨ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;LNMPçš„ä¸è¶³&quot;&gt;&lt;a href=&quot;#LNMPçš„ä¸è¶³&quot; class=&quot;headerlink&quot; title=&quot;LNMPçš„ä¸è¶³&quot;&gt;&lt;/a&gt;LNMPçš„ä¸è¶³&lt;/h2&gt;&lt;p&gt;LNMPæ˜¯ç»å…¸çš„Webåº”ç”¨æ¶æ„ç»„åˆï¼Œè™½ç„¶ï¼ˆLinuxã€NginXã€MySQLå’ŒPHP-FPMï¼‰å››è€…å„ç§æ˜¯ä¼˜ç§€çš„ç³»ç»Ÿæˆ–è½¯ä»¶ï¼Œä½†æ˜¯ç»„åˆåˆ°ä¸€èµ·çš„æ€»ä½“æ€§èƒ½å¹¶ä¸å°½äººæ„ï¼Œæ˜æ˜¾çš„ä¸æ˜¯&lt;code&gt;1+1+1+1&amp;gt;4&lt;/code&gt;ï¼Œè€Œæ˜¯&lt;code&gt;4+3+2+1&amp;lt;1&lt;/code&gt;ã€‚Linuxç³»ç»Ÿæ— å¯åšéï¼Œä¸»è¦é—®é¢˜å‡ºç°åœ¨ï¼š&lt;/p&gt;
&lt;h3 id=&quot;ä»NginXåˆ°PHP-FPM&quot;&gt;&lt;a href=&quot;#ä»NginXåˆ°PHP-FPM&quot; class=&quot;headerlink&quot; title=&quot;ä»NginXåˆ°PHP-FPM&quot;&gt;&lt;/a&gt;ä»NginXåˆ°PHP-FPM&lt;/h3&gt;&lt;p&gt;NginXåˆ©ç”¨IOå¤šè·¯å¤ç”¨æœºåˆ¶&lt;a href=&quot;https://en.wikipedia.org/wiki/Epoll&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;epoll&lt;/a&gt;ï¼Œæå¤§åœ°å‡å°‘äº†IOé˜»å¡ç­‰å¾…ï¼Œå¯ä»¥è½»æ¾åº”å¯¹&lt;a href=&quot;https://en.wikipedia.org/wiki/C10k_problem&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;C10K&lt;/a&gt;ã€‚å¯æ˜¯æ¯æ¬¡NginXå°†ç”¨æˆ·è¯·æ±‚ä¼ é€’ç»™PHP-FPMæ—¶ï¼ŒPHP-FPMæ€»æ˜¯éœ€è¦ä»æ–°åŠ è½½PHPé¡¹ç›®ä»£ç ï¼šåˆ›å»ºæ‰§è¡Œç¯å¢ƒï¼Œè¯»å–PHPæ–‡ä»¶å’Œä»£ç è§£æã€ç¼–è¯‘ç­‰æ“ä½œä¸€æ¬¡åˆä¸€æ¬¡çš„é‡å¤æ‰§è¡Œï¼Œé€ æˆä¸å°çš„æ¶ˆè€—ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ä»PHP-FPMåˆ°MySQL&quot;&gt;&lt;a href=&quot;#ä»PHP-FPMåˆ°MySQL&quot; class=&quot;headerlink&quot; title=&quot;ä»PHP-FPMåˆ°MySQL&quot;&gt;&lt;/a&gt;ä»PHP-FPMåˆ°MySQL&lt;/h3&gt;&lt;p&gt;ç”±äºPHPä»£ç æœ¬èº«æ˜¯åŒæ­¥æ‰§è¡Œï¼ŒPHP-FPMè¿æ¥MySQLæŸ¥è¯¢æ•°æ®æ—¶ï¼Œåªèƒ½ç©ºé—²ç­‰å¾…MySQLè¿”å›æŸ¥è¯¢ç»“æœã€‚ä¸€ä¸ªæŸ¥è¯¢è¯­å¥æ‰§è¡Œæ—¶é—´å¯èƒ½ä¼šéœ€è¦å‡ ç§’é’Ÿï¼ŒæœŸé—´PHP-FPMè‹¥æ˜¯èƒ½æš‚æ—¶æ”¾ä¸‹å½“å‰ç”¨æˆ·æ…¢æŸ¥è¯¢è¯·æ±‚ï¼Œè€Œå»å¤„ç†å…¶ä»–ç”¨æˆ·è¯·æ±‚ï¼Œæ•ˆç‡å¿…ç„¶æœ‰æ‰€æé«˜ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æ±‚ç´¢" scheme="https://breeze2.github.io/blog/categories/%E6%B1%82%E7%B4%A2/"/>
    
    
      <category term="php" scheme="https://breeze2.github.io/blog/tags/php/"/>
    
      <category term="swoole" scheme="https://breeze2.github.io/blog/tags/swoole/"/>
    
      <category term="lumen" scheme="https://breeze2.github.io/blog/tags/lumen/"/>
    
      <category term="think" scheme="https://breeze2.github.io/blog/tags/think/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨Lumené¡¹ç›®ä¸­è‡ªå®šä¹‰åç½®å¼‚æ­¥åç¨‹</title>
    <link href="https://breeze2.github.io/blog/swoole-lumen-define-post-processing-coroutine.html"/>
    <id>https://breeze2.github.io/blog/swoole-lumen-define-post-processing-coroutine.html</id>
    <published>2018-03-01T23:12:02.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://blog.breezelin.cn/swoole-lumen-use-async-mysql-client-in-lumen.html" target="_blank" rel="noopener">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä»‹ç»äº†åˆ©ç”¨yieldç‰¹æ€§å®ç°åç½®çš„MySQLå¼‚æ­¥æŸ¥è¯¢åç¨‹ï¼ŒæŒ‰ç…§è¿™ç§â€œåç½®æ‰§è¡Œâ€çš„æ€è·¯ï¼Œå…¶å®è¿˜å¯ä»¥å®ç°æ›´å¤šå…¶ä»–çš„åç½®å¼‚æ­¥åç¨‹ã€‚è¿™é‡Œä»‹ç»å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªåç½®å¼‚æ­¥åç¨‹ï¼Œå°†æœ€å¤§å¼€å‘è‡ªç”±åº¦äº¤ç”±Lumenæ¡†æ¶ä½¿ç”¨è€…ã€‚</p></blockquote><h2 id="CustomAsyncProcess"><a href="#CustomAsyncProcess" class="headerlink" title="CustomAsyncProcess"></a>CustomAsyncProcess</h2><p><a href="https://breeze2.github.io/lumen-swoole-http/">lumen-swoole-http</a>ä¸­å·²ç»å®šä¹‰äº†æŠ½è±¡ç±»<code>CustomAsyncProcess</code>ï¼Œåœ¨å¤„ç†ç”¨æˆ·è¯·æ±‚æ—¶ï¼Œè‹¥æ˜¯æ•è·åˆ°<code>CustomAsyncProcess</code>ç±»çš„å¯¹è±¡ï¼Œç¨‹åºä¾¿ä¼šæŒ‰ç…§<code>CustomAsyncProcess</code>å¯¹è±¡çš„æŒ‡å®šæ–¹æ³•æ‰§è¡Œã€‚éƒ¨åˆ†ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    ...</span><br><span class="line">    $current_value = $last_generator-&gt;current();</span><br><span class="line">    <span class="keyword">if</span> ($current_value <span class="keyword">instanceof</span> CustomAsyncProcess) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($worker-&gt;canDoCoroutine()) &#123;</span><br><span class="line">            $worker-&gt;upCoroutineNum();</span><br><span class="line">            <span class="keyword">return</span> $current_value-&gt;runAsyncTask($request, $response, $worker, <span class="keyword">$this</span>-&gt;scheduler, $last_generator);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> $current_value-&gt;runNormalTask($request, $response, $worker, <span class="keyword">$this</span>-&gt;scheduler, $last_generator);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="ä¸€ä¸ªç®€å•çš„åç½®åç¨‹"><a href="#ä¸€ä¸ªç®€å•çš„åç½®åç¨‹" class="headerlink" title="ä¸€ä¸ªç®€å•çš„åç½®åç¨‹"></a>ä¸€ä¸ªç®€å•çš„åç½®åç¨‹</h2><p>æˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸ªç®€å•çš„åç½®åç¨‹<code>EasyProcess</code>ï¼Œç»§æ‰¿è‡ª<code>CustomAsyncProcess</code>ï¼Œéœ€è¦å®ç°ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">http</span>\<span class="title">AfterCoroutines</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">BL</span>\<span class="title">SwooleHttp</span>\<span class="title">Service</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">BL</span>\<span class="title">SwooleHttp</span>\<span class="title">Coroutine</span>\<span class="title">SimpleSerialScheduler</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Generator</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">swoole_http_request</span> <span class="title">as</span> <span class="title">SwooleHttpRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">swoole_http_response</span> <span class="title">as</span> <span class="title">SwooleHttpResponse</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EasyProcess</span> <span class="keyword">extends</span> \<span class="title">BL</span>\<span class="title">SwooleHttp</span>\<span class="title">Coroutine</span>\<span class="title">CustomAsyncProcess</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºæœ‰åç¨‹æ•°é‡é™åˆ¶ï¼Œè¾¾åˆ°æœ€å¤§åç¨‹æ•°é‡æ—¶ï¼Œä¼šè°ƒç”¨runNormalTaskæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">runNormalTask</span><span class="params">(SwooleHttpRequest $request, SwooleHttpResponse $response, Service $worker, SimpleSerialScheduler $scheduler, Generator $last_generator)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $value = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// ç»™æœ€åä¸€å±‚ç”Ÿæˆå™¨ï¼Œä¼ å…¥$valueå€¼ï¼Œå¹¶é€’å½’å¯¼å‡ºæ•´ä¸ªç”Ÿæˆå™¨å¥—å±‚çš„æœ€ç»ˆå€¼$final</span></span><br><span class="line">        $final = <span class="keyword">$this</span>-&gt;fullRunScheduler($scheduler, $last_generator, $value);</span><br><span class="line">        $http_response = $final;</span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šrunNormalTaskæ–¹æ³•ä¸­ä½¿ç”¨makeNormalResponseæ–¹æ³•å“åº”ç”¨æˆ·è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;makeNormalResponse($request, $response, $worker, $http_response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ²¡è¾¾åˆ°æœ€å¤§åç¨‹æ•°é‡æ—¶ï¼Œä¼šè°ƒç”¨runAsyncTaskæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">runAsyncTask</span><span class="params">(SwooleHttpRequest $request, SwooleHttpResponse $response, Service $worker, SimpleSerialScheduler $scheduler, Generator $last_generator)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $value = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// ç»™æœ€åä¸€å±‚ç”Ÿæˆå™¨ï¼Œä¼ å…¥$valueå€¼ï¼Œå¹¶é€’å½’å¯¼å‡ºæ•´ä¸ªç”Ÿæˆå™¨å¥—å±‚çš„æœ€ç»ˆå€¼$final</span></span><br><span class="line">        $final = <span class="keyword">$this</span>-&gt;fullRunScheduler($scheduler, $last_generator, $value);</span><br><span class="line">        $http_response = $final;</span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šrunAsyncTaskæ–¹æ³•ä¸­ä½¿ç”¨makeAsyncResponseæ–¹æ³•å“åº”ç”¨æˆ·è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;makeAsyncResponse($request, $response, $worker, $http_response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥åœ¨Controllerä¸­ä½¿ç”¨è¿™ä¸ªåç½®åç¨‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">http</span>\<span class="title">AfterCoroutines</span>\<span class="title">EasyProcess</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $a = <span class="keyword">yield</span> <span class="keyword">new</span> EasyProcess();</span><br><span class="line">        response()-&gt;json($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“è®¿é—®<code>TestController@test</code>å¯¹åº”çš„è·¯ç”±æ—¶ï¼Œå¾—åˆ°çš„è¿”å›ç»“æœæœ‰å¯èƒ½æ˜¯1ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯2ï¼Œè§†å½“æ—¶åç¨‹æ•°é‡è€Œå®šã€‚1æˆ–2è¿™ä¸ªç»“æœåœ¨<code>TestController@test</code>å±‚é¢ä¸Šæ˜¯æœªæ›¾çŸ¥çš„ï¼Œæ˜¯ç”±<code>EasyProcess</code>è¿™ä¸ªåç½®åç¨‹äº§å‡ºçš„ã€‚</p><p><code>EasyProcess</code>ä¸ç®—ä¸€ä¸ªå¼‚æ­¥åç¨‹ï¼Œæ— è®º<code>runNormalTask</code>æ–¹æ³•æˆ–è€…<code>runAsyncTask</code>æ–¹æ³•ï¼Œéƒ½æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚è‹¥æƒ³å®ç°å¼‚æ­¥æ‰§è¡Œï¼Œå¿…é¡»ä½¿ç”¨Swooleæä¾›çš„å¼‚æ­¥å®¢æˆ·ç«¯ï¼Œè¯¦ç»†è¯·æŸ¥çœ‹Swooleå®˜æ–¹æ–‡æ¡£<a href="https://wiki.swoole.com/wiki/page/p-async.html" target="_blank" rel="noopener">AsyncIO</a>ã€‚</p><p>ä¸‹é¢ä»‹ç»å¦‚ä½•å®ç°ä¸€ä¸ªåç½®çš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯åç¨‹ã€‚</p><h2 id="ä¸€ä¸ªåç½®çš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯åç¨‹"><a href="#ä¸€ä¸ªåç½®çš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯åç¨‹" class="headerlink" title="ä¸€ä¸ªåç½®çš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯åç¨‹"></a>ä¸€ä¸ªåç½®çš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯åç¨‹</h2><p>å‡è®¾æˆ‘ä»¬å¤„ç†æŸä¸ªç”¨æˆ·è¯·æ±‚æ—¶ï¼Œéœ€è¦ä»è¿œç«¯é“¾æ¥<code>http://www.domain.com/api/data</code>è·å–ä¸€äº›æ•°æ®ï¼ŒæœŸé—´å¯èƒ½éœ€è¦è€—æ—¶å‡ ç§’é’Ÿï¼Œé‚£ä¹ˆæ€æ ·ç”¨åç½®å¼‚æ­¥åç¨‹å®ç°æ¥é¿å…é˜»å¡å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸ªç®€å•çš„åç½®åç¨‹<code>AysncHttpProcess</code>ï¼Œç»§æ‰¿è‡ª<code>CustomAsyncProcess</code>ï¼Œéœ€è¦å®ç°ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">http</span>\<span class="title">AfterCoroutines</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">BL</span>\<span class="title">SwooleHttp</span>\<span class="title">Service</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">BL</span>\<span class="title">SwooleHttp</span>\<span class="title">Coroutine</span>\<span class="title">SimpleSerialScheduler</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Generator</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">swoole_http_request</span> <span class="title">as</span> <span class="title">SwooleHttpRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">swoole_http_response</span> <span class="title">as</span> <span class="title">SwooleHttpResponse</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Http2</span>\<span class="title">Client</span> <span class="title">as</span> <span class="title">SwooleHttpClient</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AysncHttpProcess</span> <span class="keyword">extends</span> \<span class="title">BL</span>\<span class="title">SwooleHttp</span>\<span class="title">Coroutine</span>\<span class="title">CustomAsyncProcess</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    public function $url;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;url = $url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å› ä¸ºæœ‰åç¨‹æ•°é‡é™åˆ¶ï¼Œè¾¾åˆ°æœ€å¤§åç¨‹æ•°é‡æ—¶ï¼Œä¼šè°ƒç”¨runNormalTaskæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">runNormalTask</span><span class="params">(SwooleHttpRequest $request, SwooleHttpResponse $response, Service $worker, SimpleSerialScheduler $scheduler, Generator $last_generator)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = file_get_contents(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        <span class="comment">// ç»™æœ€åä¸€å±‚ç”Ÿæˆå™¨ï¼Œä¼ å…¥$valueå€¼ï¼Œå¹¶é€’å½’å¯¼å‡ºæ•´ä¸ªç”Ÿæˆå™¨å¥—å±‚çš„æœ€ç»ˆå€¼$final</span></span><br><span class="line">        $final = <span class="keyword">$this</span>-&gt;fullRunScheduler($scheduler, $last_generator, $data);</span><br><span class="line">        $http_response = $final;</span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šrunNormalTaskæ–¹æ³•ä¸­ä½¿ç”¨makeNormalResponseæ–¹æ³•å“åº”ç”¨æˆ·è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;makeNormalResponse($request, $response, $worker, $http_response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ²¡è¾¾åˆ°æœ€å¤§åç¨‹æ•°é‡æ—¶ï¼Œä¼šè°ƒç”¨runAsyncTaskæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">runAsyncTask</span><span class="params">(SwooleHttpRequest $request, SwooleHttpResponse $response, Service $worker, SimpleSerialScheduler $scheduler, Generator $last_generator)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $client = <span class="keyword">new</span> SwooleHttpClient();</span><br><span class="line">        $caller = <span class="keyword">$this</span>;</span><br><span class="line">        $client-&gt;get(<span class="keyword">$this</span>-&gt;url, <span class="function"><span class="keyword">function</span> <span class="params">($o)</span> <span class="title">use</span><span class="params">($client, $caller)</span> </span>&#123;</span><br><span class="line">            $data = $o-&gt;body;</span><br><span class="line">            <span class="comment">// ç»™æœ€åä¸€å±‚ç”Ÿæˆå™¨ï¼Œä¼ å…¥$valueå€¼ï¼Œå¹¶é€’å½’å¯¼å‡ºæ•´ä¸ªç”Ÿæˆå™¨å¥—å±‚çš„æœ€ç»ˆå€¼$final</span></span><br><span class="line">            $final = $caller-&gt;fullRunScheduler($scheduler, $last_generator, $value);</span><br><span class="line">            $http_response = $final;</span><br><span class="line">            <span class="comment">// æ³¨æ„ï¼šrunAsyncTaskæ–¹æ³•ä¸­ä½¿ç”¨makeAsyncResponseæ–¹æ³•å“åº”ç”¨æˆ·è¯·æ±‚</span></span><br><span class="line">            $caller-&gt;makeAsyncResponse($request, $response, $worker, $http_response);</span><br><span class="line">            $client-&gt;close();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥åœ¨Controllerä¸­ä½¿ç”¨è¿™ä¸ªåç½®åç¨‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">http</span>\<span class="title">AfterCoroutines</span>\<span class="title">AysncHttpProcess</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $a = <span class="keyword">yield</span> <span class="keyword">new</span> AysncHttpProcess(<span class="string">'http://www.domain.com/api/data'</span>);</span><br><span class="line">        response()-&gt;json($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±è¿™æ ·ï¼Œåœ¨åç¨‹æ•°é‡å…è®¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åç½®çš„å¼‚æ­¥HTTPå®¢æˆ·ç«¯åç¨‹è·å–è¿œç«¯æ•°æ®ï¼Œå¹¶ä¸”é¿å…äº†é˜»å¡ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ä¸‰ç¯‡æ–‡ç« ï¼š</p><ol><li><a href="https://blog.breezelin.cn/swoole-lumen-run-lumen-with-swoole.html" target="_blank" rel="noopener">ç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®çš„å®ç°æ–¹æ³•</a></li><li><a href="https://blog.breezelin.cn/swoole-lumen-use-async-mysql-client-in-lumen.html" target="_blank" rel="noopener">åœ¨Lumené¡¹ç›®ä¸­ä½¿ç”¨Swooleå¼‚æ­¥MySQLå®¢æˆ·ç«¯çš„å®ç°æ–¹æ³•</a></li><li><a href>åœ¨Lumené¡¹ç›®ä¸­è‡ªå®šä¹‰åç½®å¼‚æ­¥åç¨‹</a></li></ol><p>è‡³æ­¤ï¼Œå·²ç»å°†<a href="https://breeze2.github.io/lumen-swoole-http/">lumen-swoole-http</a>çš„è®¾è®¡ç†å¿µä»‹ç»å®Œäº†ï¼Œä¸»è¦æ˜¯ä¸¤ç‚¹ï¼š</p><ul><li>åˆ©ç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ï¼›</li><li>åˆ©ç”¨åç½®å¼‚æ­¥åç¨‹ï¼Œä¿æŒåŒæ­¥ç¼–ç¨‹é£æ ¼ï¼Œé¿å…ä¸»è¿›ç¨‹é˜»å¡ã€‚</li></ul><blockquote><p>Swooleå¡«è¡¥äº†PHPç½‘ç»œç¼–ç¨‹çš„ç¼ºé™·ï¼Œå¼•å…¥NodeJSã€GoLangç­‰è¯­è¨€çš„å¹¶è¡Œæ‰§è¡Œç‰¹æ€§ï¼Œä½¿ç”¨äº†ä¸åŒçš„ç¼–ç¨‹é£æ ¼ã€‚å¯¹æ­¤ï¼Œä¸åº”è¯¥ä¸€å‘³æŠ—æ‹’ï¼Œè€Œæ˜¯å­¦ä¼šèä¼šè´¯é€šâ€”â€”å­¦æ— æ­¢å¢ƒï¼ŒçŸ¥è¯†æ²¡æœ‰ç•Œé™ï¼ŒPHPerä¹Ÿåº”è¯¥å­¦ä¹ å…¶ä»–è¯­è¨€çš„è®¾è®¡ç†å¿µï¼Œç‰¹åˆ«æ˜¯ä¸ºé«˜å¹¶å‘è€Œç”Ÿçš„GoLangã€‚</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.breezelin.cn/swoole-lumen-use-async-mysql-client-in-lumen.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a&gt;ä»‹ç»äº†åˆ©ç”¨yieldç‰¹æ€§å®ç°åç½®çš„MySQLå¼‚æ­¥æŸ¥è¯¢åç¨‹ï¼ŒæŒ‰ç…§è¿™ç§â€œåç½®æ‰§è¡Œâ€çš„æ€è·¯ï¼Œå…¶å®è¿˜å¯ä»¥å®ç°æ›´å¤šå…¶ä»–çš„åç½®å¼‚æ­¥åç¨‹ã€‚è¿™é‡Œä»‹ç»å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªåç½®å¼‚æ­¥åç¨‹ï¼Œå°†æœ€å¤§å¼€å‘è‡ªç”±åº¦äº¤ç”±Lumenæ¡†æ¶ä½¿ç”¨è€…ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;CustomAsyncProcess&quot;&gt;&lt;a href=&quot;#CustomAsyncProcess&quot; class=&quot;headerlink&quot; title=&quot;CustomAsyncProcess&quot;&gt;&lt;/a&gt;CustomAsyncProcess&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://breeze2.github.io/lumen-swoole-http/&quot;&gt;lumen-swoole-http&lt;/a&gt;ä¸­å·²ç»å®šä¹‰äº†æŠ½è±¡ç±»&lt;code&gt;CustomAsyncProcess&lt;/code&gt;ï¼Œåœ¨å¤„ç†ç”¨æˆ·è¯·æ±‚æ—¶ï¼Œè‹¥æ˜¯æ•è·åˆ°&lt;code&gt;CustomAsyncProcess&lt;/code&gt;ç±»çš„å¯¹è±¡ï¼Œç¨‹åºä¾¿ä¼šæŒ‰ç…§&lt;code&gt;CustomAsyncProcess&lt;/code&gt;å¯¹è±¡çš„æŒ‡å®šæ–¹æ³•æ‰§è¡Œã€‚éƒ¨åˆ†ä»£ç ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    $current_value = $last_generator-&amp;gt;current();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ($current_value &lt;span class=&quot;keyword&quot;&gt;instanceof&lt;/span&gt; CustomAsyncProcess) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ($worker-&amp;gt;canDoCoroutine()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            $worker-&amp;gt;upCoroutineNum();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; $current_value-&amp;gt;runAsyncTask($request, $response, $worker, &lt;span class=&quot;keyword&quot;&gt;$this&lt;/span&gt;-&amp;gt;scheduler, $last_generator);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; $current_value-&amp;gt;runNormalTask($request, $response, $worker, &lt;span class=&quot;keyword&quot;&gt;$this&lt;/span&gt;-&amp;gt;scheduler, $last_generator);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="æ±‚ç´¢" scheme="https://breeze2.github.io/blog/categories/%E6%B1%82%E7%B4%A2/"/>
    
    
      <category term="php" scheme="https://breeze2.github.io/blog/tags/php/"/>
    
      <category term="swoole" scheme="https://breeze2.github.io/blog/tags/swoole/"/>
    
      <category term="lumen" scheme="https://breeze2.github.io/blog/tags/lumen/"/>
    
      <category term="think" scheme="https://breeze2.github.io/blog/tags/think/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨Lumené¡¹ç›®ä¸­ä½¿ç”¨Swooleå¼‚æ­¥MySQLå®¢æˆ·ç«¯çš„å®ç°æ–¹æ³•</title>
    <link href="https://breeze2.github.io/blog/swoole-lumen-use-async-mysql-client-in-lumen.html"/>
    <id>https://breeze2.github.io/blog/swoole-lumen-use-async-mysql-client-in-lumen.html</id>
    <published>2018-03-01T16:03:02.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://blog.breezelin.cn/swoole-lumen-run-lumen-with-swoole.html" target="_blank" rel="noopener">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä»‹ç»äº†ç”¨Swoole HTTPæœåŠ¡å™¨æ›¿ä»£NginX + PHP-FPMæ¥è¿è¡ŒLumené¡¹ç›®çš„æ–¹æ³•ï¼Œæé«˜è¿è¡Œæ•ˆç‡ã€‚ä¸è¿‡ï¼Œåœ¨å¤„ç†ç”¨æˆ·è¯·æ±‚è¿‡ç¨‹ä¸­è¿˜æ˜¯ä¼šå­˜åœ¨å¾ˆå¤šIOé˜»å¡æƒ…å†µï¼Œæ¯”å¦‚MySQLæ•°æ®æŸ¥è¯¢ã€‚æœ‰æ²¡æœ‰å¯èƒ½åœ¨Lumenä¸­ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œä»¥æ­¤é¿å…IOé˜»å¡å‘¢ï¼Ÿ</p></blockquote><h2 id="å¼‚æ­¥MySQLå®¢æˆ·ç«¯"><a href="#å¼‚æ­¥MySQLå®¢æˆ·ç«¯" class="headerlink" title="å¼‚æ­¥MySQLå®¢æˆ·ç«¯"></a>å¼‚æ­¥MySQLå®¢æˆ·ç«¯</h2><p>Swoole1.8.6å¢åŠ äº†å†…ç½®å¼‚æ­¥MySQLå®¢æˆ·ç«¯çš„æ”¯æŒï¼Œæ— éœ€ä¾èµ–å…¶ä»–ç¬¬ä¸‰æ–¹åº“ï¼Œä½¿ç”¨æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œï¼ˆå…·ä½“å‚è€ƒSwooleå®˜æ–¹æ–‡æ¡£<a href="https://wiki.swoole.com/wiki/page/517.html" target="_blank" rel="noopener">å¼‚æ­¥MySQLå®¢æˆ·ç«¯</a>ï¼‰ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$db = <span class="keyword">new</span> \swoole_mysql;</span><br><span class="line">$mysql_config = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'host'</span> =&gt; <span class="string">'192.168.56.102'</span>,</span><br><span class="line">    <span class="string">'port'</span> =&gt; <span class="number">3306</span>,</span><br><span class="line">    <span class="string">'user'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">    <span class="string">'password'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">    <span class="string">'database'</span> =&gt; <span class="string">'test'</span>,</span><br><span class="line">    <span class="string">'charset'</span> =&gt; <span class="string">'utf8'</span>, <span class="comment">//æŒ‡å®šå­—ç¬¦é›†</span></span><br><span class="line">    <span class="string">'timeout'</span> =&gt; <span class="number">2</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$db-&gt;connect($mysql_config, <span class="function"><span class="keyword">function</span> <span class="params">($db, $r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($r) &#123;</span><br><span class="line">        $sql = <span class="string">'show tables'</span>;</span><br><span class="line">            $db-&gt;query($sql, <span class="function"><span class="keyword">function</span><span class="params">($db, $r)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ($r) &#123;</span><br><span class="line">                var_dump($r);</span><br><span class="line">            &#125;</span><br><span class="line">            $db-&gt;close();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><a id="more"></a><p>è¿™æ˜¯å…¸å‹å›è°ƒå¤„ç†çš„å¼‚æ­¥ç¼–ç¨‹é£æ ¼ï¼Œè€ŒLumenæœ¬èº«æ˜¯åŒæ­¥ç¼–ç¨‹é£æ ¼ï¼Œåœ¨ç¼–ç¨‹å±‚é¢ï¼Œä¸¤è€…ä¸èƒ½èåˆã€‚æ¯”å¦‚ï¼Œæœ‰è¿™ä¹ˆä¸€ä¸ª<code>Controller</code>ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DB</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $a = DB::query(<span class="string">'select * from users;'</span>);</span><br><span class="line">        response()-&gt;json($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‹¥æ˜¯æ”¹å†™æˆï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $a = <span class="keyword">null</span>;</span><br><span class="line">        $db = <span class="keyword">new</span> \swoole_mysql;</span><br><span class="line">        $db-&gt;connect($mysql_config, <span class="function"><span class="keyword">function</span> <span class="params">($db, $r)</span> <span class="title">use</span> <span class="params">($a)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ($r) &#123;</span><br><span class="line">                $db-&gt;query(<span class="string">'select * from users;'</span>, <span class="function"><span class="keyword">function</span><span class="params">($db, $r)</span> <span class="title">use</span> <span class="params">($a)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> ($r) &#123;</span><br><span class="line">                        $a = json_decode(json_encode($r));</span><br><span class="line">                    &#125;</span><br><span class="line">                    $db-&gt;close();</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        response()-&gt;json($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·è¿”å›çš„å“åº”æ°¸è¿œæ˜¯<code>null</code>ï¼Œå› ä¸º<code>response()-&gt;json($a)</code>ä¼šåœ¨<code>$db-&gt;query()</code>ä¹‹å‰è¢«æ‰§è¡Œã€‚</p><blockquote><p>ä¸€å¼€å§‹æˆ‘ä¹Ÿè§‰å¾—Lumené¡¹ç›®é‡Œæ°¸è¿œæ²¡åŠæ³•ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯äº†ï¼Œç›´åˆ°çœ‹äº†è¿™ç¯‡æ–‡ç« ï¼š<a href="http://nikic.github.io/2012/12/22/Cooperative-multitasking-using-coroutines-in-PHP.html" target="_blank" rel="noopener">Cooperative multitasking using coroutines (in PHP!)</a>ã€‚å½“ç„¶ï¼Œæˆ‘çœ‹çš„æ˜¯ä¸­æ–‡ç‰ˆï¼š<a href="http://www.laruence.com/2015/05/28/3038.html" target="_blank" rel="noopener"> åœ¨PHPä¸­ä½¿ç”¨åç¨‹å®ç°å¤šä»»åŠ¡è°ƒåº¦</a>ï¼Œæ–‡ä¸­æåˆ°äº†PHP5.5åŠ å…¥çš„ä¸€ä¸ªæ–°åŠŸèƒ½ï¼š<a href="http://php.net/manual/en/language.generators.syntax.php" target="_blank" rel="noopener">yield</a>ã€‚</p></blockquote><h2 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h2><p><code>yield</code>æ˜¯ä¸ªåŠ¨è¯ï¼Œæ„æ€æ˜¯â€œç”Ÿæˆâ€ï¼ŒPHPä¸­yieldç”Ÿå‡ºçš„ä¸œè¥¿å«<code>Generator</code>ï¼Œè¯‘ä½œâ€œç”Ÿæˆå™¨â€ã€‚<br>yieldå¯ä»¥åšä»€ä¹ˆå‘¢ï¼Ÿyieldå¯ä»¥å°†å½“å‰æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ä½œä¸ºå½“å‰å‡½æ•°çš„ç»“æœè¿”å›ï¼ˆyieldå¿…é¡»åœ¨å‡½æ•°ä¸­ä½¿ç”¨ï¼‰ã€‚<br>æœ‰äº†yieldï¼Œåˆèƒ½æ€æ ·å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªç±»ï¼Œå«<code>SlwoQuery</code>ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BL</span>\<span class="title">SwooleHttp</span>\<span class="title">Database</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SlowQuery</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sql = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sql = $sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“åˆä¸Šä¸€ç¯‡æ–‡ç« ã€Š<a href="https://blog.breezelin.cn/swoole-lumen-run-lumen-with-swoole.html" target="_blank" rel="noopener">ç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®çš„å®ç°æ–¹æ³•</a>ã€‹ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹<code>Service</code>ç±»çš„<code>onRequest</code>æ–¹æ³•ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(\swoole_http_request $request,\swoole_http_response $response)</span> </span>&#123;</span><br><span class="line">        $app = <span class="keyword">$this</span>-&gt;app;</span><br><span class="line">        <span class="comment">// å¤„ç†ç”¨æˆ·è¯·æ±‚</span></span><br><span class="line">        $http_request = <span class="keyword">$this</span>-&gt;parseRequest($request);</span><br><span class="line">        $http_response = $app-&gt;dispatch($http_request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($http_response <span class="keyword">instanceof</span> \Generator) &#123;</span><br><span class="line">            $gen = $http_response-&gt;current();</span><br><span class="line">            $gen_queue = <span class="keyword">new</span> \SplQueue();</span><br><span class="line">            <span class="keyword">while</span>($gen <span class="keyword">instanceof</span> Generator) &#123;</span><br><span class="line">                $gen_queue-&gt;push($gen); $gen = $gen-&gt;current();</span><br><span class="line">            &#125;</span><br><span class="line">            $last_gen = $gen_queue-&gt;pop();</span><br><span class="line">            $value = $last_gen-&gt;current();</span><br><span class="line">            <span class="keyword">if</span> ($value <span class="keyword">instanceof</span> \BL\SwooleHttp\Database\SlowQuery) &#123;</span><br><span class="line">                $db = <span class="keyword">new</span> \swoole_mysql;</span><br><span class="line">                $caller = <span class="keyword">$this</span>;</span><br><span class="line">                <span class="comment">// å…³é”®éƒ¨åˆ†</span></span><br><span class="line">                $db-&gt;connect($mysql_config, <span class="function"><span class="keyword">function</span> <span class="params">($db, $r)</span> <span class="title">use</span> <span class="params">($caller, $request, $response, $gen_queue, $last_gen, $value)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> ($r) &#123;</span><br><span class="line">                        $db-&gt;query($value-&gt;sql, <span class="function"><span class="keyword">function</span><span class="params">($db, $r)</span> <span class="title">use</span> <span class="params">($caller, $request, $response, $gen_queue, $last_gen)</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> ($r) &#123;</span><br><span class="line">                                <span class="comment">// å…³é”®éƒ¨åˆ†</span></span><br><span class="line">                                $r = json_decode(json_encode($r));</span><br><span class="line">                                $last_gen-&gt;send($r);</span><br><span class="line">                                $ret = $last_gen-&gt;getReturn();</span><br><span class="line">                                <span class="keyword">while</span>(!$gen_queue-&gt;isEmpty()) &#123;</span><br><span class="line">                                    $gen = $gen_queue-&gt;pop(); $gen-&gt;send($ret); $ret = $gen-&gt;getReturn();</span><br><span class="line">                                &#125;</span><br><span class="line">                                $caller-&gt;makeResponse($response, $ret);</span><br><span class="line">                            &#125;</span><br><span class="line">                            $db-&gt;close();</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å“åº”ç”¨æˆ·è¯·æ±‚</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;makeResponse($response, $http_response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä»£ç æ˜¯é•¿äº†äº›ï¼Œå› ä¸ºæ²¡åšåˆ†æ‹†å’Œå°è£…ï¼Œä¸»è¦å…³æ³¨<code>$db-&gt;connect()</code>å’Œ<code>$caller-&gt;makeResponse()</code>çš„å‡ºç°ä½ç½®ã€‚æ•´å—ä»£ç çš„æ„æ€æ˜¯ï¼š</p><ol><li>å¦‚æœLumenå¤„ç†ç”¨æˆ·è¯·æ±‚çš„è¿”å›ç»“æœæ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆå°±ä»è¿™ä¸ªç”Ÿæˆå™¨çš„å‡½æ•°å¥—å±‚é‡Œå¯»æ‰¾ï¼ˆSlowQueryï¼‰ï¼›</li><li>å¦‚æœå½“å‰ç”Ÿæˆå™¨çš„å½“å‰å€¼ä¹Ÿæ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆå°±å¾€æ›´æ·±ä¸€å±‚é‡Œå¯»æ‰¾ï¼›</li><li>å¦‚æœå½“å‰ç”Ÿæˆå™¨çš„å½“å‰å€¼æ˜¯ä¸€ä¸ª<code>SlowQuery</code>å¯¹è±¡ï¼Œé‚£ä¹ˆå°†<code>SlowQuery</code>å¯¹è±¡çš„<code>sql</code>å±æ€§ï¼Œäº¤ç»™å¼‚æ­¥MySQLå®¢æˆ·<code>swoole_mysql</code>æŸ¥è¯¢æ•°æ®ï¼›</li><li>å°†æŸ¥è¯¢æ•°æ®ä¼ å…¥å½“å‰ç”Ÿæˆå™¨ï¼Œè·å¾—å½“å‰å±‚å‡½æ•°çš„è¿”å›ç»“æœï¼›</li><li>å°†å‡½æ•°è¿”å›ç»“æœä¼ å…¥ä¸Šä¸€å±‚ç”Ÿæˆå™¨ï¼Œè·å–ä¸Šä¸€å±‚å‡½æ•°çš„è¿”å›ç»“æœï¼Œé‡å¤ç›´åˆ°æ²¡æœ‰æ›´é«˜å±‚ç”Ÿæˆå™¨ï¼›</li><li>æ‰å°†æœ€é¡¶å±‚å±‚çš„å‡½æ•°è¿”å›ç»“æœä½œä¸ºå“åº”è¾“å‡ºç»™ç”¨æˆ·ã€‚<br>è™½ç„¶æ•´ä¸ªè¿‡ç¨‹å¾ˆç»•ï¼Œä½†æ˜¯ï¼Œåœ¨Lumençš„Controllerå±‚é¢å´æ˜¯ååˆ†çš„ç›´æ¥äº†ç„¶ï¼š<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">BL</span>\<span class="title">SwooleHttp</span>\<span class="title">Database</span>\<span class="title">SlowQuery</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $a = <span class="keyword">yield</span> <span class="keyword">new</span> SlowQuery(<span class="string">'select * from users;'</span>);</span><br><span class="line">        response()-&gt;json($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>å°±è¿™æ ·ï¼Œå®ç°äº†åœ¨åŒæ­¥ç¼–ç¨‹é£æ ¼çš„Lumené¡¹ç›®ä¸­ä½¿ç”¨ä¸Šäº†Swooleçš„å¼‚æ­¥MySQLå®¢æˆ·ç«¯ã€‚å®ç°çš„æ€è·¯ï¼Œå°±åƒ<a href="https://lumen.laravel.com/docs/middleware" target="_blank" rel="noopener">åç½®ä¸­é—´ä»¶</a>ï¼Œä¿æŒæ§åˆ¶å™¨ä»£ç çš„æ•´æ´ï¼Œè„æ´»ç´¯æ´»æ”¾åœ¨ä¸­é—´ä»¶é‡Œæ‰§è¡Œã€‚</p><h2 id="æ•ˆç‡æå‡"><a href="#æ•ˆç‡æå‡" class="headerlink" title="æ•ˆç‡æå‡"></a>æ•ˆç‡æå‡</h2><p>å‡å¦‚ç”¨æˆ·è¯·æ±‚æ‰§è¡Œä¸€ä¸ªæ•°æ®åº“æ…¢æŸ¥è¯¢è¯­å¥ï¼ˆå¯èƒ½è€—æ—¶1ç§’ï¼Œå¦‚<code>select sleep(1);</code>ï¼‰ï¼Œå•ä¸ªPHPè¿›ç¨‹ä½¿ç”¨åŒæ­¥MySQLå®¢æˆ·ç«¯å¤„ç†1ä¸ªè¿™æ ·çš„ç”¨æˆ·è¯·æ±‚ï¼Œè‡³å°‘éœ€è¦1ç§’ï¼Œå¤„ç†10ä¸ªï¼Œåˆ™è‡³å°‘éœ€è¦10ç§’ï¼›è€Œä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œå¤„ç†1ä¸ªï¼Œå¯èƒ½éœ€è¦1ç§’å¤šï¼Œå¤„ç†10ä¸ªï¼Œå¯èƒ½ä¹Ÿåªæ˜¯éœ€è¦1ç§’ã€‚å¼‚æ­¥æ‰§è¡Œå¸¦æ¥çš„æ•ˆç‡æå‡ï¼Œæ˜¯ä¸è¨€è€Œå–»çš„ã€‚</p><p>ä¸è¿‡ï¼Œä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯æ˜¯ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºçš„ï¼Œä¸èƒ½å¤§é‡ä½¿ç”¨ï¼›è€Œä¸”éæ…¢æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥ï¼Œæ ¹æœ¬ä¸éœ€è¦ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯æ¥æ‰§è¡Œï¼Œæ¯”å¦‚<code>select * from users.id = 1;</code>ï¼Œidæœ‰ä¸»é”®ç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶é—´ä¸ä¼šå¤ªé•¿ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>yieldå¯ä»¥å°†æ•´ä¸ªç¨‹åºçš„å„ä¸ªä»£ç å—çš„æ‰§è¡Œç§©åºäº¤ç”±ç¨‹åºå‘˜è‡ªè¡Œè°ƒåº¦ï¼Œç¡®å®å¯ä»¥å®ç°å¾ˆå¤šæ„å‘ä¸åˆ°çš„æ•ˆæœã€‚åƒä»¥ä¸Šè¿™ç§â€œåç½®æ‰§è¡Œâ€çš„æ€è·¯ï¼Œä¸ä»…ä»…æ˜¯å¯ä»¥ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å¼‚æ­¥Rediså®¢æˆ·ç«¯ï¼Œå¼‚æ­¥HTTPå®¢æˆ·ç«¯ï¼Œè¿˜æœ‰æ›´å¤šå„ç§å„æ ·çš„åº”ç”¨ã€‚</p><p>ä¸‹ä¸€ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•è‡ªå®šä¹‰åç½®å¼‚æ­¥åç¨‹ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.breezelin.cn/swoole-lumen-run-lumen-with-swoole.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a&gt;ä»‹ç»äº†ç”¨Swoole HTTPæœåŠ¡å™¨æ›¿ä»£NginX + PHP-FPMæ¥è¿è¡ŒLumené¡¹ç›®çš„æ–¹æ³•ï¼Œæé«˜è¿è¡Œæ•ˆç‡ã€‚ä¸è¿‡ï¼Œåœ¨å¤„ç†ç”¨æˆ·è¯·æ±‚è¿‡ç¨‹ä¸­è¿˜æ˜¯ä¼šå­˜åœ¨å¾ˆå¤šIOé˜»å¡æƒ…å†µï¼Œæ¯”å¦‚MySQLæ•°æ®æŸ¥è¯¢ã€‚æœ‰æ²¡æœ‰å¯èƒ½åœ¨Lumenä¸­ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œä»¥æ­¤é¿å…IOé˜»å¡å‘¢ï¼Ÿ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;å¼‚æ­¥MySQLå®¢æˆ·ç«¯&quot;&gt;&lt;a href=&quot;#å¼‚æ­¥MySQLå®¢æˆ·ç«¯&quot; class=&quot;headerlink&quot; title=&quot;å¼‚æ­¥MySQLå®¢æˆ·ç«¯&quot;&gt;&lt;/a&gt;å¼‚æ­¥MySQLå®¢æˆ·ç«¯&lt;/h2&gt;&lt;p&gt;Swoole1.8.6å¢åŠ äº†å†…ç½®å¼‚æ­¥MySQLå®¢æˆ·ç«¯çš„æ”¯æŒï¼Œæ— éœ€ä¾èµ–å…¶ä»–ç¬¬ä¸‰æ–¹åº“ï¼Œä½¿ç”¨æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œï¼ˆå…·ä½“å‚è€ƒSwooleå®˜æ–¹æ–‡æ¡£&lt;a href=&quot;https://wiki.swoole.com/wiki/page/517.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;å¼‚æ­¥MySQLå®¢æˆ·ç«¯&lt;/a&gt;ï¼‰ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$db = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; \swoole_mysql;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$mysql_config = &lt;span class=&quot;keyword&quot;&gt;array&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;host&#39;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&#39;192.168.56.102&#39;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;port&#39;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;number&quot;&gt;3306&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;user&#39;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&#39;test&#39;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;password&#39;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&#39;test&#39;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;database&#39;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&#39;test&#39;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;charset&#39;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&#39;utf8&#39;&lt;/span&gt;, &lt;span class=&quot;comment&quot;&gt;//æŒ‡å®šå­—ç¬¦é›†&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&#39;timeout&#39;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$db-&amp;gt;connect($mysql_config, &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;($db, $r)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ($r) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        $sql = &lt;span class=&quot;string&quot;&gt;&#39;show tables&#39;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            $db-&amp;gt;query($sql, &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;($db, $r)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ($r) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                var_dump($r);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            $db-&amp;gt;close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="æ±‚ç´¢" scheme="https://breeze2.github.io/blog/categories/%E6%B1%82%E7%B4%A2/"/>
    
    
      <category term="mysql" scheme="https://breeze2.github.io/blog/tags/mysql/"/>
    
      <category term="php" scheme="https://breeze2.github.io/blog/tags/php/"/>
    
      <category term="swoole" scheme="https://breeze2.github.io/blog/tags/swoole/"/>
    
      <category term="lumen" scheme="https://breeze2.github.io/blog/tags/lumen/"/>
    
      <category term="think" scheme="https://breeze2.github.io/blog/tags/think/"/>
    
  </entry>
  
  <entry>
    <title>ç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®çš„å®ç°æ–¹æ³•</title>
    <link href="https://breeze2.github.io/blog/swoole-lumen-run-lumen-with-swoole.html"/>
    <id>https://breeze2.github.io/blog/swoole-lumen-run-lumen-with-swoole.html</id>
    <published>2018-03-01T12:03:02.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>LNMPè™½æ˜¯ä¼ ç»Ÿçš„Webåº”ç”¨æ¶æ„ç»„åˆï¼Œæ— å¥ˆNginX + PHP-FPMçš„æ­é…è¿è¡Œæ•ˆç‡å®åœ¨å¤ªä½ï¼›è€ŒSwoole HTTPæœåŠ¡å™¨å…·æœ‰NginXçº§åˆ«çš„æ€§èƒ½ï¼Œä¸”æœ¬èº«åµŒå…¥åœ¨PHPä¸­ï¼Œå®Œå…¨å¯ä»¥æ›¿ä»£NginX + PHP-FPMã€‚äºæ˜¯ä¸€ç›´åœ¨æ¢ç´¢ç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡Œä¼ ç»ŸPHPåº”ç”¨çš„é€”å¾„ã€‚è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®çš„å®ç°æ–¹æ³•ï¼š</p></blockquote><h2 id="Swoole-HTTPæœåŠ¡å™¨"><a href="#Swoole-HTTPæœåŠ¡å™¨" class="headerlink" title="Swoole HTTPæœåŠ¡å™¨"></a>Swoole HTTPæœåŠ¡å™¨</h2><p>Swoole1.7.7å¢åŠ äº†å†…ç½®HTTPæœåŠ¡å™¨çš„æ”¯æŒï¼Œä½¿ç”¨äº†è·ŸNginXä¸€æ ·çš„IOå¤šè·¯å¤ç”¨æœºåˆ¶epollï¼Œå¯ä»¥è¾¾åˆ°NginXçº§åˆ«çš„æ€§èƒ½ï¼Œå¹¶ä¸”åªéœ€å‡ è¡Œä»£ç å³å¯å†™å‡ºä¸€ä¸ªå¼‚æ­¥éé˜»å¡å¤šè¿›ç¨‹çš„HTTPæœåŠ¡å™¨ï¼ˆepollå±äºåŒæ­¥éé˜»å¡ï¼Œè¿™é‡Œè¯´â€œå¼‚æ­¥éé˜»å¡â€ä¸»è¦æ˜¯å› ä¸ºâ€œå¤šè¿›ç¨‹â€ï¼Œå•ä¸ªè¿›ç¨‹å†…éƒ¨ä¾ç„¶æ˜¯åŒæ­¥éé˜»å¡ï¼‰ã€‚</p><a id="more"></a><p>å¼€å¯ä¸€ä¸ªSwoole HTTPæœåŠ¡å™¨çš„é¢å‘å¯¹è±¡ç¼–ç¨‹ä»£ç æ ·æ¿å¤§è‡´å¦‚ä¸‹ï¼ˆå…·ä½“å‚è€ƒSwooleå®˜æ–¹æ–‡æ¡£<a href="https://wiki.swoole.com/wiki/page/326.html" target="_blank" rel="noopener">HttpServer</a>ï¼‰ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $app;</span><br><span class="line">    <span class="keyword">public</span> $server;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host, $port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;server = <span class="keyword">new</span> \swoole_http_server($host, $port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// $this-&gt;server-&gt;on('start', array($this, 'onStart'));</span></span><br><span class="line">        <span class="comment">// $this-&gt;server-&gt;on('shutdown', array($this, 'onShutdown'));</span></span><br><span class="line">        <span class="comment">// $this-&gt;server-&gt;on('workerStop', array($this, 'onWorkerStop'));</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;server-&gt;on(<span class="string">'workerStart'</span>, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'onWorkerStart'</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;server-&gt;on(<span class="string">'request'</span>, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'onRequest'</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;server-&gt;start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onWorkerStart</span><span class="params">($serv, $worker_id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åº”ç”¨åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;app = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(\swoole_http_request $request,\swoole_http_response $response)</span> </span>&#123;</span><br><span class="line">        $app = <span class="keyword">$this</span>-&gt;app;</span><br><span class="line">        <span class="comment">// å¤„ç†ç”¨æˆ·è¯·æ±‚</span></span><br><span class="line">        $get = json_encode($request-&gt;get);</span><br><span class="line">        <span class="comment">// å“åº”ç”¨æˆ·è¯·æ±‚</span></span><br><span class="line">        $response-&gt;end(<span class="string">"App is &#123;$app&#125;. Get &#123;$get&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$s = <span class="keyword">new</span> Service(<span class="string">"127.0.0.1"</span>, <span class="number">9080</span>);</span><br><span class="line">$s-&gt;start();</span><br></pre></td></tr></table></figure><p>ç›´æ¥ç”¨<code>php</code>å‘½ä»¤æ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œæµè§ˆå™¨è®¿é—®<code>http://127.0.0.1:9080</code>ï¼Œä¼šå¾—åˆ°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">App is 1. Get null</span><br></pre></td></tr></table></figure><p>æµè§ˆå™¨è®¿é—®<code>http://127.0.0.1:9080/?user=guest</code>ï¼Œä¼šå¾—åˆ°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">App is 1. Get &#123;&quot;user&quot;:&quot;guest&quot;&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚</p><h2 id="åŠ è½½Lumené¡¹ç›®"><a href="#åŠ è½½Lumené¡¹ç›®" class="headerlink" title="åŠ è½½Lumené¡¹ç›®"></a>åŠ è½½Lumené¡¹ç›®</h2><p>Lumené¡¹ç›®çš„å…¥å£æ–‡ä»¶æ˜¯é¡¹ç›®è·¯å¾„ä¸‹çš„<code>public/index.php</code>ï¼Œé‡Œé¢åªæœ‰ç®€å•çš„ä¸¤è¡Œä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$app = <span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</span><br><span class="line">$app-&gt;run();</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œä»£ç å°±æ˜¯åŠ è½½æ•´ä¸ªLumenæ¡†æ¶ä»£ç ï¼Œç¬¬äºŒè¡Œä»£ç åˆ™æ˜¯å¤„ç†è¯·æ±‚ï¼Œç”Ÿæˆå“åº”ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨Swoole HTTPæœåŠ¡å™¨ä¸­åŠ è½½Lumené¡¹ç›®ï¼Œä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€ä¿®æ”¹<code>onWorkerStart</code>æ–¹æ³•ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onWorkerStart</span><span class="params">($serv, $worker_id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åº”ç”¨åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;app = <span class="keyword">require</span> <span class="string">'/THE/FULL/PATH/TO/bootstrap/app.php'</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="å¤„ç†ç”¨æˆ·è¯·æ±‚"><a href="#å¤„ç†ç”¨æˆ·è¯·æ±‚" class="headerlink" title="å¤„ç†ç”¨æˆ·è¯·æ±‚"></a>å¤„ç†ç”¨æˆ·è¯·æ±‚</h2><p>è™½ç„¶å¯ä»¥åŠ è½½Lumenæ¡†æ¶ï¼Œä½†æ˜¯è¦æ€æ ·æ‰èƒ½ç”¨Lumenæ¡†æ¶æ¥å¤„ç†ç”¨æˆ·è¯·æ±‚å‘¢ï¼Ÿ</p><p>ç”±äºLumenæ¡†æ¶çš„è§£è€¦ç¨‹åº¦éå¸¸é«˜ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾åœ°å°†<code>swoole_http_request</code>å¯¹è±¡<code>$request</code>ï¼Œè½¬æ¢æˆLumenæ¡†æ¶ç†Ÿæ‚‰çš„<code>Illuminate\Http\Request</code>å¯¹è±¡ï¼Œè¿™æ ·Lumenæ¡†æ¶å°±èƒ½å¤„ç†ç”¨æˆ·è¯·æ±‚äº†ã€‚<br>è¿™é‡Œå®ç°ä¸€ä¸ª<code>parseRequest</code>æ–¹æ³•ï¼Œæ¥æ”¶<code>swoole_http_request</code>ç±»å‚æ•°ï¼Œè¿”å›<code>\Illuminate\Http\Request</code>ç±»ç»“æœï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseRequest</span><span class="params">(\swoole_http_request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $get     = <span class="keyword">isset</span>($request-&gt;get) ? $request-&gt;get : <span class="keyword">array</span>();</span><br><span class="line">        $post    = <span class="keyword">isset</span>($request-&gt;post) ? $request-&gt;post : <span class="keyword">array</span>();</span><br><span class="line">        $cookie  = <span class="keyword">isset</span>($request-&gt;cookie) ? $request-&gt;cookie : <span class="keyword">array</span>();</span><br><span class="line">        $server  = <span class="keyword">isset</span>($request-&gt;server) ? $request-&gt;server : <span class="keyword">array</span>();</span><br><span class="line">        $header  = <span class="keyword">isset</span>($request-&gt;header) ? $request-&gt;header : <span class="keyword">array</span>();</span><br><span class="line">        $files   = <span class="keyword">isset</span>($request-&gt;files) ? $request-&gt;files : <span class="keyword">array</span>();</span><br><span class="line">        $fastcgi = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">        $new_server = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">foreach</span> ($server <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            $new_server[strtoupper($key)] = $value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> ($header <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            $new_server[<span class="string">'HTTP_'</span> . strtoupper($key)] = $value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $content = $request-&gt;rawContent() ?: <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        $http_request = <span class="keyword">new</span> \Illuminate\Http\Request($get, $post, $fastcgi, $cookie, $files, $new_server, $content);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $http_request;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆè¯·æ±‚å“åº”"><a href="#ç”Ÿæˆè¯·æ±‚å“åº”" class="headerlink" title="ç”Ÿæˆè¯·æ±‚å“åº”"></a>ç”Ÿæˆè¯·æ±‚å“åº”</h2><p>Lumenæ¡†æ¶å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œååˆ†æ–¹ä¾¿ï¼Œåªéœ€è°ƒç”¨åº”ç”¨çš„<code>dispatch</code>æ–¹æ³•å³å¯ã€‚ä¸è¿‡<code>dispatch</code>æ–¹æ³•è¿”å›ç»“æœä¸€èˆ¬æ˜¯<code>Symfony\Component\HttpFoundation\Response</code>å¯¹è±¡ï¼Œéœ€è¦åšä¸€äº›è½¬åŒ–æ‰èƒ½äº¤ç”±<code>swoole_http_response</code>å¯¹è±¡ç»™ç”¨æˆ·è¾“å‡ºå“åº”ã€‚<br>è¿™é‡Œå®ç°ä¸€ä¸ª<code>makeResponse</code>æ–¹æ³•ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseRequest</span><span class="params">(\swoole_http_response $request, \Symfony\Component\HttpFoundation\Response $http_response)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// status</span></span><br><span class="line">        $response-&gt;status($http_response-&gt;getStatusCode());</span><br><span class="line">        <span class="comment">// headers</span></span><br><span class="line">        <span class="keyword">foreach</span> ($http_response-&gt;headers-&gt;allPreserveCase() <span class="keyword">as</span> $name =&gt; $values) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($values <span class="keyword">as</span> $value) &#123;</span><br><span class="line">                $response-&gt;header($name, $value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// cookies</span></span><br><span class="line">        <span class="keyword">foreach</span> ($http_response-&gt;headers-&gt;getCookies() <span class="keyword">as</span> $cookie) &#123;</span><br><span class="line">            $response-&gt;rawcookie(</span><br><span class="line">                $cookie-&gt;getName(),</span><br><span class="line">                $cookie-&gt;getValue(),</span><br><span class="line">                $cookie-&gt;getExpiresTime(),</span><br><span class="line">                $cookie-&gt;getPath(),</span><br><span class="line">                $cookie-&gt;getDomain(),</span><br><span class="line">                $cookie-&gt;isSecure(),</span><br><span class="line">                $cookie-&gt;isHttpOnly()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// content</span></span><br><span class="line">        $content = $http_response-&gt;getContent();</span><br><span class="line">        <span class="comment">// send content</span></span><br><span class="line">        $response-&gt;end($content);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº†<code>parseRequest</code>æ–¹æ³•å’Œ<code>makeResponse</code>æ–¹æ³•ï¼Œè¦å®ç°ä»¥Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®æ¥å¤„ç†ç”¨æˆ·è¯·æ±‚åªè¦å‡ è¡Œä»£ç ã€‚<code>onRequest</code>æ–¹æ³•è¿™æ ·ä¿®æ”¹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(\swoole_http_request $request,\swoole_http_response $response)</span> </span>&#123;</span><br><span class="line">        $app = <span class="keyword">$this</span>-&gt;app;</span><br><span class="line">        <span class="comment">// å¤„ç†ç”¨æˆ·è¯·æ±‚</span></span><br><span class="line">        $http_request = <span class="keyword">$this</span>-&gt;parseRequest($request);</span><br><span class="line">        $http_response = $app-&gt;dispatch($http_request);</span><br><span class="line">        <span class="comment">// å“åº”ç”¨æˆ·è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;makeResponse($response, $http_response);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å°±è¿™æ ·ï¼Œä¸éœ€è¦ä¿®æ”¹Lumené¡¹ç›®åŸæœ¬ä»»ä½•ä»£ç ï¼Œå°±èƒ½è®©å…¶è¿è¡Œåœ¨Swoole HTTPæœåŠ¡å™¨ä¸Šã€‚<br>å½“ç„¶ï¼Œç”¨æˆ·è¯·æ±‚å„ç§å„æ ·ï¼Œæœ‰è¯·æ±‚æ–‡ä»¶ä¸Šä¼ ï¼Œæœ‰è¯·æ±‚é™æ€èµ„æºç­‰ç­‰ï¼›å“åº”ç±»å‹ä¹Ÿæ˜¯å„ç§å„æ ·ï¼Œæœ‰Gzipå‹ç¼©ï¼Œæœ‰JSONæ ¼å¼ï¼Œæœ‰è®¾ç½®Cookieç­‰å¾…ã€‚è¦å®ç°ä¸€ä¸ªå¥å…¨çš„<code>Swoole+Lumen</code>ç½‘å…³æœåŠ¡ï¼Œä»¥ä¸Šä»£ç è¿˜é¡»æ›´å¤šä¼˜åŒ–ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ<a href="https://github.com/breeze2/lumen-swoole-http" target="_blank" rel="noopener">Service.php</a>ã€‚</p><blockquote><p>æŒ‰ç…§ä»¥ä¸Šæ€è·¯ï¼Œè¦å®ç°ä»¥Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLaravelé¡¹ç›®ä¹Ÿä¸éš¾ï¼Œä¸è¿‡ï¼Œä¸ºäº†æ•ˆç‡é€‰æ‹©Swooleï¼Œè‡ªç„¶ä¼šä¸ºäº†æ•ˆç‡é€‰æ‹©Lumenè€Œä¸æ˜¯Laravelã€‚</p></blockquote><p><a href="https://blog.breezelin.cn/swoole-lumen-use-async-mysql-client-in-lumen.html" target="_blank" rel="noopener">ä¸‹ä¸€ç¯‡æ–‡ç« </a>ä»‹ç»å¦‚ä½•åœ¨Lumenä¸­ä½¿ç”¨å¼‚æ­¥MySQLå®¢æˆ·ç«¯ï¼Œå‡å°‘IOé˜»å¡ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;LNMPè™½æ˜¯ä¼ ç»Ÿçš„Webåº”ç”¨æ¶æ„ç»„åˆï¼Œæ— å¥ˆNginX + PHP-FPMçš„æ­é…è¿è¡Œæ•ˆç‡å®åœ¨å¤ªä½ï¼›è€ŒSwoole HTTPæœåŠ¡å™¨å…·æœ‰NginXçº§åˆ«çš„æ€§èƒ½ï¼Œä¸”æœ¬èº«åµŒå…¥åœ¨PHPä¸­ï¼Œå®Œå…¨å¯ä»¥æ›¿ä»£NginX + PHP-FPMã€‚äºæ˜¯ä¸€ç›´åœ¨æ¢ç´¢ç”¨Swoole HTTPæœåŠ¡å™¨è¿è¡Œä¼ ç»ŸPHPåº”ç”¨çš„é€”å¾„ã€‚è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹Swoole HTTPæœåŠ¡å™¨è¿è¡ŒLumené¡¹ç›®çš„å®ç°æ–¹æ³•ï¼š&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Swoole-HTTPæœåŠ¡å™¨&quot;&gt;&lt;a href=&quot;#Swoole-HTTPæœåŠ¡å™¨&quot; class=&quot;headerlink&quot; title=&quot;Swoole HTTPæœåŠ¡å™¨&quot;&gt;&lt;/a&gt;Swoole HTTPæœåŠ¡å™¨&lt;/h2&gt;&lt;p&gt;Swoole1.7.7å¢åŠ äº†å†…ç½®HTTPæœåŠ¡å™¨çš„æ”¯æŒï¼Œä½¿ç”¨äº†è·ŸNginXä¸€æ ·çš„IOå¤šè·¯å¤ç”¨æœºåˆ¶epollï¼Œå¯ä»¥è¾¾åˆ°NginXçº§åˆ«çš„æ€§èƒ½ï¼Œå¹¶ä¸”åªéœ€å‡ è¡Œä»£ç å³å¯å†™å‡ºä¸€ä¸ªå¼‚æ­¥éé˜»å¡å¤šè¿›ç¨‹çš„HTTPæœåŠ¡å™¨ï¼ˆepollå±äºåŒæ­¥éé˜»å¡ï¼Œè¿™é‡Œè¯´â€œå¼‚æ­¥éé˜»å¡â€ä¸»è¦æ˜¯å› ä¸ºâ€œå¤šè¿›ç¨‹â€ï¼Œå•ä¸ªè¿›ç¨‹å†…éƒ¨ä¾ç„¶æ˜¯åŒæ­¥éé˜»å¡ï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æ±‚ç´¢" scheme="https://breeze2.github.io/blog/categories/%E6%B1%82%E7%B4%A2/"/>
    
    
      <category term="php" scheme="https://breeze2.github.io/blog/tags/php/"/>
    
      <category term="swoole" scheme="https://breeze2.github.io/blog/tags/swoole/"/>
    
      <category term="lumen" scheme="https://breeze2.github.io/blog/tags/lumen/"/>
    
      <category term="think" scheme="https://breeze2.github.io/blog/tags/think/"/>
    
  </entry>
  
  <entry>
    <title>æ­å»ºDocker Registryç§æœ‰é•œåƒä»“åº“</title>
    <link href="https://breeze2.github.io/blog/practice-docker-registry.html"/>
    <id>https://breeze2.github.io/blog/practice-docker-registry.html</id>
    <published>2018-01-16T11:01:06.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://store.docker.com/" target="_blank" rel="noopener">Docker Store</a>æ˜¯Dockerå®˜æ–¹æä¾›çš„å…¬å…±çš„é•œåƒä»“åº“ï¼Œä½†æœ‰æ—¶ä¼šéœ€è¦åœ¨å±€éƒ¨å†…å…±äº«é•œåƒï¼Œé‚£ä¹ˆå¯ä»¥åˆ©ç”¨<a href="https://docs.docker.com/registry/" target="_blank" rel="noopener">Docker Registry</a>å·¥å…·æ­å»ºä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ã€‚</p><p>ç›´æ¥è¿è¡Œå®˜æ–¹<a href="https://store.docker.com/images/registry" target="_blank" rel="noopener">registry</a>é•œåƒï¼Œå³å¯å¼€å¯é•œåƒä»“åº“æœåŠ¡ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p <span class="number">5000</span>:<span class="number">5000</span> --restart=always --name registry registry</span><br></pre></td></tr></table></figure><p>è‹¥è¦å®šåˆ¶ä½¿ç”¨ï¼Œè¿˜éœ€æ›´å¤šé…ç½®ã€‚</p><a id="more"></a><h2 id="Dockerå®‰è£…"><a href="#Dockerå®‰è£…" class="headerlink" title="Dockerå®‰è£…"></a>Dockerå®‰è£…</h2><p>ç®€å•ä»‹ç»ä¸€ä¸‹Dockerçš„å®‰è£…ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install -y docker-ce</span><br><span class="line">$ sudo apt-get install -y docker-compose</span><br><span class="line">$ sudo usermod -aG docker $&#123;USER&#125;</span><br></pre></td></tr></table></figure><h2 id="Docker-Composeå®‰è£…"><a href="#Docker-Composeå®‰è£…" class="headerlink" title="Docker Composeå®‰è£…"></a>Docker Composeå®‰è£…</h2><p>Docker Composeçš„å®‰è£…ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo curl -L https://github.com/docker/compose/releases/download/<span class="number">1</span>.<span class="number">18</span>.<span class="number">0</span>/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><span class="line">$ sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><h2 id="Docker-Composeç¼–æ’"><a href="#Docker-Composeç¼–æ’" class="headerlink" title="Docker Composeç¼–æ’"></a>Docker Composeç¼–æ’</h2><p>è¿›å…¥å·¥ä½œç›®å½•ï¼Œç¼–è¾‘<code>docker-compose.yml</code>ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/workspace</span><br><span class="line">$ <span class="built_in">cd</span> docker/registry</span><br><span class="line">$ vi docker-compose.yml</span><br></pre></td></tr></table></figure><p>åŸºäºå®˜æ–¹é•œåƒ<code>registry</code>åˆ¶ä½œï¼Œ<code>/etc/docker/registry</code>æ˜¯å®¹å™¨å†…é…ç½®ä¿¡æ¯è·¯å¾„ï¼Œæ˜ å°„åˆ°æœ¬åœ°<code>./config</code>ï¼›<code>/var/lib/registry</code>æ˜¯å®¹å™¨å†…æ•°æ®ä¿å­˜è·¯å¾„ï¼Œæ˜ å°„åˆ°æœ¬åœ°<code>./data</code>ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  registry:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"5000:5000"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./config:/etc/docker/registry"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./data:/var/lib/registry"</span></span><br></pre></td></tr></table></figure><h2 id="Docker-Registryé…ç½®"><a href="#Docker-Registryé…ç½®" class="headerlink" title="Docker Registryé…ç½®"></a>Docker Registryé…ç½®</h2><p>è®¾ç½®HTTPè®¤è¯ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p config/auth</span><br><span class="line">$ htpasswd -Bbn $USERNAME $PASSWORD &gt; ./config/auth/htpasswd # or</span><br><span class="line">$ docker run --rm --entrypoint htpasswd registry -Bbn $USERNAME $PASSWORD &gt; ./config/auth/htpasswd</span><br></pre></td></tr></table></figure><p>é…ç½®Registryï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vi config/config.yml</span><br></pre></td></tr></table></figure><p><code>config/config.yml</code>ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line"><span class="attr">  fields:</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  cache:</span></span><br><span class="line"><span class="attr">    blobdescriptor:</span> <span class="string">inmemory</span></span><br><span class="line"><span class="attr">  filesystem:</span></span><br><span class="line"><span class="attr">    rootdirectory:</span> <span class="string">/var/lib/registry</span></span><br><span class="line"><span class="attr">auth:</span></span><br><span class="line"><span class="attr">  htpasswd:</span></span><br><span class="line"><span class="attr">    realm:</span> <span class="string">basic-realm</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/docker/registry/auth/htpasswd</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line"><span class="attr">  addr:</span> <span class="string">:5000</span></span><br><span class="line"><span class="attr">  headers:</span></span><br><span class="line"><span class="attr">    X-Content-Type-Options:</span> <span class="string">[nosniff]</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line"><span class="attr">  storagedriver:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">    threshold:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><h2 id="è¿è¡Œä¸æµ‹è¯•"><a href="#è¿è¡Œä¸æµ‹è¯•" class="headerlink" title="è¿è¡Œä¸æµ‹è¯•"></a>è¿è¡Œä¸æµ‹è¯•</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose up -d</span><br><span class="line">$ docker login <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">5000</span></span><br><span class="line">$ docker pull ubuntu:<span class="number">16</span>.<span class="number">04</span></span><br><span class="line">$ docker tag ubuntu:<span class="number">16</span>.<span class="number">04</span> <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>/username/ubuntu:<span class="number">16</span>.<span class="number">04</span></span><br><span class="line">$ docker push <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>/username/ubuntu:<span class="number">16</span>.<span class="number">04</span></span><br><span class="line">$ docker pull <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>/username/ubuntu:<span class="number">16</span>.<span class="number">04</span></span><br><span class="line">$ docker logout</span><br><span class="line">$ docker push <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>/username/ubuntu:<span class="number">16</span>.<span class="number">04</span></span><br></pre></td></tr></table></figure><h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="*HTTPS"></a>*HTTPS</h2><p>è™½ç„¶Docker Registryé»˜è®¤ç›‘å¬ç«¯å£æ˜¯<code>5000</code>ï¼Œä½†å®é™…ä¸ŠæœåŠ¡æ˜¯åŸºäºHTTPï¼Œå¯ä»¥é€šè¿‡HTTPSä¿éšœä¼ è¾“æ•°æ®å®‰å…¨ã€‚Dockeré»˜è®¤ä¸å…è®¸éHTTPSè¿æ¥ä¸‹æ¨é€é•œåƒï¼ˆ<code>127.0.0.1</code>æœ¬åœ°ç½‘ç»œåœ°å€ä¾‹å¤–ï¼‰ï¼Œè¦å–æ¶ˆè¿™ä¸ªé™åˆ¶é¡»ä¿®æ”¹Dockeré…ç½®â€”â€”æ¯”å¦‚è¿æ¥<code>192.168.1.1:5000</code>æœåŠ¡ï¼Œåœ¨<code>/etc/default/docker</code>æ–‡ä»¶ä¸­æ·»åŠ <code>DOCKER_OPTS=&quot;--insecure-registries=192.168.1.1:5000&quot;</code>ï¼Œç„¶åé‡å¯Dockerï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service docker restart</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæœ€å¥½è¿˜æ˜¯ç»™Docker Registryè®¾ç½®HTTPSï¼šå¯ä»¥ç”¨NginXä»£ç†æœ¬åœ°<code>5000</code>ç«¯å£ï¼Œç„¶ååœ¨NginXä¸Šè®¾ç½®HTTPSï¼›ä¹Ÿå¯ä»¥åœ¨Docker Registryå†…éƒ¨è®¾ç½®HTTPSï¼Œè¯¦ç»†è¿‡ç¨‹è¯·é˜…è¯»<br><a href="https://yeasy.gitbooks.io/docker_practice/content/repository/registry_auth.html" target="_blank" rel="noopener">ã€Šç§æœ‰ä»“åº“é«˜çº§é…ç½®ã€‹</a>ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://docs.docker.com/registry/deploying/" target="_blank" rel="noopener">Deploy a registry server</a></li><li><a href="https://docs.docker.com/registry/configuration/" target="_blank" rel="noopener">Configuring a registry</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://store.docker.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Docker Store&lt;/a&gt;æ˜¯Dockerå®˜æ–¹æä¾›çš„å…¬å…±çš„é•œåƒä»“åº“ï¼Œä½†æœ‰æ—¶ä¼šéœ€è¦åœ¨å±€éƒ¨å†…å…±äº«é•œåƒï¼Œé‚£ä¹ˆå¯ä»¥åˆ©ç”¨&lt;a href=&quot;https://docs.docker.com/registry/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Docker Registry&lt;/a&gt;å·¥å…·æ­å»ºä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ã€‚&lt;/p&gt;
&lt;p&gt;ç›´æ¥è¿è¡Œå®˜æ–¹&lt;a href=&quot;https://store.docker.com/images/registry&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;registry&lt;/a&gt;é•œåƒï¼Œå³å¯å¼€å¯é•œåƒä»“åº“æœåŠ¡ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight cmd&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ docker run -d -p &lt;span class=&quot;number&quot;&gt;5000&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;5000&lt;/span&gt; --restart=always --name registry registry&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;è‹¥è¦å®šåˆ¶ä½¿ç”¨ï¼Œè¿˜éœ€æ›´å¤šé…ç½®ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
      <category term="docker" scheme="https://breeze2.github.io/blog/tags/docker/"/>
    
      <category term="registry" scheme="https://breeze2.github.io/blog/tags/registry/"/>
    
  </entry>
  
  <entry>
    <title>æºç å®‰è£…GitLabï¼ˆMySQL &amp; HTTPSï¼‰</title>
    <link href="https://breeze2.github.io/blog/practice-gitlab-installation-from-source.html"/>
    <id>https://breeze2.github.io/blog/practice-gitlab-installation-from-source.html</id>
    <published>2018-01-12T18:26:13.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<p>ä»‹ç»ä¸€ä¸‹åœ¨Ubuntu16.04ç³»ç»Ÿä¸‹æºç å®‰è£…GitLab10.04ä¸”ä»¥MySQLä½œä¸ºæ•°æ®åº“ã€SSLåŠ å¯†ä¼ è¾“çš„æ­¥éª¤ï¼š</p><a id="more"></a><h2 id="å¼€å§‹"><a href="#å¼€å§‹" class="headerlink" title="å¼€å§‹"></a>å¼€å§‹</h2><h3 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h3><p>å®‰è£…ä¾èµ–ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libre2-dev libreadline-dev libncurses5-dev libffi-dev curl openssh-server checkinstall libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev logrotate rsync python-docutils pkg-config cmake</span><br></pre></td></tr></table></figure><p>ä¸ºGitLabåˆ›å»ºä¸€ä¸ªç³»ç»Ÿç”¨æˆ·gitï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo adduser --disabled-login --gecos 'GitLab' git</span><br></pre></td></tr></table></figure><p>$ sudo apt-get install -y postfix</p><h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><p>å®‰è£…æœ€æ–°ç‰ˆGitï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo add-apt-repository ppa:git-core/ppa</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install git</span><br></pre></td></tr></table></figure><h3 id="Ruby"><a href="#Ruby" class="headerlink" title="Ruby"></a>Ruby</h3><p>å®‰è£…æœ€æ–°ç‰ˆRubyï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-add-repository ppa:brightbox/ruby-ng</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install ruby</span><br><span class="line">$ sudo apt-get install ruby-dev</span><br></pre></td></tr></table></figure><p>å®‰è£…Bundlerï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo gem install bundler --no-ri --no-rdoc</span><br></pre></td></tr></table></figure><h3 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h3><p>å®‰è£…Go1.9.2ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl --remote-name --progress https://dl.google.com/go/go1.<span class="number">9</span>.<span class="number">2</span>.linux-amd64.tar.gz</span><br><span class="line">$ sudo tar -C /usr/local -xzf go1.<span class="number">9</span>.<span class="number">2</span>.linux-amd64.tar.gz</span><br><span class="line">$ sudo ln -sf /usr/local/go/bin/&#123;go,godoc,gofmt&#125; /usr/local/bin/</span><br><span class="line">$ rm go1.<span class="number">9</span>.<span class="number">2</span>.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>å®‰è£…NodeJS8.xï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl --location https://deb.nodesource.com/setup_8.x | sudo bash -</span><br><span class="line">$ sudo apt-get install -y nodejs</span><br></pre></td></tr></table></figure><p>å®‰è£…yarnï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl --silent --show-error https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -</span><br><span class="line"><span class="built_in">echo</span> "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install yarn</span><br></pre></td></tr></table></figure><h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>å®‰è£…MySQL5.7ï¼Œå…ˆä»<a href="https://dev.mysql.com/downloads/repo/apt/" target="_blank" rel="noopener">MySQLå®˜ç½‘</a>ä¸‹è½½APTé…ç½®å™¨(mysql-apt-config_0.8.9-1_all.deb)[<a href="https://dev.mysql.com/downloads/file/?id=474129]ï¼Œç„¶åï¼š" target="_blank" rel="noopener">https://dev.mysql.com/downloads/file/?id=474129]ï¼Œç„¶åï¼š</a></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dpkg -i mysql-apt-config_0.<span class="number">8</span>.<span class="number">9</span>-<span class="number">1</span>_all.deb</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install -y mysql-server mysql-client libmysqlclient-dev</span><br></pre></td></tr></table></figure><p>MySQLå®‰å…¨é…ç½®ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ </span><br><span class="line">$ mysql --version</span><br><span class="line">$ sudo mysql_secure_installation</span><br></pre></td></tr></table></figure><p>åˆ›å»ºGitLabç”¨æˆ·å’Œæ•°æ®åº“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u root -p</span><br><span class="line">mysql&gt; CREATE USER &apos;git&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;$password&apos;;</span><br><span class="line"></span><br><span class="line"># Create the GitLab production database</span><br><span class="line">mysql&gt; CREATE DATABASE IF NOT EXISTS `gitlabhq_production` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_general_ci`;</span><br><span class="line"></span><br><span class="line"># Grant the GitLab user necessary permissions on the database</span><br><span class="line">mysql&gt; GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, CREATE TEMPORARY TABLES, DROP, INDEX, ALTER, LOCK TABLES, REFERENCES, TRIGGER ON `gitlabhq_production`.* TO &apos;git&apos;@&apos;localhost&apos;;</span><br><span class="line"></span><br><span class="line"># Quit the database session</span><br><span class="line">mysql&gt; \q</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®æ•°æ®åº“ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H mysql -u git -p -D gitlabhq_production</span><br></pre></td></tr></table></figure><h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>å®‰è£…Redis3.0.6ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install redis</span><br></pre></td></tr></table></figure><h3 id="GitLab"><a href="#GitLab" class="headerlink" title="GitLab"></a>GitLab</h3><h4 id="å…‹éš†GitLabæºç "><a href="#å…‹éš†GitLabæºç " class="headerlink" title="å…‹éš†GitLabæºç "></a>å…‹éš†GitLabæºç </h4><p>å…‹éš†GitLabæºç ï¼Œå¹¶é…ç½®GitLabï¼ˆä¿®æ”¹åŸŸåç­‰ç­‰ï¼‰ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/git</span><br><span class="line">$ sudo -u git -H git clone https://gitlab.com/gitlab-org/gitlab-ce.git -b <span class="number">10</span>-<span class="number">4</span>-stable gitlab</span><br><span class="line">$ <span class="built_in">cd</span> /home/git/gitlab</span><br><span class="line">$ sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml</span><br><span class="line">$ sudo -u git -H vi config/gitlab.yml</span><br></pre></td></tr></table></figure><h4 id="é…ç½®GitLab"><a href="#é…ç½®GitLab" class="headerlink" title="é…ç½®GitLab"></a>é…ç½®GitLab</h4><p>é…ç½®å¯†é’¥æ–‡ä»¶ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H cp config/secrets.yml.example config/secrets.yml</span><br><span class="line">$ sudo -u git -H chmod <span class="number">0600</span> config/secrets.yml</span><br></pre></td></tr></table></figure><p>é…ç½®Unicornï¼ˆä¿®æ”¹ç›‘å¬ç«¯å£ç­‰ç­‰ï¼‰ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H cp config/unicorn.rb.example config/unicorn.rb</span><br><span class="line">$ sudo -u git -H vi config/unicorn.rb</span><br></pre></td></tr></table></figure><p>è®¾ç½®ç›®å½•æƒé™ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chown -R git log/</span><br><span class="line">$ sudo chown -R git tmp/</span><br><span class="line">$ sudo chmod -R u+rwX,go-w log/</span><br><span class="line">$ sudo chmod -R u+rwX tmp/</span><br><span class="line"></span><br><span class="line">$ sudo chmod -R u+rwX tmp/pids/</span><br><span class="line">$ sudo chmod -R u+rwX tmp/sockets/</span><br><span class="line"></span><br><span class="line">$ sudo -u git -H <span class="built_in">mkdir</span> public/uploads/</span><br><span class="line">$ sudo chmod <span class="number">0700</span> public/uploads</span><br><span class="line"></span><br><span class="line">$ sudo chmod -R u+rwX builds/</span><br><span class="line">$ sudo chmod -R u+rwX shared/artifacts/</span><br><span class="line">$ sudo chmod -R ug+rwX shared/pages/</span><br></pre></td></tr></table></figure><p>é…ç½®Rack Attackï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb</span><br></pre></td></tr></table></figure><p>é…ç½®Resqueï¼ˆä¿®æ”¹Redisé“¾æ¥ç­‰ç­‰ï¼‰ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H cp config/resque.yml.example config/resque.yml</span><br><span class="line">$ sudo -u git -H vi config/resque.yml</span><br></pre></td></tr></table></figure><p>é…ç½®Gitç”¨æˆ·ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Configure Git global settings <span class="keyword">for</span> git user</span><br><span class="line"># 'autocrlf' is needed <span class="keyword">for</span> the web editor</span><br><span class="line">$ sudo -u git -H git config --global core.autocrlf input</span><br><span class="line"></span><br><span class="line"># Disable 'git gc --auto' because GitLab already runs 'git gc' when needed</span><br><span class="line">$ sudo -u git -H git config --global gc.auto <span class="number">0</span></span><br><span class="line"></span><br><span class="line"># Enable packfile bitmaps</span><br><span class="line">$ sudo -u git -H git config --global repack.writeBitmaps true</span><br><span class="line"></span><br><span class="line"># Enable push options</span><br><span class="line">$ sudo -u git -H git config --global receive.advertisePushOptions true</span><br></pre></td></tr></table></figure><h4 id="æ•°æ®åº“è®¾ç½®"><a href="#æ•°æ®åº“è®¾ç½®" class="headerlink" title="æ•°æ®åº“è®¾ç½®"></a>æ•°æ®åº“è®¾ç½®</h4><p>é…ç½®MySQLï¼ˆä¿®æ”¹è´¦æˆ·å¯†ç ç­‰ç­‰ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git cp config/database.yml.mysql config/database.yml</span><br><span class="line">$ sudo -u git -H chmod o-rwx config/database.yml</span><br><span class="line">$ sudo -u git -H vi config/database.yml</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Gems"><a href="#å®‰è£…Gems" class="headerlink" title="å®‰è£…Gems"></a>å®‰è£…Gems</h4><p>å®‰è£…Gemsï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">If</span> you use MySQL (note, the option says "without ... postgres")</span><br><span class="line"># <span class="keyword">If</span> you want to use Kerberos <span class="keyword">for</span> user authentication, then omit kerberos <span class="keyword">in</span> the --without option</span><br><span class="line">$ sudo -u git -H bundle install --deployment --without development test postgres aws kerberos</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…GitLab-Shell"><a href="#å®‰è£…GitLab-Shell" class="headerlink" title="å®‰è£…GitLab Shell"></a>å®‰è£…GitLab Shell</h4><p>å®‰è£…GitLab Shellï¼Œå¹¶é…ç½®ï¼ˆä¿®æ”¹GitLabé“¾æ¥ç­‰ç­‰ï¼‰ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Run the installation task <span class="keyword">for</span> gitlab-shell (<span class="built_in">replace</span> `REDIS_URL` <span class="keyword">if</span> needed):</span><br><span class="line">$ sudo -u git -H bundle exec rake gitlab:shell:install RAILS_ENV=production SKIP_STORAGE_VALIDATION=true</span><br><span class="line"></span><br><span class="line"># By default, the gitlab-shell config is generated from your main GitLab config.</span><br><span class="line"># You can review (and modify) the gitlab-shell config as follows:</span><br><span class="line">$ sudo -u git -H vi /home/git/gitlab-shell/config.yml</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Gitlab-Workhorse"><a href="#å®‰è£…Gitlab-Workhorse" class="headerlink" title="å®‰è£…Gitlab Workhorse"></a>å®‰è£…Gitlab Workhorse</h4><p>å®‰è£…Gitlab Workhorseï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H bundle exec rake "gitlab:workhorse:install[/home/git/gitlab-workhorse]" RAILS_ENV=production</span><br><span class="line"></span><br><span class="line">$ sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production GITLAB_ROOT_PASSWORD='$root_password' GITLAB_ROOT_EMAIL='$root_email'</span><br></pre></td></tr></table></figure><h4 id="secrets-yml"><a href="#secrets-yml" class="headerlink" title="secrets.yml"></a>secrets.yml</h4><p><code>/home/git/gitlab/config/secrets.yml</code>æ–‡ä»¶å­˜å‚¨ç€å„ç±»æ•°æ®åŠ å¯†çš„é’¥åŒ™ï¼Œåº”å¤‡ä»½åœ¨ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹ã€‚</p><h4 id="å®‰è£…å¯åŠ¨è„šæœ¬"><a href="#å®‰è£…å¯åŠ¨è„šæœ¬" class="headerlink" title="å®‰è£…å¯åŠ¨è„šæœ¬"></a>å®‰è£…å¯åŠ¨è„šæœ¬</h4><p>å®‰è£…åœ¨ç³»ç»Ÿä¸­å¯åŠ¨GitLabæœåŠ¡çš„è„šæ­¥ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab</span><br><span class="line">$ sudo cp lib/support/init.d/gitlab.default.example /etc/default/gitlab</span><br><span class="line">$ sudo update-rc.d gitlab defaults <span class="number">21</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…Gitaly"><a href="#å®‰è£…Gitaly" class="headerlink" title="å®‰è£…Gitaly"></a>å®‰è£…Gitaly</h4><p>å®‰è£…Gitalyï¼Œå¹¶é…ç½®ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H bundle exec rake "gitlab:gitaly:install[/home/git/gitaly]" RAILS_ENV=production</span><br><span class="line">$ sudo chmod <span class="number">0700</span> /home/git/gitlab/tmp/sockets/private</span><br><span class="line">$ sudo chown git /home/git/gitlab/tmp/sockets/private</span><br><span class="line">$ sudo -u git -H vi /home/git/gitaly/config.toml</span><br></pre></td></tr></table></figure><h4 id="è®¾ç½®Logrotate"><a href="#è®¾ç½®Logrotate" class="headerlink" title="è®¾ç½®Logrotate"></a>è®¾ç½®Logrotate</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab</span><br></pre></td></tr></table></figure><h4 id="ç¼–è¯‘GetText-PO"><a href="#ç¼–è¯‘GetText-PO" class="headerlink" title="ç¼–è¯‘GetText PO"></a>ç¼–è¯‘GetText PO</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H bundle exec rake gettext:compile RAILS_ENV=production</span><br></pre></td></tr></table></figure><h4 id="MySQLå­—ç¬¦ä¸²é™åˆ¶"><a href="#MySQLå­—ç¬¦ä¸²é™åˆ¶" class="headerlink" title="MySQLå­—ç¬¦ä¸²é™åˆ¶"></a>MySQLå­—ç¬¦ä¸²é™åˆ¶</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H bundle exec rake add_limits_mysql RAILS_ENV=production</span><br></pre></td></tr></table></figure><h4 id="ç¼–è¯‘å‰ç«¯èµ„æº"><a href="#ç¼–è¯‘å‰ç«¯èµ„æº" class="headerlink" title="ç¼–è¯‘å‰ç«¯èµ„æº"></a>ç¼–è¯‘å‰ç«¯èµ„æº</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H yarn install --production --pure-lockfile</span><br><span class="line">$ sudo -u git -H bundle exec rake gitlab:assets:compile RAILS_ENV=production NODE_ENV=production</span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨GitLabæœåŠ¡"><a href="#å¯åŠ¨GitLabæœåŠ¡" class="headerlink" title="å¯åŠ¨GitLabæœåŠ¡"></a>å¯åŠ¨GitLabæœåŠ¡</h4><p>å¯åŠ¨æˆ–é‡å¯GitLabæœåŠ¡ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service gitlab <span class="built_in">start</span></span><br><span class="line"># or</span><br><span class="line">$ sudo /etc/init.d/gitlab restart</span><br></pre></td></tr></table></figure><h4 id="è·å–æœåŠ¡é…ç½®"><a href="#è·å–æœåŠ¡é…ç½®" class="headerlink" title="è·å–æœåŠ¡é…ç½®"></a>è·å–æœåŠ¡é…ç½®</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production</span><br></pre></td></tr></table></figure><h4 id="æ£€æµ‹æœåŠ¡çŠ¶æ€"><a href="#æ£€æµ‹æœåŠ¡çŠ¶æ€" class="headerlink" title="æ£€æµ‹æœåŠ¡çŠ¶æ€"></a>æ£€æµ‹æœåŠ¡çŠ¶æ€</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production</span><br></pre></td></tr></table></figure><h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p>å®‰è£…æœ€æ–°ç‰ˆNginXï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo add-apt-repository ppa:nginx/stable</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-install nginx</span><br></pre></td></tr></table></figure><p>é…ç½®NginXä»£ç†ï¼ˆä¿®æ”¹åŸŸåç­‰ç­‰ï¼‰ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp lib/support/nginx/gitlab /etc/nginx/sites-available/gitlab</span><br><span class="line">$ sudo ln -s /etc/nginx/sites-available/gitlab /etc/nginx/sites-enabled/gitlab</span><br><span class="line">$ sudo vi /etc/nginx/sites-available/gitlab</span><br></pre></td></tr></table></figure><p>é‡å¯NginXæœåŠ¡ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service nginx <span class="built_in">start</span></span><br></pre></td></tr></table></figure><h3 id="Letsencrypt"><a href="#Letsencrypt" class="headerlink" title="*Letsencrypt"></a>*Letsencrypt</h3><p>å®‰è£…Letsencryptï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install letsencrypt</span><br></pre></td></tr></table></figure><p>ç”³è¯·å¯†é’¥å’Œè¯ä¹¦ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo letsencrypt sudo letsencrypt certonly --webroot -w /home/git/gitlab/public -d '$domainname'</span><br></pre></td></tr></table></figure><p>é…ç½®NginXä»£ç†ï¼ˆä¿®æ”¹åŸŸåã€å¯†é’¥ä½ç½®ã€è¯ä¹¦ä½ç½®ç­‰ç­‰ï¼‰ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo cp lib/support/nginx/gitlab-ssl /etc/nginx/sites-available/gitlab</span><br><span class="line">sudo ln -s /etc/nginx/sites-available/gitlab /etc/nginx/sites-enabled/gitlab</span><br><span class="line">sudo vi /etc/nginx/sites-available/gitlab</span><br></pre></td></tr></table></figure><p>é‡å¯NginXæœåŠ¡ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service nginx <span class="built_in">start</span></span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://docs.gitlab.com/ce/install/installation.html" target="_blank" rel="noopener">Installation from source</a></li><li><a href="https://docs.gitlab.com/ce/install/database_mysql.html" target="_blank" rel="noopener">Database MySQL</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»‹ç»ä¸€ä¸‹åœ¨Ubuntu16.04ç³»ç»Ÿä¸‹æºç å®‰è£…GitLab10.04ä¸”ä»¥MySQLä½œä¸ºæ•°æ®åº“ã€SSLåŠ å¯†ä¼ è¾“çš„æ­¥éª¤ï¼š&lt;/p&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="mysql" scheme="https://breeze2.github.io/blog/tags/mysql/"/>
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
      <category term="gitlab" scheme="https://breeze2.github.io/blog/tags/gitlab/"/>
    
      <category term="nginx" scheme="https://breeze2.github.io/blog/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Webé¡µé¢ä¸­æ»šåŠ¨ç©¿é€çš„è§£å†³æ–¹æ³•</title>
    <link href="https://breeze2.github.io/blog/hack-scroll-event-propagation.html"/>
    <id>https://breeze2.github.io/blog/hack-scroll-event-propagation.html</id>
    <published>2018-01-08T18:48:30.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åšä¸€ä¸ªç§»åŠ¨ç«¯çš„Webåº”ç”¨ï¼Œå› ä¸ºæ˜¯å•é¡µæ¨¡å¼ï¼Œæ‰€ä»¥å°‘ä¸äº†å„ç§å„æ ·çš„å¼¹å‡ºæ¡†ï¼Œä¾§è¾¹æ ï¼Œç»“æœå‘ç°è¿™äº›å…ƒç´ åœ¨æ»šåŠ¨åˆ°è¾¹ç•Œæ—¶ï¼Œæ»šåŠ¨äº‹ä»¶ä¼šä¼ é€’ç»™çˆ¶å…ƒç´ ï¼Œå¯¼è‡´çˆ¶å…ƒç´ å¼€å§‹æ»šåŠ¨ï¼ˆåœ¨PCç«¯ä¹Ÿæ˜¯ä¸€æ ·å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œè€Œåœ¨ç§»åŠ¨ç«¯æ›´ä¸ºçªå‡ºï¼Œæœ‰æ—¶å³ä½¿ä¸åœ¨è¾¹ç•Œä¹Ÿä¼šå¯¼è‡´çˆ¶å…ƒç´ æ»šåŠ¨ï¼Œè‡ªèº«å´ä¸åŠ¨ï¼‰ã€‚</p><p>åœ¨ç½‘ä¸Šæœå¯»ä¸€ç•ªåï¼Œæ‰¾åˆ°å¾ˆå¤šå…³äºè¿™ä¸ªé—®é¢˜çš„è®¨è®ºï¼Œè§£å†³æ–¹æ³•å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p><ol><li>ï¼ˆJSï¼‰ç›‘å¬å…ƒç´ <code>el</code>æ»šåŠ¨äº‹ä»¶<code>event</code>ï¼Œå½“<code>el.scrollTop</code>æˆ–è€…<code>el.scrollLeft</code>åˆ°è¾¾è¾¹ç•Œå€¼çš„æ—¶å€™ï¼Œç”¨<code>event.preventDefault()</code>æ–¹æ³•å–æ¶ˆæµè§ˆå™¨é»˜è®¤æ“ä½œå’Œç”¨<code>event.preventDefault()</code>æ–¹æ³•åœæ­¢äº‹ä»¶å¾€ä¸Šä¼ æ’­ï¼›</li><li>ï¼ˆCSSï¼‰åœ¨è¡¨å±‚å…ƒç´ ï¼ˆå¼¹å‡ºæ¡†ï¼Œä¾§è¾¹æ ç­‰ç­‰ï¼‰æ˜¾ç¤ºæ—¶ï¼Œä¿®æ”¹åº•å±‚å…ƒç´ ï¼ˆä¸€èˆ¬æ˜¯ç½‘é¡µä¸»ä½“<code>body</code>ï¼‰çš„æ ·å¼ï¼Œå¦‚<code>position:fixed</code>ã€<code>overflow:hidden</code>ç­‰ç­‰ï¼Œä½¿å…¶ä¸å¯æ»šåŠ¨ã€‚</li></ol><p>å…·ä½“å¯ä»¥å‚è€ƒ<a href="https://github.com/pod4g/tool/wiki/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E6%BB%9A%E5%8A%A8%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">ç§»åŠ¨ç«¯æ»šåŠ¨ç©¿é€é—®é¢˜</a>ï¼Œå…¶ä¸­æåˆ°çš„â€œç»ˆæå®Œç¾è§£å†³æ–¹æ¡ˆâ€ä¾¿å±ä¸Šé¢çš„ç¬¬äºŒç±»ã€‚</p><a id="more"></a><h2 id="ç–‘è™‘"><a href="#ç–‘è™‘" class="headerlink" title="ç–‘è™‘"></a>ç–‘è™‘</h2><p>è™½è¯´æ˜¯â€œç»ˆæå®Œç¾è§£å†³æ–¹æ¡ˆâ€ï¼Œä½†å…¶å®æˆ‘æ˜¯ä¸ç›¸ä¿¡çš„ï¼Œå› ä¸ºä¿®æ”¹äº†å…ƒç´ å®šä½æ–¹å¼ï¼Œå…ƒç´ éœ€è¦é‡ç»˜ï¼Œå†…å®¹æ˜¾ç¤ºä½ç½®ä¹Ÿä¼šæ”¹å˜ï¼Œå³ä½¿è®°å½•å†…å®¹ä½ç½®åç»­æ¢å¤ï¼Œç”»é¢ä¹Ÿå°‘ä¸å…æŠ–åŠ¨ï¼Œæ‰€ä»¥æ€ä¹ˆå¯èƒ½æ˜¯â€œå®Œç¾â€å‘¢ï¼Ÿ</p><h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><p>å°½ç®¡æœ‰æ‰€ç–‘è™‘ï¼Œè¿˜æ˜¯è¦å®è·µä¸€ä¸‹ã€‚äºæ˜¯ç®€å•åœ°å†™ä¸€ä¸ªæµ‹è¯•æ ·ä¾‹äº†ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">html</span>, <span class="selector-tag">body</span> &#123;<span class="attribute">width</span>: <span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">body</span> &#123;<span class="attribute">background-color</span>: <span class="number">#9e9e9e</span>; <span class="attribute">height</span>: <span class="number">9000px</span>; <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>; <span class="attribute">z-index</span>: <span class="number">1</span>;&#125;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.main</span> &#123;<span class="attribute">background-color</span>: <span class="number">#00bcd4</span>; <span class="attribute">height</span>: <span class="number">6000px</span>; <span class="attribute">margin</span>: <span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.nav</span> &#123;<span class="attribute">background-color</span>: <span class="number">#2196f3</span>; <span class="attribute">width</span>: <span class="number">200px</span>; <span class="attribute">position</span>: fixed; <span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">bottom</span>: <span class="number">0</span>; <span class="attribute">right</span>: <span class="number">0</span>; <span class="attribute">overflow</span>: scroll; <span class="attribute">display</span>: none; <span class="attribute">z-index</span>: <span class="number">9</span>;&#125;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"main"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>testing testing<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>testing testing<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>testing testing<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>testing testing<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>testing testing<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- more and more     --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"nav"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"height: 2000px"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>testing testing<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>testing testing<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>testing testing<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>testing testing<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>testing testing<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- more and more     --&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> main = <span class="built_in">document</span>.querySelector(<span class="string">'.main'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> nav  = <span class="built_in">document</span>.querySelector(<span class="string">'.nav'</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> flag = <span class="number">0</span>;</span></span><br><span class="line"><span class="actionscript">        main.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            nav.style.display = <span class="string">'block'</span>;</span></span><br><span class="line"><span class="javascript">            flag = <span class="built_in">document</span>.body.scrollTop;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.body.style.position = <span class="string">'fixed'</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.body.style.top = -flag + <span class="string">'px'</span>;</span></span><br><span class="line">        &#125;);</span><br><span class="line"><span class="actionscript">        nav.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.body.style.position = <span class="string">'static'</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.body.style.top = <span class="string">'auto'</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.body.scrollTop = flag;</span></span><br><span class="line"><span class="actionscript">            nav.style.display = <span class="string">'none'</span>;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ ·ä¾‹é¡µé¢ä¸­ï¼Œç‚¹å‡»<code>.main</code>æ—¶ï¼Œå°†<code>.nav</code>è®¾ä¸ºå¯è§ï¼Œä¸”å°†<code>body</code>çš„å®šä½è®¾ä¸º<code>fixed</code>ï¼Œå‘ä¸Šåç§»åˆ°<code>body</code>æœ¬æ¥çš„æ»šåŠ¨é«˜åº¦ï¼Œè¿™æ ·<code>.nav</code>å¯ä»¥æ»šåŠ¨è€Œ<code>.main</code>ä¸èƒ½æ»šåŠ¨ï¼Œå°±ä¸ä¼šå‡ºç°æ»šåŠ¨ç©¿é€çš„é—®é¢˜ï¼›å†ç‚¹å‡»<code>.nav</code>ï¼Œå°†<code>.nav</code>è®¾ä¸ºä¸å¯è§ï¼Œä¸”å°†<code>body</code>çš„å®šä½è®¾ä¸º<code>static</code>ï¼Œå–æ¶ˆ<code>body</code>çš„å‘ä¸Šåç§»å¹¶æ»šå›æœ¬æ¥çš„æ»šåŠ¨é«˜åº¦ã€‚</p><h3 id="æœ‰ä¸ªé—®é¢˜"><a href="#æœ‰ä¸ªé—®é¢˜" class="headerlink" title="æœ‰ä¸ªé—®é¢˜"></a>æœ‰ä¸ªé—®é¢˜</h3><p>æ ·ä¾‹é¡µé¢åœ¨Safariæµè§ˆå™¨ä¸­è¿è¡Œæ­£å¸¸ï¼Œåœ¨Chromeæµè§ˆå™¨ä¸­å´æœ‰é—®é¢˜ï¼Œå› ä¸ºSafariæµè§ˆå™¨è®¤ä¸º<code>body</code>å…ƒç´ æ˜¯æ»šåŠ¨ä¸»ä½“ï¼Œè€ŒChromeæµè§ˆå™¨è®¤ä¸º<code>html</code>å…ƒç´ æ‰æ˜¯æ»šåŠ¨ä¸»ä½“ã€‚<code>document</code>ä¸­è·å–<code>body</code>å…ƒç´ çš„é”®å€¼æ˜¯<code>body</code>ï¼Œè€Œè·å–<code>html</code>å…ƒç´ çš„é”®å€¼æ˜¯<code>documentElement</code>ï¼Œæ‰€ä»¥è¦åœ¨Chromeæµè§ˆå™¨ä¸­è¿è¡Œæ­£å¸¸çš„è„šæ­¥ä»£ç åº”è¯¥æ˜¯ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> main = <span class="built_in">document</span>.querySelector(<span class="string">'.main'</span>);</span><br><span class="line"><span class="keyword">var</span> nav  = <span class="built_in">document</span>.querySelector(<span class="string">'.nav'</span>);</span><br><span class="line"><span class="keyword">var</span> flag = <span class="number">0</span>;</span><br><span class="line">main.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    nav.style.display = <span class="string">'block'</span>;</span><br><span class="line">    flag = <span class="built_in">document</span>.documentElement.scrollTop;</span><br><span class="line">    <span class="built_in">document</span>.documentElement.style.position = <span class="string">'fixed'</span>;</span><br><span class="line">    <span class="built_in">document</span>.documentElement.style.top = -flag + <span class="string">'px'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">nav.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.documentElement.style.position = <span class="string">'static'</span>;</span><br><span class="line">    <span class="built_in">document</span>.documentElement.style.top = <span class="string">'auto'</span>;</span><br><span class="line">    <span class="built_in">document</span>.documentElement.scrollTop = flag;</span><br><span class="line">    nav.style.display = <span class="string">'none'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œæ•ˆæœ"><a href="#è¿è¡Œæ•ˆæœ" class="headerlink" title="è¿è¡Œæ•ˆæœ"></a>è¿è¡Œæ•ˆæœ</h3><p>åœ¨<code>.nav</code>å‡ºç°æˆ–æ¶ˆå¤±æ—¶ï¼Œè®¤çœŸçœ‹å¯ä»¥å¼€åˆ°<code>.main</code>æœ‰äº›å°æŠ–åŠ¨ï¼Œä½†å¹¶ä¸æ˜æ˜¾ï¼Œåœ¨ä»Šå¤©ç§»åŠ¨ç«¯ç¡¬ä»¶ï¼ˆCPUï¼Œå†…å­˜ï¼‰å’Œè½¯ä»¶ï¼ˆæµè§ˆå™¨ï¼‰ä¼˜åŒ–è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ»šåŠ¨ç©¿é€çš„è§£å†³æ–¹æ³•ç¡®å®æ˜¯å¯ä»¥æ”¾å¿ƒä½¿ç”¨çš„ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å¼€å·æœ‰ç–‘ï¼Œå®è·µè¯æ˜ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘åšä¸€ä¸ªç§»åŠ¨ç«¯çš„Webåº”ç”¨ï¼Œå› ä¸ºæ˜¯å•é¡µæ¨¡å¼ï¼Œæ‰€ä»¥å°‘ä¸äº†å„ç§å„æ ·çš„å¼¹å‡ºæ¡†ï¼Œä¾§è¾¹æ ï¼Œç»“æœå‘ç°è¿™äº›å…ƒç´ åœ¨æ»šåŠ¨åˆ°è¾¹ç•Œæ—¶ï¼Œæ»šåŠ¨äº‹ä»¶ä¼šä¼ é€’ç»™çˆ¶å…ƒç´ ï¼Œå¯¼è‡´çˆ¶å…ƒç´ å¼€å§‹æ»šåŠ¨ï¼ˆåœ¨PCç«¯ä¹Ÿæ˜¯ä¸€æ ·å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œè€Œåœ¨ç§»åŠ¨ç«¯æ›´ä¸ºçªå‡ºï¼Œæœ‰æ—¶å³ä½¿ä¸åœ¨è¾¹ç•Œä¹Ÿä¼šå¯¼è‡´çˆ¶å…ƒç´ æ»šåŠ¨ï¼Œè‡ªèº«å´ä¸åŠ¨ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ç½‘ä¸Šæœå¯»ä¸€ç•ªåï¼Œæ‰¾åˆ°å¾ˆå¤šå…³äºè¿™ä¸ªé—®é¢˜çš„è®¨è®ºï¼Œè§£å†³æ–¹æ³•å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ï¼ˆJSï¼‰ç›‘å¬å…ƒç´ &lt;code&gt;el&lt;/code&gt;æ»šåŠ¨äº‹ä»¶&lt;code&gt;event&lt;/code&gt;ï¼Œå½“&lt;code&gt;el.scrollTop&lt;/code&gt;æˆ–è€…&lt;code&gt;el.scrollLeft&lt;/code&gt;åˆ°è¾¾è¾¹ç•Œå€¼çš„æ—¶å€™ï¼Œç”¨&lt;code&gt;event.preventDefault()&lt;/code&gt;æ–¹æ³•å–æ¶ˆæµè§ˆå™¨é»˜è®¤æ“ä½œå’Œç”¨&lt;code&gt;event.preventDefault()&lt;/code&gt;æ–¹æ³•åœæ­¢äº‹ä»¶å¾€ä¸Šä¼ æ’­ï¼›&lt;/li&gt;
&lt;li&gt;ï¼ˆCSSï¼‰åœ¨è¡¨å±‚å…ƒç´ ï¼ˆå¼¹å‡ºæ¡†ï¼Œä¾§è¾¹æ ç­‰ç­‰ï¼‰æ˜¾ç¤ºæ—¶ï¼Œä¿®æ”¹åº•å±‚å…ƒç´ ï¼ˆä¸€èˆ¬æ˜¯ç½‘é¡µä¸»ä½“&lt;code&gt;body&lt;/code&gt;ï¼‰çš„æ ·å¼ï¼Œå¦‚&lt;code&gt;position:fixed&lt;/code&gt;ã€&lt;code&gt;overflow:hidden&lt;/code&gt;ç­‰ç­‰ï¼Œä½¿å…¶ä¸å¯æ»šåŠ¨ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å…·ä½“å¯ä»¥å‚è€ƒ&lt;a href=&quot;https://github.com/pod4g/tool/wiki/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E6%BB%9A%E5%8A%A8%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ç§»åŠ¨ç«¯æ»šåŠ¨ç©¿é€é—®é¢˜&lt;/a&gt;ï¼Œå…¶ä¸­æåˆ°çš„â€œç»ˆæå®Œç¾è§£å†³æ–¹æ¡ˆâ€ä¾¿å±ä¸Šé¢çš„ç¬¬äºŒç±»ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æ–¹æ¡ˆ" scheme="https://breeze2.github.io/blog/categories/%E6%96%B9%E6%A1%88/"/>
    
    
      <category term="js" scheme="https://breeze2.github.io/blog/tags/js/"/>
    
      <category term="html5" scheme="https://breeze2.github.io/blog/tags/html5/"/>
    
      <category term="css" scheme="https://breeze2.github.io/blog/tags/css/"/>
    
      <category term="scheme" scheme="https://breeze2.github.io/blog/tags/scheme/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºRedisçš„ä»»åŠ¡è°ƒåº¦è®¾è®¡æ–¹æ¡ˆ</title>
    <link href="https://breeze2.github.io/blog/scheme-redis-task-queue.html"/>
    <id>https://breeze2.github.io/blog/scheme-redis-task-queue.html</id>
    <published>2018-01-08T09:23:02.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸€ä¸ªç½‘å…³æœåŠ¡å™¨å°±è·Ÿå¿«é¤åº—ä¸€æ ·ï¼Œæ€»æ˜¯å¸Œæœ›å®¢äººæ¥å¾—å¿«ã€å»å¾—ä¹Ÿå¿«ï¼Œè¿™æ ·åœ¨ç›¸åŒæ—¶é—´å†…æ‰å¯ä»¥æœåŠ¡æ›´å¤šçš„å®¢äººã€‚å¦‚æœå¿«é¤åº—çš„æœåŠ¡å‘˜åœ¨ä¸€ä¸ªé¡¾å®¢ç‚¹é¤ã€ç­‰é¤å’Œç»“è´¦æ—¶éƒ½å…¨ç¨‹è·Ÿé™ªçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡å‘˜å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯åœ¨ç©ºé—²çš„ç­‰å¾…ã€‚åº”è¯¥æœ‰ä¸“é—¨çš„æœåŠ¡å‘˜è´Ÿè´£ç‚¹é¤ï¼Œä¸“é—¨çš„æœåŠ¡å‘˜è´Ÿè´£é€é¤ï¼Œä¸“é—¨çš„æœåŠ¡å‘˜è´Ÿè´£ç»“è´¦ï¼Œè¿™æ ·æ‰èƒ½æé«˜æ•ˆç‡ã€‚åŒæ ·é“ç†ï¼Œç½‘å…³æœåŠ¡å™¨ä¸­ä¹Ÿéœ€è¦åˆ†å·¥æ˜ç¡®ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p></blockquote><p>å‡è®¾æœ‰ä¸€ä¸ªç”³è¯·å‘é€é‡ç½®å¯†ç é‚®ä»¶çš„ç½‘å…³æ¥å£ï¼Œé¡»çŸ¥é“å‘é€ä¸€å°é‚®ä»¶å¯èƒ½ä¼šèŠ±è´¹ä¸Šå¥½å‡ ç§’é’Ÿï¼Œå¦‚æœç½‘å…³æœåŠ¡å™¨ç›´æ¥åœ¨çº¿ä¸Šç»™ç”¨æˆ·å‘é€é‡ç½®å¯†ç é‚®ä»¶ï¼Œé«˜å¹¶å‘çš„æƒ…å†µä¸‹å°±å¾ˆå®¹æ˜“é€ æˆç½‘ç»œæ‹¥æŒ¤ã€‚ä½†å®é™…ä¸Šï¼Œç½‘å…³æœåŠ¡å™¨å¹¶éä¸€å®šè¦ç­‰å¾…é‚®ä»¶å‘é€æˆåŠŸåæ‰èƒ½å“åº”ç”¨æˆ·ï¼Œå®Œå…¨å¯ä»¥å…ˆå‘ŠçŸ¥ç”¨æˆ·é‚®ä»¶ä¼šå‘é€çš„ï¼Œè€Œåå†åœ¨çº¿ä¸‹æŠŠé‚®ä»¶å‘é€å‡ºå»ï¼ˆå°±åƒå¿«é¤åº—é‡Œç‚¹é¤çš„æœåŠ¡å‘˜è·Ÿé¡¾å®¢è¯´å…ˆå»æ‰¾ä½ç½®åï¼Œé¥­èœåšå¥½åä¼šæœ‰äººç»™ä»–é€è¿‡å»ï¼‰ã€‚</p><p>é‚£ä¹ˆæ˜¯è°æ¥æŠŠé‚®ä»¶å‘é€å‡ºå»å‘¢ï¼Ÿ</p><h2 id="ä»»åŠ¡é˜Ÿåˆ—"><a href="#ä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="ä»»åŠ¡é˜Ÿåˆ—"></a>ä»»åŠ¡é˜Ÿåˆ—</h2><p>ä¸ºäº†ç½‘å…³æ¥å£èƒ½å¤Ÿå°½å¿«å“åº”ç”¨æˆ·è¯·æ±‚ï¼Œæ— éœ€å³æ—¶çŸ¥é“ç»“æœçš„è€—æ—¶æ“ä½œå¯ä»¥äº¤ç”±ä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶æ¥å¤„ç†ã€‚<br>ä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶ä¸­åŒ…å«ä¸¤ç§è§’è‰²ï¼Œä¸€ä¸ªæ˜¯ä»»åŠ¡ç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ˜¯ä»»åŠ¡æ¶ˆè´¹è€…ï¼Œè€Œä»»åŠ¡é˜Ÿåˆ—æ˜¯ä¸¤è€…ä¹‹é—´çš„çº½å¸¦ï¼š</p><ul><li>ç”Ÿäº§è€…å¾€é˜Ÿåˆ—é‡Œæ”¾å…¥ä»»åŠ¡ï¼›</li><li>æ¶ˆè´¹è€…ä»é˜Ÿåˆ—é‡Œå–å‡ºä»»åŠ¡ã€‚</li></ul><p>ä»»åŠ¡é˜Ÿåˆ—çš„æ•´ä½“è¿è¡Œæµç¨‹æ˜¯ï¼šä»»åŠ¡ç”Ÿäº§è€…æŠŠå½“å‰æ“ä½œçš„å…³é”®ä¿¡æ¯ï¼ˆåç»­å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯è¿˜åŸå‡ºå½“å‰æ“ä½œï¼‰æŠ½è±¡å‡ºæ¥ï¼Œæ¯”å¦‚å‘é€é‡ç½®å¯†ç çš„é‚®ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦å½“å‰ç”¨æˆ·é‚®ç®±å’Œç”¨æˆ·åå°±å¯ä»¥äº†ï¼›ä»»åŠ¡ç”Ÿäº§è€…æŠŠä»»åŠ¡æ”¾è¿›é˜Ÿåˆ—ï¼Œå®é™…å°±æ˜¯æŠŠä»»åŠ¡çš„å…³é”®ä¿¡æ¯å­˜å‚¨èµ·æ¥ï¼Œè¿™é‡Œä¼šç”¨åˆ°MySQLã€Redisä¹‹ç±»æ•°æ®å­˜å‚¨å·¥å…·ï¼Œå¸¸ç”¨çš„æ˜¯Redisï¼›è€Œä»»åŠ¡æ¶ˆè´¹è€…å°±ä¸æ–­åœ°ä»æ•°æ®åº“ä¸­å–å‡ºä»»åŠ¡ä¿¡æ¯ï¼Œé€ä¸€æ‰§è¡Œã€‚</p><p>ä»»åŠ¡ç”Ÿäº§è€…çš„å·¥ä½œæ˜¯ä»»åŠ¡åˆ†å‘ï¼Œä¸€èˆ¬ç”±çº¿ä¸Šçš„ç½‘å…³æœåŠ¡ç¨‹åºæ‰§è¡Œï¼›ä»»åŠ¡æ¶ˆè´¹è€…çš„å·¥ä½œæ˜¯ä»»åŠ¡è°ƒåº¦ï¼Œä¸€èˆ¬ç”±çº¿ä¸‹çš„ç¨‹åºæ‰§è¡Œï¼Œè¿™æ ·å³ä½¿ä»»åŠ¡è€—æ—¶å†å¤šï¼Œä¹Ÿä¸é˜»å¡ç½‘å…³æœåŠ¡ã€‚</p><p>è¿™é‡Œä¸»è¦è®¨è®ºçš„æ˜¯ä»»åŠ¡è°ƒåº¦ï¼ˆä»»åŠ¡æ¶ˆè´¹è€…ï¼‰çš„ç¨‹åºè®¾è®¡ã€‚</p><a id="more"></a><h2 id="ç®€å•ç›´æ¥"><a href="#ç®€å•ç›´æ¥" class="headerlink" title="ç®€å•ç›´æ¥"></a>ç®€å•ç›´æ¥</h2><p>å‡è®¾æˆ‘ä»¬ç”¨Redisåˆ—è¡¨Listå­˜å‚¨ä»»åŠ¡ä¿¡æ¯ï¼Œåˆ—è¡¨é”®åæ˜¯<code>queues:default</code>ï¼Œä»»åŠ¡å‘å¸ƒå°±æ˜¯å¾€åˆ—è¡¨<code>queues:default</code>åè¿½åŠ æ•°æ®ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// PHPä¼ªä»£ç </span></span><br><span class="line">    Redis::rpush(<span class="string">'queues:default'</span>, serialize($task));</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä»»åŠ¡è°ƒåº¦å¯ä»¥è¿™æ ·ç®€å•ç›´æ¥çš„å®ç°ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// PHPä¼ªä»£ç </span></span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">Worker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">schedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            $seri = Redis::lpop(<span class="string">'queues:default'</span>);</span><br><span class="line">            <span class="keyword">if</span>($seri) &#123;</span><br><span class="line">                $task = unserialize($seri);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;handle($task);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($task)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something time-consuming</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$worker = <span class="keyword">new</span> Worker;</span><br><span class="line">$worker-&gt;schedule();</span><br></pre></td></tr></table></figure><h2 id="æ„å¤–ä¿é™©"><a href="#æ„å¤–ä¿é™©" class="headerlink" title="æ„å¤–ä¿é™©"></a>æ„å¤–ä¿é™©</h2><p>ä¸Šé¢ä»£ç æ˜¯ç›´æ¥ä»<code>queues:default</code>åˆ—è¡¨ä¸­ç§»å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆlpopï¼‰ï¼Œå› ä¸º<code>handle($task)</code>å‡½æ•°æ˜¯ä¸€ä¸ªè€—æ—¶çš„æ“ä½œï¼Œè¿‡ç¨‹ä¸­è‹¥æ˜¯é‡åˆ°ä»€ä¹ˆæ„å¤–å¯¼è‡´äº†æ•´ä¸ªç¨‹åºé€€å‡ºï¼Œè¿™ä¸ªä»»åŠ¡å¯èƒ½è¿˜æ²¡æ‰§è¡Œå®Œæˆï¼Œå¯æ˜¯ä»»åŠ¡ä¿¡æ¯å·²ç»å®Œå…¨ä¸¢å¤±äº†ã€‚ä¿é™©èµ·è§ï¼Œå¯¹<code>schedule()</code>å‡½æ•°è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">schedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            $seri = Redis::lindex(<span class="string">'queues:default'</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span>($seri) &#123;</span><br><span class="line">                $task = unserialize($seri);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;handle($task);</span><br><span class="line">                Redis::lpop(<span class="string">'queues:default'</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å³åœ¨ä»»åŠ¡å®Œæˆåæ‰å°†ä»»åŠ¡ä¿¡æ¯ä»åˆ—è¡¨ä¸­ç§»é™¤ã€‚</p><h2 id="å»¶æ—¶æ‰§è¡Œ"><a href="#å»¶æ—¶æ‰§è¡Œ" class="headerlink" title="å»¶æ—¶æ‰§è¡Œ"></a>å»¶æ—¶æ‰§è¡Œ</h2><p><code>queues:default</code>åˆ—è¡¨ä¸­çš„ä»»åŠ¡éƒ½æ˜¯éœ€è¦å³æ—¶æ‰§è¡Œçš„ï¼Œä½†æ˜¯æœ‰äº›ä»»åŠ¡æ˜¯éœ€è¦é—´éš”ä¸€æ®µæ—¶é—´åæˆ–è€…åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šæ‰§è¡Œï¼Œé‚£ä¹ˆå¯ä»¥å¼•å…¥ä¸€ä¸ªæœ‰åºé›†åˆï¼Œå‘½åä¸º<code>queues:default:delayed</code>ï¼Œæ¥å­˜æ”¾è¿™äº›ä»»åŠ¡ã€‚ä»»åŠ¡å‘å¸ƒæ—¶éœ€è¦æŒ‡æ˜æ‰§è¡Œçš„æ—¶é—´ç‚¹<code>$time</code>ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// PHPä¼ªä»£ç </span></span><br><span class="line">    Redis::zadd(<span class="string">'queues:default:delayed'</span>, $time, serialize($task));</span><br></pre></td></tr></table></figure><p>ä»»åŠ¡è°ƒåº¦æ—¶ï¼Œå¦‚æœ<code>queues:default</code>åˆ—è¡¨å·²ç»ç©ºäº†ï¼Œå°±ä»<code>queues:default:delayed</code>é›†åˆä¸­å–å‡ºåˆ°è¾¾æ‰§è¡Œæ—¶é—´çš„ä»»åŠ¡æ”¾å…¥<code>queues:default</code>åˆ—è¡¨ä¸­ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">schedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            $seri = Redis::lindex(<span class="string">'queues:default'</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span>($seri) &#123;</span><br><span class="line">                $task = unserialize($seri);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;handle($task);</span><br><span class="line">                Redis::lpop(<span class="string">'queues:default'</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $seri_arr = Redis::zremrangebyscore(<span class="string">'queues:default:delayed'</span>, <span class="number">0</span>, time());</span><br><span class="line">            <span class="keyword">if</span>($seri_arr) &#123;</span><br><span class="line">                Redis::rpush(<span class="string">'queues:default'</span>, $seri_arr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="ä»»åŠ¡è¶…æ—¶"><a href="#ä»»åŠ¡è¶…æ—¶" class="headerlink" title="ä»»åŠ¡è¶…æ—¶"></a>ä»»åŠ¡è¶…æ—¶</h2><p>é¢„ä¼°ä»»åŠ¡æ­£å¸¸æ‰§è¡Œæ‰€éœ€çš„æœ€å¤§æ—¶é—´å€¼ï¼Œè‹¥æ˜¯ä»»åŠ¡æ‰§è¡Œè¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œå¯èƒ½æ˜¯è¿‡ç¨‹ä¸­é‡åˆ°ä¸€äº›æ„å¤–ï¼Œå¦‚æœä»»ç”±å®ƒç»§ç»­å¡ç€ï¼Œé‚£ä¹ˆåé¢çš„ä»»åŠ¡å°±ä¼šæ— æ³•è¢«æ‰§è¡Œäº†ã€‚<br>é¦–å…ˆæˆ‘ä»¬ç»™ä»»åŠ¡è®¾å®šä¸€ä¸ªæ—¶é™å±æ€§<code>timeout</code>ï¼Œç„¶ååœ¨æ‰§è¡Œä»»åŠ¡å‰å…ˆç»™è¿›ç¨‹æœ¬èº«è®¾ç½®ä¸€ä¸ªé—¹é’Ÿä¿¡å·ï¼Œ<code>timeout</code>åæ”¶åˆ°ä¿¡å·è¯´æ˜ä»»åŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œéœ€è¦é€€å‡ºå½“å‰è¿›ç¨‹ï¼ˆç”¨<a href="http://supervisord.org/" target="_blank" rel="noopener">supervisor</a>å®ˆæŠ¤è¿›ç¨‹æ—¶ï¼Œè¿›ç¨‹è‡ªèº«é€€å‡ºï¼Œsupervisorä¼šè‡ªåŠ¨å†æ‹‰èµ·ï¼‰ã€‚<br>æ³¨æ„ï¼š<code>pcntl_alarm($timeout)</code>ä¼šè¦†ç›–ä¹‹å‰é—¹é’Ÿä¿¡å·ï¼Œè€Œ<code>pcntl_alarm(0)</code>ä¼šå–æ¶ˆé—¹é’Ÿä¿¡å·ï¼›ä»»åŠ¡è¶…æ—¶åï¼Œå½“å‰ä»»åŠ¡æ”¾å…¥<code>queues:default:delayed</code>é›†åˆä¸­å»¶æ—¶æ‰§è¡Œï¼Œä»¥å…å†æ¬¡é˜»å¡é˜Ÿåˆ—ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">schedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            $seri = Redis::lindex(<span class="string">'queues:default'</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span>($seri) &#123;</span><br><span class="line">                $task = unserialize($seri);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;timeoutHanle($task);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;handle($task);</span><br><span class="line">                Redis::lpop(<span class="string">'queues:default'</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $seri_arr = Redis::zremrangebyscore(<span class="string">'queues:default:delayed'</span>, <span class="number">0</span>, time());</span><br><span class="line">            <span class="keyword">if</span>($seri_arr) &#123;</span><br><span class="line">                Redis::rpush(<span class="string">'queues:default'</span>, $seri_arr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pcntl_alarm(<span class="number">0</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">timeoutHanle</span><span class="params">($task)</span> </span>&#123;</span><br><span class="line">        $timeout = (int)$task-&gt;timeout;</span><br><span class="line">        <span class="keyword">if</span> ($timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pcntl_signal(SIGALRM, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">                $seri = Redis::lpop(<span class="string">'queues:default'</span>);</span><br><span class="line">                Redis::zadd(<span class="string">'queues:default:delayed'</span>, time()+<span class="number">10</span>), $seri);</span><br><span class="line">                posix_kill(getmypid(), SIGKILL);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        pcntl_alarm($timeout);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="å¹¶å‘æ‰§è¡Œ"><a href="#å¹¶å‘æ‰§è¡Œ" class="headerlink" title="å¹¶å‘æ‰§è¡Œ"></a>å¹¶å‘æ‰§è¡Œ</h2><p>ä¸Šé¢ä»£ç ï¼Œç›´è§‚ä¸Šæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šè¿›ç¨‹å¹¶å‘æ‰§è¡Œçš„æ—¶å€™ï¼Œæœ‰äº›ä»»åŠ¡å¯èƒ½ä¼šè¢«é‡å¤æ‰§è¡Œï¼Œæ˜¯å› ä¸ºæ²¡èƒ½åŠæ—¶å°†å½“å‰æ‰§è¡Œçš„ä»»åŠ¡ä»<code>queues:default</code>åˆ—è¡¨ä¸­ç§»å‡ºï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿå¯ä»¥è¯»å–åˆ°ã€‚ä¸ºäº†é¿å…é‡å¤æ‰§è¡Œçš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªæœ‰åºé›†åˆSortedSetå­˜æ”¾æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå‘½åä¸º<code>queues:default:reserved</code>ã€‚<br>é¦–å…ˆä»»åŠ¡æ˜¯ä»<code>queues:default</code>åˆ—è¡¨ä¸­ç›´æ¥ç§»å‡ºï¼Œç„¶åå¼€å§‹æ‰§è¡Œä»»åŠ¡å‰å…ˆæŠŠä»»åŠ¡æ”¾è¿›<code>queues:default:reserved</code>é›†åˆä¸­ï¼Œä»»åŠ¡å®Œæˆäº†å†ä»<code>queues:default:reserved</code>é›†åˆä¸­ç§»å‡ºã€‚<br>å†ç»“åˆä»»åŠ¡è¶…æ—¶ï¼Œå‡è®¾ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸å¯èƒ½è¶…è¿‡<code>60*60</code>ç§’ï¼ˆå¯ä»¥æŒ‰éœ€è°ƒæ•´ï¼‰ï¼Œåœ¨<code>queues:default</code>åˆ—è¡¨ä¸ºç©ºçš„æ—¶å€™ï¼Œ<code>queues:default:reserved</code>é›†åˆä¸­æœ‰ä»»åŠ¡å·²ç»å­˜æ”¾è¶…è¿‡äº†<code>60*60</code>ç§’ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½æ˜¯æŸäº›è¿›ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡æ˜¯æ„å¤–é€€å‡ºäº†ï¼Œæ‰€ä»¥æŠŠè¿™äº›ä»»åŠ¡æ”¾åˆ°<code>queues:default:delayed</code>é›†åˆä¸­ç¨åæ‰§è¡Œã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">schedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            $seri = Redis::lpop(<span class="string">'queues:default'</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span>($seri) &#123;</span><br><span class="line">                Redis::zadd(<span class="string">'queues:default:reserved'</span>, time()+<span class="number">10</span>, $seri);</span><br><span class="line">                $task = unserialize($seri);                </span><br><span class="line">                <span class="keyword">$this</span>-&gt;timeoutHanle($task);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;handle($task);</span><br><span class="line">                Redis::zrem(<span class="string">'queues:default:reserved'</span>, $seri);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $seri_arr = Redis::zremrangebyscore(<span class="string">'queues:default:delayed'</span>, <span class="number">0</span>, time());</span><br><span class="line">            <span class="keyword">if</span>($seri_arr) &#123;</span><br><span class="line">                Redis::rpush(<span class="string">'queues:default'</span>, $seri_arr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $seri_arr = Redis::zremrangebyscore(<span class="string">'queues:default:reserved'</span>, <span class="number">0</span>, time()<span class="number">-60</span>*<span class="number">60</span>);</span><br><span class="line">            <span class="keyword">if</span>($seri_arr) &#123;</span><br><span class="line">                <span class="keyword">foreach</span>($seri_arr <span class="keyword">as</span> $seri) &#123;</span><br><span class="line">                    Redis::zadd(<span class="string">'queues:default:delayed'</span>, time()+<span class="number">10</span>, $seri);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">timeoutHanle</span><span class="params">($task)</span> </span>&#123;</span><br><span class="line">        $timeout = (int)$task-&gt;timeout;</span><br><span class="line">        <span class="keyword">if</span> ($timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pcntl_signal(SIGALRM, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($task)</span> </span>&#123;</span><br><span class="line">                $seri = serialize($task);</span><br><span class="line">                Redis::zrem(<span class="string">'queues:default:reserved'</span>, $seri);</span><br><span class="line">                Redis::zadd(<span class="string">'queues:default:delayed'</span>, time()+<span class="number">10</span>), $seri);</span><br><span class="line">                posix_kill(getmypid(), SIGKILL);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        pcntl_alarm($timeout);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="å¤±è´¥é‡è¯•"><a href="#å¤±è´¥é‡è¯•" class="headerlink" title="å¤±è´¥é‡è¯•"></a>å¤±è´¥é‡è¯•</h3><p>ä»¥ä¸Šä»£ç æ²¡æœ‰æ£€éªŒä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œåº”è¯¥æœ‰ä»»åŠ¡å¤±è´¥çš„å¤„ç†æœºåˆ¶ï¼šæ¯”å¦‚ç»™ä»»åŠ¡è®¾å®šä¸€ä¸ªæœ€å¤šé‡è¯•æ¬¡æ•°å±æ€§<code>retry_times</code>ï¼Œä»»åŠ¡æ¯æ‰§è¡Œä¸€æ¬¡<code>retry_times</code>ï¼Œä»»åŠ¡æ‰§è¡Œå¤±è´¥æ—¶ï¼Œè‹¥æ˜¯<code>retry_times</code>ç­‰äº0ï¼Œåˆ™å°†ä»»åŠ¡æ”¾å…¥<code>queues:default:failed</code>åˆ—è¡¨ä¸­ä¸å†æ‰§è¡Œï¼›å¦åˆ™æ”¾å…¥æ”¾åˆ°<code>queues:default:delayed</code>é›†åˆä¸­ç¨åæ‰§è¡Œã€‚</p><h3 id="ä¼‘çœ æ—¶é—´"><a href="#ä¼‘çœ æ—¶é—´" class="headerlink" title="ä¼‘çœ æ—¶é—´"></a>ä¼‘çœ æ—¶é—´</h3><p>ä»¥ä¸Šä»£ç æ˜¯è¿›ç¨‹å¿™æ—¶è¿ç»­æ‰§è¡Œï¼Œé—²æ—¶ä¼‘çœ ä¸€ç§’ï¼Œå¯ä»¥æŒ‰éœ€è°ƒæ•´ä¼˜åŒ–ã€‚</p><h3 id="äº‹ä»¶ç›‘å¬"><a href="#äº‹ä»¶ç›‘å¬" class="headerlink" title="äº‹ä»¶ç›‘å¬"></a>äº‹ä»¶ç›‘å¬</h3><p>è‹¥æ˜¯éœ€è¦åœ¨ä»»åŠ¡æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶è¿›è¡ŒæŸäº›æ“ä½œï¼Œå¯ä»¥ç»™ä»»åŠ¡è®¾å®šæˆåŠŸæ“ä½œæ–¹æ³•<code>afterSucceeded()</code>æˆ–å¤±è´¥æ“ä½œæ–¹æ³•<code>afterFailed()</code>ï¼Œåœ¨ç›¸åº”çš„æ—¶å€™å›è°ƒã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ä»¥ä¸Šè®²è¿°äº†ä¸€ä¸ªä»»åŠ¡è°ƒåº¦ç¨‹åºçš„é€æ­¥æ¼”å˜ï¼Œè®¾è®¡æ–¹æ¡ˆå¾ˆå¤§ç¨‹åº¦ä¸Šå‚è€ƒäº†<a href="https://laravel.com/docs/5.5/queues" target="_blank" rel="noopener">Laravel Queue</a>ã€‚<br>ç”¨å·¥å…·ï¼ŒçŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä¸€ä¸ªç½‘å…³æœåŠ¡å™¨å°±è·Ÿå¿«é¤åº—ä¸€æ ·ï¼Œæ€»æ˜¯å¸Œæœ›å®¢äººæ¥å¾—å¿«ã€å»å¾—ä¹Ÿå¿«ï¼Œè¿™æ ·åœ¨ç›¸åŒæ—¶é—´å†…æ‰å¯ä»¥æœåŠ¡æ›´å¤šçš„å®¢äººã€‚å¦‚æœå¿«é¤åº—çš„æœåŠ¡å‘˜åœ¨ä¸€ä¸ªé¡¾å®¢ç‚¹é¤ã€ç­‰é¤å’Œç»“è´¦æ—¶éƒ½å…¨ç¨‹è·Ÿé™ªçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡å‘˜å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯åœ¨ç©ºé—²çš„ç­‰å¾…ã€‚åº”è¯¥æœ‰ä¸“é—¨çš„æœåŠ¡å‘˜è´Ÿè´£ç‚¹é¤ï¼Œä¸“é—¨çš„æœåŠ¡å‘˜è´Ÿè´£é€é¤ï¼Œä¸“é—¨çš„æœåŠ¡å‘˜è´Ÿè´£ç»“è´¦ï¼Œè¿™æ ·æ‰èƒ½æé«˜æ•ˆç‡ã€‚åŒæ ·é“ç†ï¼Œç½‘å…³æœåŠ¡å™¨ä¸­ä¹Ÿéœ€è¦åˆ†å·¥æ˜ç¡®ã€‚ä¸¾ä¸ªä¾‹å­ï¼š&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å‡è®¾æœ‰ä¸€ä¸ªç”³è¯·å‘é€é‡ç½®å¯†ç é‚®ä»¶çš„ç½‘å…³æ¥å£ï¼Œé¡»çŸ¥é“å‘é€ä¸€å°é‚®ä»¶å¯èƒ½ä¼šèŠ±è´¹ä¸Šå¥½å‡ ç§’é’Ÿï¼Œå¦‚æœç½‘å…³æœåŠ¡å™¨ç›´æ¥åœ¨çº¿ä¸Šç»™ç”¨æˆ·å‘é€é‡ç½®å¯†ç é‚®ä»¶ï¼Œé«˜å¹¶å‘çš„æƒ…å†µä¸‹å°±å¾ˆå®¹æ˜“é€ æˆç½‘ç»œæ‹¥æŒ¤ã€‚ä½†å®é™…ä¸Šï¼Œç½‘å…³æœåŠ¡å™¨å¹¶éä¸€å®šè¦ç­‰å¾…é‚®ä»¶å‘é€æˆåŠŸåæ‰èƒ½å“åº”ç”¨æˆ·ï¼Œå®Œå…¨å¯ä»¥å…ˆå‘ŠçŸ¥ç”¨æˆ·é‚®ä»¶ä¼šå‘é€çš„ï¼Œè€Œåå†åœ¨çº¿ä¸‹æŠŠé‚®ä»¶å‘é€å‡ºå»ï¼ˆå°±åƒå¿«é¤åº—é‡Œç‚¹é¤çš„æœåŠ¡å‘˜è·Ÿé¡¾å®¢è¯´å…ˆå»æ‰¾ä½ç½®åï¼Œé¥­èœåšå¥½åä¼šæœ‰äººç»™ä»–é€è¿‡å»ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆæ˜¯è°æ¥æŠŠé‚®ä»¶å‘é€å‡ºå»å‘¢ï¼Ÿ&lt;/p&gt;
&lt;h2 id=&quot;ä»»åŠ¡é˜Ÿåˆ—&quot;&gt;&lt;a href=&quot;#ä»»åŠ¡é˜Ÿåˆ—&quot; class=&quot;headerlink&quot; title=&quot;ä»»åŠ¡é˜Ÿåˆ—&quot;&gt;&lt;/a&gt;ä»»åŠ¡é˜Ÿåˆ—&lt;/h2&gt;&lt;p&gt;ä¸ºäº†ç½‘å…³æ¥å£èƒ½å¤Ÿå°½å¿«å“åº”ç”¨æˆ·è¯·æ±‚ï¼Œæ— éœ€å³æ—¶çŸ¥é“ç»“æœçš„è€—æ—¶æ“ä½œå¯ä»¥äº¤ç”±ä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶æ¥å¤„ç†ã€‚&lt;br&gt;ä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶ä¸­åŒ…å«ä¸¤ç§è§’è‰²ï¼Œä¸€ä¸ªæ˜¯ä»»åŠ¡ç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ˜¯ä»»åŠ¡æ¶ˆè´¹è€…ï¼Œè€Œä»»åŠ¡é˜Ÿåˆ—æ˜¯ä¸¤è€…ä¹‹é—´çš„çº½å¸¦ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç”Ÿäº§è€…å¾€é˜Ÿåˆ—é‡Œæ”¾å…¥ä»»åŠ¡ï¼›&lt;/li&gt;
&lt;li&gt;æ¶ˆè´¹è€…ä»é˜Ÿåˆ—é‡Œå–å‡ºä»»åŠ¡ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»»åŠ¡é˜Ÿåˆ—çš„æ•´ä½“è¿è¡Œæµç¨‹æ˜¯ï¼šä»»åŠ¡ç”Ÿäº§è€…æŠŠå½“å‰æ“ä½œçš„å…³é”®ä¿¡æ¯ï¼ˆåç»­å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯è¿˜åŸå‡ºå½“å‰æ“ä½œï¼‰æŠ½è±¡å‡ºæ¥ï¼Œæ¯”å¦‚å‘é€é‡ç½®å¯†ç çš„é‚®ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦å½“å‰ç”¨æˆ·é‚®ç®±å’Œç”¨æˆ·åå°±å¯ä»¥äº†ï¼›ä»»åŠ¡ç”Ÿäº§è€…æŠŠä»»åŠ¡æ”¾è¿›é˜Ÿåˆ—ï¼Œå®é™…å°±æ˜¯æŠŠä»»åŠ¡çš„å…³é”®ä¿¡æ¯å­˜å‚¨èµ·æ¥ï¼Œè¿™é‡Œä¼šç”¨åˆ°MySQLã€Redisä¹‹ç±»æ•°æ®å­˜å‚¨å·¥å…·ï¼Œå¸¸ç”¨çš„æ˜¯Redisï¼›è€Œä»»åŠ¡æ¶ˆè´¹è€…å°±ä¸æ–­åœ°ä»æ•°æ®åº“ä¸­å–å‡ºä»»åŠ¡ä¿¡æ¯ï¼Œé€ä¸€æ‰§è¡Œã€‚&lt;/p&gt;
&lt;p&gt;ä»»åŠ¡ç”Ÿäº§è€…çš„å·¥ä½œæ˜¯ä»»åŠ¡åˆ†å‘ï¼Œä¸€èˆ¬ç”±çº¿ä¸Šçš„ç½‘å…³æœåŠ¡ç¨‹åºæ‰§è¡Œï¼›ä»»åŠ¡æ¶ˆè´¹è€…çš„å·¥ä½œæ˜¯ä»»åŠ¡è°ƒåº¦ï¼Œä¸€èˆ¬ç”±çº¿ä¸‹çš„ç¨‹åºæ‰§è¡Œï¼Œè¿™æ ·å³ä½¿ä»»åŠ¡è€—æ—¶å†å¤šï¼Œä¹Ÿä¸é˜»å¡ç½‘å…³æœåŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œä¸»è¦è®¨è®ºçš„æ˜¯ä»»åŠ¡è°ƒåº¦ï¼ˆä»»åŠ¡æ¶ˆè´¹è€…ï¼‰çš„ç¨‹åºè®¾è®¡ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æ–¹æ¡ˆ" scheme="https://breeze2.github.io/blog/categories/%E6%96%B9%E6%A1%88/"/>
    
    
      <category term="scheme" scheme="https://breeze2.github.io/blog/tags/scheme/"/>
    
      <category term="php" scheme="https://breeze2.github.io/blog/tags/php/"/>
    
      <category term="redis" scheme="https://breeze2.github.io/blog/tags/redis/"/>
    
      <category term="queue" scheme="https://breeze2.github.io/blog/tags/queue/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨æ€æ›´æ–°æ—¶æ•ˆæ€§ç¼“å­˜çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ</title>
    <link href="https://breeze2.github.io/blog/scheme-refresh-timeliness-cache.html"/>
    <id>https://breeze2.github.io/blog/scheme-refresh-timeliness-cache.html</id>
    <published>2018-01-08T09:23:02.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡æ–‡ç« <a href="http://blog.jobbole.com/111076/" target="_blank" rel="noopener">ä¸€å¼ ä¼˜æƒ åˆ¸å¼•å‘çš„è¡€æ¡ˆ</a>ï¼Œæ–‡ç« ä½œè€…å®ç°ä¸€ä¸ªè·å–ä¼˜æƒ åˆ¸åˆ—è¡¨çš„RPCæ¥å£ï¼Œæ¥å£ä¸­çš„æ‰§è¡Œæµç¨‹å¤§æ¦‚æ˜¯å…ˆåœ¨ç¼“å­˜é‡Œè·å–ä¼˜æƒ åˆ¸åˆ—è¡¨ï¼Œæœ‰åˆ™è¿”å›ï¼Œæ²¡æœ‰åˆ™åœ¨æ•°æ®åº“é‡Œè·å–ï¼Œå°†ç»“æœå†™å…¥ç¼“å­˜å†è¿”å›ã€‚ç„¶è€Œï¼Œåœ¨é«˜å¹¶å‘è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œç¼“å­˜ä¼˜æƒ åˆ¸åˆ—è¡¨ä¸­å‡ºç°å¤§é‡çš„é‡å¤æ•°æ®ã€‚<br>ä¸»è¦åŸå› æ˜¯ï¼š</p><ol><li>ç¨‹åºåªé€‚åº”å•ä¾‹æ‰§è¡Œï¼Œæ²¡æœ‰è€ƒè™‘åˆ°å¤šä¾‹å¹¶å‘çš„æƒ…å†µï¼›</li><li>ä¼˜æƒ åˆ¸åˆ—è¡¨åœ¨ç¼“å­˜ä¸­å­˜å‚¨ç»“æ„æ˜¯æ•°ç»„ï¼Œè€Œæ›´æ–°æ–¹æ³•æ˜¯ç›´æ¥è¿½åŠ ï¼›</li><li>ç›´æ¥åœ¨RPCæ¥å£ä¸­æ‰§è¡Œæ›´æ–°ç¼“å­˜ã€‚</li></ol><p>æ–‡ç« ä½œè€…æœ€åé€šè¿‡åå¤åˆ¤æ–­æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½åŠæ³•ã€‚å…¶å®è¿™æ ·éœ€è¦åŠ¨æ€æ›´æ–°ç¼“å­˜åœºæ™¯åœ¨å¼€å‘ä¸­ååˆ†å¸¸è§ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ¢è®¨ä¸€ä¸‹ç›¸å¯¹å®Œå–„çš„è§£å†³æ–¹æ¡ˆã€‚</p><a id="more"></a><h2 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h2><p>å‡è®¾æœ‰ä¸€äº›æ—¶æ•ˆæ€§çš„æ•°æ®ï¼ˆæ¯”å¦‚æœ€æ–°èµ„è®¯ã€ä»Šæ—¥å¤©æ°”ç­‰ç­‰ï¼‰ï¼Œè¿™äº›æ•°æ®åœ¨ä¸€å®šæ—¶é—´å†…ä¸ä¼šæ”¹å˜ï¼Œç”¨æˆ·ç»å¸¸ä¼šè·å–ï¼Œè€Œç›´æ¥ä»æ•°æ®åº“ä¸­è¯»å–ç›¸å¯¹è€—æ—¶ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®å¾ˆåº”è¯¥æ”¾åœ¨ç¼“å­˜ä¸­ã€‚<br>å› ä¸ºè¿™äº›æ•°æ®å…·æœ‰æ—¶æ•ˆæ€§ï¼Œæ‰€ä»¥éœ€è¦åŠæ—¶æ›´æ–°ã€‚ç”¨å®šæ—¶æ›´æ–°çš„è¯ï¼ˆä¸€èˆ¬éƒ½ä¸ä¼šæ¯ä¸ª1ç§’æ›´æ–°ä¸€æ¬¡ï¼‰ï¼Œä¼šæœ‰ä¸€äº›é—´éš”ï¼›ç”¨åŠ¨æ€æ›´æ–°çš„è¯ï¼ˆç”±ç”¨æˆ·è§¦å‘æ›´æ–°ï¼‰ï¼Œåœ¨ç”¨æˆ·è¯·æ±‚è·å–è¿™äº›æ•°æ®çš„æ—¶å€™æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œæ˜¯åˆ™æ›´æ–°å¹¶å°†æ–°çš„æ•°æ®è¿”å›ç»™ç”¨æˆ·ã€‚</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><p>åœ¨ç¼“å­˜ä¸­å­˜å‚¨æ•°æ®æ—¶ï¼Œåº”è¯¥é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„ã€‚</p><ol><li>å¦‚æœæ•°æ®æœ¬èº«æ˜¯æœ‰è§„åˆ™å…ƒç´ çš„é›†åˆï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨æ•°ç»„ç»“æ„å­˜å‚¨ï¼Œæ–¹ä¾¿æ‰©å±•ï¼›</li><li>å¦‚æœæ•°æ®æœ¬èº«æ˜¯æœ‰è§„åˆ™å…ƒç´ çš„é›†åˆä¸”å…ƒç´ å„æœ‰ä¸»é”®ï¼Œé‡‡ç”¨æ˜ å°„ç»“æ„å­˜å‚¨ï¼Œå¯ä»¥å•ç‹¬å¯¹å…ƒç´ è¿›è¡Œæ›´æ–°ï¼›</li><li>å¦‚æœæ•°æ®æœ¬èº«æ¯«æ— è§„åˆ™ï¼Œå¯ä»¥å°è£…æˆJSONæ ¼å¼ï¼Œé‡‡ç”¨å­—ç¬¦ä¸²ç»“æ„å­˜å‚¨ï¼Œæ›´æ–°æ—¶æ˜¯å…¨é‡æ›´æ–°ã€‚</li></ol><p>å¦å¤–ï¼Œéœ€è¦è®°å½•æ•°æ®ä¸Šä¸€æ¬¡æ›´æ–°çš„æ—¶é—´æˆ³ï¼Œå³å°†è¿™ä¸ªæ—¶é—´æˆ³ä¹Ÿæ”¾è¿›ç¼“å­˜ï¼Œä»¥æ­¤æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼Œæ˜¯å¦éœ€è¦æ›´æ–°ã€‚å½“ç„¶ï¼ŒåƒRedisè¿™ç±»æˆç†Ÿçš„å­˜å‚¨å·¥å…·ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨å…¶æä¾›çš„TTLï¼ˆtime to liveï¼‰æ¥åˆ¤æ–­ã€‚</p><h3 id="ä»»åŠ¡é˜Ÿåˆ—"><a href="#ä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="ä»»åŠ¡é˜Ÿåˆ—"></a>ä»»åŠ¡é˜Ÿåˆ—</h3><p>é¦–å…ˆå…ˆå®ç°ä¸€ä¸ªæ›´æ–°æ•°æ®çš„ä»»åŠ¡ï¼Œè¿™é‡Œæ›´æ–°æ˜¯æŒ‡å…¨é‡æ›´æ–°ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">updateTheDataTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $ttl  = Redis::getTheDataTTL();</span><br><span class="line">    <span class="keyword">if</span>($ttl &gt; NEED_TO_UPDATE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $data = MySQL::getTheData();</span><br><span class="line">    Redis::setTheData($data); <span class="comment">// update expires of the data at the same time</span></span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    Queue::cancelOtherUpdateTheDataTasks();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œè¿è¡Œä¸€ä¸ªæ‰§è¡Œæ•°æ®æ›´æ–°ä»»åŠ¡çš„é˜Ÿåˆ—è¿›ç¨‹ï¼Œæ³¨æ„é¡»æ˜¯å•è¿›ç¨‹ï¼Œè€Œéå¤šè¿›ç¨‹ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šåªæ‰§è¡Œä¸€ä¸ªæ•°æ®æ›´æ–°ä»»åŠ¡ã€‚å…¶ä¸­åšTTLåˆ¤æ–­ï¼Œæ˜¯ä¸ºäº†è¿‡æ»¤æ²¡å¿…è¦ä»»åŠ¡æ‰§è¡Œï¼›æ›´æ–°æˆåŠŸåä¼‘çœ ä¸¤ç§’ï¼ˆå…¶å®å¯ä»¥ä¼‘çœ æ›´ä¹…ç‚¹ï¼‰ï¼Œä¸»è¦ç­‰å¾…RedisåŒæ­¥ï¼Œä»¥å…åç»­ä»»åŠ¡è·å–åˆ°æ—§çš„æ•°æ®ï¼›å–æ¶ˆæ‰åç»­çš„æ•°æ®æ›´æ–°ä»»åŠ¡æ˜¯å› ä¸ºæ ¹æœ¬æ²¡å¿…è¦æ‰§è¡Œäº†ã€‚</p><p>ä»»åŠ¡é˜Ÿåˆ—å¯ä»¥ç”¨<a href="http://gearman.org/" target="_blank" rel="noopener">gearman</a>å®ç°ï¼Œè€Œé˜Ÿåˆ—è¿›ç¨‹å¯ä»¥ç”¨<a href="http://supervisord.org/" target="_blank" rel="noopener">supervisord</a>æ¥å®ˆæŠ¤ï¼Œè¿™é‡Œä¸å±•å¼€ä»‹ç»ã€‚</p><h3 id="ç½‘å…³æ¥å£"><a href="#ç½‘å…³æ¥å£" class="headerlink" title="ç½‘å…³æ¥å£"></a>ç½‘å…³æ¥å£</h3><p>æœ‰äº†ä¸Šé¢çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸‹é¢å®ç°é¢å‘ç”¨æˆ·çš„è·å–æ•°æ®æ¥å£å°±å®¹æ˜“å¤šäº†ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">theData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $data = Redis::getTheData();</span><br><span class="line">    <span class="keyword">if</span>($data) &#123;</span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $data = MySQL::getTheData();</span><br><span class="line">        Queue::pushUpdateTheDataTask();</span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Queue::pushUpdateTheDataTask()</code>åªæ˜¯å°†æ•°æ®æ›´æ–°ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œç”±é˜Ÿåˆ—å¤„ç†è¿›ç¨‹å»æ‰§è¡Œã€‚è¿™é‡Œå¼ºè°ƒä¸€ä¸‹ï¼Œæ•°æ®æ›´æ–°è™½ç„¶æ˜¯ç”±ç”¨æˆ·è§¦å‘ï¼Œä½†æ˜¯ç»ä¸åœ¨é¢å‘ç”¨æˆ·çš„ç½‘å…³æ¥å£é‡Œæ‰§è¡Œï¼Œå› ä¸ºé¢å‘ç”¨æˆ·çš„ç½‘å…³æ¥å£å¯èƒ½ä¼šæœ‰å¤§é‡å¹¶å‘è¯·æ±‚ï¼Œæ¥å£å†…ä¸åº”è¯¥åšè€—æ—¶æ“ä½œï¼Œæ‰€ä»¥æ‰å»ºç«‹ä»»åŠ¡é˜Ÿåˆ—æ¥æ‰§è¡Œæ•°æ®æ›´æ–°ï¼Œå‡è½»ç½‘å…³å‹åŠ›ã€‚</p><h3 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h3><p>è¿™ä¸ªæ–¹æ¡ˆåœ¨å¤§é‡å¹¶å‘è®¿é—®ç½‘å…³æ¥å£çš„æƒ…å†µä¸‹ï¼Œç¼“å­˜çš„æ•°æ®å¯ä»¥ä¿æŒå‡†ç¡®ï¼Œè¿‡ç¨‹æ²¡æœ‰è¿‡å¤šçš„æ— ç”¨æ“ä½œï¼Œä¹ŸèŠ‚çœäº†æ‰§è¡Œæ—¶é—´ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ã€Šä¸€å¼ ä¼˜æƒ åˆ¸å¼•å‘çš„è¡€æ¡ˆã€‹å›¾æ–‡å¹¶èŒ‚ï¼Œæ–‡ä¸­ä½œè€…å¯¹è¿›ç¨‹ã€ä»£ç å—ã€åˆ†å¸ƒå¼é”ç­‰æ–¹é¢è¿›è¡Œäº†è®¨è®ºï¼Œæœ€åä¹Ÿæä¾›è§£å†³æ–¹æ³•ï¼Œç„¶è€Œè¯»è€…æ›´éœ€è¦çš„æ˜¯ç‹¬ç«‹æ€è€ƒâ€”â€”åŒæ ·çš„é—®é¢˜ï¼Œå¯ä»¥æœ‰ä¸åŒçš„ã€æ›´å¥½çš„è§£å†³æ–¹æ³•ã€‚</p><p>å¼€å·æœ‰ç›Šï¼Œè´µåœ¨æ€è€ƒã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡æ–‡ç« &lt;a href=&quot;http://blog.jobbole.com/111076/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ä¸€å¼ ä¼˜æƒ åˆ¸å¼•å‘çš„è¡€æ¡ˆ&lt;/a&gt;ï¼Œæ–‡ç« ä½œè€…å®ç°ä¸€ä¸ªè·å–ä¼˜æƒ åˆ¸åˆ—è¡¨çš„RPCæ¥å£ï¼Œæ¥å£ä¸­çš„æ‰§è¡Œæµç¨‹å¤§æ¦‚æ˜¯å…ˆåœ¨ç¼“å­˜é‡Œè·å–ä¼˜æƒ åˆ¸åˆ—è¡¨ï¼Œæœ‰åˆ™è¿”å›ï¼Œæ²¡æœ‰åˆ™åœ¨æ•°æ®åº“é‡Œè·å–ï¼Œå°†ç»“æœå†™å…¥ç¼“å­˜å†è¿”å›ã€‚ç„¶è€Œï¼Œåœ¨é«˜å¹¶å‘è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œç¼“å­˜ä¼˜æƒ åˆ¸åˆ—è¡¨ä¸­å‡ºç°å¤§é‡çš„é‡å¤æ•°æ®ã€‚&lt;br&gt;ä¸»è¦åŸå› æ˜¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç¨‹åºåªé€‚åº”å•ä¾‹æ‰§è¡Œï¼Œæ²¡æœ‰è€ƒè™‘åˆ°å¤šä¾‹å¹¶å‘çš„æƒ…å†µï¼›&lt;/li&gt;
&lt;li&gt;ä¼˜æƒ åˆ¸åˆ—è¡¨åœ¨ç¼“å­˜ä¸­å­˜å‚¨ç»“æ„æ˜¯æ•°ç»„ï¼Œè€Œæ›´æ–°æ–¹æ³•æ˜¯ç›´æ¥è¿½åŠ ï¼›&lt;/li&gt;
&lt;li&gt;ç›´æ¥åœ¨RPCæ¥å£ä¸­æ‰§è¡Œæ›´æ–°ç¼“å­˜ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ–‡ç« ä½œè€…æœ€åé€šè¿‡åå¤åˆ¤æ–­æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½åŠæ³•ã€‚å…¶å®è¿™æ ·éœ€è¦åŠ¨æ€æ›´æ–°ç¼“å­˜åœºæ™¯åœ¨å¼€å‘ä¸­ååˆ†å¸¸è§ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ¢è®¨ä¸€ä¸‹ç›¸å¯¹å®Œå–„çš„è§£å†³æ–¹æ¡ˆã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æ–¹æ¡ˆ" scheme="https://breeze2.github.io/blog/categories/%E6%96%B9%E6%A1%88/"/>
    
    
      <category term="scheme" scheme="https://breeze2.github.io/blog/tags/scheme/"/>
    
      <category term="mysql" scheme="https://breeze2.github.io/blog/tags/mysql/"/>
    
      <category term="php" scheme="https://breeze2.github.io/blog/tags/php/"/>
    
      <category term="redis" scheme="https://breeze2.github.io/blog/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>ç”¨Dockeræ­å»ºRabbitMQé«˜å¯ç”¨é›†ç¾¤</title>
    <link href="https://breeze2.github.io/blog/practice-rabbitmq-ha-docker-compose.html"/>
    <id>https://breeze2.github.io/blog/practice-rabbitmq-ha-docker-compose.html</id>
    <published>2017-12-04T18:39:06.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://www.rabbitmq.com/" target="_blank" rel="noopener">RabbitMQ</a>æ˜¯åŸºäº<a href="https://www.amqp.org/" target="_blank" rel="noopener">é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰</a>å®ç°çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼Œä¸»è¦æä¾›æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ã€‚è¿™é‡Œä»‹ç»ç”¨Docker Composeæ­å»ºRabbitMQé«˜å¯ç”¨é›†ç¾¤çš„è¿‡ç¨‹ã€‚</p></blockquote><p>RabbitMQè‡ªèº«æä¾›éƒ¨ç½²é›†ç¾¤çš„åŠŸèƒ½ï¼Œé€šè¿‡å‘½ä»¤ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rabbitmqctl -n rabbit@rmqha_node1 stop_app</span><br><span class="line">$ rabbitmqctl -n rabbit@rmqha_node1 join_cluster --ram rabbit@rmqha_node0</span><br><span class="line">$ rabbitmqctl -n rabbit@rmqha_node1 start_app</span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥å¾ˆå®¹æ˜“çš„å°†èŠ‚ç‚¹rabbit@rmqha_node1åŠ å…¥åˆ°é›†ç¾¤rabbit@rmqha_node0ä¸­ã€‚<code>--ram</code>é€‰é¡¹è¡¨ç¤ºèŠ‚ç‚¹ä»¥å†…å­˜å­˜å‚¨æ–¹å¼è¿è¡Œï¼Œè¯»å†™é€Ÿåº¦å¿«ï¼Œé‡å¯åå†…å®¹ä¼šä¸¢å¤±ï¼›ä¸åŠ <code>--ram</code>é€‰é¡¹ï¼ŒèŠ‚ç‚¹åˆ™ä»¥ç£ç›˜å­˜å‚¨æ–¹å¼è¿è¡Œï¼Œè™½ç„¶è¯»å†™é€Ÿåº¦æ…¢ï¼Œä½†æ˜¯å†…å®¹ä¸€èˆ¬å¯ä»¥æŒä¹…ä¿æŒã€‚</p><p>åœ¨åŒä¸€ä¸ªRabbitMQé›†ç¾¤ä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´å¹¶æ²¡æœ‰ä¸»ä»ä¹‹åˆ†ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¼šåŒæ­¥ç›¸åŒçš„é˜Ÿåˆ—ç»“æ„ï¼Œé˜Ÿåˆ—å†…å®¹ï¼ˆæ¶ˆæ¯ï¼‰åˆ™å„è‡ªä¸åŒï¼Œä¸è¿‡æ¶ˆæ¯ä¼šåœ¨èŠ‚ç‚¹é—´ä¼ é€’ã€‚è¿™æ ·çš„é›†ç¾¤åªæ˜¯æé«˜äº†åº”å¯¹å¤§é‡å¹¶å‘è¯·æ±‚çš„èƒ½åŠ›ï¼Œæ•´ä½“å¯ç”¨æ€§è¿˜æ˜¯å¾ˆä½ï¼Œå› ä¸ºæŸä¸ªèŠ‚ç‚¹å®•æœºåï¼Œå¯„å­˜åœ¨è¯¥èŠ‚ç‚¹ä¸Šçš„æ¶ˆæ¯ä¸å¯ç”¨ï¼Œè€Œåœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šä¹Ÿæ²¡æœ‰è¿™äº›æ¶ˆæ¯çš„å¤‡ä»½ï¼Œè‹¥æ˜¯è¯¥èŠ‚ç‚¹æ— æ³•æ¢å¤ï¼Œé‚£ä¹ˆè¿™äº›æ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRabbitMQæä¾›é•œåƒé˜Ÿåˆ—åŠŸèƒ½ï¼Œé€šè¿‡å‘½ä»¤ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rabbitmqctl set_policy ha-all "^" '&#123;"ha-<span class="built_in">mode</span>":"all"&#125;'</span><br></pre></td></tr></table></figure><p>å¯ä»¥è®¾ç½®é•œåƒé˜Ÿåˆ—ï¼Œ<code>&quot;^&quot;</code>è¡¨ç¤ºåŒ¹é…æ‰€æœ‰é˜Ÿåˆ—ï¼Œå³æ‰€æœ‰é˜Ÿåˆ—åœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šæœ‰å¤‡ä»½ã€‚åœ¨é›†ç¾¤ä¸­ï¼Œåªéœ€è¦åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè®¾ç½®é•œåƒé˜Ÿåˆ—ï¼Œè®¾ç½®æ“ä½œä¼šåŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚</p><a id="more"></a><h2 id="Docker-Composeç¼–æ’"><a href="#Docker-Composeç¼–æ’" class="headerlink" title="Docker Composeç¼–æ’"></a>Docker Composeç¼–æ’</h2><p>è¿™ä¸ªç¼–æ’ä¸»è¦å®ç°ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ã€ä¸¤ä¸ªå†…å­˜èŠ‚ç‚¹çš„RabbitMQé›†ç¾¤å’Œä¸€ä¸ªHAProxyä»£ç†ã€‚</p><h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">L--rabbitmq-ha-docker                    //ä¸»ç›®å½•</span><br><span class="line">    L--scripts                           //æœ¬åœ°ï¼ˆDockerå®¿ä¸»ï¼‰ä½¿ç”¨çš„ä¸€äº›è„šæœ¬</span><br><span class="line">        L--rmqha_set_policy.sh           //è®¾ç½®å„ä¸ªæ•°æ®åº“è´¦å·å’Œå¼€å¯ä¸»ä»å¤åˆ¶</span><br><span class="line">    L--volumes                           //å„ä¸ªå®¹å™¨çš„æŒ‚è½½æ•°æ®å·</span><br><span class="line">        L--rmqha_proxy</span><br><span class="line">            L--haproxy.cfg               //HAProxyé…ç½®</span><br><span class="line">        L--rmqha_slave</span><br><span class="line">            L--cluster_entrypoint.sh     //å…¥å£æ–‡ä»¶</span><br><span class="line">    L--parameters.env                    //è´¦å·å¯†ç ç­‰ç¯å¢ƒå‚æ•°</span><br><span class="line">    L--docker-compose.yml                //ç¼–æ’é…ç½®</span><br></pre></td></tr></table></figure><h3 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"2"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  master:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">rabbitmq:3.6-management</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">rmqha_node0</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    mem_limit:</span> <span class="number">256</span><span class="string">m</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      net1:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">10.9</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">rmqha_node0</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"55672:15672"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"56720:5672"</span></span><br><span class="line"><span class="attr">    env_file:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./parameters.env</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CONTAINER_NAME=rmqha_node0</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">RABBITMQ_HOSTNAME=rmqha_node0</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">RABBITMQ_NODENAME=rabbit</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  slave1:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">rabbitmq:3.6-management</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">rmqha_node1</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    mem_limit:</span> <span class="number">256</span><span class="string">m</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      net1:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">10.9</span><span class="number">.0</span><span class="number">.11</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">rmqha_node1</span></span><br><span class="line">    <span class="comment"># ports:</span></span><br><span class="line">    <span class="comment">#   - "56721:5672"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/rmqha_slave/cluster_entrypoint.sh:/usr/local/bin/cluster_entrypoint.sh"</span></span><br><span class="line"><span class="attr">    entrypoint:</span> <span class="string">"/usr/local/bin/cluster_entrypoint.sh"</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">"rabbitmq-server"</span></span><br><span class="line"><span class="attr">    env_file:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./parameters.env</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CONTAINER_NAME=rmqha_node1</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">RABBITMQ_HOSTNAME=rmqha_node1</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">RABBITMQ_NODENAME=rabbit</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">RMQHA_RAM_NODE=true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  slave2:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">rabbitmq:3.6-management</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">rmqha_node2</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    mem_limit:</span> <span class="number">256</span><span class="string">m</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      net1:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">10.9</span><span class="number">.0</span><span class="number">.12</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">rmqha_node2</span></span><br><span class="line">    <span class="comment"># ports:</span></span><br><span class="line">    <span class="comment">#   - "56722:5672"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/rmqha_slave/cluster_entrypoint.sh:/usr/local/bin/cluster_entrypoint.sh"</span></span><br><span class="line"><span class="attr">    entrypoint:</span> <span class="string">"/usr/local/bin/cluster_entrypoint.sh"</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">"rabbitmq-server"</span></span><br><span class="line"><span class="attr">    env_file:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./parameters.env</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CONTAINER_NAME=rmqha_node2</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">RABBITMQ_HOSTNAME=rmqha_node2</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">RABBITMQ_NODENAME=rabbit</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">RMQHA_RAM_NODE=true</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  haproxy:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">haproxy:1.8</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">rmqha_proxy</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">slave1</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">slave2</span></span><br><span class="line"><span class="attr">    mem_limit:</span> <span class="number">256</span><span class="string">m</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      net1:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">10.9</span><span class="number">.0</span><span class="number">.19</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">rmqha_proxy</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"56729:5672"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"51080:1080"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/rmqha_proxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/rmqha_proxy:/root/rmqha_proxy"</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CONTAINER_NAME=rmqha_proxy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  net1:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">bridge</span></span><br><span class="line"><span class="attr">    ipam:</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line"><span class="attr">        - subnet:</span> <span class="number">10.9</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">          gateway:</span> <span class="number">10.9</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œé…ç½®äº†å››ä¸ªå®¹å™¨æœåŠ¡ï¼Œä¸€ä¸ª<code>haproxy</code>ï¼Œè´Ÿè´£ä»£ç†å„ä¸ªRabbitMQæœåŠ¡ï¼›ä¸‰ä¸ª<code>rabbitmq</code>ï¼Œç»„æˆRabbitMQé›†ç¾¤ã€‚æ¯ä¸ªå®¹å™¨æœåŠ¡éƒ½æŒ‡å®šäº†é™æ€IPï¼Œå³ä½¿æœåŠ¡é‡å¯ä¹Ÿä¸ä¼šå‡ºç°IPé”™ä¹±é—®é¢˜ï¼Œç‰¹æ®Šçš„ç½‘ç»œç«¯å£æ˜ å°„åé¢ä¼šä»‹ç»ã€‚</p><h3 id="ç¯å¢ƒå‚æ•°"><a href="#ç¯å¢ƒå‚æ•°" class="headerlink" title="ç¯å¢ƒå‚æ•°"></a>ç¯å¢ƒå‚æ•°</h3><p>parameters.env</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RMQHA_MASTER_NODE=rabbit</span><br><span class="line">RMQHA_MASTER_HOST=rmqha_node0</span><br><span class="line">RABBITMQ_DEFAULT_USER=guest</span><br><span class="line">RABBITMQ_DEFAULT_PASS=guest</span><br><span class="line">RABBITMQ_NODENAME=rabbit</span><br><span class="line">RABBITMQ_ERLANG_COOKIE=myerlangcookie</span><br></pre></td></tr></table></figure><h3 id="RabbitMQå¯åŠ¨"><a href="#RabbitMQå¯åŠ¨" class="headerlink" title="RabbitMQå¯åŠ¨"></a>RabbitMQå¯åŠ¨</h3><p>è¿™é‡ŒRabbitMQå®¹å™¨æ˜¯ä½¿ç”¨<a href="https://hub.docker.com/_/rabbitmq/" target="_blank" rel="noopener">Dockerå®˜æ–¹é•œåƒ</a>ç”Ÿæˆçš„ï¼ŒèŠ‚ç‚¹rmqha_node0å¯ä»¥ç›´æ¥å¯åŠ¨ï¼›è€ŒèŠ‚ç‚¹rmqha_node1å’Œrmqha_node2éœ€è¦åŠ å…¥åˆ°rmqha_node0é›†ç¾¤é‡Œï¼Œæ‰€ä»¥éœ€è¦éœ€æ”¹å…¥å£æ–‡ä»¶ã€‚<br>volumes/rmqha_slave/cluster_entrypoint.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">if [ -e "/root/is_not_first_time" ]; then</span><br><span class="line">    exec "$@"</span><br><span class="line">else</span><br><span class="line">    /usr/local/bin/docker-entrypoint.sh rabbitmq-server -detached # å…ˆæŒ‰å®˜æ–¹å…¥å£æ–‡ä»¶å¯åŠ¨ä¸”æ˜¯åå°è¿è¡Œ</span><br><span class="line"></span><br><span class="line">    rabbitmqctl -n "$RABBITMQ_NODENAME@$RABBITMQ_HOSTNAME" stop_app # åœæ­¢åº”ç”¨</span><br><span class="line">    rabbitmqctl -n "$RABBITMQ_NODENAME@$RABBITMQ_HOSTNAME" join_cluster $&#123;RMQHA_RAM_NODE:+--ram&#125; "$RMQHA_MASTER_NODE@$RMQHA_MASTER_HOST" # åŠ å…¥rmqha_node0é›†ç¾¤</span><br><span class="line">    rabbitmqctl -n "$RABBITMQ_NODENAME@$RABBITMQ_HOSTNAME" start_app # å¯åŠ¨åº”ç”¨</span><br><span class="line">    rabbitmqctl stop # åœæ­¢æ‰€æœ‰æœåŠ¡</span><br><span class="line"></span><br><span class="line">    touch /root/is_not_first_time</span><br><span class="line">    sleep 2s</span><br><span class="line">    exec "$@"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="HAProxyé…ç½®"><a href="#HAProxyé…ç½®" class="headerlink" title="HAProxyé…ç½®"></a>HAProxyé…ç½®</h3><p>è¿™é‡ŒHAProxyå®¹å™¨ä¹Ÿæ˜¯ä½¿ç”¨<a href="https://hub.docker.com/_/haproxy/" target="_blank" rel="noopener">Dockerå®˜æ–¹é•œåƒ</a>ç”Ÿæˆçš„ï¼Œå¯åŠ¨å‰éœ€è¦å…ˆå‡†å¤‡é…ç½®æ–‡ä»¶ã€‚<br>volumes/rmqha_proxy/haproxy.cfg</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log 127.0.0.1 local0</span><br><span class="line">    maxconn 4096</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log     global</span><br><span class="line">    mode    tcp</span><br><span class="line">    option  tcplog</span><br><span class="line">    retries 3</span><br><span class="line">    option  redispatch</span><br><span class="line">    maxconn 2000</span><br><span class="line">    timeout connect 5000</span><br><span class="line">    timeout client 50000</span><br><span class="line">    timeout server 50000</span><br><span class="line"></span><br><span class="line"># ssl for rabbitmq</span><br><span class="line"># frontend ssl_rabbitmq</span><br><span class="line">    # bind *:5673 ssl crt /root/rmqha_proxy/rmqha.pem</span><br><span class="line">    # mode tcp</span><br><span class="line">    # default_backend rabbitmq</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    bind *:1080 # haproxyå®¹å™¨1080ç«¯å£æ˜¾ç¤ºä»£ç†ç»Ÿè®¡é¡µé¢ï¼Œæ˜ å°„åˆ°å®¿ä¸»51080ç«¯å£</span><br><span class="line">    mode http</span><br><span class="line">    stats enable</span><br><span class="line">    stats hide-version</span><br><span class="line">    stats realm Haproxy\ Statistics</span><br><span class="line">    stats uri /</span><br><span class="line">    stats auth admin:admin</span><br><span class="line"></span><br><span class="line">listen rabbitmq</span><br><span class="line">    bind *:5672 # haproxyå®¹å™¨5672ç«¯å£ä»£ç†å¤šä¸ªrabbitmqæœåŠ¡ï¼Œæ˜ å°„åˆ°å®¿ä¸»56729ç«¯å£</span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin</span><br><span class="line">    timeout client 1h</span><br><span class="line">    timeout server 1h</span><br><span class="line">    option  clitcpka</span><br><span class="line">    # server  rmqha_node0 rmqha_node0:5672  check inter 5s rise 2 fall 3</span><br><span class="line">    server  rmqha_node1 rmqha_node1:5672  check inter 5s rise 2 fall 3</span><br><span class="line">    server  rmqha_node2 rmqha_node2:5672  check inter 5s rise 2 fall 3</span><br></pre></td></tr></table></figure><h2 id="å®é™…è¿è¡Œ"><a href="#å®é™…è¿è¡Œ" class="headerlink" title="å®é™…è¿è¡Œ"></a>å®é™…è¿è¡Œ</h2><p>åœ¨ä¸»ç›®å½•ä¸‹æ‰§è¡Œ<code>docker-compose up -d</code>æ„å»ºå¹¶è¿è¡Œæ•´ä¸ªDockeræœåŠ¡ã€‚</p><h3 id="é•œåƒé˜Ÿåˆ—"><a href="#é•œåƒé˜Ÿåˆ—" class="headerlink" title="é•œåƒé˜Ÿåˆ—"></a>é•œåƒé˜Ÿåˆ—</h3><p>ï¼Œåœ¨ä¸»ç›®å½•ä¸‹æ‰§è¡Œï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sh ./scripts/rmqha_set_policy.sh</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šæ˜¯æ‰§è¡Œäº†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it rmqha_node0 rabbitmqctl set_policy ha-all &apos;^&apos; &apos;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&apos;</span><br></pre></td></tr></table></figure><p>å³åœ¨rmqha_node0é›†ç¾¤ä¸­å°†æ‰€æœ‰é˜Ÿåˆ—è®¾ç½®ä¸ºé•œåƒé˜Ÿåˆ—ï¼Œè¿™ä¸ªå‘½ä»¤åªéœ€æ‰§è¡Œä¸€æ¬¡ï¼Œé™¤éé‡æ–°æ„å»ºæ•´ä¸ªDockeræœåŠ¡ã€‚</p><h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>ç”¨ä¸¤ä¸ªPHPè„šæœ¬å¯ä»¥å¯¹RabbitMQè¿›è¡Œç®€å•çš„æµ‹è¯•ï¼Œä¸è¿‡éœ€è¦ç”¨åˆ°<code>php-amqplib</code>åº“ã€‚</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ composer require php-amqplib/php-amqplib</span><br></pre></td></tr></table></figure><p>å‘é€æ¶ˆæ¯è„šæœ¬ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// send.php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</span><br><span class="line"></span><br><span class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'127.0.0.1'</span>, <span class="number">56729</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>, <span class="string">'/'</span>); <span class="comment">// è¿æ¥rmqha_proxy</span></span><br><span class="line">$channel    = $connection-&gt;channel();</span><br><span class="line">$channel-&gt;queue_declare(<span class="string">'task_queue'</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">$data = <span class="string">"Hello World!"</span>;</span><br><span class="line"></span><br><span class="line">$msg = <span class="keyword">new</span> AMQPMessage($data,</span><br><span class="line">    <span class="keyword">array</span>(<span class="string">'delivery_mode'</span> =&gt; AMQPMessage::DELIVERY_MODE_PERSISTENT)</span><br><span class="line">);</span><br><span class="line">$channel-&gt;basic_publish($msg, <span class="string">''</span>, <span class="string">'task_queue'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">" [x] Sent "</span>, $data, <span class="string">"\n"</span>;</span><br><span class="line">$channel-&gt;close();</span><br><span class="line">$connection-&gt;close();</span><br></pre></td></tr></table></figure><p>æ¥å—æ¶ˆæ¯è„šæœ¬ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// receive.php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</span><br><span class="line"></span><br><span class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'127.0.0.1'</span>, <span class="number">56720</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>, <span class="string">'/'</span>); <span class="comment">// è¿æ¥rmqha_node0</span></span><br><span class="line">$channel    = $connection-&gt;channel();</span><br><span class="line">$channel-&gt;queue_declare(<span class="string">'task_queue'</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">' [*] Waiting for messages. To exit press CTRL+C'</span>, <span class="string">"\n"</span>;</span><br><span class="line">$callback = <span class="function"><span class="keyword">function</span> <span class="params">($msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">" [x] Received "</span>, $msg-&gt;body, <span class="string">"\n"</span>;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">" [x] Done"</span>, <span class="string">"\n"</span>;</span><br><span class="line">    $msg-&gt;delivery_info[<span class="string">'channel'</span>]-&gt;basic_ack($msg-&gt;delivery_info[<span class="string">'delivery_tag'</span>]);</span><br><span class="line">&#125;;</span><br><span class="line">$channel-&gt;basic_qos(<span class="keyword">null</span>, <span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line">$channel-&gt;basic_consume(<span class="string">'task_queue'</span>, <span class="string">''</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, $callback);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (count($channel-&gt;callbacks)) &#123;</span><br><span class="line">    $channel-&gt;wait();</span><br><span class="line">&#125;</span><br><span class="line">$channel-&gt;close();</span><br><span class="line">$connection-&gt;close();</span><br></pre></td></tr></table></figure><h2 id="SSLè®¾ç½®"><a href="#SSLè®¾ç½®" class="headerlink" title="SSLè®¾ç½®"></a>SSLè®¾ç½®</h2><p>ä¸ºäº†RabbitMQæœåŠ¡åœ¨ç½‘ç»œä¼ è¾“ä¸­ä¸æ³„æ¼ä¿¡æ¯ï¼Œå¯ä»¥ç»™HAProxyè®¾ç½®SSLä¼ è¾“ï¼ˆæ¯”å¯¹å„ä¸ªRabbitMQæœåŠ¡è®¾ç½®SSLä¼ è¾“çš„æ€§èƒ½æ¶ˆè€—è¦å°ï¼‰ï¼Œè¿™é‡Œç®€å•çš„ä»‹ç»ä¸€ä¸‹è‡ªç­¾è¯ä¹¦ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ./volumes/rmqha_proxy/</span><br><span class="line">$ openssl genrsa -out rmqha.key <span class="number">1024</span> # éšæœºç”Ÿæˆä¸€ä¸ªç§é’¥</span><br><span class="line">$ openssl req -new -key rmqha.key -out rmqha.csr # æ ¹æ®ç§é’¥ç”Ÿæˆè¯ä¹¦ç­¾ç½²è¯·æ±‚</span><br><span class="line">$ openssl x509 -req -days <span class="number">365</span> -<span class="keyword">in</span> rmqha.csr -signkey rmqha.key -out rmqha.crt # è‡ªå·±ç­¾ç½²è¯ä¹¦</span><br><span class="line">$ cat rmqha.crt rmqha.key|tee rmqha.pem # å°†ç§é’¥å’Œè¯ä¹¦åˆå¹¶åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šç”Ÿæˆè¯ä¹¦ç­¾ç½²è¯·æ±‚æ—¶ï¼Œéœ€è¦å¡«å†™ä¸€äº›ä¿¡æ¯ï¼Œ<code>Common Name (eg, fully qualified host name)</code>åº”è¯¥å†™<code>127.0.0.1</code>ã€‚<br>HAProxyé…ç½®ä¸­æ·»åŠ ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ssl for rabbitmq</span><br><span class="line">frontend ssl_rabbitmq</span><br><span class="line">    bind *:5673 ssl crt /root/rmqha_proxy/rmqha.pem # haproxyå®¹å™¨5673ç«¯å£ä»£ç†rabbitmqæœåŠ¡ï¼Œéœ€è¦æ˜ å°„åˆ°å®¿ä¸»ç«¯å£</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend rabbitmq</span><br></pre></td></tr></table></figure><p>PHPä¸­é€šè¿‡SSLè¿æ¥HAProxyä»£ç†æœåŠ¡ç¤ºä¾‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPSSLConnection</span>;</span><br><span class="line">$connection = <span class="keyword">new</span> AMQPSSLConnection(<span class="string">'127.0.0.1'</span>, <span class="number">56730</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>, <span class="string">'/'</span>, [<span class="string">'cafile'</span>=&gt;<span class="string">'./rmqha.crt'</span>]); <span class="comment">// å‡è®¾SSLçš„ç›‘å¬ç«¯å£æ˜¯56730ï¼Œrmqha.crtæ˜¯ä¸Šé¢ç”Ÿæˆçš„è‡ªç­¾è¯ä¹¦</span></span><br><span class="line">$channel    = $connection-&gt;channel();</span><br></pre></td></tr></table></figure><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><h3 id="å»ºè®®"><a href="#å»ºè®®" class="headerlink" title="å»ºè®®"></a>å»ºè®®</h3><ol><li>æ¶ˆæ¯ç”Ÿäº§è€…å¯ä»¥é€šè¿‡HAProxyä»£ç†è¿æ¥RabbitMQæœåŠ¡ï¼Œå®ç°è´Ÿè½½å‡è¡¡ï¼›</li><li>æ¶ˆæ¯å¤„ç†è€…åº”è¯¥ç›´æ¥è¿æ¥RabbitMQæœåŠ¡ä¸»æœºï¼Œå¹¶ä¸”è·ŸéšRabbitMQæœåŠ¡ä¸»æœºå¯åŠ¨æœåŠ¡ã€åœæ­¢æœåŠ¡ã€‚</li></ol><h3 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h3><ul><li><a href="https://addops.cn/post/rabbitmq-ha-mirror.html" target="_blank" rel="noopener">Rabbitmqé«˜å¯ç”¨-é•œåƒé˜Ÿåˆ—æ¨¡å¼</a></li><li><a href="http://www.cnblogs.com/flat_peach/archive/2013/04/07/3004008.html" target="_blank" rel="noopener">Rabbitmqé›†ç¾¤é«˜å¯ç”¨æµ‹è¯•</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.rabbitmq.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;RabbitMQ&lt;/a&gt;æ˜¯åŸºäº&lt;a href=&quot;https://www.amqp.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰&lt;/a&gt;å®ç°çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼Œä¸»è¦æä¾›æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ã€‚è¿™é‡Œä»‹ç»ç”¨Docker Composeæ­å»ºRabbitMQé«˜å¯ç”¨é›†ç¾¤çš„è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;RabbitMQè‡ªèº«æä¾›éƒ¨ç½²é›†ç¾¤çš„åŠŸèƒ½ï¼Œé€šè¿‡å‘½ä»¤ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight cmd&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ rabbitmqctl -n rabbit@rmqha_node1 stop_app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ rabbitmqctl -n rabbit@rmqha_node1 join_cluster --ram rabbit@rmqha_node0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ rabbitmqctl -n rabbit@rmqha_node1 start_app&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;å°±å¯ä»¥å¾ˆå®¹æ˜“çš„å°†èŠ‚ç‚¹rabbit@rmqha_node1åŠ å…¥åˆ°é›†ç¾¤rabbit@rmqha_node0ä¸­ã€‚&lt;code&gt;--ram&lt;/code&gt;é€‰é¡¹è¡¨ç¤ºèŠ‚ç‚¹ä»¥å†…å­˜å­˜å‚¨æ–¹å¼è¿è¡Œï¼Œè¯»å†™é€Ÿåº¦å¿«ï¼Œé‡å¯åå†…å®¹ä¼šä¸¢å¤±ï¼›ä¸åŠ &lt;code&gt;--ram&lt;/code&gt;é€‰é¡¹ï¼ŒèŠ‚ç‚¹åˆ™ä»¥ç£ç›˜å­˜å‚¨æ–¹å¼è¿è¡Œï¼Œè™½ç„¶è¯»å†™é€Ÿåº¦æ…¢ï¼Œä½†æ˜¯å†…å®¹ä¸€èˆ¬å¯ä»¥æŒä¹…ä¿æŒã€‚&lt;/p&gt;
&lt;p&gt;åœ¨åŒä¸€ä¸ªRabbitMQé›†ç¾¤ä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´å¹¶æ²¡æœ‰ä¸»ä»ä¹‹åˆ†ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¼šåŒæ­¥ç›¸åŒçš„é˜Ÿåˆ—ç»“æ„ï¼Œé˜Ÿåˆ—å†…å®¹ï¼ˆæ¶ˆæ¯ï¼‰åˆ™å„è‡ªä¸åŒï¼Œä¸è¿‡æ¶ˆæ¯ä¼šåœ¨èŠ‚ç‚¹é—´ä¼ é€’ã€‚è¿™æ ·çš„é›†ç¾¤åªæ˜¯æé«˜äº†åº”å¯¹å¤§é‡å¹¶å‘è¯·æ±‚çš„èƒ½åŠ›ï¼Œæ•´ä½“å¯ç”¨æ€§è¿˜æ˜¯å¾ˆä½ï¼Œå› ä¸ºæŸä¸ªèŠ‚ç‚¹å®•æœºåï¼Œå¯„å­˜åœ¨è¯¥èŠ‚ç‚¹ä¸Šçš„æ¶ˆæ¯ä¸å¯ç”¨ï¼Œè€Œåœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šä¹Ÿæ²¡æœ‰è¿™äº›æ¶ˆæ¯çš„å¤‡ä»½ï¼Œè‹¥æ˜¯è¯¥èŠ‚ç‚¹æ— æ³•æ¢å¤ï¼Œé‚£ä¹ˆè¿™äº›æ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRabbitMQæä¾›é•œåƒé˜Ÿåˆ—åŠŸèƒ½ï¼Œé€šè¿‡å‘½ä»¤ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight cmd&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ rabbitmqctl set_policy ha-all &quot;^&quot; &#39;&amp;#123;&quot;ha-&lt;span class=&quot;built_in&quot;&gt;mode&lt;/span&gt;&quot;:&quot;all&quot;&amp;#125;&#39;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;å¯ä»¥è®¾ç½®é•œåƒé˜Ÿåˆ—ï¼Œ&lt;code&gt;&amp;quot;^&amp;quot;&lt;/code&gt;è¡¨ç¤ºåŒ¹é…æ‰€æœ‰é˜Ÿåˆ—ï¼Œå³æ‰€æœ‰é˜Ÿåˆ—åœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šæœ‰å¤‡ä»½ã€‚åœ¨é›†ç¾¤ä¸­ï¼Œåªéœ€è¦åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè®¾ç½®é•œåƒé˜Ÿåˆ—ï¼Œè®¾ç½®æ“ä½œä¼šåŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
      <category term="docker" scheme="https://breeze2.github.io/blog/tags/docker/"/>
    
      <category term="rabbitmq" scheme="https://breeze2.github.io/blog/tags/rabbitmq/"/>
    
      <category term="haproxy" scheme="https://breeze2.github.io/blog/tags/haproxy/"/>
    
  </entry>
  
  <entry>
    <title>JSå®ç°äººè„¸æ¢å¦†å’Œé¡µé¢æˆªå›¾</title>
    <link href="https://breeze2.github.io/blog/practice-js-face-makeup-and-html2canvas.html"/>
    <id>https://breeze2.github.io/blog/practice-js-face-makeup-and-html2canvas.html</id>
    <published>2017-11-20T09:46:23.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘è¦åšä¸€ä¸ªH5æ´»åŠ¨é¡µé¢ï¼Œå¤§æ¦‚åŠŸèƒ½æ˜¯ç»™å›¾ç‰‡äººè„¸æ¢å¦†ï¼Œè‡ªç„¶ä¹Ÿå°‘ä¸äº†ä¸Šä¼ åŸå§‹å›¾ç‰‡å’Œå¯¼å‡ºæœ€ç»ˆå›¾ç‰‡ç­‰åŠŸèƒ½ã€‚å¦‚æœå›¾ç‰‡åŠ å·¥ï¼ˆå³äººè„¸æ¢å¦†ï¼‰æ”¾åœ¨æœåŠ¡å™¨å¤„ç†ï¼Œé‚£ä¹ˆå¹¶å‘é‡é«˜çš„æ—¶å€™ï¼Œè‚¯å®šäº§ç”Ÿå¤§é‡é˜»å¡ã€‚äºæ˜¯æƒ³æŠŠå›¾ç‰‡åŠ å·¥æ”¾åœ¨å®¢æˆ·ç«¯å¤„ç†ï¼Œç”¨HTMLå †ç Œå‡ºå›¾ç‰‡çš„æœ€ç»ˆæ•ˆæœï¼Œä½†æ˜¯æ€æ ·æŠŠHTMLå¯¼å‡ºæˆå›¾ç‰‡å‘¢ï¼Ÿ</p></blockquote><h2 id="å›¾ç‰‡ä¸Šä¼ "><a href="#å›¾ç‰‡ä¸Šä¼ " class="headerlink" title="å›¾ç‰‡ä¸Šä¼ "></a>å›¾ç‰‡ä¸Šä¼ </h2><p>å›¾ç‰‡ä¸Šä¼ å¯ä»¥å‚è€ƒ<a href="https://blog.breezelin.site/2017/08/12/scheme-nginx-php-js-upload-process/" target="_blank" rel="noopener">HTTPæ–‡ä»¶ä¸Šä¼ çš„ä¸€ä¸ªåç«¯å®Œå–„æ–¹æ¡ˆï¼ˆNginXï¼‰</a>ï¼Œæˆ–è€…ä½¿ç”¨ç°æœ‰çš„äº‘å­˜å‚¨æœåŠ¡ï¼Œå¦‚<a href="https://www.qiniu.com/" target="_blank" rel="noopener">ä¸ƒç‰›</a>ç­‰ç­‰ã€‚</p><h2 id="äº”å®˜å®šä½"><a href="#äº”å®˜å®šä½" class="headerlink" title="äº”å®˜å®šä½"></a>äº”å®˜å®šä½</h2><p>äººè„¸è¯†åˆ«å’Œäº”å®˜å®šä½å¯ä»¥åˆ©ç”¨<a href="https://opencv.org/" target="_blank" rel="noopener">OpenVC</a>è‡ªè¡Œå®ç°ï¼Œæˆ–è€…ä½¿ç”¨æˆç†Ÿçš„äº‘è¯†åˆ«æœåŠ¡ï¼Œå¦‚<a href="https://www.faceplusplus.com.cn/" target="_blank" rel="noopener">Face++</a>ç­‰ç­‰ã€‚è¿™é‡Œä½¿ç”¨è…¾è®¯äº‘çš„äººè„¸è¯†åˆ«æœåŠ¡ã€‚</p><a id="more"></a><h2 id="äººè„¸æ¢å¦†"><a href="#äººè„¸æ¢å¦†" class="headerlink" title="äººè„¸æ¢å¦†"></a>äººè„¸æ¢å¦†</h2><p>å‡è®¾æœ‰ä¸€å¼ å›¾ç‰‡ï¼Œè¯†åˆ«ç»“æœå¦‚ä¸‹ï¼š<br><img src="/blog/assets/images/practice-js-face-makeup-and-html2canvas1.png" alt="è¯†åˆ«ç»“æœ"></p><blockquote><p>å›¾ç‰‡æ¥æºï¼š<a href="https://cloud.tencent.com/act/event/ci_demo.html" target="_blank" rel="noopener">ä¸‡è±¡ä¼˜å›¾-è…¾è®¯äº‘</a></p></blockquote><p>æ ¹æ®äº”å®˜å®šä½ç‚¹ï¼Œåœ¨é€‚å½“ä½ç½®ç»™äººè„¸æ·»ä¸Šå¦†é¥°ï¼Œæ¯”å¦‚å°èƒ¡å­ï¼š<br><img src="/blog/assets/images/practice-js-face-makeup-and-html2canvas2.png" alt="å°èƒ¡å­"></p><p>æºç ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"padding: 0; margin: 0;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width: 100%; text-align: center;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width: 336px; margin-left: auto; margin-right: auto; position: relative;"</span> <span class="attr">id</span>=<span class="string">"div1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"./face.png"</span> <span class="attr">style</span>=<span class="string">"width: 100%;"</span> <span class="attr">id</span>=<span class="string">"face"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> FACE = &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="string">"session_id"</span>:<span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">            <span class="string">"face_shape"</span>:[</span></span><br><span class="line">                &#123;</span><br><span class="line"><span class="actionscript">                    <span class="string">"face_profile"</span>:[&#123;<span class="string">"x"</span>:<span class="number">49</span>,<span class="string">"y"</span>:<span class="number">231</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">59</span>,<span class="string">"y"</span>:<span class="number">249</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">71</span>,<span class="string">"y"</span>:<span class="number">267</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">84</span>,<span class="string">"y"</span>:<span class="number">284</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">100</span>,<span class="string">"y"</span>:<span class="number">298</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">118</span>,<span class="string">"y"</span>:<span class="number">310</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">138</span>,<span class="string">"y"</span>:<span class="number">318</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">158</span>,<span class="string">"y"</span>:<span class="number">324</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">178</span>,<span class="string">"y"</span>:<span class="number">329</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">198</span>,<span class="string">"y"</span>:<span class="number">329</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">217</span>,<span class="string">"y"</span>:<span class="number">323</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">232</span>,<span class="string">"y"</span>:<span class="number">309</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">239</span>,<span class="string">"y"</span>:<span class="number">291</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">244</span>,<span class="string">"y"</span>:<span class="number">271</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">249</span>,<span class="string">"y"</span>:<span class="number">252</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">252</span>,<span class="string">"y"</span>:<span class="number">232</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">253</span>,<span class="string">"y"</span>:<span class="number">213</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">251</span>,<span class="string">"y"</span>:<span class="number">194</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">247</span>,<span class="string">"y"</span>:<span class="number">175</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">240</span>,<span class="string">"y"</span>:<span class="number">157</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">232</span>,<span class="string">"y"</span>:<span class="number">142</span>&#125;],</span></span><br><span class="line"><span class="actionscript">                    <span class="string">"left_eye"</span>:[&#123;<span class="string">"x"</span>:<span class="number">89</span>,<span class="string">"y"</span>:<span class="number">209</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">100</span>,<span class="string">"y"</span>:<span class="number">210</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">110</span>,<span class="string">"y"</span>:<span class="number">207</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">120</span>,<span class="string">"y"</span>:<span class="number">202</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">128</span>,<span class="string">"y"</span>:<span class="number">196</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">117</span>,<span class="string">"y"</span>:<span class="number">190</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">105</span>,<span class="string">"y"</span>:<span class="number">191</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">95</span>,<span class="string">"y"</span>:<span class="number">198</span>&#125;],</span></span><br><span class="line"><span class="actionscript">                    <span class="string">"right_eye"</span>:[&#123;<span class="string">"x"</span>:<span class="number">209</span>,<span class="string">"y"</span>:<span class="number">153</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">204</span>,<span class="string">"y"</span>:<span class="number">161</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">196</span>,<span class="string">"y"</span>:<span class="number">167</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">186</span>,<span class="string">"y"</span>:<span class="number">170</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">176</span>,<span class="string">"y"</span>:<span class="number">172</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">179</span>,<span class="string">"y"</span>:<span class="number">161</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">187</span>,<span class="string">"y"</span>:<span class="number">154</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">198</span>,<span class="string">"y"</span>:<span class="number">150</span>&#125;],</span></span><br><span class="line"><span class="actionscript">                    <span class="string">"left_eyebrow"</span>:[&#123;<span class="string">"x"</span>:<span class="number">58</span>,<span class="string">"y"</span>:<span class="number">190</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">72</span>,<span class="string">"y"</span>:<span class="number">180</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">89</span>,<span class="string">"y"</span>:<span class="number">175</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">106</span>,<span class="string">"y"</span>:<span class="number">172</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">122</span>,<span class="string">"y"</span>:<span class="number">167</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">105</span>,<span class="string">"y"</span>:<span class="number">161</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">86</span>,<span class="string">"y"</span>:<span class="number">165</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">68</span>,<span class="string">"y"</span>:<span class="number">174</span>&#125;],</span></span><br><span class="line"><span class="actionscript">                    <span class="string">"right_eyebrow"</span>:[&#123;<span class="string">"x"</span>:<span class="number">214</span>,<span class="string">"y"</span>:<span class="number">120</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">200</span>,<span class="string">"y"</span>:<span class="number">125</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">187</span>,<span class="string">"y"</span>:<span class="number">133</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">175</span>,<span class="string">"y"</span>:<span class="number">143</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">162</span>,<span class="string">"y"</span>:<span class="number">150</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">169</span>,<span class="string">"y"</span>:<span class="number">135</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">182</span>,<span class="string">"y"</span>:<span class="number">123</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">198</span>,<span class="string">"y"</span>:<span class="number">115</span>&#125;],</span></span><br><span class="line"><span class="actionscript">                    <span class="string">"mouth"</span>:[&#123;<span class="string">"x"</span>:<span class="number">149</span>,<span class="string">"y"</span>:<span class="number">279</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">165</span>,<span class="string">"y"</span>:<span class="number">290</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">184</span>,<span class="string">"y"</span>:<span class="number">294</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">202</span>,<span class="string">"y"</span>:<span class="number">289</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">215</span>,<span class="string">"y"</span>:<span class="number">276</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">219</span>,<span class="string">"y"</span>:<span class="number">258</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">219</span>,<span class="string">"y"</span>:<span class="number">239</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">208</span>,<span class="string">"y"</span>:<span class="number">241</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">196</span>,<span class="string">"y"</span>:<span class="number">246</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">189</span>,<span class="string">"y"</span>:<span class="number">253</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">178</span>,<span class="string">"y"</span>:<span class="number">256</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">163</span>,<span class="string">"y"</span>:<span class="number">266</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">165</span>,<span class="string">"y"</span>:<span class="number">282</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">181</span>,<span class="string">"y"</span>:<span class="number">281</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">197</span>,<span class="string">"y"</span>:<span class="number">277</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">207</span>,<span class="string">"y"</span>:<span class="number">266</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">214</span>,<span class="string">"y"</span>:<span class="number">254</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">209</span>,<span class="string">"y"</span>:<span class="number">245</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">200</span>,<span class="string">"y"</span>:<span class="number">252</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">191</span>,<span class="string">"y"</span>:<span class="number">258</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">177</span>,<span class="string">"y"</span>:<span class="number">266</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">163</span>,<span class="string">"y"</span>:<span class="number">273</span>&#125;],</span></span><br><span class="line"><span class="actionscript">                    <span class="string">"nose"</span>:[&#123;<span class="string">"x"</span>:<span class="number">180</span>,<span class="string">"y"</span>:<span class="number">231</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">155</span>,<span class="string">"y"</span>:<span class="number">187</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">154</span>,<span class="string">"y"</span>:<span class="number">201</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">154</span>,<span class="string">"y"</span>:<span class="number">216</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">153</span>,<span class="string">"y"</span>:<span class="number">230</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">152</span>,<span class="string">"y"</span>:<span class="number">247</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">170</span>,<span class="string">"y"</span>:<span class="number">248</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">186</span>,<span class="string">"y"</span>:<span class="number">245</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">196</span>,<span class="string">"y"</span>:<span class="number">235</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">203</span>,<span class="string">"y"</span>:<span class="number">219</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">190</span>,<span class="string">"y"</span>:<span class="number">211</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">178</span>,<span class="string">"y"</span>:<span class="number">203</span>&#125;,&#123;<span class="string">"x"</span>:<span class="number">167</span>,<span class="string">"y"</span>:<span class="number">195</span>&#125;]</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line"><span class="actionscript">            <span class="string">"image_height"</span>:<span class="number">430</span>,</span></span><br><span class="line"><span class="actionscript">            <span class="string">"image_width"</span>:<span class="number">336</span></span></span><br><span class="line"><span class="actionscript">        &#125;; <span class="comment">// äººè„¸è¯†åˆ«ç»“æœ</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> BEARD = &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="string">"src"</span>:<span class="string">"./beard.png"</span>,</span></span><br><span class="line"><span class="actionscript">            <span class="string">"image_height"</span>:<span class="number">222</span>,</span></span><br><span class="line"><span class="actionscript">            <span class="string">"image_width"</span>:<span class="number">567</span></span></span><br><span class="line"><span class="actionscript">        &#125;; <span class="comment">// èƒ¡å­å›¾ç‰‡ä¿¡æ¯</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">parseEyesData</span><span class="params">(leye, reye)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> lx = ly = <span class="number">0</span>;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> rx = ry = <span class="number">0</span>;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> leye) &#123;</span></span><br><span class="line"><span class="actionscript">                lx += leye[i][<span class="string">'x'</span>]; ly += leye[i][<span class="string">'y'</span>];</span></span><br><span class="line">            &#125;</span><br><span class="line">            lx = lx/leye.length; ly = ly/leye.length;</span><br><span class="line"><span class="actionscript">            <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> reye) &#123;</span></span><br><span class="line"><span class="actionscript">                rx += reye[i][<span class="string">'x'</span>]; ry += reye[i][<span class="string">'y'</span>];</span></span><br><span class="line">            &#125;</span><br><span class="line">            rx = rx/leye.length; ry = ry/leye.length;</span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">                angle: <span class="built_in">Math</span>.atan((ly-ry)/(lx-rx))/<span class="built_in">Math</span>.PI*(<span class="number">180</span>),</span></span><br><span class="line"><span class="javascript">                span: <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(lx-rx, <span class="number">2</span>)+<span class="built_in">Math</span>.pow(ly-ry, <span class="number">2</span>))</span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="actionscript">        &#125; <span class="comment">// æ ¹æ®çœ¼ç›æ•°æ®ï¼Œè·å–è„¸å€¾è§’å’Œçœ¼å¿ƒè·</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> div1 = <span class="built_in">document</span>.getElementById(<span class="string">'div1'</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> edata = parseEyesData(FACE[<span class="string">'face_shape'</span>][<span class="number">0</span>][<span class="string">'left_eye'</span>], FACE[<span class="string">'face_shape'</span>][<span class="number">0</span>][<span class="string">'right_eye'</span>]);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> beard = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> scale = div1.offsetWidth/FACE[<span class="string">'image_width'</span>];</span></span><br><span class="line">        </span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> point1 = FACE[<span class="string">'face_shape'</span>][<span class="number">0</span>][<span class="string">'nose'</span>][<span class="number">0</span>]; <span class="comment">// é¼»å°–</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> point2 = FACE[<span class="string">'face_shape'</span>][<span class="number">0</span>][<span class="string">'nose'</span>][<span class="number">7</span>]; <span class="comment">// é¼»ä½</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> point3 = FACE[<span class="string">'face_shape'</span>][<span class="number">0</span>][<span class="string">'mouth'</span>][<span class="number">9</span>]; <span class="comment">//ä¸Šå”‡ä¸Šä¸­ç‚¹</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> beardx = ((point1[<span class="string">'x'</span>]+point2[<span class="string">'x'</span>])/<span class="number">2</span>+point3[<span class="string">'x'</span>])/<span class="number">2</span>*scale; <span class="comment">// å¤§æ¦‚ç®—å‡ºäººä¸­Xåæ ‡</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> beardy = ((point1[<span class="string">'y'</span>]+point2[<span class="string">'y'</span>])/<span class="number">2</span>+point3[<span class="string">'y'</span>])/<span class="number">2</span>*scale; <span class="comment">// å¤§æ¦‚ç®—å‡ºäººä¸­Yåæ ‡</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> beardw = edata[<span class="string">'span'</span>]*scale; <span class="comment">// èƒ¡å­é•¿åº¦å–çœ¼å¿ƒè·å€¼</span></span></span><br><span class="line">        beard.width = beardw;</span><br><span class="line"><span class="actionscript">        beard.src = <span class="string">'./beard.png'</span>;</span></span><br><span class="line"><span class="actionscript">        beard.style.transform = <span class="string">'rotate('</span>+edata[<span class="string">'angle'</span>]+<span class="string">'deg)'</span>;</span></span><br><span class="line"><span class="actionscript">        beard.style.position = <span class="string">'absolute'</span>;</span></span><br><span class="line"><span class="actionscript">        beard.style.top = (beardy-beardw/<span class="number">2</span>/(BEARD[<span class="string">'image_width'</span>]/BEARD[<span class="string">'image_height'</span>]))+<span class="string">'px'</span>;</span></span><br><span class="line"><span class="actionscript">        beard.style.left = (beardx-beardw/<span class="number">2</span>)+<span class="string">'px'</span>;</span></span><br><span class="line">        </span><br><span class="line">        div1.appendChild(beard);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ•ˆæœï¼š<br><img src="/blog/assets/images/practice-js-face-makeup-and-html2canvas3.png" alt="æœ€ç»ˆæ•ˆæœ"></p><p>è¿™åªæ˜¯HTMLï¼Œæ€æ ·ä¿å­˜æˆå›¾ç‰‡å‘¢ï¼Ÿ</p><h2 id="å¯¼å‡ºå›¾ç‰‡"><a href="#å¯¼å‡ºå›¾ç‰‡" class="headerlink" title="å¯¼å‡ºå›¾ç‰‡"></a>å¯¼å‡ºå›¾ç‰‡</h2><p>æŠŠHTMLä¿å­˜æˆå›¾ç‰‡ï¼Œåœ¨æœåŠ¡å™¨ä¸Šå¯ä»¥ç”¨<a href="http://phantomjs.org/" target="_blank" rel="noopener">PhantomJS</a>å®ç°ï¼Œåœ¨æµè§ˆå™¨ä¸Šå‘¢ï¼Ÿå…¶å®ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ï¼Œé¦–å…ˆå°†HTMLï¼ˆDOMç»“æ„ï¼‰å†™å…¥Canvasï¼ŒCanvaså†å¯¼å‡ºDataURLï¼Œæœ€åDataURLèµ‹äºˆimgæ ‡ç­¾çš„srcå±æ€§ï¼Œä¾¿å¾—åˆ°æœ€ç»ˆå›¾ç‰‡ï¼Œè¯¦æƒ…è¯·é˜…è¯»<a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Drawing_DOM_objects_into_a_canvas" target="_blank" rel="noopener">Drawing DOM objects into a canvas</a>ã€‚</p><p>è¿™é‡Œä½¿ç”¨æ’ä»¶<a href="https://github.com/niklasvh/html2canvas" target="_blank" rel="noopener">html2canvas</a>æ¥å®ç°HTMLå†™å…¥CanvasåŠŸèƒ½ï¼Œç±»ä¼¼çš„æ’ä»¶è¿˜æœ‰<a href="https://github.com/cburgmer/rasterizeHTML.js" target="_blank" rel="noopener">rasterizeHTML.js</a>ç­‰ç­‰ã€‚</p><p>æºç ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"./html2canvas.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> can1 = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> img1 = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> ctxt = can1.getContext(<span class="string">'2d'</span>);</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> level = <span class="number">2</span>;</span></span><br><span class="line"><span class="javascript">    can1.width = <span class="built_in">document</span>.body.offsetWidth*level;</span></span><br><span class="line">    can1.height = div1.offsetHeight*level;</span><br><span class="line"><span class="actionscript">    can1.style.width = can1.width + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="actionscript">    can1.style.height = can1.height + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="actionscript">    ctxt.scale(level, level); <span class="comment">// ä½¿ç”¨ä¸¤å€å›¾ï¼Œä¿æŒæ¸…æ™°åº¦</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        html2canvas(div1, &#123;canvas:can1&#125;).then(<span class="function"><span class="keyword">function</span><span class="params">(can1)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> can2 = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> face = <span class="built_in">document</span>.getElementById(<span class="string">'face'</span>);</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> ctxt = can1.getContext(<span class="string">'2d'</span>);</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> level = <span class="number">2</span>;</span></span><br><span class="line">            can2.width = face.offsetWidth*level;</span><br><span class="line">            can2.height = face.offsetHeight*level;</span><br><span class="line"><span class="actionscript">            can2.style.width = face.offsetWidth + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="actionscript">            can2.style.height = face.offsetWidth + <span class="string">'px'</span>;</span></span><br><span class="line">            ctxt.scale(level, level);</span><br><span class="line"><span class="actionscript">            can2.getContext(<span class="string">'2d'</span>).drawImage(can1,</span></span><br><span class="line">            div1.offsetLeft*level, 0, face.offsetWidth*level, face.offsetHeight*level,</span><br><span class="line">                0, 0, face.offsetWidth*level, face.offsetHeight*level</span><br><span class="line"><span class="actionscript">            ); <span class="comment">// ä½¿ç”¨can2æ˜¯ä¸ºäº†è£æ‰ä¸äººè„¸å›¾ç‰‡æ— å…³çš„è¾¹ç¼˜</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> data = can2.toDataURL();</span></span><br><span class="line">            img1.src = data;</span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.body.appendChild(img1); <span class="comment">// æŠŠå›¾ç‰‡æ”¾å…¥å½“å‰é¡µé¢ä¸­</span></span></span><br><span class="line"><span class="actionscript">            can2 = <span class="literal">null</span>;</span></span><br><span class="line"><span class="actionscript">            can1 = <span class="literal">null</span>;</span></span><br><span class="line">        &#125;);</span><br><span class="line"><span class="actionscript">    &#125;, <span class="number">2000</span>); <span class="comment">// éœ€è¦ç­‰å¾…äººè„¸å›¾ç‰‡åŠ è½½å®Œæˆå†æ‰§è¡Œ</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨PCç«¯å¯ä»¥ç”¨aæ ‡ç­¾ä¸‹è½½å›¾ç‰‡ï¼Œhrefå±æ€§å€¼åº”è¯¥æ˜¯canvaså¯¼å‡ºçš„DataURLï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"DataURL"</span> <span class="attr">download</span>=<span class="string">"æœ€ç»ˆæ•ˆæœ"</span> <span class="attr">id</span>=<span class="string">"a1"</span>&gt;</span>ä¸‹è½½<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨ç§»åŠ¨ç«¯åˆ™éœ€è¦æ˜¾ç¤ºå›¾ç‰‡ï¼Œå¹¶å¼•å¯¼ç”¨æˆ·é•¿æŒ‰ä¿å­˜å›¾ç‰‡ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æ³¨æ„ï¼šå¦‚æœæœ€ç»ˆå›¾ç‰‡æœªèƒ½å†™å…¥canvasï¼Œå¯èƒ½æ˜¯å›¾ç‰‡è·¨åŸŸé—®é¢˜ï¼Œæˆ–è€…å›¾ç‰‡æœªåŠ è½½å®Œå°±å¼€å§‹å†™äº†ã€‚<br>å¦å¤–ï¼šå¯ä»¥åˆ†æå›¾ç‰‡äººè„¸çš„è¡¨æƒ…ã€å§¿æ€ã€å¹´çºªã€å¿ƒæƒ…ç­‰å±æ€§ï¼Œæ­é…æ›´åˆé€‚çš„å¦†é¥°ï¼Œæ•ˆæœæ›´ä½³ï¼›åŸå§‹å›¾ç‰‡ä¸å¦†é¥°å›¾ç‰‡å¯èƒ½ä¼šæœ‰è‰²è°ƒã€åˆ†è¾¨ç‡ç­‰ä¸ç›¸é…çš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨CSS3æ»¤é•œè°ƒæ•´ï¼Œä½¿å¾—æœ€ç»ˆç”»é¢æ›´èæ´½ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘è¦åšä¸€ä¸ªH5æ´»åŠ¨é¡µé¢ï¼Œå¤§æ¦‚åŠŸèƒ½æ˜¯ç»™å›¾ç‰‡äººè„¸æ¢å¦†ï¼Œè‡ªç„¶ä¹Ÿå°‘ä¸äº†ä¸Šä¼ åŸå§‹å›¾ç‰‡å’Œå¯¼å‡ºæœ€ç»ˆå›¾ç‰‡ç­‰åŠŸèƒ½ã€‚å¦‚æœå›¾ç‰‡åŠ å·¥ï¼ˆå³äººè„¸æ¢å¦†ï¼‰æ”¾åœ¨æœåŠ¡å™¨å¤„ç†ï¼Œé‚£ä¹ˆå¹¶å‘é‡é«˜çš„æ—¶å€™ï¼Œè‚¯å®šäº§ç”Ÿå¤§é‡é˜»å¡ã€‚äºæ˜¯æƒ³æŠŠå›¾ç‰‡åŠ å·¥æ”¾åœ¨å®¢æˆ·ç«¯å¤„ç†ï¼Œç”¨HTMLå †ç Œå‡ºå›¾ç‰‡çš„æœ€ç»ˆæ•ˆæœï¼Œä½†æ˜¯æ€æ ·æŠŠHTMLå¯¼å‡ºæˆå›¾ç‰‡å‘¢ï¼Ÿ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;å›¾ç‰‡ä¸Šä¼ &quot;&gt;&lt;a href=&quot;#å›¾ç‰‡ä¸Šä¼ &quot; class=&quot;headerlink&quot; title=&quot;å›¾ç‰‡ä¸Šä¼ &quot;&gt;&lt;/a&gt;å›¾ç‰‡ä¸Šä¼ &lt;/h2&gt;&lt;p&gt;å›¾ç‰‡ä¸Šä¼ å¯ä»¥å‚è€ƒ&lt;a href=&quot;https://blog.breezelin.site/2017/08/12/scheme-nginx-php-js-upload-process/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;HTTPæ–‡ä»¶ä¸Šä¼ çš„ä¸€ä¸ªåç«¯å®Œå–„æ–¹æ¡ˆï¼ˆNginXï¼‰&lt;/a&gt;ï¼Œæˆ–è€…ä½¿ç”¨ç°æœ‰çš„äº‘å­˜å‚¨æœåŠ¡ï¼Œå¦‚&lt;a href=&quot;https://www.qiniu.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ä¸ƒç‰›&lt;/a&gt;ç­‰ç­‰ã€‚&lt;/p&gt;
&lt;h2 id=&quot;äº”å®˜å®šä½&quot;&gt;&lt;a href=&quot;#äº”å®˜å®šä½&quot; class=&quot;headerlink&quot; title=&quot;äº”å®˜å®šä½&quot;&gt;&lt;/a&gt;äº”å®˜å®šä½&lt;/h2&gt;&lt;p&gt;äººè„¸è¯†åˆ«å’Œäº”å®˜å®šä½å¯ä»¥åˆ©ç”¨&lt;a href=&quot;https://opencv.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;OpenVC&lt;/a&gt;è‡ªè¡Œå®ç°ï¼Œæˆ–è€…ä½¿ç”¨æˆç†Ÿçš„äº‘è¯†åˆ«æœåŠ¡ï¼Œå¦‚&lt;a href=&quot;https://www.faceplusplus.com.cn/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Face++&lt;/a&gt;ç­‰ç­‰ã€‚è¿™é‡Œä½¿ç”¨è…¾è®¯äº‘çš„äººè„¸è¯†åˆ«æœåŠ¡ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="js" scheme="https://breeze2.github.io/blog/tags/js/"/>
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
  </entry>
  
  <entry>
    <title>ç”¨Dockeræ­å»ºMySQL MHAé«˜å¯ç”¨é›†ç¾¤</title>
    <link href="https://breeze2.github.io/blog/practice-mysql-mha-docker-compose.html"/>
    <id>https://breeze2.github.io/blog/practice-mysql-mha-docker-compose.html</id>
    <published>2017-10-13T15:39:06.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://yoshinorimatsunobu.blogspot.ca/2011/07/announcing-mysql-mha-mysql-master-high.html" target="_blank" rel="noopener">MySQL MHAï¼ˆMaster High Availabilityï¼‰</a>æ˜¯ç›®å‰ç›¸å¯¹æˆç†Ÿçš„ä¸€ä¸ªMySQLé«˜å¯ç”¨è§£å†³æ–¹æ¡ˆã€‚<br>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»ç”¨Docker Composeç¼–æ’MySQL MHAé«˜å¯ç”¨é›†ç¾¤çš„å®è·µè¿‡ç¨‹ã€‚<br>Docker Composeç¼–æ’ä¸­ä½¿ç”¨äº†ä¸¤ä¸ªç°æœ‰é•œåƒï¼Œåˆ†åˆ«æ˜¯<a href="https://hub.docker.com/r/breeze2/mha4mysql-manager/" target="_blank" rel="noopener">breeze2/mha4mysql-manager</a>å’Œ<a href="https://hub.docker.com/r/breeze2/mha4mysql-node/" target="_blank" rel="noopener">breeze2/mha4mysql-node</a>ï¼Œè¿™ä¸¤ä¸ªé•œåƒçš„ç›¸å…³ä¿¡æ¯å¯ä»¥æŸ¥çœ‹<a href="https://blog.breezelin.site/2017/10/13/practice-make-mha4mysql-docker-image/" target="_blank" rel="noopener">ã€Šåˆ¶ä½œmha4mysqlçš„Dockeré•œåƒã€‹</a>ã€‚<br>æœ¬æ¬¡å®è·µæºç ä¸Šä¼ åœ¨GitHubçš„<a href="https://github.com/breeze2/mysql-mha-docker" target="_blank" rel="noopener">breeze2/mysql-mha-docker</a>ã€‚</p><a id="more"></a><h2 id="Docker-Composeç¼–æ’"><a href="#Docker-Composeç¼–æ’" class="headerlink" title="Docker Composeç¼–æ’"></a>Docker Composeç¼–æ’</h2><p>è¿™ä¸ªç¼–æ’ä¸»è¦å®ç°ä¸€ä¸»ä¸€å¤‡ä¸€ä»çš„MySQL MHAé«˜å¯ç”¨é›†ç¾¤ã€‚</p><h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">L--mysql-mha-docker                //ä¸»ç›®å½•</span><br><span class="line">    L--scripts                     //æœ¬åœ°ï¼ˆDockerå®¿ä¸»ï¼‰ä½¿ç”¨çš„ä¸€äº›è„šæœ¬</span><br><span class="line">        L--mha_check_repl.sh</span><br><span class="line">        L--...</span><br><span class="line">    L--services                    //éœ€è¦buildçš„æœåŠ¡ï¼ˆç›®å‰æ˜¯ç©ºï¼‰</span><br><span class="line">    L--volumes                     //å„ä¸ªå®¹å™¨çš„æŒ‚è½½æ•°æ®å·</span><br><span class="line">        L--mha_manager</span><br><span class="line">        L--mha_node0</span><br><span class="line">        L--mha_node1</span><br><span class="line">        L--mha_node2</span><br><span class="line">        L--mha_share               //å„ä¸ªå®¹å™¨å…±äº«çš„ç›®å½•</span><br><span class="line">          L--scripts               //å„ä¸ªå®¹å™¨å…±ç”¨çš„ä¸€äº›è„šæœ¬</span><br><span class="line">          L--sshkeys               //å„ä¸ªå®¹å™¨çš„ssh public key</span><br><span class="line">    L--parameters.env              //è´¦å·å¯†ç ç­‰ç¯å¢ƒå‚æ•°</span><br><span class="line">    L--docker-compose.yml          //ç¼–æ’é…ç½®</span><br></pre></td></tr></table></figure><h3 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"2"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  master:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">breeze2/mha4mysql-node:0.57</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">mha_node0</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    mem_limit:</span> <span class="number">256</span><span class="string">m</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      net1:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">10.5</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"33060:3306"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_share/:/root/mha_share/"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_node0/lib/:/var/lib/mysql/"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_node0/conf/:/etc/mysql/conf.d/"</span></span><br><span class="line"><span class="attr">    env_file:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./parameters.env</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CONTAINER_NAME=mha_node0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  slave1:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">breeze2/mha4mysql-node:0.57</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">mha_node1</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    mem_limit:</span> <span class="number">256</span><span class="string">m</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      net1:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">10.5</span><span class="number">.0</span><span class="number">.11</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"33061:3306"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_share/:/root/mha_share/"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_node1/lib/:/var/lib/mysql/"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_node1/conf/:/etc/mysql/conf.d/"</span></span><br><span class="line"><span class="attr">    env_file:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./parameters.env</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CONTAINER_NAME=mha_node1</span></span><br><span class="line"><span class="attr">  slave2:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">breeze2/mha4mysql-node:0.57</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">mha_node2</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    mem_limit:</span> <span class="number">256</span><span class="string">m</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      net1:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">10.5</span><span class="number">.0</span><span class="number">.12</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"33062:3306"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_share/:/root/mha_share/"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_node2/lib/:/var/lib/mysql/"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_node2/conf/:/etc/mysql/conf.d/"</span></span><br><span class="line"><span class="attr">    env_file:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./parameters.env</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CONTAINER_NAME=mha_node2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  manager:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">breeze2/mha4mysql-manager:0.57</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">mha_manager</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">master</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">slave1</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">slave2</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    mem_limit:</span> <span class="number">256</span><span class="string">m</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      net1:</span></span><br><span class="line"><span class="attr">        ipv4_address:</span> <span class="number">10.5</span><span class="number">.0</span><span class="number">.9</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_share/:/root/mha_share/"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_manager/conf:/etc/mha"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"./volumes/mha_manager/work:/usr/local/mha"</span></span><br><span class="line"><span class="attr">    entrypoint:</span> <span class="string">"tailf /dev/null"</span></span><br><span class="line"><span class="attr">    env_file:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./parameters.env</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CONTAINER_NAME=mha_manager</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  net1:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">bridge</span></span><br><span class="line"><span class="attr">    ipam:</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line"><span class="attr">        - subnet:</span> <span class="number">10.5</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">          gateway:</span> <span class="number">10.5</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œé…ç½®äº†å››ä¸ªå®¹å™¨æœåŠ¡ï¼Œä¸€ä¸ª<code>breeze2/mha4mysql-manager</code>ï¼Œè´Ÿè´£ç®¡ç†å„ä¸ªæ•°æ®åº“ç»“ç‚¹ï¼›ä¸‰ä¸ª<code>breeze2/mha4mysql-node</code>ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ä¸»åº“ï¼Œä¸€ä¸ªæ˜¯å¤‡ç”¨ä¸»åº“ï¼ˆå…¼ä½œä»åº“ï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯ï¼ˆçº¯ï¼‰ä»åº“ã€‚æ¯ä¸ªå®¹å™¨æœåŠ¡éƒ½æŒ‡å®šäº†é™æ€IPï¼Œå³ä½¿æœåŠ¡é‡å¯ä¹Ÿä¸ä¼šå‡ºç°IPé”™ä¹±é—®é¢˜ã€‚</p><h3 id="ç¯å¢ƒå‚æ•°"><a href="#ç¯å¢ƒå‚æ•°" class="headerlink" title="ç¯å¢ƒå‚æ•°"></a>ç¯å¢ƒå‚æ•°</h3><p>parameters.env</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ROOT_PASSWORD=123456</span><br><span class="line">MYSQL_ROOT_PASSWORD=123456</span><br><span class="line">MYSQL_DATABASE=testing</span><br><span class="line">MYSQL_User=testing</span><br><span class="line">MYSQL_PASSWORD=testing</span><br><span class="line">MHA_SHARE_SCRIPTS_PATH=/root/mha_share/scripts</span><br><span class="line">MHA_SHARE_SSHKEYS_PATH=/root/mha_share/sshkeys</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®åº“é…ç½®"><a href="#æ•°æ®åº“é…ç½®" class="headerlink" title="æ•°æ®åº“é…ç½®"></a>æ•°æ®åº“é…ç½®</h3><p>è¿™é‡Œç®€å•çš„é…ç½®ä¸€ä¸‹å„ä¸ªæ•°æ®åº“æ•°æ®å¤åˆ¶å¤‡ä»½ç›¸å…³çš„å‚æ•°<br>ä¸»åº“ï¼Œmha_node0/conf/my.cnf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id=1</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">binlog-do-db=testing</span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line">replicate-do-db=testing</span><br><span class="line">replicate-ignore-db=mysql</span><br><span class="line">auto_increment_increment=2</span><br><span class="line">auto_increment_offset=1</span><br><span class="line">expire_logs_days=7</span><br></pre></td></tr></table></figure><p>å¤‡åº“ï¼Œmha_node1/conf/my.cnf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">binlog-do-db=testing</span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line">replicate-do-db=testing</span><br><span class="line">replicate-ignore-db=mysql</span><br><span class="line">auto_increment_increment=2</span><br><span class="line">auto_increment_offset=2</span><br><span class="line">expire_logs_days=7</span><br></pre></td></tr></table></figure><p>ä»åº“ï¼Œmha_node2/conf/my.cnf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id=3</span><br><span class="line">replicate-do-db=testing</span><br><span class="line">replicate-ignore-db=mysql</span><br><span class="line">expire_logs_days=7</span><br></pre></td></tr></table></figure><h3 id="MHAé…ç½®"><a href="#MHAé…ç½®" class="headerlink" title="MHAé…ç½®"></a>MHAé…ç½®</h3><p>manager/conf/app1.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[server default]</span><br><span class="line">user=root</span><br><span class="line">password=123456</span><br><span class="line">ssh_user=root</span><br><span class="line"></span><br><span class="line">manager_workdir=/usr/local/mha</span><br><span class="line">remote_workdir=/usr/local/mha</span><br><span class="line"></span><br><span class="line">repl_user=myslave</span><br><span class="line">repl_password=myslave</span><br><span class="line"></span><br><span class="line">[server0]</span><br><span class="line">hostname=10.5.0.10</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=10.5.0.11</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname=10.5.0.12</span><br></pre></td></tr></table></figure><h2 id="å®é™…è¿è¡Œ"><a href="#å®é™…è¿è¡Œ" class="headerlink" title="å®é™…è¿è¡Œ"></a>å®é™…è¿è¡Œ</h2><p>åœ¨ä¸»ç›®å½•ä¸‹æ‰§è¡Œ<code>docker-compose up -d</code>æ„å»ºå¹¶è¿è¡Œæ•´ä¸ªDockeræœåŠ¡ã€‚</p><h3 id="SSHè®¾ç½®"><a href="#SSHè®¾ç½®" class="headerlink" title="SSHè®¾ç½®"></a>SSHè®¾ç½®</h3><p>MHAè¦æ±‚å„ä¸ªä¸»æœºèƒ½å¤Ÿç›¸äº’SSHç™»å½•ï¼Œæ‰€ä»¥æ•´ä½“æœåŠ¡é¦–æ¬¡å¯åŠ¨æˆåŠŸåï¼Œåœ¨ä¸»ç›®å½•ä¸‹å…ˆæ‰§è¡Œä¸€äº›å‘½ä»¤ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sh ./scripts/ssh_start.sh</span><br><span class="line">$ sh ./scripts/ssh_share.sh</span><br></pre></td></tr></table></figure><p><code>ssh_start.sh</code>ä½œç”¨æ˜¯åœ¨å„ä¸ªå®¹å™¨ä¸Šå¼€å¯SSHæœåŠ¡ï¼Œ<code>ssh_share.sh</code>ä½œç”¨æ˜¯åœ¨å®¹å™¨å†…ç”ŸæˆSSHå…¬å¯†é’¥ï¼Œå†æŠŠå…¬é’¥å…±äº«åˆ°å…¶ä»–å®¹å™¨ã€‚å¸¸ç”¨å‘½ä»¤è°ƒç”¨çš„è„šæœ¬åœ¨<code>scripts</code>å’Œ<code>volumes/mha_share/scripts</code>ä¸‹ï¼Œè¿™äº›è„šæœ¬éƒ½å¾ˆç®€å•ï¼Œä¸€çœ‹å°±æ˜ã€‚<br>è‹¥æ˜¯æ•´ä½“æœåŠ¡é‡æ–°å¯åŠ¨ï¼Œåªéœ€é‡æ–°å¼€å¯SSHæœåŠ¡å³å¯ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sh ./scripts/ssh_start.sh</span><br></pre></td></tr></table></figure><p>åœ¨managerå®¹å™¨ä¸Šæ£€æµ‹SSHæ˜¯å¦é…ç½®æˆåŠŸï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it mha_manager /bin/bash</span><br><span class="line">root@mha_manager# masterha_check_ssh --conf=/etc/mha/app1.conf</span><br></pre></td></tr></table></figure><p>è‹¥æ˜¯æˆåŠŸï¼Œä¼šæ˜¾ç¤º</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Mon Oct <span class="number">16</span> <span class="number">14</span>:<span class="number">53</span>:<span class="number">59</span> <span class="number">2017</span> - [debug]   ok.</span><br><span class="line">Mon Oct <span class="number">16</span> <span class="number">14</span>:<span class="number">53</span>:<span class="number">59</span> <span class="number">2017</span> - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure><h3 id="å¼€å¯æ•°æ®ä¸»ä»å¤åˆ¶"><a href="#å¼€å¯æ•°æ®ä¸»ä»å¤åˆ¶" class="headerlink" title="å¼€å¯æ•°æ®ä¸»ä»å¤åˆ¶"></a>å¼€å¯æ•°æ®ä¸»ä»å¤åˆ¶</h3><p>é¦–å…ˆå¯¹ä¸»åº“ã€å¤‡è€ƒåˆ›å»ºå’Œæˆæƒå¤åˆ¶è´¦å·ï¼Œå¯¹å¤‡åº“ã€ä»åº“è®¾ç½®ä¸»åº“ä¿¡æ¯å’Œå¼€å§‹å¤åˆ¶ï¼Œä»¥ä¸‹å‘½ä»¤ä¼šå®Œæˆè¿™äº›æ“ä½œï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sh ./scripts/mysql_set_mbs.sh</span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨ä¸»åº“ä¸Šçš„testingæ•°æ®åº“é‡Œåˆ›å»ºä¸€å¼ è¡¨ï¼Œå†™å…¥ä¸€äº›æ•°æ®ï¼Œçœ‹çœ‹å¤‡åº“ã€ä»åº“ä¼šä¸ä¼šåŒæ­¥ã€‚</p><p>åœ¨managerå®¹å™¨ä¸Šæ£€æµ‹REPLæ˜¯å¦é…ç½®æˆåŠŸï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it mha_manager /bin/bash</span><br><span class="line">root@mha_manager# masterha_check_repl --conf=/etc/mha/app1.conf</span><br></pre></td></tr></table></figure><p>è‹¥æ˜¯æˆåŠŸï¼Œä¼šæ˜¾ç¤º</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mon Oct <span class="number">16</span> <span class="number">15</span>:<span class="number">01</span>:<span class="number">35</span> <span class="number">2017</span> - [info] Got <span class="keyword">exit</span> code <span class="number">0</span> (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br></pre></td></tr></table></figure><h3 id="å¼€å¯MHAç›‘æ§"><a href="#å¼€å¯MHAç›‘æ§" class="headerlink" title="å¼€å¯MHAç›‘æ§"></a>å¼€å¯MHAç›‘æ§</h3><p>SSHå’ŒREPLæ£€æµ‹æ²¡é—®é¢˜åï¼Œå¯ä»¥åœ¨managerå®¹å™¨ä¸Šå¼€å¯MHAç›‘æ§ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it mha_manager /bin/bash</span><br><span class="line">root@mha_manager# masterha_manager --conf=/etc/mha/app1.conf</span><br></pre></td></tr></table></figure><p><code>masterha_manager</code>è¿›ç¨‹ä¼šä¸€ç›´ç›‘è§†ä¸»åº“çŠ¶æ€æ˜¯å¦å¯ç”¨ï¼Œè‹¥æ˜¯ä¸»åº“å®•æœºï¼Œ<code>masterha_manager</code>ä¼šå°†å¤‡åº“ä¸ä»åº“çš„Relay Logè¿›è¡Œæ¯”è¾ƒï¼ŒæŠŠæœ€æ–°çš„æ•°æ®æ•´åˆåˆ°å¤‡åº“ï¼Œç„¶åæŠŠå¤‡åº“æå‡ä¸ºæ–°ä¸»åº“ï¼Œä»åº“è·Ÿéšå¤åˆ¶æ–°ä¸»åº“ï¼Œæœ€å<code>masterha_manager</code>è¿›ç¨‹ä¼šé€€å‡ºï¼Œä¸å†ç›‘æ§ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°ï¼ˆDockerå®¿ä¸»ï¼‰æš‚åœä¸»åº“ï¼ˆmha_node0å®¹å™¨ï¼‰ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">pause</span> mha_node0</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œmanagerå®¹å™¨ä¸Š<code>masterha_manager</code>ç¡®è®¤ä¸»åº“å¤±è”åï¼Œå¼€å§‹åˆ‡æ¢ä¸»åº“ï¼ŒæˆåŠŸåä¼šæ˜¾ç¤ºï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">----- Failover Report -----</span><br><span class="line"></span><br><span class="line"><span class="function">app1: <span class="title">MySQL</span> <span class="title">Master</span> <span class="title">failover</span> 10.5.0.10(10.5.0.10:3306) <span class="title">to</span> 10.5.0.11(10.5.0.11:3306) <span class="title">succeeded</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Master</span> 10.5.0.10(10.5.0.10:3306) <span class="title">is</span> <span class="title">down</span>!</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Check</span> <span class="title">MHA</span> <span class="title">Manager</span> <span class="title">logs</span> <span class="title">at</span> 3<span class="title">d2d8185510b</span> <span class="title">for</span> <span class="title">details</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Started</span> <span class="title">automated</span>(<span class="title">non</span>-<span class="title">interactive</span>) <span class="title">failover</span>.</span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">latest</span> <span class="title">slave</span> 10.5.0.11(10.5.0.11:3306) <span class="title">has</span> <span class="title">all</span> <span class="title">relay</span> <span class="title">logs</span> <span class="title">for</span> <span class="title">recovery</span>.</span></span><br><span class="line"><span class="function"><span class="title">Selected</span> 10.5.0.11(10.5.0.11:3306) <span class="title">as</span> <span class="title">a</span> <span class="title">new</span> <span class="title">master</span>.</span></span><br><span class="line"><span class="function">10.5.0.11(10.5.0.11:3306): <span class="title">OK</span>: <span class="title">Applying</span> <span class="title">all</span> <span class="title">logs</span> <span class="title">succeeded</span>.</span></span><br><span class="line"><span class="function">10.5.0.12(10.5.0.12:3306): <span class="title">This</span> <span class="title">host</span> <span class="title">has</span> <span class="title">the</span> <span class="title">latest</span> <span class="title">relay</span> <span class="title">log</span> <span class="title">events</span>.</span></span><br><span class="line"><span class="function"><span class="title">Generating</span> <span class="title">relay</span> <span class="title">diff</span> <span class="title">files</span> <span class="title">from</span> <span class="title">the</span> <span class="title">latest</span> <span class="title">slave</span> <span class="title">succeeded</span>.</span></span><br><span class="line"><span class="function">10.5.0.12(10.5.0.12:3306): <span class="title">OK</span>: <span class="title">Applying</span> <span class="title">all</span> <span class="title">logs</span> <span class="title">succeeded</span>. <span class="title">Slave</span> <span class="title">started</span>, <span class="title">replicating</span> <span class="title">from</span> 10.5.0.11(10.5.0.11:3306)</span></span><br><span class="line"><span class="function">10.5.0.11(10.5.0.11:3306): <span class="title">Resetting</span> <span class="title">slave</span> <span class="title">info</span> <span class="title">succeeded</span>.</span></span><br><span class="line"><span class="function"><span class="title">Master</span> <span class="title">failover</span> <span class="title">to</span> 10.5.0.11(10.5.0.11:3306) <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥åˆ°ä»åº“ï¼ˆmha_node2å®¹å™¨ï¼‰ï¼ŒæŸ¥çœ‹å¤åˆ¶çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°è·Ÿéšä¸»åº“æ˜¯10.5.0.11ï¼Œå³æ–°ä¸»åº“ï¼ˆåŸå¤‡åº“ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it mha_manager /bin/bash</span><br><span class="line">root@mha_manager# mysql -u root -p$MYSQL_ROOT_PASSWORD</span><br><span class="line">mysql&gt; show slave status;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 10.5.0.11</span><br><span class="line">                  Master_User: myslave</span><br></pre></td></tr></table></figure><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>åœ¨æ•°æ®åº“æœåŠ¡å™¨é›†ç¾¤ä¸­ï¼Œä½¿ç”¨MHAï¼Œå¯ä»¥åœ¨ä¸»åº“å®•æœºåå¿«é€Ÿåˆ‡æ¢æ–°ä¸»åº“ï¼Œå¯æ˜¯åº”ç”¨æœåŠ¡å™¨å¹¶ä¸çŸ¥é“ä¸»åº“å·²ç»è¢«åˆ‡æ¢ã€‚æ‰€ä»¥ï¼Œ<code>masterha_manager</code>è¿›ç¨‹åˆ‡æ¢ä¸»åº“æˆåŠŸååº”è¯¥é€šçŸ¥åº”ç”¨æœåŠ¡å™¨æ–°çš„ä¸»åº“IPï¼Œæˆ–è€…ä½¿ç”¨è™šæ‹ŸIPé™é»˜è¿‡æ¸¡ã€‚è‹¥æ˜¯åº”ç”¨ä¸æ•°æ®åº“é€šè¿‡ä¸­é—´ä»¶ï¼ˆæ¯”å¦‚ProxySQLï¼‰æ¥è¿æ¥çš„ï¼Œé‚£ä¹ˆåªéœ€åœ¨ä¸­é—´ä»¶ä¸Šä¿®æ”¹ä¸»åº“IPï¼Œå¯¹åº”ç”¨å½±å“ä¸å¤§ã€‚</p><blockquote><p>æ³¨æ„ï¼šå› ä¸ºæœ¬composeä¸­MySQLæœåŠ¡ä¸SSHæœåŠ¡æ²¡æœ‰åŒä¸€å¯åŠ¨ï¼ˆSSHæœåŠ¡æ˜¯å®¹å™¨å¯åŠ¨åæ‰å¼€å¯çš„ï¼‰ï¼Œæ‰€ä»¥æœ¬composeåªèƒ½å½“ä½œçº¿ä¸‹æ¨¡æ‹Ÿç»ƒä¹ ï¼Œæœªèƒ½åœ¨æ­£å¼çº¿ä¸Šåº”ç”¨ã€‚æ¯”å¦‚å…¶ä¸­æŸä¸ªç»“ç‚¹å®¹å™¨é‡å¯ï¼ŒSSHæœåŠ¡å¹¶æ²¡æœ‰è‡ªåŠ¨é‡å¯ï¼Œè¿›è€Œæ•´ä¸ªMHAé›†ç¾¤ä¸å¯ç”¨ã€‚</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://yoshinorimatsunobu.blogspot.ca/2011/07/announcing-mysql-mha-mysql-master-high.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;MySQL MHAï¼ˆMaster High Availabilityï¼‰&lt;/a&gt;æ˜¯ç›®å‰ç›¸å¯¹æˆç†Ÿçš„ä¸€ä¸ªMySQLé«˜å¯ç”¨è§£å†³æ–¹æ¡ˆã€‚&lt;br&gt;è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»ç”¨Docker Composeç¼–æ’MySQL MHAé«˜å¯ç”¨é›†ç¾¤çš„å®è·µè¿‡ç¨‹ã€‚&lt;br&gt;Docker Composeç¼–æ’ä¸­ä½¿ç”¨äº†ä¸¤ä¸ªç°æœ‰é•œåƒï¼Œåˆ†åˆ«æ˜¯&lt;a href=&quot;https://hub.docker.com/r/breeze2/mha4mysql-manager/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;breeze2/mha4mysql-manager&lt;/a&gt;å’Œ&lt;a href=&quot;https://hub.docker.com/r/breeze2/mha4mysql-node/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;breeze2/mha4mysql-node&lt;/a&gt;ï¼Œè¿™ä¸¤ä¸ªé•œåƒçš„ç›¸å…³ä¿¡æ¯å¯ä»¥æŸ¥çœ‹&lt;a href=&quot;https://blog.breezelin.site/2017/10/13/practice-make-mha4mysql-docker-image/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€Šåˆ¶ä½œmha4mysqlçš„Dockeré•œåƒã€‹&lt;/a&gt;ã€‚&lt;br&gt;æœ¬æ¬¡å®è·µæºç ä¸Šä¼ åœ¨GitHubçš„&lt;a href=&quot;https://github.com/breeze2/mysql-mha-docker&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;breeze2/mysql-mha-docker&lt;/a&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="mysql" scheme="https://breeze2.github.io/blog/tags/mysql/"/>
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
      <category term="docker" scheme="https://breeze2.github.io/blog/tags/docker/"/>
    
      <category term="mha4mysql" scheme="https://breeze2.github.io/blog/tags/mha4mysql/"/>
    
  </entry>
  
  <entry>
    <title>åˆ¶ä½œmha4mysqlçš„Dockeré•œåƒ</title>
    <link href="https://breeze2.github.io/blog/practice-make-mha4mysql-docker-image.html"/>
    <id>https://breeze2.github.io/blog/practice-make-mha4mysql-docker-image.html</id>
    <published>2017-10-13T10:16:08.000Z</published>
    <updated>2019-09-30T02:17:26.551Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ¥æƒ³è®°å½•ä¸€ä¸‹ç”¨Dockeræ„å»ºMySQL MHAé›†ç¾¤çš„å®è·µè¿‡ç¨‹çš„ï¼Œä½†æ˜¯æ•´ä¸ªç¯‡å¹…æœ‰ç‚¹é•¿ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆæ¥ä»‹ç»ä¸€ä¸‹æ€æ ·åˆ¶ä½œmha4mysqlçš„Dockeré•œåƒã€‚</p></blockquote><p>mha4mysqlæ˜¯æ—¥æœ¬å·¥ç¨‹å¸ˆ<a href="https://www.percona.com/live/mysql-conference-2014/users/yoshinori-matsunobu" target="_blank" rel="noopener">Yoshinori Matsunobu</a>å¼€å‘çš„ä¸€æ¬¾MySQLé«˜å¯ç”¨è½¯ä»¶ã€‚mha4mysqlåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€æ˜¯ç®¡ç†å™¨éƒ¨åˆ†<a href="https://github.com/yoshinorim/mha4mysql-manager" target="_blank" rel="noopener">mha4mysql-manager</a>ï¼ŒäºŒæ˜¯ç»“ç‚¹éƒ¨åˆ†<a href="https://github.com/yoshinorim/mha4mysql-node" target="_blank" rel="noopener">mha4mysql-node</a>ã€‚mha4mysql-nodeè¦è¿è¡Œåœ¨æ¯å°å—ç®¡ç†çš„MySQLæœåŠ¡å™¨ä¸Šï¼›è€Œmha4mysql-manageræ‰€åœ¨æœåŠ¡å™¨åˆ™ä¸éœ€è¦MySQLï¼Œä½†éœ€è¦mha4mysql-nodeã€‚å› ä¸ºmha4mysql-managerä¾èµ–mha4mysql-nodeï¼Œå³å®‰è£…mha4mysql-managerå‰å¿…é¡»å…ˆå®‰è£…mha4mysql-nodeã€‚</p><p>ä¸‹é¢è®²è§£ä¸€ä¸‹ï¼ŒåŸºäº<a href="https://hub.docker.com/_/debian/" target="_blank" rel="noopener">debian:jessie</a>åˆ¶ä½œmha4mysql-managerçš„Dockeré•œåƒå’Œ<br>åŸºäº<a href="https://hub.docker.com/_/mysql/" target="_blank" rel="noopener">mysql:5.7</a>åˆ¶ä½œmha4mysql-nodeçš„Dockeré•œåƒã€‚</p><a id="more"></a><h2 id="mha4mysql-manager"><a href="#mha4mysql-manager" class="headerlink" title="mha4mysql-manager"></a>mha4mysql-manager</h2><p>mha4mysql-managerçš„Dockerfile:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:jessie</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./mha4mysql-manager.tar.gz /tmp/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./mha4mysql-node.tar.gz /tmp/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> build_deps=<span class="string">'ssh sshpass perl libdbi-perl libmodule-install-perl libdbd-mysql-perl libconfig-tiny-perl liblog-dispatch-perl libparallel-forkmanager-perl make'</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get -y --force-yes install <span class="variable">$build_deps</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -zxf /tmp/mha4mysql-node.tar.gz -C /opt \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /opt/mha4mysql-node \</span></span><br><span class="line"><span class="bash">    &amp;&amp; perl Makefile.PL \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -zxf /tmp/mha4mysql-manager.tar.gz -C /opt \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /opt/mha4mysql-manager \</span></span><br><span class="line"><span class="bash">    &amp;&amp; perl Makefile.PL \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /opt \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /opt/mha4mysql-* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get clean</span></span><br></pre></td></tr></table></figure><p>æ³¨é‡Šï¼š</p><ol><li>åŸºäºdebian:jessieé•œåƒäºŒæ¬¡åˆ¶ä½œï¼›</li><li>å°†mha4mysql-managerå’Œmha4mysql-nodeçš„å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼ˆv0.57ï¼‰æ‰“åŒ…ï¼Œå¤åˆ¶åˆ°é•œåƒå†…ï¼›</li><li><code>build_deps</code>æ˜¯mha4mysql-managerå’Œmha4mysql-nodeçš„å®‰è£…ä¾èµ–ã€è¿è¡Œä¾èµ–ï¼›</li><li>å…ˆæ‹†åŒ…å®‰è£…mha4mysql-nodeï¼Œå®‰è£…å‘½ä»¤ï¼š<code>perl Makefile.PL &amp;&amp; make &amp;&amp; make install</code>ï¼›</li><li>æ‰èƒ½æ‹†åŒ…å®‰è£…mha4mysql-managerï¼Œå®‰è£…å‘½ä»¤ï¼š<code>perl Makefile.PL &amp;&amp; make &amp;&amp; make install</code>ï¼›</li><li>æ¸…ç†ä¸€äº›æ— ç”¨æ–‡ä»¶ã€‚</li></ol><h2 id="mha4mysql-node"><a href="#mha4mysql-node" class="headerlink" title="mha4mysql-node"></a>mha4mysql-node</h2><p>mha4mysql-nodeçš„Dockerfile:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> mysql:<span class="number">5.7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./mha4mysql-node.tar.gz /tmp/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> build_deps=<span class="string">'ssh sshpass perl libdbi-perl libmodule-install-perl libdbd-mysql-perl make'</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get -y --force-yes install <span class="variable">$build_deps</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -zxf /tmp/mha4mysql-node.tar.gz -C /opt \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /opt/mha4mysql-node \</span></span><br><span class="line"><span class="bash">    &amp;&amp; perl Makefile.PL \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /opt \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /opt/mha4mysql-* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get clean</span></span><br></pre></td></tr></table></figure><p>æ³¨é‡Šï¼š</p><ol><li>åŸºäºmysql:5.7é•œåƒäºŒæ¬¡åˆ¶ä½œï¼›</li><li>å°†mha4mysql-nodeçš„å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼ˆv0.57ï¼‰æ‰“åŒ…ï¼Œå¤åˆ¶åˆ°é•œåƒå†…ï¼›</li><li><code>build_deps</code>æ˜¯mha4mysql-nodeçš„å®‰è£…ä¾èµ–ã€è¿è¡Œä¾èµ–ï¼›</li><li>æ‹†åŒ…å®‰è£…mha4mysql-managerï¼Œå®‰è£…å‘½ä»¤ï¼š<code>perl Makefile.PL &amp;&amp; make &amp;&amp; make install</code>ï¼›</li><li>æ¸…ç†ä¸€äº›æ— ç”¨æ–‡ä»¶ã€‚</li></ol><h2 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h2><h3 id="v0-57-bug"><a href="#v0-57-bug" class="headerlink" title="v0.57 bug"></a>v0.57 bug</h3><p>ç›®å‰mha4mysql-managerå’Œmha4mysql-nodeçš„v0.57å¹¶ä¸å…¼å®¹ï¼Œæ–°ç‰ˆçš„libdbd-mysql-perlçš„è°ƒç”¨è¯­æ³•ï¼Œæ¯”å¦‚æ–°ç‰ˆè¦æ±‚è¿æ¥æ•°æ®åº“æ ¼å¼æ˜¯ï¼š<br><code>my $dsn = &quot;DBI:mysql:;host=$opt{host};port=$opt{port}&quot;;</code><br>è€Œv0.57æºç æ˜¯ï¼š<br><code>my $dsn = &quot;DBI:mysql:;host=[$opt{host}];port=$opt{port}&quot;;</code><br>å¤šäº†ä¸€å¯¹ä¸­æ‹¬å·ä¼šå¯¼è‡´è¿æ¥æ•°æ®åº“å¤±è´¥ã€‚<br>è¿™é‡Œé•œåƒä¸­çš„mha4mysql-managerå’Œmha4mysql-nodeçš„æºç åŒ…æ˜¯å·²ç»å¯¹ä¸Šé¢é—®é¢˜è¿›è¡Œä¿®æ­£çš„ã€‚</p><h3 id="å•å®¹å™¨å¤šæœåŠ¡"><a href="#å•å®¹å™¨å¤šæœåŠ¡" class="headerlink" title="å•å®¹å™¨å¤šæœåŠ¡"></a>å•å®¹å™¨å¤šæœåŠ¡</h3><p>æŒ‰ç…§Dockerçš„æ€æƒ³ï¼Œæ˜¯ä¸€ä¸ªå®¹å™¨åªåšä¸€ä»¶äº‹ï¼Œä½†æ˜¯mha4mysqlç»“ç‚¹éœ€è¦mysqlæœåŠ¡å’ŒsshæœåŠ¡ï¼Œè¿™é‡Œçš„ä¸´æ—¶è§£å†³åŠæ³•æ˜¯å®¹å™¨å…ˆè¿è¡ŒmysqlæœåŠ¡ï¼Œä¹‹åæ‰§è¡Œ<code>docker exec -it $CONTAINER_NAME /bin/bash service ssh start</code>ã€‚<br>ç›®å‰å®ç°Dokcerå•å®¹å™¨å¤šæœåŠ¡çš„hackæ–¹æ³•æ˜¯åˆ©ç”¨supervisorï¼Œåªåšsupervisorè¿™ä¸€ä»¶äº‹ï¼Œè€Œsupervisoråšå¤šä»¶äº‹ã€‚å¦‚æœåæœŸçœŸçš„éœ€è¦ä½¿ç”¨supervisorï¼Œä¹Ÿå¯ä»¥åŸºäºæœ¬é•œåƒè¿›è¡ŒäºŒæ¬¡åˆ¶ä½œã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>mha4mysql-managerå’Œmha4mysql-nodeçš„Dockerfileåˆ†åˆ«æ”¾åœ¨GitHub<a href="https://github.com/breeze2/mha4mysql-manager-docker" target="_blank" rel="noopener">breeze2/mha4mysql-manager-docker</a>å’Œ<a href="https://github.com/breeze2/mha4mysql-node-docker" target="_blank" rel="noopener">breeze2/mha4mysql-node-docker</a>ä¸Šï¼›é•œåƒå¯ä»¥ç”¨dockerå‘½ä»¤ç›´æ¥æ‹‰å–ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull breeze2/mha4mysql-manager:<span class="number">0</span>.<span class="number">57</span></span><br><span class="line">$ docker pull breeze2/mha4mysql-node:<span class="number">0</span>.<span class="number">57</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æœ¬æ¥æƒ³è®°å½•ä¸€ä¸‹ç”¨Dockeræ„å»ºMySQL MHAé›†ç¾¤çš„å®è·µè¿‡ç¨‹çš„ï¼Œä½†æ˜¯æ•´ä¸ªç¯‡å¹…æœ‰ç‚¹é•¿ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆæ¥ä»‹ç»ä¸€ä¸‹æ€æ ·åˆ¶ä½œmha4mysqlçš„Dockeré•œåƒã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;mha4mysqlæ˜¯æ—¥æœ¬å·¥ç¨‹å¸ˆ&lt;a href=&quot;https://www.percona.com/live/mysql-conference-2014/users/yoshinori-matsunobu&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Yoshinori Matsunobu&lt;/a&gt;å¼€å‘çš„ä¸€æ¬¾MySQLé«˜å¯ç”¨è½¯ä»¶ã€‚mha4mysqlåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€æ˜¯ç®¡ç†å™¨éƒ¨åˆ†&lt;a href=&quot;https://github.com/yoshinorim/mha4mysql-manager&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;mha4mysql-manager&lt;/a&gt;ï¼ŒäºŒæ˜¯ç»“ç‚¹éƒ¨åˆ†&lt;a href=&quot;https://github.com/yoshinorim/mha4mysql-node&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;mha4mysql-node&lt;/a&gt;ã€‚mha4mysql-nodeè¦è¿è¡Œåœ¨æ¯å°å—ç®¡ç†çš„MySQLæœåŠ¡å™¨ä¸Šï¼›è€Œmha4mysql-manageræ‰€åœ¨æœåŠ¡å™¨åˆ™ä¸éœ€è¦MySQLï¼Œä½†éœ€è¦mha4mysql-nodeã€‚å› ä¸ºmha4mysql-managerä¾èµ–mha4mysql-nodeï¼Œå³å®‰è£…mha4mysql-managerå‰å¿…é¡»å…ˆå®‰è£…mha4mysql-nodeã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢è®²è§£ä¸€ä¸‹ï¼ŒåŸºäº&lt;a href=&quot;https://hub.docker.com/_/debian/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;debian:jessie&lt;/a&gt;åˆ¶ä½œmha4mysql-managerçš„Dockeré•œåƒå’Œ&lt;br&gt;åŸºäº&lt;a href=&quot;https://hub.docker.com/_/mysql/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;mysql:5.7&lt;/a&gt;åˆ¶ä½œmha4mysql-nodeçš„Dockeré•œåƒã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å®è·µ" scheme="https://breeze2.github.io/blog/categories/%E5%AE%9E%E8%B7%B5/"/>
    
    
      <category term="mysql" scheme="https://breeze2.github.io/blog/tags/mysql/"/>
    
      <category term="practice" scheme="https://breeze2.github.io/blog/tags/practice/"/>
    
      <category term="docker" scheme="https://breeze2.github.io/blog/tags/docker/"/>
    
      <category term="mha4mysql" scheme="https://breeze2.github.io/blog/tags/mha4mysql/"/>
    
  </entry>
  
</feed>
